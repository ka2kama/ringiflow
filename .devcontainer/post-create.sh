#!/bin/bash
# RingiFlow Dev Container 初期セットアップスクリプト
#
# コンテナ作成後に自動実行される（devcontainer.json の postCreateCommand）
# 依存関係のインストールと Git フックのセットアップを行う
#
# 詳細: docs/05_ADR/018_DevContainers導入.md

set -euo pipefail

echo "=============================================="
echo "RingiFlow Dev Container セットアップ開始"
echo "=============================================="

# =============================================================================
# 環境変数ファイルの作成
# =============================================================================
echo ""
echo "[1/5] 環境変数ファイルを作成中..."

# ルートの .env（テンプレートからコピー）
# ポート設定は .env.template の値をそのまま使用
if [ ! -f .env ]; then
    cp .env.template .env
    echo "  作成: .env"
else
    echo "  スキップ: .env（既存）"
fi

# backend/.env
if [ ! -f backend/.env ]; then
    cp backend/.env.template backend/.env
    echo "  作成: backend/.env"
else
    echo "  スキップ: backend/.env（既存）"
fi

echo "  完了"

# =============================================================================
# Rust 依存関係のビルド
# =============================================================================
echo ""
echo "[2/5] Rust 依存関係をビルド中..."
cd backend
cargo build
echo "  完了"
cd ..

# =============================================================================
# フロントエンド依存関係のインストール
# =============================================================================
echo ""
echo "[3/5] フロントエンド依存関係をインストール中..."
cd frontend
pnpm install
echo "  完了"
cd ..

# =============================================================================
# Git フックのセットアップ
# =============================================================================
echo ""
echo "[4/5] Git フックをセットアップ中..."
lefthook install
echo "  完了"

# =============================================================================
# データベースのセットアップ
# =============================================================================
echo ""
echo "[5/5] データベースをセットアップ中..."
sleep 3  # PostgreSQL の起動待ち
cd backend
sqlx migrate run 2>/dev/null || echo "  マイグレーションファイルなし（Phase 1 で作成予定）"
echo "  完了"
cd ..

# =============================================================================
# 完了メッセージ
# =============================================================================
echo ""
echo "=============================================="
echo "セットアップ完了"
echo "=============================================="
echo ""
echo "開発サーバーの起動:"
echo "  just dev-bff      : BFF 起動（localhost:13000）"
echo "  just dev-core-api : Core API 起動"
echo "  just dev-web      : フロントエンド起動（localhost:15173）"
echo ""
echo "その他のコマンド:"
echo "  just              : タスク一覧を表示"
echo "  just check-all    : リント + テスト"
echo ""
