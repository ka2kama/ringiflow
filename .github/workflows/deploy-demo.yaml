# デモ環境（Lightsail）への自動デプロイ
#
# main ブランチへの push 時に、Docker イメージを GHCR にビルド・プッシュし、
# Lightsail インスタンスにデプロイする。
#
# 必要な GitHub Secrets:
#   LIGHTSAIL_SSH_KEY  - Lightsail への SSH 秘密鍵
#   LIGHTSAIL_HOST     - Lightsail インスタンスのホスト名または IP アドレス
#   LIGHTSAIL_USER     - SSH ユーザー名（例: ec2-user）
#
# 必要な GitHub Actions 許可設定（Settings > Actions > General）:
#   docker/setup-buildx-action@*
#   docker/login-action@*
#   docker/build-push-action@*

name: Deploy Demo

on:
  push:
    branches: [main]
  workflow_dispatch:

concurrency:
  group: deploy-demo
  cancel-in-progress: true

env:
  BACKEND_IMAGE: ghcr.io/ka2kama/ringiflow/backend
  FRONTEND_IMAGE: ghcr.io/ka2kama/ringiflow/frontend

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    timeout-minutes: 45
    steps:
      - uses: actions/checkout@v4

      - uses: docker/setup-buildx-action@v3

      - uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      # バックエンドイメージ（BFF / Core Service / Auth Service の3バイナリ）
      - name: Build and push backend image
        uses: docker/build-push-action@v6
        with:
          context: backend
          file: backend/Dockerfile
          build-args: CARGO_FEATURES=""
          push: true
          tags: ${{ env.BACKEND_IMAGE }}:latest
          cache-from: type=gha,scope=backend
          cache-to: type=gha,mode=max,scope=backend

      # フロントエンドイメージ（静的ファイル出力用）
      - name: Build and push frontend image
        uses: docker/build-push-action@v6
        with:
          context: frontend
          file: frontend/Dockerfile
          build-args: VITE_DEV_AUTH=true
          push: true
          tags: ${{ env.FRONTEND_IMAGE }}:latest
          cache-from: type=gha,scope=frontend
          cache-to: type=gha,mode=max,scope=frontend

      - name: Deploy to Lightsail
        env:
          SSH_KEY: ${{ secrets.LIGHTSAIL_SSH_KEY }}
          DEPLOY_HOST: ${{ secrets.LIGHTSAIL_HOST }}
          DEPLOY_USER: ${{ secrets.LIGHTSAIL_USER }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # SSH 鍵をセットアップ
          mkdir -p ~/.ssh
          echo "$SSH_KEY" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          SSH_OPTS="-i ~/.ssh/deploy_key -o StrictHostKeyChecking=accept-new"

          # 設定ファイルを転送（tar over SSH で IPv6 アドレスにも対応）
          STAGING=$(mktemp -d)
          cp infra/lightsail/docker-compose.yaml "$STAGING/"
          mkdir -p "$STAGING/config/nginx/conf.d" "$STAGING/config/init"
          cp infra/lightsail/nginx/nginx.conf "$STAGING/config/nginx/"
          cp infra/lightsail/nginx/conf.d/default.conf "$STAGING/config/nginx/conf.d/"
          cp infra/lightsail/init/01_extensions.sql "$STAGING/config/init/"
          tar -czf - -C "$STAGING" . \
            | ssh $SSH_OPTS "${DEPLOY_USER}@${DEPLOY_HOST}" \
                "mkdir -p ~/ringiflow && cd ~/ringiflow && tar -xzf -"
          rm -rf "$STAGING"

          # Lightsail 上でデプロイ実行
          ssh $SSH_OPTS "${DEPLOY_USER}@${DEPLOY_HOST}" << DEPLOY_EOF
          set -euo pipefail
          cd ~/ringiflow

          echo "[INFO] GHCR にログイン..."
          echo "${GH_TOKEN}" | docker login ghcr.io --username github-actions --password-stdin

          echo "[INFO] イメージを pull..."
          docker pull ${BACKEND_IMAGE}:latest
          docker pull ${FRONTEND_IMAGE}:latest

          echo "[INFO] フロントエンド静的ファイルを更新..."
          docker volume create ringiflow-frontend-dist 2>/dev/null || true
          docker run --rm \
            -v ringiflow-frontend-dist:/dist \
            ${FRONTEND_IMAGE}:latest \
            sh -c "rm -rf /dist/* && cp -r /app/dist/* /dist/"

          echo "[INFO] サービスを再起動..."
          docker compose up -d --remove-orphans

          echo "[INFO] ヘルスチェック..."
          sleep 15
          curl -sf http://localhost/health && echo " - Nginx: OK" || echo " - Nginx: NG"
          curl -sf http://localhost/api/health && echo " - BFF: OK" || echo " - BFF: NG"

          docker logout ghcr.io
          DEPLOY_EOF
