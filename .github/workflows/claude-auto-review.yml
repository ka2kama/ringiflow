# Claude Code Action 自動レビュー
#
# CI 完了後に自動でコードレビューを実行する。
# Draft PR は除外。
#
# 設計判断: [ADR-011](../../docs/05_ADR/011_Claude_Code_Action導入.md)
#
# 注意: workflow_run イベントは PR のステータスチェックに自動で紐付かないため、
# GitHub Status API を使って明示的にステータスを報告している。

name: Claude Auto Review

on:
  workflow_run:
    workflows: ["CI"]
    types:
      - completed

# 同時実行制御: 同一PRでの重複実行を防止
concurrency:
  group: ${{ github.workflow }}-${{ github.event.workflow_run.pull_requests[0].number || github.run_id }}
  cancel-in-progress: true

permissions:
  contents: read
  pull-requests: write
  issues: write
  actions: read
  statuses: write # Status API でステータスを報告するために必要
  id-token: write

jobs:
  auto-review:
    name: Auto Review
    runs-on: ubuntu-latest
    # PR 起因かつ CI 成功の場合のみ実行（Draft チェックはステップ内で実施）
    if: >
      github.event.workflow_run.event == 'pull_request' &&
      github.event.workflow_run.conclusion == 'success' &&
      github.event.workflow_run.pull_requests[0] != null

    env:
      STATUS_URL: repos/${{ github.repository }}/statuses/${{ github.event.workflow_run.head_sha }}
      RUN_URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}

    steps:
      - name: Report pending status
        env:
          GH_TOKEN: ${{ github.token }}
        # ステータス報告は補助機能のため、失敗してもワークフローを継続
        run: |
          gh api "$STATUS_URL" \
            -f state=pending \
            -f context="Claude Auto Review" \
            -f description="Running auto review..." \
            -f target_url="$RUN_URL" || true

      - name: Check if PR is draft
        id: check-draft
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          PR_NUMBER=${{ github.event.workflow_run.pull_requests[0].number }}
          IS_DRAFT=$(gh pr view "$PR_NUMBER" --repo "${{ github.repository }}" --json isDraft --jq '.isDraft')
          echo "is_draft=$IS_DRAFT" >> "$GITHUB_OUTPUT"

      - name: Report skipped status for draft PR
        if: steps.check-draft.outputs.is_draft == 'true'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          gh api "$STATUS_URL" \
            -f state=success \
            -f context="Claude Auto Review" \
            -f description="Skipped (draft PR)" \
            -f target_url="$RUN_URL" || true

      - name: Checkout
        if: steps.check-draft.outputs.is_draft == 'false'
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
          ref: ${{ github.event.workflow_run.head_sha }}

      - name: Run Claude Code Review
        id: review
        if: steps.check-draft.outputs.is_draft == 'false'
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          # workflow_run イベントでは track_progress はサポートされていない
          track_progress: false
          prompt: |
            REPO: ${{ github.repository }}
            PR NUMBER: ${{ github.event.workflow_run.pull_requests[0].number }}

            ## 基本方針

            CLAUDE.md に記載されたプロジェクト理念と品質基準に基づいてレビューしてください。
            特に以下の2つの理念を意識すること:
            - 理念1: 学習効果の最大化
            - 理念2: 品質の追求

            ## レビュー観点（CLAUDE.md を補完）

            ### 必須チェック

            1. バグ・正確性: 実行時エラー、ロジックミス、エッジケースの見落とし
            2. セキュリティ: 脆弱性、認証/認可の問題、機密データの露出
            3. パフォーマンス: 明らかなボトルネック、N+1クエリ、メモリリーク
            4. 型システムの活用: Rust/Elmの強みを活かしているか
            5. テスト: 新機能・バグ修正に対応するテストがあるか
            6. 設計: 責務の混在、依存関係の方向違反、過度な複雑さ

            ### 学習機会の提供

            設計判断を伴う重要な箇所では、学習のため簡潔に解説する:
            - なぜその実装が良い/悪いのか
            - 代替案があればトレードオフとともに提示

            すべての箇所に解説は不要。学びになるポイントのみ。

            ### 指摘しないこと

            - コードスタイルの好み（フォーマッタが担う領域）
            - 既存コードとの些細な不整合（このPRの責務外）
            - 明確な理由のない「こうした方がより良い」

            ## フィードバック方法

            - コード固有の問題: `mcp__github_inline_comment__create_inline_comment` でインラインコメント
            - 全体的なフィードバック: `gh pr comment` でPRコメント

            ## 承認判断

            | 重大度 | 基準 | アクション |
            |--------|------|-----------|
            | Critical/High | マージ前に必ず修正が必要 | `gh pr review --request-changes` |
            | Medium/Low | 改善推奨だがマージ可能 | `gh pr review --approve` + コメント |
            | None | 問題なし | `gh pr review --approve` |

            学習のための解説コメントは承認判断に影響しない。
            問題がなければ、躊躇なく承認してください。

            ## 承認メッセージの書き方

            `gh pr review --approve -b "メッセージ"` の承認メッセージは簡潔に要点のみ記載する。

            構成:
            - 1行目: 結論（LGTM / 軽微な指摘あり など）
            - 2行目以降（任意）: 軽微な指摘がある場合のみ、箇条書きで要約

            良い例:
            ```
            LGTM
            ```

            ```
            軽微な指摘をコメントしました
            - 変数名の改善提案（任意）
            - ドキュメントの typo
            ```

            書かないこと:
            - インラインコメントで既に詳述した内容の繰り返し
            - PRの変更内容の説明（PR作成者は既に知っている）
            - 各ファイルごとの詳細なレビュー結果

            詳細なフィードバックはインラインコメントで行い、承認メッセージはサマリーに留める。
          claude_args: |
            --max-turns 40
            --allowedTools "Bash(gh pr view:*),Bash(gh pr list:*),Bash(gh pr diff:*),Bash(gh pr checks:*),Bash(gh pr comment:*),Bash(gh pr review:*),Bash(git log:*),Bash(git diff:*),Bash(git show:*),Bash(git status:*),mcp__github_inline_comment__create_inline_comment"

      - name: Report success status
        if: steps.check-draft.outputs.is_draft == 'false' && steps.review.outcome == 'success'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          gh api "$STATUS_URL" \
            -f state=success \
            -f context="Claude Auto Review" \
            -f description="Review completed" \
            -f target_url="$RUN_URL" || true

      - name: Report failure status
        if: always() && steps.check-draft.outputs.is_draft == 'false' && steps.review.outcome == 'failure'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          gh api "$STATUS_URL" \
            -f state=failure \
            -f context="Claude Auto Review" \
            -f description="Review failed" \
            -f target_url="$RUN_URL" || true
