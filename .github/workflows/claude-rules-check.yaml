# Claude Rules Check
#
# CI 完了後に .claude/rules/ のルール準拠をチェックする。
# Draft PR は除外。
#
# 責務分離:
# - このワークフロー: ルール準拠チェック（違反時のみ request-changes、それ以外は comment）
# - claude-auto-review.yaml: コード品質レビュー + 承認判断（approve/request-changes）
#
# 重要: このワークフローは --approve を使用しない。
# 承認権限は Auto Review に一元化し、誤った承認を防ぐ。

name: Claude Rules Check

on:
  workflow_run:
    workflows: ["CI"]
    types:
      - completed

concurrency:
  group: ${{ github.workflow }}-${{ github.event.workflow_run.pull_requests[0].number || github.run_id }}
  cancel-in-progress: true

permissions:
  contents: read
  pull-requests: write
  issues: write
  actions: read
  statuses: write
  id-token: write

jobs:
  rules-check:
    name: Claude Rules Check
    runs-on: ubuntu-latest
    if: >
      github.event.workflow_run.event == 'pull_request' &&
      github.event.workflow_run.conclusion == 'success' &&
      github.event.workflow_run.pull_requests[0] != null

    env:
      STATUS_URL: repos/${{ github.repository }}/statuses/${{ github.event.workflow_run.head_sha }}
      RUN_URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}

    steps:
      - name: Report pending status
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          gh api "$STATUS_URL" \
            -f state=pending \
            -f context="Claude Rules Check" \
            -f description="Checking rules compliance..." \
            -f target_url="$RUN_URL" || true

      - name: Check if PR is draft
        id: check-draft
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          PR_NUMBER=${{ github.event.workflow_run.pull_requests[0].number }}
          IS_DRAFT=$(gh pr view "$PR_NUMBER" --repo "${{ github.repository }}" --json isDraft --jq '.isDraft')
          echo "is_draft=$IS_DRAFT" >> "$GITHUB_OUTPUT"

      - name: Report skipped status for draft PR
        if: steps.check-draft.outputs.is_draft == 'true'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          gh api "$STATUS_URL" \
            -f state=success \
            -f context="Claude Rules Check" \
            -f description="Skipped (draft PR)" \
            -f target_url="$RUN_URL" || true

      - name: Checkout
        if: steps.check-draft.outputs.is_draft == 'false'
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
          ref: ${{ github.event.workflow_run.head_sha }}

      - name: Fetch PR comments
        id: pr-comments
        if: steps.check-draft.outputs.is_draft == 'false'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          PR_NUMBER=${{ github.event.workflow_run.pull_requests[0].number }}

          # PR コメントと Review コメントを取得（最新20件、claude[bot] 自身を除外）
          COMMENTS=$(gh api "repos/${{ github.repository }}/issues/${PR_NUMBER}/comments" \
            --jq '[.[] | select(.user.login != "claude[bot]") | {author: .user.login, body: .body, created_at: .created_at}] | .[-20:]' 2>/dev/null || echo "[]")

          REVIEW_COMMENTS=$(gh api "repos/${{ github.repository }}/pulls/${PR_NUMBER}/comments" \
            --jq '[.[] | select(.user.login != "claude[bot]") | {author: .user.login, body: .body, path: .path, created_at: .created_at}] | .[-20:]' 2>/dev/null || echo "[]")

          # JSON を環境ファイルに出力（multiline safe）
          {
            echo "PR_COMMENTS<<EOF_COMMENTS"
            echo "$COMMENTS"
            echo "EOF_COMMENTS"
            echo "REVIEW_COMMENTS<<EOF_REVIEW"
            echo "$REVIEW_COMMENTS"
            echo "EOF_REVIEW"
          } >> "$GITHUB_OUTPUT"

      - name: Build review context
        id: review-context
        if: steps.check-draft.outputs.is_draft == 'false'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          PR_NUMBER=${{ github.event.workflow_run.pull_requests[0].number }}
          CURRENT_SHA="${{ github.event.workflow_run.head_sha }}"

          # claude[bot] の直近レビューのコミット SHA を取得
          LAST_REVIEW_SHA=$(gh api "repos/${{ github.repository }}/pulls/${PR_NUMBER}/reviews" \
            --jq '[.[] | select(.user.login == "claude[bot]")] | last | .commit_id // empty')

          {
            echo "REVIEW_MODE<<REVIEW_MODE_EOF"
            if [ -n "$LAST_REVIEW_SHA" ] && [ "$LAST_REVIEW_SHA" != "$CURRENT_SHA" ] && git cat-file -e "${LAST_REVIEW_SHA}" 2>/dev/null; then
              echo "### 増分チェックモード（Re-check）"
              echo ""
              echo "前回チェックコミット: ${LAST_REVIEW_SHA}"
              echo "今回のコミット: ${CURRENT_SHA}"
              echo ""
              echo "これは再チェック（前回のチェック後に修正が push された）です。"
              echo "以下の方針でチェックしてください:"
              echo ""
              echo "1. **前回指摘したルール違反が修正されたか確認**"
              echo "2. **新しく変更されたファイルについてのみルール準拠をチェック**"
              echo "3. **前回問題がなかった箇所の再チェックは不要**"
              echo ""
              echo "#### 前回チェック以降の差分"
              echo ""
              echo '```diff'
              git diff "${LAST_REVIEW_SHA}..${CURRENT_SHA}" -- . ':!*.lock' 2>/dev/null | head -c 50000 || echo "(差分取得に失敗)"
              echo '```'
              echo ""
              echo "注: 差分が大きい場合は 50KB で切り詰めています。完全な差分は gh pr diff で確認してください。"
            else
              echo "### 初回チェック"
              echo ""
              echo "PR 全体のルール準拠をチェックしてください。"
            fi
            echo "REVIEW_MODE_EOF"
          } >> "$GITHUB_OUTPUT"

      - name: Run Claude Rules Check
        id: check
        if: steps.check-draft.outputs.is_draft == 'false'
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          track_progress: false
          # Dependabot などの Bot からの PR を許可
          allowed_bots: "dependabot[bot]"
          prompt: |
            REPO: ${{ github.repository }}
            PR NUMBER: ${{ github.event.workflow_run.pull_requests[0].number }}

            ## PR コメント（議論の文脈）

            以下は PR 上でのこれまでの議論です。チェック前に必ず目を通し、文脈を理解してください。

            ### PR コメント
            ```json
            ${{ steps.pr-comments.outputs.PR_COMMENTS }}
            ```

            ### レビューコメント（インラインコメント）
            ```json
            ${{ steps.pr-comments.outputs.REVIEW_COMMENTS }}
            ```

            ## チェックモード

            ${{ steps.review-context.outputs.REVIEW_MODE }}

            ## 言語

            コメントは日本語で記述する。
            CLAUDE.md の「応答は英語」はCLI対話に限定され、PRレビューには適用されない。

            ## 目的

            この PR が `.claude/rules/` に定義されたルールに準拠しているかチェックする。
            コードの品質や設計に関する詳細なレビューは別のワークフロー（Code Review）で行う。

            ## 手順

            1. `gh pr diff` で変更されたファイルパスを取得
            2. `.claude/rules/` 内の各ルールファイルを読み、`paths:` パターンとマッチするか確認
            3. マッチしたルールファイルの内容に基づいて、変更がルールに準拠しているかチェック

            ## チェック観点

            各ルールファイルに記載された内容のみをチェックする:
            - コーディング規約（命名、構造、スタイル）
            - 必須の手順（テスト、ドキュメント更新など）
            - 禁止事項

            ### 過去の議論を踏まえた判断

            PR コメントで既に議論された内容については、以下のように判断する:

            | コメントの内容 | 対応 |
            |---------------|------|
            | 正当な理由が説明されている（設計意図、別のルールでカバー済み等） | 尊重し、再指摘しない |
            | 単なる質問、未解決の議論 | 必要に応じて追加コメント |
            | 「後で直す」「TODO」などの保留 | 必要に応じてリマインド |

            過去の議論を踏まえた上で、なお指摘が必要と判断した場合は、その理由を明記する。

            ## フィードバック方法

            1. ルール違反がある場合: `mcp__github_inline_comment__create_inline_comment` で該当箇所にコメント
               - 該当ルールを引用して指摘
            2. 全体フィードバック: `gh pr review` でレビューを投稿
               - ルール違反あり → `--request-changes` with 違反内容のサマリー
               - ルール違反なし → `--comment` with "Rules Check: LGTM ✅" + チェックしたルール一覧

            **重要:** ルール違反がない場合でも `--approve` は使用しない。
            承認判断は Auto Review ワークフローが担当する。

            ## 注意

            - コードの品質、設計、セキュリティ、パフォーマンスについては指摘しない（Code Review の責務）
            - ルールに明記されていない「好み」の指摘はしない
            - 長いコメントを投稿する際は HEREDOC 形式を使用すること:
              ```bash
              gh pr comment 93 --body "$(cat <<'EOF'
              複数行のコメント
              EOF
              )"
              ```
          claude_args: |
            --max-turns 40
            --allowedTools "Read,Bash(cat:*),Bash(grep:*),Bash(find:*),Bash(gh pr view:*),Bash(gh pr diff:*),Bash(gh pr comment:*),Bash(gh pr review:*),Bash(git diff:*),mcp__github_inline_comment__create_inline_comment"

      - name: Check review decision
        id: review-decision
        if: steps.check-draft.outputs.is_draft == 'false' && steps.check.outcome == 'success'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          PR_NUMBER=${{ github.event.workflow_run.pull_requests[0].number }}
          # claude[bot] の最新レビュー状態を取得
          REVIEW_STATE=$(gh api "repos/${{ github.repository }}/pulls/${PR_NUMBER}/reviews" \
            --jq '[.[] | select(.user.login == "claude[bot]")] | last | .state // "NONE"')
          echo "review_state=$REVIEW_STATE" >> "$GITHUB_OUTPUT"
          echo "Claude review state: $REVIEW_STATE"

      - name: Report success status
        if: steps.check-draft.outputs.is_draft == 'false' && steps.check.outcome == 'success' && steps.review-decision.outputs.review_state != 'CHANGES_REQUESTED'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          gh api "$STATUS_URL" \
            -f state=success \
            -f context="Claude Rules Check" \
            -f description="Rules check completed" \
            -f target_url="$RUN_URL" || true

      - name: Report failure status (changes requested)
        if: steps.check-draft.outputs.is_draft == 'false' && steps.check.outcome == 'success' && steps.review-decision.outputs.review_state == 'CHANGES_REQUESTED'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          gh api "$STATUS_URL" \
            -f state=failure \
            -f context="Claude Rules Check" \
            -f description="Rule violations found" \
            -f target_url="$RUN_URL" || true

      - name: Report failure status (action failed)
        if: always() && steps.check-draft.outputs.is_draft == 'false' && steps.check.outcome == 'failure'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          gh api "$STATUS_URL" \
            -f state=failure \
            -f context="Claude Rules Check" \
            -f description="Rules check failed" \
            -f target_url="$RUN_URL" || true
