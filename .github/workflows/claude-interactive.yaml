# Claude Code Action インタラクティブレビュー
#
# PRコメントで @claude メンションに応答する。
#
# 設計判断: [ADR-011](../../docs/05_ADR/011_Claude_Code_Action導入.md)

name: Claude Interactive

on:
  issue_comment:
    types: [created]
  pull_request_review_comment:
    types: [created]

# 同時実行制御: 同一PRでの重複実行を防止
# コメントIDを含めることで、Bot自身のコメントによる自己キャンセルを防止
concurrency:
  group: ${{ github.workflow }}-${{ github.event.issue.number || github.event.pull_request.number }}-${{ github.event.comment.id }}
  cancel-in-progress: false

permissions:
  contents: read
  pull-requests: write
  issues: write
  actions: read
  id-token: write

jobs:
  interactive-review:
    name: Interactive Review
    runs-on: ubuntu-latest
    # @claude メンションを含むコメントのみ
    # Bot 自身のコメントは除外（無限ループ防止）
    if: >
      contains(github.event.comment.body, '@claude') &&
      github.event.comment.user.login != 'claude[bot]' &&
      github.event.comment.user.login != 'github-actions[bot]'

    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Run Claude Code
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          claude_args: |
            --max-turns 40
            --allowedTools "Bash(gh pr view:*),Bash(gh pr list:*),Bash(gh pr diff:*),Bash(gh pr checks:*),Bash(gh pr comment:*),Bash(gh pr review:*),Bash(git log:*),Bash(git diff:*),Bash(git show:*),Bash(git status:*),mcp__github_inline_comment__create_inline_comment"
