# RingiFlow CI ワークフロー
#
# 設計判断: [ADR-004](../../docs/05_ADR/004_CI並列化と変更検出.md)
# 技術詳細: [GitHub Actions](../../docs/06_ナレッジベース/devtools/GitHubActions.md)

name: CI

on:
  push:
    branches:
      - main
      - develop
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]
    branches:
      - main
      - develop

jobs:
  # 変更検出: 変更されたファイルを検出し、必要なジョブのみを実行
  changes:
    name: Detect Changes
    runs-on: ubuntu-latest
    outputs:
      rust: ${{ steps.filter.outputs.rust }}
      elm: ${{ steps.filter.outputs.elm }}
      shell: ${{ steps.filter.outputs.shell }}
      ci: ${{ steps.filter.outputs.ci }}
      openapi: ${{ steps.filter.outputs.openapi }}
      api-test: ${{ steps.filter.outputs.api-test }}
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          # paths-filter が差分比較に履歴を必要とするため全履歴を取得
          fetch-depth: 0

      - name: Filter paths
        uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            rust:
              - 'backend/**'
            elm:
              - 'frontend/**'
            shell:
              - '**/*.sh'
            ci:
              - '.github/workflows/**'
            openapi:
              - 'openapi/**'
            api-test:
              - 'backend/**'
              - 'tests/api/**'

  # Rust チェック: リント、テスト
  rust:
    name: Rust
    runs-on: ubuntu-latest
    needs: changes
    if: needs.changes.outputs.rust == 'true'

    env:
      CARGO_TERM_COLOR: always
      RUST_BACKTRACE: 1
      SQLX_OFFLINE: true  # CI では DB 接続なしでビルド

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup Rust toolchain (stable)
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: 1.93.0
          components: clippy

      # rustfmt の unstable 機能を使用するため nightly が必要
      - name: Setup Rust toolchain (nightly)
        uses: dtolnay/rust-toolchain@nightly
        with:
          components: rustfmt

      - name: Cache Cargo
        uses: actions/cache@v5
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            backend/target/
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-

      - name: Install just
        uses: extractions/setup-just@v3

      - name: Lint
        run: just lint-rust

      - name: Test (unit tests)
        # 統合テスト（tests/）は rust-integration ジョブで実行
        run: cargo test --release --all-features --lib --bins
        working-directory: backend

      - name: Verify production build (no dev features)
        # 本番ビルド（dev-auth feature 除外）がコンパイルできることを検証
        run: cargo build --release --no-default-features --bin ringiflow-bff
        working-directory: backend

  # Rust 統合テスト: PostgreSQL / Redis を使用するテスト
  rust-integration:
    name: Rust Integration
    runs-on: ubuntu-latest
    needs: changes
    if: needs.changes.outputs.rust == 'true'

    services:
      postgres:
        image: postgres:17
        ports:
          - 15432:5432
        env:
          POSTGRES_USER: ringiflow
          POSTGRES_PASSWORD: ringiflow
          POSTGRES_DB: ringiflow_test
        options: >-
          --health-cmd "pg_isready -U ringiflow"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

      redis:
        image: redis:7
        ports:
          - 16379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    env:
      CARGO_TERM_COLOR: always
      RUST_BACKTRACE: 1
      SQLX_OFFLINE: true
      DATABASE_URL: postgres://ringiflow:ringiflow@localhost:15432/ringiflow_test
      REDIS_URL: redis://localhost:16379

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: 1.93.0

      - name: Cache Cargo
        uses: actions/cache@v5
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            backend/target/
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-

      - name: Install sqlx-cli
        run: cargo install sqlx-cli --no-default-features --features rustls,postgres

      - name: Run migrations
        run: sqlx migrate run
        working-directory: backend

      - name: Test (integration tests)
        run: cargo test --release --all-features --test '*'
        working-directory: backend

  # Elm チェック: リント、テスト、ビルド
  elm:
    name: Elm
    runs-on: ubuntu-latest
    needs: changes
    if: needs.changes.outputs.elm == 'true'

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '22'

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10

      - name: Install npm dependencies
        run: pnpm install --frozen-lockfile
        working-directory: frontend

      # elm-test は devDependencies、elm と elm-format はグローバル
      - name: Install Elm tools
        run: npm install -g elm elm-format

      - name: Install just
        uses: extractions/setup-just@v3

      - name: Lint
        run: just lint-elm

      - name: Test
        run: just test-elm

      - name: Build
        run: pnpm run build
        working-directory: frontend

      - name: Upload build artifacts
        uses: actions/upload-artifact@v6
        with:
          name: web-dist
          path: frontend/dist/
          retention-days: 7

  # シェルスクリプト・CI ワークフロー チェック: ShellCheck + actionlint
  shell:
    name: Shell
    runs-on: ubuntu-latest
    needs: changes
    if: needs.changes.outputs.shell == 'true' || needs.changes.outputs.ci == 'true'

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Install just
        uses: extractions/setup-just@v3

      - name: Lint shell scripts
        if: needs.changes.outputs.shell == 'true'
        run: just lint-shell

      - name: Install actionlint
        if: needs.changes.outputs.ci == 'true'
        run: |
          bash <(curl -sSL https://raw.githubusercontent.com/rhysd/actionlint/main/scripts/download-actionlint.bash)
          sudo mv actionlint /usr/local/bin/

      - name: Lint GitHub Actions
        if: needs.changes.outputs.ci == 'true'
        run: just lint-ci

  # OpenAPI 仕様書 チェック: Redocly CLI で lint
  openapi:
    name: OpenAPI
    runs-on: ubuntu-latest
    needs: changes
    if: needs.changes.outputs.openapi == 'true'

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '22'

      - name: Install just
        uses: extractions/setup-just@v3

      - name: Lint OpenAPI
        run: just lint-openapi

  # API テスト: 実際のサービスを起動して hurl でテスト
  api-test:
    name: API Test
    runs-on: ubuntu-latest
    needs: changes
    if: needs.changes.outputs.api-test == 'true'

    env:
      CARGO_TERM_COLOR: always
      SQLX_OFFLINE: true

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: 1.93.0

      - name: Cache Cargo
        uses: actions/cache@v5
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            backend/target/
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-

      - name: Install hurl
        run: |
          HURL_VERSION=7.1.0
          curl -sSL "https://github.com/Orange-OpenSource/hurl/releases/download/${HURL_VERSION}/hurl-${HURL_VERSION}-x86_64-unknown-linux-gnu.tar.gz" -o hurl.tar.gz
          tar xzf hurl.tar.gz
          sudo mv "hurl-${HURL_VERSION}-x86_64-unknown-linux-gnu/bin/hurl" /usr/local/bin/
          rm -rf hurl.tar.gz "hurl-${HURL_VERSION}-x86_64-unknown-linux-gnu"

      - name: Install sqlx-cli
        run: |
          if ! command -v sqlx &> /dev/null; then
            cargo install sqlx-cli --no-default-features --features rustls,postgres
          fi

      - name: Install just
        uses: extractions/setup-just@v3

      - name: Start dependencies
        run: just api-test-deps

      - name: Reset database
        run: just api-test-reset-db

      - name: Build services
        run: cargo build --release
        working-directory: backend

      - name: Run API tests
        run: |
          # ログディレクトリ作成
          mkdir -p /tmp/api-test-logs

          # サービスをバックグラウンドで起動（ログをファイルに出力）
          cd backend
          set -a && source .env.api-test && set +a
          ./target/release/ringiflow-bff > /tmp/api-test-logs/bff.log 2>&1 &
          ./target/release/ringiflow-core-service > /tmp/api-test-logs/core.log 2>&1 &
          ./target/release/ringiflow-auth-service > /tmp/api-test-logs/auth.log 2>&1 &
          cd ..

          # ヘルスチェック待機
          for i in {1..30}; do
            if curl -sf http://localhost:14000/health > /dev/null 2>&1 && \
               curl -sf http://localhost:14001/health > /dev/null 2>&1 && \
               curl -sf http://localhost:14002/health > /dev/null 2>&1; then
              echo "All services are healthy"
              break
            fi
            if [ "$i" -eq 30 ]; then
              echo "Service startup timeout. Showing logs:"
              echo "=== BFF ===" && cat /tmp/api-test-logs/bff.log
              echo "=== Core Service ===" && cat /tmp/api-test-logs/core.log
              echo "=== Auth Service ===" && cat /tmp/api-test-logs/auth.log
              exit 1
            fi
            sleep 1
          done

          # テスト実行
          hurl --test --jobs 1 --variables-file tests/api/hurl/vars.env tests/api/hurl/**/*.hurl

      - name: Cleanup
        if: always()
        run: just api-test-clean

  # セキュリティチェック: 依存関係の脆弱性・ライセンスチェック
  security:
    name: Security
    runs-on: ubuntu-latest
    needs: changes
    if: needs.changes.outputs.rust == 'true'

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Check dependencies
        uses: EmbarkStudios/cargo-deny-action@v2
        with:
          manifest-path: backend/Cargo.toml
          command: check
          arguments: --all-features

  # ブランチ保護用ステータス統合: skipped を成功扱いにし、単一ステータスを提供
  ci-success:
    name: CI Success
    runs-on: ubuntu-latest
    needs: [changes, rust, rust-integration, elm, shell, openapi, api-test, security]
    if: always()
    steps:
      - name: Check results
        run: |
          if [[ "${{ needs.changes.result }}" == "failure" ]]; then
            echo "Changes detection failed"
            exit 1
          fi

          if [[ "${{ needs.rust.result }}" == "failure" ]]; then
            echo "Rust checks failed"
            exit 1
          fi

          if [[ "${{ needs.rust-integration.result }}" == "failure" ]]; then
            echo "Rust integration tests failed"
            exit 1
          fi

          if [[ "${{ needs.elm.result }}" == "failure" ]]; then
            echo "Elm checks failed"
            exit 1
          fi

          if [[ "${{ needs.shell.result }}" == "failure" ]]; then
            echo "Shell checks failed"
            exit 1
          fi

          if [[ "${{ needs.openapi.result }}" == "failure" ]]; then
            echo "OpenAPI checks failed"
            exit 1
          fi

          if [[ "${{ needs.api-test.result }}" == "failure" ]]; then
            echo "API tests failed"
            exit 1
          fi

          if [[ "${{ needs.security.result }}" == "failure" ]]; then
            echo "Security checks failed"
            exit 1
          fi

          echo "All checks passed!"
