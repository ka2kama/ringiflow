# 週次レトロスペクティブ Issue の自動作成
#
# 毎週月曜 9:00 JST に `/retro` 実施を促す Issue を作成する。
# 手動トリガー（workflow_dispatch）にも対応。

name: Weekly Retro

on:
  schedule:
    # 毎週月曜 0:00 UTC = 9:00 JST
    - cron: "0 0 * * 1"
  workflow_dispatch:

permissions:
  contents: read
  issues: write

jobs:
  create-retro-issue:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout reports
        uses: actions/checkout@v6
        with:
          sparse-checkout: prompts/reports
          sparse-checkout-cone-mode: true

      - name: Calculate period from last retro
        id: period
        run: |
          TODAY=$(date +%Y-%m-%d)

          # 前回のレトロスペクティブレポートを検索（最新順）
          LAST_RETRO=$(find prompts/reports -maxdepth 1 -name '*_レトロスペクティブ.md' 2>/dev/null | sort -r | head -1)

          if [ -n "$LAST_RETRO" ]; then
            # ファイル名から日付を抽出（YYYY-MM-DD_HHMM_レトロスペクティブ.md）
            START=$(basename "$LAST_RETRO" | cut -d'_' -f1)
          else
            # フォールバック: 7日前
            START=$(date -d "7 days ago" +%Y-%m-%d)
          fi

          {
            echo "start=${START}"
            echo "end=${TODAY}"
            echo "today=${TODAY}"
          } >> "$GITHUB_OUTPUT"

      - name: Create retro issue
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GH_REPO: ${{ github.repository }}
        run: |
          gh issue create \
            --title "週次レトロスペクティブ (${{ steps.period.outputs.today }})" \
            --label "process" \
            --body "$(cat <<'BODY'
          ## 概要

          週次レトロスペクティブの実施 Issue。

          対象期間: ${{ steps.period.outputs.start }} 〜 ${{ steps.period.outputs.end }}

          ## チェックリスト

          - [ ] `/retro` を実行（フルモードまたは `quick`）
          - [ ] レポートを `prompts/reports/` に保存
          - [ ] アクションアイテムから必要な Issue を作成

          ## 実施方法

          ```
          /retro
          ```

          軽量に済ませたい場合:
          ```
          /retro quick
          ```

          → スキル詳細: `.claude/skills/retro/SKILL.md`
          BODY
          )"
