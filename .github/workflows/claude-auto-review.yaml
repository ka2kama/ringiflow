# Claude Code Action 自動レビュー
#
# CI 完了後に自動でコードレビューを実行する。
# Draft PR は除外。
#
# 責務分離:
# - このワークフロー:
#   - Verification（コード品質、設計、セキュリティ）→ Opus
#   - Validation（完了基準との整合）→ Sonnet
# - claude-rules-check.yaml: .claude/rules/ のルール準拠チェック
#
# ジョブ構成:
#   setup → verification (並列) → finalize
#         → validation  (並列) →
#
# 設計判断: [ADR-011](../../docs/70_ADR/011_Claude_Code_Action導入.md)
#
# 注意: workflow_run イベントは PR のステータスチェックに自動で紐付かないため、
# GitHub Status API を使って明示的にステータスを報告している。

name: Claude Auto Review

on:
  workflow_run:
    workflows: ["CI"]
    types:
      - completed

# 同時実行制御: 同一PRでの重複実行を防止
concurrency:
  group: ${{ github.workflow }}-${{ github.event.workflow_run.pull_requests[0].number || github.run_id }}
  cancel-in-progress: true

permissions:
  contents: read
  pull-requests: write
  issues: write
  actions: read
  statuses: write # Status API でステータスを報告するために必要
  id-token: write

jobs:
  # ──────────────────────────────────────────────
  # setup: 共通前処理（draft check, コンテキスト収集）
  # ──────────────────────────────────────────────
  setup:
    name: Setup
    runs-on: ubuntu-latest
    # PR 起因かつ CI 成功の場合のみ実行（Draft チェックはステップ内で実施）
    if: >
      github.event.workflow_run.event == 'pull_request' &&
      github.event.workflow_run.conclusion == 'success' &&
      github.event.workflow_run.pull_requests[0] != null

    outputs:
      is_draft: ${{ steps.check-draft.outputs.is_draft }}
      pr_number: ${{ steps.set-pr-number.outputs.pr_number }}
      PR_COMMENTS: ${{ steps.pr-comments.outputs.PR_COMMENTS }}
      REVIEW_COMMENTS: ${{ steps.pr-comments.outputs.REVIEW_COMMENTS }}
      REVIEW_MODE: ${{ steps.review-context.outputs.REVIEW_MODE }}
      VALIDATION_CONTEXT: ${{ steps.validation-context.outputs.VALIDATION_CONTEXT }}

    env:
      STATUS_URL: repos/${{ github.repository }}/statuses/${{ github.event.workflow_run.head_sha }}
      RUN_URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}

    steps:
      - name: Report pending status
        env:
          GH_TOKEN: ${{ github.token }}
        # ステータス報告は補助機能のため、失敗してもワークフローを継続
        run: |
          gh api "$STATUS_URL" \
            -f state=pending \
            -f context="Claude Auto Review" \
            -f description="Running auto review..." \
            -f target_url="$RUN_URL" || true

      - name: Set PR number
        id: set-pr-number
        run: |
          echo "pr_number=${{ github.event.workflow_run.pull_requests[0].number }}" >> "$GITHUB_OUTPUT"

      - name: Check if PR is draft
        id: check-draft
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          PR_NUMBER=${{ github.event.workflow_run.pull_requests[0].number }}
          IS_DRAFT=$(gh pr view "$PR_NUMBER" --repo "${{ github.repository }}" --json isDraft --jq '.isDraft')
          echo "is_draft=$IS_DRAFT" >> "$GITHUB_OUTPUT"

      - name: Report skipped status for draft PR
        if: steps.check-draft.outputs.is_draft == 'true'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          gh api "$STATUS_URL" \
            -f state=success \
            -f context="Claude Auto Review" \
            -f description="Skipped (draft PR)" \
            -f target_url="$RUN_URL" || true

      - name: Checkout
        if: steps.check-draft.outputs.is_draft == 'false'
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
          ref: ${{ github.event.workflow_run.head_sha }}

      - name: Fetch PR comments
        id: pr-comments
        if: steps.check-draft.outputs.is_draft == 'false'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          PR_NUMBER=${{ github.event.workflow_run.pull_requests[0].number }}

          # PR コメントと Review コメントを取得（最新20件、claude[bot] 自身を除外）
          COMMENTS=$(gh api "repos/${{ github.repository }}/issues/${PR_NUMBER}/comments" \
            --jq '[.[] | select(.user.login != "claude[bot]") | {author: .user.login, body: .body, created_at: .created_at}] | .[-20:]' 2>/dev/null || echo "[]")

          REVIEW_COMMENTS=$(gh api "repos/${{ github.repository }}/pulls/${PR_NUMBER}/comments" \
            --jq '[.[] | select(.user.login != "claude[bot]") | {author: .user.login, body: .body, path: .path, created_at: .created_at}] | .[-20:]' 2>/dev/null || echo "[]")

          # JSON を環境ファイルに出力（multiline safe）
          {
            echo "PR_COMMENTS<<EOF_COMMENTS"
            echo "$COMMENTS"
            echo "EOF_COMMENTS"
            echo "REVIEW_COMMENTS<<EOF_REVIEW"
            echo "$REVIEW_COMMENTS"
            echo "EOF_REVIEW"
          } >> "$GITHUB_OUTPUT"

      - name: Build review context
        id: review-context
        if: steps.check-draft.outputs.is_draft == 'false'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          PR_NUMBER=${{ github.event.workflow_run.pull_requests[0].number }}
          CURRENT_SHA="${{ github.event.workflow_run.head_sha }}"

          # claude[bot] の直近レビューのコミット SHA を取得
          LAST_REVIEW_SHA=$(gh api "repos/${{ github.repository }}/pulls/${PR_NUMBER}/reviews" \
            --jq '[.[] | select(.user.login == "claude[bot]")] | last | .commit_id // empty')

          {
            echo "REVIEW_MODE<<REVIEW_MODE_EOF"
            if [ -n "$LAST_REVIEW_SHA" ] && [ "$LAST_REVIEW_SHA" != "$CURRENT_SHA" ] && git cat-file -e "${LAST_REVIEW_SHA}" 2>/dev/null; then
              echo "### 増分レビューモード（Re-review）"
              echo ""
              echo "前回レビューコミット: ${LAST_REVIEW_SHA}"
              echo "今回のコミット: ${CURRENT_SHA}"
              echo ""
              echo "これは再レビュー（前回のレビュー後に修正が push された）です。"
              echo "以下の方針でレビューしてください:"
              echo ""
              echo "1. **前回の指摘事項の確認**: PR コメントやインラインコメントで前回指摘した内容が適切に修正されたか確認"
              echo "2. **新しい変更のみレビュー**: 前回レビュー後に追加・変更されたコードに集中"
              echo "3. **既にレビュー済みの箇所は省略**: 前回問題がなかった箇所の再レビューは不要"
              echo ""
              echo "#### 前回レビュー以降の差分"
              echo ""
              echo '```diff'
              git diff "${LAST_REVIEW_SHA}..${CURRENT_SHA}" -- . ':!*.lock' 2>/dev/null | head -c 50000 || echo "(差分取得に失敗)"
              echo '```'
              echo ""
              echo "注: 差分が大きい場合は 50KB で切り詰めています。完全な差分は gh pr diff で確認してください。"
            else
              echo "### 初回レビュー"
              echo ""
              echo "PR 全体をレビューしてください。"
            fi
            echo "REVIEW_MODE_EOF"
          } >> "$GITHUB_OUTPUT"

      - name: Fetch validation context
        id: validation-context
        if: steps.check-draft.outputs.is_draft == 'false'
        env:
          GH_TOKEN: ${{ github.token }}
          PR_NUMBER: ${{ github.event.workflow_run.pull_requests[0].number }}
          GH_REPO: ${{ github.repository }}
        run: ./scripts/ci/fetch-validation-context.sh

  # ──────────────────────────────────────────────
  # verification: コード品質レビュー（Opus）
  # ──────────────────────────────────────────────
  verification:
    name: Verification
    runs-on: ubuntu-latest
    needs: setup
    if: needs.setup.outputs.is_draft == 'false'

    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
          ref: ${{ github.event.workflow_run.head_sha }}

      - name: Run Claude Verification
        id: verification
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          track_progress: false
          allowed_bots: "dependabot[bot]"
          prompt: |
            REPO: ${{ github.repository }}
            PR NUMBER: ${{ needs.setup.outputs.pr_number }}

            ## PR コメント（議論の文脈）

            以下は PR 上でのこれまでの議論です。レビュー前に必ず目を通し、文脈を理解してください。

            ### PR コメント
            ```json
            ${{ needs.setup.outputs.PR_COMMENTS }}
            ```

            ### レビューコメント（インラインコメント）
            ```json
            ${{ needs.setup.outputs.REVIEW_COMMENTS }}
            ```

            ## レビューモード

            ${{ needs.setup.outputs.REVIEW_MODE }}

            ## 言語

            レビューコメントは日本語で記述する。
            CLAUDE.md の「応答は英語」はCLI対話に限定され、PRレビューには適用されない。

            ## 基本方針

            CLAUDE.md に記載されたプロジェクト理念と品質基準に基づいてレビューしてください。
            特に以下の2つの理念を意識すること:
            - 理念1: 学習効果の最大化
            - 理念2: 品質の追求

            ## レビュー観点

            ### Verification チェック（コードの品質）

            1. バグ・正確性: 実行時エラー、ロジックミス、エッジケースの見落とし
            2. セキュリティ: 脆弱性、認証/認可の問題、機密データの露出
            3. パフォーマンス: 明らかなボトルネック、N+1クエリ、メモリリーク
            4. 型システムの活用: Rust/Elmの強みを活かしているか。状態によって有効なフィールドが異なる場合に型安全ステートマシン（ADR-054）が適用されているか
            5. テスト: 新機能・バグ修正に対応するテストがあるか
            6. 設計: 責務の混在、依存関係の方向違反、過度な複雑さ

            注: ルール準拠チェック（.claude/rules/）は別ワークフローで実施。
            注: 完了基準との整合チェック（Validation）は別ジョブで実施。

            ### 学習機会の提供

            設計判断を伴う重要な箇所では、学習のため簡潔に解説する:
            - なぜその実装が良い/悪いのか
            - 代替案があればトレードオフとともに提示

            すべての箇所に解説は不要。学びになるポイントのみ。

            ### 指摘しないこと

            - コードスタイルの好み（フォーマッタが担う領域）
            - 既存コードとの些細な不整合（このPRの責務外）
            - 明確な理由のない「こうした方がより良い」

            ### 過去の議論を踏まえた判断

            PR コメントで既に議論された内容については、以下のように判断する:

            | コメントの内容 | 対応 |
            |---------------|------|
            | 正当な理由が説明されている（設計意図、別のルールでカバー済み等） | 尊重し、再指摘しない |
            | 単なる質問、未解決の議論 | 必要に応じて追加コメント |
            | 「後で直す」「TODO」などの保留 | 必要に応じてリマインド |

            過去の議論を踏まえた上で、なお指摘が必要と判断した場合は、その理由を明記する。

            ## フィードバック方法

            以下の順序で実行する:

            1. インラインコメント: コード固有の問題は `mcp__github_inline_comment__create_inline_comment` で該当箇所にコメント
            2. 全体フィードバック（必須）: `gh pr comment` で PR コメントを投稿。以下の構成で記載する:

            ### 全体フィードバックの構成

            ```
            ## Verification（コード品質）

            [Verification の指摘・サマリー]
            ```

            学習機会があれば Verification セクション内で解説を含める。

            3. 承認/却下: `gh pr review` で承認判断を実行

            ## 重大度判定ガイドライン

            Verification 指摘の重大度は**影響度（Impact）を優先**して判定する。発生確率が低くても、影響度が高ければ重大度を上げる。

            | 重大度 | 判定基準 | 例 |
            |--------|---------|-----|
            | Critical | セキュリティ境界の突破、認証/認可バイパス、機密データ漏洩 | SQL インジェクション、認証なしの API アクセス |
            | High | データ破損・不整合、サイレントな正確性バグ、ACID 違反 | トランザクション不在、LIKE ワイルドカード未エスケープ |
            | Medium | ユーザーに見えるバグ、エッジケースの非最適な挙動、設計上の問題 | エラーメッセージの不正確さ、N+1 クエリ |
            | Low | コード品質・可読性の改善、軽微な設計改善 | 命名の改善、不要な中間変数 |

            ## 承認判断

            | カテゴリ | 重大度 | アクション |
            |---------|--------|-----------|
            | Verification: Critical/High | マージ前に必ず修正が必要 | `gh pr review --request-changes` |
            | Verification: Medium/Low | 改善推奨だがマージ可能 | `gh pr review --approve` + コメント |
            | None | 問題なし | `gh pr review --approve` |

            学習のための解説コメントは承認判断に影響しない。
            問題がなければ、躊躇なく承認してください。

            ## メタデータ埋め込み（必須）

            PR コメント投稿時には、本文の末尾に以下の形式でメタデータを埋め込むこと:

            ```html
            <!-- review-metadata
            type: verification
            severity-critical: <数値>
            severity-high: <数値>
            severity-medium: <数値>
            severity-low: <数値>
            action-required: true | false
            -->
            ```

            ### メタデータの各フィールド

            | フィールド | 型 | 説明 | 例 |
            |-----------|-----|------|-----|
            | `type` | enum | レビュータイプ。`verification` 固定 | `type: verification` |
            | `severity-critical` | int | Critical 指摘の件数 | `severity-critical: 0` |
            | `severity-high` | int | High 指摘の件数 | `severity-high: 1` |
            | `severity-medium` | int | Medium 指摘の件数 | `severity-medium: 2` |
            | `severity-low` | int | Low 指摘の件数 | `severity-low: 3` |
            | `action-required` | boolean | Critical/High が 1 件以上なら true | `action-required: false` |

            ### 指摘件数のカウント方法

            1. インラインコメントで指摘した箇所をすべて数える
            2. PR コメント本文の Verification セクションに記載した全体的な指摘もカウントする
            3. 学習のための解説コメント（指摘を含まないもの）はカウントしない

            メタデータブロックは PR コメント本文の**末尾**に配置する。

            ## 承認メッセージの書き方

            `gh pr review --approve -b "メッセージ"` の承認メッセージは簡潔に要点のみ記載する。

            構成:
            - 1行目: 結論（LGTM / 軽微な指摘あり など）
            - 2行目以降（任意）: 軽微な指摘がある場合のみ、箇条書きで要約

            書かないこと:
            - インラインコメントで既に詳述した内容の繰り返し
            - PRの変更内容の説明（PR作成者は既に知っている）
            - 各ファイルごとの詳細なレビュー結果

            詳細なフィードバックはインラインコメントで行い、承認メッセージはサマリーに留める。

            ## コマンド実行時の注意

            長いコメントを投稿する際は HEREDOC 形式を使用すること:
            ```bash
            gh pr comment 93 --body "$(cat <<'EOF'
            複数行のコメント
            EOF
            )"
            ```
          claude_args: |
            --model claude-opus-4-6
            --max-turns 30
            --allowedTools "Bash(cat:*),Bash(gh pr view:*),Bash(gh pr list:*),Bash(gh pr diff:*),Bash(gh pr checks:*),Bash(gh pr comment:*),Bash(gh pr review:*),Bash(gh issue view:*),Bash(git log:*),Bash(git diff:*),Bash(git show:*),Bash(git status:*),mcp__github_inline_comment__create_inline_comment"

  # ──────────────────────────────────────────────
  # validation: 完了基準との整合チェック（Sonnet）
  # ──────────────────────────────────────────────
  validation:
    name: Validation
    runs-on: ubuntu-latest
    needs: setup
    if: needs.setup.outputs.is_draft == 'false'

    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
          ref: ${{ github.event.workflow_run.head_sha }}

      - name: Run Claude Validation
        id: validation
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          track_progress: false
          allowed_bots: "dependabot[bot]"
          prompt: |
            REPO: ${{ github.repository }}
            PR NUMBER: ${{ needs.setup.outputs.pr_number }}

            ## PR コメント（議論の文脈）

            以下は PR 上でのこれまでの議論です。チェック前に必ず目を通し、文脈を理解してください。

            ### PR コメント
            ```json
            ${{ needs.setup.outputs.PR_COMMENTS }}
            ```

            ### レビューコメント（インラインコメント）
            ```json
            ${{ needs.setup.outputs.REVIEW_COMMENTS }}
            ```

            ## レビューモード

            ${{ needs.setup.outputs.REVIEW_MODE }}

            ## Validation コンテキスト

            以下は PR に関連する Issue、PR 本文、計画ファイルの情報です。
            Validation チェックの入力として使用してください。

            ${{ needs.setup.outputs.VALIDATION_CONTEXT }}

            ## 言語

            コメントは日本語で記述する。
            CLAUDE.md の「応答は英語」はCLI対話に限定され、PRレビューには適用されない。

            ## 基本方針

            CLAUDE.md に記載されたプロジェクト理念と品質基準に基づいてチェックしてください。

            ## チェック観点

            ### Validation チェック（書かれていないことの検出）

            Validation コンテキストを参照し、以下を確認する。
            Issue や計画ファイルが存在しない場合（ドキュメント修正等）、PR 本文の検証のみ実施する。

            #### 欠落（Omission）の検出

            Issue の完了基準に対して:
            - 完了基準の各項目に対応する実装が diff に含まれているか
            - 実装計画の Phase に対応する変更がすべて含まれているか

            計画ファイルのテストリストに対して:
            - テストリストの各項目に対応するテストコードが存在するか
            - 操作パスの全分類（正常系・準正常系・異常系）がテストでカバーされているか

            #### 乖離（Divergence）の検出

            Issue・計画ファイルとの一致:
            - 実装が完了基準の意図する動作と異なっていないか
            - 計画で「対象外」とされた範囲に変更が含まれていないか

            PR 本文の品質確認セクションの検証:
            - 「設計・ドキュメント」で挙げられたファイルパスが実際に変更されているか
            - 「テスト」の記載内容と実際のテストファイルの対応
            - 「N/A（理由）」の理由の妥当性

            #### 注意事項

            - Validation は確信度が Verification より低い場合がある。確信度を明示すること
            - 完了基準の「解釈の幅」を考慮し、字句一致ではなく意図レベルで判断する
            - 実装者が意図的にスコープを調整している可能性を考慮する

            ### 過去の議論を踏まえた判断

            PR コメントで既に議論された内容については、以下のように判断する:

            | コメントの内容 | 対応 |
            |---------------|------|
            | 正当な理由が説明されている（設計意図、別のルールでカバー済み等） | 尊重し、再指摘しない |
            | 単なる質問、未解決の議論 | 必要に応じて追加コメント |
            | 「後で直す」「TODO」などの保留 | 必要に応じてリマインド |

            ## フィードバック方法

            重要: このジョブは `gh pr review` を**使用しない**。承認判断は Verification ジョブが行う。

            1. インラインコメント: 欠落・乖離が特定のコード箇所に関連する場合は `mcp__github_inline_comment__create_inline_comment` でコメント
            2. 全体フィードバック（必須）: `gh pr comment` で PR コメントを投稿。以下の構成で記載する:

            ### 全体フィードバックの構成

            ```
            ## Validation（完了基準との整合）

            ### 確認済み
            - [突合して問題なかった項目を簡潔に列挙]

            ### 欠落
            - [指摘内容]（確信度: 高/中/低）

            ### 乖離
            - [指摘内容]（確信度: 高/中/低）
            ```

            Validation の指摘がない場合は「確認済み」のみ記載する。
            Issue 参照がない場合は「Issue 参照なし — PR 本文の品質確認セクションのみ検証」と記載する。

            ## メタデータ埋め込み（必須）

            PR コメント投稿時には、本文の末尾に以下の形式でメタデータを埋め込むこと:

            ```html
            <!-- review-metadata
            type: validation
            validation-omission: <数値>
            validation-divergence: <数値>
            -->
            ```

            | フィールド | 型 | 説明 |
            |-----------|-----|------|
            | `type` | enum | `validation` 固定 |
            | `validation-omission` | int | 欠落の指摘件数 |
            | `validation-divergence` | int | 乖離の指摘件数 |

            メタデータブロックは PR コメント本文の**末尾**に配置する。

            ## コマンド実行時の注意

            長いコメントを投稿する際は HEREDOC 形式を使用すること:
            ```bash
            gh pr comment 93 --body "$(cat <<'EOF'
            複数行のコメント
            EOF
            )"
            ```
          claude_args: |
            --model claude-sonnet-4-6
            --max-turns 15
            --allowedTools "Read,Bash(cat:*),Bash(gh pr view:*),Bash(gh pr diff:*),Bash(gh pr comment:*),Bash(gh issue view:*),Bash(git diff:*),mcp__github_inline_comment__create_inline_comment"

  # ──────────────────────────────────────────────
  # finalize: 結果集約 + ステータス報告
  # ──────────────────────────────────────────────
  finalize:
    name: Finalize
    runs-on: ubuntu-latest
    needs: [setup, verification, validation]
    if: always() && needs.setup.outputs.is_draft == 'false'

    env:
      STATUS_URL: repos/${{ github.repository }}/statuses/${{ github.event.workflow_run.head_sha }}
      RUN_URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Check review decision
        id: review-decision
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          PR_NUMBER=${{ needs.setup.outputs.pr_number }}
          # claude[bot] の最新レビュー状態を取得（Verification ジョブが投稿）
          REVIEW_STATE=$(gh api "repos/${{ github.repository }}/pulls/${PR_NUMBER}/reviews" \
            --jq '[.[] | select(.user.login == "claude[bot]")] | last | .state // "NONE"')
          echo "review_state=$REVIEW_STATE" >> "$GITHUB_OUTPUT"
          echo "Claude review state: $REVIEW_STATE"

      - name: Determine final status
        id: final-status
        env:
          VERIFICATION_RESULT: ${{ needs.verification.result }}
          VALIDATION_RESULT: ${{ needs.validation.result }}
          REVIEW_STATE: ${{ steps.review-decision.outputs.review_state }}
        run: ./scripts/ci/determine-review-status.sh

      - name: Report status
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          gh api "$STATUS_URL" \
            -f state="${{ steps.final-status.outputs.state }}" \
            -f context="Claude Auto Review" \
            -f description="${{ steps.final-status.outputs.description }}" \
            -f target_url="$RUN_URL" || true
