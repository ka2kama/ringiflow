/**
 * Vite 設定ファイル
 *
 * Vite は次世代フロントエンドビルドツール。
 * Webpack と比較して以下の利点がある:
 *
 * - **高速な起動**: ES モジュールのネイティブサポートにより、
 *   バンドル不要で開発サーバーを起動
 * - **高速な HMR**: 変更ファイルのみを更新
 * - **シンプルな設定**: デフォルト設定が実用的
 *
 * ## なぜ Vite を選択したか
 *
 * | ツール   | 起動速度 | 設定の複雑さ | Elm サポート |
 * |----------|----------|--------------|--------------|
 * | Vite     | 速い     | 低い         | プラグイン   |
 * | Webpack  | 遅い     | 高い         | loader       |
 * | Parcel   | 速い     | 最低         | 限定的       |
 * | esbuild  | 最速     | 中程度       | なし         |
 *
 * Vite は速度と設定のバランスが良く、
 * vite-plugin-elm による Elm サポートも安定している。
 *
 * ## ファイル構成
 *
 * ```
 * apps/web/
 * ├── vite.config.js  (このファイル)
 * ├── index.html      (エントリーポイント)
 * ├── src/
 * │   ├── main.js     (JS エントリー)
 * │   └── Main.elm    (Elm エントリー)
 * └── dist/           (ビルド出力)
 * ```
 */

import { defineConfig } from "vite";
import elmPlugin from "vite-plugin-elm";

/**
 * Vite 設定オブジェクト
 *
 * defineConfig() は TypeScript の型補完を有効にするヘルパー関数。
 * 機能的には単なるオブジェクトを返すだけだが、
 * IDE のサポートが向上する。
 */
export default defineConfig({
  /**
   * プラグイン設定
   *
   * ## vite-plugin-elm について
   *
   * Elm ファイルを JavaScript モジュールとして import 可能にする。
   * 内部で elm コンパイラを呼び出し、生成された JS を返す。
   *
   * 動作モード:
   * - 開発時: デバッグ情報付きでコンパイル、HMR 対応
   * - 本番時: 最適化コンパイル（--optimize フラグ）
   *
   * オプション（デフォルト値で十分なため省略）:
   * - debug: デバッグモードを強制（開発時は自動で有効）
   * - optimize: 最適化を強制（本番時は自動で有効）
   */
  plugins: [elmPlugin()],

  /**
   * 開発サーバー設定
   */
  server: {
    /**
     * リッスンポート
     *
     * Vite のデフォルトは 5173。
     * 他のサービスとの衝突を避けるため明示的に指定。
     */
    port: 5173,

    /**
     * API プロキシ設定
     *
     * ## 設計意図
     *
     * 開発環境では、フロントエンド（5173）と
     * バックエンド（3000）が別ポートで動作する。
     * CORS の問題を回避するため、Vite のプロキシ機能を使用。
     *
     * ## リクエストフロー
     *
     * ```
     * ブラウザ → localhost:5173/api/users
     *         → Vite プロキシ
     *         → localhost:3000/api/users
     *         → Rust バックエンド
     * ```
     *
     * ## 本番環境との違い
     *
     * 本番環境では:
     * - 同一ドメインでフロント/バックエンドを提供、または
     * - CORS ヘッダーを適切に設定
     *
     * のいずれかで対応するため、プロキシは不要。
     */
    proxy: {
      "/api": {
        /**
         * プロキシ先 URL
         *
         * Rust バックエンド（axum）のアドレス。
         * docker-compose で起動時もこのポートを使用。
         */
        target: "http://localhost:3000",

        /**
         * Origin ヘッダーの書き換え
         *
         * true にすると、プロキシリクエストの Origin を
         * target のホストに書き換える。
         * バックエンドが Origin をチェックする場合に必要。
         */
        changeOrigin: true,
      },
    },
  },

  /**
   * ビルド設定
   */
  build: {
    /**
     * 出力ディレクトリ
     *
     * ビルド成果物の出力先。
     * dist/ は .gitignore に含めてバージョン管理対象外。
     *
     * 本番デプロイ時:
     * 1. `pnpm run build` で dist/ を生成
     * 2. dist/ の内容を CDN/S3 にアップロード
     */
    outDir: "dist",

    /**
     * ビルド前にディレクトリを空にする
     *
     * true（デフォルト）にすると、ビルド前に
     * outDir の内容を削除。古いファイルが残らない。
     *
     * 明示的に設定しているのは、この挙動を
     * ドキュメント化する目的。
     */
    emptyOutDir: true,
  },
});
