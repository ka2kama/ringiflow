# #765 完了基準・テスト計画を操作パス起点で設計する仕組みの導入

## Context

改善記録「子 Issue 分割実装時の操作パス検証欠落」の根本原因（L0）:

> 完了基準とテストが「実装の構造」（モジュール、関数、レイヤー）に沿って設計されており、「ユーザーの操作パス」に沿って設計されていない。

PR #764 で Epic 固有の対策（テスト責任マッピング、統合検証ゲート）は導入済み。本 Issue は全 Issue/PR に適用される一般的な仕組みの導入。

## 対象

| # | ファイル | 変更内容 |
|---|---------|---------|
| F1 | `docs/04_手順書/04_開発フロー/02_TDD開発フロー.md` | テストリスト作成前の「操作パス列挙」ステップ追加 |
| F2 | `docs/04_手順書/04_開発フロー/01_Issue駆動開発.md` | 完了基準の書き方に操作パス観点追加 + 品質チェックリスト更新 |
| F3 | `.claude/rules/zoom-rhythm.md` | ギャップ発見観点 + 計画ファイル必須要素の更新 |
| F4 | `process/improvements/2026-02/2026-02-21_1700_子Issue分割実装時の操作パス検証欠落.md` | 対策 L0 の次のアクション完了 |
| F5 | `docs/06_ナレッジベース/methodology/独自フレームワークと既知手法の対応.md` | BDD/ATDD/Cockburn との対応追記 |

対象外: Issue テンプレート変更（プロセスの構造的強制にならないため）、コード変更。

## 設計判断

| # | 判断 | 選択 | 理由 |
|---|------|------|------|
| 1 | 操作パス列挙の配置場所 | TDD フローのテストリストセクション内 | テストリスト作成の直前ステップとして自然。Issue 駆動開発側には完了基準の書き方として補強 |
| 2 | Cockburn Use Cases の採用レベル | MSS + Extensions の簡略版 | 正常系パス + 分岐点 + 準正常系・異常系パスのみ採用。完全な Use Case 記述はオーバーヘッド |
| 3 | テスト設計の方向性 | トップダウン設計 × ボトムアップ実装を明示 | ATDD の二重ストリームに対応。明示しないと設計時もボトムアップになる |
| 4 | 適用条件 | ユーザー操作を伴う Issue のみ必須 | フルスタック/API: 必須、ドメインロジック: 推奨、ドキュメント/インフラ: 不要 |

## Phase 1: TDD フローに「操作パス列挙」ステップを追加

対象: `docs/04_手順書/04_開発フロー/02_TDD開発フロー.md`

### 変更内容

テストリストセクション（L263-L359）を再構成:

1. L275 の直後（「作成のコツ」の前）に新セクションを挿入:
   - `### 操作パスの列挙（テストリスト作成の前に）` — 適用条件表、手順（4ステップ）、操作パス分類表、計画ファイル用フォーマット、操作パス→テスト層の変換表
   - `### テスト設計の方向性` — トップダウン設計とボトムアップ実装の二方向性

2. `### 作成のコツ`（L276-L281）を更新:
   - 「完了基準から逆算」→「操作パスから逆算」
   - 「正常系 → 異常系」→「正常系 → 準正常系 → 異常系」
   - 「優先順位付け」→「テスト層の配置」

3. `### 例: ログイン機能`（L300-L350）を更新:
   - テストリストの前に操作パスの列挙を追加
   - 各 Phase に操作パスとの紐づけコメントを追加

4. ワークフロー全体像（L531-L544）を更新:
   - 「Issue の完了基準を確認」の後に「操作パスを列挙」ノードを追加

#### 確認事項

- パターン: 既存のテストリストセクション構造 → `02_TDD開発フロー.md` L263-L359
- パターン: ワークフロー Mermaid 図 → `02_TDD開発フロー.md` L531-L544

#### テストリスト

ユニットテスト（該当なし — ドキュメント修正のみ）
ハンドラテスト（該当なし）
API テスト（該当なし）
E2E テスト（該当なし）

## Phase 2: Issue 駆動開発の完了基準と品質チェックリストの更新

対象: `docs/04_手順書/04_開発フロー/01_Issue駆動開発.md`

### 変更内容

1. 完了基準の書き方セクション（L58-L87）に操作パスの視点を追加:
   - L65 の直後に「完了基準と操作パス」サブセクションを挿入
   - コンポーネント実装レベル vs 操作パスレベルの対比表
   - 良い例を操作パスレベルに更新

2. 品質チェックリストのテストセクション（L445-L455）を更新:
   - L448「正常系・異常系・境界値が網羅されているか」→ 操作パス起点の検証に強化
   - L449 の直後に「テスト設計が操作パス起点か」を追加

3. L455 の操作パス分類注釈を TDD フローへのリンクに変更

#### 確認事項

- パターン: 既存の完了基準セクション → `01_Issue駆動開発.md` L58-L87
- パターン: 既存の品質チェックリスト → `01_Issue駆動開発.md` L445-L455

#### テストリスト

ユニットテスト（該当なし）
ハンドラテスト（該当なし）
API テスト（該当なし）
E2E テスト（該当なし）

## Phase 3: zoom-rhythm.md のギャップ発見観点と計画ファイル必須要素の更新

対象: `.claude/rules/zoom-rhythm.md`

### 変更内容

1. ギャップ発見の観点（L37 の直後）に追加:
   - `| 操作パス網羅漏れ | 完了基準に対応する操作パス（正常系・準正常系・異常系）がテストリストに反映されていないもの |`

2. 計画ファイルの必須要素（L205「テストリスト」の前）に追加:
   - `### 操作パス（テストリスト作成の前提）` — フォーマット、該当なしの明示方法

#### 確認事項

- パターン: 既存のギャップ発見観点 → `zoom-rhythm.md` L24-L38
- パターン: 既存の計画ファイル必須要素 → `zoom-rhythm.md` L185-L220

#### テストリスト

ユニットテスト（該当なし）
ハンドラテスト（該当なし）
API テスト（該当なし）
E2E テスト（該当なし）

## Phase 4: 改善記録の更新 + ナレッジベース追記

### 変更内容

1. 改善記録（L117-L118）の対策 L0 の次のアクションを完了状態に更新

2. ナレッジベース `独自フレームワークと既知手法の対応.md`:
   - 「Issue 駆動 + Phase 分割 + TDD と既知手法」セクション内に追記
   - BDD（Dan North, 2006）: Given-When-Then を思考モデルとして活用
   - ATDD（Uncle Bob）: 二重ストリーム → トップダウン設計 × ボトムアップ実装
   - Cockburn Use Cases（2001）: MSS + Extensions → 操作パス列挙形式
   - 全体像 Mermaid 図に BDD/ATDD/Cockburn を追加
   - 変更履歴に追記

#### 確認事項

- パターン: 既存の既知手法対応のセクション構造 → `独自フレームワークと既知手法の対応.md`

#### テストリスト

ユニットテスト（該当なし）
ハンドラテスト（該当なし）
API テスト（該当なし）
E2E テスト（該当なし）

## ブラッシュアップループの記録

| ループ | 検出したギャップ | 観点 | 対応 |
|-------|----------------|------|------|
| 1回目 | 適用条件が未定義（全 Issue に一律適用するとオーバーヘッド） | 曖昧 | 適用条件を表で明示（フルスタック: 必須、API: 必須、ドメイン: 推奨、ドキュメント: 不要） |
| 2回目 | 既存の「正常系・異常系・境界値が網羅されているか」と操作パス観点が重複 | 競合 | 既存項目を操作パス起点に置き換え（抽象的 → 具体的への強化） |
| 3回目 | zoom-rhythm の計画ファイル必須要素に操作パスを追加する配置順序が未定義 | 不完全なパス | テストリストの前に配置（テストリストの前提として） |
| 4回目 | 操作パス分類の注釈が Issue 駆動開発と TDD フローで重複する | 競合 | Issue 駆動開発側はリンクに変更、詳細定義は TDD フロー側に集約 |

## 収束確認（設計・計画）

| # | 観点 | 理想状態（To-Be） | 判定 | 確認内容 |
|---|------|------------------|------|---------|
| 1 | 網羅性 | 完了基準3項目すべてに対応する変更がある | OK | 完了基準1→Phase1+2、完了基準2→Phase1、完了基準3→Phase2。全項目カバー |
| 2 | 曖昧さ排除 | 不確定な記述がゼロ | OK | 適用条件、フォーマット、変換ルール、配置場所すべて具体的 |
| 3 | 設計判断の完結性 | 全差異に判断が記載 | OK | 4つの設計判断に選択肢と理由を記載 |
| 4 | スコープ境界 | 対象と対象外が明記 | OK | 対象5ファイル、対象外2項目を明記 |
| 5 | 技術的前提 | 前提が考慮されている | OK | ドキュメント修正のみ。Epic 固有テスト責任マッピングとの整合確認済み |
| 6 | 既存ドキュメント整合 | 矛盾がない | OK | 操作パス用語定義は既存注釈を踏襲。テスト責任マッピング（PR #764）と補完関係 |

## 検証

`just check-all` を実行し、既存テストが通過することを確認する（ドキュメント修正のみのためリンク検証が主要な検証項目）。
