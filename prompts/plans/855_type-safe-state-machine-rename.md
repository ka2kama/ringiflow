# #855 ADT ベースステートマシンの命名・判断基準を手段非依存に修正する

## Context

CLAUDE.md の「Want と How」原則: 手段を Want に昇格させない。現状、パターン名「ADT ベースステートマシン」が特定の実装手段（ADT: 代数的データ型）を前提としており、ジェネリクスや trait bounds 等の代替手段を「例外」扱いにするリスクがある。

命名を「型安全ステートマシン」に変更し、判断基準を「ADT で表現できるか」から「不正な状態遷移が型レベルで防止されているか」に修正する。

ドキュメント・コード修正に加え、関連する GitHub Issues の用語・方針も更新する。既存実装の再評価や未着手 Story のアプローチ見直しはフォローアップ Issue として切り出す。

## 新命名

| 変更前 | 変更後 |
|-------|--------|
| ADT ベースステートマシン | 型安全ステートマシン |
| ADT ステートマシン | 型安全ステートマシン |

英語: ADT-based state machine → Type-safe state machine

## スコープ

対象:
- Living documents（ADR、ルールファイル、手順書、設計書）
- ソースコードコメント
- 実装解説ドキュメント
- GitHub Actions ワークフロー
- GitHub Issues（Epic #822、#854 等の用語・判断基準）

対象外:
- セッションログ（`prompts/runs/`）、計画ファイル（`prompts/plans/`）、DB マイグレーション（`backend/migrations/`）— 時点の記録であり変更しない
- 既存実装の設計判断の再評価 — フォローアップ Issue で対応
- 未着手 Story のアプローチ変更 — フォローアップ Issue で対応

## Phase 1: ADR-054 の修正（核心）

ADR-054 がパターンの定義文書。ここが全変更の起点。

ファイルリネーム:
- `docs/70_ADR/054_ADTベースステートマシンパターンの標準化.md` → `docs/70_ADR/054_型安全ステートマシンパターンの標準化.md`

内容の修正:
- タイトル: `ADR-054: ADT ベースステートマシンパターンの標準化` → `ADR-054: 型安全ステートマシンパターンの標準化`
- 本文中の「ADT ベースステートマシン」→「型安全ステートマシン」（ただし選択肢の説明や比較表内の技術的記述で ADT に言及する箇所は、手段としての説明を維持）
- 「検討した選択肢」セクション: 選択肢 2 のタイトルを「型安全ステートマシン（ADT ベース）」等に調整。ADT が主な実装手段であることは維持しつつ、型安全性が目的であることを明示
- 「決定」セクション: 判断基準の主眼を「ADT で表現できるか」→「不正な状態遷移が型レベルで防止されているか」に変更。ADT は推奨される主な実装手段として位置づけ
- 「設計ガイドライン」: 現在の ADT パターン（Pattern A/B）はそのまま維持。将来の代替手段（ジェネリクス、trait bounds）にも開かれた記述に調整
- 「既知手法との関連」: 「ADT ベースステートマシン」→「型安全ステートマシン」に更新
- 変更履歴に本変更を追記

確認事項:
- 型: ADR-054 の選択肢構造、比較表のカラム名 → ADR-054 本文
- パターン: ADR 変更履歴の書き方 → 既存の ADR 変更履歴

#### 操作パス

操作パス: 該当なし（操作パスが存在しない）

#### テストリスト

テストリスト: 該当なし（ドキュメント修正のみ）

## Phase 2: ルールファイル・手順書の更新

ADR-054 を参照している Living documents の用語とリンクを更新。

対象ファイル:

1. `.claude/rules/zoom-rhythm.md`
   - 「状態依存フィールド」観点の記述: 「ADT ベースステートマシン」→「型安全ステートマシン」
   - ADR-054 リンクのファイル名を更新

2. `.claude/rules/pre-implementation.md`
   - セクション名: 「型定義時の ADT ステートマシン判定」→「型定義時の型安全ステートマシン判定」
   - 本文: 「ADT ベースステートマシン」→「型安全ステートマシン」
   - ADR-054 リンクのファイル名を更新

3. `docs/60_手順書/04_開発フロー/02_TDD開発フロー.md`
   - 設計原則レンズ「型の活用」: ADR-054 リンクのファイル名を更新

確認事項:
- パターン: 各ファイルの ADR-054 参照箇所 → Grep 結果で確認済み

#### 操作パス

操作パス: 該当なし（操作パスが存在しない）

#### テストリスト

テストリスト: 該当なし（ドキュメント修正のみ）

## Phase 3: 設計書・ソースコードコメントの更新

### 3a. 設計書

`docs/40_詳細設計書/エンティティ影響マップ/WorkflowInstance.md`:
- 「ADT ベースステートマシン」→「型安全ステートマシン」
- ADR-054 リンクのファイル名を更新

### 3b. ソースコードコメント

用語とリンクを更新。6 ファイル:

1. `backend/crates/domain/src/workflow/instance.rs` — モジュール doc + struct/enum doc
2. `backend/crates/domain/src/workflow/step.rs` — モジュール doc + struct/enum doc
3. `frontend/src/Page/WorkflowDefinition/Designer.elm` — モジュール doc
4. `frontend/src/Page/Workflow/Detail.elm` — モジュール doc + 型コメント
5. `frontend/src/Page/Workflow/New.elm` — モジュール doc
6. `frontend/src/Page/Task/Detail.elm` — モジュール doc + 型コメント

確認事項:
- パターン: 各ファイルのコメント記法（Rust doc comment `///` `//!`, Elm `{-| -}` `{- -}`）→ 既存パターンに従う

#### 操作パス

操作パス: 該当なし（操作パスが存在しない）

#### テストリスト

テストリスト: 該当なし（ドキュメント修正のみ）

## Phase 4: 実装解説ドキュメントの更新

ディレクトリリネーム + 内容更新。3 PR 分:

1. `docs/90_実装解説/PR802_Designer-ADTステートマシン/` → `docs/90_実装解説/PR802_Designer-型安全ステートマシン/`
   - `01_Designer-ADTステートマシン_機能解説.md` → `01_Designer-型安全ステートマシン_機能解説.md`
   - `01_Designer-ADTステートマシン_コード解説.md` → `01_Designer-型安全ステートマシン_コード解説.md`
   - 内容中の用語 + ADR-054 リンクを更新

2. `docs/90_実装解説/PR839_WorkflowDetail_ADTステートマシン/` → `docs/90_実装解説/PR839_WorkflowDetail_型安全ステートマシン/`
   - `01_ADTステートマシン_機能解説.md` → `01_型安全ステートマシン_機能解説.md`
   - `01_ADTステートマシン_コード解説.md` → `01_型安全ステートマシン_コード解説.md`
   - 内容中の用語 + ADR-054 リンクを更新

3. `docs/90_実装解説/PR840_WorkflowStep-ADTステートマシン/` → `docs/90_実装解説/PR840_WorkflowStep-型安全ステートマシン/`
   - `01_WorkflowStep-ADTステートマシン_機能解説.md` → `01_WorkflowStep-型安全ステートマシン_機能解説.md`
   - `01_WorkflowStep-ADTステートマシン_コード解説.md` → `01_WorkflowStep-型安全ステートマシン_コード解説.md`
   - 内容中の用語 + ADR-054 リンクを更新

確認事項:
- パターン: 実装解説の命名規則 → `docs/90_実装解説/README.md`

#### 操作パス

操作パス: 該当なし（操作パスが存在しない）

#### テストリスト

テストリスト: 該当なし（ドキュメント修正のみ）

## Phase 5: GitHub Actions ワークフローの更新

`.github/workflows/claude-auto-review.yaml`:
- 「ADT ベースステートマシン（ADR-054）」→「型安全ステートマシン（ADR-054）」

確認事項: なし（既知のパターンのみ）

#### 操作パス

操作パス: 該当なし（操作パスが存在しない）

#### テストリスト

テストリスト: 該当なし（ドキュメント修正のみ）

## Phase 6: GitHub Issues の用語・方針更新

関連する GitHub Issues の用語と判断基準を更新する。

### 6a. Epic #822 の更新

- タイトル: 「ADT ベースステートマシンの既存コード適用」→「型安全ステートマシンの既存コード適用」
- 本文:
  - 概要: 「ADR-054（ADT ベースステートマシンパターンの標準化）」→「ADR-054（型安全ステートマシンパターンの標準化）」
  - 完了基準: 「ADT で分離」→「型レベルで分離」等の手段非依存な記述に
  - タスクリスト: 各 Story の記述を「ADT ベースステートマシン」→「型安全ステートマシン」に
  - 中優先度 Story: 「ADT に分離」→「型安全ステートマシンで分離」に
  - 参照セクション: ADR-054 のファイル名リンクを更新

### 6b. Issue #854 の更新

- 本文の「ADT パターンが防ごうとしている」→「型安全ステートマシンパターンが防ごうとしている」等に更新

### 6c. Issue #855 自身の更新

Issue #855 のタイトルは手段非依存な修正の文脈を説明しているため、変更不要。

確認事項: なし（Issue テキストの修正のみ）

#### 操作パス

操作パス: 該当なし（操作パスが存在しない）

#### テストリスト

テストリスト: 該当なし（Issue 更新のみ）

## Phase 7: フォローアップ Issue の作成

#855 のスコープ外だが今後必要な作業を Issue として切り出す。

### 7a. 既存実装の再評価

Issue 内容:
- 既存の型安全ステートマシン実装（Designer.elm, WorkflowInstance 等）を新しい判断基準（「不正な状態遷移が型レベルで防止されているか」）で再評価する
- 例: `CancelledState` の `Option` フィールドが「ADT の限界による妥協」ではなく、型安全性の観点で適切かどうかを判断する

### 7b. 未着手 Story のアプローチ見直し

Issue 内容:
- Epic #822 の中優先度（確認ダイアログ共通パターン: WorkflowDefinition/List.elm, Role/List.elm, User/Detail.elm）のアプローチを、ADT 前提ではなく「最適な型安全手段」で検討する
- 確認ダイアログの状態管理に ADT が最適か、より簡潔な手段がないかを評価する

確認事項: なし

#### 操作パス

操作パス: 該当なし（操作パスが存在しない）

#### テストリスト

テストリスト: 該当なし（Issue 作成のみ）

## 置換ルール

本文中の用語置換は以下のルールに従う:

| 対象 | 置換 | 例 |
|------|------|-----|
| パターン名（定義的使用） | 「ADT ベースステートマシン」→「型安全ステートマシン」 | ADR タイトル、セクション名 |
| パターン名（参照的使用） | 「ADT ベースステートマシン」→「型安全ステートマシン」 | コメント、説明文 |
| 技術的説明文脈 | 維持 | 「ADT（代数的データ型）で状態を分離する」等の具体手段を説明する箇所 |
| ファイル名・ディレクトリ名 | 「ADT ステートマシン」→「型安全ステートマシン」 | リネーム対象 |
| ADR-054 へのリンク | ファイル名部分を新名に更新 | `054_ADTベース...` → `054_型安全...` |
| Issue タイトル・本文 | パターン名を更新、判断基準を手段非依存に | Epic #822, #854 |

## Verification

1. `just check-all` で全テスト通過を確認
2. Grep で旧用語（`ADT ベースステートマシン|ADTベースステートマシン|ADTステートマシン`）が Living documents に残っていないことを確認（`prompts/runs/`, `prompts/plans/`, `backend/migrations/` は除外）
3. ADR-054 へのリンクが全て新ファイル名を指していることを確認
4. 実装解説のディレクトリリネームが正しく反映されていることを確認
5. GitHub Issues の用語が更新されていることを確認（`gh issue view` で確認）
6. フォローアップ Issue が作成されていることを確認

### ブラッシュアップループの記録

| ループ | 検出したギャップ | 観点 | 対応 |
|-------|----------------|------|------|
| 1回目 | 実装解説ドキュメントのディレクトリ名にも旧用語が含まれる | 網羅性 | Phase 4 としてディレクトリリネーム + ファイルリネーム + 内容更新を追加 |
| 2回目 | GitHub Actions ワークフローにも参照がある | 網羅性 | Phase 5 として追加 |
| 3回目 | 技術的説明文脈（ADT の具体手段説明）まで置換すると意味が変わる | 曖昧さ排除 | 置換ルールに「技術的説明文脈は維持」を明示 |
| 4回目 | GitHub Issues（Epic #822、#854）の用語・方針も更新が必要 | 網羅性 | Phase 6 として Issue 更新を追加 |
| 5回目 | 既存実装の再評価と未着手 Story のアプローチ見直しは本 Issue のスコープ外 | スコープ境界 | Phase 7 としてフォローアップ Issue 作成を追加。スコープの「対象外」にも明記 |

## 収束確認（設計・計画）

| # | 観点 | 判定 | 確認内容 |
|---|------|------|---------|
| 1 | 網羅性 | OK | Grep で 32 ファイルを検出、Living/Historical に分類し全対象を計画に含めた。GitHub Issues（#822, #854）も対象に含めた。除外（セッションログ・計画ファイル・マイグレーション・既存実装再評価）は理由付き |
| 2 | 曖昧さ排除 | OK | 置換ルールを明示し、「技術的説明文脈」の維持条件を定義。フォローアップ Issue の内容も具体的に記述 |
| 3 | 設計判断の完結性 | OK | 命名選択（型安全ステートマシン）、スコープ境界（Living vs Historical、Issue 内 vs フォローアップ）、置換ルールの判断が記載済み |
| 4 | スコープ境界 | OK | 対象・対象外を「スコープ」セクションで明示。フォローアップ Issue で対象外作業をカバー |
| 5 | 技術的前提 | OK | `git mv` でファイル・ディレクトリのリネームを行い git の追跡を維持。`gh issue edit` で Issue を更新 |
| 6 | 既存ドキュメント整合 | OK | CLAUDE.md の「Want と How」原則、ADR-054 の構造、Issue #855 の対応内容と整合 |
