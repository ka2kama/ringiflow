# Issue #939: テスト戦略の拡充 — エッジケース・境界値・不変条件テスト方針

## Context

現在のテストは「ドメインロジックの状態遷移」「認証・CSRF」「楽観的ロック」は堅いが、「予想外の入力値（空文字、特殊文字、長文）」と「予想外の操作列」に対するカバーが薄い。API テスト 100% カバーは全エンドポイントの正常系を意味し、各エンドポイントの境界値・異常系の網羅性は保証していない。

本 Issue はドキュメント・方針策定が中心。実際のテストコード追加は後続 Issue で行う。

## スコープ

**対象:** テスト方針のドキュメント作成・既存ルールファイルへの追記・ADR 作成
**対象外:** テストコードの追加、proptest の依存追加、既存テストのリファクタリング

## 設計判断

### 1. 全体方針の配置先

既存ルールファイル（api-test.md, e2e-test.md）への追記 + `docs/08_テスト/` に新規ドキュメント。

理由: 層ごとの責務分担表は参照用ドキュメントとして集約、各層固有の方針は AI ディレクティブとしてルールファイルに配置。

### 2. 状態遷移表の粒度

ドメインモデルの遷移メソッドレベル（`submitted()`, `cancelled()` 等）。

理由: 型安全ステートマシンの防御範囲と、テストで検証すべき範囲を明確に区別するため。

### 3. proptest の導入判断

ADR で正式に評価・判断する。推奨は「導入」。

理由: 成熟度（v1.x）、既存 `assert_workflow_invariants()` との自然な統合、学習効果。

## Phase 分割

### Phase 1: テスト層間の責務分担と原則の定義

**成果物:** `docs/08_テスト/テスト戦略_エッジケース方針.md`（新規）

内容:
- テスト層ごとのエッジケース責務分担表
- 「同じことを複数層でテストしない」原則の明文化
- 「操作列ではなく不変条件をテストする」原則の明文化
- API テストに追加すべきエッジケースカテゴリ（入力値境界、ページネーション、権限境界、状態遷移異常系）
- E2E テストでカバーすべき UI 固有エッジケース（二重送信防止、セッション切れ、エラー表示）
- 各ルールファイル・ADR へのリンク

**確認事項:**
- パターン: `.claude/rules/dev-flow-tdd.md`（テスト層とテストリスト）
- パターン: `.claude/rules/e2e-test.md` の既存非重複記述
- パターン: ADR-032、ADR-036

**対応する完了基準:** 1, 2, 3, 5, 7

**操作パス:** 該当なし（ドキュメント・方針策定）

**テストリスト:**
- ユニットテスト: 該当なし
- ハンドラテスト: 該当なし
- API テスト: 該当なし
- E2E テスト: 該当なし
- 検証: `just check-all` 通過

---

### Phase 2: 既存ルールファイルへのエッジケース方針追記

**成果物:**
- `.claude/rules/api-test.md` への追記（エッジケースカテゴリセクション）
- `.claude/rules/e2e-test.md` への追記（UI 固有エッジケースセクション）

**確認事項:**
- パターン: `api-test.md` の既存構造（アサーション方針 → 必須チェック項目 → AI 指示）
- パターン: `e2e-test.md` の既存構造（スコープ方針 → テストの書き方 → 必須チェック項目 → AI 指示）

**対応する完了基準:** 4

**操作パス:** 該当なし（ドキュメント・方針策定）

**テストリスト:** Phase 1 と同じ

---

### Phase 3: 状態遷移表の作成

**成果物:**
- `docs/08_テスト/状態遷移表_WorkflowInstance.md`（新規）— 7 状態 × 8 操作
- `docs/08_テスト/状態遷移表_WorkflowStep.md`（新規）— 4 状態 × 6 操作

各セルに「成功 → 遷移先」または「Error」を記載。型安全ステートマシンのカバー範囲と既存テストカバレッジを注記。

**確認事項:**
- 型: `WorkflowInstanceState` → `backend/crates/domain/src/workflow/instance.rs`
- 型: `WorkflowStepState` → `backend/crates/domain/src/workflow/step.rs`
- パターン: エンティティ影響マップ → `docs/03_詳細設計書/エンティティ影響マップ/WorkflowInstance.md`

**対応する完了基準:** 6

**操作パス:** 該当なし（ドキュメント・方針策定）

**テストリスト:** Phase 1 と同じ

---

### Phase 4: proptest 導入判断の ADR

**成果物:** `docs/05_ADR/058_プロパティベーステスト導入.md`（新規）

選択肢:
1. proptest 導入（推奨）
2. rstest パラメータ化テストで代替
3. 見送り

**確認事項:**
- パターン: ADR テンプレート → `docs/05_ADR/template.md`
- パターン: 既存の技術選定 ADR → ADR-035、ADR-038
- ライブラリ: proptest → docs.rs で最新版 API 確認
- 型: `assert_workflow_invariants()` → `backend/crates/infra/tests/common/mod.rs`

**対応する完了基準:** 8

**操作パス:** 該当なし（ドキュメント・方針策定）

**テストリスト:** Phase 1 と同じ

## 重要ファイル

| ファイル | 用途 |
|---------|------|
| `.claude/rules/api-test.md` | Phase 2 で追記 |
| `.claude/rules/e2e-test.md` | Phase 2 で追記 |
| `backend/crates/domain/src/workflow/instance.rs` | Phase 3 の情報源（状態遷移） |
| `backend/crates/domain/src/workflow/step.rs` | Phase 3 の情報源（状態遷移） |
| `backend/crates/infra/tests/common/mod.rs` | 既存 `assert_workflow_invariants()` |
| `docs/03_詳細設計書/エンティティ影響マップ/WorkflowInstance.md` | 不変条件定義（INV-I, INV-X） |
| `docs/03_詳細設計書/エンティティ影響マップ/WorkflowStep.md` | 不変条件定義（INV-S） |
| `docs/05_ADR/032_テスト設計方針.md` | 既存テスト設計方針 |

## ブラッシュアップループの記録

| ループ | 検出したギャップ | 観点 | 対応 |
|-------|----------------|------|------|
| 1回目 | 実装ガイドラインに「proptest」が既に記載済みだが未導入。ADR で正式判断が必要 | 既存手段の見落とし | Phase 4 で ADR を作成し整合させる |
| 2回目 | 状態遷移表の対象が WorkflowInstance のみで WorkflowStep が欠落 | 不完全なパス | Phase 3 に WorkflowStep を追加 |
| 3回目 | 非重複原則が既に `e2e-test.md` に断片的に存在 | 未定義（散在） | Phase 1 で集約・強化 |
| 4回目 | Phase 2 の追記で既存の文体（簡潔なルール文体）との整合が必要 | 曖昧 | Phase 2 の確認事項に構造パターン確認を追加 |

## 収束確認（設計・計画）

| # | 観点 | 理想状態（To-Be） | 判定 | 確認内容 |
|---|------|------------------|------|---------|
| 1 | 網羅性 | 完了基準 8 項目すべてが Phase に割当 | OK | 1,2,3,5,7→Ph1、4→Ph2、6→Ph3、8→Ph4 |
| 2 | 曖昧さ排除 | 不確定な記述がゼロ | OK | 各 Phase の成果物が具体的ファイルパスと内容で確定 |
| 3 | 設計判断の完結性 | 全差異に判断が記載 | OK | 配置先、状態遷移表粒度、proptest 導入の 3 判断を記載 |
| 4 | スコープ境界 | 対象と対象外が両方明記 | OK | 対象: ドキュメント。対象外: テストコード追加 |
| 5 | 技術的前提 | 前提が考慮されている | OK | proptest 成熟度、型安全ステートマシンによる既存防御を確認 |
| 6 | 既存ドキュメント整合 | 矛盾がない | OK | ADR-032, 036, 054 と整合 |

## 検証方法

各 Phase 完了後に `just check-all` で既存テストが壊れていないことを確認。
ドキュメントの品質は品質チェックリスト（ドキュメント版）で確認:
- 参照の網羅性: 関連ファイルの参照をすべて更新
- 用語の統一: 新旧用語が混在していないこと
- 意図の明確さ: 変更の目的が読み手に伝わること
