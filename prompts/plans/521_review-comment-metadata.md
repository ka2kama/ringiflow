# 計画: Issue #521 Claude Code Action レビューコメントフォーマットの構造化

## Context

### 背景

Issue #497 で `/review-and-merge` スキルの Step 5 に「未対応レビュー指摘のゼロ検証」を追加した。しかし、PR コメントの指摘有無は AI がコメント内容を自然言語で読んで判定する設計となっており、判定が曖昧になるリスクがある。

Step 5 の検証 #3 の現在の判定手順（`.claude/skills/review-and-merge/SKILL.md` L254-258）：
1. claude[bot] の PR コメントを取得
2. **各コメントの内容を読み、具体的な指摘事項を含むか判定**（AI の解釈に依存）
3. 指摘を含むコメントについて、返信があるか確認

この「内容を読んで判定」は以下の問題がある：
- サマリーと指摘の境界が曖昧なケースで判定がぶれる
- セッションをまたぐと解釈が変わる可能性がある
- 検証の確実性が低い

### 解決策

レビューコメント自体に機械判定可能なメタデータを埋め込む。メタデータで対応要否を機械的に判定できれば、検証の確実性が向上する。

---

## 現状（As-Is）

### 既存のレビューコメントフォーマット

claude[bot] は 2 つのワークフローでレビューコメントを投稿する：

| ワークフロー | 役割 | コメント形式 |
|-------------|------|-------------|
| `claude-auto-review.yaml` | 品質・設計・セキュリティの総合評価 | 自由形式テキスト、重大度 `[Critical]` `[High]` `[Medium]` `[Low]` を明示 |
| `claude-rules-check.yaml` | `.claude/rules/` の準拠チェック | 自由形式テキスト、末尾に `<!-- rules-check-result:pass/fail -->` |

### 現在の構造化要素

- **重大度明示**: 本文中に `[Critical]` `[High]` `[Medium]` `[Low]` を記載
- **機械判定マーカー**: Rules Check のみ `<!-- rules-check-result:pass/fail -->` を使用
- **Auto Review にはメタデータなし**: 指摘件数や対応要否が構造化されていない

### 既存の構造化パターン（プロジェクト内）

- **HTML コメント**: PR テンプレート、Rules Check で使用実績あり
- **YAML フロントマター**: ドキュメント規約で使用
- **Markdown テーブル**: 改善記録、計画ファイルで使用

---

## メタデータフォーマット設計

### 採用方式: HTML コメント（Key-Value 形式）

**理由:**
1. Rules Check で既に `<!-- rules-check-result:pass/fail -->` を使用している（整合性）
2. Markdown レンダリング時に非表示になり、人間の可読性を損なわない
3. 単純な正規表現・grep で抽出可能
4. 将来的な項目追加が容易（Key-Value 形式）

### メタデータスキーマ

```html
<!-- review-metadata
type: auto-review | rules-check
severity-critical: <数値>
severity-high: <数値>
severity-medium: <数値>
severity-low: <数値>
action-required: true | false
-->
```

| フィールド | 型 | 説明 |
|-----------|-----|------|
| `type` | enum | `auto-review` または `rules-check` |
| `severity-critical` | int | Critical 指摘の件数 |
| `severity-high` | int | High 指摘の件数 |
| `severity-medium` | int | Medium 指摘の件数 |
| `severity-low` | int | Low 指摘の件数 |
| `action-required` | boolean | 対応必須か（`true` = CHANGES_REQUESTED, `false` = APPROVED） |

### 配置場所

コメント本文の**末尾**に配置する（既存の `<!-- rules-check-result:pass/fail -->` と同じ位置）。

---

## Phase 構成

### Phase 1: Auto Review のメタデータ埋め込み

**概要**: `claude-auto-review.yaml` のプロンプトにメタデータ埋め込み指示を追加

**確認事項:**
- [x] 既存のプロンプト構造 → `claude-auto-review.yaml` L167-297 （プロンプト全体を確認、承認判断は L248-257）
- [x] 承認判断セクションの位置 → L248-257 （承認判断テーブルと承認メッセージの書き方を確認）

**実装内容:**
1. 承認判断セクションの後に「メタデータ埋め込み（必須）」セクションを追加
2. メタデータのフォーマット、配置場所、フォーマット例を明記
3. 指摘件数のカウント方法を説明

**テストリスト:**

ユニットテスト（該当なし）

ハンドラテスト（該当なし）

API テスト（該当なし）

E2E テスト（該当なし）

手動テスト:
- [ ] 実際の PR で Auto Review が実行され、メタデータが正しく埋め込まれるか確認
- [ ] APPROVED（指摘なし）、APPROVED（軽微な指摘あり）、CHANGES_REQUESTED の3パターンを確認

### Phase 2: Rules Check のメタデータ埋め込み

**概要**: `claude-rules-check.yaml` のプロンプトにメタデータ埋め込み指示を追加

**確認事項:**
- [x] 既存のプロンプト構造 → `claude-rules-check.yaml` L163-242 （プロンプト全体を確認）
- [x] フィードバック方法セクションの位置 → L220-230 （L225-226 に既存の結果マーカー `<!-- rules-check-result:pass/fail -->` を確認）

**実装内容:**
1. フィードバック方法セクションに、既存の `<!-- rules-check-result:pass/fail -->` に加えてメタデータ埋め込みを指示
2. Rules Check は Critical のみを使用（ルール違反は修正必須のため）
3. メタデータのフォーマット例を明記

**テストリスト:**

ユニットテスト（該当なし）

ハンドラテスト（該当なし）

API テスト（該当なし）

E2E テスト（該当なし）

手動テスト:
- [ ] 実際の PR で Rules Check が実行され、メタデータが正しく埋め込まれるか確認
- [ ] pass と fail の両パターンを確認

### Phase 3: `/review-and-merge` スキルの Step 3 修正

**概要**: レビューコメント取得時にメタデータを抽出し、サマリーに含める

**確認事項:**
- [x] Step 3 の現在の実装 → `.claude/skills/review-and-merge/SKILL.md` L61-110 （3つの API でレビュー情報取得、L83-101 にサマリー提示形式）
- [x] jq の使用パターン → L69-78 （`gh api` + `--jq` で claude[bot] のコメントをフィルタ）

**実装内容:**
1. PR コメント取得後、各コメントからメタデータを抽出する手順を追加
2. メタデータがある場合はそれを使用し、ない場合は従来通り本文を解釈する（後方互換性）
3. サマリー提示のフォーマットを更新（重大度別件数、対応要否を表示）

**抽出方法:**
```bash
# grep でメタデータブロックを抽出
echo "$COMMENT_BODY" | grep -Pzo '(?<=<!-- review-metadata\n)[\s\S]*?(?=\n-->)' || echo ""
```

**テストリスト:**

ユニットテスト（該当なし）

ハンドラテスト（該当なし）

API テスト（該当なし）

E2E テスト（該当なし）

手動テスト:
- [ ] メタデータありのコメントで正しく抽出・表示されるか確認
- [ ] メタデータなしのコメント（古い PR）でフォールバックが動作するか確認

### Phase 4: `/review-and-merge` スキルの Step 5 修正

**概要**: 検証 #3 をメタデータによる判定に変更

**確認事項:**
- [x] Step 5 検証 #3 の現在の実装 → `.claude/skills/review-and-merge/SKILL.md` L254-259, L280-284 （判定手順を確認）
- [x] 判定ロジックの変更箇所 → L282 （「各コメントの内容を読み、具体的な指摘事項を含むか判定する」が AI 解釈に依存）

**実装内容:**
1. 検証 #3 の判定手順を更新:
   - ~~「各コメントの内容を読み、具体的な指摘事項を含むか判定」~~ （AI の解釈）
   - 「メタデータを抽出し、指摘件数（severity-*）の合計がゼロでないか判定」（機械的判定）
2. フォールバック: メタデータがない場合は従来通り本文を解釈
3. 判定ロジックの疑似コードを追加

**テストリスト:**

ユニットテスト（該当なし）

ハンドラテスト（該当なし）

API テスト（該当なし）

E2E テスト（該当なし）

手動テスト:
- [ ] メタデータによる判定が正しく動作するか確認（指摘あり/なし）
- [ ] 未返信の指摘がある場合、マージがブロックされるか確認
- [ ] フォールバックが動作するか確認

---

## 対象ファイル

**修正:**
- `.github/workflows/claude-auto-review.yaml` — Auto Review のメタデータ埋め込み指示
- `.github/workflows/claude-rules-check.yaml` — Rules Check のメタデータ埋め込み指示
- `.claude/skills/review-and-merge/SKILL.md` — Step 3 と Step 5 の修正

**新規:** なし

---

## 対象外

- インラインコメント（Review comment）のメタデータ化: 現状は resolve の仕組みで管理できているため不要
- 過去の PR への遡及適用: 新しい PR からメタデータを埋め込む（後方互換性は維持）
- メタデータの JSON 化: HTML コメント形式で十分シンプル

---

## 検証方法

### 手動テスト（E2E）

1. **Auto Review のメタデータ埋め込み確認**:
   - 新しい PR を作成
   - CI 完了後、Auto Review が実行される
   - PR コメントにメタデータが埋め込まれているか確認
   - 重大度別件数が正しいか確認

2. **Rules Check のメタデータ埋め込み確認**:
   - ルール違反を含む PR を作成
   - CI 完了後、Rules Check が実行される
   - PR コメントにメタデータが埋め込まれているか確認
   - `<!-- rules-check-result:fail -->` も併存しているか確認

3. **`/review-and-merge` スキルでの解析確認**:
   - メタデータありの PR で `/review-and-merge` を実行
   - Step 3 でメタデータが正しく抽出・表示されるか確認
   - Step 5 でメタデータによる判定が動作するか確認

4. **後方互換性確認**:
   - 古い PR（メタデータなし）で `/review-and-merge` を実行
   - フォールバック（本文解釈）が動作するか確認

---

## ブラッシュアップループの記録

| ループ | 検出したギャップ | 観点 | 対応 |
|-------|----------------|------|------|
| （実装時に記録） | | | |

---

## 収束確認（設計・計画）

| # | 観点 | 理想状態（To-Be） | 判定 | 確認内容 |
|---|------|------------------|------|---------|
| 1 | 網羅性 | Auto Review, Rules Check, `/review-and-merge` の3箇所すべてを対象に含む | OK | Phase 1-4 で3箇所すべてをカバー |
| 2 | 曖昧さ排除 | メタデータのスキーマ、配置場所、抽出方法が明確 | OK | メタデータスキーマ、配置場所、抽出方法の grep コマンド例を明記 |
| 3 | 設計判断の完結性 | HTML コメント形式の選択理由、代替案との比較を記載 | OK | 「採用方式」セクションで理由を明記、Plan agent の設計書に代替案比較あり |
| 4 | スコープ境界 | 対象と対象外が明記されている | OK | 「対象外」セクションでインラインコメント、過去の PR、JSON 化を除外 |
| 5 | 技術的前提 | grep の正規表現、GitHub API の制約を考慮 | OK | grep コマンド例を記載、既存の jq パターンを参照 |
| 6 | 既存ドキュメント整合 | Issue #521, ADR-011（Claude Code Action 導入）と整合 | OK | Issue #521 の完了基準と一致、claude-auto-review.yaml のコメントで ADR-011 を参照 |
