# 計画: #655 Observability ロードマップを詳細設計書に文書化

## Context

Epic #648（Observability 基盤の設計と段階的実装）の Story 1〜4, 6 が全て完了し、Observability の実装が一通り揃った。しかし、これらの設計判断を一元的にまとめた詳細設計書が存在しない。運用設計書（WHAT）と実装（HOW）を橋渡しする設計書を作成し、新規参加者が全体像を把握でき、Phase 4（OpenTelemetry + Datadog）への接続パスを明確にする。

## 対象・対象外

対象:
- `docs/03_詳細設計書/14_Observability設計.md` の新規作成
- 運用設計書 9.1〜9.4 の MUST 要件との対応表
- Phase 4 への移行パスの文書化

対象外:
- コード変更（ドキュメントのみ）
- 実装ロードマップ（`00_実装ロードマップ.md`）の更新（必要であれば別 Issue）
- メトリクス・アラート・ダッシュボードの詳細設計（Phase 4 で実施）

## 設計判断

### ファイル命名

既存の詳細設計書の連番は 00〜13（12 が最新作成）。次の番号は `14`。
→ `docs/03_詳細設計書/14_Observability設計.md`

### ドキュメント構造

既存の詳細設計書パターン（`07_認証機能設計.md`, `08_AuthService設計.md`）に準拠する。
ただし本文書は「実装後の設計記録 + Phase 4 ロードマップ」という性質のため、以下を調整:

- 実装済みセクションにはマーカーなし（docs.md ルールに従い、マーカーなし = 実装済み）
- Phase 4 向けセクション（メトリクス、OpenTelemetry、ダッシュボード、アラート）には実装状態マーカーを付与
- 運用設計書の MUST 要件対応表で、対応状況を「実装済み / Phase 4 で対応」と分類

### 章構成

1. 概要（目的、関連ドキュメント、対象要件、Epic #648 との関係）
2. 設計原則（AI エージェントによる調査を前提としたログ設計 — Epic から転記）
3. アーキテクチャ（現在: tracing_subscriber → stdout/JSON、将来: → OTel Collector → Datadog）
4. ログ設計（構造化ログフォーマット、ログレベルガイドライン、出力先、PII マスキング）
5. 計装設計（レイヤーごとのスパン設計、フィールド命名規則、Request ID 伝播）
6. ビジネスイベントログ設計（イベントカテゴリ、アクション定数、エラーコンテキスト）
7. メトリクス設計（Phase 4 — 運用設計書 9.2 に基づく）
8. Phase 4 移行パス（OpenTelemetry 導入計画、Datadog 連携、移行ステップ）
9. MUST 要件対応表（運用設計書 9.1〜9.4 + 8.5 + 8.6 の MUST/MUST NOT 要件）
10. 変更履歴

### 内容ソース

| セクション | 主なソース |
|-----------|-----------|
| 設計原則 | Epic #648 Issue 本文 |
| ログ設計 | `shared/src/observability.rs`, `docs/06_ナレッジベース/backend/log-schema.md` |
| 計装設計 | `docs/07_実装解説/PR692_アプリケーション計装/` |
| ビジネスイベントログ | `shared/src/event_log.rs`, `docs/07_実装解説/PR675_ビジネスイベントログ/` |
| PII マスキング | `domain/src/macros.rs`, `docs/07_実装解説/PR668_PIIマスキング基盤/` |
| Request ID | `bff/src/middleware/request_id.rs` |
| メトリクス・Phase 4 | 運用設計書 9.1〜9.2, OpenTelemetry Rust SDK ベストプラクティス |
| MUST 要件対応表 | 運用設計書 9.1〜9.4, 8.5, 8.6 |

## 確認事項

- [x] 既存の詳細設計書のフォーマットパターン → `07_認証機能設計.md`, `08_AuthService設計.md` を確認済み
- [x] 連番の次番号 → 14（12 が最新、13 はデザインガイドライン）
- [x] 実装状態マーカーのルール → `docs.md` 確認済み（マーカーなし = 実装済み）
- [x] 運用設計書の MUST 要件 → セクション 9.1〜9.4, 8.5, 8.6 を確認済み
- [x] 実装コード → `observability.rs`, `event_log.rs`, `request_id.rs`, `macros.rs` 確認済み
- [x] ナレッジベース → `log-schema.md` 確認済み

## 実装計画

ドキュメント作成タスクのため TDD は適用外。

### Phase 1: 設計書の作成

#### テストリスト

ユニットテスト（該当なし）
ハンドラテスト（該当なし）
API テスト（該当なし）
E2E テスト（該当なし）

#### 確認事項
- [x] 既存の詳細設計書のフォーマットパターン → 上記で確認済み
- [x] MUST 要件の完全なリスト → 運用設計書から抽出済み

#### 作業内容

1. `docs/03_詳細設計書/14_Observability設計.md` を作成
2. 実装済みの設計（ログ、計装、PII、Request ID、ビジネスイベント）を文書化
3. Phase 4 向けセクション（メトリクス、OTel、ダッシュボード、アラート）を文書化
4. MUST 要件対応表を作成

### ブラッシュアップループの記録

| ループ | 検出したギャップ | 観点 | 対応 |
|-------|----------------|------|------|
| 1回目 | 監査ログ要件（8.5）と鍵管理要件（8.6）も MUST 要件に含まれる | 未定義 | MUST 要件対応表のスコープを 9.1〜9.4 + 8.5 + 8.6 に拡大 |
| 2回目 | メトリクス設計は Phase 4 だが運用設計書で閾値が定義済み | 不完全なパス | メトリクス設計セクションを追加し実装状態マーカー付きで記載 |

## 収束確認（設計・計画）

| # | 観点 | 理想状態（To-Be） | 判定 | 確認内容 |
|---|------|------------------|------|---------|
| 1 | 網羅性 | Issue の完了基準 5 項目すべてが計画に含まれている | OK | ログ設計、計装設計、Phase 4 接続パス、MUST 対応表を全て含む |
| 2 | 曖昧さ排除 | 章構成と内容ソースが一意に確定 | OK | 各セクションのソースファイルを明示 |
| 3 | 設計判断の完結性 | ファイル名、章構成、マーカー使い分けの判断が完了 | OK | `14_Observability設計.md`、10章構成、実装済み/Phase 4 の区分を決定 |
| 4 | スコープ境界 | 対象と対象外が明記 | OK | 対象外にコード変更、ロードマップ更新、Phase 4 詳細設計を明示 |
| 5 | 技術的前提 | OpenTelemetry Rust SDK の現状を把握 | OK | `tracing-opentelemetry` クレートで既存 tracing コードを変更せず Exporter 追加可能 |
| 6 | 既存ドキュメント整合 | 運用設計書、実装ロードマップ、ADR と矛盾なし | OK | 運用設計書の Phase 4 記載、ADR-049 の方針と整合 |

## 検証方法

- `docs/03_詳細設計書/14_Observability設計.md` が存在すること
- Issue #655 の完了基準 5 項目すべてが文書に含まれていること
- MUST 要件対応表が運用設計書の全 MUST/MUST NOT 要件を網羅していること
- 実装状態マーカーが正しく付与されていること（実装済み = マーカーなし、Phase 4 = マーカーあり）
