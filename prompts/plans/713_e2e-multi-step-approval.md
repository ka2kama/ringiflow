# #713 Phase 2-3 E2E テスト（多段階承認・却下・差し戻し）

## Context

Phase 2-3 のバックエンド・フロントエンド実装は完了しているが、E2E テストは1段階承認のみカバーしている。E2E テスト突合表の未実装シナリオ（E2E-004 拡張、E2E-005、E2E-006）を実装し、Phase 2-3 機能の端到端検証を完了させる。これにより Epic #404 のクローズ条件が達成され、後続 Epic（#405, #406）のブロッカーが解除される。

## 対象

- E2E-004 拡張: 2段階承認フローの E2E テスト
- E2E-005: 却下フローの E2E テスト
- E2E-006: 差し戻し→再申請フローの E2E テスト
- E2E テスト突合表の更新
- E2E テストインフラの拡張（一般ユーザー認証セットアップ）

## 対象外

- バックエンド・フロントエンドの実装変更（既に完了済み）
- E2E-002（SSO）、E2E-007〜010（機能未実装のシナリオ）
- API テストの追加・修正

## 設計判断

### 1. マルチユーザー E2E テストの実現方式

**選択: `browser.newContext()` + 複数 storageState**

2段階承認テストでは admin と user の2ユーザーが必要。`auth.setup.ts` に一般ユーザーのセットアップを追加し、テスト内で `browser.newContext({ storageState })` で別ユーザーのコンテキストを作成する。

代替案:
- Playwright プロジェクト分離 → 設定が複雑化し、テスト内でユーザー切り替えが困難
- テスト内で API ログイン → storageState パターンから逸脱、セットアップ重複

### 2. テストファイル構成

E2E テストルール「1テストファイル = 1ユーザーシナリオ」に従い、シナリオ別にファイルを構成する。

| ファイル | シナリオ |
|---------|---------|
| `approval.spec.ts`（既存拡張） | E2E-004: 2段階承認テストを追加 |
| `rejection.spec.ts`（新規） | E2E-005: 却下フロー |
| `request-changes.spec.ts`（新規） | E2E-006: 差し戻し→再申請フロー |

### 3. テスト戦略: 自己承認パターン vs マルチユーザー

| シナリオ | 戦略 | 理由 |
|---------|------|------|
| E2E-004 (2段階承認) | マルチユーザー | 2段階承認のクリティカルパスにはユーザー切り替えが必須 |
| E2E-005 (却下) | 自己承認 | 却下 UI 操作の検証が目的。1段階でクリティカルパスを検証済み |
| E2E-006 (差し戻し) | 自己承認 | 差し戻し→再申請→承認の全サイクルが目的。1段階で十分 |

### 4. 共通ヘルパーの抽出

ワークフロー作成ヘルパーが3ファイル以上で使用されるため（3回ルール）、`helpers/workflow.ts` に抽出する。既存 `approval.spec.ts` の `createAndSubmitWorkflow` もこのヘルパーを使うようリファクタリングする。

## Phase 構成

### Phase 1: E2E テストインフラ拡張

**変更ファイル:**
- `tests/e2e/tests/auth.setup.ts` — 一般ユーザー認証セットアップ追加
- `tests/e2e/helpers/test-data.ts` — マルチステップ定義 ID、認証ファイルパス定数追加
- `tests/e2e/helpers/workflow.ts` — 共通ワークフロー作成ヘルパー（新規）
- `tests/e2e/tests/approval.spec.ts` — ヘルパー import に移行（リファクタリング）

#### 確認事項
- [x] 型: `auth.setup.ts` の `setup()` API — `test as setup` + `login()` + `request.storageState({ path })` パターン
- [x] パターン: `storageState` ファイルパスの命名規則 — `tests/.auth/admin.json` → user は `tests/.auth/user.json`
- [x] ライブラリ: Playwright `browser.newContext({ storageState })` — 既存使用なし。Playwright 公式ドキュメントのパターンに従う
- [x] パターン: ApproverSelector の DOM 構造 — 選択後に `#approver-search` input が badge div に置換。順次入力で対応可能

#### テストリスト

ユニットテスト（該当なし — E2E テストインフラのため）

ハンドラテスト（該当なし）

API テスト（該当なし）

E2E テスト:
- [ ] 既存テスト（`approval.spec.ts`, `workflow.spec.ts`, `dashboard.spec.ts`）がヘルパー移行後も通過する

### Phase 2: E2E-004 拡張 — 2段階承認フロー

**変更ファイル:**
- `tests/e2e/tests/approval.spec.ts` — 2段階承認テスト追加

**テストシナリオ:**
```
Given: admin が「2段階承認申請」テンプレートでワークフローを作成
       admin を上長承認者、一般ユーザーを経理承認者に指定して申請
When:  admin がタスク一覧からステップ1の詳細を開き、承認する
And:   一般ユーザーがタスク一覧からステップ2の詳細を開き、承認する
Then:  申請一覧でワークフローのステータスが「承認済み」に更新される
```

**実装ポイント:**
- `browser.newContext({ storageState: USER_AUTH_FILE })` で一般ユーザーコンテキスト作成
- 2段階承認申請テンプレートのフォームフィールド: 件名, 内容, 金額
- 承認者選択: `id="approver-search"` が選択後に消えるため、順次入力で対応可能

#### 確認事項
- [x] パターン: 既存承認テストのロケーター戦略 — Phase 1 でヘルパーに抽出済み。getByRole, getByText, locator パターン
- [x] 型: 2段階承認定義のフォームスキーマ — 件名(text), 内容(textarea), 金額(number) の3フィールド

#### テストリスト

ユニットテスト（該当なし）

ハンドラテスト（該当なし）

API テスト（該当なし）

E2E テスト:
- [ ] 2段階承認フローで両ステップ承認後にワークフローが「承認済み」になる

### Phase 3: E2E-005 — 却下フロー

**変更ファイル:**
- `tests/e2e/tests/rejection.spec.ts` — 新規作成

**テストシナリオ:**
```
Given: admin が「汎用申請」テンプレートでワークフローを作成し、自身を承認者に指定して申請
When:  admin がタスク一覧からタスク詳細を開き、却下する
Then:  申請一覧でワークフローのステータスが「却下」に更新される
```

**実装ポイント:**
- 自己承認パターン（admin = 申請者 = 承認者）
- 確認ダイアログ: 「却下の確認」→「却下する」ボタン
- 成功メッセージ: 「却下しました」
- ステータス検証: 「却下」

#### 確認事項

確認事項: なし（Phase 1-2 で確認済みのパターンのみ）

#### テストリスト

ユニットテスト（該当なし）

ハンドラテスト（該当なし）

API テスト（該当なし）

E2E テスト:
- [ ] タスク詳細から却下するとワークフローのステータスが「却下」に更新される

### Phase 4: E2E-006 — 差し戻し→再申請フロー

**変更ファイル:**
- `tests/e2e/tests/request-changes.spec.ts` — 新規作成

**テストシナリオ:**
```
Given: admin が「汎用申請」テンプレートでワークフローを作成し、自身を承認者に指定して申請
When:  admin がタスク詳細から差し戻す
And:   admin がワークフロー詳細からフォームを修正して再申請する
And:   admin がタスク詳細から承認する
Then:  申請一覧でワークフローのステータスが「承認済み」に更新される
```

**実装ポイント:**
- 差し戻し: 確認ダイアログ「差し戻しの確認」→「差し戻す」、成功メッセージ「差し戻しました」
- ワークフロー詳細遷移: 申請一覧で該当ワークフローを見つけてクリック
- 再申請バナー: 「この申請は差し戻されました。内容を修正して再申請できます。」
- 再申請ボタン: 「再申請する」→ 編集フォーム表示 → フォーム修正 → 「再申請する」
- 再申請後の承認: タスク一覧に新しいタスクが表示される

#### 確認事項
- [ ] パターン: ワークフロー詳細ページの再申請 UI 構造 — `frontend/src/Page/Workflow/Detail.elm`（再申請バナー、編集フォーム、承認者再選択）
- [ ] パターン: 再申請後のタスク表示 — 新しいステップが生成され、タスク一覧に表示されるか

#### テストリスト

ユニットテスト（該当なし）

ハンドラテスト（該当なし）

API テスト（該当なし）

E2E テスト:
- [ ] 差し戻し→フォーム修正→再申請→承認でワークフローが「承認済み」になる

### Phase 5: E2E テスト突合表更新

**変更ファイル:**
- `docs/50_テスト/E2Eテスト突合表.md`

#### 確認事項

確認事項: なし（ドキュメント更新のみ）

#### テストリスト

ユニットテスト（該当なし）

ハンドラテスト（該当なし）

API テスト（該当なし）

E2E テスト（該当なし）

## 主要ファイル参照

| ファイル | 役割 |
|---------|------|
| `tests/e2e/tests/auth.setup.ts` | 認証セットアップ |
| `tests/e2e/helpers/test-data.ts` | テストデータ定数 |
| `tests/e2e/helpers/auth.ts` | 認証ヘルパー |
| `tests/e2e/tests/approval.spec.ts` | 既存承認テスト（拡張対象） |
| `tests/e2e/playwright.config.ts` | Playwright 設定 |
| `frontend/src/Page/Task/Detail.elm` | タスク詳細ページ（ボタン・ダイアログ） |
| `frontend/src/Page/Workflow/Detail.elm` | ワークフロー詳細ページ（再申請 UI） |
| `frontend/src/Page/Workflow/New.elm` | 新規申請ページ |
| `frontend/src/Component/ApproverSelector.elm` | 承認者選択コンポーネント |
| `backend/migrations/20260212000001_seed_multi_step_workflow_definition.sql` | 2段階承認定義 |

## UI 操作で使用する主要ラベル

| 操作 | ボタンテキスト | 確認ダイアログタイトル | 確認ボタン | 成功メッセージ |
|------|-------------|---------------------|-----------|-------------|
| 承認 | 「承認」(exact) | 「承認の確認」 | 「承認する」 | 「承認しました」 |
| 却下 | 「却下」 | 「却下の確認」 | 「却下する」 | 「却下しました」 |
| 差し戻し | 「差し戻し」 | 「差し戻しの確認」 | 「差し戻す」 | 「差し戻しました」 |
| 再申請 | 「再申請する」 | — | — | 「再申請しました」 |

## 検証方法

```bash
# E2E テスト実行（開発サーバー起動後）
just test-e2e

# 全テスト実行
just check-all
```

### ブラッシュアップループの記録

| ループ | 検出したギャップ | 観点 | 対応 |
|-------|----------------|------|------|
| 1回目 | `id="approver-search"` が全 ApproverSelector で重複。2段階承認の承認者選択で問題になる可能性 | 競合・エッジケース | 選択後に input が badge に置き換わる Elm の Virtual DOM 差分動作を確認。順次入力で対応可能と判断 |
| 2回目 | 2段階承認定義のフォームフィールドが汎用申請と異なる（件名 + 内容 + 金額） | 未定義 | Phase 2 のテストシナリオにフォームフィールド（金額含む）を明記 |
| 3回目 | E2E-006 で再申請後に承認者を再選択する必要がある可能性 | 不完全なパス | Detail.elm の resubmit UI を確認。編集フォームに承認者選択が含まれることを確認 |
| 4回目 | 共通ヘルパー抽出で既存テストが壊れないか | 既存手段の見落とし | Phase 1 のテストリストに既存テスト通過確認を追加 |

## 収束確認（設計・計画）

| # | 観点 | 理想状態（To-Be） | 判定 | 確認内容 |
|---|------|------------------|------|---------|
| 1 | 網羅性 | 探索で発見された全対象が計画に含まれている | OK | E2E-004, E2E-005, E2E-006 の全シナリオが Phase 2-4 に対応。インフラ拡張は Phase 1 |
| 2 | 曖昧さ排除 | 不確定な記述がゼロ | OK | 各テストシナリオを Given-When-Then で一意に記述。UI ラベルを表に整理 |
| 3 | 設計判断の完結性 | 全ての差異に判断が記載されている | OK | マルチユーザー方式、テストファイル構成、自己承認 vs マルチユーザーの判断を記載 |
| 4 | スコープ境界 | 対象と対象外が両方明記されている | OK | 「対象」「対象外」セクションに明記 |
| 5 | 技術的前提 | コードに現れない前提が考慮されている | OK | Playwright の `browser.newContext` パターン、Elm の Virtual DOM 差分による重複 ID 回避を確認 |
| 6 | 既存ドキュメント整合 | 既存ドキュメントと矛盾がない | OK | E2E テストルール（`.claude/rules/e2e-test.md`）、突合表（`docs/50_テスト/E2Eテスト突合表.md`）、要件（CORE-12 セクション 12.6）と照合 |
