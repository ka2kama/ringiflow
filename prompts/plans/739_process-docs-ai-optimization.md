# #739 プロセスドキュメントの AI エージェント最適化

## Context

CLAUDE.md + `.claude/rules/` + 手順書で ~75,000-91,000 トークン（コンテキストの 37-45%）を消費している。主な構造的問題:

1. **重複**: CLAUDE.md が手順書・always-loaded ルールファイルと内容を重複（Issue 駆動開発フロー、Git 操作手順、禁止事項 5 件）
2. **背景と指示の混在**: 理念の散文的説明（~55 行）が実行指示と同居
3. **rule-skill-writing.md 違反**: CLAUDE.md・zoom-rhythm.md 等で語りかけ調・背景説明が残存

## スコープ

**対象**: 方向性 1-3（CLAUDE.md スリム化、禁止事項統合、ルールファイル圧縮）

- CLAUDE.md: 465 → ~290 行（37% 削減）
- Always-loaded ルールファイル: narrative 除去・構造化

**対象外**: 方向性 4-5（フェーズベース構造化、手順書の機械可読化）→ follow-up Issue

## Phase 1: CLAUDE.md スリム化

CLAUDE.md のセクション別に、圧縮・移動・削除を実施する。

### 変更方針（セクション別）

| セクション | 行 | 現状 | 方針 | 根拠 |
|-----------|-----|------|------|------|
| 言語 | 5-31 | 27行 | **軽微圧縮**（プロンプト英訳の例示を簡略化） | 指示は明確だが例示が冗長 |
| プロジェクト概要 | 32-41 | 10行 | **維持** | 技術スタック表は簡潔で有用 |
| 開発コマンド | 43-82 | 40行 | **圧縮**（必須コマンド表 + リンクに集約） | justfile が SSOT。テスト・データストア操作の詳細は参照で十分 |
| コードアーキテクチャ | 84-119 | 36行 | **圧縮**（ディレクトリツリー削除、短い要約 + リンク） | 読んで理解するのは初回のみ。依存関係の 1 行は残す |
| プロジェクト理念 | 121-176 | 56行 | **大幅圧縮**（指示形式に変換、散文を除去） | 哲学的背景 → 既存 KB（ISO25010.md, V&V.md）にリンク。設計原則は指示として残す |
| 技術選定 | 178-204 | 27行 | **軽微圧縮** | 構造は良い。禁止事項 2 件はここが canonical |
| 俯瞰・実装リズム | 206-220 | 15行 | **圧縮**（散文削除、表 + リンクのみ） | zoom-rhythm.md（always loaded）に詳細あり。重複排除 |
| 問題解決 | 222-238 | 17行 | **圧縮**（6 ステップリスト + リンクのみ） | problem-solving.md（always loaded）に詳細あり。重複排除 |
| 運用サイクル | 240-250 | 11行 | **維持** | 既に簡潔 |
| ドキュメント体系 | 252-298 | 47行 | **圧縮**（ナビテーブルを 3 行に集約） | 暗黙知禁止の宣言 + 参照テーブルを簡略化。ドキュメント自動作成ルールは残す |
| 学習支援 | 300-317 | 18行 | **軽微圧縮** | Insight 形式は残す |
| Issue 駆動開発 | 319-346 | 28行 | **大幅圧縮**（フロー要約 L337-346 を削除） | 手順書が SSOT。重複削除。禁止事項 2 件は always-loaded ルールと重複するが CLAUDE.md が canonical（エントリポイントとして） |
| 破壊的操作 | 348-364 | 17行 | **維持** | 構造化済み、模範的フォーマット |
| Git 操作ルール | 366-454 | 89行 | **大幅圧縮**（詳細手順削除、必須ルール + リンクに集約） | 手順書が SSOT。PR 作成/完了/マージの詳細手順は手順書で十分。必須ルール（ブランチ命名、禁止事項）のみ残す |
| PR レビュー | 456-465 | 10行 | **維持** | 既に簡潔 |

### 禁止事項の重複排除方針

CLAUDE.md に残す禁止事項は「always-loaded ルールファイルと重複しないもの」のみ。
always-loaded ルール（zoom-rhythm.md, problem-solving.md 等）に canonical 定義がある禁止事項は CLAUDE.md から削除する。

| CLAUDE.md の禁止事項 | Always-loaded ルール | 方針 |
|---------------------|---------------------|------|
| 視点を上げずに実装を続ける (L220) | zoom-rhythm.md L327 | **CLAUDE.md から削除** |
| 収束確認なしに成果物提示 (L220) | zoom-rhythm.md L328 | **CLAUDE.md から削除** |
| フレームワーク経ずに対策提示 (L238) | problem-solving.md L114 | **CLAUDE.md から削除** |
| 手順書を読まず実装開始 (L325) | CLAUDE.md 固有 | **CLAUDE.md に残す**（canonical） |
| テストなしにコード開始 (L329) | CLAUDE.md 固有 | **CLAUDE.md に残す**（canonical） |

### 確認事項

- [x] zoom-rhythm.md が frontmatter `paths:` なし（always loaded）→ 確認済み、なし
- [x] problem-solving.md が frontmatter `paths:` なし（always loaded）→ 確認済み、なし
- [x] 既存 KB 記事 ISO25010.md / V&V.md が背景知識の移動先として適切か → 確認済み、適切（品質特性・V&V の詳細解説が存在）
- [x] 手順書（01_Issue駆動開発.md）が Git 操作手順の SSOT として十分か → 確認済み、PR 作成/完了/マージの詳細手順を網羅

### テストリスト

ユニットテスト（該当なし）
ハンドラテスト（該当なし）
API テスト（該当なし）
E2E テスト（該当なし）

検証:
- [x] 圧縮前後で実行指示の欠損がないこと → 全セクション確認済み
- [x] 内部リンクがすべて有効であること → 25 リンク全件 OK
- [x] rule-skill-writing.md の基準に準拠していること → 語りかけ調・背景散文ゼロ
- [x] 行数が 290 行以下に収まっていること → 285 行（38.7% 削減）

## Phase 2: Always-loaded ルールファイルの最適化

### 対象ファイル

| ファイル | サイズ | ロード条件 | 方針 |
|---------|-------|-----------|------|
| zoom-rhythm.md | 19 KB | 常時 | **圧縮**（語りかけ調の散文除去、冗長な例の簡略化） |
| troubleshooting.md | 9.4 KB | 常時 | **圧縮**（背景説明除去、「既知手法との関連」をリンクに） |
| problem-solving.md | 5.4 KB | 常時 | **軽微圧縮**（散文的説明の構造化） |
| pre-implementation.md | 4.3 KB | 常時 | **軽微修正**（rule-skill-writing.md 準拠確認のみ） |
| long-running-commands.md | 1.7 KB | 常時 | **維持**（既に簡潔） |

### zoom-rhythm.md の主な変更

1. **散文除去**: 「良いプログラミングは〜」等の語りかけ調テキストを指示形式に変換
2. **例の簡略化**: ブラッシュアップループの冗長な例を最小限に
3. **背景説明の移動**: 「品質を守る二つの砦」の説明的セクションを表のみに圧縮

### troubleshooting.md の主な変更

1. **「既知手法との関連」セクション**: methodology-design.md の領域。リンクに圧縮
2. **散弾銃デバッグの説明**: 定義（「〜とされる」）は背景知識。検出基準と対応のみ残す
3. **「核心原則」の図**: ASCII ダイアグラムを維持しつつ散文を削減

### problem-solving.md の主な変更

1. **Want/How の説明**: 例示・構造図を簡略化
2. **Issue 精査の重複**: 手順書との重複部分を参照に変換

### 確認事項

- [x] zoom-rhythm.md のギャップ発見の観点テーブル → 12 ファイルから参照あり。テーブルは維持、形式を圧縮
- [x] troubleshooting.md の仮説追跡テーブル → investigations/README.md と整合確認済み
- [x] problem-solving.md の Issue 精査フォーマット → 01_Issue駆動開発.md と整合確認済み

### テストリスト

ユニットテスト（該当なし）
ハンドラテスト（該当なし）
API テスト（該当なし）
E2E テスト（該当なし）

検証:
- [x] 圧縮後の各ファイルが rule-skill-writing.md に準拠していること → 語りかけ調・背景散文ゼロ
- [x] クロスリファレンスの整合性 → 15 リンク全件 OK
- [x] Always-loaded ファイルの合計バイト数が削減 → 40,142 B → 33,487 B（16.6% 削減）

## 検証方法

1. **情報の完全性**: 各セクションの diff を確認し、実行指示が欠損していないことを検証
2. **リンク整合性**: 全 Markdown リンクの参照先ファイルが存在することを確認
3. **rule-skill-writing.md 準拠**: 語りかけ調「〜である」「良い〜は」、背景説明セクション「## 理由」の不在を確認
4. **トークン削減**: 圧縮前後のバイト数を比較
5. **`just check-all`**: コードに影響がないことの確認（docs のみの変更だが念のため）

## ブラッシュアップループの記録

| ループ | 検出したギャップ | 観点 | 対応 |
|-------|----------------|------|------|
| 1回目 | 禁止事項の canonical 定義場所が不明確 | 未定義 | 禁止事項ごとに canonical location を明示する表を追加 |
| 2回目 | CLAUDE.md の「プロジェクト理念」は背景だけでなく設計原則（YAGNI/KISS 区別、型活用）も含む | 曖昧 | 設計原則は指示として CLAUDE.md に残し、哲学的背景のみ KB リンクに |
| 3回目 | always-loaded ルールの禁止事項は CLAUDE.md から削除して良いが、CLAUDE.md 固有のもの（手順書未読、テスト未作成）は残す必要がある | 不完全なパス | 禁止事項別の残す/削除判定表を追加 |

## 収束確認（設計・計画）

| # | 観点 | 理想状態（To-Be） | 判定 | 確認内容 |
|---|------|------------------|------|---------|
| 1 | 網羅性 | CLAUDE.md 全セクションに方針が定義されている | OK | 16 セクションすべてに方針（維持/圧縮/大幅圧縮）を記載 |
| 2 | 曖昧さ排除 | 各セクションの変更内容が具体的 | OK | 「圧縮」の内容を具体的に記述（何を残し何を削除するか）。「必要に応じて」等の不確定記述なし |
| 3 | 設計判断の完結性 | 禁止事項の残す/削除判定が全件分ある | OK | 重複禁止事項 5 件の判定表を Phase 1 に記載 |
| 4 | スコープ境界 | 対象と対象外が明記 | OK | 方向性 1-3 が対象、4-5 が対象外と明記 |
| 5 | 技術的前提 | CLAUDE.md のローディングメカニズムを理解 | OK | CLAUDE.md は常時ロード。rules/ は frontmatter `paths:` で条件付き。6 ファイルが frontmatter なし（常時ロード） |
| 6 | 既存ドキュメント整合 | 既存 KB・手順書との矛盾なし | OK | ISO25010.md, V&V.md が背景知識の移動先として適切。手順書が Git 操作の SSOT として網羅 |
