# 計画: #276 Lightsail を IPv6-only からデュアルスタックに切り替え

## Context

現在の Lightsail インスタンスは IPv6-only（$5/月）で運用しているが、以下の問題が発生している:

1. Docker コンテナからインターネットに出られない（デフォルトブリッジが IPv4 のみ）
2. SCP で IPv6 アドレスに角括弧が必要 + zsh のクォート問題
3. deploy.sh で `SSH_TARGET` / `SCP_TARGET` の分離が必要

デュアルスタック（$7/月、+$2）に切り替えることで、これらすべてが解消される。

## スコープ

### 対象

- ADR 作成（ADR-047: IPv6-only → デュアルスタック切り替え）
- `infra/lightsail/deploy.sh` の IPv6 ワークアラウンド簡略化
- `scripts/deploy-lightsail.sh` のコメント更新
- `infra/lightsail/README.md` の更新（コスト、DNS レコード、IPv6 注意事項、マイグレーション手順）
- `docs/06_ナレッジベース/infra/IPv6-only環境でのDocker運用.md` にアーカイブ注記追加

### 対象外

- AWS コンソールでの実際のインスタンス切り替え作業（手動操作）
- Cloudflare DNS レコードの変更（手動操作）
- GitHub Secrets の更新（手動操作）

## Phase 1: ADR-047 作成

### 確認事項

- [x] パターン: ADR テンプレート → `docs/05_ADR/template.md`
- [x] 既存: ADR-030（Lightsail 個人環境の構築）→ 変更履歴に追記

### 作業内容

`docs/05_ADR/047_LightsailのIPv6-onlyからデュアルスタックへの切り替え.md` を作成。

選択肢:
1. 現状維持（IPv6-only, $5/月）
2. デュアルスタックに切り替え（$7/月）
3. インスタンス再作成（IPv4 のみ）

決定: 選択肢 2（デュアルスタック）

ADR-030 の変更履歴にもデュアルスタック切り替えの旨を追記。

### テストリスト

ユニットテスト（該当なし）
ハンドラテスト（該当なし）
API テスト（該当なし）
E2E テスト（該当なし）

## Phase 2: deploy.sh の IPv6 ワークアラウンド簡略化

### 確認事項

確認事項: なし（既知のパターンのみ）

### 作業内容

`infra/lightsail/deploy.sh` L69-77:

現在の IPv6 分岐ロジック:
```bash
SSH_TARGET="$LIGHTSAIL_USER@$LIGHTSAIL_HOST"
if [[ "$LIGHTSAIL_HOST" == *:* ]]; then
    SCP_TARGET="$LIGHTSAIL_USER@[$LIGHTSAIL_HOST]"
else
    SCP_TARGET="$SSH_TARGET"
fi
```

変更後: `SCP_TARGET` 分岐を削除し、`SSH_TARGET` に統一。`SCP_TARGET` の使用箇所を `SSH_TARGET` に置換。
IPv6 分岐のコメント（L69-72）も削除。

### テストリスト

ユニットテスト（該当なし）
ハンドラテスト（該当なし）
API テスト（該当なし）
E2E テスト（該当なし）

## Phase 3: scripts/deploy-lightsail.sh のコメント更新

### 確認事項

確認事項: なし（既知のパターンのみ）

### 作業内容

L30 のコメント `# 設定ファイルを転送（tar over SSH で IPv6 アドレスにも対応）` を
`# 設定ファイルを転送（tar over SSH）` に簡略化。

### テストリスト

ユニットテスト（該当なし）
ハンドラテスト（該当なし）
API テスト（該当なし）
E2E テスト（該当なし）

## Phase 4: README.md の更新

### 確認事項

確認事項: なし（既知のパターンのみ）

### 作業内容

`infra/lightsail/README.md` の以下を更新:

1. **コスト表**: $5 → $7
2. **DNS レコード**: 現在 A レコード記載だが、ナレッジベースでは AAAA と記載。デュアルスタックでは IPv4 静的 IP が使えるため A レコードで正しい。整合性のための注記は不要（デュアルスタック化により自然に解消）
3. **IPv6-only 環境の注意事項セクション削除**: `## IPv6-only 環境の注意事項` セクション全体を削除
4. **マイグレーション手順の簡略化**: 方法 A（psql 直接実行）の IPv6-only 向け注記を更新し、方法 B（sqlx-cli）を推奨に変更

### テストリスト

ユニットテスト（該当なし）
ハンドラテスト（該当なし）
API テスト（該当なし）
E2E テスト（該当なし）

## Phase 5: ナレッジベース更新

### 確認事項

確認事項: なし（既知のパターンのみ）

### 作業内容

`docs/06_ナレッジベース/infra/IPv6-only環境でのDocker運用.md` の冒頭にアーカイブ注記を追加:

```markdown
> **注記**: [ADR-047](../../05_ADR/047_LightsailのIPv6-onlyからデュアルスタックへの切り替え.md) により、Lightsail はデュアルスタックに切り替え済み。本ドキュメントは IPv6-only 環境での知見の記録として残す。
```

`## プロジェクトでの使用箇所` セクションも更新（deploy.sh の SCP_TARGET 分離は廃止された旨）。

### テストリスト

ユニットテスト（該当なし）
ハンドラテスト（該当なし）
API テスト（該当なし）
E2E テスト（該当なし）

## ブラッシュアップループの記録

| ループ | 検出したギャップ | 観点 | 対応 |
|-------|----------------|------|------|
| 1回目 | README の DNS レコード型（A）とナレッジベース（AAAA）の不整合 | 不完全なパス | デュアルスタック化で A レコードが正しくなるため、README は変更不要。ナレッジベースはアーカイブ扱いなのでそのまま |
| 2回目 | ADR-030 の変更履歴更新が計画に含まれていなかった | 未定義 | Phase 1 に ADR-030 の変更履歴追記を追加 |

## 収束確認（設計・計画）

| # | 観点 | 理想状態（To-Be） | 判定 | 確認内容 |
|---|------|------------------|------|---------|
| 1 | 網羅性 | IPv6-only に関連する全ファイルが計画に含まれている | OK | deploy.sh, deploy-lightsail.sh, README.md, ナレッジベース, ADR-030 を網羅。docker-compose.yaml は IPv6 依存コードなし |
| 2 | 曖昧さ排除 | 不確定な記述がゼロ | OK | 各 Phase の変更内容が具体的に記述されている |
| 3 | 設計判断の完結性 | 全ての差異に判断が記載されている | OK | DNS レコード型の不整合について判断記載済み |
| 4 | スコープ境界 | 対象と対象外が両方明記されている | OK | 手動操作（AWS コンソール、Cloudflare、GitHub Secrets）を対象外に明記 |
| 5 | 技術的前提 | コードに現れない前提が考慮されている | OK | Lightsail デュアルスタックでは IPv4 静的 IP が利用可能という前提を確認 |
| 6 | 既存ドキュメント整合 | 既存ドキュメントと矛盾がない | OK | ADR-030, ナレッジベースとの整合を確認 |

## 検証方法

- `just fmt` でフォーマット確認
- 各ドキュメントの内部リンクが有効であることを確認
- shellcheck で deploy.sh の構文チェック（`shellcheck infra/lightsail/deploy.sh`）
