# #565 実行ギャップ再発（50%）の構造的対策

## Context

レトロスペクティブ（2026-02-16）で実行ギャップが 9%→50% に急増。#392（行動規範→成果物要件転換）はコード実装領域では有効だが、プロセス運用（改善記録のフォーマット遵守、スキル手順遵守等）には波及していない。

8 件の実行ギャップを分析し、3 つの構造パターンを特定:
- Pattern A: 参照漏れ at meta-level（3件）— テンプレート/定義を参照せず改善記録を作成
- Pattern B: 即座の対策（3件）— 問題の性質を分類せず対策を設計
- Pattern C: 実行フロー漏れ（2件）— スキル手順がスキップされる（既存 Issue でカバー済み）

## 対象

- `prompts/improvements/README.md` — 問題の性質フィールドと routing table を追加
- `.claude/rules/problem-solving.md` — 問題の性質による前段分類を追加
- `.claude/skills/wrap-up/SKILL.md` — 改善記録作成ステップに README 参照と自己チェックを組み込み

## 対象外

- #549（破壊的操作の判定チェックリスト — CLAUDE.md の変更）
- #545（Draft 後の再 Ready フロー — PR 完了フローの変更）
- Pattern C の対策（#518 closed、docs.md 修正済み）

## 既存 Issue との関係

| Issue | 関係 | 方針 |
|-------|------|------|
| #547（対策妥当性チェックリスト） | Phase 1 で README に統合 | 実装後にクローズ |
| #550（改善記録作成時の自己チェック） | Phase 3 で wrap-up に統合 | 実装後にクローズ |
| #549（破壊的操作チェックリスト） | 独立 | 別途対応 |
| #545（Draft 後の再 Ready フロー） | 独立 | 別途対応 |

---

## Phase 1: 改善記録 README — 問題の性質分類と routing table

### 確認事項
- [x] パターン: README の「対策形式の検証」セクション（L79-97）→ L97 の後に新セクション追加を確認
- [x] パターン: README の「分類」セクション（L113-167）→ 照合手順 L146-154 に問題の性質を追加

### 変更内容

**1. 「対策設計の前提: 問題の性質分類（必須）」セクション新設**（「対策形式の検証」の後、L97 付近）

対策を設計する前に問題の性質を分類し、適切なアプローチを選択する routing table を追加:

| 性質 | 定義 | 適切なアプローチ | 対策の配置先 |
|------|------|----------------|-------------|
| 技術的 | CI エラー、ビルドエラー、実行時エラー、ツール仕様 | 調査手順、確認手段の明確化 | `troubleshooting.md`、ナレッジベース |
| プロセス的 | 手順スキップ、品質ゲート漏れ、フロー不備 | フロー改善、チェックリスト、スキル修正 | 手順書、スキル定義、CLAUDE.md |
| 思考的 | 判断の誤り、分析不足、視点の欠如 | フレームワーク、原則、観点の追加 | `problem-solving.md`、設計原則 |

禁止: 問題の性質を分類せずに対策を記載すること

対策案の妥当性チェック（#547 の内容を統合）:
1. 問題の性質と対策の配置先が一致しているか
2. 既存ツール・フレームワークの適用範囲を確認したか
3. 対策が既存ツールのスコープを不適切に拡大していないか

**2. 「分類」セクションの照合手順に問題の性質を追加**（L146-154 付近）

既存の照合手順（カテゴリ 6 種、失敗タイプ 3 種）に、問題の性質 3 種の照合を追加

### テストリスト

ユニットテスト（該当なし）
ハンドラテスト（該当なし）
API テスト（該当なし）
E2E テスト（該当なし）

検証: README を読み返し、問題の性質が必須フィールドとして定義されていること、routing table が 3 性質をカバーしていること、照合手順に含まれていることを確認

---

## Phase 2: problem-solving.md — 問題の性質による前段分類

### 確認事項
- [x] パターン: problem-solving.md の「適用場面」セクション → L5-14、適用場面の後（L14）に追加
- [x] パターン: troubleshooting.md との境界 → 同ディレクトリ内の相対パス `troubleshooting.md` で参照

### 変更内容

「適用場面」セクションの後に「問題の性質による前段分類」を追加:

- problem-solving.md（Want/To-Be/As-Is フレームワーク）は主に**プロセス的・思考的問題**に適用
- **技術的問題**は troubleshooting.md の調査フローに直接従う
- routing のみを追加し、技術的問題の詳細は troubleshooting.md に委譲

### テストリスト

ユニットテスト（該当なし）
ハンドラテスト（該当なし）
API テスト（該当なし）
E2E テスト（該当なし）

検証: problem-solving.md と troubleshooting.md の適用範囲が明確に分離されていること、改善記録 README との相互参照が正しいことを確認

---

## Phase 3: wrap-up スキル — 改善記録作成ステップ強化

### 確認事項
- [x] パターン: wrap-up SKILL.md の改善記録セクション → L114-121（3 ステップ）を 7 ステップに拡充

### 変更内容

現在の 3 ステップを 7 ステップに拡充:

1. **README を Read で参照**し、記載内容・分類定義・対策形式を確認する ← NEW
2. 初回コミット時刻を取得してファイル名を組み立てる（命名規則照合を実施）
3. 構成: 事象 → 原因分析 → 対策（**問題の性質分類を含む**） → 次のアクション → 分類
4. 対策セクションで確認: 問題の性質が記載、配置先が routing table と一致、対策形式が検討済み ← NEW
5. 分類セクションで照合手順を実施（カテゴリ 6 種、失敗タイプ 3 種、問題の性質 3 種） ← NEW
6. 恒久対策がある場合は GitHub Issue を作成し、記録に Issue 番号を記載
7. **docs.md の自己チェック**（コンテキスト独立性、サニタイズ、文体整合）を実施する ← NEW（#550 統合）

### テストリスト

ユニットテスト（該当なし）
ハンドラテスト（該当なし）
API テスト（該当なし）
E2E テスト（該当なし）

検証: wrap-up スキルが README の必須フィールドを網羅的にカバーしていること、自己チェックがステップとして含まれていることを確認

---

## 8 パターンのカバレッジ

| 改善記録 | パターン | 対策 | Issue |
|---------|---------|------|-------|
| カテゴリ混同 | A: 参照漏れ | Phase 3: wrap-up で README Read 必須化 | #520 closed |
| 自己チェック省略 | A: 参照漏れ | Phase 3: wrap-up で自己チェックをステップ化 | #550 → サブスーム |
| 検証セクション誤記 | A: 参照漏れ | Phase 3: wrap-up で README Read 必須化 | 対応済み |
| エラーメッセージ鵜呑み | B: 即座の対策 | Phase 1: 「技術的」→ troubleshooting.md routing | #546 closed |
| 問題分類なし対策 | B: 即座の対策 | Phase 1: 問題の性質を必須フィールド化 | #547 → サブスーム |
| ユーザー確認なし破壊的操作 | B: 即座の対策 | スコープ外 | #549 open |
| base-branch 同期スキップ | C: フロー漏れ | 対策済み | #518 closed |
| Test-plan チェックボックス形骸化 | C: フロー漏れ | 対策済み（docs.md 修正） | #545 open |

8 件中 5 件を本 Issue で対策。1 件は #549（別途）。2 件は対策済み。

## ブラッシュアップループの記録

| ループ | 検出したギャップ | 観点 | 対応 |
|-------|----------------|------|------|
| 1回目 | #547 と #550 が本 Issue と重複 | 既存手段の見落とし | サブスームし Phase 1/3 で統合的に対応 |
| 2回目 | 破壊的操作（Pattern B の 3 件目）は CLAUDE.md 変更 | スコープ境界 | スコープ外として #549 に委譲 |
| 3回目 | problem-solving.md と troubleshooting.md の境界が曖昧化リスク | アーキテクチャ不整合 | routing のみ追加、詳細は troubleshooting.md に委譲 |
| 4回目 | wrap-up の「README Read」は行動規範に近い | 対策形式の検証 | 「問題の性質」必須フィールドが成果物要件として検証可能。Read は手段、成果物で検証 |

## 収束確認（設計・計画）

| # | 観点 | 理想状態（To-Be） | 判定 | 確認内容 |
|---|------|------------------|------|---------|
| 1 | 網羅性 | 8 件全てにカバレッジ | OK | カバレッジ表で全 8 件を確認 |
| 2 | 曖昧さ排除 | 不確定な記述がゼロ | OK | 各 Phase に変更内容を具体的に記載 |
| 3 | 設計判断の完結性 | 全判断に理由記載 | OK | サブスーム判断、スコープ外判断を明記 |
| 4 | スコープ境界 | 対象と対象外が明記 | OK | 「対象」3 ファイル、「対象外」3 Issue を明記 |
| 5 | 技術的前提 | 前提が考慮されている | OK | wrap-up 経由しない記録は成果物要件でカバー |
| 6 | 既存ドキュメント整合 | 矛盾がない | OK | README の既存構造、problem-solving.md と整合 |

## 検証方法

1. 変更後の 3 ファイルを読み返し、相互参照が正しいことを確認
2. `just check` で lint エラーがないことを確認（Markdown のみのため軽量）
3. 改善記録の新テンプレートで仮想的な改善記録を作成し、routing table が機能することを確認
