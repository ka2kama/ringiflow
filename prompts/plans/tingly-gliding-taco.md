# #751 Issue/Epic の状態管理を自動化する

## Context

Epic #747 の Story 3。Issue/Epic のチェックボックス状態管理を自動化し、AI エージェントの手動更新への依存を解消する。

2つの改善記録が背景:
- 品質チェックリストの Issue 状態更新漏れ（Issue 完了基準のチェックボックスが未更新のまま auto-close）
- Epic の Story 進捗が未記録（Story マージ後も Epic タスクリストが未更新）

手順書へのフロー追加（#524 → PR #603）や品質チェックリストの文言変更（#646）で対策済みだが、根本的には「AI エージェントが手動で状態を同期する」パターン自体が失敗しやすい。Epic の設計原則 3「反復的な状態管理はスクリプトに委ねる」に基づき、スクリプトで自動化する。

## 設計判断

### アプローチ: スクリプト + スキル統合

| アプローチ | 採否 | 理由 |
|-----------|------|------|
| スクリプト + スキル統合 | 採用 | 既存パターン（scripts/）に沿い、ローカルで実行・デバッグ可能 |
| GitHub Actions | 不採用 | 複雑さが増す。ローカル実行不可。Issue body の全文置換は競合リスクが高い |
| lefthook | 不採用 | `gh pr merge --squash` は gh CLI 経由のため post-merge hook が発火しない |

### 自動化の範囲

| 対象 | 操作 | 理由 |
|------|------|------|
| Epic タスクリスト | 自動更新 | Story の完了は Issue close で確定しており、Epic への反映は機械的に可能 |
| Issue チェックボックス | 検証のみ | 自動チェックは検証の形骸化になる。AI が実際に確認した上で更新すべき |

### 対象外

- テストリスト（TDD の進捗追跡、ローカルファイル内で完結）
- 品質チェックリスト（手順書内のテンプレート、参照用）
- 改善記録の次アクション（頻度が低く自動化の投資対効果が低い）

## Phase 1: スクリプト・justfile・ドキュメント更新

確認事項: なし（既知のパターンのみ）

### 1. `scripts/issue/sync-epic.sh`

Story Issue のクローズ後に、親 Epic のタスクリストを自動更新するスクリプト。

入力: Issue 番号（引数）
出力: Epic タスクリストの該当チェックボックスを `[x]` に更新

ロジック:
1. Issue body を取得し、`Epic: #NNN` パターンで親 Epic 番号を抽出
2. Epic が見つからない場合は正常終了（Epic に属さない Issue もある）
3. Epic body を取得
4. `- [ ] ... #<Issue番号>` パターンの行を `- [x] ... #<Issue番号>` に置換
5. 該当行が既に `[x]` の場合は何もしない（冪等性）
6. `gh issue edit --body` で Epic を更新

エラーケース:
- Issue が存在しない → エラー終了
- Epic が見つからない → 正常終了（メッセージ表示）
- Epic body に該当行がない → 警告表示、正常終了

### 2. `scripts/issue/check-issue-state.sh`

Issue のチェックボックスが全て `[x]` になっているか検証するスクリプト。

入力: Issue 番号（引数、省略時はブランチ名から自動検出）
出力: 未チェック項目のレポート、終了コード（0: 全チェック済み、1: 未チェックあり）

ロジック:
1. Issue 番号を取得（引数 or ブランチ名から `feature/NNN-xxx` パターンで抽出）
2. Issue body を取得
3. `- [ ]` パターンの行を全て抽出
4. 未チェック項目がなければ成功メッセージを表示して exit 0
5. 未チェック項目があれば一覧を表示して exit 1

### 3. justfile レシピ

```just
# Issue のチェックボックス状態を検証する
check-issue *args:
    ./scripts/issue/check-issue-state.sh {{ args }}

# Story 完了後に Epic タスクリストを自動更新する
sync-epic issue_number:
    ./scripts/issue/sync-epic.sh {{ issue_number }}
```

### 4. review-and-merge スキル更新

`.claude/skills/review-and-merge/skill.md` の Step 5（マージ実行）に `sync-epic` ステップを追加:

```bash
gh pr merge --squash
just clean-branches
just sync-epic <Issue番号>
```

### 5. Issue 駆動開発手順書更新

`docs/04_手順書/04_開発フロー/01_Issue駆動開発.md`:

- セクション 6.2（品質チェックリスト）の「Issue との整合」に `just check-issue` の実行を追加
- Epic 管理セクション（Story PR マージ時）を `just sync-epic` に置き換え

### テストリスト

ユニットテスト（該当なし）
ハンドラテスト（該当なし）
API テスト（該当なし）
E2E テスト（該当なし）

検証方法: `just check-all` + 実際の Issue/Epic に対してスクリプトを手動実行して動作確認

## 収束確認（設計・計画）

| # | 観点 | 判定 | 確認内容 |
|---|------|------|---------|
| 1 | 網羅性 | OK | Epic の自動化対象 2 件（Epic タスクリスト更新、Issue チェックボックス検証）をカバー。対象外 3 件を明記 |
| 2 | 曖昧さ排除 | OK | 各スクリプトの入出力・ロジック・エラーケースを明記 |
| 3 | 設計判断の完結性 | OK | アプローチ選択（スクリプト vs GitHub Actions vs lefthook）の理由を記載 |
| 4 | スコープ境界 | OK | 対象（Epic タスクリスト、Issue チェックボックス）と対象外（テストリスト、品質チェックリスト、改善記録）を明記 |
| 5 | 技術的前提 | OK | `gh issue edit --body` は全文置換のみ（部分更新不可）、冪等性の確保が必要 |
| 6 | 既存ドキュメント整合 | OK | Epic #747 の設計原則 3「反復的な状態管理はスクリプトに委ねる」に準拠 |

### ブラッシュアップループの記録

| ループ | 検出したギャップ | 観点 | 対応 |
|-------|----------------|------|------|
| 1回目 | Issue チェックボックスの自動更新 vs 検証のみの判断が未明記 | 設計判断の完結性 | 「自動化の範囲」セクションに理由付きで明記。自動チェックは検証の形骸化になるため検証のみ |
