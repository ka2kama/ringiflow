# #941 ログポリシーの策定

## スコープ

### 対象

- `docs/40_詳細設計書/14_Observability設計.md` — 「ログポリシー」セクション新設（7 項目の判断基準）
- `docs/80_ナレッジベース/backend/log-schema.md` — 「メッセージ書き方ガイドライン」セクション追加

### 対象外

- プロダクションコードの変更（既存の実装パターンは変更しない）
- Phase 4（OpenTelemetry 移行）の設計変更
- 既存のログレベルガイドライン表の変更（判定フローで補完する）

## 設計判断

### 1. 配置場所

「ログ設計」セクション（How）と「計装設計」セクション（Where）の間に「ログポリシー」セクション（When/What）を新設する。

- 選択肢 A: ログ設計の中にサブセクションとして追加 → 却下（セクションが肥大化する）
- 選択肢 B: 独立セクションとして新設 → 採用（関心の分離が明確）

### 2. 設計書 vs ナレッジベースの分担

| 内容 | 配置先 | 理由 |
|------|-------|------|
| 判断基準（判定テスト、判定フロー） | Observability 設計書 | 設計レベルの意思決定 |
| 書き方（メッセージ命名規約、コード例） | ログスキーマ | 実装ガイドレベル |

### 3. ログレベル判定フロー

Mermaid flowchart で表現する。既存のログレベルガイドライン表（レベル・用途・例）を補完する位置づけ。

### 4. Phase 4 整合性

既存の ECS ベースのフィールド命名（`event.*`, `error.*`）と OpenTelemetry Semantic Conventions は直交するため共存可能。ポリシーの判断基準は出力先に依存しないため Phase 4 後も適用可能。

## Phase 1: Observability 設計書にログポリシーを追加

#### 確認事項

- パターン: Observability 設計書の構造・文体 → `docs/40_詳細設計書/14_Observability設計.md`
- パターン: 既存のログレベルガイドライン（重複回避） → 同ファイル line 164-174
- パターン: 既存の計装設計（整合性） → 同ファイル line 222-

#### 操作パス: 該当なし（操作パスが存在しない）

#### テストリスト

ユニットテスト（該当なし）
ハンドラテスト（該当なし）
API テスト（該当なし）
E2E テスト（該当なし）

## Phase 2: ログスキーマにメッセージ書き方ガイドラインを追加

#### 確認事項

- パターン: 既存のログスキーマの構造 → `docs/80_ナレッジベース/backend/log-schema.md`
- パターン: 実際のログメッセージ使用例 → `backend/apps/` 配下の `tracing::info!`, `tracing::error!` 呼び出し

#### 操作パス: 該当なし（操作パスが存在しない）

#### テストリスト

ユニットテスト（該当なし）
ハンドラテスト（該当なし）
API テスト（該当なし）
E2E テスト（該当なし）

## ブラッシュアップループの記録

| ループ | 検出したギャップ | 観点 | 対応 |
|-------|----------------|------|------|
| 1回目 | 既存のログレベルガイドライン表に「ヘルスチェック」が INFO の例として含まれているが、抑制基準と矛盾しうる | 競合・エッジケース | 抑制基準の対象を「手動ログ出力と `log_business_event!`」に限定し、自動計装（tower-http リクエストログ）は対象外と明記。既存表との矛盾を回避 |
| 2回目 | 計装追加基準が既存の計装設計セクションと内容重複する | 重複の排除 | 計装追加基準は「判定テスト」のみに絞り、レイヤー別詳細は既存の計装設計への参照にとどめる |

## 収束確認（設計・計画）

| # | 観点 | 理想状態（To-Be） | 判定 | 確認内容 |
|---|------|------------------|------|---------|
| 1 | 網羅性 | Issue の完了条件 7 項目 + Phase 4 整合性が全て計画に含まれている | OK | 7 項目: ビジネスイベント追加基準、ログレベル判定、ログ vs メトリクス、ボディ方針、高頻度抑制、計装基準、メッセージガイドライン + Phase 4 整合性。全項目に対応するセクションあり |
| 2 | 曖昧さ排除 | 不確定な記述がゼロ | OK | 「必要に応じて」「あれば」等の不確定表現なし。将来の抑制候補は「該当する場合に適用」と条件を明示 |
| 3 | 設計判断の完結性 | 配置場所・分担・形式の判断が完結 | OK | 設計判断 1-4 で全て記載 |
| 4 | スコープ境界 | 対象と対象外が両方明記 | OK | 対象: 2 ファイル。対象外: コード変更、Phase 4 設計変更、既存表の変更 |
| 5 | 技術的前提 | Mermaid flowchart の記法制約が考慮されている | OK | docs.md の Mermaid ルール（flowchart の `ID["ラベル"]` 構文）に準拠 |
| 6 | 既存ドキュメント整合 | 既存のログレベルガイドライン・計装設計と矛盾がない | OK | ブラッシュアップ 1-2 回目で矛盾を検出・解消済み |
