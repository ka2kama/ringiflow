# 計画: Playwright ナレッジベースとテストドキュメント体系の整備（#435）

## Context

Issue #128 で Playwright E2E テストの導入が完了した（PR #434、コミット `ffec66a`）。テストコード・CI 統合・実装解説は作成済みだが、以下のドキュメント整備が残っている:

- ツールとしての Playwright の使い方（ナレッジベース）
- テスト戦略の体系化（テストピラミッドの基本設計書への明記）
- E2E テスト突合表（カバレッジ管理）
- AI エージェント向けルール（`.claude/rules/e2e-test.md`）
- TDD 開発フローへの E2E テスト実行タイミングの追記

## 前提: ブランチの同期

現在のブランチ `feature/435-playwright` は main より古い。main の HEAD `ffec66a`（Playwright 導入コミット）を含んでいないため、実装開始前に `git rebase origin/main` を実行する。

## 対象

| # | ファイル | 操作 |
|---|---------|------|
| 1 | `docs/06_ナレッジベース/devtools/Playwright.md` | 新規 |
| 2 | `docs/02_基本設計書/01_アーキテクチャ設計.md` | 追記（テスト戦略セクション） |
| 3 | `docs/08_テスト/E2Eテスト突合表.md` | 新規 |
| 4 | `.claude/rules/e2e-test.md` | 新規 |
| 5 | `docs/04_手順書/04_開発フロー/02_TDD開発フロー.md` | 追記（E2E テスト実行タイミング） |

## 対象外

- Playwright テストコードの追加・変更（#128 で完了済み）
- CI ワークフローの変更
- ADR の作成（テスト設計方針は ADR-032 で策定済み、E2E 固有の設計判断は #128 の計画ファイルで記録済み）

## Phase 1: ナレッジベース `Playwright.md`

### 確認事項
- パターン: 既存ナレッジベース `docs/06_ナレッジベース/devtools/hurl.md` の構成を踏襲
- 型: Playwright 設定 → `tests/e2e/playwright.config.ts`
- パターン: 認証ヘルパー → `tests/e2e/helpers/auth.ts`, `tests/e2e/tests/auth.setup.ts`
- パターン: テストデータ → `tests/e2e/helpers/test-data.ts`
- パターン: テストの書き方 → `tests/e2e/tests/*.spec.ts`

### 内容構成

`hurl.md` のパターンに倣い、以下の構成で作成する:

1. **Playwright とは** — 概要（Microsoft 製のブラウザ自動化ツール）
2. **なぜ Playwright を使うのか** — 選定理由（#128 の経緯、Cypress/elm-program-test との比較）
3. **インストール** — `cd tests/e2e && pnpm install && npx playwright install chromium`
4. **テスト実行** — ローカル（`just test-e2e`）、CI の違い
5. **認証パターン: storageState** — API ログイン + storageState の仕組みと設計理由
6. **テストの書き方** — Given-When-Then コメント、ロケーター戦略
7. **デバッグ手順** — `npx playwright codegen`、`--headed`、`--ui`、スクリーンショット/トレース
8. **ローカル vs CI の環境差異** — ポート、baseURL、サーバー起動方法
9. **プロジェクトでのファイル構成** — ディレクトリツリー
10. **参考** — 公式ドキュメントリンク

## Phase 2: テスト戦略の体系化

### 確認事項
- パターン: `docs/02_基本設計書/01_アーキテクチャ設計.md` の既存構造 → Read で確認
- 型: テストピラミッドの定義 → `docs/01_要件定義書/01_コア要件.md` CORE-12（L1343-1498）
- パターン: ADR-032 のレイヤーごとのテスト表現形式

### 内容

`docs/02_基本設計書/01_アーキテクチャ設計.md` に「テスト戦略」セクションを追加する。分散している情報を基本設計レベルで統合する:

1. **テストピラミッド** — CORE-12 の要件を基に、現状の実装状況と合わせて明記
2. **テスト層の定義** — Unit / Integration / API / E2E の役割分担を表形式で整理

| テスト層 | ツール | 目的 | 実行コマンド | 配置場所 |
|---------|--------|------|-------------|---------|
| Unit (Rust) | cargo test | ドメインロジック検証 | `just test-rust` | `backend/*/src/` |
| Unit (Elm) | elm-test | UI ロジック検証 | `just test-elm` | `frontend/tests/` |
| Integration | sqlx::test | DB 連携検証 | `just test-rust-integration` | `backend/crates/infra/tests/` |
| API | Hurl | API 契約検証 | `just test-api` | `tests/api/hurl/` |
| E2E | Playwright | ユーザーシナリオ検証 | `just test-e2e` | `tests/e2e/tests/` |

3. **関連ドキュメントへのリンク** — 各層の詳細は各ドキュメントを参照

## Phase 3: E2E テスト突合表

### 確認事項
- パターン: `docs/08_テスト/APIテスト突合表.md` の構成を踏襲
- 型: E2E テストシナリオ一覧 → `docs/01_要件定義書/01_コア要件.md` CORE-12 セクション 12.6（L1460-1473）
- パターン: 実装済みテスト → `tests/e2e/tests/*.spec.ts`（auth.setup, dashboard, workflow, approval）

### 内容

要件定義の E2E シナリオ（E2E-001〜E2E-010）と実装済みテストの突合表:

| シナリオID | シナリオ名 | 優先度 | テストファイル | 状態 |
|-----------|-----------|--------|-------------|------|
| E2E-001 | ログイン | 必須 | auth.setup.ts | カバー済み（API ログイン） |
| E2E-003 | ワークフロー申請 | 必須 | workflow.spec.ts | カバー済み |
| E2E-004 | 承認フロー | 必須 | approval.spec.ts | カバー済み |
| E2E-002 | SSO ログイン | 必須 | — | 未実装（機能未実装） |
| E2E-005 | 却下フロー | 必須 | — | 未実装 |
| E2E-006 | 差し戻し | 必須 | — | 未実装 |
| E2E-007 | ファイルアップロード | 必須 | — | 未実装（機能未実装） |
| E2E-008 | 検索 | 推奨 | — | 未実装（機能未実装） |
| E2E-009 | ユーザー管理 | 推奨 | — | 未実装 |
| E2E-010 | ワークフローデザイナー | 推奨 | — | 未実装（機能未実装） |

ダッシュボード表示テスト（`dashboard.spec.ts`）は要件定義のシナリオ外だが、カバー済みテストとして別途記載する。

## Phase 4: `.claude/rules/e2e-test.md`

### 確認事項
- パターン: `.claude/rules/api-test.md` の構成を踏襲（paths ヘッダー、方針、必須チェック、AI 指示、禁止事項）
- パターン: ADR-032 の E2E テスト表現形式 → Given-When-Then

### 内容構成

```yaml
---
paths:
  - "tests/e2e/**"
---
```

1. **スコープ方針** — E2E はクリティカルパスに集中（5%）。API テストで検証済みの詳細はテストしない
2. **テストの書き方**
   - Given-When-Then コメントを使用
   - テスト名は日本語で test.describe / test 構造
   - ユニークな識別子（`Date.now()`）でテストデータを分離
3. **ロケーター戦略** — `getByRole` > `getByText` > `getByPlaceholder` > `locator`
4. **認証パターン** — storageState を再利用。新しいロールのテスト追加時は setup ファイルを拡張
5. **テストデータ管理** — シードデータに依存。テスト固有データは動的に作成
6. **必須チェック項目** — E2E テスト突合表の更新、CI 通過確認
7. **AI エージェントへの指示** — テスト追加時のワークフロー

## Phase 5: TDD 開発フローへの追記

### 確認事項
- パターン: `docs/04_手順書/04_開発フロー/02_TDD開発フロー.md` の既存構造
- 型: 変更履歴テーブルの形式

### 内容

TDD 開発フローの以下の箇所に E2E テストの位置づけを追記:

1. **ワークフロー全体像（L378-392）** — フローチャートの「統合テストで動作確認」の後に E2E テストの位置を追記
2. **チェックリスト（L396-404）** — E2E テストの項目を追加（「E2E テストが影響するシナリオを確認」）
3. **E2E テストの実行タイミング** — 新セクションを追加:
   - TDD サイクル内では実行しない（遅い）
   - Phase 完了後、`just check-all` の一部として実行される
   - UI に影響する変更を行った場合は `just test-e2e` で明示的に確認
4. **変更履歴** — エントリ追加

### 設計判断: E2E テストの TDD サイクルとの関係

E2E テストは TDD の Red-Green-Refactor サイクルには組み込まない。

理由:
- 実行時間が長い（バックエンド+フロントエンド起動が必要）
- TDD はユニットレベルの高速フィードバックが本質
- E2E は品質ゲート（`just check-all`）として機能する

位置づけ:
```
TDD サイクル（高速）→ Phase 完了 → 品質ゲート（E2E 含む）→ PR
```

## ブラッシュアップループの記録

| ループ | 検出したギャップ | 観点 | 対応 |
|-------|----------------|------|------|
| 1回目 | Playwright コミット `ffec66a` がブランチに含まれていない | 技術的前提 | Phase 0 としてブランチ同期（rebase）を追加 |
| 2回目 | 実装解説ドキュメント（`docs/07_実装解説/18_E2Eテスト/`）が #128 で既に作成済みで、ナレッジベースとの住み分けが必要 | 責務の明確さ | ナレッジベースはツールの汎用的な使い方、実装解説は PR 固有の設計判断と位置づけ。重複を避ける |
| 3回目 | ダッシュボードテスト（dashboard.spec.ts）が要件定義のシナリオ一覧にない | 不完全なパス | 突合表にシナリオ外のテストも記載するセクションを追加 |
| 4回目 | ADR の要否 — E2E テスト固有の設計判断は ADR が必要か | 既存手段の見落とし | ADR-032 で E2E の表現形式は定義済み、#128 の計画ファイルで設計判断は記録済み。新たな ADR は不要 |

## 収束確認（設計・計画）

| # | 観点 | 判定 | 確認内容 |
|---|------|------|---------|
| 1 | 網羅性 | OK | Issue の 5 タスクすべてに Phase が対応 |
| 2 | 曖昧さ排除 | OK | 各 Phase の成果物と内容構成が具体的 |
| 3 | 設計判断の完結性 | OK | E2E テストの TDD サイクルとの関係、ナレッジベースと実装解説の住み分けを明記 |
| 4 | スコープ境界 | OK | 対象（ドキュメント 5 件）と対象外（コード変更なし）を明記 |
| 5 | 技術的前提 | OK | ブランチ同期の必要性を確認。Playwright コードは main にマージ済み |
| 6 | 既存ドキュメント整合 | OK | CORE-12（テスト戦略）、ADR-032（テスト設計方針）、既存の hurl.md・api-test.md パターンと整合 |

## 検証方法

ドキュメントのみの変更のため、コード実行による検証は不要。以下を確認:

1. 全ファイルの Markdown 構文が正しいこと
2. リンク先が存在すること
3. 既存ドキュメントとの整合性
4. `just check-all` が通ること（lint + test）
