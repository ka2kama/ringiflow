# コンテキスト圧縮リファクタリング計画

## Context

CLAUDE.md + 常時ロード rules ファイル (paths フロントマターなし) が計 ~75.5K bytes のコンテキストを常時占有している。これを圧縮してコンテキストウィンドウの利用効率を改善する。

**制約**: デグレ不可。すべてのルール・禁止事項・プロセス・挙動を保持する。

## 現状（常時ロードファイル）

| ファイル | サイズ (bytes) | 行数 | 割合 |
|---------|---------------|------|------|
| CLAUDE.md | 33,645 | 713 | 45% |
| zoom-rhythm.md | 25,996 | 436 | 34% |
| problem-solving.md | 5,439 | 128 | 7% |
| pre-implementation.md | 4,644 | 94 | 6% |
| troubleshooting.md | 2,483 | 53 | 3% |
| long-running-commands.md | 1,795 | 35 | 2% |
| MEMORY.md | ~1,550 | 31 | 2% |
| **計** | **~75,552** | **1,490** | **100%** |

条件付きロード (paths あり) の 17 ファイル (~75K bytes) は対象外。スキル (7 ファイル, ~73K bytes) はオンデマンドのため対象外。

## 戦略

2 つの手法を組み合わせる:

### 手法 1: 非ルール要素の除去・冗長記述の圧縮

ルール（禁止事項、指示、チェックリスト、テンプレート、プロセス）はすべて保持し、以下を除去・圧縮する:

| 除去対象 | 理由 |
|---------|------|
| Mermaid 図 | LLM はテキスト記述で十分理解できる |
| 「改善の経緯」リンク | 歴史的参照。元ドキュメント (prompts/improvements/) は残る |
| 「既知手法との関連」「参照」セクション | 末尾の相互参照リスト。ルール実行に不要 |
| 冗長な説明・例示 | ルールが明示されていれば詳細説明は不要 |

### 手法 2: CLAUDE.md から条件付き rules への抽出

CLAUDE.md は常時ロードされるため、特定コンテキストでのみ必要な内容を条件付き rules ファイルに移す:

- **既存 rules が存在するポインタセクション**: CLAUDE.md から除去（rules が paths マッチで自動ロードされるため不要）
- **対応 rules がない必須対応セクション**: 既存の近い rules ファイルに統合、または新規条件付き rules を作成

## Phase 計画

### Phase 1: CLAUDE.md 圧縮（最大効果）

目標: 713 行 → ~430 行 (~40% 削減)

#### 1a. 条件付き rules ポインタの除去（~46 行削減）

以下のセクションは対応する条件付き rules ファイルが paths マッチで自動ロードされるため、CLAUDE.md のポインタは不要:

| 除去するセクション | 対応 rules ファイル |
|-------------------|-------------------|
| 構造品質の維持 | structural-review.md |
| データストア追加時の必須対応 | data-store.md |
| リポジトリ実装時の必須対応 | repository.md |
| API 実装時の必須対応 | api.md |
| ドキュメント規約 | docs.md |

#### 1b. 必須対応セクションの条件付き rules 抽出（~47 行削減）

CLAUDE.md にのみ存在するルールを条件付き rules に移動:

| セクション | 統合先 | 理由 |
|-----------|--------|------|
| エンティティ追加・更新パス追加時 | repository.md に追記 | リポジトリ/エンティティ操作時に同時ロード |
| 開発ツール追加時 | scripts.md に追記 | justfile 等の編集時に同時ロード |
| CI ワークフロー変更時 | scripts.md に追記 | ワークフロー編集時に同時ロード |
| アーキテクチャ構成変更時 | structural-review.md に追記 | バックエンド構造変更時に同時ロード |

#### 1c. 冗長記述の圧縮（~138 行削減）

| セクション | 現状 | 圧縮方針 | 目標 |
|-----------|------|---------|------|
| プロジェクト理念 | ~106 行 | 品質テーブル統合、Validation/Verification 圧縮、YAGNI/KISS 判断基準をインライン化 | ~65 行 |
| 開発コマンド | ~70 行 | 個別起動コマンドをテーブル化、理由説明を 1 行に | ~45 行 |
| ドキュメント体系 | ~70 行 | 参照テーブル圧縮、自動作成ルールの説明簡潔化 | ~40 行 |
| 学習支援 | ~54 行 | 解説ガイドライン統合、Insight ブロック例を省略 | ~30 行 |
| Git 操作ルール | ~116 行 | PR 完了フロー圧縮、コミット動詞テーブル省略、改善経緯リンク除去 | ~70 行 |
| 運用サイクル | ~25 行 | Mermaid 図除去 | ~15 行 |
| PR レビュー | ~19 行 | テーブル圧縮 | ~12 行 |

### Phase 2: zoom-rhythm.md 圧縮（2 番目の効果）

目標: 436 行 → ~280 行 (~36% 削減)

| 圧縮内容 | 削減 |
|---------|------|
| Mermaid 図 3 個除去（フロー図は等価なテキスト記述に置換） | ~20 行 |
| 「改善の経緯」リンク全除去 | ~15 行 |
| 「既知手法との関連」セクション除去 | ~5 行 |
| 「参照」セクション（ファイル末尾）除去 | ~15 行 |
| ギャップ発見の観点テーブル圧縮（列統合） | ~15 行 |
| 設計ブラッシュアップループの説明圧縮 | ~20 行 |
| To-Be の確定と更新セクション圧縮 | ~15 行 |
| 収束確認チェックリストの冗長ヘッダ圧縮 | ~15 行 |
| テンプレート例の圧縮 | ~15 行 |
| その他説明の圧縮 | ~21 行 |

### Phase 3: 他の常時ロード rules 圧縮

| ファイル | 現状 | 圧縮方針 | 目標 |
|---------|------|---------|------|
| problem-solving.md | 128 行 | 改善経緯リンク除去、Issue 精査フォーマット圧縮 | ~95 行 |
| pre-implementation.md | 94 行 | 改善経緯リンク除去、例示圧縮 | ~70 行 |
| troubleshooting.md | 53 行 | 改善経緯リンク除去 | ~43 行 |
| long-running-commands.md | 35 行 | 改善経緯リンク除去 | ~30 行 |

### Phase 4: MEMORY.md 重複排除

CLAUDE.md・rules と重複する項目を除去:
- 「PR 作成時の注意」→ CLAUDE.md Git 操作ルールと重複
- 「問題解決フレームワークの Want」→ problem-solving.md と重複

## 対象ファイル

変更:
- `CLAUDE.md`
- `.claude/rules/zoom-rhythm.md`
- `.claude/rules/problem-solving.md`
- `.claude/rules/pre-implementation.md`
- `.claude/rules/troubleshooting.md`
- `.claude/rules/long-running-commands.md`
- MEMORY.md

Phase 1b で追記:
- `.claude/rules/repository.md` (エンティティ追加ルール追記)
- `.claude/rules/scripts.md` (開発ツール追加・CI 変更ルール追記)
- `.claude/rules/structural-review.md` (アーキテクチャ構成変更ルール追記)

## 期待される結果

| ファイル | Before | After (推定) | 削減率 |
|---------|--------|-------------|--------|
| CLAUDE.md | 33,645 | ~21,000 | 38% |
| zoom-rhythm.md | 25,996 | ~17,000 | 35% |
| problem-solving.md | 5,439 | ~4,000 | 26% |
| pre-implementation.md | 4,644 | ~3,500 | 25% |
| troubleshooting.md | 2,483 | ~2,100 | 15% |
| long-running-commands.md | 1,795 | ~1,500 | 16% |
| MEMORY.md | ~1,550 | ~1,200 | 23% |
| **常時ロード計** | **~75,552** | **~50,300** | **33%** |

注: Phase 1b で条件付き rules に移した内容は、対象ファイル操作時にのみロードされる。常時ロードからは除外される。

## デグレ防止チェックリスト

各 Phase 完了時に確認:

- [ ] すべての「禁止:」「**禁止:**」「**禁止事項:**」が保持されている
- [ ] すべての「AI エージェントへの指示」が保持されている
- [ ] すべてのチェックリスト（収束確認、品質ゲート）が保持されている
- [ ] すべてのテンプレート（計画ファイル、PR 本文）が保持されている
- [ ] すべてのプロセスステップ（PR 完了フロー等）が保持されている
- [ ] すべての設計原則が保持されている
- [ ] すべての「→ 詳細:」リンクが有効である
- [ ] rules ファイルから CLAUDE.md への参照が有効である

## 検証方法

1. 各ファイルの before/after diff で、ルール・禁止事項・指示の欠落がないことを確認
2. 条件付き rules に抽出した内容が、対応する paths で正しくマッチすることを確認
3. CLAUDE.md・rules ファイル間の相互参照が有効であることを確認
