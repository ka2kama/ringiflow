# 計画: TDD テストと品質保証テストの区別を TDD フローに反映する (#279)

## Context

TDD で書くテストは「設計発見のためのフィードバックループ」であり、最終成果物として残すべき「品質保証テスト」とは性質が異なる。しかし現在の TDD フロードキュメントではこの区別が明示されておらず、TDD の副産物（仮実装テスト、三角測量の冗長テスト等）がそのまま最終テストとして残るリスクがある。

**Want**: 品質の追求 — TDD で書いたテストが最終成果物として品質を担保できていること

## 変更対象ファイルと変更概要

| ファイル | 変更 |
|---------|------|
| `docs/04_手順書/04_開発フロー/02_TDD開発フロー.md` | 3箇所の変更（主要） |
| `docs/04_手順書/04_開発フロー/01_Issue駆動開発.md` | テスト項目に1行追加 |
| `.claude/rules/zoom-rhythm.md` | テストフェーズに1行追加 |

### 対象外

- ワークフロー全体像の Mermaid 図（266-279行目）: テストレビューは TDD サイクルの外のアクションであり、図に追加すると複雑になるが得るものが少ない
- チェックリストセクション（283-291行目）: 最終チェックリストであり、テストレビューの詳細を記載する場所ではない

---

## 変更1: Refactor ステップにテストのリファクタリングを明記

**場所:** `02_TDD開発フロー.md` 72-79行目

現状はプロダクションコードの改善のみ。テストコード自体の改善を明記する。

**変更後:**

```markdown
### 🔵 Refactor: きれいにする

**目的:** 動作を変えずにコードを改善する

プロダクションコード:
1. 重複を除去
2. 命名を改善
3. 構造を整理

テストコード:
1. テストの意図が名前から読み取れるか確認
2. 三角測量で追加したテストの中に、一般化後は冗長になったものがないか確認
3. Arrange / Act / Assert の構造が明確か確認

**テストが通り続けることを確認しながら** 進める。
```

## 変更2: テストリストの二面性を明記

**場所:** `02_TDD開発フロー.md` 99-101行目

**変更後:**

```markdown
## テストリスト

実装前にテストリスト（TODO リスト）を作成する。

テストリストには二つの役割がある:

| 段階 | 役割 | 性質 |
|------|------|------|
| TDD サイクル中 | 実装の道標 | 思いついた順に追加してよい。仮実装や三角測量のためのテストも含む |
| Phase 完了時 | 仕様の文書化 | 正常系・異常系・境界値が体系的に整理され、各テストが独立した仕様を表現している |

TDD サイクル中はリストを自由に使い、Phase 完了時に品質保証の観点で整理する（後述の「テストレビュー」を参照）。
```

## 変更3: Phase 完了時のテストレビューを追加

**場所:** `02_TDD開発フロー.md` 193行目（「各ステップで〜繰り返す。」）の後、`---` の前

「MVP 積み上げ方式」セクション内に配置。Phase 完了時のアクションとして自然に読める位置。

**追加内容:**

```markdown
### テストレビュー（Phase 完了時）

各 Phase の TDD サイクル完了後、テストを品質保証の観点でレビューする。

確認観点:

| 観点 | 確認内容 |
|------|---------|
| 冗長性 | 三角測量や仮実装で追加したテストの中に、本実装後は同じことを検証しているものがないか |
| 網羅性 | 正常系・異常系・境界値が体系的に網羅されているか。TDD では思いついた順に書くため、抜けがないか確認 |
| 明確さ | 各テストが「何の仕様を検証しているか」をテスト名から読み取れるか |
| 構造 | テストの並び順が仕様として読みやすいか（正常系 → 異常系 → 境界値） |

TDD サイクル中の Refactor はテストの局所的な改善。テストレビューは Phase 全体を俯瞰した整理。
```

Refactor ステップとテストレビューの役割の違い:

| | Refactor ステップ | テストレビュー |
|---|-----------------|--------------|
| タイミング | TDD サイクルごと | Phase 完了時 |
| スコープ | 直前に書いたテスト（局所） | Phase 全体のテスト（俯瞰） |
| zoom-rhythm | 局所作業 | 俯瞰 |

## 変更4: 品質チェックリストにテスト品質項目を追加

**場所:** `01_Issue駆動開発.md` 376行目の後

**追加:**

```markdown
- [ ] テストレビュー済みか（冗長なテストの統合、テスト名の明確さ、構造の整理）
```

## 変更5: zoom-rhythm.md テストフェーズに追加

**場所:** `.claude/rules/zoom-rhythm.md` 255行目の後

**追加:**

```markdown
| 5 | テスト品質 | 各テストが独立した仕様を表現し、冗長なテストがない | TDD 開発フローのテストレビュー |
```

## 変更6: 変更履歴の更新

**場所:** `02_TDD開発フロー.md` の変更履歴テーブル

## 検証方法

- 変更後のドキュメントを通読し、論理的な一貫性を確認
- TDD フロー → 品質チェックリスト → zoom-rhythm.md の参照チェーンが整合していることを確認

---

## ブラッシュアップループの記録

| ループ | きっかけ | 調査内容 | 結果 |
|-------|---------|---------|------|
| 1回目 | 初版完成 → テストレビューの配置場所検討 | TDD フロードキュメントの全構造を確認 | 「MVP 積み上げ方式」セクション内に配置。独立セクションは過剰 |
| 2回目 | ワークフロー図への影響確認 | Mermaid 図（266-279行目）を確認 | 図への追加は複雑化のみ。テキストで十分 |
| 3回目 | 品質チェックリストとの重複確認 | 01_Issue駆動開発.md と zoom-rhythm.md の関係を確認 | 両方に1行ずつ追加が既存パターンに合致 |

## 収束確認（設計・計画）

| # | 観点 | 判定 | 確認内容 |
|---|------|------|---------|
| 1 | 網羅性 | OK | Issue の3検討方向すべてを網羅: (1) Refactor→変更1, (2) テストレビュー→変更3, (3) 二面性→変更2。関連ファイルへの波及も含む |
| 2 | 曖昧さ排除 | OK | 各変更に行番号・現状・変更後を明記 |
| 3 | 設計判断の完結性 | OK | 各変更に配置理由と代替案の検討を記載 |
| 4 | スコープ境界 | OK | 対象: 3ファイル5箇所。対象外: ワークフロー図、チェックリストセクション |
| 5 | 技術的前提 | OK | docs.md 規約（Mermaid、太字の使用基準）を確認済み |
| 6 | 既存ドキュメント整合 | OK | zoom-rhythm.md の「局所 vs 俯瞰」の思想と整合 |
