# 計画: #566 改善記録テンプレートのバリデーション

## Context

レトロスペクティブ（2026-02-16）で 16 件中 3 件の改善記録が非標準フォーマットで記載されていた。
README に照合手順は存在するが、自動検証がないため遵守が保証されていない。
対策形式の観点から、フロー組み込み（自動バリデーション）が最も効果的。

## 対象

- `scripts/check-improvement-records.sh` — 新規作成
- `justfile` — `lint-improvements` タスク追加
- `scripts/check-parallel.sh` — Non-Rust レーンに追加
- `prompts/improvements/2026-02/` — 非標準記録 3 件の修正
- `prompts/improvements/2026-02/2026-02-11_2200_Epic単位PRによるサブIssueクローズ漏れ.md` — 不正カテゴリ値の修正

## 対象外

- `問題の性質` フィールドの既存記録への遡及追加（69 件。別 Issue で対応すべき規模）
- lefthook pre-commit への統合（`just check` で十分。pre-commit は軽量チェックに限定する既存方針）
- README の大幅な書き換え（現在の照合手順は十分明確）

## 設計判断

### バリデーション対象フィールド

| フィールド | チェック | 理由 |
|-----------|--------|------|
| `## 分類` セクション | エラー（必須） | 全記録に必要 |
| `- カテゴリ:` | エラー（必須 + 値検証） | 初期から必須フィールド |
| `- 失敗タイプ:` | エラー（必須 + 値検証） | 初期から必須フィールド |
| `- 問題の性質:` | 警告のみ | 2026-02-15 に導入。69 件が未対応。遡及は別 Issue |

### `just check` への統合（`just lint` ではなく）

`lint` はコードフォーマッタ・静的解析ツールの集約。改善記録のバリデーションは「構造品質チェック」に近い（`check-file-size`, `check-duplicates` と同カテゴリ）。
→ `just lint-improvements` として定義し、`check-parallel.sh` の Non-Rust レーンに追加。

### 値の括弧付き補足の扱い

既存記録には `- カテゴリ: 知識-実行乖離（検証の仕組みは設計済みだったが...）` のように値の後に括弧付き補足がある。
→ 値抽出時に `（` または `(` 以降を除去してから照合。

## Phase 1: バリデーションスクリプト作成

### 確認事項
- [x] 既存スクリプトパターン → `check-rule-files.sh`（エラー配列 + exit 1）、`check-file-size.sh`（警告 + exit 0）
- [x] ShellCheck 対応 → `just lint-shell` で `scripts/*.sh` が対象。`set -euo pipefail`、配列操作は bash 4+ で OK
- [x] 有効値リスト → README L152-183（カテゴリ 6 種、失敗タイプ 3 種、問題の性質 3 種）

### 作業
1. `scripts/check-improvement-records.sh` を作成
   - `prompts/improvements/????-??/*.md` を走査（README.md を除外）
   - `## 分類` セクションの存在チェック
   - `- カテゴリ:` の存在 + 値検証（6 種）
   - `- 失敗タイプ:` の存在 + 値検証（3 種）
   - `- 問題の性質:` は存在チェックのみ（警告、非ブロック）
   - エラーがあれば exit 1、警告のみなら exit 0

### テストリスト

ユニットテスト（該当なし — シェルスクリプト）

ハンドラテスト（該当なし）

API テスト（該当なし）

E2E テスト（該当なし）

手動検証:
- [ ] スクリプト単体実行で非標準記録がエラーとして検出される
- [ ] 修正後にスクリプトがエラーゼロで通過する
- [ ] ShellCheck（`just lint-shell`）をパスする

## Phase 2: 非標準記録の修正

### 確認事項
- [x] 非標準記録 3 件のフォーマット → 確認済み（`**カテゴリ**:` 形式、`## 分類` セクション欠如）
- [x] 不正カテゴリ値 → `2026-02-11_2200` の `プロセスギャップ`（失敗タイプの値をカテゴリに使用）

### 作業

#### 2-1. `2026-02-14_2115_Issue精査時のAs-Is確認不足.md`

現状: ファイル先頭に `**カテゴリ**: プロセス（問題解決フレームワーク）`、`## 分類` セクションなし

修正:
- 先頭の `**カテゴリ**: プロセス（問題解決フレームワーク）` を削除
- 末尾（`## 関連` の前）に `## 分類` セクションを追加
- カテゴリ: 即座の対策（Issue 本文の As-Is を検証せずにそのまま使用した）
- 失敗タイプ: 実行ギャップ（問題解決フレームワークは存在したが As-Is 検証を実行しなかった）
- 問題の性質: プロセス的

#### 2-2. `2026-02-14_2130_Test-planチェックボックスの形骸化.md`

現状: ファイル先頭に `**カテゴリ**: プロセス（品質ゲート）`、`## 分類` セクションなし

修正:
- 先頭の `**カテゴリ**: プロセス（品質ゲート）` を削除
- 末尾（`## 関連` の前）に `## 分類` セクションを追加
- カテゴリ: 知識-実行乖離（検証せずにチェックを入れた — 手順は存在したが実行しなかった）
- 失敗タイプ: 実行ギャップ
- 問題の性質: プロセス的

#### 2-3. `2026-02-15_1137_無関係の問題をスルーする傾向.md`

現状: `## 分類` セクションの内容が非標準（`**カテゴリ**: プロセス・ルール`、`**影響範囲**`、`**再発防止**`）

修正:
- 既存の `## 分類` セクション内容を標準フォーマットに置換
- カテゴリ: 即座の対策（「CI が通っているから OK」と即座に判断し、Issue 化を回避した）
- 失敗タイプ: プロセスギャップ（問題発見時の対応プロセスが未定義だった）
- 問題の性質: プロセス的

#### 2-4. `2026-02-11_2200_Epic単位PRによるサブIssueクローズ漏れ.md`

現状: `- カテゴリ: プロセスギャップ（手順書の想定と実際のプラクティスの乖離）` — 失敗タイプの値をカテゴリに使用

修正:
- カテゴリ: 視点不足（Epic/Story の PR 運用における副作用を見落とした）

### テストリスト

手動検証:
- [ ] 修正後のファイルがバリデーションスクリプトをパスする
- [ ] カテゴリ・失敗タイプの値が README の定義済み値と一致する

## Phase 3: `just check` への統合

### 確認事項
- [x] justfile パターン → `check-file-size:` は `./scripts/check-file-size.sh` を直接呼び出し
- [x] check-parallel.sh → Non-Rust レーンに `just lint-improvements` を追加

### 作業
1. `justfile` に `lint-improvements` タスクを追加（`check-file-size` の近くに配置）
2. `scripts/check-parallel.sh` の Non-Rust レーンに `just lint-improvements` を追加

### テストリスト

手動検証:
- [ ] `just lint-improvements` が単体で動作する
- [ ] `just check` 実行時に Non-Rust レーンで改善記録バリデーションが実行される

## ブラッシュアップループの記録

| ループ | 検出したギャップ | 観点 | 対応 |
|-------|----------------|------|------|
| 1回目 | `問題の性質` が 71 件中 2 件にしか存在しない | 不完全なパス | エラーではなく警告に変更。遡及追加は別 Issue として対象外に明記 |
| 2回目 | `カテゴリ: プロセスギャップ` という不正値の記録が存在 | 競合・エッジケース | Phase 2 に修正対象として追加（2-4） |

## 収束確認（設計・計画）

| # | 観点 | 判定 | 確認内容 |
|---|------|------|---------|
| 1 | 網羅性 | OK | 非標準記録 3 件 + 不正値 1 件を特定。バリデーション対象フィールド 3 種を定義 |
| 2 | 曖昧さ排除 | OK | 各修正の具体的なカテゴリ値・失敗タイプ値を明記 |
| 3 | 設計判断の完結性 | OK | `問題の性質` の扱い、統合先（lint vs check）、括弧補足の扱いを判断・記載 |
| 4 | スコープ境界 | OK | 対象外セクションで `問題の性質` 遡及追加、lefthook 統合を明示的に除外 |
| 5 | 技術的前提 | OK | ShellCheck 対応、bash 配列操作、grep の日本語処理を確認 |
| 6 | 既存ドキュメント整合 | OK | README の照合手順（L173-186）と一致。ADR 不要（既存パターンの踏襲） |
