# #618 main ブランチへの直接コミット提案の再発防止

## Context

AI エージェントがドキュメントのみの変更時に「main で直接コミットしてよいか？」と繰り返し確認する問題が発生。CLAUDE.md L373 に禁止ルールがあるが、例外を推測する余地がある。ソフトコントロール（ルール明確化）とハードコントロール（技術的強制）の両面で対策する。

## 対象

- `CLAUDE.md` L371-374: 禁止事項の補足追加
- `lefthook.yaml` L5-24: pre-commit コマンド追加

## 対象外

- ナレッジベース（lefthook.md）の更新: 既存の内容で十分。新規フックの解説は PR の実装解説で対応
- GitHub のブランチ保護ルール: CI/CD 側の対策はこの Issue のスコープ外

## Phase 1: CLAUDE.md の禁止事項補足

### 確認事項
- [x] 現在の記述: CLAUDE.md L371-374 — `**禁止:** main ブランチで直接作業・コミット`。「例外なし」の記述がないことを確認済み

### 変更内容

`CLAUDE.md` L373 を修正:

```markdown
# Before
- main ブランチで直接作業・コミット

# After
- main ブランチで直接作業・コミット（変更の種類によらず例外なし。ドキュメントのみの変更でもブランチを作成する）
```

### テストリスト

ユニットテスト（該当なし）
ハンドラテスト（該当なし）
API テスト（該当なし）
E2E テスト（該当なし）

検証: 文言の明確さを目視確認

## Phase 2: lefthook の pre-commit フック追加

### 確認事項
- [x] lefthook.yaml の構造: pre-commit セクションに `parallel: true` で 3 コマンド（no-yml-extension, rustfmt-check, elm-format-check）
- [x] 既存パターン: `no-yml-extension` が inline run スクリプトで、`git diff --cached` + 条件チェック + `exit 1` のパターン
- [x] `git symbolic-ref --short HEAD`: ブランチ名取得の標準的な方法。detached HEAD 時はエラーを返す（`2>/dev/null` で抑制）

### 変更内容

`lefthook.yaml` の pre-commit セクションに `no-main-commit` コマンドを追加:

```yaml
    no-main-commit:
      # main ブランチへの直接コミットを禁止
      run: |
        BRANCH=$(git symbolic-ref --short HEAD 2>/dev/null)
        if [ "$BRANCH" = "main" ]; then
          echo "Error: main ブランチへの直接コミットは禁止されています。ブランチを作成してください。"
          exit 1
        fi
```

設計判断:
- インラインスクリプト（`.lefthook/` にファイルを作成しない）: `no-yml-extension` と同様のシンプルなチェックで、スクリプトファイルに分離する複雑さがない
- detached HEAD（`git symbolic-ref` がエラー）の場合: `2>/dev/null` で空文字になり、`main` と一致しないためパスする。rebase 中等の正当な操作を妨げない

### テストリスト

ユニットテスト（該当なし）
ハンドラテスト（該当なし）
API テスト（該当なし）
E2E テスト（該当なし）

手動検証:
- [ ] main ブランチでコミットが拒否されることを確認
- [ ] feature ブランチでコミットが通ることを確認

## ブラッシュアップループの記録

| ループ | 検出したギャップ | 観点 | 対応 |
|-------|----------------|------|------|
| 1回目 | detached HEAD 時の挙動が未定義 | 不完全なパス | `2>/dev/null` で空文字 → main と不一致 → パスする。rebase 中等の正当な操作を妨げない旨を明記 |

## 収束確認（設計・計画）

| # | 観点 | 理想状態（To-Be） | 判定 | 確認内容 |
|---|------|------------------|------|---------|
| 1 | 網羅性 | Issue の対策案 2 項目がすべて計画に含まれている | OK | CLAUDE.md 補足 + lefthook フック、両方を Phase に対応付け |
| 2 | 曖昧さ排除 | 不確定な記述がゼロ | OK | 変更箇所・変更内容が具体的に記載されている |
| 3 | 設計判断の完結性 | 全ての差異に判断が記載されている | OK | インラインスクリプト vs ファイル分離の判断を記載 |
| 4 | スコープ境界 | 対象と対象外が両方明記されている | OK | 対象外セクションでナレッジベース更新・ブランチ保護を除外 |
| 5 | 技術的前提 | コードに現れない前提が考慮されている | OK | detached HEAD、`--no-verify` でのスキップ可能性を考慮 |
| 6 | 既存ドキュメント整合 | 既存ドキュメントと矛盾がない | OK | CLAUDE.md の既存禁止事項の補足であり、矛盾なし |
