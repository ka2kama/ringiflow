# 計画: #891 設計原則レンズの検証項目見直し

## Context

設計原則レンズ（TDD Refactor ステップで設計品質を評価する仕組み）のレンズ間の具体性にばらつきがある。具体的な検証行動まで指定されているレンズ（重複の排除: Grep で照合）と、問いが一般的で行動に繋がりにくいレンズ（意図の明確さ、SRP、DIP）が混在している。また、品質チェックリスト（6.2）との「String/整数の濫用」の重複と、既知手法の欠落がある。

背景: この Issue は ISO 25010 に基づく品質追求（理念2）の Want への適合見直しの一環。本 Issue のスコープはレンズの具体性・型関連の重複・既知手法に限定するが、品質チェックリスト全体と ISO 25010 品質特性の対応見直しは将来の Issue 候補として認識しておく。

## 設計判断

### 問い + 手がかりの構造

Issue の備考: 「具体性を高めすぎるとチェックリスト化して形骸化するリスクがある」

**採用**: 2列テーブル（レンズ | 問い）を維持し、問い列に手がかりを含める。理由: 既存の「重複の排除」レンズが既にこのパターン（問い + Grep 照合アクション）を使っている。3列テーブル（問い | 手がかり）は Markdown で横幅過大。

**不採用**: 3列テーブル（レンズ | 問い | 手がかり）。理由: 「手がかり」列の長文が Markdown テーブルの可読性を下げ、既存パターンとも不整合。

### マイナス→ゼロ / ゼロ→プラス の役割分担

- マイナス→ゼロ = 既存パターンへの準拠確認（既に確立されたパターンに違反している = 欠陥）
- ゼロ→プラス = 新しい改善機会の発見（まだ適用されていないが、適用すると品質向上）

## 対象ファイル

| ファイル | 変更内容 |
|---------|---------|
| `docs/60_手順書/04_開発フロー/02_TDD開発フロー.md` | 設計原則レンズの問い改善、既知手法テーブル追記、変更履歴 |
| `docs/60_手順書/04_開発フロー/01_Issue駆動開発.md` | 品質チェックリスト L471, L486 の役割分担明確化 |
| `docs/80_ナレッジベース/methodology/独自フレームワークと既知手法の対応.md` | コード設計レンズの新セクション、mermaid 図、リソース、変更履歴 |

## Phase 1: 設計原則レンズの問い改善（TDD開発フロー.md）

### 確認事項: なし（対象ファイルは既読済み）

### 操作パス: 該当なし（操作パスが存在しない）

### 変更 1-1: 毎 Refactor テーブル（L196-202）

「意図の明確さ」に手がかりを追加。「重複の排除」「要素の最小性」は既に具体的なため軽微な調整のみ。

変更前:
```
| 意図の明確さ | このコードの意図は読み手に伝わるか？ |
```

変更後:
```
| 意図の明確さ | このコードの意図は読み手に伝わるか？ 手がかり: 関数名が「何をするか」を伝えているか / 変数名が計算の意味を表しているか / コメントが必要なら命名やヘルパー関数で解決できないか |
```

### 変更 1-2: モジュール/関数完成時テーブル（L204-210）

SRP にレイヤー別の変更理由、DIP にプロジェクトのレイヤー構造、型の活用に ADR-051・境界型変換・不変条件を追加。

変更前（SRP）:
```
| 単一責務（SRP） | この関数/モジュールに変更理由は1つだけか？ |
```

変更後:
```
| 単一責務（SRP） | この関数/モジュールに変更理由は1つだけか？ 手がかり: レイヤー別の変更理由 — Handler: API 契約変更、UseCase: ビジネスルール変更、Repository: DB スキーマ/クエリ変更、Domain Entity: ドメインモデル変更。複数のレイヤーの変更理由が混在していたら分離の兆候 |
```

変更前（DIP）:
```
| 依存方向（DIP） | 依存の方向は正しいか？詳細が抽象に依存しているか？ |
```

変更後:
```
| 依存方向（DIP） | 依存の方向は正しいか？ 手がかり: `apps → domain → shared`, `apps → infra → shared` に違反する import がないか / domain が infra の具体型（`PgPool` 等）に依存していないか / 新しい外部依存は trait で抽象化し `Arc<dyn Trait>` で注入しているか |
```

変更前（型の活用）:
```
| 型の活用 | 型で防げる不正状態を String や整数で済ませていないか？（ADR-016） 状態によって有効なフィールドが異なるのにフラットな型にしていないか？（ADR-054） |
```

変更後:
```
| 型の活用 | 不正な状態や操作を型で防げていないか？ Newtype: プリミティブ型の取り違え防止（[ADR-016]）/ 型安全ステートマシン: 状態依存フィールドの分離（[ADR-054]）/ 構造的強制: 引数の型でルール遵守を強制（[ADR-051]）/ 境界での型変換: 外部入力を未検証のまま内部で持ち回していないか / 不変条件の保護: `new()` で検証される不変条件が公開フィールドで壊されないか |
```

### 変更 1-3: レンズと品質チェックリストの関係説明（L214）

変更前:
```
Refactor で作り込み、品質チェックリストで最終確認する。
```

変更後:
```
レンズは Refactor ステップで設計品質を作り込むためのもの。品質チェックリストは PR 全体を通した最終確認であり、レンズで見逃した問題を捕捉する最後の砦。
```

### 変更 1-4: 既知手法の一行参照（L216）

変更前:
```
既知手法との対応: 「毎 Refactor」は Kent Beck の Simple Design rules、「モジュール完成時」は SOLID 原則の SRP・DIP に対応。
```

変更後:
```
既知手法との対応: 「毎 Refactor」は Kent Beck の Four Rules of Simple Design（Reveals intention → No duplication → Fewest elements）、「モジュール完成時」は SOLID 原則の SRP・DIP および型による不正状態防止（"Making Illegal States Unrepresentable" — Minsky, 2011; "Parse, don't validate" — King, 2019）に対応。
```

### 変更 1-5: 既知手法テーブルに追記（L685-692）

先頭に 4 行追加（コード設計レンズ対応）:

```markdown
| Four Rules of Simple Design | Kent Beck, *Extreme Programming Explained* (2000) | 毎 Refactor レンズ（意図の明確さ・重複の排除・要素の最小性） |
| SRP・DIP（SOLID 原則） | Robert C. Martin, *Agile Software Development* (2003) | モジュール完成時レンズ（単一責務・依存方向） |
| Making Illegal States Unrepresentable | Yaron Minsky, *Effective ML* (2011); Richard Feldman, *Elm Conf* (2016) | 型の活用レンズ（Newtype、型安全ステートマシン、構造的強制） |
| Parse, don't validate | Alexis King (2019) | 型の活用レンズ（境界での型変換、不変条件の保護） |
```

### 変更 1-6: 参考資料に追記（L676-681 付近）

```markdown
- Kent Beck (2000) "Extreme Programming Explained" — Four Rules of Simple Design
- Robert C. Martin (2003) "Agile Software Development, Principles, Patterns, and Practices" — SOLID 原則
- Yaron Minsky (2011) "Effective ML" — Making Illegal States Unrepresentable
- Alexis King (2019) "Parse, don't validate"
```

### 変更 1-7: 変更履歴に追記

### テストリスト

ユニットテスト（該当なし）
ハンドラテスト（該当なし）
API テスト（該当なし）
E2E テスト（該当なし）

## Phase 2: 品質チェックリストの役割分担明確化（Issue駆動開発.md）

### 確認事項: なし（対象ファイルは既読済み）

### 操作パス: 該当なし（操作パスが存在しない）

### 変更 2-1: マイナス→ゼロの型安全性項目（L471）

変更前:
```
- [ ] 型安全性・エラーハンドリング: String/整数の濫用、安易な unwrap/expect がない
```

変更後:
```
- [ ] 型安全性・エラーハンドリング: 既存の Newtype（`UserId`, `Email`, `Version` 等）を使わず生の String/整数を使用していないか、安易な unwrap/expect がないか
```

### 変更 2-2: ゼロ→プラスの型の活用項目（L486）

変更前:
```
- [ ] 型の活用: 型で防げる不正状態を String や整数で済ませていないか
```

変更後:
```
- [ ] 型の活用: 新たに型で防げる不正状態がないか（未定義の Newtype 候補、状態依存フィールドの型安全ステートマシン化、引数の型による構造的強制の機会）
```

### 変更 2-3: 変更履歴に追記

### テストリスト

ユニットテスト（該当なし）
ハンドラテスト（該当なし）
API テスト（該当なし）
E2E テスト（該当なし）

## Phase 3: 既知手法との対応更新（独自フレームワークと既知手法の対応.md）

### 確認事項: なし（対象ファイルは既読済み）

### 操作パス: 該当なし（操作パスが存在しない）

### 変更 3-1: mermaid 図にコード設計レンズを追加（L11-58）

ringiflow サブグラフに追加:
```
DPL["設計原則レンズ（コード設計）<br/>問い + 手がかり"]
```

既知手法サブグラフに追加:
```
SD["Four Rules of Simple Design（Beck）"]
SOLID["SOLID 原則（Martin）"]
MISR["Making Illegal States<br/>Unrepresentable（Minsky）"]
PDV["Parse, don't validate（King）"]
```

矢印追加: `DPL --> SD`, `DPL --> SOLID`, `DPL --> MISR`, `DPL --> PDV`

### 変更 3-2: 新セクション「設計原則レンズ（コード設計）と既知手法」を L309 直前に挿入

以下の4つの既知手法とのマッピングを記載:
- **Four Rules of Simple Design** (Beck, 2000): 毎 Refactor の 3 レンズと 1:1 対応
- **SOLID 原則 SRP・DIP** (Martin, 2003): レイヤー別変更理由の具体化、レイヤー依存方向の明示
- **Making Illegal States Unrepresentable** (Minsky, 2011; Feldman, 2016): ADR-016/054/051 の3つの型活用パターン
- **Parse, don't validate** (King, 2019): 境界での型変換、不変条件の保護

ringiflow の独自性テーブルも追加（手がかり列、レイヤー接続、3 ADR の系統的適用）。

### 変更 3-3: 関連リソースに追記（L410-430 付近）

5 件追加:
- Beck, K. (2000) "Extreme Programming Explained"
- Rainsberger, J.B. (2013) "The Four Elements of Simple Design"
- Martin, R. C. (2003) "Agile Software Development, Principles, Patterns, and Practices"
- Minsky, Y. (2011) "Effective ML" (Making Illegal States Unrepresentable)
- King, A. (2019) "Parse, don't validate"

### 変更 3-4: 変更履歴に追記

### テストリスト

ユニットテスト（該当なし）
ハンドラテスト（該当なし）
API テスト（該当なし）
E2E テスト（該当なし）

## ブラッシュアップループの記録

| ループ | 検出したギャップ | 観点 | 対応 |
|-------|----------------|------|------|
| 1回目 | 品質チェックリスト L471 vs L486 の「String/整数の濫用」重複 | 競合 | マイナス→ゼロを「既存 Newtype 不使用」、ゼロ→プラスを「新たな型活用機会」と再定義 |
| 2回目 | 既知手法の対応.md にコード設計レンズのセクションが存在せず UI/UX のみがセクションを持つ | 非対称 | 新セクション追加で対称性確保 |
| 3回目 | ADR-051（構造的強制）が型の活用レンズに未接続 | 不完全なパス | 手がかりに追加 |
| 4回目 | 3列テーブル案は既存パターンと不整合、Markdown 可読性低下 | 既存手段の見落とし | 2列テーブル維持、問い列に手がかりを含める既存パターンに合わせる |

## 収束確認（設計・計画）

| # | 観点 | 判定 | 確認内容 |
|---|------|------|---------|
| 1 | 網羅性 | OK | 完了基準3点: (1) レンズの具体性→手がかり追加、(2) 役割分担→既存/新規で分離、(3) 既知手法→新セクション+テーブル |
| 2 | 曖昧さ排除 | OK | 全変更箇所に変更前/変更後を明示 |
| 3 | 設計判断の完結性 | OK | テーブル形式（2列 vs 3列）、マイナス→ゼロ/ゼロ→プラスの区分基準を記載 |
| 4 | スコープ境界 | OK | 対象: 3ファイル。対象外: コード変更なし、UI/UX レンズは変更なし（既に具体的） |
| 5 | 技術的前提 | OK | Markdown テーブルの横幅制約を考慮 |
| 6 | 既存ドキュメント整合 | OK | CLAUDE.md 設計原則、ADR-016/051/054、zoom-rhythm.md 二つの砦と整合 |

## 検証方法

```bash
just check-all  # lint + test が通ることを確認
```

ドキュメントのみの変更のため、自動テスト通過が品質ゲート。追加で、変更後の Markdown テーブルが正しくレンダリングされることを目視確認する。
