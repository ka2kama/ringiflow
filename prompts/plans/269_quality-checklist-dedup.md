# Issue #269: 品質チェックリストの重複整理

## Context

`zoom-rhythm.md` の実装フェーズチェックリスト（7項目）と `Issue駆動開発.md` 6.2 品質チェックリストに重複がある。どちらを参照すべきか曖昧で、保守時に不整合が生じるリスクがある。

## 責務境界の定義

| ファイル | 役割 | 含めるもの |
|---------|------|-----------|
| `zoom-rhythm.md` | 概念フレームワーク（Why + 背景） | 品質観点が必要な理由、出典（改善記録へのリンク）、俯瞰リズムの理論 |
| `Issue駆動開発.md` | 実用チェックリスト（What） | Ready for Review で確認すべき全項目（チェックボックス付き） |

原則: **実用チェックリストは Issue駆動開発.md に一元化**する。zoom-rhythm.md は「なぜこの観点が必要か」を説明し、具体的なチェック項目は Issue駆動開発.md を参照する。

### 選択理由

- Ready for Review は重要なゲート。確認項目が1ファイルに集約されていることで認知負荷を下げる
- zoom-rhythm.md はシステムプロンプトに含まれるため、観点の名前は常に見える。詳細な確認手順は Issue駆動開発.md を読めばよい
- 出典（改善記録リンク）は zoom-rhythm.md に残すことで、各観点の経緯を追跡可能にする

### 見送った選択肢

- **zoom-rhythm.md を正典とする案**: Ready 時に2ファイル行き来が必要で実用性が低い
- **両方に残して「再確認」と整理する案**: 重複が残り保守コストが変わらない

## 対象と対象外

対象:
- zoom-rhythm.md 実装フェーズチェックリスト（7項目）と Issue駆動開発.md 6.2 の重複解消
- zoom-rhythm.md テストフェーズチェックリスト（4項目）と Issue駆動開発.md 6.2 テスト項目の重複解消
- zoom-rhythm.md 横断検証フェーズチェックリスト（3項目）の Issue駆動開発.md 6.2 への統合
- 上記に伴う相互参照の整備

対象外:
- zoom-rhythm.md 設計・計画フェーズチェックリスト（6項目）: Issue駆動開発.md 4.4 と対応するが、重複していない（4.4 は zoom-rhythm.md を参照している）
- ギャップ発見の観点（設計ブラッシュアップループ内）: 設計段階の観点であり、実装/Ready for Review のチェックリストとは用途が異なる。同じ ゼロ→プラス 4項目が含まれるが、設計段階で使う指針として残す

## 変更対象ファイル

1. `.claude/rules/zoom-rhythm.md`
2. `docs/04_手順書/04_開発フロー/01_Issue駆動開発.md`
3. `.github/pull_request_template.md`

## 変更内容

### 1. zoom-rhythm.md

#### 1a. 実装フェーズセクション（行203-221）

現在の7項目テーブル（観点 + 理想状態 + 確認内容）を、**観点名 + 理想状態 + 出典** のテーブルに変更する。確認内容の詳細は Issue駆動開発.md に委譲。

変更後:

```markdown
### 実装フェーズ

TDD サイクルの Refactor ステップが往復のトリガー。各サイクルで視点を上げ、整合性を確認する。

**コミット前の必須確認**: 各 Phase のコミット前に、品質チェックリストの「コード品質確認」がすべて OK であることを確認する。確認せずにコミットしてはならない。

Phase 完了後にも改めて全体を通して検証する。

品質チェックリストの具体的な確認項目は [Issue駆動開発 > 品質チェックリスト](../../docs/04_手順書/04_開発フロー/01_Issue駆動開発.md#62-品質チェックリスト) を参照。

以下は、各観点が必要となった背景:

| # | 観点 | 理想状態（To-Be） | 出典 |
|---|------|------------------|------|
| 1 | アーキテクチャ一貫性 | レイヤー違反がゼロ | [YAGNI-KISS の拡大解釈](../../process/improvements/2026-02/2026-02-01_0004_YAGNI-KISSの拡大解釈による設計品質低下.md) |
| 2 | 既存パターン整合 | 既存コードと一貫している | 品質原則に基づく補完項目 |
| 3 | 型安全性・エラーハンドリング | 型で表現できるものは型で表現されている | [YAGNI-KISS の拡大解釈](../../process/improvements/2026-02/2026-02-01_0004_YAGNI-KISSの拡大解釈による設計品質低下.md) |
| 4 | 仕様突合 | OpenAPI 仕様と実装が一致している | [OpenAPI 仕様突合漏れ](../../process/improvements/2026-01/2026-01-29_1445_Phase5実装時のOpenAPI仕様突合漏れ.md) |
| 5 | レイヤー間接続 | 全レイヤーにフィールド変更が伝播している | [E2E 視点の完了基準欠如](../../process/improvements/2026-01/2026-01-29_1304_E2E視点の完了基準欠如.md)、[テストスコープ差異](../../process/improvements/2026-02/2026-02-02_1636_ローカルとCIのテストスコープ差異による検証漏れ.md) |
| 6 | YAGNI/KISS の正しい適用 | 機能スコープと設計品質が区別されている | [YAGNI-KISS の拡大解釈](../../process/improvements/2026-02/2026-02-01_0004_YAGNI-KISSの拡大解釈による設計品質低下.md) |
| 7 | 技術的前提の確認 | ツール仕様が公式ドキュメントで確認されている | [Hurl 仕様未確認](../../process/improvements/2026-02/2026-02-01_0003_Hurl仕様未確認のまま機能を推奨.md) |
```

暫定値・ワークアラウンドのセクション（行223-242）はそのまま残す。

#### 1b. テストフェーズセクション（行244-253）

現在の4項目テーブルを、Issue駆動開発.md への参照 + 出典に変更する。

変更後:

```markdown
### テストフェーズ

品質チェックリストの具体的な確認項目は [Issue駆動開発 > 品質チェックリスト](../../docs/04_手順書/04_開発フロー/01_Issue駆動開発.md#62-品質チェックリスト) を参照。

| # | 観点 | 理想状態（To-Be） | 出典 |
|---|------|------------------|------|
| 1 | テストリスト突合 | 計画と実装が 1:1 で対応している | TDD 開発フローのテストリスト進め方 |
| 2 | カバレッジ | 正常系・異常系・境界値が網羅されている | TDD 開発フロー チェックリスト |
| 3 | E2E 視点 | ユーザーが UI から操作を完了できる | [E2E 視点の完了基準欠如](../../process/improvements/2026-01/2026-01-29_1304_E2E視点の完了基準欠如.md) |
| 4 | TDD 遵守 | Red → Green → Refactor のサイクルを守っている | TDD 開発フローのサイクル定義 |
```

#### 1c. 横断検証フェーズセクション（行255-265）

現在の3項目テーブルを、Issue駆動開発.md への参照 + 出典に変更する。

変更後:

```markdown
### 横断検証フェーズ（複数 Phase の PR で全 Phase 完了後に実施）

各 Phase が個別に整合していても、Phase 間の接続でずれが生じることがある。全 Phase 完了後に、PR 全体を俯瞰して検証する。

品質チェックリストの具体的な確認項目は [Issue駆動開発 > 品質チェックリスト](../../docs/04_手順書/04_開発フロー/01_Issue駆動開発.md#62-品質チェックリスト) を参照。

| # | 観点 | 理想状態（To-Be） | 出典 |
|---|------|------------------|------|
| 1 | Phase 間データフロー整合 | 全レイヤーでデータが一致している | [OpenAPI 仕様突合漏れ](../../process/improvements/2026-01/2026-01-29_1445_Phase5実装時のOpenAPI仕様突合漏れ.md)、[E2E 視点の完了基準欠如](../../process/improvements/2026-01/2026-01-29_1304_E2E視点の完了基準欠如.md) |
| 2 | 仕様との端到端突合 | OpenAPI → Core → BFF → フロントエンドでデータが一貫している | 同上 |
| 3 | 完了基準の E2E 検証 | Issue の完了基準がすべて達成されている | 同上 |

出典: これらのインシデントでは、各 Phase は個別に正しかったがレイヤー間の接続で Silent Failure が発生した。
```

#### 1d. 品質を守る二つの砦（行267-288）

「最後の砦」の参照先を Issue駆動開発.md 6.2 に明確化する。主要な変更は行288:

```markdown
実装中は [TDD の Refactor ステップ](../../docs/04_手順書/04_開発フロー/02_TDD開発フロー.md#-refactor-きれいにする) が俯瞰のトリガーとなり、[品質チェックリスト](../../docs/04_手順書/04_開発フロー/01_Issue駆動開発.md#62-品質チェックリスト)で品質を維持する。特定コンテキストの詳細ルール（[api.md](../../.claude/rules/api.md), [repository.md](../../.claude/rules/repository.md), [data-store.md](../../.claude/rules/data-store.md)）は俯瞰時の観点を提供する。
```

#### 1e. PR 本文への記載の実装例（行331-340）

Self-review の例を更新:

```markdown
**実装の場合:**
```markdown
## Self-review

| # | 観点 | 判定 | 確認内容 |
|---|------|------|---------|
| 1 | 品質チェックリスト | OK | 全項目確認済み |
| 2 | `just check-all` pass | OK | CI で確認 |
```
```

「実装チェックリスト | OK | 全7項目確認済み」→「品質チェックリスト | OK | 全項目確認済み」に変更。「横断検証」行は品質チェックリストに含まれるため削除。

### 2. Issue駆動開発.md

#### 2a. 6.2 品質チェックリスト（行336-367）

現在の内容を、全確認項目を含む包括的なチェックリストに置き換える。

変更後:

```markdown
#### 6.2 品質チェックリスト

自動チェック通過後、以下を確認する。

→ 位置づけ: [品質を守る二つの砦](../../.claude/rules/zoom-rhythm.md#品質を守る二つの砦)（最後の砦）
→ 各観点の背景・出典: [俯瞰・実装リズム > 収束確認のチェックリスト](../../.claude/rules/zoom-rhythm.md#収束確認のチェックリスト)

プロセス完了確認:

設計・ドキュメント:
- [ ] 詳細設計書が作成・更新されているか（`docs/03_詳細設計書/`）
- [ ] API を含む場合、OpenAPI 仕様書が更新されているか（`openapi/`）
- [ ] 技術選定・設計判断があれば ADR が作成されているか（`docs/05_ADR/`）

Issue との整合:
- [ ] Issue の完了基準チェックリストが全て達成されているか
- [ ] Issue の実装計画（Phase、テストリスト）が全て完了しているか

テスト:
- [ ] テストリストの項目が全て実装されているか（計画と実装が 1:1 で対応）
- [ ] 正常系・異常系・境界値が網羅されているか
- [ ] フルスタック機能の場合、E2E シナリオを確認済みか
- [ ] TDD サイクル（Red → Green → Refactor）を守っているか

コード品質確認（マイナス→ゼロ）:

- [ ] アーキテクチャ一貫性: ハンドラ→リポジトリ直接呼び出し等のショートカットがない
- [ ] 既存パターン整合: 命名、構造、エラー処理が既存パターンに準拠
- [ ] 型安全性・エラーハンドリング: String/整数の濫用、安易な unwrap/expect がない
- [ ] 仕様突合: OpenAPI 仕様と実装が一致（フィールド、ステータスコード、型）
- [ ] レイヤー間接続: 全レイヤーにフィールド変更が伝播、DB 制約（UNIQUE、FK、NOT NULL）への影響確認
- [ ] YAGNI/KISS の正しい適用: シンプル化を理由にしたレイヤー違反・型安全性省略がない
- [ ] 技術的前提の確認: ツール仕様が公式ドキュメントで確認されている
- [ ] 既存ドキュメントとの矛盾がないか（要件定義書、基本設計書、ADR など）

品質向上の最終確認（ゼロ→プラス）:

- [ ] シンプルさ: 同じ結果をより少ない概念で実現できないか（不要な中間層、冗長なデータ構造）
- [ ] 型の活用: 型で防げる不正状態を String や整数で済ませていないか
- [ ] 責務の明確さ: 各コンポーネントの責務が単一か（複数の関心事が混ざっていないか）
- [ ] ベストプラクティス: その分野の推奨パターンに沿っているか（標準ライブラリ、フレームワークの活用）

横断検証（複数 Phase の PR の場合）:

- [ ] Phase 間データフロー整合: 下位レイヤーの出力と上位レイヤーの入力を突合し、差分ゼロ
- [ ] 仕様との端到端突合: OpenAPI → Core → BFF → フロントエンドでデータが一貫、Silent Failure がない
- [ ] 完了基準の E2E 検証: Issue の完了基準がすべて達成されている
```

#### 2b. 6.3 収束確認結果を PR 本文に記載（行368-386）

zoom-rhythm.md の「実装フェーズ・横断検証フェーズを実施し」の記述を、6.2 品質チェックリストへの参照に更新。

変更後:

```markdown
#### 6.3 収束確認結果を PR 本文に記載

品質チェックリスト（6.2）の確認結果を **PR 本文の Self-review セクション** に記載する。

```markdown
## Self-review

| # | 観点 | 判定 | 確認内容 |
|---|------|------|---------|
| 1 | 品質チェックリスト | OK | 全項目確認済み |
| 2 | `just check-all` pass | OK | CI で確認 |
```

注意:
- 「OK」だけでなく、具体的に何を確認したかを記載する
- 収束確認結果が記載されていない PR は Ready for Review にしない

改善の経緯: [実装フェーズにおける収束確認の自動実行欠如](../../process/improvements/2026-02/2026-02-06_0010_実装フェーズにおける自己検証の自動実行欠如.md)
```

#### 2c. 変更履歴（行700付近）

```markdown
| 2026-02-06 | 6.2 にコード品質・テスト・横断検証の全項目を統合し、zoom-rhythm.md との重複を解消（#269） |
```

注意: 既存の `2026-02-06` エントリ（`6.2 に品質向上（ゼロ→プラス）チェックを追加`）は、この新エントリに置き換える。

### 3. PR テンプレート

`.github/pull_request_template.md` 行16-20:

変更後:

```markdown
| # | 観点 | 判定 | 確認内容 |
|---|------|------|---------|
| 1 | 品質チェックリスト | | |
| 2 | `just check-all` pass | | |
```

「実装チェックリスト」→「品質チェックリスト」にリネーム。「横断検証」行は品質チェックリストに含まれるため削除。

## 検証方法

1. 変更後の全ファイルを読み、相互参照が正しくリンクされていることを確認
2. 「品質チェックリスト」で Grep し、全参照箇所が整合していることを確認
3. 「実装チェックリスト」「全7項目」で Grep し、古い表現が残っていないことを確認
4. zoom-rhythm.md と Issue駆動開発.md の間で、同じ確認項目が詳細付きで定義されている箇所がないことを確認

## ブラッシュアップループの記録

| ループ | きっかけ | 調査内容 | 結果 |
|-------|---------|---------|------|
| 1回目 | 初版完成 → 重複の網羅性確認 | テストフェーズ・横断検証フェーズにも重複がないか確認 | テストフェーズ (#1, #2) にも Issue駆動 6.2 テスト項目と重複あり。横断検証は重複ではないが統合すべき。スコープを拡大 |
| 2回目 | 統合先の検討 → zoom-rhythm.md がシステムプロンプトに含まれる点の考慮 | zoom-rhythm.md に観点名+理想状態を残すべきか検討 | 観点名+理想状態+出典のテーブルを残すことで、実装中にシステムプロンプト経由で参照可能にする。詳細な確認手順のみ Issue駆動開発.md に委譲 |
| 3回目 | ギャップ発見の観点ゼロ→プラスとの関係 | 設計ブラッシュアップループ内のゼロ→プラス4項目と Issue駆動 6.2 のゼロ→プラスが完全一致する点を確認 | 設計段階の指針として zoom-rhythm.md に残す。対象外と明記。用途が異なる（設計時の発見 vs Ready時の最終確認） |

## 収束確認（設計・計画）

| # | 観点 | 理想状態（To-Be） | 判定 | 確認内容 |
|---|------|------------------|------|---------|
| 1 | 網羅性 | 探索で発見された全重複が計画に含まれている | OK | 実装フェーズ7項目、テストフェーズ4項目中2項目、横断検証3項目、ゼロ→プラス4項目の重複を全て確認。対象外も明記 |
| 2 | 曖昧さ排除 | 不確定な記述がゼロ | OK | 各ファイルの変更箇所を行番号で特定、変更後の内容を具体的に記載 |
| 3 | 設計判断の完結性 | 全ての差異に判断が記載されている | OK | 統合方針（Option B）の選択理由、見送った選択肢、ギャップ発見の観点を対象外とする理由を記載 |
| 4 | スコープ境界 | 対象と対象外が両方明記されている | OK | 「対象と対象外」セクションで明記 |
| 5 | 技術的前提 | コードに現れない前提が考慮されている | OK | zoom-rhythm.md がシステムプロンプトに含まれる点、Issue駆動開発.md は明示的に読む必要がある点を考慮 |
| 6 | 既存ドキュメント整合 | 既存ドキュメントと矛盾がない | OK | CLAUDE.md の参照（俯瞰・実装リズム、Issue駆動開発）に影響なし。改善記録は過去の記録のため更新不要 |
