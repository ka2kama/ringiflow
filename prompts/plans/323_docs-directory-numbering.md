# #323 docs/ ディレクトリ番号見直し

## Context

`docs/50_テスト/` を #291 で新設した際に番号 08 が割り当てられたが、テスト仕様は設計仕様から導出されるため 03（詳細設計）の近くが自然。また、機能仕様書（#299）は `20_機能仕様書/` にサブディレクトリとして暫定配置された（ADR-040: リナンバリングのコスト回避のため）。ADR-040 では「#323 でリナンバリング予定」と明記されている。

番号体系全体を論理的に再構成する。加えて、1 刻み連番から 10 刻み飛び番号に変更し、将来のカテゴリ挿入時にリナンバリングが不要な構造にする。

## 設計判断

### 1. 新しい番号体系

#### 現状

```
10_要件定義書    ← WHAT（機能仕様書がサブディレクトリとして同居）
30_基本設計書    ← HOW（全体設計）
40_詳細設計書    ← HOW（実装設計）
60_手順書       ← HOW TO
70_ADR         ← WHY
80_ナレッジベース ← 参照知識
90_実装解説      ← 実装の詳細
50_テスト       ← テスト仕様・追跡
```

#### 新番号体系（10 刻み飛び番号）

```
10_要件定義書       ← WHAT（ビジネス要件、PRD 相当）
20_機能仕様書       ← WHAT（ユーザー視点の振る舞い、SRS 相当）★ 昇格
30_基本設計書       ← HOW（全体設計）
40_詳細設計書       ← HOW（実装設計）
50_テスト          ← VERIFY（設計から導出されるテスト仕様）★ 移動
60_手順書          ← HOW TO（操作手順）
70_ADR            ← WHY（意思決定記録）
80_ナレッジベース   ← 参照知識
90_実装解説        ← 実装の詳細（PR 単位）
```

#### 設計根拠

**論理順序**: 仕様→設計→検証→運用→参照

- 10-20: 仕様（WHAT）— 要件 → 機能仕様（StRS → SRS、ISO 29148 の抽象度順）
- 30-40: 設計（HOW）— 基本設計 → 詳細設計
- 50: 検証（VERIFY）— テスト仕様（V モデルで設計の対になる）
- 60: 運用（HOW TO）— 開発手順
- 70-90: 参照（REFERENCE）— 意思決定、知識、実装解説

**機能仕様書の昇格**: 7 ファイル・成長中のコレクション。ADR-040 で「#323 でリナンバリング可能」と明記済み。

**テストの位置（50）**: テスト仕様は詳細設計（40）から導出される。現状の 08 は配置根拠が弱い。

### 2. 飛び番号の採用理由

1 刻み連番の問題は #299 → #323 で既に顕在化した。10 刻みにすることで、各ペア間に 9 スロットの挿入余地を確保し、将来のカテゴリ追加時にリナンバリングを不要にする。

## 影響範囲

### 参照更新の見積もり

| 変更 | 出現数 | ファイル数 |
|------|--------|-----------|
| `20_機能仕様書/` → `20_機能仕様書/` | 37 | 20 |
| `10_要件定義書` → `10_要件定義書` | 61 | 29 |
| `30_基本設計書` → `30_基本設計書` | 32 | 22 |
| `40_詳細設計書` → `40_詳細設計書` | 193 | 125 |
| `60_手順書` → `60_手順書` | 215 | 113 |
| `70_ADR` → `70_ADR` | 161 | 109 |
| `80_ナレッジベース` → `80_ナレッジベース` | 153 | 101 |
| `90_実装解説` → `90_実装解説` | 63 | 37 |
| `50_テスト` → `50_テスト` | 47 | 26 |
| **合計** | **~962** | **（重複ファイルあり）** |

注: 10 刻みでは `10_要件定義書` も `10_要件定義書` に変更が必要（1 刻みでは回避できていた）。

### 更新対象のファイル種別

- `.claude/rules/*.md`, `.claude/skills/**/*.md` — ルール・スキル定義
- `CLAUDE.md` — プロジェクトガイダンス
- `docs/**/*.md` — ドキュメント本体
- `prompts/**/*.md` — セッションログ、計画ファイル
- `process/**/*.md` — 改善・調査記録
- `README.md`, `README.ja.md` — プロジェクト README
- `backend/**/*.rs` — コードコメント内の参照
- `frontend/**` — コードコメント内の参照
- `scripts/**`, `justfile` — スクリプト・タスクランナー
- `.github/**`, `tests/**` — CI・テスト

## 対象外

- ディレクトリ内部のファイル番号の変更（各ディレクトリ内の `00_`, `01_` 等は変更しない）

## 実装計画

### Phase 1: ディレクトリ移動

#### 確認事項
- パターン: docs.md のエントリファイル規約 → `.claude/rules/docs.md`

#### 手順

10 刻みへの移動は旧番号と新番号が重複しないため、衝突の心配はない。ただし `20_機能仕様書/` の昇格を先に行い、空になったサブディレクトリの処理が必要。

実行順序（依存関係なし、任意の順序で可）:

```bash
# 機能仕様書の昇格（先に実行: 01 の中身を変更してから 01 をリネーム）
git mv docs/20_機能仕様書 docs/20_機能仕様書

# 残りのディレクトリ移動
git mv docs/10_要件定義書 docs/10_要件定義書
git mv docs/30_基本設計書 docs/30_基本設計書
git mv docs/40_詳細設計書 docs/40_詳細設計書
git mv docs/50_テスト docs/50_テスト
git mv docs/60_手順書 docs/60_手順書
git mv docs/70_ADR docs/70_ADR
git mv docs/80_ナレッジベース docs/80_ナレッジベース
git mv docs/90_実装解説 docs/90_実装解説
```

#### 操作パス: 該当なし（ドキュメント整理のみ）
#### テストリスト
ユニットテスト（該当なし）、ハンドラテスト（該当なし）、API テスト（該当なし）、E2E テスト（該当なし）

### Phase 2: 参照の一括置換

#### 確認事項
- パターン: `sed` による一括置換 → 長いパス（機能仕様書の完全パス）を先に置換

#### 手順

10 刻みへの変更は旧番号と新番号が重複しないため、一時マーカーは不要。ただし `20_機能仕様書` → `20_機能仕様書` を先に処理し、その後に `10_要件定義書` → `10_要件定義書` を処理する（長いパスから先に置換）。

置換順序:
1. `20_機能仕様書` → `20_機能仕様書`（最長パスを先に）
2. `10_要件定義書` → `10_要件定義書`
3. `30_基本設計書` → `30_基本設計書`
4. `40_詳細設計書` → `40_詳細設計書`
5. `60_手順書` → `60_手順書`
6. `70_ADR` → `70_ADR`
7. `80_ナレッジベース` → `80_ナレッジベース`
8. `90_実装解説` → `90_実装解説`
9. `50_テスト` → `50_テスト`

相対パスの調整: docs 内の相互参照（`../30_基本設計書/` 等）も上記で網羅される。

#### テストリスト
ユニットテスト（該当なし）、ハンドラテスト（該当なし）、API テスト（該当なし）、E2E テスト（該当なし）

検証: `just check` 通過 + 旧パターン残留ゼロ

### Phase 3: ドキュメント更新

#### 確認事項
- 型: CLAUDE.md のドキュメント体系テーブル → `CLAUDE.md`
- パターン: docs.md のエントリファイル注記 → `.claude/rules/docs.md`
- パターン: ADR-040 → `docs/70_ADR/040_機能仕様書の導入.md`（移動後パス）

#### 手順

1. `CLAUDE.md` のドキュメント体系テーブルを新番号に更新
2. `.claude/rules/docs.md` の注記を更新（`00_` スロット問題の #323 対応予定を解消）
3. ADR-040 に変更履歴を追記（機能仕様書が独立ディレクトリに昇格したこと）
4. `docs/20_機能仕様書/00_はじめに.md` の参照パスを調整
5. `docs/10_要件定義書/00_はじめに.md` から機能仕様書への参照を新パスに更新

#### テストリスト
ユニットテスト（該当なし）、ハンドラテスト（該当なし）、API テスト（該当なし）、E2E テスト（該当なし）

### Phase 4: 品質ゲート

1. `just check` 通過
2. 旧番号パターンの残留チェック:
   - `rg "docs/0[1-8]_"` → ゼロ（全ディレクトリが 10 刻みに移行済み）
   - `rg "20_機能仕様書"` → ゼロ
3. `ls -d docs/*/` で構造確認
4. 品質チェックリスト実施

## 検証

- `just check` でビルド・テスト全通過
- `rg "docs/0[1-8]_"` で旧パターン残留ゼロ
- `ls -d docs/*/` で期待通りの 9 ディレクトリ構造

## ブラッシュアップループの記録

| ループ | 検出したギャップ | 観点 | 対応 |
|-------|----------------|------|------|
| 1回目 | 1 刻み連番では同じリナンバリング問題が再発する | 既存手段の見落とし | 10 刻み飛び番号を採用 |
| 2回目 | 10 刻みでは旧番号と新番号が重複しないため一時マーカーが不要 | シンプルさ | Phase 2 から一時マーカー方式を削除、直接置換に簡略化 |
| 2回目 | 10 刻みでは `10_要件定義書` も変更対象（1 刻みでは回避していた） | 未定義 | 影響範囲に `10_要件定義書` の変更を追加 |

## 収束確認（設計・計画）

| # | 観点 | 理想状態（To-Be） | 判定 | 確認内容 |
|---|------|------------------|------|---------|
| 1 | 網羅性 | 全ディレクトリの移動と参照更新が計画に含まれている | OK | 8→9 ディレクトリ（01 含む全件）、全参照パターンを列挙 |
| 2 | 曖昧さ排除 | 不確定な記述がゼロ | OK | 対象外を明記、置換順序を確定 |
| 3 | 設計判断の完結性 | 番号体系と飛び番号の根拠が記載されている | OK | 論理フロー + 1 刻みの問題顕在化 |
| 4 | スコープ境界 | 対象と対象外が明記 | OK | ディレクトリ内ファイル番号は対象外 |
| 5 | 技術的前提 | 10 刻みで衝突なしを確認 | OK | 旧番号(01-08)と新番号(10-90)に重複なし |
| 6 | 既存ドキュメント整合 | ADR-040 と矛盾がない | OK | ADR-040 で「#323 でリナンバリング可能」と明記済み |
