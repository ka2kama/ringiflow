# 自己検証プロトコル（Self-Review Protocol）の導入

## 概要

AI エージェントが設計・実装・テストの初版を推敲せずに進める傾向に対し、全フェーズ共通の「生成 → 検証 → 修正」ループを構造化する。

## 変更ファイル

| ファイル | 操作 | 内容 |
|---------|------|------|
| `.claude/rules/self-review.md` | 新規作成 | フェーズ別の自己検証チェックリスト |
| `CLAUDE.md` | 編集（2箇所） | ① YAGNI/KISS 判断基準追記 ② 自己検証プロトコルセクション追加 |
| `prompts/improvements/2026-02/` 2ファイル | 編集 | 次のアクションのチェックボックスを完了に更新 |

## 実装手順

### Step 1: `.claude/rules/self-review.md` を新規作成

frontmatter なし（全コンテキストで常時適用）。

構成:
1. 検証ループの実行方法（生成→検証→修正→...→指摘ゼロ→提示）
2. フェーズ別チェックリスト（テーブル形式、既存 rules と同じスタイル）
   - **設計・計画**: 網羅性、曖昧さ排除、設計判断の完結性、スコープ境界、技術的前提、既存ドキュメント整合（6項目）
   - **実装**: アーキテクチャ一貫性、既存パターン整合、型安全性、エラーハンドリング、仕様突合、レイヤー間接続、YAGNI/KISS の正しい適用、技術的前提の確認（8項目）
   - **テスト**: テストリスト突合、カバレッジ、アサーションの意味、E2E視点、TDD遵守（5項目）
3. 既存の検証プロセスとの関係
   - Ready for Review チェックリスト（Issue駆動開発 6.2）= PR 提出前の最終確認。自己検証プロトコルとは**補完関係**（開発中 vs PR 提出前）
   - TDD Refactor ステップ = コード内部品質の改善。自己検証はそれに加えて「設計との整合性」「パターンの一貫性」を確認する上位概念
   - 既存 rules（api.md, repository.md 等）を「いつ適用するか」の上位構造
4. AI エージェントへの指示 + 禁止事項
5. 参照（改善記録へのリンク）

チェックリストの各項目は過去の改善記録から抽出した実証済みの観点のみ。

### Step 2: `CLAUDE.md` に YAGNI/KISS 判断基準を追記（Issue #199）

**挿入位置**: 行 158（設計原則の箇条書き末尾）の後、行 160（型システムの活用）の前

追記内容:
- YAGNI/KISS/MVP は**機能スコープ**の原則であり、**設計品質**を妥協する根拠にならない
- 判定テスト: 「放置すると後続で同パターンが使われるか？」→ Yes なら設計品質の問題
- テーブルで「機能の先取り（見送り可）」vs「設計品質（妥協不可）」を具体例付きで対比

### Step 3: `CLAUDE.md` に自己検証プロトコルセクションを追加

**挿入位置**: 行 199（`## 技術選定・設計判断の原則` 末尾）の後、行 201（`## ドキュメント体系`）の前

追加する `## 自己検証プロトコル` セクション:
- 原則: 初版をそのまま提示しない。必ず自己検証を1回以上実施
- 検証タイミング表（計画提示前 / 設計書コミット前 / Phase実装完了後 / テスト全項目実装後）
- `.claude/rules/self-review.md` へのリンク
- 禁止: 自己検証を実施せずに成果物を提示・コミットすること

### Step 4: 改善記録の更新

2ファイルの「次のアクション」チェックボックスを `[x]` に更新:
- `2026-02-02_1023_計画段階での置換対象と設計決定の網羅性不足.md` 行 71
- `2026-02-01_0004_YAGNI-KISSの拡大解釈による設計品質低下.md` 行 48

## 設計判断

| 判断 | 選択 | 理由 |
|------|------|------|
| チェックリストの粒度 | 各フェーズ 5-7 項目 | 細かすぎると形骸化する。実際のインシデントに基づく項目のみ |
| 検証実施の報告 | 暗黙実行（報告不要） | レスポンスの冗長化を防ぐ。品質は結果で示す |
| frontmatter | なし（常時適用） | 全フェーズ横断のため。推定 3KB のコンテキスト消費は許容範囲 |
| 手順書の修正 | スコープ外 | 手順書への統合が必要なら別 Issue で追跡する |

## スコープ境界

| 区分 | 対象 |
|------|------|
| 対象 | CLAUDE.md（2箇所追記）、`.claude/rules/self-review.md`（新規）、改善記録（2件更新） |
| 対象外 | 手順書（01_Issue駆動開発.md、02_TDD開発フロー.md）の修正。必要なら別 Issue で追跡 |

## Issue 管理

- Issue #199（YAGNI/KISS 判断基準）の完了条件は Step 2 で満たされる
- 自己検証プロトコルは #199 のスコープを超えるため、新規 Issue を作成
  - タイトル: `CLAUDE.md に自己検証プロトコル（Self-Review Protocol）を導入する`
  - 完了条件:
    - CLAUDE.md に自己検証プロトコルセクションが追加されていること
    - `.claude/rules/self-review.md` にフェーズ別チェックリストが定義されていること
- 同一 PR で両 Issue をクローズする（`Closes #199` + `Closes #新Issue`）

## 検証方法

- CLAUDE.md のセクション順序が正しいこと（理念 → 技術選定 → 自己検証 → ドキュメント体系）
- `.claude/rules/self-review.md` 内のリンク（改善記録5件、既存 rules 4件）が正しく解決されること
- 改善記録5件の「対策」がチェックリスト項目に反映されていること
- `just check-all` が通ること
