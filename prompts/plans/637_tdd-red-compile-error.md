# #637 TDD Red フェーズにおけるコンパイルエラーの位置づけを明示する

## Context

現在の TDD 開発フロー（`02_TDD開発フロー.md`）の Red セクションでは、コンパイルエラー解消が機械的な手順として記述されている。静的型付き言語（Rust/Elm）では、コンパイラからのフィードバックが TDD の Red フェーズで設計駆動の役割を果たすが、その意味が文書化されていない。

Issue #637 で提案された「二層の Red モデル」を TDD 開発フローに組み込み、既知手法との対応をナレッジベースに追記する。

## 対象ファイル

| ファイル | 変更内容 |
|---------|---------|
| `docs/04_手順書/04_開発フロー/02_TDD開発フロー.md` | Red セクションの拡充 |
| `docs/06_ナレッジベース/methodology/独自フレームワークと既知手法の対応.md` | nano-cycle の対応を追記 |

## 対象外

- コードの変更（既存の `todo!()` 使用パターンはそのまま）
- 他のセクション（Green / Refactor）の変更
- TDD ワークフロー図の変更（Red の内部構造であり、全体フローには影響しない）

## Phase 1: TDD 開発フローの Red セクション拡充

### 変更箇所

`02_TDD開発フロー.md` L57-82 の `### 🔴 Red: 失敗するテストを書く` セクション。

### 変更内容

現在のステップリスト（L61-63）を拡充し、以下を追加する:

1. **二層の Red モデル**: Issue で提案された表をそのまま採用。ステップリストの後に配置
2. **Mermaid 図**: Red 内部の小サイクル（compile → test failure）を可視化
3. **コンパイルエラー解消の原則**: `todo!()` / `Debug.todo` を使いロジックは書かない
4. **メンタルモデル**: コンパイラ = 最初のテストランナー
5. **参考資料セクション**: nano-cycle、Compiler-Driven Development、GOOS への参照を追加

### 具体的な構造

```
### 🔴 Red: 失敗するテストを書く

**目的:** 実装すべき振る舞いを明確にする

1. テストを1つだけ書く
2. コンパイルエラーを解消する（最小限のスタブ）
3. テストを実行して **失敗することを確認** する

#### 二層の Red モデル

[表: Red (compile) と Red (test failure) の比較]
[Mermaid 図: テスト記述 → Red (compile) → Red (test failure) → Green]

[メンタルモデルの解説]

#### コンパイルエラー解消の原則

[原則の表: 書くもの / 書かないもの]
[Rust / Elm のコード例]

[既存コード例へのポインタ]

重要: 失敗を確認せずに実装に進まない。...（既存テキスト）
```

### ステップリストの書き換え

現在:
```
1. テストを1つだけ書く
2. コンパイルエラーを解消する（最小限のスタブ）
3. テストを実行して **失敗することを確認** する
```

変更後:
```
1. テストを1つだけ書く（→ Red: compile）
2. コンパイルエラーを解消する（→ Green: compile / Red: test failure）
3. テストを実行して **失敗することを確認** する
```

ステップ番号に二層モデルとの対応を括弧で付記し、後続の詳細セクションへの橋渡しとする。

### 参考資料セクションへの追記

既存の参考資料セクション（L490-494）に以下を追加:

- Robert C. Martin (2021) "Clean Craftsmanship" — nano-cycle（Red 内の小サイクル）
- Steve Freeman & Nat Pryce (2009) "Growing Object-Oriented Software, Guided by Tests" — "Write the test you wish you had"

#### 確認事項
- [x] 既存の Red セクションの構造（L57-82）→ 読み込み済み。ステップリスト + コード例 + 重要注記の3部構成
- [x] 既存の参考資料セクション（L490-494）→ Kent Beck + t_wada の2点。ここに追記する
- [x] `todo!()` の既存使用パターン → `handler/auth/tests.rs`, `handler/role.rs` のスタブ実装で15箇所使用。テストで使われていないトレイトメソッドのプレースホルダとして使用
- [x] Mermaid flowchart の既存パターン → L22-26 の TDD サイクル図を参照。`flowchart LR` + emoji 付きノード

#### テストリスト

ユニットテスト（該当なし）
ハンドラテスト（該当なし）
API テスト（該当なし）
E2E テスト（該当なし）

## Phase 2: ナレッジベースに nano-cycle の対応を追記

### 変更箇所

`docs/06_ナレッジベース/methodology/独自フレームワークと既知手法の対応.md`

### 変更内容

「Issue 駆動 + Phase 分割 + TDD と既知手法」セクション（L130 付近）に、TDD の nano-cycle に関するサブセクションを追加する。

追加内容:
- nano-cycle（Robert C. Martin, Clean Craftsmanship）の概要
- ringiflow の「二層の Red モデル」との対応
- 関連概念: Compiler-Driven Development、GOOS の "Write the test you wish you had"
- ringiflow の独自性: 静的型付き言語に特化した二層モデルの明示化

### 配置

`### Spec-Driven Development（GitHub Spec Kit）` の前に新しいサブセクション `### nano-cycle と二層の Red モデル（Robert C. Martin）` を追加。TDD に直接関連する概念なので、SDD より前に配置するのが論理的。

全体像の Mermaid 図（L11-41）にも nano-cycle のノードを追加する。

関連リソースセクション（L179-188）にも Clean Craftsmanship と GOOS を追加する。

#### 確認事項
- [x] 既存の Mermaid 図の構造（L11-41）→ `ringiflow` サブグラフに `ID["Issue 駆動 + Phase 分割 + TDD"]` ノードあり。`known` サブグラフに `SDD["Spec-Driven Development"]` ノードあり。`ID --> SDD` のエッジ。ここに nano-cycle ノードを追加
- [x] 「Issue 駆動 + Phase 分割 + TDD と既知手法」セクション（L130-148）の構造 → SDD のみ。ここに nano-cycle セクションを追加
- [x] 関連リソースセクション（L179-188）→ 8件のリソース。ここに Clean Craftsmanship と GOOS を追加
- [x] 変更履歴セクション（L192-197）→ 最新エントリは 2026-02-11

#### テストリスト

ユニットテスト（該当なし）
ハンドラテスト（該当なし）
API テスト（該当なし）
E2E テスト（該当なし）

## ブラッシュアップループの記録

| ループ | 検出したギャップ | 観点 | 対応 |
|-------|----------------|------|------|
| 1回目 | ステップリストと二層モデルの接続が不明確 | 曖昧 | ステップリストに二層モデルとの対応を括弧で付記する方針を追加 |
| 2回目 | Mermaid 全体像図への nano-cycle 追加が計画に含まれていない | 不完全なパス | Phase 2 に全体像 Mermaid 図への追加を明記 |
| 3回目 | ギャップなし | — | — |

## 収束確認（設計・計画）

| # | 観点 | 判定 | 確認内容 |
|---|------|------|---------|
| 1 | 網羅性 | OK | Issue の完了基準3点（Red セクション拡充、参考資料追記、ナレッジベース追記）すべてに対応する Phase がある |
| 2 | 曖昧さ排除 | OK | 変更箇所を行番号で特定、構造をスケルトンで提示 |
| 3 | 設計判断の完結性 | OK | nano-cycle セクションの配置位置（SDD の前）、ステップリストの書き換え方針を決定済み |
| 4 | スコープ境界 | OK | 対象（2ファイル）と対象外（コード変更なし、他セクション変更なし）を明記 |
| 5 | 技術的前提 | OK | Mermaid flowchart の記法は既存パターンを踏襲 |
| 6 | 既存ドキュメント整合 | OK | Issue #637 の提案内容、既存の TDD フロー、ナレッジベースと矛盾なし |

## 検証方法

1. `just check-all` が通ること（lint 含む）
2. 変更した Markdown の Mermaid 図が正しく描画されること（PR のプレビューで確認）
