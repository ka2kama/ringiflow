# 計画: Issue #106 テスト設計方針の策定

## Context

テストコードの一覧性・可読性・一貫性を向上させるため、レイヤーごとのテスト設計方針を策定し ADR に記録する。Issue #106 の完了条件（レイヤーごとの方針、共通原則、ADR 作成、移行方針）をすべて満たす。

成果物は **ADR-032** のみ。コード変更はなし。

## 前提（既に確定している事項）

- TDD 採用済み（開発プロセス）
- AAA 用語は #279 で採用済み
- テストピラミッド（75% Unit / 20% Integration / 5% E2E）は要件定義 CORE-12 で定義済み
- API テストのアサーション方針は `.claude/rules/api-test.md` で定義済み

## 実施手順

### Step 1: ブランチ作成

```bash
git checkout main && git pull
git checkout -b feature/106-test-design-policy
```

### Step 2: ADR-032 作成

ファイル: `docs/70_ADR/032_テスト設計方針.md`

テンプレート（`docs/70_ADR/template.md`）に準拠した構造で、以下の5つの論点を含む ADR を作成する。

#### 論点1: BDD（cucumber-rs）の採用判断

**決定: 見送り（rstest + AAA パターン + 構造化ルールで対応）**

理由:
- cucumber-rs の最大利点（非技術者への仕様共有）が個人開発プロジェクトでは活きない
- TDD の素早いフィードバックサイクル（Red-Green-Refactor）に摩擦が生じる（feature ファイル + ステップ定義の二重管理）
- rstest が既にプロジェクト全体で活用されており、パラメータ化テストの基盤が整っている
- 既存テストの移行コストを回避できる

見送りは「BDD が不要」ではなく「BDD の価値が発揮される条件がこのプロジェクトにない」という判断。

#### 論点2: レイヤーごとのテスト表現形式

| レイヤー | ツール | 表現形式 | 構造化コメント |
|---------|--------|---------|-------------|
| Unit (Domain) | Rust + rstest | AAA | `// Arrange` / `// Act` / `// Assert`（必要時） |
| Unit (Elm) | elm-test | describe + test 階層 | フレームワークが構造を強制 |
| Integration (Infra) | Rust + sqlx::test | AAA | Unit と一貫 |
| Integration (BFF) | Rust + axum | AAA（Given-When-Then も許容） | シナリオ的テストでは自然な方を選択 |
| API | Hurl | Given-When-Then | 現状維持（api-test.md 定義済み） |
| E2E | Playwright（予定） | Given-When-Then | ユーザーシナリオに適合 |

#### 論点3: 命名規則

**決定: 現状の日本語命名を維持**

| 項目 | 規則 | 例 |
|------|------|-----|
| Rust テスト関数 | `test_[振る舞いの説明]` | `test_新規作成時にversionは1()` |
| Rust テストモジュール | `mod [snake_case]` | `mod workflow_instance` |
| Elm テスト名 | 日本語で条件を明確に | `test "/ → Home"` |
| Hurl ファイル名 | snake_case 英語 | `submit_workflow.hurl` |
| Hurl セクション名 | 日本語コメント | `# 正常系: ワークフローを申請できる` |

#### 論点4: テストコードの構造化方法

1. **mod によるグルーピング**: 対象機能ごとに `mod` で分離
2. **セクションコメント**: 正常系/異常系/境界値を区切り線で分類
3. **ファイル先頭のテスト目次**: 統合テストファイルの冒頭に doc コメントでテストケース一覧
4. **AAA コメントの適用基準**: テストの意図がコードから明らかでない場合に付与。単純なテストには不要

#### 論点5: 既存テストへの移行方針

**決定: 段階的適用**

| フェーズ | 対象 | タイミング |
|---------|------|-----------|
| Phase 0 | ADR のマージ | 即時 |
| Phase 1 | 新規テスト | 即時（ADR ルールに従って書く） |
| Phase 2 | 既存テストの漸進的適用 | 各機能実装時（ボーイスカウトルール） |
| Phase 3 | 一括適用（任意） | 必要に応じて |

### Step 3: Draft PR 作成

```bash
git add docs/70_ADR/032_テスト設計方針.md
git commit -m "#106 Add ADR-032: Test design policy"
git push -u origin HEAD
gh pr create --draft --title "#106 Add ADR-032: Test design policy" ...
```

### Step 4: Issue チェックボックス更新

Issue #106 の完了条件を更新。

### Step 5: 収束確認・ドキュメント整備

収束確認チェックリスト実施後、`/wrap-up` でセッションログ等を作成。

## 対象ファイル

- 新規: `docs/70_ADR/032_テスト設計方針.md`

## 対象外

- TDD プロセス自体の変更（採用済み）
- カバレッジ目標の変更（CORE-12 で定義済み）
- API テストのアサーション方針の変更（api-test.md で定義済み）
- コード変更（テストコードの修正は含まない）

## 検証方法

- ADR の内容が Issue #106 の完了条件4項目をすべてカバーしているか確認
- 既存の ADR（特に ADR-023）のフォーマットと一貫しているか確認
- 要件定義 CORE-12、TDD 開発フロー、#279 の決定と矛盾しないか確認

## ブラッシュアップループの記録

| ループ | きっかけ | 調査内容 | 結果 |
|-------|---------|---------|------|
| 1回目 | 初版完成 → 既存テストパターンとの整合性確認 | Rust/Elm/Hurl の全テストファイルのパターンを調査 | 4つの既存構造化パターン（mod グルーピング、セクションコメント、テスト目次、AAA コメント）を発見し、「現状を形式知化する」方針に調整 |
| 2回目 | rstest 使用状況の確認 | 全ての `#[rstest]` / `#[case(` 使用箇所を確認 | rstest が広く使われていることを確認。cucumber-rs 見送りの根拠を強化 |
| 3回目 | #279 との整合性確認 | AAA / Given-When-Then の位置づけ、TDD テストと品質保証テストの区別を確認 | 「AAA を基本とし、シナリオ的テストでは Given-When-Then も許容」の方針が #279 の決定と整合することを確認 |

## 収束確認（設計・計画）

| # | 観点 | 理想状態（To-Be） | 判定 | 確認内容 |
|---|------|------------------|------|---------|
| 1 | 網羅性 | Issue #106 の完了条件4項目すべてが計画に含まれている | OK | レイヤーごとの方針（論点2）、共通原則（論点3,4）、ADR 作成（Step 2）、移行方針（論点5）すべてカバー |
| 2 | 曖昧さ排除 | 各論点の判断が一意に確定している | OK | 5つの論点すべてに決定と理由を記載。「必要に応じて」等の不確定表現なし |
| 3 | 設計判断の完結性 | Issue 本文の4つの選択肢すべてに評価がある | OK | 現状維持/BDD/データ駆動+目次/折衷案を評価し、比較表で整理 |
| 4 | スコープ境界 | 対象と対象外が両方明記されている | OK | 「対象ファイル」と「対象外」セクションで明記 |
| 5 | 技術的前提 | cucumber-rs, rstest の現状を確認済み | OK | crates.io / GitHub で成熟度確認、既存コードでの使用状況調査済み |
| 6 | 既存ドキュメント整合 | 要件定義、TDD フロー、api-test.md、#279 の決定と矛盾がない | OK | CORE-12 テストピラミッド準拠、AAA 用語は #279 を引き継ぎ、api-test.md は現状維持 |
