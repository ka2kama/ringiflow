# Issue #846: Phase 2-5（通知 + ドキュメント管理）の設計

## Context

Phase 2-4（ワークフローデザイナー）が完走し、Phase 2-5 の前提条件がクリアされた。
本 Issue では Phase 2-5 の機能仕様書・詳細設計書を作成し、実装への道筋を確立する。
AWS SES（メール通知）と S3（ドキュメント管理）連携が主要な技術要素。

コード実装は行わない。成果物は設計ドキュメントと Epic/Story Issue。

## スコープ

Phase 2-5 で実装する範囲:
- NOTIFY-001: メール通知基盤（AWS SES）+ ワークフロー通知
- DOC-001: ファイルアップロード（AWS S3）
- DOC-003: フォルダ管理（基本的な階層構造）

対象外（Phase 3 以降）:
- NOTIFY-002〜006（Slack, Teams, Webhook, アプリ内通知, 通知設定）
- DOC-002, 004〜006（バージョン管理, 全文検索, アクセス権限, プレビュー）

## 設計判断

| # | 判断事項 | 推奨 | 理由 |
|---|---------|------|------|
| 1 | SES 連携方式 | 直接 API 呼び出し（同期） | テナント 10 社規模で十分。trait 抽象化で Phase 3 Outbox パターンへ移行可能 |
| 2 | メールテンプレート | アプリ側テンプレート（tera or handlebars） | コードでバージョン管理完結、ローカル開発対応 |
| 3 | 通知イベントモデル | ドメインイベント型 + ユースケース呼び出し | Phase 3 イベント駆動移行の基盤 |
| 4 | ローカル開発（メール） | Mailpit | MailHog はメンテナンス停滞、Mailpit が後継で活発 |
| 5 | アップロード方式 | Presigned URL | サーバー負荷軽減、AWS ベストプラクティス |
| 6 | S3 バケット構成 | 単一バケット + テナントプレフィックス分離 | テナント退会削除設計に準拠 |
| 7 | フォルダデータモデル | PostgreSQL + materialized path | S3 はフラットストレージ、DB で階層・権限管理 |
| 8 | ローカル開発（S3） | MinIO | 最も広く使われる S3 互換ストレージ |
| 9 | Elm ファイルアップロード | elm/file + Http.request | Ports 不要、標準機能で Presigned URL へ直接 PUT |
| 10 | 通知ログ格納先 | PostgreSQL（notification_logs） | Phase 2-5 は送信ログのみ。DynamoDB notifications は Phase 3 アプリ内通知で使用 |

---

## Phase 1: 機能仕様書の作成

成果物:
- `docs/01_要件定義書/機能仕様書/05_通知機能.md`（新規）
- `docs/01_要件定義書/機能仕様書/06_ドキュメント管理.md`（新規）
- `docs/01_要件定義書/機能仕様書/00_はじめに.md`（更新: 読む順序に追加）

#### 確認事項
- テンプレート: `docs/01_要件定義書/機能仕様書/00_はじめに.md`
- 既存パターン: `01_ワークフロー管理.md`, `04_ワークフローデザイナー.md`
- 要件: `docs/01_要件定義書/01_コア要件.md` NOTIFY-001, DOC-001, DOC-003
- 通知トリガー: `backend/crates/domain/src/workflow/instance.rs` WorkflowInstanceStatus enum

#### 05_通知機能.md の構成

テンプレート（9 セクション）準拠:

1. **概要**: ワークフロー進行のメール通知で承認プロセスを迅速化
2. **シナリオ**（4 個）: 承認依頼通知、承認完了通知、却下通知、差し戻し通知
3. **画面・操作フロー**: Phase 2-5 では専用画面なし（メール送信のみ）。将来拡張点を記載
4. **機能詳細**: 通知イベント一覧（5 種類）、メール本文に含む情報、送信失敗時の振る舞い
   - 通知イベント: 承認依頼 / 承認完了 / 却下 / 差し戻し / ステップ承認（中間）
5. **状態遷移**: Phase 2-5 では管理しない（送信ログのみ）。将来: Queued → Sent → Delivered/Failed
6. **権限**: システム自動送信のため権限制御不要
7. **非ゴール**: NOTIFY-002〜006, リトライ/Outbox, 通知リマインダー
8. **未解決事項**: メール送信元アドレス、開発環境メール確認方法、多言語対応方針
9. **関連ドキュメント**

#### 06_ドキュメント管理.md の構成

1. **概要**: ワークフロー申請へのファイル添付、テナント内フォルダ管理
2. **シナリオ**（4 個）: 申請へのファイル添付、フォルダ作成・整理、ダウンロード、ファイル削除
3. **画面・操作フロー**: ドキュメント管理画面レイアウト、申請フォーム添付 UI、アップロード進捗
4. **機能詳細**:
   - ファイルアップロード: 対応形式、サイズ制限（20MB/件、100MB/申請）、Presigned URL 方式
   - フォルダ管理: 階層制限（最大 5 階層）、フォルダ名制約、操作（CRUD + 移動）
5. **状態遷移**: ファイル: Uploading → Active → Deleted、フォルダ: Active → Deleted
6. **権限**: 申請者/承認者/管理者のマトリックス
7. **非ゴール**: DOC-002, 004〜006, サムネイル生成, インデックス
8. **未解決事項**: 定義スキーマへの file フィールド型追加、フォルダとワークフローの関連付け、ストレージ容量制限
9. **関連ドキュメント**

#### テストリスト（ドキュメント品質検証）

ユニットテスト（該当なし）
ハンドラテスト（該当なし）
API テスト（該当なし）
E2E テスト（該当なし）

ドキュメント品質検証:
- [ ] テンプレート構造（9 セクション）に準拠
- [ ] 技術的実装詳細が混入していない（ユーザー視点で記述）
- [ ] 非ゴールで Phase 2-5 スコープ外を網羅
- [ ] ワークフロー管理仕様書との整合性（状態遷移、権限、用語）
- [ ] 通知トリガーが WorkflowInstanceStatus と整合
- [ ] `00_はじめに.md` の読む順序に新規仕様書を追加

#### 操作パス
該当なし（操作パスが存在しない）

---

## Phase 2: 詳細設計書の作成（通知機能）

成果物: `docs/03_詳細設計書/16_通知機能設計.md`（新規）

#### 確認事項
- パターン: `docs/03_詳細設計書/15_ワークフローデザイナー設計.md`
- 基本設計: `docs/02_基本設計書/01_アーキテクチャ設計.md` BATCH-203, `03_インフラとDB設計.md` notifications テーブル
- 既存インフラ: `infra/docker/docker-compose.yaml`
- テナント退会: `docs/03_詳細設計書/06_テナント退会時データ削除設計.md`
- 既存イベントパターン: `backend/crates/shared/src/event_log.rs`
- API 設計パターン: `docs/03_詳細設計書/03_API設計.md`

#### 16_通知機能設計.md の構成

1. **概要**: Phase 2-5 スコープ、要件（NOTIFY-001）
2. **アーキテクチャ**:
   - シーケンス図: Browser → BFF → Core → 通知サービス → SES
   - 通知サービスは Core Service 内のドメインサービス
   - Phase 3 で Outbox パターン + Lambda に移行する移行パス
3. **設計判断**: SES 連携方式、テンプレート管理、イベントモデル（各推奨案・代替案・理由）
4. **ローカル開発環境**: Mailpit（Docker Compose 追加）
5. **API 設計**: Phase 2-5 では外部エンドポイントなし（内部副作用のみ）。将来の API 案を記載
6. **データモデル**: notification_logs テーブル（PostgreSQL、RLS 対応、CASCADE 削除）
7. **ドメインロジック**: NotificationSender trait、WorkflowNotification enum（5 バリアント）
8. **ユースケース統合**: 既存の approve_step, reject_step 等への通知送信追加
9. **フロントエンド**: Phase 2-5 では変更なし
10. **テスト観点**: ユニット（イベント生成、テンプレート）、ハンドラ（mock 通知）、統合（Mailpit）
11. **テナント退会削除対応**: notification_logs の削除レジストリ登録

#### テストリスト: 該当なし（設計ドキュメント作成のみ）

ドキュメント品質検証:
- [ ] 詳細設計書パターンに準拠
- [ ] Phase 2-5 スコープと将来拡張が分離されている
- [ ] trait 定義が既存パターンと一貫
- [ ] テナント退会削除設計との整合
- [ ] DB 設計が既存パターン（RLS、tenant_id、UUID v7）に準拠
- [ ] 実装状態マーカー付与

#### 操作パス
該当なし（操作パスが存在しない）

---

## Phase 3: 詳細設計書の作成（ドキュメント管理）

成果物: `docs/03_詳細設計書/17_ドキュメント管理設計.md`（新規）

#### 確認事項
- S3 設計: `docs/03_詳細設計書/06_テナント退会時データ削除設計.md` S3 パス設計
- S3 バケット: `docs/02_基本設計書/03_インフラとDB設計.md` `ringiflow-{env}-documents`
- 開発環境: `infra/docker/docker-compose.yaml`（MinIO 追加）
- ワークフロー定義スキーマ: file フィールド型の不在を確認
- Elm ファイル API: `elm/file` パッケージの既存使用を Grep 確認
- Presigned URL: AWS SDK for Rust の S3 クライアント API

#### 17_ドキュメント管理設計.md の構成

1. **概要**: Phase 2-5 スコープ、要件（DOC-001, DOC-003）
2. **アーキテクチャ**:
   - シーケンス図（アップロード）: URL 発行要求 → Presigned URL 生成 → ブラウザ直接 PUT → 完了通知
   - シーケンス図（ダウンロード）: URL 要求 → Presigned URL 生成 → ブラウザ直接 GET
   - コンポーネント構成
3. **設計判断**: アップロード方式、S3 バケット構成、フォルダデータモデル、Elm UI 方式
4. **ローカル開発環境**: MinIO（Docker Compose 追加）
5. **API 設計**: 10 エンドポイント
   - ドキュメント: upload-url, confirm-upload, download-url, delete, list
   - フォルダ: create, update, delete, list
   - ワークフロー添付: attachments list
6. **データモデル**:
   - documents テーブル（tenant_id, folder_id, workflow_instance_id, s3_key, status）
   - folders テーブル（tenant_id, parent_id, path(materialized), depth CHECK <= 5）
7. **S3 パス設計**: `{tenant_id}/workflows/{instance_id}/{file_id}_{filename}`, `{tenant_id}/folders/{folder_id}/{file_id}_{filename}`
8. **Presigned URL セキュリティ**: 有効期限（5分/15分）、Content-Type/Length 制限
9. **ドメインロジック**: ファイルバリデーション、フォルダ操作ルール
10. **フロントエンド**: アップロードコンポーネント（D&D）、フォルダツリー、申請フォーム統合
11. **テスト観点**: ユニット（バリデーション）、ハンドラ（Presigned URL）、API（MinIO）、E2E（ファイル添付フロー）
12. **テナント退会削除対応**: documents/folders テーブル CASCADE、S3 プレフィックス削除

#### テストリスト: 該当なし（設計ドキュメント作成のみ）

ドキュメント品質検証:
- [ ] Presigned URL シーケンス図が完全（発行 → アップロード → 確認の 3 ステップ）
- [ ] S3 パス設計がテナント退会削除設計と整合
- [ ] RLS 対応テーブル（documents, folders）が含まれている
- [ ] 定義スキーマへの file フィールド型追加が記載
- [ ] MinIO の Docker Compose 設定方針が記載
- [ ] 削除レジストリへの登録が考慮されている

#### 操作パス
該当なし（操作パスが存在しない）

---

## Phase 4: Epic Issue 作成 + Story 分解

成果物: GitHub Issues（Epic 2 件 + Story）

#### 確認事項
- Issue 駆動開発: `docs/04_手順書/04_開発フロー/01_Issue駆動開発.md`
- ブランチ戦略: `docs/05_ADR/046_Story-per-PRブランチ戦略.md`
- 既存 Epic パターン: `gh issue list --label "type:epic" --state all` で構成確認

#### Epic 構成案

**Epic A: 通知機能（NOTIFY-001）** — 5 Story

| # | Story | 概要 |
|---|-------|------|
| 1 | 通知基盤 | trait 定義、テンプレートエンジン、Mailpit Docker |
| 2 | 承認依頼通知 | submit 時の通知送信、テンプレート |
| 3 | 承認完了/却下/差し戻し通知 | approve/reject/request_changes 時 |
| 4 | 通知送信ログ | notification_logs テーブル、マイグレーション、削除レジストリ |
| 5 | SES 連携 | AWS SDK 設定、Terraform SES、環境切替 |

**Epic B: ドキュメント管理（DOC-001, DOC-003）** — 7 Story

| # | Story | 概要 |
|---|-------|------|
| 1 | S3 基盤 | MinIO Docker、S3 クライアント、Presigned URL |
| 2 | ファイルアップロード API | エンドポイント、documents テーブル |
| 3 | ファイルダウンロード/削除 API | |
| 4 | フォルダ管理 API | folders テーブル、CRUD |
| 5 | ワークフロー申請ファイル添付 | 定義スキーマ拡張、フロントエンド統合 |
| 6 | ドキュメント管理フロントエンド | 一覧画面、フォルダツリー、アップロード UI |
| 7 | テナント退会削除対応 + Terraform | 削除レジストリ登録、S3 バケット定義 |

各 Epic に完了基準（実装ロードマップ準拠）とテスト責任マッピングを記載。

#### テストリスト: 該当なし（設計ドキュメント作成のみ）

ドキュメント品質検証:
- [ ] Story 単位で独立して PR 可能な粒度
- [ ] Story 間の依存関係が明示
- [ ] 完了基準が実装ロードマップ Phase 2-5 と整合
- [ ] 各 Story に完了基準が設定されている
- [ ] テスト責任マッピングが記載されている

#### 操作パス
該当なし（操作パスが存在しない）

---

## ブラッシュアップループの記録

| ループ | 検出したギャップ | 観点 | 対応 |
|-------|----------------|------|------|
| 1回目 | 通知ログの格納先が未定義。基本設計の DynamoDB notifications は user_id PK で Phase 2-5 の送信ログに不適 | 不完全なパス | PostgreSQL に notification_logs テーブルを追加。DynamoDB は Phase 3 アプリ内通知で使用 |
| 1回目 | ワークフロー定義スキーマに file フィールド型が不在 | 未定義 | 詳細設計に定義スキーマ拡張を記載 |
| 1回目 | テナント退会削除設計に documents, folders, notification_logs の追加が必要 | アーキテクチャ不整合 | 各詳細設計書に削除対応セクションを記載 |
| 1回目 | Mailpit / MinIO の Docker Compose 追加時、API テスト用環境にも反映必要 | 不完全なパス | 両 compose ファイルへの追加を明記 |
| 1回目 | `00_はじめに.md` に新規仕様書の追加が必要 | 既存手段の見落とし | Phase 1 テストリストに追加 |

## 収束確認（設計・計画）

| # | 観点 | 理想状態（To-Be） | 判定 | 確認内容 |
|---|------|------------------|------|---------|
| 1 | 網羅性 | 全成果物が計画に含まれている | OK | 機能仕様書 2 + 詳細設計書 2 + Epic/Story = 4 Phase に分割 |
| 2 | 曖昧さ排除 | 不確定な記述がゼロ | OK | 設計判断 10 件すべてに推奨案・理由記載。曖昧表現なし |
| 3 | 設計判断の完結性 | 全差異に判断が記載 | OK | SES方式、テンプレート、アップロード方式等すべてに判断あり |
| 4 | スコープ境界 | 対象と対象外が明記 | OK | 各仕様書に非ゴール、計画全体の対象外を明示 |
| 5 | 技術的前提 | 前提が考慮されている | OK | Mailpit, MinIO, Presigned URL, Elm File API 確認済み |
| 6 | 既存ドキュメント整合 | 矛盾がない | OK | ロードマップ、テナント退会設計、基本設計と照合済み |

## 検証方法

- `just check-all` が通ること（ドキュメント変更のみなのでテスト影響なし）
- 機能仕様書が `00_はじめに.md` のテンプレート構造に準拠していること
- 詳細設計書が `15_ワークフローデザイナー設計.md` の構成パターンに準拠していること
- 各設計判断に推奨案・代替案・理由が記載されていること

## 参照ファイル

| ファイル | 用途 |
|---------|------|
| `docs/01_要件定義書/機能仕様書/00_はじめに.md` | 機能仕様書テンプレート |
| `docs/01_要件定義書/機能仕様書/04_ワークフローデザイナー.md` | 最新の機能仕様書パターン |
| `docs/03_詳細設計書/15_ワークフローデザイナー設計.md` | 最新の詳細設計書パターン |
| `docs/03_詳細設計書/06_テナント退会時データ削除設計.md` | S3 パス設計、削除対象 |
| `docs/03_詳細設計書/00_実装ロードマップ.md` | Phase 2-5 スコープ・完了基準 |
| `docs/02_基本設計書/03_インフラとDB設計.md` | S3 バケット構成、DynamoDB 設計 |
| `backend/crates/domain/src/workflow/instance.rs` | WorkflowInstanceStatus（通知トリガー） |
| `docs/01_要件定義書/01_コア要件.md` | NOTIFY-001, DOC-001, DOC-003 要件 |
