# 調査記録（Investigation Record）体系の構築

## Context

トラブルシューティング時の仮説/検証結果を「証跡」として残す形式知体系が存在しない。

現在の `troubleshooting.md` は仮説追跡表のフォーマットを定義しているが、「会話内にインラインで記録する」と書かれており、永続化先が未定義。散弾銃デバッグ改善記録（`2026-02-20_0012`）の「系統的アプローチの適用結果」セクションが調査記録のプロトタイプとして存在するが、これを正式な文書体系として確立する。

### 目的

1. 監査証跡（Audit trail）: 修正に至った根拠を後から追跡できるようにする。散弾銃デバッグの防止ゲートとしても機能
2. 知識の再利用: 同種の問題が再発した場合の参照資料。診断パターンを蓄積する

## 対象

- `process/investigations/README.md` の新規作成
- `.claude/rules/troubleshooting.md` の更新（仮説追跡セクションに調査記録への参照を追加）
- `CLAUDE.md` の更新（ドキュメント自動作成ルールに追加）
- `.claude/skills/wrap-up/prompt.md` の更新（チェックリストに追加）

## 対象外

- テンプレートファイルの作成（README.md 内にテンプレートを記載する。改善記録と同じパターン）
- 既存の改善記録の書き換え（既存記録はそのまま維持）
- ナレッジベースへの自動抽出の仕組み（将来検討）

## 設計判断

### 1. 文書の位置づけをどうするか

調査記録は「プロセス記録」（process/）と「ドキュメント」（docs/）のどちらに配置すべきか。

| 案 | 位置 | メリット | デメリット |
|----|------|---------|-----------|
| **process/investigations/（採用）** | 運用記録 | 改善記録と同列で自然。時系列管理が適切 | docs/ と分散 |
| docs/80_ナレッジベース/ | 知識体系 | 知識の再利用に最適化 | 時系列管理が合わない。粒度が異なる |
| prompts/runs/ に統合 | セッションログ | 新ディレクトリ不要 | セッションログの「軽量な証跡」という性質と矛盾 |

採用理由: 調査記録は「特定の問題に対する調査の証跡」であり、改善記録と同じ「プロセス記録」の性質。時系列で月別管理するのが自然。汎用知識はナレッジベースに抽出する二段構成とする。

### 2. 作成トリガーの閾値をどうするか

| 案 | 閾値 | メリット | デメリット |
|----|------|---------|-----------|
| **仮説検証 2 回以上（採用）** | troubleshooting.md と一致 | 既存ルールと整合。最小限の負担で最大の効果 | 軽微な 2 回検証でもトリガーされる |
| 仮説検証 3 回以上 | より厳選 | 本当に複雑な調査のみ記録 | 2 回で解決した有用なケースを取りこぼす |
| 全てのトラブルシューティング | 網羅的 | 完全な証跡 | オーバーヘッドが大きい |

採用理由: `troubleshooting.md` が既に「2 回以上の試行に及ぶ場合、仮説の追跡を行う」と定義しており、この閾値と一致させる。仮説追跡を行ったら、その結果を調査記録として永続化するという自然な流れ。

### 3. セッションログとの関係をどうするか

| 案 | 関係 | メリット | デメリット |
|----|------|---------|-----------|
| **セッションログからリンク（採用）** | 独立文書 + 相互参照 | 各文書の責務が明確。セッションログは軽量のまま | 2 つの文書を管理 |
| セッションログに統合 | 判断ログの拡張 | 管理が一元化 | セッションログの「軽量な証跡」という性質が崩れる |

採用理由: セッションログの README は「Slack のチャット履歴と同程度の軽量な記録」と明言している。調査の詳細な証跡はこの軽量さと矛盾するため、独立文書とし、セッションログからリンクする。

## Phase 1: 調査記録の基盤構築

### 作成ファイル

`process/investigations/README.md`

### 記載内容

1. 目的（監査証跡 + 知識の再利用）
2. 作成トリガー（仮説検証 2 回以上）
3. ディレクトリ構造（`YYYY-MM/` 月別管理、改善記録と同じパターン）
4. ファイル命名規則（`YYYY-MM-DD_HHMM_<トピック>.md`）
5. テンプレート
6. 他文書との関係

### テンプレート構成

```markdown
# <問題のタイトル>

関連: #<Issue/PR 番号>（該当する場合）

## 症状

<事実のみ記載。解釈を加えない>

- エラーメッセージ:
- 発生タイミング:
- 影響範囲:

## 環境

| 項目 | 値 |
|------|-----|
| ブランチ | |
| 実行環境 | ローカル / CI |
| 関連コミット | |

## 仮説と検証

| # | 仮説 | 予測（正しければ何が観察されるか） | 検証手段 | 結果 | 判定 |
|---|------|--------------------------------|---------|------|------|
| 1 | | | | | 支持/棄却 |

### 仮説 N: <仮説名>

予測: ...
検証手段: ...

検証データ:
```
<実際の出力 / ログ / スクリーンショットパス>
```

判定: 支持 / 棄却 / 不明確
理由: ...

## 切り分け（Isolate）

<問題の局在化の手順と結果。該当する場合のみ>

| 確認レイヤー | 確認手段 | 結果 |
|------------|---------|------|
| | | 正常 / 異常 |

## 根本原因

<特定された根本原因>

### 因果関係

<Mermaid flowchart: 原因から症状への因果連鎖。該当する場合のみ>

## 修正と検証

修正内容: ...
検証結果: ...

## 診断パターン（Knowledge）

<今後同種の問題が発生した場合の診断のヒント>

- 症状「...」が見られたら、まず ... を確認する
- ...

## 関連ドキュメント

- セッションログ: [...]
- 改善記録: [...]（プロセス改善に至った場合）
```

### 確認事項

- [x] 改善記録 README.md のディレクトリ構造・命名規則パターンを参照 → `YYYY-MM/YYYY-MM-DD_HHMM_<トピック>.md`、月別サブディレクトリ
- [x] セッションログ README.md の「軽量な証跡」の位置づけを確認 → 「Slack のチャット履歴と同程度」
- [x] troubleshooting.md の仮説追跡セクションの現在の文言 → 「会話内にインラインで記録する」が永続化先不明

### テストリスト

ユニットテスト（該当なし）
ハンドラテスト（該当なし）
API テスト（該当なし）
E2E テスト（該当なし）

## Phase 2: 既存システムとの統合

### 2.1 troubleshooting.md の更新

「仮説追跡（成果物要件）」セクションに以下を追加:
- 仮説追跡を行ったら、解決後に**調査記録**として永続化する
- 調査記録の配置先とテンプレートへの参照

変更箇所: `.claude/rules/troubleshooting.md` L106-120 付近

### 2.2 CLAUDE.md の更新

「ドキュメント自動作成ルール」に以下を追加:
- **調査記録** — 仮説検証 2 回以上のトラブルシューティング（→ `process/investigations/`）

変更箇所: `CLAUDE.md` の「ドキュメント自動作成ルール」セクション

### 2.3 wrap-up スキルの更新

Step 2 のチェックリストテーブルに「調査記録」行を追加:
- 作成条件: 仮説検証 2 回以上のトラブルシューティングがあった
- 配置先: `process/investigations/YYYY-MM/`

Step 3 に調査記録の作成手順を追加:
- README.md のテンプレートに従って作成
- セッション中の仮説追跡表を転記し、検証データを補完
- 「診断パターン」セクションで知識を抽出

変更箇所: `.claude/skills/wrap-up/prompt.md`

### 確認事項

- [x] CLAUDE.md のドキュメント自動作成ルールの現在のリスト → ADR / ナレッジベース / セッションログ / 実装解説 / 操作レシピ / 改善記録 の 6 種
- [x] wrap-up スキルの Step 2 テーブル形式 → `| ドキュメント | 作成条件 | 配置先 |`

### テストリスト

ユニットテスト（該当なし）
ハンドラテスト（該当なし）
API テスト（該当なし）
E2E テスト（該当なし）

## 検証方法

1. 作成した `process/investigations/README.md` のテンプレートが、散弾銃デバッグ改善記録の「系統的アプローチの適用結果」セクションの情報を包含できることを確認する
2. `troubleshooting.md` の更新が既存の調査フローと矛盾しないことを確認する
3. `just check-all` で品質ゲート通過を確認する（ドキュメントリンクチェック含む）

## ブラッシュアップループの記録

| ループ | 検出したギャップ | 観点 | 対応 |
|-------|----------------|------|------|
| 1回目 | テンプレートの「切り分け」セクションが必須だと全ての調査に強制される | 曖昧さ排除 | 「該当する場合のみ」と明記し、必須セクションと任意セクションを区別 |
| 2回目 | 「診断パターン」セクションの粒度が不明確 | 既存手段の見落とし | troubleshooting.md の「よくあるパターンと確認手段」テーブルとの関係を明確化。調査記録の診断パターンが蓄積されたら troubleshooting.md に昇格させる運用を記載 |
| 3回目 | 既存の改善記録との重複リスク | スコープ境界 | 改善記録は「プロセスの問題と対策」、調査記録は「技術的な調査の証跡」。同一事象で両方作成する場合の関係性を README に明記 |

## 収束確認（設計・計画）

| # | 観点 | 理想状態（To-Be） | 判定 | 確認内容 |
|---|------|------------------|------|---------|
| 1 | 網羅性 | 必要な変更が全て計画に含まれている | OK | README 新規作成 + troubleshooting.md + CLAUDE.md + wrap-up の 4 ファイル。調査記録のライフサイクル（作成トリガー → テンプレート → 永続化 → 既存文書との接続）がカバーされている |
| 2 | 曖昧さ排除 | 不確定な記述がゼロ | OK | テンプレートの各セクションに必須/任意を明記。作成トリガー（2 回以上）が数値で確定 |
| 3 | 設計判断の完結性 | 全ての差異に判断が記載されている | OK | 配置先（process/ vs docs/）、閾値（2 回 vs 3 回 vs 全て）、セッションログとの関係の 3 つの設計判断を記載 |
| 4 | スコープ境界 | 対象と対象外が明記されている | OK | 対象（4 ファイル）と対象外（テンプレートファイル分離、既存書き換え、ナレッジベース自動抽出）を記載 |
| 5 | 技術的前提 | コードに現れない前提が考慮されている | OK | ドキュメント変更のみ。doc-links.sh によるリンクチェックを検証方法に記載 |
| 6 | 既存ドキュメント整合 | 既存ドキュメントと矛盾がない | OK | troubleshooting.md の「2 回以上の試行」、セッションログ README の「軽量な証跡」、改善記録の「問題の性質 routing table」と整合 |
