# #315 AI駆動開発プロセスの観測可能性向上

## Context

AI駆動開発の品質改善サイクルをデータ駆動で回すために、思考プロセスの観測可能性を高める。

改善記録33件の分析から、AIの思考に6つの構造的特性（クセ）があり、対策の有効性に「行動規範 < 成果物要件」という明確な序列があることが確認された。設計段階はブラッシュアップループで観測可能性が高いが、実装段階の判断プロセスは暗黙知のまま消えている。

## 設計判断

### 記録の場所: セッションログの拡張（既存の成果物に統合）

選択肢:

| 案 | メリット | デメリット |
|----|---------|----------|
| A. セッションログに新セクション追加 | 既存の成果物要件に統合、追加コスト最小 | wrap-up 時に記憶を頼る必要 |
| B. Issue コメントにリアルタイム記録 | リアルタイム、低コスト | 散在して分析困難 |
| C. 専用の判断ログファイル（新規） | 構造化しやすい | 新ファイル体系の追加、管理コスト |
| D. PR Self-review セクション拡張 | 既存の成果物 | squash merge で本文が長大化 |

**A を選択。** 理由:
- セッションログは `/wrap-up` で作成される「成果物要件」。新セクション追加で構造的強制が効く
- wrap-up 時の記憶の問題は、コミットメッセージやコード diff を手がかりにすれば復元可能（設計判断セクションと同様）
- 既存のファイル体系・ワークフローへの影響が最小

### 記録の粒度: 判断ポイントのみ（全判断の記録ではない）

記録すべきもの（1セッションあたり 3-5 件想定）:

| 種別 | 何を記録するか | 例 |
|------|--------------|-----|
| 設計修正 | Refactor で構造・設計を変更した判断 | 「メソッド分割ではなく trait 抽出を選択」 |
| 軌道修正 | 方向転換した判断 | 「Phase 3 で API 設計を見直し」 |
| ルール適用 | ルール/チェックリストが問題を防いだケース | 「収束確認で型安全性の不足を発見」 |
| 発見 | 予期しない知見 | 「axum の State ジェネリクスの波及を発見」 |

記録しないもの:
- 定型的なコーディング判断（変数名の選択など）
- テストの追加・修正（テストリストで管理済み）
- 既に「設計上の判断」セクションで記録されるもの（重複回避）

### 改善記録の分類体系: 6カテゴリ + 3タイプ

33件の分析で特定した6つの AI 構造的特性をカテゴリとして定義:

| カテゴリ | 説明 |
|---------|------|
| 参照漏れ | ドキュメント/手順が存在するが参照されなかった |
| 単一パス検証 | 1回の確認で完全と考え、複数ループを省略 |
| 即座の対策 | 深く考えずに対策を提示 |
| 視点不足 | 複数視点の同時把握ができていない |
| コンテキスト引きずり | 前の会話/作業の文脈を不適切に持ち越し |
| 知識-実行乖離 | 情報は存在するが使用フローに組み込まれていない |

失敗タイプ（根本原因の分類）:

| タイプ | 説明 |
|-------|------|
| 知識ギャップ | 情報自体を知らなかった |
| 実行ギャップ | 知っていたが実行しなかった |
| プロセスギャップ | プロセス自体が不十分だった |

### 定期分析: 改善記録のマイルストーン分析

分析のトリガー:
- 改善記録が 10 件追加されるごと
- または月次（月末の wrap-up 時）

分析内容:
- カテゴリ別の件数推移（パターンの変化）
- 対策の有効性（同カテゴリの再発率）
- ルール有効性の確認（適用されたルールが問題を防いだ件数）

## 対象・対象外

対象:
- セッションログの判断ログセクション追加
- 改善記録の分類・検証セクション追加
- wrap-up スキルの更新
- 定期分析ガイドの作成

対象外:
- 自動化ツール（分析スクリプト等）の作成
- メトリクスダッシュボード
- 新しいディレクトリ体系の追加
- CLAUDE.md の変更（ルール追加は必要ない。既存の成果物要件を拡張するだけ）

## 実装計画

### Phase 1: セッションログの判断ログセクション

変更ファイル: `prompts/runs/README.md`

セッション記録の構成テーブルに「判断ログ」を追加。以下のフォーマットで記載:

```markdown
## 判断ログ

実装中の判断ポイントを記録する。設計上の判断（Why）はそのまま「設計上の判断」セクションに記載し、ここでは実装中の in-action な判断を記録する。

| 種別 | 判断 | 背景 |
|------|------|------|
| 設計修正 | メソッド分割ではなく trait 抽出を採用 | Refactor で責務を見直した結果 |
| ルール適用 | 収束確認で型安全性の不足を発見・修正 | チェックリスト項目3 |
```

「設計上の判断」との棲み分け:
- 設計上の判断: 設計フェーズで行った Why レベルの意思決定（既存）
- 判断ログ: 実装中に行った in-action な判断（新規）

判断ログが空のセッション（定型作業、議論なし）は「特筆すべき判断なし」と記載。

### Phase 2: 改善記録の分類・検証セクション

変更ファイル: `prompts/improvements/README.md`

#### 2a. 分類セクション

記載内容に「5. 分類」を追加:

```markdown
## 記載内容

1. 事象: 何が起きたか
2. 原因分析: なぜ起きたか
3. 対策: どう改善するか
4. 次のアクション: 具体的な作業項目
5. 分類: カテゴリと失敗タイプ（後述）
```

分類テーブルの定義を README に追加:

```markdown
## 分類

改善記録には以下の分類を付与する。分析・傾向把握に使用する。

### カテゴリ（AI 構造的特性）

| カテゴリ | 説明 | 例 |
|---------|------|-----|
| 参照漏れ | ドキュメント/手順が存在するが参照されなかった | Issue駆動フロー未遵守 |
| 単一パス検証 | 1回の確認で完全と考え、複数ループを省略 | 計画段階での網羅性不足 |
| 即座の対策 | 深く考えずに対策を提示 | 目先の対策に飛びつく傾向 |
| 視点不足 | 複数視点の同時把握ができていない | E2E視点の完了基準欠如 |
| コンテキスト引きずり | 前の会話/作業の文脈を不適切に持ち越し | 会話コンテキストのドキュメント混入 |
| 知識-実行乖離 | 情報は存在するが使用フローに組み込まれていない | CI Action許可設定漏れ |

### 失敗タイプ

| タイプ | 説明 |
|-------|------|
| 知識ギャップ | 情報自体を知らなかった |
| 実行ギャップ | 知っていたが実行しなかった |
| プロセスギャップ | プロセス自体が不十分だった |
```

記載例:

```markdown
## 分類

- カテゴリ: 参照漏れ
- 失敗タイプ: 実行ギャップ
```

#### 2b. 検証セクション

記載内容に「6. 検証」を追加。対策を実行した後に追記する:

```markdown
## 検証（対策実行後に追記）

- 実施日: YYYY-MM-DD
- 対策の実行状況: [実行済み / 部分的 / 未実行]
- 効果: [同種の問題が再発していないか]
- 備考: [対策の調整が必要な場合はここに記載]
```

注意: 検証セクションは対策実行時に追記するもの。改善記録作成時点では空または省略。

### Phase 3: wrap-up スキルの更新

変更ファイル: `.claude/skills/wrap-up/SKILL.md`

Step 1（作業内容の振り返り）の観点に追加:

```
- 実装中に判断ポイントがあったか（設計修正、軌道修正、ルール適用、発見）
```

Step 3 セッションログの構成に「判断ログ」を追加:

```
3. 構成に従って作成: 概要 → 背景と目的 → 実施内容 → 設計上の判断 → 判断ログ → 成果物 → 議論の経緯 → 学んだこと → 発見した問題 → 次のステップ
```

### Phase 4: 定期分析ガイド

新規ファイル: `docs/06_ナレッジベース/methodology/AI思考特性の分析ガイド.md`

内容:
1. 分析の目的と位置づけ
2. 分析のトリガー（10件追加 or 月次）
3. 分析手順
   - 改善記録のカテゴリ別集計
   - 失敗タイプ別集計
   - 時系列トレンド
   - 対策の有効性評価（検証セクションの集約）
   - セッションログの判断ログからのパターン抽出
4. 分析結果の活用
   - ルール改善へのフィードバック
   - #302 (ルール引退メカニズム) への入力
5. 既知手法との関連
   - SPC (Statistical Process Control) の考え方
   - メトリクス駆動改善

## 検証方法

1. 変更した README が既存のフォーマット・規約に整合しているか
2. wrap-up スキルが既存のステップと矛盾なく更新されているか
3. 定期分析ガイドが methodology-design.md の方針に従っているか
4. 実際のセッションで判断ログを記録してみて、コストが許容範囲か（次回のセッションで検証）

## ブラッシュアップループの記録

| ループ | きっかけ | 調査内容 | 結果 |
|-------|---------|---------|------|
| 1回目 | 初版完成 → 記録場所の選択 | セッションログ/Issue コメント/新規ファイル/PR を比較 | セッションログ拡張を選択（成果物要件として最もコスト低） |
| 2回目 | 「設計上の判断」との重複 | 既存セッションログの「設計上の判断」セクションを確認 | 棲み分けを明確化: 設計上の判断=Why、判断ログ=in-action |
| 3回目 | 改善記録の分類粒度 | 33件分析の6カテゴリを再検証、失敗タイプとの直交性を確認 | 6カテゴリ+3タイプの二軸分類を採用 |
| 4回目 | 対象外の明確化 | CLAUDE.md への影響、新ディレクトリの要否を検討 | CLAUDE.md 変更不要（既存成果物の拡張のみ）、新ディレクトリ不要 |

## 収束確認（設計・計画）

| # | 観点 | 判定 | 確認内容 |
|---|------|------|---------|
| 1 | 網羅性 | OK | Issue #315 の完了基準5項目すべてに対応する Phase がある。記録の仕組み(Ph1)、成果物要件化(Ph1,3)、記録コスト最小化(Ph1の粒度設計)、分析方法(Ph4)、フィードバックループ(Ph4) |
| 2 | 曖昧さ排除 | OK | 判断ログの種別4つ、分類カテゴリ6つ、失敗タイプ3つが具体的に定義されている。「判断ポイント」の記録/非記録の基準を明示 |
| 3 | 設計判断の完結性 | OK | 記録場所（4案比較→A選択）、粒度（記録/非記録の基準）、既存セクションとの棲み分け、分類体系（二軸）の判断理由を記載 |
| 4 | スコープ境界 | OK | 対象4項目・対象外4項目を明記 |
| 5 | 技術的前提 | OK | 全変更が Markdown ファイルの編集のみ。ツール仕様の前提なし |
| 6 | 既存ドキュメント整合 | OK | methodology-design.md の「既知手法を地図として活用」方針に従い分析ガイドに既知手法との関連を記載。docs.md のフォーマット規約に準拠 |
