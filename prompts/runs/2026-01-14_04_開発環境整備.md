# 開発環境整備

## 概要

bun から pnpm への移行、テスト環境の整備（pretty_assertions）、リリースプロファイルの設定、バージョン表記の統一を実施した。

## 背景と目的

パッケージマネージャーを bun から pnpm に変更したため、関連箇所の更新が必要だった。また、テストの可読性向上とリリースビルドのデバッグ容易性を改善するための設定を追加した。

## 実施内容

### 1. bun → pnpm 移行

以下のファイルで bun を pnpm に置換:
- `.github/workflows/ci.yml`
- `.github/dependabot.yml`
- `justfile`
- `docs/03_手順書/` 配下の各ドキュメント

### 2. テスト環境整備

- `pretty_assertions` を workspace に追加
- 全パッケージの dev-dependencies に設定
- テストコードで `use pretty_assertions::{assert_eq, assert_ne}` を追加

### 3. リリースプロファイル設定

```toml
[profile.release]
overflow-checks = true
debug = "line-tables-only"
strip = "none"
```

- `overflow-checks`: 整数オーバーフローを検出
- `debug = "line-tables-only"`: スタックトレースに行番号を含める
- `strip = "none"`: デバッグ情報を保持

### 4. バージョン表記の統一

| 項目 | バージョン |
|------|-----------|
| Rust | 1.92.0 |
| rustfmt | 1.9.0-stable |
| clippy | 0.1.92 |
| Node.js | 22 LTS (22.16.0) |
| pnpm | 10 |
| Elm | 0.19.1 |

## 成果物

### 更新したファイル

- `Cargo.toml` (workspace) - pretty_assertions、profile.release
- `apps/api/Cargo.toml` - pretty_assertions
- `apps/web/package.json` - format:check スクリプト、Volta 設定
- `apps/web/README.md` - Node.js バージョン
- `packages/*/Cargo.toml` - pretty_assertions
- `packages/shared/src/correlation_id.rs` - pretty_assertions 使用
- `justfile` - pnpm コマンド
- `docs/02_設計書/01_プロジェクト構造設計.md` - Rust バージョン
- `docs/03_手順書/*.md` - バージョン表記、pnpm コマンド

## 設計判断と実装解説

### profile.release の設定

**意図**: 本番環境でもエラー発生時の原因調査を容易にする。

| 設定 | 値 | 理由 |
|------|---|------|
| `overflow-checks` | `true` | 整数オーバーフローは本番でも検出すべきバグ |
| `debug` | `"line-tables-only"` | スタックトレースに行番号を含めつつ、バイナリサイズ増加を抑制 |
| `strip` | `"none"` | debug 情報を保持するため、strip しない |

`debug = "full"` ではなく `"line-tables-only"` を選択した理由:
- 完全なデバッグ情報はバイナリサイズを大幅に増加させる
- 行番号があればスタックトレースで原因箇所を特定できる
- 変数の値などは本番ログで確認する設計

### Node.js バージョンの選定

elm-test は古い JavaScript の書き方を使用しているため、新しい Node.js バージョンとの互換性が懸念された。しかし、Node.js 24 で elm-test が正常動作することを確認し、Node.js 22 LTS を採用した。

## ユーザープロンプト（抜粋）

> pretty_assertions を workspace に追加して、テストで使わせてください。

> debuginfo を追加したいです。少なくともエラーが起きたときに原因調査に手間取らないくらいの情報は欲しいです。

> strip とは何ですか？

> strip = "none" を明示してください。

> Node.js のバージョンは elm 関連が問題なく動く方にしてください。

> 問題ない範囲で各バージョンを最新にしてください。

## 学んだこと

1. **Cargo の profile 設定**: `debuginfo` ではなく `debug` がキー名。ワークフローの警告で発覚。

2. **strip と debug の関係**: `strip` を設定すると `debug` で生成した情報も削除される。両方を有効にする場合は `strip = "none"` が必要。

3. **elm-test の互換性**: Node.js 24 でも動作確認できた。以前の問題は限定的だった可能性がある。
