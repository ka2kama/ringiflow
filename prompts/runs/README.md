# prompts/runs/

このディレクトリには、AI エージェントとのセッション記録を保存する。

## ディレクトリ構造

月ごとのサブディレクトリに整理する。

```
prompts/runs/
├── YYYY-MM/
│   ├── YYYY-MM-DD_HHMM_<トピック>.md
│   └── ...
└── README.md
```

例: `prompts/runs/2026-01/2026-01-17_0930_Phase0_Elm構築.md`

## ファイル命名規則

```
YYYY-MM-DD_HHMM_<トピック>.md
```

- `HHMM`: セッションの最初のコミット時刻（24時間形式、例: `0930`, `1415`）
- `<トピック>`: セッションの主題（例: `Phase0_Elm構築`）

時刻の取得方法:
```bash
git log --format="%ci" --reverse <branch> --not main | head -1
# 出力例: 2026-01-22 11:08:10 +0900 → HHMM = 1108
```

コミット時刻を使う理由:
- セッション開始時刻は曖昧で推測になりがち
- コミット時刻は `git log` で正確に取得・検証できる

## セッション記録の構成

| セクション | 内容 |
|-----------|------|
| 概要 | セッションで達成したことの要約 |
| 背景と目的 | なぜこの作業が必要だったか、セッションの発端 |
| 実施内容 | 具体的な作業内容 |
| 設計上の判断 | 主要な設計判断の一覧（該当する場合） |
| 判断ログ | 実装中の判断ポイント（該当する場合） |
| 成果物 | コミット、作成/更新ファイル |
| 議論の経緯 | ユーザーとの議論・質疑応答の流れを要約 |
| 学んだこと | セッションで得た知見 |
| 発見した問題 | 未解決の問題や調査事項（該当する場合） |
| 次のステップ | 今後の作業（該当する場合） |

## 判断ログの記載ルール

### 目的

実装中に行った判断（in-action）を記録し、AI の思考プロセスの観測可能性を高める。蓄積された記録はパターン分析に使用する。

### 「設計上の判断」との棲み分け

| セクション | 対象 | タイミング | 例 |
|-----------|------|-----------|-----|
| 設計上の判断 | Why レベルの意思決定 | 設計フェーズ | 「既存エンドポイント拡張 vs 新規エンドポイント」 |
| 判断ログ | in-action な判断 | 実装フェーズ | 「Refactor で trait 抽出を採用」「収束確認で型安全性の不足を発見」 |

### 種別

| 種別 | 記録するもの | 例 |
|------|------------|-----|
| 設計修正 | Refactor で構造・設計を変更した判断 | 「メソッド分割ではなく trait 抽出を選択」 |
| 軌道修正 | 方向転換した判断 | 「Phase 3 で API 設計を見直し」 |
| ルール適用 | ルール/チェックリストが問題を防いだケース | 「収束確認で型安全性の不足を発見」 |
| 発見 | 予期しない知見 | 「axum の State ジェネリクスの波及を発見」 |

### 記載フォーマット

```markdown
## 判断ログ

| 種別 | 判断 | 背景 |
|------|------|------|
| 設計修正 | メソッド分割ではなく trait 抽出を採用 | Refactor で責務を見直した結果 |
| ルール適用 | 収束確認で型安全性の不足を発見・修正 | チェックリスト項目3 |
```

### 記録しないもの

- 定型的なコーディング判断（変数名の選択など）
- テストの追加・修正（テストリストで管理済み）
- 既に「設計上の判断」セクションで記録されるもの（重複回避）

### 判断がないセッション

定型作業や軽微な修正で判断ポイントがない場合は「特筆すべき判断なし」と記載する。

### 記録のタイミング

判断ログは判断が行われた時点で即座に記録する（wrap-up での振り返り時ではない）。

判断時のコンテキスト（検討した選択肢、棄却理由、違和感の正体）は時間が経つと失われるため、リアルタイムに記録することで情報の損失を防ぐ。

フロー:

1. セッション中、最初の判断ポイントが発生した時点でセッションログファイルを作成し、判断ログセクションに記入する
2. 以降の判断ポイントは都度追記する
3. `/wrap-up` 時に、残りのセクション（概要、背景と目的、成果物、学んだこと等）を仕上げる

```bash
# セッションログのファイル名に使う初回コミット時刻の取得
git log --format="%ci" --reverse HEAD --not main | head -1
```

注意: 判断ログ以外のセクション（概要、成果物など）はセッション完了後に書く方が正確なため、wrap-up 時に記載する。

## 議論の経緯の記載ルール

### 目的

セッション中にどのような議論・質疑応答があったかを、後から読んでも流れが分かるように要約する。

### 形式

トピックごとに見出しを付け、議論の流れを要約する。

```markdown
## 議論の経緯

### credentials の保存先

ユーザーに保存先の選択肢を提示し、「DB 分離（auth スキーマ）」を選択。
理由として、運用のシンプルさと将来の DB 分離への移行パスの両立を挙げた。

### サーキットブレーカーのスケーラビリティ

ユーザーから、メモリに状態を持つとスケールアウト時に問題があるのではないかという懸念が出た。
3つの方式（インスタンス単位、Redis 共有、ハイブリッド）を比較検討し、
シンプルさを優先してインスタンス単位を採用。ADR-020 として文書化した。
```

### 記載するもの

- 設計判断に至った議論
- 技術的な質問と回答
- 問題の発見と解決の経緯
- ユーザーからの指摘と対応

### 省略するもの

- 単純な応答（「はい」「続けて」など）
- 定型作業の指示
- 技術的判断に関係しない雑談

## サニタイズ規則

セッションログは GitHub で公開されるため、以下の規則に従ってサニタイズする。

### 省略または伏せ字にする

| 対象 | 処理 |
|------|------|
| 認証情報（鍵、トークン、パスワード） | 完全に省略 |
| 個人を特定できる情報 | 省略または一般化 |
| 社内 URL、内部システム名 | 伏せ字（`[内部URL]`、`[システム名]`） |

### 表現を変換する

| 対象 | 処理 |
|------|------|
| カジュアルすぎる表現 | 丁寧語に整形（下記「校正例」参照） |
| 感情的・主観的な発言 | 技術的な内容に要約、または省略 |
| 文脈がないと誤解されうる発言 | 文脈を補足するか省略 |

#### 校正例

| 元の発言 | 校正後 |
|---------|-------|
| 「この辺の知見はプロダクト固有でない部分もあるとおもうので」 | 「これらの知見は一般的なものなので」 |
| 「どうとでもなる」 | 「柔軟に対応できる」 |
| 「おもう」 | 「思う」 |

### 表記を校正する

| 対象 | 処理 |
|------|------|
| 誤字・脱字 | 正しい表記に修正 |
| 漢字の誤り | 正しい漢字に修正 |
| 不要なひらがな | 漢字で書くべき箇所は漢字に修正 |
| 表記揺れ | 文書内で統一 |

### 議論の経緯の取捨選択

「省略するもの」セクションに加え、以下も省略する:

- 雑談、私的な発言
- 感情表現（不満、愚痴など）
- 技術的判断に関係しない指示

**原則:** 技術的な学びに繋がる内容のみを記載する。

