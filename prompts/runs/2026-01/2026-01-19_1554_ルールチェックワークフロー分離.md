# 2026-01-19_06 ルールチェックワークフロー分離

## 概要

Claude Auto Review からルール準拠チェックを分離し、専用のワークフロー `claude-rules-check.yml` を新設した。

## 背景と目的

### 問題提起

既存の Auto Review ワークフローに以下の責務が集中していた:

1. バグ・正確性のチェック
2. セキュリティチェック
3. パフォーマンスチェック
4. 型システムの活用チェック
5. テストの有無チェック
6. 設計チェック
7. ルール準拠チェック
8. 学習機会の提供

「1つのワークフローに責務を詰め込みすぎている」という懸念があり、特に「レビューの見落としがあるかどうかを判断できない」という問題があった。

### 解決方針

責務を分離し、「何がチェックされたか」を明確にする:

- ルールチェックが完了 → 明確に分かる
- コードレビューが完了 → 明確に分かる

## 実施内容

### 1. 設計の検討

3つの分離案を比較:

| 案 | 説明 | 採用 |
|---|------|------|
| 案1: 直列実行 | Rules Check → Code Review | ❌ |
| 案2: 並列実行 | 両方を同時に実行 | ✅ |
| 案3: 観点分離 | 各観点を完全に独立したワークフローに | ❌ |

案2（並列実行）を採用した理由:
- 実装がシンプル
- 実行時間が増えない
- 片方が失敗しても、もう片方の結果は見れる

### 2. 実装

新しいワークフローを作成し、既存ワークフローからルールチェック部分を削除:

```
CI Success
├─→ Claude Rules Check    # 新規: ルール準拠のみ
└─→ Claude Auto Review    # 既存: コード品質・設計
```

### 3. 手順書の更新

`docs/60_手順書/02_プロジェクト構築/03_GitHub設定.md` を更新:
- ワークフロー構成の説明を追加
- Ruleset の Status Check に `Claude Rules Check` を追加

## 成果物

### 変更ファイル

| ファイル | 変更内容 |
|----------|----------|
| `.github/workflows/claude-rules-check.yml` | 新規作成 |
| `.github/workflows/claude-auto-review.yml` | ルールチェック部分を削除、責務分離の説明追加 |
| `docs/60_手順書/02_プロジェクト構築/03_GitHub設定.md` | ワークフロー構成の説明を追加 |

### PR

- [#90 refactor(ci): ルールチェックを別ワークフローに分離](https://github.com/ka2kama/ringiflow/pull/90)

## 設計判断と実装解説

### 責務分離のメリット

1. 観測可能性の向上: PR に2つの独立したステータスが表示される
2. 問題の切り分けが容易: どちらのチェックで問題が発生したか明確
3. 将来の拡張性: 片方だけ無効化、設定変更が可能

### max-turns の設定

| ワークフロー | max-turns | 理由 |
|-------------|-----------|------|
| Rules Check | 20 | ルールファイルの読み取りと単純なチェックのみ |
| Auto Review | 40 | 詳細なコード分析と学習機会の提供 |

### 並列実行の実現

両ワークフローは同じトリガー条件を持つ:

```yaml
on:
  workflow_run:
    workflows: ["CI"]
    types:
      - completed
```

GitHub Actions は同じイベントでトリガーされる複数のワークフローを並列実行する。

## 議論の経緯

### 責務過多の懸念

ユーザーから、1つの Review ワークフローに責務を詰め込みすぎていないだろうかという懸念が示された。

### 見落とし検出の困難さ

見落としが出ているかどうかを判断できないという問題が指摘された。チェック完了を保証する方が現実的なアプローチであるという方針が確認された。

### 分離の方針決定

ルールチェックを分離して「完了」を明確にする方向で進めたいという方針が示され、並列実行によるワークフロー分離を実施した。

## 学んだこと

- 「見落としを検出する」より「チェック完了を保証する」方が現実的なアプローチ
- 責務分離は観測可能性の向上にも寄与する
- 並列実行により、分離してもパフォーマンスへの影響を最小化できる
