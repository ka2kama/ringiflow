# 楽観的ロック TOCTOU 修正

## 日時

2026-01-29

## 概要

Issue #157 に対応し、`WorkflowInstanceRepository` と `WorkflowStepRepository` の楽観的ロックにおける TOCTOU（Time-of-Check-Time-of-Use）脆弱性を修正した。UPSERT パターンを INSERT + UPDATE with version check に分離し、DB レベルでの競合検出を実現した。

## 背景

- ユースケース層でバージョンチェック（`step.version() != input.version`）を行ってから `save`（UPSERT）を呼ぶまでの間に別のリクエストが更新する可能性があった
- `save` メソッドが `ON CONFLICT DO UPDATE` を使用しており、WHERE 句でバージョンチェックを行っていなかった
- 新規作成（INSERT）と更新（UPDATE）が同一メソッドに混在し、意図が不明確だった

## 実施内容

### Phase 1: InfraError に Conflict バリアントを追加

`backend/crates/infra/src/error.rs` に楽観的ロック競合を表す `Conflict { entity, id }` バリアントを追加。

### Phase 2: `update_with_version_check` メソッドの新設

両リポジトリトレイトに `update_with_version_check(&self, entity, expected_version: Version)` を追加。

PostgreSQL 実装:
```rust
UPDATE workflow_steps SET ...
WHERE id = $8 AND version = $9
```

`rows_affected() == 0` で競合を検出し `InfraError::Conflict` を返す。

### Phase 3: `save` → `insert` への改名

- トレイトメソッド名を `save` → `insert` に変更
- SQL から `ON CONFLICT DO UPDATE` を除去（純粋な INSERT のみ）
- 新規作成と更新の意図を型レベルで明確化

### Phase 4: ユースケース層の修正

| メソッド | 変更前 | 変更後 |
|---------|--------|--------|
| `create_workflow` | `instance_repo.save()` | `instance_repo.insert()` |
| `submit_workflow` | `instance_repo.save()` + `step_repo.save()` | `instance_repo.update_with_version_check()` + `step_repo.insert()` |
| `approve_step` | `step_repo.save()` + `instance_repo.save()` | `step_repo.update_with_version_check()` + `instance_repo.update_with_version_check()` |
| `reject_step` | `step_repo.save()` + `instance_repo.save()` | `step_repo.update_with_version_check()` + `instance_repo.update_with_version_check()` |

`InfraError::Conflict` → `CoreError::Conflict` への変換も実装。

### Phase 5: sqlx-prepare と全体チェック

`just sqlx-prepare` でキャッシュ更新、`just check-all` で全テスト通過を確認。

## 設計判断

### 1. UPSERT の分離（INSERT + UPDATE with version check）

なぜこの設計か:
- UPSERT はリポジトリの「新規作成」と「更新」の意図を曖昧にする
- `save` という名前では、呼び出し側が「このエンティティは新規なのか既存なのか」を意識しない
- `insert` と `update_with_version_check` に分離することで、意図がメソッド名に表れる

代替案:
- `save` のまま WHERE 句にバージョンチェックを追加する方法もあったが、新規作成時にバージョンチェックは不要であり、分離した方が明確

### 2. 多層防御（ユースケース層 + リポジトリ層）

ユースケース層の早期チェック（`step.version() != input.version`）をリポジトリ層の DB レベルチェックと併存させた。

- ユースケース層: 不要な DB アクセスを回避（早期フェイル）、ドメイン用語でのエラーメッセージ
- リポジトリ層: TOCTOU を防ぐ最終防衛線（DB レベルのアトミック操作）

### 3. `rows_affected()` による競合検出

`UPDATE ... WHERE version = $expected` で影響行数が 0 の場合を競合として検出。

代替案:
- SELECT FOR UPDATE（悲観的ロック）は、テーブル全体のパフォーマンスに影響するため不採用
- RETURNING 句で更新前の行を取得する方法もあるが、単純な成否判定には `rows_affected()` で十分

## テスト

TDD で実装。各 Phase でテストを先に書いてから実装した:

- バージョン一致で更新できる（WorkflowInstance / WorkflowStep）
- バージョン不一致で `InfraError::Conflict` を返す（WorkflowInstance / WorkflowStep）
- ステップの完了フロー（insert → activate → complete の一連のバージョン管理）

## 学んだこと

- TOCTOU は「チェックと操作が別のトランザクション」で発生する。DB レベルの WHERE 句でアトミックに検証するのが定石
- UPSERT（`ON CONFLICT DO UPDATE`）は便利だが、楽観的ロックとは相性が悪い。バージョンチェックの意味を無効化してしまう
- メソッド名で意図を表現すること（`save` vs `insert`/`update_with_version_check`）は、バグの早期発見に直結する

## 関連

- Issue: [#157](https://github.com/ka2kama/ringiflow/issues/157)（楽観的ロック TOCTOU 修正）
- PR: [#158](https://github.com/ka2kama/ringiflow/pull/158)
- 親 Issue: [#36](https://github.com/ka2kama/ringiflow/issues/36)（ワークフロー承認フロー）
