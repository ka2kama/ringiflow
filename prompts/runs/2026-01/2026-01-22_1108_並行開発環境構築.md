# 2026-01-22_1100_並行開発環境構築

## 概要

git worktree と Docker Compose プロジェクト名を組み合わせた並行開発環境を構築した。
複数のタスクを同時に進めるための、完全に分離された開発環境を実現。

## 背景と目的

複数の Claude Code セッションを同時に動かしたいというニーズがあった。
単にコードを分けるだけでは意味がなく、Docker コンテナやデータベースも分離する必要がある。

## 実施内容

### 1. 設計

3つのアプローチを比較検討:
- 複数クローン方式
- git worktree + Docker Compose プロジェクト名（採用）
- Dev Container

git worktree + Docker Compose プロジェクト名を採用した理由:
- Git 公式機能で安定
- ディスク効率が良い
- コンテナ・ボリュームが自動分離される

### 2. 実装

| ファイル | 内容 |
|---------|------|
| `scripts/generate-env.sh` | ポートオフセット付き `.env` 生成スクリプト |
| `justfile` | `worktree-add/remove/list` タスク、`dev-deps/clean` のプロジェクト名対応 |
| `docker-compose.yml` | `container_name` と `volume.name` を削除 |
| `docs/04_手順書/.../04_並行開発（Worktree）.md` | 手順書 |

### 3. 動作確認

テスト用 worktree を作成し、以下を確認:
- ポートオフセットの自動割り当て
- Docker コンテナの分離（別ポート、別ボリューム）
- ブラウザからの同時アクセス

## 設計上の判断

### ポートオフセットの自動計算

手動でオフセットを指定する方式から、自動割り当て方式に変更。
既存 worktree の `.env` からポートを読み取り、空きオフセットを自動で選択する。

### Docker Compose プロジェクト名

`container_name` を固定すると、プロジェクト名を変えても同じ名前のコンテナが作成される。
これを削除することで、プロジェクト名ベースの自動命名に切り替えた。

## 成果物

### コミット

- `feat: git worktree による並行開発環境を構築`
- `docs: worktree 初回セットアップ手順を追記`

### 作成ファイル

- `scripts/generate-env.sh`
- `docs/04_手順書/04_開発フロー/04_並行開発（Worktree）.md`
- `docs/05_ADR/021_並行開発環境の構成.md`
- `docs/06_技術ノート/git_worktree.md`

### 更新ファイル

- `justfile`
- `infra/docker/docker-compose.yml`

## 議論の経緯

### 分離の範囲

ユーザーから「コードだけ分けても意味がない。ローカル実行環境や統合テストが分離できていないと意味がない」という指摘があった。
これを受けて、Docker コンテナ・ボリューム・ポートも含めた完全分離を設計した。

### ポート管理方式

3つの方式を提示:
1. オフセット方式（採用）: worktree 名から計算
2. 手動設定方式: `.env` を手動編集
3. 動的ポート方式: Docker に自動割り当てさせる

オフセット方式を採用。さらに、手動指定からの自動割り当てに改善した。

### 動作確認

実際に worktree を作成し、両環境で Docker と Vite を起動して確認。
テスト worktree では `pnpm install` が必要であることが判明し、手順書に追記した。

## 学んだこと

- Docker Compose の `-p` オプションでプロジェクト名を変えると、コンテナ・ボリューム・ネットワークが自動的に分離される
- `container_name` を固定するとプロジェクト名機能が効かない
- worktree は `node_modules/` や `target/` を共有しないため、初回セットアップが必要

## 次のステップ

- PR #96 のレビュー・マージ
