# セッションログ: アーキテクチャ比較とサンドボックス問題

日時: 2026-01-25 19:55

## 概要

水平レイヤー vs Vertical Slice Architecture の比較分析を実施。また、Claude Code サンドボックスによる不要ファイル作成問題を調査・解決した。

## 実施内容

### 1. アーキテクチャ比較分析

RingiFlow の理念・要件に基づき、水平レイヤー構造と Vertical Slice Architecture を比較。

評価軸:
- マルチテナント要件との適合
- テナント退会時のデータ削除要件（ADR-007）
- CQRS + イベントソーシング導入予定（Phase 4）
- 学習効果

結論: **ハイブリッドアプローチを採用**
- 水平レイヤーを基盤として維持
- handlers をスライス志向で整理
- 横断的関心事は Infra 層に集約

### 2. サンドボックス問題の調査・解決

#### 症状

プロジェクトディレクトリに空のドットファイルが作成される:
- `.bashrc`, `.zshrc`, `.gitconfig`, `.mcp.json` など
- 0 バイト、読み取り専用
- サンドボックス内から削除不可

#### 原因

Claude Code サンドボックス実装のバグ（[Issue #17258](https://github.com/anthropics/claude-code/issues/17258)）

```bash
# バグ: プロジェクトディレクトリにバインド
--ro-bind /home/user/project/.bashrc /home/user/project/.bashrc

# 期待: ホームディレクトリをバインド
--ro-bind $HOME/.bashrc $HOME/.bashrc
```

#### 環境差異

| 環境 | bubblewrap | 発生 |
|------|------------|------|
| Fedora 43 | 0.11.0 | ✅ 発生 |
| Ubuntu 24.04 | 0.8.0（推定） | ❌ 発生しない |

#### 解決策

1. `excludedCommands` に `bash`, `sh` を追加 → **効果なし**
2. `.claude/settings.json` で `sandbox.enabled: false` に設定 → **解決**

スタブファイルはセッション起動時の bubblewrap 初期化で作成されるため、`excludedCommands`（個別コマンド実行時の制御）では回避できなかった。

## 成果物

### 技術ノート

- `docs/06_技術ノート/ClaudeCode_サンドボックス.md`

### 設定変更

- `.claude/settings.json`: `sandbox.enabled: false` を設定（サンドボックス無効化）

## 学習ポイント

### Vertical Slice Architecture

- 機能単位での凝集を重視するアーキテクチャパターン
- CQRS との親和性が高い
- マルチテナント要件がある場合、横断的関心事の重複に注意が必要

### bubblewrap サンドボックス

- Linux でのコンテナ化ツール
- `--ro-bind` でファイルシステムを隔離
- バインドマウントにはターゲットファイルが必要（空ファイルが作成される）

## 参考リンク

- [Issue #17258: Sandbox creates phantom dotfiles](https://github.com/anthropics/claude-code/issues/17258)
- [bubblewrap - GitHub](https://github.com/containers/bubblewrap)
- [Bubblewrap - ArchWiki](https://wiki.archlinux.org/title/Bubblewrap)
