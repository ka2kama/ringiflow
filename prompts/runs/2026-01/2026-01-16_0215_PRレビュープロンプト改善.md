# PRレビュープロンプト改善

## 概要

Claude Code Action の自動 PR レビュープロンプトを 2026 年現在のベストプラクティスに更新し、プロジェクト理念との整合性を確保した。

## 背景と目的

既存の PR レビュー設定は基本的な構成のみで、以下の課題があった:

1. レビュー成功時に自動 approve されない
2. 2026 年現在のベストプラクティスを反映していない
3. プロジェクト理念（学習効果の最大化、品質の追求）が考慮されていない

## 実施内容

### 1. ベストプラクティスの調査

以下のソースから最新のベストプラクティスを調査:

- [Claude Code Action 公式ドキュメント](https://github.com/anthropics/claude-code-action)
- [Solutions Guide](https://github.com/anthropics/claude-code-action/blob/main/docs/solutions.md)
- コミュニティのブログ記事

### 2. プロンプトの改善

**技術的な改善:**

- GitHub コンテキストの明示（REPO, PR NUMBER）
- 進捗トラッキングの有効化（`track_progress: true`）
- トリガーイベントの拡充（`ready_for_review`, `reopened` 追加）
- 承認基準の明確化

**プロジェクト理念の反映:**

- 型システムの活用（Rust/Elm）の観点を追加
- テストの有無と品質の観点を追加
- 学習機会の提供を明記
- CLAUDE.md への参照を維持（Single Source of Truth）

### 3. ドキュメントの整合

- CLAUDE.md の PRレビューセクションを更新
- 技術ノートを作成（PRレビュープロンプト設計）

## 成果物

### 更新ファイル

- `.github/workflows/claude-review.yml` - プロンプト改善
- `CLAUDE.md` - PRレビューセクション更新

### 新規ファイル

- `docs/05_技術ノート/ClaudeCodeAction_PRレビュープロンプト設計.md`

## 設計判断と実装解説

### Single Source of Truth の維持

当初、プロンプト内にプロジェクト理念を直接記述しようとしたが、以下の理由で CLAUDE.md への参照に変更:

| 方式 | メリット | デメリット |
|------|---------|-----------|
| プロンプト内に直接記述 | 確実に参照される | DRY 違反、保守性低下 |
| CLAUDE.md を参照 | Single Source of Truth | - |

**結論**: CLAUDE.md を正式な情報源とし、プロンプトからは参照 + 補完のみ行う。

### 学習支援と承認判断の分離

一般的なベストプラクティスでは「nitpick 禁止」だが、学習目的のプロジェクトでは設計解説が価値を持つ。

**解決策**: 学習のための解説コメントは承認判断に影響しないことを明記。

```yaml
学習のための解説コメントは承認判断に影響しない。
問題がなければ、躊躇なく承認してください。
```

## 議論の経緯

### 承認動作の改善

Claude Code Action による Auto Review 時、成功したら approve してほしいという要望があり、承認判断基準を追加した。

### ベストプラクティスの適用

Review 用プロンプトを 2026 年現在のベストプラクティスに合わせてほしいという依頼があった。プロジェクトの理念と目的にも沿えているか確認があり、学習目的のプロジェクトでは nitpick 禁止が学習機会の喪失につながるため調整した。

### CLAUDE.md 参照の削除

CLAUDE.md への参照を消した意図について確認があり、Claude Code Action は CLAUDE.md を自動的に読み込むため明示的な参照は不要であることを説明した。

## 学んだこと

1. **一般的なベストプラクティスがプロジェクトに適合するとは限らない**
   - 学習目的のプロジェクトでは、nitpick 禁止が学習機会の喪失につながる
   - プロジェクト固有の理念を考慮した調整が必要

2. **Single Source of Truth の重要性**
   - 「プロンプト内で完結させる」より「参照 + 補完」の方が保守性が高い
   - 重複記述は必ず不整合を招く

3. **承認基準と学習コメントの分離**
   - 学習支援とゲートキーピングは異なる責務
   - 分離することで両立が可能
