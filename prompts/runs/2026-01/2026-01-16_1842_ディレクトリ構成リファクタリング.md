# 2026-01-16_05_ディレクトリ構成リファクタリング

## 概要

プロジェクトのディレクトリ構成を `backend/` と `frontend/` に分離し、言語境界を明確化した。
また、環境変数ファイル（`.env.template`）を使用者ごとに分離した。

## 背景と目的

従来の構成には以下の問題があった:

1. **言語境界が曖昧**: トップレベルに `Cargo.toml` があり、Rust ワークスペースがトップを占めていたが、`apps/web/` に Elm が混在
2. **命名と実態の不一致**: `packages/` という汎用的な名前だが、中身は Rust クレートのみ
3. **環境変数の混在**: ルートの `.env.template` に Docker、Rust、Vite の設定が混在

## 実施内容

### ディレクトリ構成の変更

**Before**:
```
ringiflow/
├── Cargo.toml
├── apps/
│   ├── bff/          # Rust
│   ├── core-api/     # Rust
│   └── web/          # Elm
└── packages/         # Rust
```

**After**:
```
ringiflow/
├── backend/
│   ├── Cargo.toml
│   ├── apps/
│   │   ├── bff/
│   │   └── core-api/
│   └── crates/       # 旧 packages
│       ├── domain/
│       ├── infra/
│       └── shared/
└── frontend/         # 旧 apps/web
```

### 環境変数の分離

**Before**:
```
.env.template         # 全部入り
frontend/.env.template
```

**After**:
```
.env.template         # Docker ポート + 開発サーバーポート
backend/.env.template # Rust 固有（DB, Redis, ログ）
```

`frontend/.env.template` は削除。justfile の `dotenv-load` でルートの `.env` を読み込むため不要。

### 更新したファイル

- `backend/Cargo.toml`: パスを `crates/` に変更
- `justfile`: 全コマンドのパスを更新
- `.github/workflows/ci.yml`: パスフィルタと working-directory を更新
- `docs/02_設計書/01_プロジェクト構造設計.md`: 全面改訂
- `frontend/vite.config.js`: コメント更新

## 成果物

- 技術ノート: [モノレポディレクトリ構成](../../../docs/80_ナレッジベース/architecture/モノレポディレクトリ構成.md)

## 設計判断と実装解説

### なぜ `backend/` を切り出したか

Rust コードを `backend/` 内で完結させることで:
- `Cargo.toml` がトップレベルを汚さない
- Elm との言語境界が明確
- 将来 Worker やバッチを追加する際も `backend/apps/` に追加するだけ

### なぜ `packages/` を `crates/` に変更したか

`packages/` は Node.js エコシステム（npm, Turborepo）で使われる汎用的な名前。
中身が Rust クレートのみなら `crates/` の方が意図が明確。

### なぜ `frontend/` 直下に Elm を配置したか

YAGNI の原則。現時点でモバイルアプリの予定はないので、`frontend/web/` のような階層は不要。
必要になった時点で再構成すればよい。

### 環境変数分離の判断

| 環境変数 | 使用者 | 配置先 |
|----------|--------|--------|
| `POSTGRES_PORT`, `REDIS_PORT` | docker-compose | ルート |
| `BFF_PORT`, `VITE_PORT` | 開発サーバー | ルート |
| `DATABASE_URL`, `RUST_LOG` | Rust アプリ | backend/ |

justfile の `dotenv-load` がルートの `.env` を読み込むため、`just dev-web` 実行時に `BFF_PORT` と `VITE_PORT` が環境変数として渡される。これにより `frontend/.env` が不要になった。

## 議論の経緯

### ディレクトリ構成の見直し

packages がトップレベルにいていいのかという質問があった。また、汎用的といいながら packages の直下が domain, infra など Rust プロジェクトなのが違和感があるという指摘があった。

backend, frontend, その他今あるもの、あるいは今後増えそうなもの、そのあたりを全部加味して最適な構成を考えるよう依頼があり、`backend/` 配下に Rust 関連を集約する構成に変更した。

### 環境変数ファイルの整理

トップレベルの .env.template に RUST_LOG などがあることについて確認があり、必要最小限に整理した。frontend に .env が必要かについても確認があり、justfile の dotenv-load で対応できるため不要と判断した。

## 学んだこと

1. **命名と実態の一致**: ディレクトリ名は中身を正確に表すべき
2. **言語境界の明確化**: 多言語モノレポではトップレベルで言語を分離すると見通しが良い
3. **環境変数の整理**: 使用者ごとに分離し、justfile の機能を活用して重複を減らす

## 次のステップ

- 特になし（リファクタリング完了）
