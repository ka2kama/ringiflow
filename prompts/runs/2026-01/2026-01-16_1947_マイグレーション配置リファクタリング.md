# マイグレーション配置リファクタリング

## 概要

マイグレーションディレクトリを `backend/apps/core-api/migrations/` から `backend/migrations/` に移動し、アプリケーション非依存の配置に変更した。また、sqlx-cli 技術ノートに冪等性の解説を追加した。

## 背景と目的

- マイグレーションが特定のアプリケーション（core-api）内に配置されていた
- 将来バッチジョブやワーカーが追加された際に、同じスキーマを共有しにくい構造だった
- `sqlx migrate run` の冪等性について技術ノートに記載がなかった

## 実施内容

### 1. マイグレーションディレクトリの移動

```
backend/apps/core-api/migrations/ → backend/migrations/
```

### 2. 関連ファイルのパス更新

- `justfile` の `setup-db` タスク
- 設計書（DB設計、テナント退会時データ削除設計）
- 手順書（プロジェクトセットアップ）
- `.claude/rules/data-store.md`

### 3. sqlx-cli 技術ノートの更新

- マイグレーションの仕組み（冪等性）セクションを追加
- `_sqlx_migrations` テーブルの構造を説明
- プロジェクト固有の記述を削除（技術ノートは汎用的な知識のみ記載するルール）

### 4. PostgreSQL ポート番号の修正（別 PR）

PR #31 で意図せず変更されていたポート番号を修正。

- `.env.template`: 15433 → 15432
- `backend/.env.template`: 15433 → 15432

## 成果物

### コミット

- PR #32: PostgreSQL ポート番号を 15432 に戻す
- PR #33: マイグレーションを backend/ 直下に移動（本セッション）

### 作成/更新ファイル

| ファイル | 変更内容 |
|---------|---------|
| `backend/migrations/` | 新規配置 |
| `justfile` | setup-db のパス変更 |
| `docs/05_技術ノート/sqlx-cli.md` | 冪等性セクション追加、プロジェクト固有記述削除 |
| `docs/02_設計書/02_データベース設計_MVP.md` | パス更新 |
| `docs/02_設計書/07_テナント退会時データ削除設計.md` | パス更新 |
| `docs/03_手順書/01_開発参画/02_プロジェクトセットアップ.md` | パス更新 |
| `.claude/rules/data-store.md` | パス更新 |

## 設計判断と実装解説

### マイグレーションの配置場所

検討した選択肢:

| 配置 | 考え方 |
|------|--------|
| `backend/apps/core-api/migrations/` | 元の配置。Core API がDBの唯一の所有者なので自然 |
| `backend/migrations/` | アプリ非依存。バッチジョブ等が追加されても共有可能 |
| `infra/migrations/` | DBはインフラの一部という考え方 |

採用: `backend/migrations/`

理由:
- マイグレーションは特定アプリに属さない
- sqlx との相性を考慮し、backend/ 内に配置（sqlx のデフォルト動作に近い）
- `infra/` は概念的には正しいが、sqlx の設定が複雑になる

### 技術ノートの記載ルール

技術ノートにプロジェクト固有のディレクトリ構成を記載していたが、README のルールに従い削除した:

> 書かないこと:
> - プロジェクト固有の設計詳細（→ 設計書へ）

技術ノートは汎用的な技術知識を記載する場所であり、プロジェクト固有の構成は設計書に記載すべき。

## 議論の経緯

### マイグレーションの冪等性

`setup-db` は何度も実行できるかという確認があり、sqlx の `_sqlx_migrations` テーブルにより冪等に実行できることを説明した。

### マイグレーションの配置

DB とアプリケーションが 1:1 とは限らないのではという指摘があった。backend 内でさえあるのかどうかという観点も含め、将来の拡張性を考慮して `backend/migrations/` に配置することを決定した。

### 技術ノートの内容

技術ノートにプロジェクト特有のディレクトリ構成を書くのは適切かという確認があり、汎用的な知識のみ記載し、プロジェクト固有の構成は設計書に書く方針を確認した。

## 学んだこと

- マイグレーションの配置は「誰がDBを所有するか」ではなく「将来の拡張性」で考える
- sqlx の `_sqlx_migrations` テーブルにより、マイグレーションは冪等に実行できる
- 技術ノートには汎用的な知識のみ記載し、プロジェクト固有の構成は設計書に書く

## 次のステップ

- ローカルの `.env` と `backend/.env` のポート番号を手動で更新
- Docker コンテナを再起動して新しいポートで接続

---

## 変更履歴

| 日付 | 変更内容 |
|------|---------|
| 2026-01-16 | 初版作成 |
