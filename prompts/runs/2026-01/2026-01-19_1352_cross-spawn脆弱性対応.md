# 2026-01-19_04 cross-spawn 脆弱性対応

## 概要

Dependabot が検出した `cross-spawn` パッケージの ReDoS 脆弱性（CVE-2024-21538）に対応した。

## 背景と目的

Dependabot アラートで `cross-spawn` の High 深刻度脆弱性が検出された。
`vite-plugin-elm` → `node-elm-compiler` → `cross-spawn 6.0.5` という間接依存が脆弱なバージョンを使用しており、上流での修正が行われていなかったため、pnpm overrides で対応した。

## 実施内容

### 1. 脆弱性の調査

- Dependabot アラート #2 の詳細を GitHub API で取得
- 依存関係ツリーを `pnpm why cross-spawn` で確認
- 上流パッケージ（`node-elm-compiler`）の最新版でも未修正であることを確認

### 2. 修正方法の検討

3 つの選択肢を比較:

1. pnpm overrides で強制上書き
2. 上流の修正を待つ
3. 代替パッケージへの移行

パッチバージョンの上げ幅が小さく互換性リスクが低いこと、上流の修正時期が不明であることから、選択肢 1 を採用。

### 3. 修正の実施

`frontend/package.json` に overrides を追加:

```json
"pnpm": {
  "overrides": {
    "cross-spawn@<6.0.6": "6.0.6"
  }
}
```

`pnpm install` で lockfile を更新し、ビルドが正常に動作することを確認。

## 成果物

### 変更ファイル

| ファイル | 変更内容 |
|----------|----------|
| `frontend/package.json` | pnpm overrides を追加 |
| `frontend/pnpm-lock.yaml` | 自動更新 |
| `docs/70_ADR/018_cross-spawn脆弱性への対応.md` | 新規作成 |
| `docs/06_技術ノート/Dependabot.md` | セキュリティアラート対応セクションを追加 |

## 設計判断と実装解説

### pnpm overrides の選択

npm/yarn にも同様の機能（overrides/resolutions）があるが、pnpm では `pnpm.overrides` フィールドで設定する。バージョンセレクタ（`cross-spawn@<6.0.6`）を使うことで、影響範囲を脆弱なバージョンのみに限定できる。

### devDependencies の脆弱性対応

`cross-spawn` は devDependencies の間接依存であり、本番環境には含まれない。実際のリスクは低いが、以下の理由から対応した:

- アラートを放置する習慣を避ける
- CI/CD パイプラインへの攻撃可能性（理論上）
- 修正コストが極めて低い

## 学んだこと

- pnpm overrides でバージョンセレクタを使い、影響範囲を限定する方法
- devDependencies の脆弱性も、コストが低ければ対応するのがベター
- 上流が修正されない場合の対処法として、overrides は有効な手段

## 次のステップ

- 定期的に `pnpm why cross-spawn` で上流の修正状況を確認
- 上流が修正されたら overrides を削除

## 関連リンク

- [ADR-018: cross-spawn 脆弱性への対応](../../../docs/70_ADR/018_cross-spawn脆弱性への対応.md)
- [技術ノート: Dependabot](../../../docs/80_ナレッジベース/devtools/Dependabot.md)
