# 認証設計レビュー対応

## 概要

PR #46（ユーザー認証設計）のレビュー指摘に対応。設計書の不整合を修正し、技術ノートを追加・更新した。

## 背景と目的

Claude Code Action による自動レビューで以下の Critical 指摘があった:

1. SameSite 属性の不整合（Strict vs Lax）
2. セッション有効期限の不整合（24時間 vs 8時間）

これらを修正し、レビューで提供された学習ポイントを技術ノートとして形式知化する。

## 実施内容

### 設計書の修正

| ファイル | 修正内容 |
|---------|---------|
| `00_アーキテクチャ概要.md` | SameSite=Strict → Lax、有効期限 24時間 → 8時間 |
| `07_認証機能設計.md` | Argon2 メモリ 46MB → 64MB（RFC 9106 推奨） |

### 技術ノートの更新

**BFFパターン.md:**

- SameSite 属性（Strict/Lax/None）の違いと選択理由
- CSRF 防御方式を「Double Submit Cookie」から「サーバサイドトークン方式」に修正

### 技術ノートの追加

**パスワードハッシュ.md:**

- パスワードハッシュの必要性
- アルゴリズム比較（MD5/bcrypt/Argon2）
- メモリハード関数の解説
- Argon2id パラメータの意味と選択理由
- タイミング攻撃対策（`std::hint::black_box` の使用）

## 成果物

### コミット

- `b066791` レビュー指摘対応: 設計書の不整合修正と技術ノート追加 #34

### 作成/更新ファイル

| ファイル | 種別 |
|---------|------|
| `docs/02_基本設計書/00_アーキテクチャ概要.md` | 更新 |
| `docs/03_詳細設計書/07_認証機能設計.md` | 更新 |
| `docs/06_技術ノート/BFFパターン.md` | 更新 |
| `docs/06_技術ノート/パスワードハッシュ.md` | 新規 |

## 設計判断と実装解説

### なぜ SameSite=Lax を選んだか

| 値 | 動作 | 採用判断 |
|----|------|---------|
| Strict | クロスサイトリクエストで Cookie を送らない | 外部リンクからのアクセスでログアウト状態になる |
| Lax | トップレベルナビゲーションの GET のみ送る | CSRF トークンと併用で十分な安全性 |

CSRF 対策はトークンで担保しているため、Strict の制約は不要。

### メモリハード関数とは

計算に大量のメモリを必要とする関数。GPU や ASIC による並列攻撃を困難にする。

- SHA-256: GPU 1台で毎秒数十億回のハッシュ計算可能
- Argon2（64MB）: GPU のコアごとに 64MB 必要 → 並列数が制限される

### `black_box` の注意点

`std::hint::black_box` は最適化抑制の「ヒント」であり、完全な保証はない（ベストエフォート）。超高セキュリティが必要な場合は `volatile read` を検討。

## 議論の経緯

### Argon2 のメモリパラメータ

ユーザーから、Argon2 のメモリパラメータは 64MB ではだめかという質問があった。検討の結果、RFC 9106 推奨の 64MB に変更した。

### 最適化によるコード削除の懸念

`let _ = xxx` は最適化の過程で消えたりしないかという懸念が指摘された。理論上は消える可能性があるため、`std::hint::black_box` を使用し、ベストエフォートである旨を明記した。

### メモリハード関数の解説

「メモリハード」とは何かという質問があり、技術ノートに詳細な解説を追加した。

## 学んだこと

1. **SameSite 属性の選択**: CSRF トークンと併用する場合、Lax で十分
2. **メモリハード関数**: GPU 攻撃への耐性を高める仕組み
3. **`black_box`**: Rust の最適化抑制ヒント（ベストエフォート）
4. **Argon2 パラメータ**: RFC 9106 推奨は 64MB

## 次のステップ

- PR #46 のマージ
- 認証機能の実装開始
