# コミット粒度の整理

## 概要

35件のコミットを「1機能1コミット」の方針で11件に統合し、コミットメッセージを整理した。

## 背景と目的

- コミット履歴が細かく分散していた
- PRでマージされたコミットと直接コミットが混在
- 履歴を見やすく整理し、1機能1コミットの粒度に揃える

## 実施内容

### 1. コミットの統合（rebase）

`git rebase -i --root` で全コミットを対象に、関連するコミットを `fixup` で統合。

**統合前後の対応:**

| 統合後のコミット | 統合元 |
|-----------------|--------|
| Initial commit | そのまま |
| プロジェクト基盤を構築 | 要件定義・設計書 + プロジェクト設定 |
| Rust バックエンドを実装 | そのまま |
| Elm フロントエンドを実装 | そのまま |
| インフラを構築 | そのまま |
| ドキュメント体系を整備 | 手順書 + 技術ノート + CLAUDE.md関連 + ADR + 規約移管 |
| Dependabotを導入し依存関係を更新 | Dependabot技術ノート + Bump PRs + 依存関係更新 |
| テナント退会時のデータ削除設計を追加 | セッションログ + 削除設計 |
| 設定ファイルの管理方法を改善 | コメント簡素化 + ポート変更 + .env一元化 + ADR-008 |
| ドキュメント自動作成の仕組みを追加 | MCP見送りADR + リンク方針 + 自動作成 + セッションログ |
| PRレビュー自動化と手順書再構成 | PRマージルール + Claude Code Action + 手順書再構成 |

### 2. コミットメッセージの変更（filter-branch）

`git filter-branch --msg-filter` でメッセージを一括変更。

```bash
GIT_SEQUENCE_EDITOR="cp rebase-todo" git rebase -i --root
FILTER_BRANCH_SQUELCH_WARNING=1 git filter-branch -f --msg-filter './msg-filter.sh' -- --all
```

### 3. 署名の追加

```bash
git rebase --root --exec 'git commit --amend --no-edit -S'
```

## 成果物

### 最終的なコミット履歴（11件）

```
10578ea PRレビュー自動化と手順書再構成
0468606 ドキュメント自動作成の仕組みを追加
8373f07 設定ファイルの管理方法を改善
3f1b626 テナント退会時のデータ削除設計を追加
b0d8dde Dependabotを導入し依存関係を更新
44ae381 ドキュメント体系を整備
30112de インフラを構築
0bf400a Elm フロントエンドを実装
02c465c Rust バックエンドを実装
8a1d651 プロジェクト基盤を構築
09212fd Initial commit
```

### 作成ファイル

- `docs/05_技術ノート/Git履歴の書き換え.md`

## 設計判断と実装解説

### GIT_SEQUENCE_EDITOR の活用

対話的な rebase を自動化するため、`GIT_SEQUENCE_EDITOR` 環境変数を使用した。これにより、事前に作成した rebase-todo ファイルを読み込ませることができる。

### filter-branch vs rebase reword

大量のコミットメッセージを変更する場合、`rebase -i` の `reword` は各コミットで対話的にエディタが開くため自動化が難しい。`filter-branch --msg-filter` を使うことで、スクリプトによる一括変更が可能。

### 署名が消える理由

rebase や filter-branch でコミットを書き換えると、コミットハッシュが変わる。署名はコミット内容に対して行われるため、内容が変わると署名は無効になる。履歴書き換え後は再署名が必要。

## ユーザープロンプト（抜粋）

> コミットの粒度を揃えてください。

> 全履歴を対象にしてください。

> 署名を付け直してください。

## 学んだこと

- `git rebase --exec` で各コミット後にコマンドを実行できる
- `GIT_SEQUENCE_EDITOR` で rebase-todo を自動生成できる
- `filter-branch --msg-filter` で大量のメッセージを一括変更できる
- 履歴書き換え後は署名が無効になるため、再署名が必要
