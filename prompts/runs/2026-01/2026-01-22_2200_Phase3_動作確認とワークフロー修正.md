# 2026-01-22_2200_Phase3_動作確認とワークフロー修正

## 概要

Auth Service 分離（Issue #80）の Phase 3 動作確認と、Claude ワークフローの status check 修正を行った。

## 実施内容

### 1. Phase 3 動作確認

Auth Service 経由の認証フローを実際に起動して動作確認した。

**起動したサービス:**

| サービス | ポート |
|---------|-------|
| Core API | 13001 |
| Auth Service | 13002 |
| BFF | 13000 |

**テスト結果:**

| ケース | 結果 |
|--------|------|
| 正常ログイン | ✅ 200 OK |
| パスワード不一致 | ✅ 401 Unauthorized |
| ユーザー不存在 | ✅ 401 Unauthorized |

セキュリティ確認: パスワード不一致とユーザー不存在で同じエラーメッセージを返し、ユーザー存在の推測を防止。

### 2. 不足していた設定の追加

#### worktree ポート計算に Auth Service を追加

`scripts/generate-env.sh` に Auth Service のポート設定が欠けていた。

```bash
# 追加
BASE_AUTH_SERVICE_PORT=13002
AUTH_SERVICE_PORT=$((BASE_AUTH_SERVICE_PORT + OFFSET))
```

#### just dev-auth-service コマンドを追加

`justfile` に Auth Service 起動コマンドがなかった。

```just
dev-auth-service:
    cd backend && cargo run -p ringiflow-auth-service
```

### 3. FIXME コメントの形式修正

Rules Check で指摘: FIXME は行コメント（`//`）で書く必要があるが、doc コメント（`///`）で書いていた。

**修正前:**
```rust
/// FIXME: `#[allow(dead_code)]` を解消する
```

**修正後:**
```rust
// FIXME: `#[allow(dead_code)]` を解消する
```

### 4. Claude ワークフローの status check 修正

**問題:**
Claude が `gh pr review --request-changes` を実行しても、status check は `success` を報告していた。そのため、Ruleset で `required_status_checks` に設定しても、マージがブロックされなかった。

**原因:**
- Status check（pending → success/failure）と PR review（approve/request-changes）は別物
- claude[bot] のレビューは `required_approving_review_count` にカウントされない

**修正:**
両ワークフローに、Claude のレビュー状態をチェックするステップを追加:

```yaml
- name: Check review decision
  run: |
    REVIEW_STATE=$(gh api ... --jq 'claude[bot] の最新レビュー')
    echo "review_state=$REVIEW_STATE" >> "$GITHUB_OUTPUT"

- name: Report failure status (changes requested)
  if: review_state == 'CHANGES_REQUESTED'
  run: gh api ... -f state=failure
```

### 5. Mermaid シーケンス図の修正

Phase 3 の実装解説ドキュメントで、participant が重複表示される問題を修正。

**修正前:**
```mermaid
participant Browser["ブラウザ"]
```

**修正後:**
```mermaid
participant Browser as ブラウザ
```

### 6. E2E テスト Issue 作成

手動で curl テストを行ったが、自動化されていないため Issue を作成。

- Issue #98: E2E API テストを hurl で追加する

## 成果物

### 更新ファイル

- `scripts/generate-env.sh` - Auth Service ポート追加
- `justfile` - dev-auth-service コマンド追加
- `backend/apps/auth-service/src/error.rs` - FIXME コメント形式修正
- `backend/apps/core-api/src/handler/auth.rs` - FIXME コメント形式修正
- `.claude/rules/code-annotations.md` - 行コメント使用の注意を追加
- `.claude/rules/docs.md` - Mermaid sequenceDiagram の構文を明記
- `.github/workflows/claude-rules-check.yml` - CHANGES_REQUESTED 時に failure
- `.github/workflows/claude-auto-review.yml` - CHANGES_REQUESTED 時に failure
- `docs/07_実装解説/03_AuthService/03_Phase3_BFF統合.md` - Mermaid 修正

## 学んだこと

### GitHub の status check と PR review の違い

| 概念 | 説明 | 設定箇所 |
|------|------|---------|
| Status check | CI/CD の実行結果（success/failure） | `required_status_checks` |
| PR review | 人間/bot のレビュー判断（approve/request-changes） | `required_approving_review_count` |

bot のレビューは `required_approving_review_count` にカウントされないため、bot が `--request-changes` してもマージを止められない。status check を failure にする必要がある。

### Mermaid の構文

| 図の種類 | 構文 |
|---------|------|
| flowchart | `ID["ラベル"]` |
| sequenceDiagram | `participant ID as ラベル` |

sequenceDiagram で `ID["ラベル"]` を使うと participant が重複表示される。

## 次のステップ

- CI 完了後、PR #97 をマージ
- Phase 4: `users.password_hash` カラム削除
- Issue #98: E2E テスト追加
