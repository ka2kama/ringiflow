# 設計ファースト開発フロー導入

## 概要

実装前に必ず設計フェーズ（基本設計確認 → 詳細設計 → 実装計画）を経る開発フローを整備した。
TDD（テスト駆動開発）の方針を形式知化し、Issue 駆動開発と統合した。

## 背景と目的

Issue #34（ユーザー認証）の実装に着手する前に、開発の進め方を形式知化する必要があった。

- 設計なしに実装を始めるとアーキテクチャが不明確になる
- テストリストなしに TDD を進めると方向性を見失う
- プロジェクト理念「暗黙知ゼロ」「学習効果の最大化」を実現するには、進め方自体も文書化すべき

## 実施内容

### 1. OpenAPI 仕様書の導入

API 仕様を機械可読な OpenAPI 3.1.0 形式で管理することを決定。

**配置の検討:**

| 候補 | 位置づけ |
|------|---------|
| `docs/openapi/` | ドキュメントの一部 |
| `openapi/` | Single Source of Truth |
| `backend/openapi/` | コード生成と連携 |

プロジェクト理念に照らし、OpenAPI を「API の正式な仕様」として `openapi/`（プロジェクトルート）に配置。

### 2. TDD 開発フローの形式知化

t_wada の TDD 手法を基本とし、以下を文書化:

- Red → Green → Refactor サイクル
- テストリストの作成方法
- MVP 積み上げ方式（依存順に下位レイヤーから）
- 実践的なパターン（三角測量、AAA、テストダブル）

### 3. Issue 駆動開発への設計フェーズ統合

開発フローを拡張:

```
Issue 作成 → 設計 → ブランチ作成 → 実装（TDD）→ PR → マージ
```

設計フェーズの内容:
1. 基本設計確認
2. 詳細設計作成（+ OpenAPI 更新）
3. 実装計画作成（Issue に記載）

### 4. コミット粒度のガイドライン追加

実装時のコミット粒度を明記:
- セーブポイントを積み上げるようにコツコツとコミット
- テストが通った時点でコミット
- 壊れた状態を残さない

### 5. レビュー確認ステップの追加

PR の auto-merge を廃止し、レビュー確認ステップを追加:
- Claude Code Action による自動レビューを確認
- 指摘があれば修正、なければ手動マージ
- レビュー結果を読んでから判断する

### 6. 実装計画の配置決定

Issue ごとの実装計画をどこに置くか検討:

| 候補 | 評価 |
|------|------|
| `docs/03_詳細設計書/` | 設計（HOW）と進め方（HOW TO）が混在 |
| `prompts/plans/` | 一時的で形式知として残らない |
| GitHub Issue 本文 | 計画と進捗が一箇所に集約、完了後もアーカイブ |

プロジェクト理念に照らし、**Issue 本文に記載** を採用。

## 成果物

### 作成したファイル

| ファイル | 内容 |
|---------|------|
| `openapi/openapi.yaml` | OpenAPI 3.1.0 仕様書（認証 API、ヘルスチェック API） |
| `docs/04_手順書/04_開発フロー/02_TDD開発フロー.md` | TDD 開発フローの手順書 |
| `docs/03_詳細設計書/07_認証機能設計.md` | 認証機能の詳細設計 |

### 更新したファイル

| ファイル | 変更内容 |
|---------|---------|
| `docs/04_手順書/04_開発フロー/01_Issue駆動開発.md` | 設計フェーズを追加 |
| `docs/03_詳細設計書/03_API設計.md` | OpenAPI 仕様書への参照を追加 |
| GitHub Issue #34 | 実装計画（フェーズ別テストリスト）を追記 |

### 削除したファイル

| ファイル | 理由 |
|---------|------|
| `prompts/plans/*.md` | 正式なドキュメントに移行 |

## 設計判断と実装解説

### OpenAPI の配置

OpenAPI を `docs/openapi/` ではなく `openapi/`（プロジェクトルート）に配置した理由:

1. **学習効果の最大化**: OpenAPI 駆動開発（API-First Design）は業界標準のベストプラクティス
2. **品質の追求**: 「型で表現できるものは型で表現する」理念と同様、API 仕様も機械可読にしてツールで検証可能に
3. **暗黙知ゼロ**: OpenAPI が Single Source of Truth となり、API の契約が明示的に

### 実装計画の配置

実装計画を詳細設計書ではなく Issue 本文に記載することにした理由:

1. **学習効果の最大化**: 計画から完了までの流れが Issue で一目瞭然
2. **品質の追求**: 計画と実装が直接紐づき、乖離が起きにくい
3. **暗黙知ゼロ**: Issue 自体が形式知、完了後もアーカイブとして残る
4. **Issue 駆動開発との整合性**: 既存の「完了基準をチェックリスト形式で書く」方針の延長

## 議論の経緯

### 開発フローの形式知化

ユーザーから、実装の前に計画書を作りたいという要望があった。コードを記述するというよりは進め方の形式知化であり、アジャイル的に MVP を積み上げつつ、t_wada の TDD でテストファーストに進めたいとのことだった。

### OpenAPI と実装計画書の配置

API ドキュメントの配置について、プロジェクトの理念と目的に一番合致する場所を検討した。また、実装計画書は詳細設計とはまた別のセクションに見えるという指摘があり、同様に最適な配置を議論した。

### 設計フェーズの必須化

ユーザーから、実装前の一連の流れ（基本設計、詳細設計、実装計画）を毎回必ず行うようにしたいという要望があった。

### コミット粒度の明記

実装中のコミット粒度についても明記したいという要望があった。セーブポイントを積み上げるようにコツコツとコミットするスタイルを推奨することになった。

### PR レビューの確認プロセス

PR の auto-merge を廃止すべきという指摘があった。Claude Code Action によるレビューが行われるため、approve だとしても修正しておくべき箇所があるかもしれない。レビュー結果を読んだ上で修正するかマージするか決めたいとのことだった。

## 学んだこと

- 設計ドキュメントの配置は「何として扱うか」で決まる（ドキュメントの一部 vs Single Source of Truth）
- 実装計画は設計（HOW）ではなく進め方（HOW TO）に近い
- Issue に実装計画を書くと、計画・進捗・完了が一箇所に集約される

## 次のステップ

- Issue #34 の実装（Phase 1: UserRepository から TDD で進める）
