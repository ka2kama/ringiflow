# CI 統合テストジョブ追加と Claude Auto Review 実行順序変更

## 概要

CI に Rust 統合テストジョブを追加し、Claude Auto Review を CI 完了後に実行するよう変更した。

## 背景と目的

Phase 6 で追加した統合テスト（PostgreSQL / Redis 使用）が CI で実行できていなかった。また、Claude Auto Review が CI チェックと並行して実行されていたため、CI 失敗時にも無駄にレビューが走っていた。

## 実施内容

### 1. CI に rust-integration ジョブを追加

PostgreSQL と Redis を使用する統合テストを実行するジョブを追加:

```yaml
rust-integration:
  services:
    postgres:
      image: postgres:17
    redis:
      image: redis:7
  steps:
    - Install sqlx-cli
    - Run migrations
    - Test (integration tests)
```

### 2. Claude Auto Review を CI 完了後に実行

`pull_request` トリガーから `workflow_run` トリガーに変更:

```yaml
on:
  workflow_run:
    workflows: ["CI"]
    types:
      - completed
```

追加の変更:
- CI 成功時のみ実行（`conclusion == 'success'`）
- Draft PR のチェックを `gh pr view` で実施（`workflow_run` では Draft 情報が取得できないため）

## 成果物

### PR

- [#68 CI に Rust 統合テストジョブを追加](https://github.com/ka2kama/ringiflow/pull/68)

### 更新したファイル

| ファイル | 変更内容 |
|---------|---------|
| `.github/workflows/ci.yml` | rust-integration ジョブ追加 |
| `.github/workflows/claude-auto-review.yml` | CI 完了後実行、Draft チェック追加 |

## 設計判断と実装解説

### workflow_run トリガーの制約

`workflow_run` イベントでは `pull_requests` 配列にベーシックな情報（number, head, base）しか含まれず、`draft` フラグは含まれない。そのため、Draft PR の除外は追加のステップで `gh pr view` を使って確認する必要がある。

### CI 失敗時の挙動

`conclusion == 'success'` を条件にしているため、CI が失敗した場合は Auto Review はスキップされる。これにより、無駄なレビュー実行を防ぐ。

## 学んだこと

- `workflow_run` トリガーでは元の PR のコンテキストが限定的
- `github.event.workflow_run.pull_requests` には Draft 情報が含まれない
- Draft チェックは `gh pr view` で API 呼び出しが必要
