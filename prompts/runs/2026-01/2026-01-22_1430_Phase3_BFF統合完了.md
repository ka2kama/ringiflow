# 2026-01-22_1430_Phase3_BFF統合完了

## 概要

Auth Service 分離（Issue #80）の Phase 3 を完了した。BFF が Auth Service と Core API を呼び分ける新しい認証フローを実装し、統合テストを修正した。

## 背景と目的

Phase 2 で Auth Service の実装が完了したため、BFF を Auth Service 経由の認証フローに移行する必要があった。同時に、Core API から認証関連コードを整理し、責務を明確に分離する。

## 実施内容

### 1. BFF 統合テスト修正

`AuthState` の型パラメータが 2 つから 3 つに変更されたことで、統合テストが 74 エラーでコンパイルに失敗していた。

変更点:
- `AuthState<C, S>` → `AuthState<C, A, S>`（AuthServiceClient 追加）
- `CoreApiClient::verify_credentials` → `CoreApiClient::get_user_by_email`
- `StubAuthServiceClient` を新規追加

### 2. TODO/FIXME の追加

将来対応すべき箇所を可視化するため、コードアノテーションを追加した。

| ファイル | タグ | 内容 |
|---------|------|------|
| `domain/src/user.rs` | TODO(#80) | Phase 4 で password_hash 削除 |
| `infra/src/repository/user_repository.rs` | TODO(#80) | Phase 4 のマイグレーション手順 |
| `auth-service/src/error.rs` | FIXME | `#[allow(dead_code)]` 解消 |
| `core-api/src/handler/auth.rs` | FIXME | `#[allow(dead_code)]` 解消 |

### 3. コードアノテーション規約の策定

プロジェクト全体の TODO/FIXME 使い分け方針を明文化した。

- TODO: やるべきこと（機能追加、改善、削除）
- FIXME: 修正すべき問題（バグ、一時的な回避策、警告抑制）

## 設計上の判断

### TODO vs FIXME の使い分け

当初、`#[allow(dead_code)]` の解消を TODO で記載したが、ユーザーの指摘を受けて FIXME に変更した。

理由:
- TODO は「やるべきこと」であり、コードに問題がない前提
- `#[allow(dead_code)]` は「警告を抑制している問題のある状態」
- FIXME の方が緊急度が高いことを示せる

### paths フロントマターの追加

`.claude/rules/code-annotations.md` に `paths` フロントマターを追加し、Rust/Elm ファイル編集時のみルールが適用されるようにした。

## 成果物

### 更新ファイル

**統合テスト修正:**
- `backend/apps/bff/tests/auth_integration_test.rs`

**TODO/FIXME 追加:**
- `backend/crates/domain/src/user.rs`
- `backend/crates/infra/src/repository/user_repository.rs`
- `backend/apps/auth-service/src/error.rs`
- `backend/apps/core-api/src/handler/auth.rs`

**環境設定:**
- `backend/.env.template`

### 作成ファイル

- `.claude/rules/code-annotations.md` — コードアノテーション規約
- `docs/07_実装解説/03_AuthService/00_概要.md` — 概要ドキュメント
- `docs/07_実装解説/03_AuthService/03_Phase3_BFF統合.md` — Phase 3 実装解説

## 議論の経緯

### TODO の書き方

ユーザーから「TODO の意図が伝わらない」という指摘があった。

問題のあった例:
```rust
// TODO: 将来使う可能性があるため保持
```

改善後:
```rust
// FIXME: `#[allow(dead_code)]` を解消する
//        （ユーザー取得 API でロール詳細を返すか、構造体ごと削除する）
```

「やること」に焦点を当て、具体的なアクションを記載するようにした。

### 不要な TODO の削除

リトライ機構やサーキットブレーカーなど、将来的な改善案を TODO として書いていたが、「あると便利」レベルの曖昧なものは削除した。TODO は明確なタスクのみに限定する。

## 学んだこと

- TODO/FIXME は「やること」を書く。状態の説明ではなく、アクションを記載する
- `#[allow(dead_code)]` のような一時的な回避策は FIXME で明示する
- Claude Code の rules は `paths` で適用範囲を制限できる

## 次のステップ

- Phase 4: `users.password_hash` カラム削除
- FIXME 項目の解消（使用するか削除するか判断）
