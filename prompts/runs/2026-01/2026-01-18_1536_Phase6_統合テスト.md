# Phase 6: BFF 認証統合テスト実装

## 概要

| 項目 | 内容 |
|-----|------|
| 日時 | 2026-01-18 |
| Issue | [#34 ユーザー認証](https://github.com/ka2kama/ringiflow/issues/34) |
| Phase | Phase 6: 統合テスト |
| 成果物 | BFF 認証統合テスト |

## 実装内容

### 新規作成

| ファイル | 説明 |
|---------|------|
| `backend/apps/bff/src/lib.rs` | クレートのライブラリエントリポイント |
| `backend/apps/bff/tests/auth_integration_test.rs` | 統合テスト（430行） |

## 設計判断

### 実 Redis + Core API スタブ

統合テストでは以下の構成を採用:

- **Redis**: 実際のインスタンスを使用
  - セッション管理の実際の動作を検証
  - TTL、永続化、削除が正しく動作することを確認

- **Core API**: スタブを使用
  - 認証ロジックのテストに集中
  - 設定ベースで異なるシナリオを簡潔に表現

理由:
- セッション管理はシステムの重要な部分であり、実際の動作を確認したい
- Core API のテストは Phase 4 で完了済み
- テスト実行時間とのバランス

### lib.rs の追加

統合テストからクレート内のモジュールを使用するために `lib.rs` を追加。

```rust
pub mod client;
pub mod handler;
```

Rust では `main.rs` のみのクレートは統合テストからアクセスできないため、
ライブラリとしてのエントリポイントが必要。

## テスト結果

```
running 6 tests
test test_不正なパスワードでログインできない ... ok
test test_存在しないメールでログインできない ... ok
test test_未認証状態でauthmeにアクセスすると401 ... ok
test test_非アクティブユーザーはログインできない ... ok
test test_ログインからログアウトまでの一連フロー ... ok
test test_ログアウト後にauthmeで401 ... ok

test result: ok. 6 passed; 0 failed
```

## Issue #34 完了

Phase 6 をもって Issue #34 の全フェーズが完了:

- [x] Phase 1: UserRepository
- [x] Phase 2: PasswordHasher
- [x] Phase 3: SessionManager
- [x] Phase 4: Core API 認証エンドポイント
- [x] Phase 5: BFF 認証ハンドラ
- [x] Phase 6: 統合テスト

完了基準も達成:

- [x] POST /auth/login でログインできる
- [x] POST /auth/logout でログアウトできる
- [x] GET /auth/me で現在のユーザー情報を取得できる

## 次のステップ

- PR を作成してマージ
- Issue #34 をクローズ

## 関連ドキュメント

- [07_認証機能設計.md](../../docs/03_詳細設計書/07_認証機能設計.md)
- [実装解説: Phase 6](../../docs/07_実装解説/01_認証機能/06_Phase6_統合テスト.md)
