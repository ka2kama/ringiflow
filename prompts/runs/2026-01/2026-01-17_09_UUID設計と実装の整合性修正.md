# 2026-01-17_09_UUID設計と実装の整合性修正

## 概要

データベース設計において UUID v4 を主キーとして使用している現状を見直し、ADR-001（ID 形式の選定）で決定された UUID v4 + v7 の使い分けとマイグレーション実装の整合性を確保した。

## 背景と目的

ユーザーから「UUID v4 は B-tree インデックスと相性が悪いのでは？」という指摘があった。

確認の結果、ADR-001 と ID 設計規約では以下の使い分けが決定されていた:
- 参照系（マスタデータ）: UUID v4
- 時系列系（運用データ）: UUID v7

しかし、マイグレーションファイルでは全テーブルが `DEFAULT gen_random_uuid()`（v4）になっており、設計と実装の乖離があった。

## 実施内容

### 1. 設計判断の再確認

プロジェクト理念・要件・セキュリティ要件を再確認し、ADR-001 の決定が妥当であることを検証した。

| 観点 | 評価 |
|------|------|
| B-tree 効率 | 時系列系は v7 で解決、参照系は低頻度挿入のため許容 |
| セキュリティ | v7 のタイムスタンプ漏洩は `created_at` と同等で許容範囲 |
| 分散生成 | Event Sourcing では必須、UUID が適切 |
| シンプルさ | BIGSERIAL + UUID パターンは複雑さが増すだけ |

### 2. マイグレーションの修正

時系列系テーブルから `DEFAULT gen_random_uuid()` を削除し、アプリケーション側で UUID v7 を生成する設計に変更。

- `workflow_instances`: `DEFAULT` 句削除
- `workflow_steps`: `DEFAULT` 句削除

### 3. 設計書の更新

- データベース設計書に「ID 設計方針」セクションを追加
- 各テーブル定義と DDL を更新

### 4. 技術ノートの作成

UUID と B-tree インデックスの関係について技術ノートを作成。

## 成果物

### 変更ファイル

| ファイル | 変更内容 |
|---------|---------|
| `backend/migrations/20260115000006_create_workflow_instances.sql` | `DEFAULT` 句削除、UUID v7 コメント追加 |
| `backend/migrations/20260115000007_create_workflow_steps.sql` | 同上 |
| `docs/03_詳細設計書/02_データベース設計.md` | ID 設計方針追加、テーブル定義・DDL 更新 |

### 新規作成

| ファイル | 内容 |
|---------|------|
| `docs/06_技術ノート/UUIDとB-treeインデックス.md` | UUID v4/v7 の構造と B-tree への影響 |

## 設計判断と実装解説

### なぜ BIGSERIAL + UUID パターンを採用しなかったか

「内部 ID は auto increment、外部公開は UUID」というパターンも検討したが、以下の理由で不採用とした:

1. **UUID v7 で B-tree 効率問題はほぼ解決** - 追加の複雑さに見合わない
2. **Event Sourcing では分散 ID 生成が必須** - 結局 UUID が必要になる
3. **設計のシンプルさ** - 2 つの ID 体系は認知負荷が増える

### なぜ参照系は UUID v4 のままか

1. **挿入頻度が低い** - テナント登録、ユーザー招待は高頻度ではない
2. **作成時刻を隠す** - マスタデータの作成時刻露出を防ぐ防御的設計
3. **時系列ソートが不要** - 参照系データは `created_at` でソートすれば十分

## ユーザープロンプト（抜粋）

> DB 設計について既存の設計書およびマイグレーションファイルを参考に再考したいです。id が UUID v4 だとソートが大変ではないですか？B-tree と相性が悪いのでは？

> セキュリティの懸念も書いてあったはずです。目先の解決ではなくこのプロジェクトの理念、目的、要件に最適な解を考えてください。

> 主キーが UUID である必要はありますか？id は auto increment にしつつ別カラムで UUID を持つとか。

## 学んだこと

1. **設計と実装の整合性確認の重要性** - ADR で決めても実装が追いついていないと意味がない
2. **目先の技術効率だけでなく、プロジェクト全体の理念・要件から判断する** - UUID v7 への全面移行は技術的には可能だが、設計意図との整合性を優先
3. **トレードオフの明示** - BIGSERIAL + UUID パターンのメリット・デメリットを理解した上で不採用とした

## 次のステップ

- Rust 側で UUID v7 生成の実装（`uuid` crate の `now_v7()` を使用）
- `WorkflowInstanceId`, `WorkflowStepId` などの Newtype 実装
