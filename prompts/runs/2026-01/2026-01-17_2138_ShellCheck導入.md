# ShellCheck 導入

## 概要

シェルスクリプトの静的解析ツール ShellCheck を導入し、開発ツール・スクリプトの品質担保を強化した。

## 背景と目的

開発中に使用する自作ツールやスクリプト（デプロイされる成果物とは別）の正しさをどう担保するかという課題があった。

検討した選択肢:
- ShellCheck による静的解析
- rust-script によるテスト可能なスクリプト化
- Python への移行

プロジェクトの理念（KISS、品質追求）と現状のスクリプト複雑度を考慮し、ShellCheck 導入を選択した。将来スクリプトが複雑化した場合は Rust 化を検討する。

## 実施内容

1. **CI に ShellCheck ジョブを追加**
   - `.github/workflows/ci.yml` に `shell` ジョブを追加
   - 変更検出パターン `**/*.sh` を追加

2. **justfile に lint-shell タスクを追加**
   - `git ls-files` を使用して `.git` と `.gitignore` を尊重
   - `lint` タスクに `lint-shell` を追加

3. **check-tools に必要なツールを追加**
   - `shellcheck` を追加
   - `elm-format` を追加（グローバルインストール）

4. **elm-test を devDependencies に移行**
   - elm-format は pnpm との互換性問題があり、グローバルのまま維持

5. **ドキュメント更新**
   - 開発環境構築手順書に ShellCheck を追加
   - CLAUDE.md に開発ツール追加時の同期ルールを追加

## 成果物

### ADR

- [ADR-015: 開発スクリプトの品質担保方針](../../../docs/70_ADR/015_開発スクリプトの品質担保方針.md)

### 更新ファイル

- `.github/workflows/ci.yml`
- `justfile`
- `frontend/package.json`
- `frontend/pnpm-lock.yaml`
- `docs/60_手順書/01_開発参画/01_開発環境構築.md`
- `CLAUDE.md`

### 新規ファイル

- `frontend/pnpm-workspace.yaml`

## 設計判断と実装解説

### シェルスクリプト検索方法の選択

ripgrep と find/git ls-files を比較検討:

| 方式 | メリット | デメリット |
|------|---------|-----------|
| ripgrep | 高速、.gitignore 尊重 | 追加インストール必要 |
| git ls-files | 追加依存なし、.gitignore 尊重 | git リポジトリ前提 |
| find | 追加依存なし | .gitignore 非対応 |

最終的に `git ls-files` を採用。理由:
- 追加の依存が不要
- `.git` と `.gitignore` を自動的に尊重
- このプロジェクトは git リポジトリ前提

### elm-format のグローバルインストール維持

elm-format を devDependencies に移行しようとしたが、pnpm との互換性問題が発生:
- npm パッケージがネイティブバイナリを配布
- pnpm の node_modules 構造でビルドスクリプトが正しく動作しない

Volta でグローバル管理されている環境と競合するため、グローバルインストールを維持することにした。

## 議論の経緯

### スクリプト品質担保の課題

ユーザーから、開発中は様々なツールやスクリプトで効率化をはかっているが、これらの自作ツールやスクリプト類の正しさをどう担保するのかという問題提起があった。

### 最適解の検討

プロジェクトの理念、目的、要件、今後の規模感あたりを加味した上での最適解は何かという観点で検討を進めた。

### ローカル vs CI の判断

ローカルにできるものはローカルでよいという方針が示された。

### 依存ツールの検討

ripgrep を求めるのは酷かという議論があり、代わりに git ls-files を使用する方針に決定した。

### 同期ルールの明文化

check-tools と手順書は毎回同時更新したいという要望があり、CLAUDE.md にルールとして追加した。

## 学んだこと

1. **段階的アプローチの重要性**: 現状のスクリプトはシンプルなので ShellCheck で十分。複雑化したら Rust 化を検討する YAGNI の実践。

2. **git ls-files の活用**: find の代替として `.gitignore` を尊重しつつ、追加依存なしでファイル一覧を取得できる。

3. **pnpm とネイティブバイナリの互換性**: 一部の npm パッケージは pnpm のシンボリックリンク構造と相性が悪い。グローバルインストールが現実的な選択肢になる場合がある。

4. **同期ルールの明文化**: 複数のファイルを同時に更新する必要がある場合、CLAUDE.md にルールとして記載することで漏れを防げる。

## 次のステップ

- スクリプトが増えてきたら dev-tools クレートの導入を検討
- 複雑なロジックが必要になった場合は Rust 化を検討
