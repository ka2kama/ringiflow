# 共有 UI コンポーネントの抽出

## 概要

Issue #182 に基づき、複数ページに重複していた UI パターン（ローディングスピナー、メッセージアラート、日付フォーマット、エラーメッセージ変換、ステータスバッジ CSS マッピング）を共通モジュールとして抽出した。5 Phase の TDD で段階的に実施し、全 Phase を完了した。

## 背景と目的

6つのページモジュール（Home, Workflow/List, Workflow/Detail, Workflow/New, Task/List, Task/Detail）に同一の UI パターンがコピペされており、保守性に課題があった。共通コンポーネントとして抽出することで:

- 変更の1箇所集約（スピナーデザイン変更時に1ファイルの修正で済む）
- コードの重複除去（約240行削減）
- テスタビリティの向上（純粋関数として独立テスト可能に）

## 実施内容

### Phase 1: Util.DateFormat の抽出

4つのページモジュールに散在していた日付フォーマット関数を `Util.DateFormat` モジュールに統合。

- `formatDate`: ISO 8601 → 日付のみ（`String -> String`）
- `formatMaybeDate`: Maybe 対応ラッパー
- `formatDateTime`: ISO 8601 → 日付+時刻（`String -> String`）
- `formatMaybeDateTime`: Maybe 対応ラッパー

基本形と Maybe ラッパーを分離し、単一責務と合成のしやすさを両立。

### Phase 2: Api.ErrorMessage の抽出

`Workflow/Detail.elm` と `Task/Detail.elm` に完全同一だった `apiErrorToMessage` 関数を `Api.ErrorMessage.toUserMessage` に統合。

- エンティティ名をレコード引数 `{ entityName : String }` でパラメータ化
- `NotFound` と `Conflict` のメッセージにエンティティ名を埋め込み
- 全9つの `ApiError` バリアントをテストで検証

### Phase 3: stepStatusToCssClass の集約

`Task/List.elm` と `Task/Detail.elm` にあった `stepStatusToCssClass` を `Data.WorkflowInstance` に追加。既存の `statusToCssClass` と対称的な構造。

### Phase 4: Component.LoadingSpinner の抽出

7箇所のインライン HTML を `Component.LoadingSpinner.view` に置換。型変数 `msg`（小文字）で任意のページから利用可能。

### Phase 5: Component.MessageAlert の抽出

`Workflow/Detail.elm` と `Task/Detail.elm` の `viewMessages` をレコード引数パターンの `Component.MessageAlert.view` に置換。`Workflow/New.elm` の `SaveMessage` 型は別パターンのため対象外とした。

## 設計上の判断

| 判断 | 選択 | 理由 |
|------|------|------|
| モジュール配置 | `Component/`, `Api/`, `Util/` | 役割ベース命名で既存の `Data/`, `Page/`, `Form/` と一貫 |
| `Badge.elm` の見送り | `Data.WorkflowInstance` に追加 | ステータス型と同じモジュールに置く方が凝集度が高い |
| `Workflow/New.elm` の対象外 | 統合しない | `SaveMessage` カスタム型は `successMessage/errorMessage` のパターンと異なる |
| MessageAlert の引数形式 | レコード引数 | 呼び出し側の意図が明確で、将来のフィールド追加にも対応 |

## 成果物

### コミット

| コミット | 内容 |
|---------|------|
| `1f5b7d1` | Phase 1: Util.DateFormat 抽出 |
| `c49a918` | Phase 2: Api.ErrorMessage 抽出 |
| `58d2ab1` | Phase 3: stepStatusToCssClass 集約 |
| `809659a` | Phase 4: Component.LoadingSpinner 抽出 |
| `fb67026` | Phase 5: Component.MessageAlert 抽出 |

### 新規ファイル

| ファイル | 概要 |
|---------|------|
| `frontend/src/Util/DateFormat.elm` | 日付フォーマットユーティリティ |
| `frontend/src/Api/ErrorMessage.elm` | ApiError → ユーザー向けメッセージ変換 |
| `frontend/src/Component/LoadingSpinner.elm` | ローディングスピナー |
| `frontend/src/Component/MessageAlert.elm` | 成功/エラーメッセージアラート |
| `frontend/tests/Util/DateFormatTest.elm` | DateFormat テスト（11件） |
| `frontend/tests/Api/ErrorMessageTest.elm` | ErrorMessage テスト（10件） |

### 変更ファイル

| ファイル | 変更内容 |
|---------|---------|
| `frontend/src/Data/WorkflowInstance.elm` | `stepStatusToCssClass` 追加 |
| `frontend/src/Page/Home.elm` | LoadingSpinner 置換 |
| `frontend/src/Page/Workflow/List.elm` | DateFormat + LoadingSpinner 置換 |
| `frontend/src/Page/Workflow/Detail.elm` | 全5モジュール置換 |
| `frontend/src/Page/Workflow/New.elm` | LoadingSpinner 置換 |
| `frontend/src/Page/Task/List.elm` | DateFormat + LoadingSpinner + stepStatusToCssClass 置換 |
| `frontend/src/Page/Task/Detail.elm` | 全5モジュール置換 |
| `frontend/tests/Data/WorkflowInstanceTest.elm` | stepStatusToCssClass テスト追加 |

### PR

- [#191](https://github.com/ka2kama/ringiflow/pull/191)

## 議論の経緯

計画承認済みの Issue であり、ユーザーとの追加議論はなかった。実装計画に従い TDD で段階的に進行した。

## 学んだこと

- Elm の `replace_all` でリファクタリングする際、関数の呼び出し箇所だけでなく関数定義内のパターンも置換されてしまうリスクがある（改善記録として別途記録）
- 基本形（`String -> String`）と Maybe ラッパーの分離は、Elm の純粋関数設計で合成しやすい API になる
- レコード引数パターンはコンポーネントの公開 API 設計で位置引数より可読性・拡張性が高い

## 発見した問題

- Edit ツールの `replace_all` オプションが、関数名だけでなく関数定義内部の同一文字列も置換してしまう。`apiErrorToMessage error` を `ErrorMessage.toUserMessage ...` に `replace_all` で置換した際、呼び出し箇所だけでなく関数定義の本体行も書き換わった（改善記録: `2026-01-31_1806_replace_allの意図しない置換.md`）

## 次のステップ

- PR #191 の CI 通過確認 → Ready for Review → マージ
- Issue #182 のクローズ（マージで自動クローズ）
- 振り返りコメントの投稿
