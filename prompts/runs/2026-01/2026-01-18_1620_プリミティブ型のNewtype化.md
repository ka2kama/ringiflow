# 2026-01-18_01: プリミティブ型の Newtype 化

## 概要

ドメインモデルで `String` や `i32` として定義されていたフィールドを Newtype パターンでラップし、型安全性を向上させた。

## 背景と目的

コードベース内で以下の問題が指摘された:

1. `User.name` や `WorkflowDefinition.name` が `String` のまま → 他のフィールドと取り違えるリスク
2. `WorkflowDefinition.version` が `i32` → 負数やゼロが表現可能（不正状態）

プロジェクトの設計原則「型で表現できるものは型で表現する」「不正な状態を表現不可能にする」に従い、Newtype 化を実施した。

## 実施内容

### 1. 調査フェーズ

- 既存の Newtype パターン実装（UserId, Email 等）を確認
- 生のプリミティブ型が使われている箇所を特定
- Newtype 化の対象と優先度を決定

### 2. 実装フェーズ

`value_objects.rs` モジュールを新規作成し、以下の Newtype を定義:

| 型 | ラップ対象 | バリデーション |
|---|-----------|---------------|
| `Version` | `u32` | 1 以上 |
| `UserName` | `String` | 空文字禁止、100 文字以内、前後空白トリム |
| `WorkflowName` | `String` | 空文字禁止、200 文字以内、前後空白トリム |

### 3. 移行フェーズ

- `workflow.rs`: `name` → `WorkflowName`、`version` → `Version`
- `user.rs`: `name` → `UserName`
- インフラ層・テストコードの型変換処理を追加

## 成果物

### 作成・更新ファイル

| ファイル | 変更内容 |
|---------|---------|
| `backend/crates/domain/src/value_objects.rs` | 新規作成 |
| `backend/crates/domain/src/lib.rs` | モジュール追加 |
| `backend/crates/domain/src/workflow.rs` | Newtype 適用 |
| `backend/crates/domain/src/user.rs` | Newtype 適用 |
| `backend/crates/infra/src/repository/user_repository.rs` | 型変換追加 |
| `backend/apps/core-api/src/usecase/auth.rs` | テスト修正 |
| `backend/apps/core-api/src/handler/auth.rs` | テスト修正 |
| `backend/crates/infra/tests/user_repository_test.rs` | テスト修正 |
| `docs/05_ADR/016_プリミティブ型のNewtype化方針.md` | 新規作成 |
| `docs/06_技術ノート/Newtypeパターン.md` | 追記 |

### テスト結果

- ユニットテスト: 60 件全て通過
- ドキュメントテスト: 10 件全て通過

## 設計判断と実装解説

### Newtype 化の判断基準

全てのフィールドを Newtype 化するのではなく、以下の基準で対象を選定:

| 対象 | Newtype 化 | 理由 |
|------|-----------|------|
| ID 型 | ○ 必須 | 取り違え防止が最重要 |
| 名前系（UserName 等） | ○ 推奨 | ドメイン概念として意味を持つ |
| バージョン番号 | ○ 推奨 | 不正値を排除 |
| description, comment | × 不要 | 自由形式テキスト |

### value_objects モジュールの設計

複数エンティティで共有される値オブジェクトを専用モジュールに集約:

- エンティティ固有の値オブジェクト（Email, Password）→ そのエンティティと同じモジュール
- 汎用的な値オブジェクト（Version, UserName 等）→ `value_objects.rs`

これにより循環依存を避けつつ再利用性を確保。

### コンパイラによるバグ検出

移行作業中、テストコード 5 箇所でコンパイルエラーが発生:

```
error[E0308]: mismatched types
  --> apps/core-api/src/usecase/auth.rs:233:10
     |
233 |          "Test User".to_string(),
     |          ^^^^^^^^^^^^^^^^^^^^^^^ expected `UserName`, found `String`
```

これは Newtype の価値を示す好例:
- 型の不一致がコンパイル時に検出される
- 実行時まで問題が発覚しない事態を防ぐ

## 議論の経緯

### Newtype 化の提案

ユーザーから、String や u64 をそのまま使っている箇所があり、Newtype 化すべきではないかという指摘があった。

### 対象の選定

Newtype 化の対象について確認があり、名前系フィールドとバージョン番号が選択された。

### ドキュメント整備

ドキュメントを追加してほしいという要望があり、ADR と技術ノートを更新した。また、セッションログの作成も依頼された。

## 学んだこと

1. **Newtype 導入の波及効果**: 型変更により、関連するコード（リポジトリ、テスト）の修正が必要になる。しかし、コンパイルエラーが全ての修正箇所を教えてくれるため、見落としがない

2. **判断基準の明文化**: 「どこまで Newtype 化するか」を ADR に記録しておくことで、将来の判断に一貫性が生まれる

3. **テストコードも型安全性の恩恵を受ける**: テストで使う fixture もドメイン型を使うことで、テスト自体の品質も向上する

## 関連ドキュメント

- [ADR-016: プリミティブ型の Newtype 化方針](../../docs/05_ADR/016_プリミティブ型のNewtype化方針.md)
- [技術ノート: Newtype パターン](../../docs/06_技術ノート/Newtypeパターン.md)
