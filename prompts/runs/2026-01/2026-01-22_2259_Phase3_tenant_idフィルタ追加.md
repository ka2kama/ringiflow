# Phase 3 修正: tenant_id フィルタ追加

## 概要

PR #97 のレビューで指摘された `CredentialsRepository` の tenant_id フィルタ漏れを修正した。

## 対応 Issue

[#80 Auth Service を分離する](https://github.com/ka2kama/ringiflow/issues/80)

## 背景

Phase 3 の実装で `CredentialsRepository` の以下のメソッドに `tenant_id` フィルタが欠落していた:

- `find_by_user_and_type`: user_id と credential_type のみでフィルタ
- `delete_by_user`: user_id のみでフィルタ

マルチテナント環境では、すべてのデータアクセスで `tenant_id` によるフィルタリングが必須。

## 変更内容

### 1. CredentialsRepository トレイト

```rust
// Before
async fn find_by_user_and_type(
    &self,
    user_id: &UserId,
    credential_type: CredentialType,
) -> Result<Option<Credential>, InfraError>;

async fn delete_by_user(&self, user_id: &UserId) -> Result<(), InfraError>;

// After
async fn find_by_user_and_type(
    &self,
    tenant_id: &TenantId,  // 追加
    user_id: &UserId,
    credential_type: CredentialType,
) -> Result<Option<Credential>, InfraError>;

async fn delete_by_user(
    &self,
    tenant_id: &TenantId,  // 追加
    user_id: &UserId,
) -> Result<(), InfraError>;
```

### 2. SQL クエリ

```sql
-- Before
WHERE user_id = $1 AND credential_type = $2

-- After
WHERE tenant_id = $1 AND user_id = $2 AND credential_type = $3
```

### 3. API エンドポイント

```
Before: DELETE /internal/auth/credentials/{user_id}
After:  DELETE /internal/auth/credentials/{tenant_id}/{user_id}
```

### 4. 修正ファイル

| ファイル | 変更内容 |
|---------|---------|
| `credentials_repository.rs` | トレイト定義と実装を修正 |
| `usecase.rs` | トレイト定義を修正 |
| `usecase/auth.rs` | 実装とテストを修正 |
| `handler/auth.rs` | ハンドラとテストを修正 |
| `main.rs` | ルート定義を修正 |
| `.sqlx/*.json` | キャッシュを更新 |

## 漏れた原因の分析

### 1. 「user_id は UUID でグローバルに一意」という誤った安心感

UUID v7 でグローバルに一意であるため、「tenant_id なしでも問題ない」と誤認。しかし防御的プログラミングの観点では不十分。

### 2. 既存コードとの一貫性チェック不足

`UserRepository.find_by_email` は `tenant_id` を受け取っているのに、`CredentialsRepository` だけ省略していた。

### 3. 設計書に明記されていたのに見落とし

ドキュメントコメントに「テナント分離: すべてのクエリでテナント ID を考慮」と明記されていた。

## 再発防止策

**既存リポジトリとのパターン比較**を推奨:

- `UserRepository` を「お手本」として参照
- 新規リポジトリ作成時に API シグネチャを比較
- 全メソッドの第一引数が `tenant_id` かを確認

## コミット

```
ffd30eb #80 fix: CredentialsRepository に tenant_id フィルタを追加
```
