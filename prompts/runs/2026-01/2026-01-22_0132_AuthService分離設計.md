# Auth Service 分離設計

## 概要

Issue #80 に基づき、Auth Service 分離の詳細設計を実施。

## 背景と目的

### 発端

ユーザーから「#80 をすすめます」という指示でセッションを開始。Issue #80 は ADR-017 で決定した Auth Service 分離の実装タスク。

### セッションの流れ

1. **既存実装の確認**: BFF と Core API の認証コードを読み、現状を把握
2. **設計判断の確認**: credentials の保存先について「DB 分離（auth スキーマ）」をユーザーが選択
3. **設計書作成**: 08_AuthService設計.md を作成し、基本設計書・関連設計書を更新
4. **技術的な質疑応答**: サーキットブレーカー、スキーマ分離、FK 制約などについてユーザーから質問
5. **技術ノート作成**: 一般的な知見を技術ノートとして切り出し
6. **CI 問題の発見と修正**: Draft → Ready 時に Claude Auto Review がトリガーされない問題を修正
7. **レビューの問題発見**: Claude Auto Review のインラインコメントに関するハルシネーションを発見

## 実施内容

### 設計書作成

1. **08_AuthService設計.md** を新規作成
   - 責務分担（BFF / Auth Service / Core API）
   - データモデル設計（auth スキーマ、credentials テーブル）
   - API 設計（/internal/auth/verify, /internal/auth/credentials）
   - サービス間通信設計（サーキットブレーカー含む）
   - 実装方針（初回デプロイ前のため新規構築）

2. **基本設計書の更新**
   - アーキテクチャ図に Auth Service を追加

3. **関連設計書の更新**
   - 02_データベース設計.md: auth スキーマ追加、Redis キー形式修正
   - 06_テナント退会時データ削除設計.md: auth.credentials を削除対象に追加

### ADR 作成

- **ADR-020**: サーキットブレーカーの状態管理方式
  - インスタンス単位で状態を持つ方式を採用
  - Redis 共有方式は複雑さとレイテンシの観点で却下

### 技術ノート作成

- **サーキットブレーカー.md**: パターンの解説、Rust 実装例
- **マイクロサービス間のデータ整合性.md**: FK を設けない理由、整合性担保パターン

### CI 改善

- `pull_request` イベントに `ready_for_review` タイプを追加
  - Draft → Ready 変更時に CI がトリガーされるよう修正

## 設計上の判断

| 判断 | 選択 | 理由 |
|------|------|------|
| credentials の保存先 | auth スキーマ（同一 DB 内） | 運用シンプルさと将来の DB 分離への移行パスを両立 |
| FK 制約 | 設けない | サービス境界の独立性、将来の DB 分離を考慮 |
| サーキットブレーカー状態 | インスタンス単位 | シンプルさ優先、Redis 依存を避ける |
| 移行方式 | 新規構築 | 初回デプロイ前のため段階的移行は不要 |
| タイミング攻撃対策 | ダミーハッシュ検証 | 固定 sleep より自然な時間分布 |

## 成果物

- PR #93: Auth Service 分離の設計書を追加

## 議論の経緯

### credentials の保存先

設計の初期段階で、credentials をどこに保存するか選択肢を提示し、ユーザーが「DB 分離（auth スキーマ）」を選択した。同一 DB 内でスキーマを分けることで、運用のシンプルさと将来の DB 分離への移行パスを両立できる。

### PostgreSQL のスキーマと DB の違い

ユーザーから PostgreSQL におけるスキーマと DB の違いについて質問があった。具体的には「両者は別の概念か」「接続時に DB を指定するが、Auth Service と Core API は同じ DB に接続するのか」という点。両サービスは同じ `ringiflow` DB に接続し、スキーマで論理的に分離することを説明。設計書に DB 接続方式のセクションを追加した。

### FK 制約を設けない理由

ユーザーから、FK 制約は別スキーマ間でも設定可能かという質問があった。技術的には可能だが、サービス境界の独立性と将来の DB 分離を考慮して意図的に設けない設計であることを説明。ユーザーから設計書に理由を明記するよう指摘を受け、設計書に追記した。さらに、一般的な知見は技術ノートにも記載してほしいとの要望があり、「マイクロサービス間のデータ整合性」技術ノートを作成した。

### サーキットブレーカーのスケーラビリティ

ユーザーから、メモリに状態を持つとスケールアウト時に問題があるのではないかという懸念が出た。3つの方式（インスタンス単位、Redis 共有、ハイブリッド）を比較検討し、シンプルさを優先して業界標準でもあるインスタンス単位を採用。ADR-020 として文書化した。

### 移行計画の簡略化

当初の設計書では Feature Flag を使った段階的移行を計画していたが、ユーザーから初回デプロイ前であるため柔軟に対応できるとの指摘があった。設計書を「新規構築」方式に簡略化した。

### タイミング攻撃対策

ユーザーから、タイミング攻撃対策にジッターは不要かという質問があった。既存実装を確認したところ、固定 sleep ではなくダミーハッシュ検証を既に採用していた。設計書を実装に合わせて修正した。

### CI の問題発見と修正

PR を Draft → Ready に変更したが、Claude Auto Review がトリガーされない問題が発生した。原因は `pull_request` イベントのデフォルト types に `ready_for_review` が含まれていないこと。CI ワークフローに `ready_for_review` を追加して修正した。

### Claude Auto Review のハルシネーション

レビュー結果に「インラインコメントで記載しました」とあるが、実際にはインラインコメントが作成されていなかった。ログを確認したが詳細は不明。プロンプト修正を試みたが効果的な対策が見つからず、別途調査することとした。

## 学んだこと

- **スキーマ分離 vs DB 分離**: 同一 DB 内でスキーマを分けることで、運用のシンプルさと将来の分離への移行パスを両立できる
- **FK 制約とサービス境界**: マイクロサービス間では FK 制約を設けず、API 経由で整合性を担保するのが一般的
- **サーキットブレーカーの状態管理**: インスタンス単位が業界標準（Netflix Hystrix もデフォルト）。Redis 共有は複雑さに見合わないことが多い
- **タイミング攻撃対策**: 固定 sleep よりダミーハッシュ検証の方が、CPU/メモリ状況による自然な変動を含むため検出が困難
- **GitHub Actions の `pull_request` イベント**: デフォルトでは `ready_for_review` は含まれないため、明示的に `types` を指定する必要がある

## 発見した問題

- Claude Auto Review がインラインコメントについてハルシネーション
  - 「インラインコメントで記載しました」と報告するが、実際には作成されていない
  - 別途調査が必要

## 次のステップ

- PR #93 をマージ
- Auth Service の実装（Issue #80 の残タスク）
