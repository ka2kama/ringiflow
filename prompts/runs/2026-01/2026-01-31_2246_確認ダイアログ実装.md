# 確認ダイアログ実装

## 概要

Issue #176 に基づき、承認/却下ボタンクリック時に確認ダイアログを表示する機能を実装した。
タスク詳細ページと申請詳細ページの両方に対応し、ESC キーやオーバーレイクリックでのキャンセルも可能にした。
また、mprocs ハング時の孤児プロセス対策として `just dev-kill` タスクを追加した。

## 背景と目的

承認・却下は取り消し不可能な破壊的操作であり、誤操作防止のための確認ステップが必要だった。
計画は事前に策定済み（Issue #176 のコメント + Plan Mode での設計レビュー）で、本セッションは実装フェーズ。

## 実施内容

TDD で Phase 1〜4 を順に実装した。

### Phase 1: 共有ユーティリティとコンポーネント

- `Util.KeyEvent.escKeyDecoder` のテストを先に作成（Red → Green）
- `Component.ConfirmDialog` をステートレス view コンポーネントとして作成
  - `MessageAlert` と同じパターン: 型変数 `msg` + レコード型パラメータ
  - `ActionStyle` 型（Positive / Destructive）でボタン色を制御

### Phase 2: Page/Task/Detail.elm に統合

- `PendingAction` 型をページローカルに定義
- `ClickApprove`/`ClickReject` の意味を「即 API 呼び出し」→「ダイアログ表示」に変更
- `ConfirmAction`/`CancelAction` メッセージを追加
- `subscriptions` 関数を新設（ダイアログ表示中のみ ESC キーを購読）

### Phase 3: Page/Workflow/Detail.elm に統合

Phase 2 と同一パターン。コメント入力がない点のみ異なる。

### Phase 4: Main.elm の subscriptions 接続

- `Sub.none` → 各ページの `subscriptions` にルーティング
- `Sub.map` で Nested TEA パターンを適用

### 追加: dev-kill タスク

mprocs ハング時に孤児プロセスを一括終了する `just dev-kill` を追加。

## 設計上の判断

### PendingAction をページローカルに定義

各ページの承認フローが微妙に異なる（Task: コメントあり、Workflow: コメントなし）ため、
共有モジュールにせずページローカルに定義した。過度な DRY を避ける方針に合致。

### 条件付き subscription

`pendingAction /= Nothing` のときだけ ESC キーを購読する。
Elm の subscription は宣言的で、`subscriptions` 関数が毎回呼ばれ返す `Sub` が「あるべき購読状態」を表す。
不要なグローバルキーイベントを避けられる。

### 既存 API 呼び出しロジックの非変更

`approveStep`/`rejectStep` 関数と `handleApprovalResult` は一切変更せず、
「ボタンクリック → API 呼び出し」の間に確認ステップを挟むだけに留めた。

## 成果物

### コミット

- `#176 Add confirmation dialogs for approve/reject actions`
- `#176 Add dev-kill task for killing orphaned dev server processes`

### 作成・変更ファイル

| ファイル | 操作 |
|---------|------|
| `frontend/src/Component/ConfirmDialog.elm` | 新規 |
| `frontend/src/Util/KeyEvent.elm` | 新規 |
| `frontend/tests/Util/KeyEventTest.elm` | 新規 |
| `frontend/src/Page/Task/Detail.elm` | 変更 |
| `frontend/src/Page/Workflow/Detail.elm` | 変更 |
| `frontend/src/Main.elm` | 変更 |
| `justfile` | 変更 |

### PR

- [#194](https://github.com/ka2kama/ringiflow/pull/194)（Draft）

## 議論の経緯

### mprocs ハングへの対応

セッション中に mprocs がハングし、孤児プロセスが残る問題が発生した。
手動で `kill` するのは面倒なため、`just dev-kill` タスクを追加して一括終了できるようにした。
`pkill -f` でコマンドライン文字列パターンを指定する方式を採用。

## 学んだこと

- Elm の subscription は宣言的。条件付き購読は `case` 式で自然に表現できる
- ステートレス view コンポーネントは型変数 `msg` を使うことで、各ページから柔軟に再利用可能
- Nested TEA での `subscriptions` ルーティングは `view` での `Html.map` と同じパターン

## 次のステップ

- 手動テストでダイアログの動作を確認
- テスト通過後、`gh pr ready` で Ready for Review に変更
