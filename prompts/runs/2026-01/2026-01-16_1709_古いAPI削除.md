# 2026-01-16_04 古い API 削除

## 概要

BFF と Core API の分離後に残っていた古い `apps/api/` ディレクトリを削除し、マイグレーションファイルを適切な場所に移動した。

## 背景と目的

BFF と Core API を独立したクレートとして `apps/bff/` と `apps/core-api/` に分離した後、古い統合型の `apps/api/` が残存していた。これにより以下の問題があった:

- 同じ機能を持つコードが重複
- マイグレーションファイルが古いディレクトリに残存
- ドキュメントが古いパスを参照

## 実施内容

### 1. 現状調査

- `apps/api/` 配下に古い BFF/Core API バイナリが残存していることを確認
- justfile は既に新しいクレート（`ringiflow-bff`, `ringiflow-core-api`）を使用していることを確認
- マイグレーションファイルが `apps/api/migrations/` に残っていることを発見

### 2. マイグレーション移動

```
apps/api/migrations/ → apps/core-api/migrations/
```

Core API がデータベースを担当するため、マイグレーションは Core API 配下に配置。

### 3. ドキュメント更新

`apps/api` を参照していた以下のドキュメントを更新:

- 設計書（2ファイル）
- 手順書（3ファイル）
- 技術ノート（5ファイル）

ADR は意思決定時点の履歴記録として変更せず保持。

### 4. 古いディレクトリ削除

`apps/api/` 配下の以下を削除:

- `src/bin/bff.rs`, `src/bin/core_api.rs` - 古いバイナリ
- `src/handler.rs`, `src/config.rs`, `src/error.rs` - 共有モジュール
- `Cargo.toml`, `.env.template` - 設定ファイル

## 成果物

### コミット

- `5748c4c` 古い apps/api を削除し、migrations を core-api に移動

### 削除ファイル

- `apps/api/` 配下全体（10ファイル）

### 移動ファイル

- マイグレーション（9ファイル）: `apps/api/migrations/` → `apps/core-api/migrations/`

### 更新ファイル

| カテゴリ | ファイル |
|---------|---------|
| 設計書 | `02_データベース設計_MVP.md`, `07_テナント退会時データ削除設計.md` |
| 手順書 | `02_プロジェクトセットアップ.md`, `01_CICD構築.md`, `03_GitHub設定.md` |
| 技術ノート | `BFFパターン.md`, `Cargoワークスペース.md`, `GitHubActions.md`, `Rustエラーハンドリング.md`, `sqlx-cli.md` |

## 設計判断と実装解説

### マイグレーションの配置場所

マイグレーションを `apps/core-api/migrations/` に配置した理由:

1. **責務の明確化**: Core API がデータベースアクセスを担当
2. **依存関係の一貫性**: BFF は Redis のみ、Core API は PostgreSQL を担当
3. **sqlx の規約**: マイグレーションはデータベースを使用するクレートに配置

### ADR を更新しなかった理由

ADR（Architecture Decision Records）は意思決定時点の記録であり、後から変更すべきではない。構造変更があった場合は:

- 新しい ADR を作成するか
- 既存 ADR に「変更履歴」セクションを追加

今回は軽微なリファクタリングのため、ADR の新規作成は不要と判断。

## ユーザープロンプト（抜粋）

> BFF と Core API を分けたはずですが、古い API が残っていそうです。

> マイグレーションファイルも消えていますが、大丈夫ですか？

## 学んだこと

- アーキテクチャ変更後は、古いコードの残存を確認する必要がある
- マイグレーションファイルの配置は、データベースを担当するサービスに合わせる
- ADR は履歴記録として保持し、安易に変更しない
