# 2026-01-19_01: just setup タスクの順序修正

## 概要

`just setup` が失敗する問題を修正した。
原因は sqlx のコンパイル時 DB 検証により、マイグレーション前に `cargo build` が実行されていたこと。

## 背景と目的

`just setup` を実行すると `cargo build` がエラーで失敗していた。
ユーザーが「migration と cargo build の順番が逆」と指摘し、調査・修正を行った。

## 実施内容

### 1. 問題の特定

修正前の `setup` タスク依存順序:

```
setup: check-tools setup-env setup-deps setup-hooks dev-deps setup-db
```

問題点:
- `setup-deps`（cargo build を含む）が `dev-deps`（PostgreSQL 起動）と `setup-db`（マイグレーション）より前に実行
- sqlx はコンパイル時に DB スキーマを検証するため、DB が準備されていないとビルドが失敗

### 2. 修正内容

1. **setup タスクの順序変更**
   - `setup-deps` を最後に移動

2. **docker compose --wait フラグ追加**
   - `dev-deps` で healthcheck が通るまで待機するように変更
   - `setup-db` の `sleep 3` を削除（--wait で不要に）

3. **pnpm ビルドスクリプト設定**
   - pnpm v9 のセキュリティ機能で esbuild のビルドスクリプトがブロックされていた
   - `pnpm-workspace.yaml` を追加して設定

修正後の順序:

```
setup: check-tools setup-env setup-hooks dev-deps setup-db setup-deps
```

## 成果物

### コミット

- `fix(setup): sqlx コンパイル時検証のため setup タスク順序を修正`

### 作成/更新ファイル

| ファイル | 内容 |
|---------|------|
| `justfile` | setup タスク順序変更、--wait 追加 |
| `frontend/.npmrc` | esbuild ビルドスクリプト設定（標準的な場所） |
| `docs/06_技術ノート/DockerCompose_healthcheck.md` | 新規作成 |
| `docs/06_技術ノート/pnpm_ビルドスクリプト制限.md` | 新規作成 |
| `docs/06_技術ノート/pnpm_コマンド.md` | 新規作成 |
| `docs/06_技術ノート/esbuild.md` | 新規作成 |

### GitHub

| 種別 | URL |
|------|-----|
| PR | [#84](https://github.com/ka2kama/ringiflow/pull/84) |

## 設計判断と実装解説

### なぜ `--wait` を使うか

固定の `sleep` は以下の問題がある:
- マシン負荷やネットワーク状況で不足/過剰になる
- 「本当に接続可能か」を判定していない

`docker compose --wait` は各サービスの **healthcheck** が通るまで待機するため:
- 確実かつ無駄がない
- PostgreSQL なら `pg_isready` などで実際の接続可能性を確認

### pnpm v9 のビルドスクリプト制限

pnpm v9 から、依存パッケージの `postinstall` などのスクリプトがデフォルトでブロックされるようになった。
これはサプライチェーン攻撃対策。

`esbuild` はネイティブバイナリをダウンロードするためスクリプト実行が必要だが、
今回は `ignoredBuiltDependencies` で無視する設定を選択した。

## 学んだこと

1. **sqlx のコンパイル時検証**
   - ビルド順序に制約を課す
   - 開発環境セットアップ時は DB → マイグレーション → ビルドの順序が必須

2. **docker compose --wait**
   - healthcheck ベースの待機で確実なサービス起動確認
   - 固定 sleep より信頼性が高い

3. **pnpm v9 のセキュリティ強化**
   - ビルドスクリプトはデフォルトブロック
   - `pnpm approve-builds` で明示的に許可/無視を設定
