# BFF / Core API 分離リファクタリング

## 概要

Phase 1 開始前にリポジトリ全体を見直し、設計書と実装の不一致を解消。
`apps/api`（単一パッケージ）を `apps/bff` と `apps/core-api`（独立サービス）に分離した。

## 背景

- Phase 0 完了確認時に、設計書と実装の乖離を発見
- 設計書: `apps/bff/` と `apps/core-api/` を独立サービスとして定義
- 実装: `apps/api/` 単一パッケージ内の 2 バイナリ

## 判断

プロジェクト理念に基づき、設計書に合わせてリファクタを選択。

**理由:**
1. **理念1（学習効果の最大化）**: 独立サービス間通信を実体験できる
2. **理念2（品質の追求）**: 責務が明確に異なるので分離が自然
3. Phase 1 開始前の今がリファクタの最良タイミング

## 実施内容

### 新規作成

- `apps/bff/` - BFF サービス（セッション管理、CSRF 防御、プロキシ）
- `apps/core-api/` - Core API サービス（ビジネスロジック、データアクセス）

### 更新

- `Cargo.toml` - workspace members を更新
- `justfile` - `dev-bff`, `dev-core-api` コマンドに変更
- `.env.template` - `CORE_API_URL` を追加
- `docs/02_設計書/01_プロジェクト構造設計.md` - 依存クレートのバージョン記載を簡素化

### 削除（手動）

- `apps/api/` - 旧ディレクトリ（権限の関係で手動削除が必要）

## 新しいコマンド

```bash
just dev-core-api  # Core API 起動（ポート 13001）
just dev-bff       # BFF 起動（ポート 13000）
```

## 学んだこと

- 設計書にライブラリのバージョンを書くと乖離リスクがある
- 設計書は「構造・意図・考え方」に集中し、詳細は実装に任せるべき
- コミット前に lint と test を実行すべき

## 副次的な修正: Claude Code Action

PR 作成時に Claude Code Review ワークフローが OIDC token エラーで失敗。
調査の結果、以下が漏れていたことが判明:

1. ワークフローの `permissions` 設定（`id-token: write` が必要）
2. ruleset への required status checks 追加手順

### 修正内容

`.github/workflows/claude-review.yml` に permissions を追加:

```yaml
permissions:
  contents: read
  pull-requests: write
  issues: write
  id-token: write
```

### 関連

- 技術ノート: [GitHub Actions OIDC](../../../docs/06_ナレッジベース/devtools/GitHub_Actions_OIDC.md)

## 次のステップ

Phase 1 開始: DB スキーマ作成（SQLx マイグレーション）
