# Phase 5: BFF 認証ハンドラ実装

## 概要

| 項目 | 内容 |
|-----|------|
| 日時 | 2026-01-18 |
| Issue | [#34 ユーザー認証](https://github.com/ka2kama/ringiflow/issues/34) |
| Phase | Phase 5: BFF 認証ハンドラ |
| 成果物 | BFF 認証エンドポイント（login, logout, me） |

## 実装内容

### 新規作成

| ファイル | 説明 |
|---------|------|
| `backend/apps/bff/src/client/mod.rs` | クライアントモジュール定義 |
| `backend/apps/bff/src/client/core_api.rs` | Core API クライアント |
| `backend/apps/bff/src/handler/auth.rs` | 認証ハンドラ（750行） |

### 変更

| ファイル | 変更内容 |
|---------|---------|
| `backend/Cargo.toml` | axum-extra, reqwest, time を追加 |
| `backend/apps/bff/Cargo.toml` | 依存関係追加 |
| `backend/apps/bff/src/config.rs` | redis_url, core_api_url を追加 |
| `backend/apps/bff/src/handler/mod.rs` | auth モジュールを追加 |
| `backend/apps/bff/src/main.rs` | ルーティングを追加 |

## 設計判断

### X-Tenant-ID ヘッダーによるテナント識別

MVP ではリクエストヘッダー `X-Tenant-ID` でテナントを識別する。

理由:
- 開発・テストが容易
- ローカル環境で DNS 設定が不要
- 将来的にミドルウェアでサブドメインからヘッダーへ変換可能

本番環境ではサブドメイン方式（`tenant1.ringiflow.com`）に移行予定。

### トレイトによる依存関係の抽象化

`CoreApiClient` と `SessionManager` をトレイトで定義し、テスト時にスタブを注入。

```rust
pub async fn login<C, S>(
    State(state): State<Arc<AuthState<C, S>>>,
    ...
) -> impl IntoResponse
where
    C: CoreApiClient,
    S: SessionManager,
```

メリット:
- 外部 API に依存せずにテスト可能
- コンパイル時に型チェック
- axum のパターンに準拠

## テスト結果

```
running 7 tests
test handler::auth::tests::test_login_テナントIDヘッダーなしで400 ... ok
test handler::auth::tests::test_login_認証失敗で401 ... ok
test handler::auth::tests::test_login_成功時にセッションcookieが設定される ... ok
test handler::auth::tests::test_login_成功時にユーザー情報が返る ... ok
test handler::auth::tests::test_logout_セッションが削除されてcookieがクリアされる ... ok
test handler::auth::tests::test_me_未認証で401 ... ok
test handler::auth::tests::test_me_認証済みでユーザー情報が返る ... ok

test result: ok. 7 passed; 0 failed
```

## 次のステップ

- Phase 6: 統合テスト（BFF + Core API + Redis + PostgreSQL）
  - ログイン → /auth/me → ログアウトの一連フロー
  - エラーケースの E2E テスト

## 関連ドキュメント

- [07_認証機能設計.md](../../../docs/40_詳細設計書/07_認証機能設計.md)
- 実装解説: Phase 5（統合後のファイル: [02_認証機能_コード解説.md](../../../docs/90_実装解説/PR46_認証機能/02_認証機能_コード解説.md)）
