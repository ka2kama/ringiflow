# 2026-01-17_04_SQLxオフラインキャッシュ修正

## 概要

PR #46 の CI 失敗を修正。SQLx オフラインキャッシュの追加漏れが原因だった。

## 背景と目的

PR #46（ユーザー認証実装 #34）で Rust の CI が失敗していた。
原因を調査し、修正する。

## 実施内容

### 1. CI 失敗原因の調査

```bash
gh pr checks 46
gh run view 21083620361 --log-failed
```

エラーメッセージ：
```
error: `SQLX_OFFLINE=true` but there is no cached data for this query,
run `cargo sqlx prepare` to update the query cache or unset `SQLX_OFFLINE`
```

### 2. 原因特定

- SQLx の `sqlx::query!` マクロはコンパイル時に SQL を検証する
- CI 環境では `SQLX_OFFLINE=true` が設定されており、DB 接続なしでビルドする
- オフラインモードでは `.sqlx/` ディレクトリのキャッシュを参照する
- **PR で新しい SQL クエリを追加したが、`cargo sqlx prepare` を実行していなかったためキャッシュが存在しなかった**

### 3. 修正

```bash
just setup-db
cd backend && cargo sqlx prepare --workspace
git add backend/.sqlx/
git commit --amend --no-edit
```

## 成果物

### 変更ファイル

| ファイル | 変更内容 |
|---------|---------|
| `backend/.sqlx/query-*.json` | SQLx オフラインキャッシュ（4ファイル追加） |
| `docs/06_技術ノート/sqlx-cli.md` | オフラインモード詳細セクションを追加 |

## 学んだこと

### SQLx オフラインモードの運用

- SQL クエリを追加・変更したら **必ず** `cargo sqlx prepare` を実行する
- `.sqlx/` ディレクトリはバージョン管理に含める
- CI では `SQLX_OFFLINE=true` でビルドするため、キャッシュがないとビルドできない

詳細: [sqlx-cli 技術ノート](../../../docs/80_ナレッジベース/rust/sqlx-cli.md#オフラインモード詳細)

## 議論の経緯

### CI 失敗の報告

ユーザーから PR #46 の CI が落ちているという報告があった。

### 原因特定と文書化の要請

結局どういう原因だったのかという確認と、セッションログと技術ノートの作成要請があった。原因を調査し、SQLx オフラインキャッシュの追加漏れであることを特定した上で、技術ノートに詳細を記載した。

## 次のステップ

1. 修正をプッシュする
2. CI が通ることを確認する
