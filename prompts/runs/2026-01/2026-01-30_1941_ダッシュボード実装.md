# ダッシュボード実装

## 日時

2026-01-30

## 概要

Issue #38 — ホームページ（`/`）をダッシュボード化し、KPI 統計情報（承認待ちタスク数・申請中ワークフロー数・本日完了数）を表示する機能をフルスタック実装した。

## 背景と目的

- Phase 1 の最後の機能として、ダッシュボード（#38）を実装
- ユーザーがログイン直後に自分の作業状況を一覧できるようにする
- OpenAPI → Core Service → BFF → Frontend の一気通貫パイプラインを構築

## 実施内容

### Phase 1: OpenAPI 仕様書更新

- `GET /api/v1/dashboard/stats` エンドポイントを追加
- `DashboardStatsResponse`、`DashboardStats` スキーマを定義

### Phase 2: Core Service（ユースケース + ハンドラ）

- `DashboardUseCaseImpl` を TDD で実装（5 テスト）
- 既存リポジトリメソッドを活用し、アプリケーション層でフィルタリング
- `now` パラメータによるテスタビリティ確保

### Phase 3: BFF（クライアント + ハンドラ）

- `CoreServiceClient` トレイトに `get_dashboard_stats` を追加
- BFF ハンドラでセッションからユーザー情報を取得し、Core Service に委譲
- 認証テストの `StubCoreServiceClient` にスタブメソッドを追加

### Phase 4: フロントエンド（Elm）

- `Data/Dashboard.elm`、`Api/Dashboard.elm` を新規作成
- `Page/Home.elm` を Stateless → Stateful に変換（Nested TEA）
- `Main.elm` の Page/Msg 型と各関数を更新
- RemoteData パターンで Loading/Failure/Success を管理

### Phase 5: 統合・仕上げ

- elm-review リントエラーを修正（`ApiError(..)` → `ApiError`、未使用パラメータ）
- `just check-all` 通過を確認

## 設計上の判断

### アプリケーション層でのフィルタリング

MVP では新規リポジトリメソッドを追加せず、既存の `find_by_assigned_to` / `find_by_initiated_by` で全件取得し、アプリケーション層でフィルタリングする方針を採用。データ量が増えた場合は SQL の `COUNT` + `WHERE` に移行する。

### `now` パラメータの外部注入

「本日完了」の判定に必要な現在時刻を `get_stats` メソッドの引数として受け取ることで、テストで日時を固定できるようにした。Clock トレイトの導入はこのユースケースでは過剰と判断。

### Home ページの Stateful 化

Nested TEA パターンに従い、Home ページに独自の Model/Msg/update/view を追加。Main.elm で直接 API を呼ぶ方式は、ページ固有のロジックが Main に漏れるため不採用。

## 成果物

### コミット

1. `#38 Add dashboard stats API to OpenAPI spec`
2. `#38 Implement dashboard stats usecase and handler in Core Service`
3. `#38 Implement dashboard stats endpoint in BFF`
4. `#38 Implement dashboard frontend with stateful Home page`
5. `#38 Fix lint errors and add dashboard stats stubs to auth tests`

### 作成ファイル

| ファイル | 種別 |
|---------|------|
| `openapi/openapi.yaml` | 更新 |
| `backend/apps/core-service/src/usecase/dashboard.rs` | 新規 |
| `backend/apps/core-service/src/handler/dashboard.rs` | 新規 |
| `backend/apps/bff/src/handler/dashboard.rs` | 新規 |
| `frontend/src/Data/Dashboard.elm` | 新規 |
| `frontend/src/Api/Dashboard.elm` | 新規 |
| `frontend/src/Page/Home.elm` | 大幅更新 |
| `frontend/src/Main.elm` | 更新 |

## 学んだこと

- トレイトにメソッドを追加すると、全ての impl（テストスタブ含む）を更新する必要がある。テストスタブでは `unimplemented!()` で対応可能
- Elm の `exposing (Type(..))` と `exposing (Type)` の違い: 前者はコンストラクタも公開、後者は型名のみ。必要最小限のインポートが推奨
- Nested TEA でページを Stateful 化する際の定型変更は多い（Page 型、Msg 型、initPage、update、updatePageShared、viewMain の 6 箇所）

## 次のステップ

- KPI カードのデザイン改善（TODO(human) として残存）
- PR レビュー対応
- E2E 動作確認

## 参照

- Issue: https://github.com/ka2kama/ringiflow/issues/38
- PR: https://github.com/ka2kama/ringiflow/pull/166
- 実装解説: [docs/90_実装解説/PR166_ダッシュボード/](../../../docs/90_実装解説/PR166_ダッシュボード/)
