# OpenAPI lint を CI に追加

## 概要

OpenAPI 仕様書（`openapi/openapi.yaml`）の構文検証を CI で自動実行する仕組みを追加した。
Redocly CLI を使用し、OpenAPI 3.1 仕様への準拠と lint ルールのチェックを行う。

## 背景と目的

PR #118 で OpenAPI 仕様書を追加したが、lint は手動実行のみだった。
CI で自動検証することで、仕様書の品質を継続的に担保する。

対応 Issue: #119

## 実施内容

### 1. justfile に lint-openapi タスクを追加

```bash
just lint-openapi
```

Redocly CLI を npx 経由で実行する。

### 2. CI ワークフローの更新

- `openapi/**` の変更を検出するフィルタを追加
- OpenAPI lint ジョブを追加
- ci-success の統合チェックに追加

### 3. OpenAPI 仕様書の修正

lint で検出されたエラーを修正:

- `nullable: true` を OpenAPI 3.1 形式（`type: ['string', 'null']`）に変更
- 認証不要エンドポイントに `security: []` を明示

### 4. Redocly 設定ファイルの追加

`openapi/redocly.yaml` を作成し、プロジェクト固有のルールを設定:

- `no-server-example.com: off` - 開発用 URL を許容
- `operation-4xx-response: warn` - ヘルスチェック API 用
- `no-unused-components: warn` - 将来使用予定のコンポーネント用

### 5. 技術ノートの作成

`docs/06_技術ノート/RedoclyCLI.md` を作成。

## 設計上の判断

| 判断 | 選択 | 理由 |
|------|------|------|
| ツール選定 | Redocly CLI | 設定がシンプル、ドキュメント生成機能も充実 |
| 実行方法 | npx | 他のツール（Rust, Go 製）と異なり npm パッケージなので適材適所 |
| 設定ファイル配置 | `openapi/redocly.yaml` | 仕様書と同じディレクトリで管理 |

## 成果物

### コミット

```
#119 OpenAPI lint を CI に追加
#119 技術ノート: Redocly CLI を追加
```

### 作成・更新ファイル

| ファイル | 変更 |
|----------|------|
| `justfile` | `lint-openapi` タスク追加、`lint` に統合 |
| `.github/workflows/ci.yaml` | `openapi` フィルタ・ジョブ追加 |
| `openapi/openapi.yaml` | OpenAPI 3.1 準拠に修正 |
| `openapi/redocly.yaml` | 新規作成 |
| `docs/06_技術ノート/RedoclyCLI.md` | 新規作成 |

## 議論の経緯

### npx vs グローバルインストール

ユーザーから `npx` の仕組みについて質問があり、他のツールとの一貫性について議論した。

検討の結果:
- 他のツール（actionlint, shellcheck, hurl 等）は Rust/Go/Haskell 製で npm とは無関係
- Redocly CLI は純粋な npm パッケージなので npx が自然な選択
- 「一貫性がない」のではなく「適材適所」と判断

最終的に npx 方式を採用した。

## 学んだこと

### OpenAPI 3.0 と 3.1 の違い

- `nullable: true` は 3.0 の記法。3.1 では `type: ['string', 'null']` を使用
- OpenAPI 3.1 は JSON Schema draft 2020-12 に準拠している

### security の明示

認証不要なエンドポイントでも `security: []` を明示的に書くことで、「意図的に認証不要」であることを示せる。
これがないと `security-defined` ルールでエラーになる。

## 次のステップ

PR #122 のレビュー・マージを待つ。
