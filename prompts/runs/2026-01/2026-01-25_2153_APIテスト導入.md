# セッションログ: API テスト導入

- 日時: 2026-01-25
- Issue: [#98 E2E API テストを hurl で追加する](https://github.com/ka2kama/ringiflow/issues/98)
- PR: [#105](https://github.com/ka2kama/ringiflow/pull/105)

## 概要

BFF の API テストを hurl で実装した。
Auth Service 分離により認証フローが複数サービスにまたがるようになり、サービス間通信を含めたテストが必要になった。

## 実装フェーズ

### Phase 1: 前提条件の整備

- justfile の `check-tools` に hurl 確認を追加
- 開発環境構築ドキュメントに hurl インストール手順を追加（mise / cargo）

### Phase 2: テスト基盤の構築

- `tests/api/hurl/` ディレクトリ構成
- `vars.env`（共通変数）
- justfile への API テストコマンド追加

### Phase 3: テストケースの実装

- health.hurl
- auth/login.hurl（正常系・異常系）
- auth/logout.hurl
- auth/me.hurl, auth/me_unauthorized.hurl
- auth/csrf.hurl, auth/csrf_unauthorized.hurl

### Phase 4: ドキュメント整備

- tests/api/README.md

## 途中で発生した問題と対応

### 1. logout が 403 を返す

**原因**: CSRF ミドルウェアが `X-CSRF-Token` ヘッダーを要求していた。

**対応**: logout 前に CSRF トークンを取得し、ヘッダーに含めるようテストを修正。

### 2. 未認証テストが 200 を返す

**原因**: hurl は同一ファイル内で Cookie を自動管理するため、直前のログインで取得した Cookie が送信されていた。

**対応**: 認証状態が異なるテストを別ファイルに分離（`me.hurl` / `me_unauthorized.hurl`）。

### 3. E2E という名称の問題

**問題**: 「E2E テスト」は一般的にブラウザ自動操作によるユーザー視点のテストを指す。今回実装したのは API レベルのテスト。

**対応**: `tests/e2e/` → `tests/api/` にリネーム。関連するコマンドや設定もすべて変更。

### 4. 開発環境とテスト環境の競合

**問題**: 開発中の DB/Redis と API テストが同じデータを使うと、互いに影響する。また、アプリケーションサービスのポートが競合すると並行実行できない。

**対応**: 完全分離を実施。

| コンポーネント | 開発 | API テスト |
|---------------|------|-----------|
| PostgreSQL | 15432 | 15433 |
| Redis | 16379 | 16380 |
| BFF | 13000 | 14000 |
| Core Service | 13001 | 14001 |
| Auth Service | 13002 | 14002 |

## 作成・変更したファイル

### 新規作成

- `tests/api/hurl/*.hurl` - テストファイル群
- `tests/api/hurl/vars.env` - 共通変数
- `tests/api/README.md` - テスト実行手順
- `tests/api/scripts/wait-for-healthy.sh` - ヘルスチェックスクリプト
- `backend/.env.api-test` - API テスト用環境変数
- `infra/docker/docker-compose.api-test.yml` - API テスト用 DB/Redis

### 変更

- `justfile` - API テストコマンド追加、check-tools に hurl 追加
- `docs/60_手順書/01_開発参画/01_開発環境構築.md` - hurl インストール手順追加
- `.github/workflows/ci.yml` - api-test ジョブを追加

## CI 統合

GitHub Actions に `api-test` ジョブを追加。

- トリガー: `backend/**` または `tests/api/**` の変更時
- 他のテスト（rust, rust-integration, elm, shell）と並列実行
- ci-success ジョブで全体の成否を統合

## 学んだこと

1. **ツールの暗黙の動作を理解する**: hurl の Cookie 自動管理は便利だが、テスト設計と矛盾することがある
2. **用語の正確さ**: E2E / API テスト / Integration テストの違いを意識する
3. **環境分離は最初から**: 後から分離するより、最初から分離設計する方が楽
4. **Given-When-Then**: テストの意図を明確にするコメントは後々役立つ
5. **テストピラミッド**: Unit / Integration / API テストの棲み分けを意識する

## 関連ドキュメント

- [実装解説: API テスト機能解説](../../../docs/90_実装解説/PR105_APIテスト/01_APIテスト_機能解説.md)
- [技術ノート: hurl](../../../docs/80_ナレッジベース/devtools/hurl.md)
