# Auto Review ワークフローのステータス報告追加

## 概要

`workflow_run` イベントでトリガーされる Auto Review ワークフローに、GitHub Status API を使ったステータス報告機能を追加した。

## 背景と目的

`workflow_run` イベントはデフォルトブランチのコンテキストで実行されるため、PR のコミットにステータスが自動で紐付かない。このため、Ruleset で「Auto Review」を必須チェックに設定しても「Waiting for status to be reported」のままになっていた。

## 実施内容

### 1. GitHub Status API によるステータス報告

PR のコミット SHA に対して明示的にステータスを報告:

| タイミング | 状態 | 説明 |
|-----------|------|------|
| ジョブ開始時 | pending | "Running auto review..." |
| Draft PR の場合 | success | "Skipped (draft PR)" |
| レビュー成功時 | success | "Review completed" |
| レビュー失敗時 | failure | "Review failed" |

### 2. 実装の最適化

stash から適用した実装を改善:

- ジョブレベルで環境変数（`STATUS_URL`, `RUN_URL`）を定義し、重複を削減
- 中間ステップ（`set-sha`）を削除し、GitHub 式を直接使用
- `success()` / `failure()` の代わりに `steps.review.outcome` を使用して明示的に
- failure ステップに `always()` を追加して確実に評価されるように

## 成果物

### 更新したファイル

| ファイル | 変更内容 |
|---------|---------|
| `.github/workflows/claude-auto-review.yml` | Status API によるステータス報告を追加 |
| `docs/05_ADR/011_Claude_Code_Action導入.md` | workflow_run でのステータス報告について追記 |

### 関連 Issue

- [#70 Auto Review ワークフローが PR のステータスチェックに反映されない](https://github.com/ka2kama/ringiflow/issues/70)

## 設計判断と実装解説

### `steps.<id>.outcome` vs `success()` / `failure()`

`success()` / `failure()` はジョブ全体の状態を見るため、どのステップが原因で成功/失敗したか不明瞭になる場合がある。`steps.review.outcome` を使うことで、Claude Code Review ステップの結果を明示的にチェックできる。

### `always()` の必要性

GitHub Actions のデフォルト動作では、前のステップが失敗するとそれ以降のステップはスキップされる。failure ステータスを報告するステップを確実に評価させるため、`always()` を条件に追加した。

## 学んだこと

- `workflow_run` イベントでは PR のステータスチェックに自動で紐付かない
- GitHub Status API を使って `repos/{owner}/{repo}/statuses/{sha}` に POST することで手動でステータスを設定できる
- ジョブレベルの `env` でよく使う式を変数化すると重複を減らせる
