# Rust コーディングスタイル標準化

## 概要

Rust の関数内コーディングスタイルを 3 層アプローチで標準化した。clippy lint による自動強制、`rust.md` への判断基準追加、既存パターン踏襲の 3 層で、同一ロジックの書き方に関するプロジェクト合意を確立した。

## 実施内容

### Phase 1: workspace.lints インフラ整備

- `backend/Cargo.toml` に `[workspace.lints.clippy]` セクションを追加（`all = { level = "deny", priority = -1 }`）
- 6 member crate に `[lints] workspace = true` を追加
- `justfile` と `.github/workflows/ci.yaml` から `-- -D warnings` CLI フラグを削除
- ADR-057 を作成（workspace.lints による lint 管理の標準化）

### Phase 2: Pedantic lint 有効化

以下の 5 lint を deny レベルで追加:

| lint | 効果 |
|------|------|
| `manual_let_else` | `if let` + early return → `let-else` |
| `cloned_instead_of_copied` | Copy 型で `.cloned()` → `.copied()` |
| `semicolon_if_nothing_returned` | unit 返却関数の末尾セミコロン |
| `redundant_else` | early return 後の不要な `else` |
| `implicit_clone` | 暗黙の clone を明示化 |

既存違反は 1 箇所のみ（`get_user_by_email` の `manual_let_else`）。`let-else` パターンに修正。

見送った lint: `needless_pass_by_value`（axum handler で偽陽性）、`module_name_repetitions`（命名は人間判断）、`must_use_candidate`（大量の `#[must_use]` が必要）、`missing_const_for_fn`（nursery lint）。

### Phase 3: rust.md スタイルガイド追加

`.claude/rules/rust.md` に「関数内スタイル」セクションを追加:

- 制御フロー（早期リターン、`let-else`、`match` vs `if let`）
- イテレータ vs for ループ（変換 → イテレータ、副作用 → for）
- 変数束縛（中間 let、デストラクチャリング）
- クロージャ（メソッド参照 vs クロージャ vs ヘルパー関数）
- impl ブロック構成順序

### Phase 4: 最終検証

`just check-all` 全パス（ユニット 520+、API 215 リクエスト、E2E 21）。

## 判断ログ

- `priority = -1` を採用: 個別 lint の override（デフォルト priority 0）が容易になるため
- `clippy::all` を deny、pedantic は個別に deny: `all` は pedantic を含まないため、個別指定が必要
- `needless_pass_by_value` を見送り: axum の extractor（`Json<T>`, `State<T>` 等）で偽陽性が多数発生するため
- `missing_const_for_fn` を見送り: nursery lint であり Rust 1.86 で既知の問題がある

## 成果物

### コミット

- `6d2c2ecb` #923 Standardize Rust coding style with workspace lints and style guide

### 作成・更新ファイル

- `docs/05_ADR/057_workspace-lintsによるlint管理の標準化.md`（新規）
- `backend/Cargo.toml`（`[workspace.lints.clippy]` 追加）
- `backend/apps/{bff,core-service,auth-service}/Cargo.toml`（`[lints]` 追加）
- `backend/crates/{domain,infra,shared}/Cargo.toml`（`[lints]` 追加）
- `backend/apps/core-service/src/handler/auth/mod.rs`（`let-else` 修正）
- `.claude/rules/rust.md`（関数内スタイルセクション追加）
- `justfile`（`-D warnings` 削除）
- `.github/workflows/ci.yaml`（`-D warnings` 削除）

### PR

- #924 (Draft)
