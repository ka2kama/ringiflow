# Elm フロントエンドのクローン削減・ファイルサイズ削減

Issue: #533
PR: #574
ブランチ: `feature/533-elm`

## 概要

Elm フロントエンドの jscpd コードクローンを 16 件から 9 件に削減（重複率 5.25% → 3.62%）し、Main.elm のファイルサイズを 1140 行から 1013 行に削減した。

4 Phase で段階的にリファクタリングを実施:

1. 共有フォームフィールドコンポーネント（Component.FormField）
2. Dirty フラグ管理の共有化（Form.DirtyState）
3. バリデーション共通化と statusToBadge 移動
4. Main.elm アイコンモジュール抽出（Component.Icons）

## 実施内容

### Phase 1: Component.FormField

User Edit/New、Role Edit/New の 4 ページに散在していたフォームフィールドの view 関数を `Component.FormField` に集約した。

- `viewTextField`: テキスト入力（ラベル + エラー表示）
- `viewTextArea`: テキストエリア
- `viewSelectField`: セレクトボックス（options を `List { value, label }` に統一）
- `viewReadOnlyField`: 読み取り専用フィールド
- `inputClass`: エラー有無による CSS クラス切り替え（テスト用に公開）

テスト: `inputClass` の純粋関数テスト（7 件）。elm-html-test 未導入のため、Button.variantClass と同じパターンで CSS クラス計算関数を公開してテストした。

### Phase 2: Form.DirtyState

4 ページで重複していた markDirty / clearDirty / isDirty を `Form.DirtyState` に集約した。

- Elm の extensible record（`{ a | isDirty_ : Bool }`）を活用し、呼び出し側の変更を最小限に抑えた
- 成功時の `isDirty_ = False` + `Ports.setBeforeUnloadEnabled False` パターンも `clearDirty` に統一

テスト: モデル状態変更のテスト（8 件）。Elm では Cmd 値を比較できないため、モデルのフィールド変更のみを検証した。

### Phase 3: バリデーション共通化 + statusToBadge 移動

- `Form.Validation.validateRequiredString`: パラメータ化した汎用バリデータを追加。fieldLabel でエラーメッセージを動的に生成（「名前」「ロール名」等）
- `Data.AdminUser.statusToBadge`: User Detail/List で重複していたステータスバッジ変換を Data 層に移動

テスト: validateRequiredString（7 件）、statusToBadge（3 件）

### Phase 4: Component.Icons

Main.elm の ICONS セクション（7 アイコン、約 122 行）を `Component.Icons` に抽出。Svg / Svg.Attributes のインポートも Main.elm から除去した。

テスト: 純粋な移動のためテストなし。

## 判断ログ

- DJ-1: フォームフィールドは `Component.FormField` に集約（個別モジュール分割は過度な分割と判断）
- DJ-2: Dirty フラグ管理は extensible record パターンを採用（呼び出し側の変更が最小限）
- DJ-3: バリデーションは既存 `Form.Validation` に追加（新モジュールを作るほどの量ではない）
- DJ-4: `statusToBadge` は `Data.AdminUser` に配置（ドメイン知識に基づく変換ロジックのため）
- Refactor: 残り 9 件のクローンはエンティティ固有部分が多く、抽象化の効果が限定的と判断して対象外とした

## 成果物

### コミット

- `b2bd42e` #533 Reduce Elm frontend code clones and file size

### 作成ファイル

| ファイル | 内容 |
|---------|------|
| `frontend/src/Component/FormField.elm` | 共有フォームフィールドコンポーネント |
| `frontend/src/Form/DirtyState.elm` | Dirty フラグ管理（extensible record） |
| `frontend/src/Component/Icons.elm` | SVG アイコン（Main.elm から抽出） |
| `frontend/tests/Component/FormFieldTest.elm` | FormField テスト（7 件） |
| `frontend/tests/Form/DirtyStateTest.elm` | DirtyState テスト（8 件） |

### 変更ファイル

| ファイル | 変更内容 |
|---------|---------|
| `Page/User/Edit.elm` | FormField, DirtyState, Validation 統合 |
| `Page/User/New.elm` | 同上 |
| `Page/Role/Edit.elm` | 同上 |
| `Page/Role/New.elm` | 同上 |
| `Page/User/Detail.elm` | statusToBadge を Data.AdminUser に移動 |
| `Page/User/List.elm` | 同上 |
| `Form/Validation.elm` | validateRequiredString 追加 |
| `Data/AdminUser.elm` | statusToBadge, BadgeConfig 追加 |
| `Main.elm` | Icons モジュール抽出（-127 行） |

### 指標

| 指標 | Before | After | 変化 |
|------|--------|-------|------|
| Elm クローン数 | 16 | 9 | -7 (44%減) |
| Elm 重複率 | 5.25% | 3.62% | -1.63pt |
| Main.elm 行数 | 1140 | 1013 | -127 行 |
| テスト数 | 303 | 321 | +18 |
