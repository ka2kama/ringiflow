# テナント情報取得機能の実装

## 概要

Issue #306 に基づき、ハードコードされていたテナント情報を Core API から動的に取得する機能を全レイヤー（ドメイン → インフラ → Core Service → BFF → フロントエンド）で実装した。

## 背景と目的

#34（ユーザー認証）実装時に、テナント情報の取得が TODO として残されていた:

- BFF: `tenant_name` が `"Development Tenant"` にハードコード
- フロントエンド: `extractTenantId` が固定 UUID を返す

マルチテナント SaaS として正しいデータフローを構築するため、実データに置き換える。

## 実施内容

5 Phase に分けて TDD で実装。

| Phase | 内容 | 主な変更 |
|-------|------|---------|
| 1 | ドメイン層 | `TenantName` 値オブジェクト、`Tenant` エンティティ追加 |
| 2 | インフラ層 | `TenantRepository` トレイト + PostgreSQL 実装 |
| 3 | Core Service | `get_user` レスポンスに `tenant_name` 追加、`UserState` に `TenantRepository` 追加 |
| 4 | BFF | ハードコード除去、`MeResponseData::from()` を動的値に変更 |
| 5 | フロントエンド | `User` 型に `tenantId` 追加、decoder 更新、`extractTenantId` 削除 |

## 設計上の判断

### 既存エンドポイントの拡張 vs 新規エンドポイント

設計書（`07_認証機能設計.md`）が `/internal/users/{user_id}` レスポンスにテナント情報を含める構造を規定しており、既存レスポンスの拡張を選択した。BFF から 1 API コールで完結するメリットもある。

### TenantRepository の分離

テナント名取得を `UserRepository` の SQL JOIN ではなく、別の `TenantRepository` で実装。責務の分離を優先した。テナント名は認証フローでのみ必要なので、ユーザー一覧取得等には影響しない。

### フロントエンドで tenantId のみ追加

`tenantName` は BFF の `MeResponseData` に含まれるが、フロントエンドでは表示に使用しないため YAGNI として見送り。`tenantId` のみ追加し、`Shared.tenantId` の更新に使用する。

### init の初期 tenantId を維持

`Shared.init` の `tenantId = "00000000-..."` はログイン前の API コール（`X-Tenant-ID` ヘッダー）に必要なため維持。ログイン後に `withUser` で正しい値に更新される。

## 成果物

### コミット

```
1ccb3e6 #306 WIP: Implement tenant info retrieval
03b3197 #306 Add TenantName value object and Tenant entity
49a5be3 #306 Add TenantRepository with find_by_id
252dfa1 #306 Add tenant_name to get_user response
6ff1747 #306 Remove hardcoded tenant_name in BFF auth handler
33d4343 #306 Add tenantId to User type and update decoder
```

### 変更ファイル（14 ファイル、+485/-67）

- `backend/crates/domain/src/tenant.rs` — TenantName, Tenant 追加
- `backend/crates/infra/src/repository/tenant_repository.rs` — 新規
- `backend/crates/infra/src/repository.rs` — pub mod 追加
- `backend/crates/infra/tests/tenant_repository_test.rs` — 新規
- `backend/apps/core-service/src/handler/auth.rs` — UserState 拡張、レスポンス拡張
- `backend/apps/core-service/src/main.rs` — TenantRepository DI
- `backend/apps/bff/src/client/core_service.rs` — tenant_name フィールド追加
- `backend/apps/bff/src/handler/auth.rs` — ハードコード除去
- `backend/apps/bff/tests/auth_integration_test.rs` — スタブ更新
- `frontend/src/Shared.elm` — User 型拡張、withUser 修正
- `frontend/src/Api/Auth.elm` — decoder 更新
- `frontend/review/src/ReviewConfig.elm` — 古い抑制削除

## 議論の経緯

特筆すべき議論なし。計画どおりに実装を進めた。

## 学んだこと

- axum の共有 State にジェネリクスを追加すると、その State を使う全ハンドラのシグネチャに型パラメータが波及する。`get_user` だけが `TenantRepository` を必要としても、`list_users` や `get_user_by_email` にも `T: TenantRepository` が現れる
- Elm の `type alias` は定義順にコンストラクタ引数が決まるため、`Decode.mapN` のフィールド順はコンストラクタの引数順と一致させる必要がある

## 次のステップ

- PR #310 のレビュー・マージ
- 将来的に `/api/v1/tenant` 公開 API が必要になった場合は、専用エンドポイントとして追加する
