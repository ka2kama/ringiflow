# main.rs の DI 定義をモジュール分離する

Issue: #962
PR: #970
日付: 2026-02-27

## 概要

core-service と bff の `main.rs` から DI（リポジトリ・UseCase・State）初期化とルーター構築を `app_builder.rs` モジュールに分離した。両ファイルとも 500 行超から 130-170 行に削減。

## 設計判断

### モジュール名: `app_builder`

`config` と同じパターンで `main.rs` のプライベートモジュールとして追加。`lib.rs` には公開しない（バイナリクレート内部の構築ロジック）。

### 分離境界: async インフラ初期化 vs sync アプリケーション組み立て

- `main.rs`: 環境変数、トレーシング、設定読み込み、DB プール、Redis、S3、DynamoDB 等の非同期インフラ初期化
- `app_builder.rs`: リポジトリ・UseCase・State の DI 組み立てとルーター構築（同期処理）

### bff の DynamoDB 依存問題

当初 `aws_sdk_dynamodb::Client` を `app_builder.rs` で受け取る設計だったが、`aws_sdk_dynamodb` は `ringiflow_infra` の推移的依存であり bff バイナリクレートからは直接参照できない。

対策: `main.rs` で `DynamoDbAuditLogRepository` を生成し、`Arc<dyn AuditLogRepository>` として `build_app()` に渡す。

## 変更ファイル

| ファイル | 変更内容 |
|---------|---------|
| `backend/apps/core-service/src/app_builder.rs` | 新規。DI + ルーター構築（398行） |
| `backend/apps/core-service/src/main.rs` | 506 → 127 行に削減 |
| `backend/apps/bff/src/app_builder.rs` | 新規。クライアント初期化 + State + ルーター構築（382行） |
| `backend/apps/bff/src/main.rs` | 519 → 171 行に削減 |
| `.config/baselines.env` | `FILE_SIZE_MAX_COUNT` 36 → 34 |

## ベースライン改善

500 行超ファイル数: 36 → 34（2 ファイル削減）
- `core-service/src/main.rs`: 506 → 127 行
- `bff/src/main.rs`: 519 → 171 行
- auth-service は 161 行で対象外
