# ビジネスイベントログとエラーコンテキスト実装

## 概要

Issue #657 の実装。AI エージェントが本番障害を `jq` で効率的に調査できるよう、ビジネスイベントの構造化ログとエラーコンテキストの拡充を行った。`log_business_event!` マクロの導入、ワークフロー操作（6 ユースケース）と認証操作のイベントログ追加、中央エラーハンドリングのコンテキスト強化を実施。

## 実施内容

### Phase 1: ヘルパーマクロ + ログスキーマ文書

- `shared` クレートに `event_log.rs` を新規作成
  - `log_business_event!` マクロ: `tracing::info!` のラッパーで `event.kind = "business_event"` マーカーを自動付与
  - `event` モジュール: カテゴリ、アクション、エンティティ種別、結果の定数
- `docs/80_ナレッジベース/backend/log-schema.md` にフィールドスキーマと `jq` クエリ例を記載

### Phase 2: ワークフロービジネスイベントログ

6 ユースケースの成功パスに `log_business_event!` を追加:

| ユースケース | action | entity_type |
|-------------|--------|-------------|
| create | `workflow.created` | `workflow_instance` |
| submit | `workflow.submitted` | `workflow_instance` |
| approve | `step.approved` | `workflow_step` |
| reject | `step.rejected` | `workflow_step` |
| request_changes | `step.changes_requested` | `workflow_step` |
| resubmit | `workflow.resubmitted` | `workflow_instance` |

### Phase 3: 認証ビジネスイベントログ

BFF の `login.rs` に 4 箇所のビジネスイベントログを追加:

| 箇所 | action | 補足 |
|------|--------|------|
| ログイン成功 | `auth.login_success` | entity_type: session |
| パスワード不一致 | `auth.login_failure` | reason: password_mismatch |
| ユーザー不存在 | `auth.login_failure` | entity_id: REDACTED（PII マスキング） |
| ログアウト | `auth.logout` | entity_type: session |

### Phase 4: エラーコンテキスト強化

既存の `tracing::error!` に `error.category` + `error.kind` フィールドを追加:

- `core-service/error.rs`: Database, Internal（2 箇所）
- `auth-service/error.rs`: Database, Internal（2 箇所）
- `bff/error.rs`: get_session, log_and_convert_core_error（2 箇所）
- `bff/handler/auth/login.rs`: 5 箇所（user_lookup, csrf_token, session, password_verification）

### Phase 5: 統合検証

`just check-all` で全テスト通過を確認。

## 判断ログ

- ログ層選択: ハンドラ層 / ユースケース層 / ドメイン層の 3 案を比較し、ユースケース層を選択。`*_by_display_number` バリアントが UUID バリアントに委譲するため、UUID バリアントにログを配置すれば両パスをカバーできる
- フィールド命名: tracing のフィールド名にドット記法（`event.category`）を採用。JSON 出力では `jq 'select(.["event.category"] == "workflow")'` で参照
- `error.kind` 命名: `error.type` は Rust の `type` 予約語と衝突するため `error.kind` を採用。`std::io::ErrorKind` と命名が一貫
- error.rs での文字列リテラル使用: `error.rs` ファイルで `event_log::error` モジュールをインポートするとモジュール名 `error` が衝突するため、定数ではなく文字列リテラルを使用
- 認証イベントのログ層: 認証は BFF の責務のため BFF ハンドラでログ出力。Core Service は認証を知らない
- PII マスキング: ユーザー不存在時のログで `event.entity_id` に `REDACTED` 定数を使用し、入力されたメールアドレスの漏洩を防止

## 成果物

コミット:
- `0cc429e` #657 WIP: Add business event logging and error context
- `ff01988` #657 Add business event logging macro and log schema documentation
- `718177c` #657 Add business event logging to all workflow use cases
- `c6c149f` #657 Add authentication business event logging to BFF login/logout
- `9dc7764` #657 Add structured error context fields to central error handlers
- `02543ee` #657 Update plan file with Phase 3-4 verification results

新規ファイル:
- `backend/crates/shared/src/event_log.rs`
- `docs/80_ナレッジベース/backend/log-schema.md`

変更ファイル:
- `backend/crates/shared/src/lib.rs`
- `backend/apps/core-service/src/usecase/workflow/command/` 配下 6 ファイル
- `backend/apps/bff/src/handler/auth/login.rs`
- `backend/apps/core-service/src/error.rs`
- `backend/apps/auth-service/src/error.rs`
- `backend/apps/bff/src/error.rs`

計画ファイル: `prompts/plans/657_business-event-log.md`
PR: #675
