# #901 check-all の警告ノイズを削減する（ラチェット化）

## 概要

`just check-all` の全 warning 系チェックにラチェット方式のベースラインを導入し、警告の悪化を構造的に防止した。`.config/baselines.env` に全ベースラインを集約し、各スクリプトから source して閾値超過時に exit 1 で CI を失敗させる。

## 実施内容

### Phase 1: ベースラインインフラ + jscpd 閾値

- `.config/baselines.env` を新規作成（全ベースライン値を集約する shell-sourceable ファイル）
- `scripts/check/check-duplicates.sh` を新規作成（justfile インラインから移動）
  - `--exitCode 0` を削除し、`--threshold` で重複率上限を baselines.env から指定
- justfile の `check-duplicates` レシピを新スクリプト呼び出しに変更

ベースライン値は実測で確定:
- Rust 重複率 10.77% → 閾値 11%
- Elm 重複率 2.32% → 閾値 3%

### Phase 2: file-size.sh ベースライン

- `scripts/check/file-size.sh` に baselines.env の読み込みと件数ベースライン比較を追加
- 超過時 exit 1、改善時にベースライン更新を促すメッセージ
- 実測: 500 行超ファイル 28 件 → `FILE_SIZE_MAX_COUNT=28`

### Phase 3: improvement-records.rs ベースライン

- `BaselineResult` enum と `check_baseline()` 純粋関数を追加（TDD で 5 テスト）
- `--max-missing-nature` CLI 引数の解析を追加
- justfile `lint-improvements` レシピを shebang 化し、baselines.env から引数を渡す構造に変更
- 実測: 「問題の性質」未記載 70 件 → `IMPROVEMENT_RECORDS_MAX_MISSING_NATURE=70`

### Phase 4: cargo deny skip + ELIFECYCLE 143 抑制

- `backend/deny.toml`: `multiple-versions` を `"warn"` → `"deny"` に変更
  - 既知 duplicate を `skip` リスト（14 エントリ）で明示許容
  - Windows プラットフォームクレートを `skip-tree`（4 エントリ）で一括許容
- `scripts/test/run-e2e.sh`: trap を `cleanup()` 関数に改善（kill + wait + stderr 抑制）

### Phase 5: 統合検証

- `just check` が全パス（リント + テスト + ベースラインチェック全て通過）
- pre-push hook も全パス

### shellcheck SC1091 修正

baselines.env を source するスクリプトで shellcheck が SC1091（source 先ファイルを辿れない）を報告した。既存プロジェクトパターン（`run-e2e.sh`、`run-api.sh` 等）に倣い `# shellcheck disable=SC1091` を使用。

## 判断ログ

- ベースライン管理方式: `.config/baselines.env`（shell-sourceable）を選択。TOML（パーサー不要）、justfile 変数（散在防止）、各スクリプト内（一覧性）を比較した結果
- cargo deny 方式: `deny` + `skip` を選択。`warn` + `skip` では新 duplicate でも exit 0 になりラチェットにならない
- improvement-records.rs のベースライン受け渡し: CLI 引数方式を選択。rust-script に TOML パーサーを追加するとコンパイル負荷が増える
- jscpd `--threshold` の比較対象: 実験で line duplication % と比較することを確認（threshold=10 で 10.77% → exit 1、threshold=11 → exit 0）

## 成果物

### コミット

- `#901 Introduce ratchet baselines for check-all warning checks`

### 作成・更新ファイル

| ファイル | 変更種別 |
|---------|---------|
| `.config/baselines.env` | 新規作成 |
| `scripts/check/check-duplicates.sh` | 新規作成 |
| `justfile` | 修正（check-duplicates, lint-improvements） |
| `scripts/check/file-size.sh` | 修正 |
| `scripts/check/improvement-records.rs` | 修正 |
| `backend/deny.toml` | 修正 |
| `scripts/test/run-e2e.sh` | 修正 |
| `prompts/plans/901_reduce-check-all-warning-noise.md` | 新規作成（計画ファイル） |
