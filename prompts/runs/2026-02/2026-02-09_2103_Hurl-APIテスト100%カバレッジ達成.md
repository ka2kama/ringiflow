# Hurl API テスト 100% カバレッジ達成

## 概要

Issue #321 に基づき、API テスト突合表で特定された 9 件のギャップを解消した。9 つの Hurl テストファイルを新規作成し、API テストカバレッジを 50%（9/18）から 100%（18/18、20 テストファイル）に引き上げた。

## 背景と目的

API テスト突合表（#291 で作成）により、18 エンドポイント中 9 件が未カバーであることが判明していた。未カバーのエンドポイントは参照系 GET（定義一覧、ユーザー一覧等）から状態変更系 POST（承認、却下）まで幅広く存在していた。

## 実施内容

### Phase 1: 参照系 GET エンドポイント（4 ファイル）

- `health_ready.hurl` — レディネスチェック（認証不要）
- `workflow_definition/list_workflow_definitions.hurl` — ワークフロー定義一覧
- `workflow_definition/get_workflow_definition.hurl` — ワークフロー定義詳細 + 404
- `user/list_users.hurl` — ユーザー一覧

### Phase 2: ワークフロー参照 + ダッシュボード（3 ファイル）

- `workflow/list_my_workflows.hurl` — 自分の申請一覧（テスト内でワークフロー作成）
- `workflow/get_workflow.hurl` — ワークフロー詳細 + 404（Capture → == パターン）
- `dashboard/stats.hurl` — ダッシュボード統計（`>= 0` でテスト順序依存回避）

### Phase 3: 承認・却下（2 ファイル）

- `workflow/approve_step.hurl` — 最も複雑。multi-user + CSRF + 4 エラーケース + 正常系
- `workflow/reject_step.hurl` — 正常系 + 2 エラーケース

### Phase 4: 仕上げ

- `vars.env` に `user_name=一般ユーザー` を追加
- API テスト突合表を 100% に更新
- Issue #321 のチェックボックスを全件チェック済みに更新

## 設計上の判断

### テストデータ戦略

| 種類 | 戦略 | 理由 |
|------|------|------|
| 参照系 GET（定義一覧、ユーザー一覧） | シードデータ参照 | 状態を変更しないため安全 |
| ワークフロー GET（一覧、詳細） | テスト内で作成 | 他テストのデータに依存しない |
| 状態変更（approve/reject） | テスト内で作成→申請→承認/却下 | 完全な E2E フローが必要 |
| ダッシュボード統計 | シードデータ参照、`>= 0` で検証 | テスト実行順序への脆弱性を回避 |

### approve と reject のエラーケース配分

approve_step.hurl に 4 つのエラーケース（CSRF 403、権限 403、Not Found 404、バージョン不一致 409）を集約し、reject_step.hurl は 2 つ（CSRF 403、Not Found 404）に絞った。権限エラーと楽観的ロックは approve で十分検証済みという判断。

### Phase 順序

Issue の優先度（高→低）ではなく、複雑度順（単純→複雑）で実装した。単純な GET テストでパターンを確立し、複雑な approve/reject に適用する戦略。

## 判断ログ

| 種別 | 判断 | 背景 |
|------|------|------|
| 軌道修正 | approve_step.hurl のエラー type を `not-assigned` → `forbidden` に修正 | テスト実行で実際の API が `forbidden` を返すことが判明 |
| 軌道修正 | reject_step.hurl のエラー type を `workflow-instance-not-found` → `step-not-found` に修正 | 存在しないワークフローへの reject が `step-not-found` として扱われることが判明 |

## 成果物

### コミット

| コミット | 内容 |
|---------|------|
| `#321 WIP: Add Hurl API tests for uncovered endpoints` | Draft PR 用空コミット |
| `#321 Add Hurl API tests for reference GET endpoints` | Phase 1: 4 ファイル |
| `#321 Add Hurl API tests for workflow queries and dashboard` | Phase 2: 3 ファイル |
| `#321 Add Hurl API tests for approve and reject endpoints` | Phase 3: 2 ファイル |
| `#321 Update vars.env and API test mapping table` | Phase 4: vars.env + 突合表 |
| `#321 Fix error type assertions in approve and reject tests` | テスト実行後の修正 |

### 作成ファイル

- `tests/api/hurl/health_ready.hurl`（新規）
- `tests/api/hurl/workflow_definition/list_workflow_definitions.hurl`（新規）
- `tests/api/hurl/workflow_definition/get_workflow_definition.hurl`（新規）
- `tests/api/hurl/user/list_users.hurl`（新規）
- `tests/api/hurl/workflow/list_my_workflows.hurl`（新規）
- `tests/api/hurl/workflow/get_workflow.hurl`（新規）
- `tests/api/hurl/dashboard/stats.hurl`（新規）
- `tests/api/hurl/workflow/approve_step.hurl`（新規）
- `tests/api/hurl/workflow/reject_step.hurl`（新規）

### 更新ファイル

- `tests/api/hurl/vars.env` — `user_name=一般ユーザー` 追加
- `docs/50_テスト/APIテスト突合表.md` — 全 18 エンドポイントをカバー済みに更新

### PR

- https://github.com/ka2kama/ringiflow/pull/340（Draft）

## 議論の経緯

### 計画の承認

計画ファイルで 4 Phase の実装計画を提示し、ユーザーが承認。特に議論なくスムーズに進行した。

## 学んだこと

- エラー型の推測は実際の API 実装と異なることがある。approve の「権限なし」エラーが `not-assigned` ではなく汎用的な `forbidden` だった点、reject の「存在しないワークフロー」が `step-not-found` として扱われる点は、API テストで初めて判明した
- テストデータ戦略（シードデータ参照 vs テスト内作成）を endpoint の性質で使い分けることで、テスト間の独立性とテスト順序への非依存性を両立できた

## 次のステップ

- CI での `just check-all` 通過を確認（ローカルでは `elm-review` 未インストールのため frontend lint がスキップされている）
- PR を Ready for Review にする
