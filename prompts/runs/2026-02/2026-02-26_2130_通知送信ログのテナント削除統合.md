# 通知送信ログのテナント削除統合

Issue: #878
Branch: `feature/878-notification-log-deletion`
PR: #937

## 概要

`notification_logs` テーブルをテナント退会時データ削除レジストリに統合した。テーブル自体（マイグレーション、RLS、NotificationLogRepository、NotificationService）は #875 で実装済みであり、本作業は削除レジストリへの登録と設計ドキュメントの更新のみ。

## 実施内容

### Issue 精査

As-Is 検証で、スコープ 5 項目中 4 項目が #875（PR #916、2026-02-26 マージ）で実装済みと判明。残作業はテナント退会削除設計への統合のみに修正して続行。

### テナント削除レジストリへの統合

- `define_simple_postgres_deleter!` マクロで `PostgresNotificationLogDeleter` を定義
- `DeletionRegistry::with_all_deleters()` に登録（`PostgresWorkflowDeleter` より先、FK 順序）
- `expected_deleter_names()` に `"postgres:notification_logs"` を追加
- テナント退会時データ削除設計ドキュメントの削除対象一覧、コード例、`DataCounts` を更新

## 判断ログ

- FK 削除順序: `notification_logs.workflow_instance_id → workflow_instances(id) ON DELETE CASCADE` のため、レジストリでは `PostgresWorkflowDeleter` より先に `PostgresNotificationLogDeleter` を登録した。CASCADE で自動削除されるが、正確な件数のため明示的に削除する方針（`PostgresWorkflowDeleter` の workflow_comments/steps と同じアプローチ）

## 成果物

### 更新ファイル

| ファイル | 変更内容 |
|---------|---------|
| `backend/crates/infra/src/deletion/postgres_simple.rs` | `PostgresNotificationLogDeleter` マクロ定義追加 |
| `backend/crates/infra/src/deletion/mod.rs` | エクスポート追加 |
| `backend/crates/infra/src/deletion/registry.rs` | インポート、登録、期待リスト追加 |
| `docs/03_詳細設計書/06_テナント退会時データ削除設計.md` | 削除対象一覧、レジストリ例、DataCounts、変更履歴更新 |

### プロセス改善

| ファイル | 内容 |
|---------|------|
| `process/improvements/2026-02/2026-02-26_2130_start完了後に毎回停止して作業を継続しない.md` | /start Step 6 後の停止パターンの分析と対策 |
