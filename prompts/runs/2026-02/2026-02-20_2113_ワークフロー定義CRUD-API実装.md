# ワークフロー定義 CRUD API 実装

## 概要

Issue #723 のワークフロー定義 CRUD API をフルスタック（Domain → UseCase → Core Service → BFF）で実装した。7 Phase の TDD 開発フロー + 品質ゲート通過 + Draft PR 作成まで完了。

## 実施内容

### Phase 1: ドメインモデル CRUD ロジック

- `WorkflowDefinition` にステータス遷移（`publish`、`archive`）、更新（`update`）、削除チェック（`can_delete`）を追加
- `WorkflowDefinitionStatus` enum（Draft / Published / Archived）による状態管理
- ステータスごとの操作制約をドメインモデルに集約

### Phase 2: バリデータ（10 ルール）

- `WorkflowDefinitionValidator` を新規作成
- ステップ構造、遷移参照、フォームフィールド、名前・説明の検証
- `ValidationError` のリスト返却によるエラー集約パターン

### Phase 3: リポジトリ CRUD

- `WorkflowDefinitionRepository` に `insert`、`update_with_version_check`、`delete` を追加
- 楽観的ロック（version カラム）による並行更新の防止
- SQLx の `query!` マクロによる型安全なクエリ

### Phase 4: ユースケース

- `WorkflowDefinitionUseCaseImpl` を新規作成
- 5 操作（create、update、publish、archive、delete）を実装
- バリデーション → ドメインロジック → 永続化の 3 段構成

### Phase 5: Core Service ハンドラ

- 5 エンドポイント（POST create、PUT update、POST publish、POST archive、DELETE）
- 既存の `workflow/query.rs` パターンを踏襲
- エラーハンドリング: ValidationFailed → 400、NotFound → 404、VersionConflict → 409

### Phase 6: BFF レイヤー

- `CoreServiceWorkflowClient` にプロキシメソッドを追加
- `workflow_definition:manage` 権限による認可制御
- DB マイグレーションで権限レコードを追加

### Phase 7: 統合テスト

- Core Service 統合テスト 6 件（CRUD + ステータス遷移 + バリデーションエラー）
- BFF 認可テスト 3 件（権限あり / 権限なし / 未認証）

### 品質ゲート対応

- `cargo clippy` の `collapsible_if` 警告を Rust 1.93 の let chains 構文で修正
- テスト関数名の `non_snake_case` 警告を修正（英大文字 → 小文字）
- SQLx のクエリキャッシュ（`.sqlx/`）を再生成

## 判断ログ

- Phase 1 Refactor: ステータス遷移ロジックを `WorkflowDefinitionStatus` のメソッドではなく `WorkflowDefinition` のメソッドとして配置。理由: ステータスだけでなくエンティティ全体の整合性を保つ責務のため
- Phase 2 Refactor: バリデーションエラーを `Vec<ValidationError>` で集約し、最初のエラーで中断しない設計を採用。理由: UX 向上（一度に全エラーを表示）
- Phase 3 Refactor: 楽観的ロックを `version` カラムで実装。`updated_at` ベースではなくインクリメンタルなバージョン番号を採用。理由: タイムスタンプの精度問題を回避
- Phase 5 Refactor: `VersionConflict` を 409 Conflict にマッピング。RFC 9110 に準拠
- Phase 6 Refactor: BFF の認可テストで `StubSessionManager` を各テストファイルに配置。既存の `authz.rs` 内テストパターンを踏襲
- clippy 修正: Rust 1.93 で安定化された let chains（`if let ... && condition`）を採用。`collapsible_if` lint の新しい推奨パターン

## 成果物

### コミット

```
c24f74b #723 Add CRUD business logic to WorkflowDefinition domain model
9bbc130 #723 Add workflow definition validator with 10 validation rules
7483bab #723 Extend WorkflowDefinitionRepository with CRUD operations
7f9509b #723 Add WorkflowDefinitionUseCaseImpl with CRUD operations
339722e #723 Add workflow definition CRUD handlers and routes
49bfe53 #723 Add BFF layer for workflow definition CRUD API
0424198 #723 Add integration tests for workflow definition CRUD API
001ca91 #723 Fix clippy collapsible_if and snake_case warnings
881edba #723 Add SQLx prepared query cache for workflow definition CRUD
```

### PR

- #730 (Draft): #723 Implement workflow definition CRUD API

### 主な変更ファイル

- `backend/crates/domain/src/workflow/definition.rs` — ドメインモデル CRUD ロジック
- `backend/crates/domain/src/workflow/definition_validator.rs` — バリデータ（新規）
- `backend/crates/infra/src/repository/workflow_definition_repository.rs` — リポジトリ CRUD
- `backend/apps/core-service/src/usecase/workflow_definition.rs` — ユースケース（新規）
- `backend/apps/core-service/src/handler/workflow_definition.rs` — Core Service ハンドラ（新規）
- `backend/apps/bff/src/handler/workflow_definition.rs` — BFF ハンドラ（新規）
- `backend/apps/bff/src/client/core_service/workflow_client.rs` — BFF クライアント拡張
- `backend/apps/core-service/tests/workflow_definition_integration_test.rs` — 統合テスト（新規）
- `backend/apps/bff/tests/workflow_definition_authz_test.rs` — 認可テスト（新規）
