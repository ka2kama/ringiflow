# Usecase 層エラーパステスト追加

## 概要

Issue #322 に基づき、reject_step / submit_workflow ユースケースのエラーパステストを追加した。Issue 精査で approve_step のエラーパステストが #291 で既に追加済みであることを発見し、スコープを reject + submit に限定した。

## 背景と目的

#291（テストカバレッジ改善）で Usecase 層のテストカバレッジを分析した結果、正常系テストは充実しているがエラーパスのカバレッジが薄いことが判明していた。#322 としてエラーパステスト追加が起票されていた。

## 実施内容

### Issue 精査

Issue #322 の完了基準には approve/reject/submit の 3 ユースケースが含まれていたが、approve のエラーパステストは #291 で既に追加済みだった。Issue を修正してスコープを限定した。

### テスト追加（4 件）

| テスト | 検証内容 | 期待エラー |
|--------|----------|-----------|
| `test_reject_step_未割り当てユーザーは403` | 担当者以外が却下を試みる | `Forbidden` |
| `test_reject_step_active以外は400` | Pending ステップの却下 | `BadRequest` |
| `test_reject_step_バージョン不一致で409` | 楽観的ロック競合 | `Conflict` |
| `test_submit_workflow_draft以外は400` | InProgress からの申請 | `BadRequest` |

approve_step の既存テストパターンを踏襲した特性テスト（Characterization Test）として実装。

### Issue #330 作成

テスト変数名を `usecase` から `sut`（System Under Test）に統一する提案を Issue 化した。

## 判断ログ

特筆すべき判断なし。既存パターンの横展開のため、新しい設計判断は発生しなかった。

## 成果物

### コミット

- `#322 Add error path tests for reject_step and submit_workflow usecases`

### 変更ファイル

- `backend/apps/core-service/src/usecase/workflow.rs`（テスト追加 +258 行）

### Issue / PR

- Issue #322: 完了基準すべてチェック済み
- PR #329: Draft（Ready for Review 待ち）
- Issue #330: `sut` 命名規約の導入（新規作成）

## 議論の経緯

### テスト変数名 `sut` の採用

ユーザーから Rust/Elm で `sut` は使われないのかという質問があった。`sut` は xUnit Test Patterns 由来で C#/Java 圏では標準だが、Rust コミュニティでは具体名（`usecase`, `repo` 等）が主流であることを説明。このプロジェクトでは Arrange が長く、テスト対象が埋もれやすいため `sut` が有効と判断し、Issue #330 として起票した。

## 学んだこと

- Issue 精査の重要性: Issue が古い情報に基づいている場合がある。着手前に現状を確認することで、不要な作業を回避できた（approve テストの重複実装を防止）
- 特性テストの位置づけ: 既存コードのテスト追加は TDD の Red→Green→Refactor とは異なるリズムになる。テストが即座に Green になるのが正常で、Red になったらバグの発見を意味する

## 次のステップ

- PR #329 を Ready for Review にする（ユーザー承認待ち）
- Issue #330（`sut` 命名規約）に着手
