# wrap-up 構造的チェックポイント追加

## 概要

PR 完了フローに wrap-up 完了の検証ステップ（構造的チェックポイント）を追加した。行動規範では防止できなかった「wrap-up 前に Ready を提案する」問題（2回再発）に対する構造的対策。

## 背景と目的

Issue: #344

PR #332 と PR #339 で、wrap-up（`/wrap-up`）を実行する前に「Ready にしてよいですか？」を提案する問題が再発した。1回目の対策「既存手順に従う」は行動規範であり、2回目で再発が確認された。

#337（`pre-implementation.md` のリデザイン）で実証された「行動規範 → 構造的チェックポイント」パターンを適用し、PR 完了フローに検証ステップを追加する。

## 実施内容

### 問題解決フレームワークの適用

| 要素 | 内容 |
|------|------|
| Want | PR 完了フローの手順順序が確実に守られること（品質の追求） |
| To-Be | wrap-up が Ready 提案前に必ず実行される |
| As-Is | 行動規範のみで構造的強制力なし。2回再発 |
| ギャップ | 行動規範は AI エージェントに構造的強制力を持たない |
| 根本原因 | wrap-up → Ready の間に検証チェックポイントがない |
| 対策 | git diff ベースの構造的検証ステップの追加 |

### CLAUDE.md の変更

PR 完了フローに Step 5（wrap-up 完了の検証）を追加:

- `git diff --name-only main...HEAD` でドキュメントファイルの存在を確認
- 対象ディレクトリ: `prompts/runs/`, `prompts/improvements/`, `docs/70_ADR/` 等
- ドキュメントが存在しない場合は `/wrap-up` を先に実行
- 禁止事項に「wrap-up 完了を検証せずに Ready を提案すること」を追加

### 改善記録の更新

`2026-02-09_2134_wrap-up前にReadyを提案する再発.md` に検証セクションを追記。

## 設計上の判断

### 検証方法: git diff ベース vs セッション内状態

| 選択肢 | メリット | デメリット |
|--------|---------|-----------|
| git diff ベース（採用） | セッション跨ぎでも機能する。客観的・検証可能 | wrap-up を実行したが「作成不要」だった場合に偽陰性 |
| セッション内状態 | 正確 | セッション再開時にリセットされる |

git diff ベースを採用。偽陰性（wrap-up 実行済みだがドキュメント不要だった場合）は `/wrap-up` の再実行で解消でき、害がない。

## 判断ログ

特筆すべき判断なし。#337 の確立済みパターンの再適用。

## 成果物

### コミット

- `e5bac42` #344 Add structural checkpoint for wrap-up verification in PR completion flow

### 作成・更新ファイル

| ファイル | 変更内容 |
|---------|---------|
| `CLAUDE.md` | PR 完了フローに Step 5（検証チェックポイント）を追加 |
| `prompts/improvements/2026-02/2026-02-09_2134_...md` | 検証セクション追記 |

### PR

- #345 (Draft)

## 議論の経緯

特になし。Issue の完了基準が明確であり、先行事例（#337）のパターンに従って実装した。

## 学んだこと

- 「行動規範 → 構造的チェックポイント」は再現性のあるパターンとして確立された。行動規範が失敗したら、成果物要件（検証可能な証跡）に変換するアプローチが有効
- git diff ベースの検証は、セッション境界を跨いでも機能する客観的な検証方法として汎用的

## 次のステップ

- 次回の PR 完了フローで構造的チェックポイントの効果を検証する
