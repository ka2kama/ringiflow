# Rust フォーマッター標準化

## 概要

Issue #541 に基づき、Rust フォーマッター設定をベストプラクティス起点で包括的に見直した。rustfmt が提供する全86個の設定オプションを検討し、公式ドキュメントとコミュニティのベストプラクティスに基づいて設定を選択。特に `edition` / `style_edition` の明示的設定により rustfmt と cargo fmt の整合性を確保し、コメント自動整形機能を追加した。

## 実施内容

### 1. Issue 精査（初回）

- Issue #541 の本来の意図を確認: フォーマッター設定全体の見直し
- As-Is 検証: `.rustfmt.toml` で `tab_spaces = 3`、unstable features 使用中
- Want の特定: AI フレンドリーで業界標準の開発環境を構築する

### 2. アプローチの修正（ユーザーフィードバック）

**問題点の指摘:**
- 初回実装は既存設定の部分的修正にとどまっていた
- `tab_spaces` のみ変更し、他の設定項目を検討していなかった
- ベストプラクティス起点のアプローチに反していた

**修正方針:**
- rustfmt 公式ドキュメントから全86個の設定オプションを調査
- ベストプラクティスを起点に、必要な設定を追加・変更・削除する包括的レビュー
- 既存項目の編集にとどまらず、rustfmt 自体のベストプラクティスを基準とする

### 3. 包括的設定レビュー

**調査結果:**
- rustfmt は全86個の設定オプションを提供
- 既存設定は7個のみ（stable: 3個、unstable: 4個）
- プロジェクトは Rust Edition 2024 を使用

**重要な発見:**
1. **Edition 設定の欠如**: `edition` と `style_edition` が未設定で、rustfmt（デフォルト "2015"）と cargo fmt（Cargo.toml から推論）に不整合リスク
2. **コメント整形の不足**: `wrap_comments` や `normalize_comments` が未設定
3. **モダン Rust イディオム**: `use_try_shorthand` が未設定

### 4. 設定の選択基準

**Stable 設定の追加:**

| 設定 | 理由 |
|------|------|
| `edition = "2024"` | Cargo.toml との整合性確保（最重要） |
| `max_width = 100` | 明示的に記載（デフォルトだが重要） |
| `hard_tabs = false` | スペース使用を明示 |
| `use_try_shorthand = true` | モダンな Rust イディオム（`?` 演算子） |

**Unstable 設定の追加:**

| 設定 | 理由 |
|------|------|
| `style_edition = "2024"` | rustfmt と cargo fmt の整合性確保（最重要） |
| `wrap_comments = true` | 長いコメントの自動折り返し |
| `normalize_comments = true` | コメントスタイルの統一 |

**既存設定の維持:**
- Import 関連（`group_imports`、`imports_granularity`、`imports_layout`）
- ドキュメント・impl・構造体関連の設定

### 5. rustfmt-nightly の選択

**選択肢の検討:**

| 選択肢 | 内容 | 評価 |
|--------|------|------|
| A | stable のみ（unstable features 削除） | 却下: import 整理・コメント整形が手動になる |
| B | nightly ツールチェーン全体を導入 | 却下: 不要なコンポーネント（rustdoc など）も含まれる |
| C | rustfmt-nightly のみ使用 | **採用**: 最小限のインストールで高度な機能を利用可能 |

### 6. 実装

1. **設定変更**: `.rustfmt.toml` を包括的に更新
   - Stable 設定: `edition`、`max_width`、`hard_tabs`、`use_try_shorthand` を追加
   - Unstable 設定: `style_edition`、`wrap_comments`、`normalize_comments` を追加
   - コメントを追加してセクション分け、各設定の意図を明確化
2. **リフォーマット**: `just fmt-rust`（nightly）で全ファイルをリフォーマット
   - 48ファイル変更（175行追加、86行削除）
   - コメントの自動折り返しとスタイル統一が主な変更
   - import 整理、フィールド整列などの既存 unstable features も適用
3. **git blame 保護**: `.git-blame-ignore-revs` を更新（新しいリフォーマットコミットを登録）
4. **ドキュメント更新**: ADR とナレッジベースに包括的レビューの内容を反映

### 7. 品質検証（保留中）

- `just check-all` でのテストとリントチェック
- CI での検証

## 判断ログ

### 判断 0: アプローチの全面的見直し

**背景**: 初回実装は既存設定の `tab_spaces` のみを変更し、他の設定項目を検討していなかった。

**選択肢**:
- 初回実装を継続（部分的な修正）
- ベストプラクティス起点で全面的に見直し

**決定**: 全面的な見直し

**理由**:
- Issue #541 の本来の意図は「フォーマッター設定全体の見直し」
- ベストプラクティス起点のアプローチに従うべき（`.claude/rules/latest-practices.md`）
- rustfmt が提供する86個の設定オプションを検討対象にすべき
- `edition` / `style_edition` など重要な設定が未設定だった

### 判断 1: Edition 設定の明示化

**背景**: `edition` と `style_edition` が未設定で、rustfmt と cargo fmt に不整合リスクがあった。

**決定**: 両方を `"2024"` に明示的に設定

**理由**:
- rustfmt のデフォルトは "2015"、cargo fmt は Cargo.toml から推論（"2024"）
- 不整合によるフォーマット結果の違いを防止
- 公式ドキュメントでも明示的な設定が推奨されている

### 判断 2: コメント自動整形の導入

**背景**: 長いコメント行が手動で折り返されており、一貫性がなかった。

**決定**: `wrap_comments` と `normalize_comments` を有効化

**理由**:
- 長いコメントの自動折り返しで可読性向上
- コメントスタイルの統一
- 手動での一貫性維持は現実的でない

### 判断 3: unstable features の維持

**背景**: rustfmt の unstable features を使用しているが、nightly 依存のリスクがある。

**選択肢**:
- stable のみに制限（安定性優先）
- unstable features を維持（機能優先）

**決定**: unstable features を維持

**理由**:
- import 自動整理（`group_imports`、`imports_granularity`）は手動では維持困難
- 長い import リストの垂直展開（`imports_layout`）は可読性向上に寄与
- 構造体フィールドの整列（`struct_field_align_threshold`）はレビュー時の視認性向上
- nightly の仕様変更リスクより、手動維持のコストの方が高い

### 判断 4: rustfmt-nightly のみをインストール

**背景**: unstable features を使用するには nightly が必要。

**選択肢**:
- nightly ツールチェーン全体をインストール
- rustfmt-nightly のみをインストール

**決定**: rustfmt-nightly のみ

**理由**:
- rustdoc など他の nightly コンポーネントは不要
- 最小限のインストールで環境構築の負担を軽減
- `rustup component add rustfmt --toolchain nightly` で rustfmt のみ追加可能

### 判断 5: `.git-blame-ignore-revs` の導入

**背景**: 全ファイルのリフォーマットにより、git blame が使いにくくなる。

**決定**: `.git-blame-ignore-revs` を導入

**理由**:
- リフォーマットコミットを git blame から除外できる
- 実際のロジックを書いた人を追跡可能にする
- Git の標準機能で、追加の依存なし
- 各開発者が `git config blame.ignoreRevsFile` を設定する必要があるが、一度のみの設定


## 成果物

### コミット

1. `33149dc` - rustfmt 設定ファイルの包括的更新
2. `c479983` - 更新された設定での全ファイルリフォーマット
3. `4f73391` - `.git-blame-ignore-revs` の更新
4. `523f59a` - ADR とナレッジベースの更新

### ドキュメント

- **ADR-048**: Rust フォーマッター設定の標準化（包括的レビューの内容を反映）
- **ナレッジベース**: `docs/06_ナレッジベース/rust/rustfmt.md`（設定カテゴリテーブルを追加）
- **`.git-blame-ignore-revs`**: リフォーマットコミットを登録

### PR

- **#553**: Standardize Rust formatter to industry best practices（Draft、再作業中）
