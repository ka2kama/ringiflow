# Rust フォーマッター標準化

## 概要

Issue #541 に基づき、Rust フォーマッター設定を業界標準に統一した。`tab_spaces` を 3 → 4 スペースに変更し、unstable features を維持する方針を採用。rustfmt-nightly を使用して全コードをリフォーマットした。

## 実施内容

### 1. Issue 精査

- Issue #541 の本来の意図を確認: フォーマッター設定全体の見直し（`tab_spaces` だけでなく unstable features も含む）
- As-Is 検証: `.rustfmt.toml` で `tab_spaces = 3`、unstable features 使用中
- Want の特定: AI フレンドリーで業界標準の開発環境を構築する

### 2. 設計判断

**選択肢の検討:**

| 選択肢 | 内容 | 評価 |
|--------|------|------|
| A | stable のみ（unstable features 削除） | 却下: import 整理が手動になり、保守コスト増 |
| B | nightly ツールチェーン全体を導入 | 却下: 不要なコンポーネント（rustdoc など）も含まれる |
| C | rustfmt-nightly のみ使用 | **採用**: 最小限のインストールで高度な機能を利用可能 |

**採用理由:**
- Rust 本体は stable を維持（安定性）
- rustfmt のみ nightly 版を使用（高度なフォーマット機能）
- import 自動整理などの unstable features は手動維持が困難で、自動化の価値が高い

### 3. 実装

1. **設定変更**: `.rustfmt.toml` の `tab_spaces` を 3 → 4 に変更
2. **リフォーマット**: `just fmt-rust`（nightly）で全ファイルをリフォーマット
   - インデント変更（3 → 4 スペース）
   - unstable features の適用（import 整理、フィールド整列など）
3. **git blame 保護**: `.git-blame-ignore-revs` を作成し、リフォーマットコミットを登録
4. **環境構築更新**: rustfmt-nightly のインストール手順を追加
5. **justfile 更新**: `check-tools` に rustfmt-nightly の確認を追加

### 4. ドキュメント化

- **ADR-048**: rustfmt 設定標準化の設計判断を記録
- **ナレッジベース**: `docs/06_ナレッジベース/rust/rustfmt.md` を作成
  - rustfmt の使用方法
  - unstable features の説明
  - `.git-blame-ignore-revs` の使い方

### 5. 品質検証

- `just check-all` 実行: コード重複検出で失敗（既存問題）
- main ブランチとの比較: 同じエラーが発生することを確認
- 結論: rustfmt の変更によって新しいエラーは発生していない

## 判断ログ

### 判断 1: unstable features の維持

**背景**: rustfmt の unstable features を使用しているが、nightly 依存のリスクがある。

**選択肢**:
- stable のみに制限（安定性優先）
- unstable features を維持（機能優先）

**決定**: unstable features を維持

**理由**:
- import 自動整理（`group_imports`、`imports_granularity`）は手動では維持困難
- 長い import リストの垂直展開（`imports_layout`）は可読性向上に寄与
- 構造体フィールドの整列（`struct_field_align_threshold`）はレビュー時の視認性向上
- nightly の仕様変更リスクより、手動維持のコストの方が高い

### 判断 2: rustfmt-nightly のみをインストール

**背景**: unstable features を使用するには nightly が必要。

**選択肢**:
- nightly ツールチェーン全体をインストール
- rustfmt-nightly のみをインストール

**決定**: rustfmt-nightly のみ

**理由**:
- rustdoc など他の nightly コンポーネントは不要
- 最小限のインストールで環境構築の負担を軽減
- `rustup component add rustfmt --toolchain nightly` で rustfmt のみ追加可能

### 判断 3: `.git-blame-ignore-revs` の導入

**背景**: 全ファイルのリフォーマットにより、git blame が使いにくくなる。

**決定**: `.git-blame-ignore-revs` を導入

**理由**:
- リフォーマットコミットを git blame から除外できる
- 実際のロジックを書いた人を追跡可能にする
- Git の標準機能で、追加の依存なし
- 各開発者が `git config blame.ignoreRevsFile` を設定する必要があるが、一度のみの設定

### 判断 4: PR 本文の「Test plan」での品質検証の記録

**背景**: `just check-all` がコード重複検出で失敗している。

**選択肢**:
- コード重複を解消してから PR を出す
- 既存問題として許容し、rustfmt の変更が原因でないことを明記

**決定**: 既存問題として許容

**理由**:
- main ブランチでも同じエラーが発生することを確認済み
- コード重複の解消は Issue #541 のスコープ外
- PR 本文に「既存問題」と明記し、誤解を防ぐ

## 成果物

### コミット

1. `9457099` - Rustfmt の標準化（リフォーマット実行）
2. `53989ad` - `.git-blame-ignore-revs` の追加
3. `af600e6` - rustfmt-nightly セットアップ手順の追加
4. `bd7e438` - ADR とナレッジベースの作成

### ドキュメント

- **ADR-048**: Rust フォーマッター設定の標準化
- **ナレッジベース**: `docs/06_ナレッジベース/rust/rustfmt.md`
- **開発環境構築手順書**: rustfmt-nightly のインストール手順を追加
- **`.git-blame-ignore-revs`**: リフォーマットコミットを登録

### PR

- **#553**: Standardize Rust formatter to industry best practices（Draft）
