# ワークフローデザイナー設計ドキュメント

## 概要

Issue #722 の設計ドキュメント作成タスク。Phase 2-4（ワークフローデザイナー）の実装に先立ち、技術選定 ADR、機能仕様書、詳細設計書の 3 ドキュメントを作成した。

ブランチ: `feature/722-workflow-designer-docs`
PR: #728

## 実施内容

### Phase 1: 技術選定 ADR（ADR-053）

`docs/70_ADR/053_ワークフローデザイナー技術選定.md` を作成。

判断事項:
1. キャンバスの描画方式 → SVG + Elm 直接レンダリング（`elm/svg` 1.0.1 既存）
2. ドラッグ&ドロップの実装方式 → Elm マウスイベント（`Browser.Events`）

3 つの Canvas 方式（SVG / HTML Canvas + JS / HTML DOM + CSS）と 3 つの D&D 方式（ブラウザ D&D API / Elm マウスイベント / Ports 経由 JS）を比較検討した。

### Phase 2: 機能仕様書

`docs/20_機能仕様書/04_ワークフローデザイナー.md` を作成。

9 セクション体系に準拠:
- 4 シナリオ（新規作成、既存編集、バリデーションエラー解消、アーカイブ）
- 7 機能カテゴリ（定義一覧管理、キャンバス、ステップパレット、接続線、プロパティパネル、バリデーション、フォーム定義）
- 10 バリデーションルール
- Draft → Published → Archived の状態遷移
- Phase 2-4 スコープ（start/approval/end の 3 ステップ種別、user assignee type のみ）

`00_はじめに.md` の読む順序にも追記。

### Phase 3: 詳細設計書

`docs/40_詳細設計書/15_ワークフローデザイナー設計.md`（810 行）を作成。

主な内容:
- アーキテクチャ: シーケンス図 3 本（作成・更新・公開）、Nested TEA コンポーネント構成、SVG キャンバスレイヤー構成
- JSON スキーマ: Phase 2-4 サブセット定義、`position` フィールド追加（後方互換性考慮）
- API 設計: 8 エンドポイント（既存 GET + 新規 CRUD + publish/archive/validate）
- ドメインロジック: Rust コード案（validate_definition、CRUD ユースケース）
- フロントエンド設計: Canvas Model 型定義（Elm）、SVG ビュー構成、D&D イベント
- バリデーションルール: 10 項目（エラーコード付き）
- テスト観点: 4 層（ユニット / ハンドラ / API / E2E）

OpenAPI については `utoipa` 自動生成のため手動編集不可。API 仕様は詳細設計書に記載し、実装時に utoipa アノテーションから生成する方針とした。

## 判断ログ

- `position` フィールドを CORE-11 スキーマに追加する設計判断。既存 seed データとの後方互換性のためデフォルト配置（auto-layout）を設計
- OpenAPI は手動編集ではなく utoipa 自動生成の方針を確認。詳細設計書に API 仕様を記載する方式に変更
- `can_publish()` が Archived → Published 遷移を許可してしまうギャップを検出。実装時に Draft のみ許可に修正する方針を記録
- Phase 2-4 の assignee type は `user` のみに限定（CORE-11 の 6 種のうち 1 種）
- `display_id` は workflow_definitions には Phase 2-4 で導入しない判断

## 成果物

### コミット

- `d585488` #722 WIP: Add workflow designer functional spec and detailed design
- `3164262` #722 Add workflow designer design documents (ADR, functional spec, detailed design)

### 作成・更新ファイル

| ファイル | 種別 |
|---------|------|
| `docs/70_ADR/053_ワークフローデザイナー技術選定.md` | 新規 |
| `docs/20_機能仕様書/04_ワークフローデザイナー.md` | 新規 |
| `docs/20_機能仕様書/00_はじめに.md` | 更新 |
| `docs/40_詳細設計書/15_ワークフローデザイナー設計.md` | 新規 |
| `prompts/plans/722_workflow-designer-docs.md` | 新規（計画ファイル） |
