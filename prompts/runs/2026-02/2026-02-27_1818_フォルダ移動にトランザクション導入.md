# フォルダ移動/名前変更にトランザクション導入

- Issue: #927
- PR: #952
- ブランチ: `feature/927-folder-transaction`

## 概要

`FolderUseCaseImpl::update_folder` で `update` と `update_subtree_paths` が別々の DB 操作として実行されていた問題を解消。トランザクションで囲み、サブツリーの最大 depth 事前検証を追加した。

## 変更内容

### Phase 1: FolderRepository TxContext 対応 + ユースケーストランザクション

- `FolderRepository` トレイトの `update` と `update_subtree_paths` に `&mut TxContext` パラメータを追加
- `PostgresFolderRepository` の実装を `self.pool` から `tx.conn()` に変更
- `FolderUseCaseImpl` に `TransactionManager` 依存を追加
- `update_folder` 内で `begin()` → `update` → `update_subtree_paths` → `commit()` のトランザクションフローを構築
- `main.rs` の DI 設定で `tx_manager` を複数ユースケース間で共有

### Phase 2: サブツリー最大 depth 事前検証

- `FolderRepository` トレイトに `max_subtree_depth` メソッドを追加
- PostgreSQL 実装: `COALESCE(MAX(depth), 0)` + `starts_with(path, $2)` で集計
- `update_folder` のトランザクション開始前に depth 検証を実施
- `depth_delta > 0` ガード: 浅い方向への移動ではクエリを省略
- `MockFolderRepository` を `mock.rs` に追加（インメモリ実装）

## 設計判断

### TxContext の適用範囲

`insert` と `delete` は単一の独立した DB 操作のため TxContext 不要。`update` + `update_subtree_paths` のみが複数操作のアトミック性を要求する。ADR-051 の「構造的強制」パターンに準拠。

### Read outside tx, Write inside tx

`find_by_id`（読み取り）や `max_subtree_depth`（集計）はトランザクション外で実行し、ロック期間を最小化。書き込み操作のみトランザクション内で実行する。

### depth_delta > 0 ガード

浅い方向（depth_delta <= 0）への移動では depth 超過が起きないため、`max_subtree_depth` クエリを省略してパフォーマンスを最適化。

## テスト

- ユニットテスト: `test_update_folder_サブツリーdepth超過時にエラーを返す`
  - 3 階層サブツリーを 4 階層の下に移動 → depth 7 > 5 でエラー
- 既存ハンドラテスト: `StubFolderRepository` を新シグネチャに更新
- 全フォルダ関連テスト（50 件）通過
