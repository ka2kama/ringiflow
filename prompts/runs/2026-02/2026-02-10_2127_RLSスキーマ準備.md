# RLS スキーマ準備（Story 1: #407）

## 概要

Phase 2-1 マルチテナント RLS 実装の Story 1 として、全テナントスコープテーブルへの RLS ポリシー設定と、`workflow_steps`・`user_roles` への `tenant_id` カラム追加を実施した。

対応 Issue: #407（Epic: #402）

## 実施内容

### マイグレーション作成（3 ファイル）

1. `20260210000001_add_tenant_id_to_workflow_steps.sql`
   - `tenant_id UUID` カラム追加 → `workflow_instances` からバックフィル → NOT NULL 制約 → FK + インデックス

2. `20260210000002_add_tenant_id_to_user_roles.sql`
   - `tenant_id UUID` カラム追加 → `users` からバックフィル → NOT NULL 制約 → FK + インデックス

3. `20260210000003_enable_rls_policies.sql`
   - `ringiflow_app` 非 superuser ロール作成
   - 全 9 テナントスコープテーブルに `ENABLE ROW LEVEL SECURITY`
   - `tenant_isolation` ポリシー: `USING (tenant_id = NULLIF(current_setting('app.tenant_id', true), '')::UUID)`
   - `roles` テーブルのみ `OR tenant_id IS NULL`（システムロール対応）
   - `tenants` テーブルは `id` で比較

### リポジトリ・テスト更新

- `WorkflowStepRepository::insert` トレイト署名に `tenant_id: &TenantId` パラメータ追加
- 全呼び出し元（プロダクション 1 箇所 + Mock 3 箇所 + テスト多数）を更新
- `assign_role` テストヘルパーに `tenant_id` パラメータ追加
- sqlx オフラインキャッシュ更新

## 判断ログ

- 非正規化（`workflow_steps`・`user_roles` に `tenant_id` カラム追加）を採用。JOIN ベースの RLS ポリシーは PostgreSQL 公式ドキュメントで非推奨（全行に対して JOIN を評価するためパフォーマンス劣化）
- RLS ポリシーの `NULLIF` パターン: `current_setting('app.tenant_id', true)` は未設定時に空文字列を返す。`''::UUID` はキャストエラーになるため `NULLIF` で NULL に変換し、`tenant_id = NULL` が常に false となる安全設計
- `set_config()` を採用（`SET` は PostgreSQL のパラメータ化クエリ非対応）

## 成果物

- コミット: `ed331e4` → `#407 Add tenant_id columns and enable RLS policies for all tenant-scoped tables`
- Draft PR: #413
- 新規ファイル: マイグレーション 3 ファイル
- 更新ファイル: リポジトリ 1 + ユースケース 3 + テスト 3 + テストヘルパー 1 + sqlx キャッシュ 3
