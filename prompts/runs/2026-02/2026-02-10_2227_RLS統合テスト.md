# RLS 統合テスト

## 概要

PostgreSQL RLS（Row Level Security）ポリシーの動作を検証する統合テストを実装した。全 9 テナントスコープテーブルのクロステナントアクセス防止、`app.tenant_id` 未設定時の安全動作、system roles の全テナント参照可能性、WITH CHECK（INSERT 制約）、TenantConnection 統合テストの 13 テストを作成した。

## 実施内容

### Phase 1: テストヘルパーと基本テーブル

- `TwoTenantFixture` 構造体: 2 テナント分のテストデータ ID を保持
- `setup_two_tenants()`: 全 9 テーブルに FK 依存順でデータを投入するヘルパー
- `set_tenant_context()` / `set_app_role_without_tenant()` / `reset_role()`: ロール切り替えヘルパー
- tenants テーブル: テナント分離テスト + tenant_id 未設定テスト
- users テーブル: テナント分離テスト
- roles テーブル: system roles 含むテスト + クロステナント防止テスト

### Phase 2: 残りのテーブル

user_roles, workflow_definitions, workflow_instances, workflow_steps, display_id_counters, auth.credentials の各テーブルに対してテナント分離テストを追加。Phase 1 のパターンを踏襲。

### Phase 3: WITH CHECK + TenantConnection 統合

- WITH CHECK テスト: テナント A のコンテキストでテナント B の tenant_id を持つ行の INSERT が `row-level security` エラーで拒否されることを検証
- TenantConnection 統合テスト: `SET ROLE ringiflow_app` + `set_config('app.tenant_id', ...)` の組み合わせでテナント切り替えが正しく機能することを検証

### 技術的対応

- `sqlx::query!` マクロの型推論エラー（32 件）→ `sqlx::query` + `.bind()` パターンに切り替え
- worktree 環境での dev-deps 起動（`setup-env.sh` → `just dev-deps` → `just setup-db`）

## 判断ログ

- テストセットアップに `sqlx::query!`（コンパイル時検証）ではなく `sqlx::query`（ランタイム）を採用した。理由: テストセットアップの INSERT 文で型推論が解決できず 32 件のコンパイルエラーが発生。テストセットアップは SELECT と異なりコンパイル時の型安全性の恩恵が薄いため、ランタイムクエリで十分と判断
- TenantConnection テストは `TenantConnection::acquire` を直接呼ぶのではなく、`SET ROLE` + `set_config` で本番相当操作をシミュレーションする方式を採用。理由: `#[sqlx::test]` が提供するプールは superuser であり、BYPASSRLS 権限を持つため、`TenantConnection::acquire` だけでは RLS が機能しない

## 成果物

- `backend/crates/infra/tests/rls_test.rs`（新規作成、614 行、13 テスト）
- `prompts/plans/409_rls-integration-test.md`（計画ファイル）
- PR: #416
