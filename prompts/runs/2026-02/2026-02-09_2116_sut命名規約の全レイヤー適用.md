# sut 命名規約の全レイヤー適用

## 概要

全レイヤーのテストで、テスト対象オブジェクトの変数名を `sut`（System Under Test）に統一した。TDD 開発フローにテスト規約セクションを新設し、全レイヤーでの適用例を記録した。

## 背景と目的

Issue #322（Usecase 層エラーパステスト追加）の作業中に、テスト対象の `usecase` 変数が Mock リポジトリやテストデータの中に埋もれる問題が指摘された。`sut` を採用することで「このテストの主役」を名前レベルで明確にする。

## 実施内容

### Phase 1: テスト規約の策定

TDD 開発フロー（`docs/04_手順書/04_開発フロー/02_TDD開発フロー.md`）にテスト規約セクションを新設。`sut` の定義、適用範囲、レイヤー別の例を記載した。

### Phase 2: Usecase テストのリネーム（4ファイル）

- core-service: `workflow.rs`, `task.rs`, `dashboard.rs`
- auth-service: `auth.rs`

全ファイルで `usecase` → `sut` にリネーム。

### Phase 3: 全レイヤーへの拡大（12ファイル）

スコープ拡大の判断後、残りのテストファイルをリネーム:

- Repository テスト（7ファイル）: `repo` / `step_repo` → `sut`
- Handler テスト（3ファイル）: `app` → `sut`
- Session テスト（1ファイル）: `manager` → `sut`
- BFF 統合テスト（1ファイル）: `app` → `sut`

## 設計上の判断

### スコープ拡大: Usecase のみ → 全レイヤー

当初は Usecase 層のみの適用を想定していた。各レイヤーの変数名（`repo`, `app`, `manager`）はテスト対象として十分に明確だという判断。

しかしユーザーから「統一感がないとどちらを使うべきか混乱しないか？」という指摘があり、KISS 原則をルール自体に適用した。レイヤーごとに条件分岐するルールよりも、「テスト対象 = `sut`」という1つのルールの方がシンプル。

### replace_all の安全性

各ファイルで `replace_all` を使用する際、型名・モジュールパス・関数パラメータとの衝突がないことを確認した。Rust の PascalCase 命名規約（型名 `SessionManager` vs 変数名 `manager`）が機械的な一括置換を安全にしてくれた。

## 判断ログ

特筆すべき判断なし。スコープ拡大は設計上の判断に記載済み。

## 成果物

### コミット

| コミット | 内容 |
|---------|------|
| `0ed3488` | テスト規約を TDD 開発フローに追加 |
| `3ed1589` | core-service Usecase テストのリネーム |
| `05832a2` | auth-service Usecase テストのリネーム |
| `b64f788` | 残りの全レイヤーテストのリネーム |

### 作成・更新ファイル

- `docs/04_手順書/04_開発フロー/02_TDD開発フロー.md` — テスト規約セクション新設
- Usecase テスト 4ファイル
- Repository テスト 7ファイル
- Handler テスト 3ファイル
- Session テスト 1ファイル
- BFF 統合テスト 1ファイル

### PR

- #332 (Ready for Review)

## 議論の経緯

### テスト規約の配置先

ナレッジベースに配置する案が出たが、テスト規約はプロジェクト全体のコーディング規約であり、TDD 開発フローに記載する方が適切と判断した。

### スコープの拡大

当初 Usecase 層のみの予定だったが、ユーザーから「統一感がないとどちらを使うべきか混乱しないか？」という指摘があった。効果の濃淡はあるが、ルールの単純さを優先して全レイヤーに適用することを決定した。

## 学んだこと

- KISS 原則はコードだけでなく、ルール自体にも適用できる。条件付きルールよりも無条件のルールの方が認知負荷が低い
- Rust の PascalCase 命名規約が、変数名の一括置換を安全にする副次的効果を持つ
- `sut` は xUnit Test Patterns（Gerard Meszaros）由来の確立された用語。テスト対象と依存関係の区別を命名で明示する設計パターン

## 発見した問題

なし。

## 次のステップ

なし。Issue #330 は PR マージで自動クローズされる。
