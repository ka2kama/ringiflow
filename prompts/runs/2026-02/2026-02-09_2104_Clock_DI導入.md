# Clock DI 導入

## 概要

ユースケース層の `Utc::now()` 直接呼び出しを `Clock` trait で抽象化し、テストで固定時刻を注入可能にした。これにより workflow.rs の正常系4テストと task.rs の正常系4テストを全体比較（`assert_eq!`）に移行し、#334 の残作業を完了した。

## 背景と目的

Issue: #338

#334（全体比較テスト移行）において、ユースケース層テスト（`task.rs`, `workflow.rs`）は `Utc::now()` で Mock データを構築しており、テスト実行中の時刻が厳密に制御されていないため対象外とした。Clock DI を導入してテストの決定性を確保し、全体比較移行を完了する。

## 実施内容

### Phase 1: Clock trait + SystemClock + FixedClock（domain クレート）

- `backend/crates/domain/src/clock.rs` を新規作成
- `Clock` trait（`Send + Sync` バウンド）、`SystemClock`、`FixedClock` を定義
- 3つのユニットテストを作成

### Phase 2: WorkflowUseCaseImpl への Clock 注入

- `WorkflowUseCaseImpl` に `clock: Arc<dyn Clock>` フィールドを追加
- `create_workflow`, `submit_workflow`, `approve_step`, `reject_step` の `Utc::now()` を `self.clock.now()` に置換
- `submit_workflow` で `Utc::now()` が2回呼ばれていた問題を1回に統合
- `main.rs` で `SystemClock` を生成して注入
- 全12テストを `FixedClock` に移行

### Phase 3: workflow.rs 正常系テスト全体比較移行

- `WorkflowWithSteps` に `#[derive(Debug, PartialEq, Eq)]` を追加
- 4つの正常系テストをフィールド単位アサーションから `assert_eq!(result, expected)` に移行

### Phase 4: task.rs テスト全体比較移行

- `TaskItem`, `TaskDetail` に `#[derive(Debug, PartialEq, Eq)]` を追加
- 4つの正常系テストを全体比較に移行

## 設計上の判断

### Clock trait の配置場所: domain クレート

- Repository trait は `infra` クレートだが、Clock はインフラストラクチャではない
- 時刻はドメイン概念（状態遷移のタイムスタンプ）であり、domain が適切
- `domain` は既に `chrono` に依存しており、新たな依存は不要

### DI パターン: `Arc<dyn Clock>`

既存の Repository DI パターン（`Arc<dyn XxxRepository>`）と一致させた。

### 対象ユースケース: WorkflowUseCaseImpl のみ

- `TaskUseCaseImpl` — プロダクションコードに `Utc::now()` 呼び出しなし → Clock 不要
- `DashboardUseCaseImpl` — `now` は既にパラメータで受け取っている → Clock 不要

### submit_workflow の二重呼び出し修正

`submit_workflow()` でステップ作成とインスタンス遷移に `Utc::now()` が2回呼ばれていた。単一の論理操作には単一のタイムスタンプが適切なため、`self.clock.now()` の1回呼び出しに統合した。

## 判断ログ

特筆すべき判断なし。設計フェーズで全ての判断が完了しており、実装は計画通りに進行した。

## 成果物

### コミット

| コミット | 内容 |
|---------|------|
| `f4c7565` | Clock trait + SystemClock + FixedClock 実装 |
| `9b4a80f` | WorkflowUseCaseImpl への Clock 注入 |
| `57710ca` | workflow.rs 正常系テスト全体比較移行 |
| `1704f7d` | task.rs テスト全体比較移行 |

### 変更ファイル

| ファイル | 変更内容 |
|---------|---------|
| `backend/crates/domain/src/clock.rs` | 新規: Clock trait + 実装 |
| `backend/crates/domain/src/lib.rs` | `pub mod clock;` 追加 |
| `backend/apps/core-service/src/usecase/workflow.rs` | Clock DI、テスト移行 |
| `backend/apps/core-service/src/usecase/task.rs` | derive 追加、テスト移行 |
| `backend/apps/core-service/src/main.rs` | SystemClock 注入 |

## 議論の経緯

Issue #338 の作業は `/next` コマンドで推奨され、ユーザーが選択した。計画はプランモードで作成・承認され、実装は特に議論なく進行した。

## 学んだこと

- `cargo clean --package` で特定パッケージだけクリーンすると、依存先のキャッシュが不整合になることがある。ワークスペース全体で `cargo clean` するか、問題のパッケージとその依存元を両方クリーンする必要がある
- 全体比較テストでは、SUT 内部で生成される非決定的な値（UUID v7 など）は結果から抽出して expected を構築する手法が有効

## 次のステップ

- PR #346 を Ready for Review にする
