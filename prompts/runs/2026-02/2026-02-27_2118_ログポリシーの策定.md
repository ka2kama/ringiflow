# セッションログ: #941 ログポリシーの策定

## 概要

Observability 設計書とログスキーマに、新しいコードを書く際のログ判断基準を追加した。

## 変更内容

### Observability 設計書（`docs/03_詳細設計書/14_Observability設計.md`）

「ログ設計」と「計装設計」の間に「ログポリシー」セクションを新設。7 つの判断基準を追加:

1. ビジネスイベントの追加基準（4 つの判定テスト）
2. ログレベルの判定フロー（Mermaid flowchart + 境界ケース表）
3. ログ vs メトリクスの境界（判定テスト + 適用例）
4. リクエスト/レスポンスボディの方針（記録する/しない）
5. 高頻度イベントの抑制基準（3 条件 + 抑制対象一覧）
6. 計装追加基準（外部システム境界の判定テスト）
7. ログメッセージの書き方ガイドライン（基本原則 + スキーマへの参照）

Phase 4（OpenTelemetry 移行）との整合性表も追加。

### ログスキーマ（`docs/06_ナレッジベース/backend/log-schema.md`）

「メッセージ書き方ガイドライン」セクションを追加:

- 基本原則（定数的な文字列、完了状態の表現、日本語記述、一意性）
- 良い例 / 悪い例（構造化フィールド分離 vs メッセージ埋め込み）
- 命名規約（操作完了、エラー、初期化、サーバー起動、障害検知、非致命的失敗）

## 判断ログ

### 配置場所の選択

- 採用: 独立セクションとして「ログ設計」と「計装設計」の間に新設
- 却下: ログ設計の中にサブセクションとして追加（セクションが肥大化するため）
- 理由: How（ログ設計）→ When/What（ログポリシー）→ Where（計装設計）の論理的な流れ

### 設計書 vs ナレッジベースの分担

- 判断基準（いつ・何をログすべきか）→ Observability 設計書（設計レベル）
- 書き方（メッセージの命名規約、コード例）→ ログスキーマ（実装ガイドレベル）
- 理由: 関心の分離。設計書は「判断」、スキーマは「実装」

### 高頻度イベント抑制基準の対象範囲

- 手動ログ出力と `log_business_event!` のみを対象とし、tower-http による自動リクエストログは対象外とした
- 理由: 既存のログレベルガイドラインに「ヘルスチェック」が INFO の例として含まれており、自動リクエストログを抑制対象に含めると矛盾が生じる

## ベストプラクティス参照

- Better Stack: Canonical Log Line の概念、サンプリング戦略、「ログをモニタリングに使うな」
- Honeycomb: イベント統合（Consolidation）、構造化フィールドへの値分離
- OpenTelemetry: Severity の体系的定義、Semantic Conventions
