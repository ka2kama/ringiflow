# RLS リポジトリ統合: 既存リポジトリの RLS 対応

Issue: #410 | PR: #420 | Branch: `feature/410-rls`

## 概要

Epic #402（マルチテナント RLS 実装）の Story 4。Story 1-3 で追加された `tenant_id` カラムを活用するよう、既存リポジトリのクエリを更新した。アプリケーション層での二重防御を完成させた。

## 実施内容

### Phase 1: WorkflowStepRepository SELECT クエリの直接参照化

`workflow_steps` テーブルに `tenant_id` カラムが追加されたため、`workflow_instances` との JOIN を排除し、直接 `tenant_id` カラムを参照するよう4つの SELECT クエリを簡素化した。

対象クエリ: `find_by_id`, `find_by_instance`, `find_by_assigned_to`, `find_by_display_number`

### Phase 2: `update_with_version_check` に `tenant_id` 追加

トレイトシグネチャに `tenant_id: &TenantId` を追加し、UPDATE の WHERE 句に `AND tenant_id = $10` を追加。呼び出し元2箇所（`approve_step`, `reject_step`）と Mock 3箇所を更新。クロステナント更新防止テストを追加。

### Phase 3: `find_with_roles` の `tenant_id` フィルタ追加

`UserRepository::find_with_roles` 内の user_roles クエリに `AND ur.tenant_id = $2` を追加。`user.tenant_id()` を内部で使用し、トレイトシグネチャは変更なし。

### Phase 4: sqlx-prepare と最終確認

sqlx クエリキャッシュを更新。全 DB 統合テスト（66件）パスを確認。

## 判断ログ

- Phase 1: JOIN 排除は `workflow_instance_repository` の既存パターンと一貫。テーブルエイリアス `s.` も不要になりクエリがシンプルに
- Phase 2: `tenant_id` を引数で渡す設計は INSERT と同じパターン。呼び出し元はすべて `tenant_id` がスコープ内にあることを確認済み
- Phase 3: `find_with_roles` のシグネチャ変更を回避。auth.rs ハンドラに `tenant_id` がなく、内部の `user.tenant_id()` で十分なため
- Phase 3: テスト設計で `user_roles` の一意制約 `(user_id, role_id)` に遭遇。同一ロールを別テナントで割り当てる方式から、別テナント用の別ロールを作成する方式に変更

## 成果物

### コミット

- `788c27e` Simplify WorkflowStep SELECT queries to use direct tenant_id column
- `9334c69` Add tenant_id to WorkflowStep update_with_version_check
- `d2e0460` Add tenant_id filter to find_with_roles user_roles query
- `d099ccf` Update sqlx query cache for tenant_id filter changes

### 変更ファイル

| ファイル | 変更内容 |
|---------|---------|
| `backend/crates/infra/src/repository/workflow_step_repository.rs` | SELECT の JOIN 排除 + UPDATE の tenant_id 追加 |
| `backend/crates/infra/src/repository/user_repository.rs` | find_with_roles の tenant_id フィルタ |
| `backend/crates/infra/tests/workflow_step_repository_test.rs` | クロステナント更新テスト追加 + 既存テスト更新 |
| `backend/crates/infra/tests/user_repository_test.rs` | クロステナントロールテスト追加 |
| `backend/apps/core-service/src/usecase/workflow/command.rs` | 呼び出し元 + Mock 更新 |
| `backend/apps/core-service/src/usecase/task.rs` | Mock 更新 |
| `backend/apps/core-service/src/usecase/dashboard.rs` | Mock 更新 |
| `backend/.sqlx/` | クエリキャッシュ更新 |
