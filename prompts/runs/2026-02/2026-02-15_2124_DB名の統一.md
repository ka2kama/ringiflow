# DB名の統一

## 概要

Issue #548: すべての環境のDB名を `ringiflow` に統一する作業を実施した。

- **目的**: シンプルさと認知負荷の軽減（KISS原則）
- **変更範囲**: 18ファイル24箇所（Docker Compose、環境変数、CI、スクリプト、ドキュメント）
- **成果**: 新しいDB名での動作確認成功、Draft PR #551 作成

## 実施内容

### Phase 1: Docker Compose ファイル更新

`infra/docker/docker-compose.yaml` と `docker-compose.api-test.yaml` の POSTGRES_DB と healthcheck を更新。

```yaml
# 変更前
POSTGRES_DB: ringiflow_dev
test: ["CMD-SHELL", "pg_isready -U ringiflow -d ringiflow_dev"]

# 変更後
POSTGRES_DB: ringiflow
test: ["CMD-SHELL", "pg_isready -U ringiflow -d ringiflow"]
```

### Phase 2: 環境変数・設定ファイル更新

- `backend/.env.template`: DATABASE_URL を `ringiflow` に変更
- `backend/.env.api-test`: DATABASE_URL を `ringiflow` に変更
- `infra/lightsail/.env.example`: POSTGRES_DB を `ringiflow` に変更

### Phase 3: CI/CD 更新

`.github/workflows/ci.yaml` の PostgreSQL 設定を更新。

```yaml
# 変更前
POSTGRES_DB: ringiflow_test
DATABASE_URL: postgres://ringiflow:ringiflow@localhost:15432/ringiflow_test

# 変更後
POSTGRES_DB: ringiflow
DATABASE_URL: postgres://ringiflow:ringiflow@localhost:15432/ringiflow
```

### Phase 4: スクリプト更新

- `scripts/generate-env.sh`: DATABASE_URL の DB 名を `ringiflow` に変更
- `justfile`: `_psql_url` 変数と `api-test-reset-db` タスクの DB 名を更新

### Phase 5: 本番環境ファイル更新

- `infra/lightsail/backup.sh`: デフォルト値を `ringiflow` に変更
- `infra/lightsail/README.md`: DB 名参照を更新

### Phase 6: ドキュメント更新

- `docs/07_実装解説/02_APIテスト/02_APIテスト_コード解説.md`
- `docs/04_手順書/01_開発参画/02_プロジェクトセットアップ.md`
- `prompts/recipes/Lightsailデプロイ_IPv6.md`
- `prompts/plans/468_db-schema-snapshot.md`

各ファイルの DB 名参照を `ringiflow` に統一。API テストの解説では、DB 名での分離ではなくインスタンスでの分離を説明するように更新。

### Phase 7: 動作確認

1. **依存サービス起動**: Docker コンテナをすべて削除してクリーンな状態から起動成功
2. **データベース作成**: `DATABASE_URL=postgres://ringiflow:ringiflow@localhost:15632/ringiflow sqlx database create`
3. **マイグレーション**: 28件のマイグレーションすべて適用成功
4. **テーブル確認**: 10テーブルの存在を確認、DB 名 `ringiflow` で正常動作

### 別Issue作成

API テストのサービス起動タイムアウト問題を Issue #552 として切り出した。

- **問題**: `just test-api` でサービス起動が30秒でタイムアウト
- **原因**: `cargo run` で直接起動するため、コンパイル時間を含む
- **提案**: サービス起動前に `cargo build` を実行

### Draft PR 作成

PR #551 を作成。CI での動作確認待ち。

## 判断ログ

該当なし（すべて計画通りの実装）

## 成果物

### コミット

```
14aff63 #548 Update Docker Compose DB name to ringiflow
a59baff #548 Update environment files DB name to ringiflow
5c8e31b #548 Update CI workflow DB name to ringiflow
104f7d1 #548 Update script and justfile DB name to ringiflow
28ad93c #548 Update Lightsail files DB name to ringiflow
f8a40b8 #548 Update documentation DB name to ringiflow
```

### 変更ファイル

- 設定ファイル: 7ファイル（Docker Compose、環境変数、CI、justfile）
- スクリプト: 2ファイル（generate-env.sh、backup.sh）
- ドキュメント: 5ファイル（手順書、実装解説、レシピ、計画）
- 計画ファイル: 1ファイル（新規作成）

### Pull Request

- Draft PR #551: Unify DB name to ringiflow across all environments
- https://github.com/ka2kama/ringiflow/pull/551

### GitHub Issue

- Issue #552: API テストのサービス起動タイムアウトを改善
- https://github.com/ka2kama/ringiflow/issues/552

## 検証結果

- ✅ 依存サービス起動成功
- ✅ 新しいDB名でデータベース作成成功
- ✅ マイグレーション（28件）すべて適用成功
- ✅ テーブル一覧取得成功（10テーブル確認）
- ⏳ CI での全体チェック待ち（PR #551）
