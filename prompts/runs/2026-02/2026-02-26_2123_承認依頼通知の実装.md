# #876 承認依頼通知の実装

## 概要

ワークフロー申請（submit）・再申請（resubmit）時に、最初の承認ステップの承認者へ承認依頼メール通知を送信する機能を実装した。#875 で構築した通知基盤（`NotificationService`）をワークフローユースケースに統合。

## 実装内容

### Phase 1: DI 配線

`WorkflowUseCaseImpl` に `Arc<NotificationService>` を注入。`main.rs` の配線を更新し、テストヘルパー `build_sut` にも `MockNotificationSender` を追加。

### Phase 2: submit_workflow 通知統合

`common.rs` に共通ヘルパー `send_approval_request_notification` を追加。トランザクション完了後（`commit_tx` 後）に fire-and-forget パターンで通知を送信。ユーザー情報取得失敗時は `tracing::warn!` でログ出力のみ。

### Phase 3: resubmit_workflow 通知統合

Phase 2 と同じヘルパーを使用して、`resubmit.rs` にも通知送信を追加。

### Phase 4: Mailpit API テスト + FIXME 解消

- `run-api.sh` にルート `.env` から Mailpit UI ポートを読み取り、hurl 変数として渡す機能を追加
- `submit_workflow.hurl` と `resubmit_workflow.hurl` に Mailpit API でメール受信を検証するアサーションを追加
- `template_renderer.rs` の `FIXME(#876)` `#[allow(dead_code)]` を解消

## 設計判断

### ユーザー情報取得タイミング

トランザクション後に取得を採用。トランザクションのスコープを最小に保つため。

### 共通ヘルパーの配置

`common.rs`（submit/resubmit 共通ロジックの既存配置場所）に `send_approval_request_notification` を追加。

### MockUserRepository のステートフル化

ユニットテストで通知のメール宛先を検証するため、`MockUserRepository` を unit struct から `Arc<Mutex<Vec<User>>>` を持つステートフルなモックに変更。

## 変更ファイル

| ファイル | 変更内容 |
|---------|---------|
| `backend/apps/core-service/src/usecase/workflow/command/lifecycle/common.rs` | `send_approval_request_notification` ヘルパー追加 |
| `backend/apps/core-service/src/usecase/workflow/command/lifecycle/submit.rs` | 通知呼び出し + テスト追加 |
| `backend/apps/core-service/src/usecase/workflow/command/lifecycle/resubmit.rs` | 通知呼び出し + テスト追加 |
| `backend/apps/core-service/src/usecase/workflow.rs` | `notification_service` フィールド追加 |
| `backend/apps/core-service/src/usecase/workflow/command.rs` | `build_sut_with_notification` ヘルパー追加 |
| `backend/apps/core-service/src/main.rs` | DI 配線更新 |
| `backend/crates/infra/src/mock.rs` | `MockUserRepository` ステートフル化 |
| `scripts/test/run-api.sh` | `mailpit_url` 変数追加 |
| `tests/api/hurl/workflow/submit_workflow.hurl` | Mailpit メール検証追加 |
| `tests/api/hurl/workflow/resubmit_workflow.hurl` | Mailpit メール検証追加 |
| `backend/apps/core-service/src/usecase/notification/template_renderer.rs` | `FIXME(#876)` 解消 |
