# Rules Check レビュー競合修正

## 概要

Claude Rules Check の `gh pr review --comment` が Auto Review の `gh pr review --approve` を上書きし、`required_approving_review_count: 1` を満たさなくなる問題（#390）を修正した。

## 根本原因

GitHub のレビューシステムは「1著者 = 1レビュー枠」のモデル。Auto Review と Rules Check が同じ `claude[bot]` アカウントでレビューを投稿するため、後に投稿されたレビューが前のレビューを上書きする。

## 設計判断

4つの選択肢を検討し、案4（レビュー不使用）を採用した。

| # | 案 | 判定 | 理由 |
|---|---|---|---|
| 1 | Rules Check を `--approve` に変更 | 却下 | Rules Check の APPROVED が Auto Review の `--request-changes` を上書きするリスク |
| 2 | ワークフロー統合 | 却下 | 責務の混在、大規模な変更 |
| 3 | 別 GitHub App アカウント | 却下 | セットアップコスト |
| **4** | **Rules Check をレビュー不使用に変更** | **採用** | 設計意図（承認権限の Auto Review 一元化）を維持。Status API による独立したブロック機能を活用 |

採用の決め手: ブランチ保護に **レビュー承認** と **Status API** の2つの独立した機構があり、Rules Check は Status API のみに責任を持てばよいと判断。

## 実施内容

1. プロンプトのフィードバック方法を `gh pr review` → `gh pr comment` に変更
2. `--allowedTools` から `Bash(gh pr review:*)` を除去
3. 結果判定ロジックをレビュー状態チェックからコメントマーカー（`<!-- rules-check-result:pass/fail -->`）のパースに変更

## 成果物

### コミット

- `#390 Fix Rules Check overriding Auto Review approval by using PR comments`

### 作成・更新ファイル

| ファイル | 操作 |
|---------|------|
| `.github/workflows/claude-rules-check.yaml` | 修正 |
| `docs/80_ナレッジベース/devtools/GitHubActions.md` | 更新（レビューシステムの制約セクション追加） |
