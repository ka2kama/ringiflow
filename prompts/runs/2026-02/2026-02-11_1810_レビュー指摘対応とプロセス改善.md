# レビュー指摘対応とプロセス改善

## 概要

PR #426（Phase 2-2 テナント管理）の Claude Auto Review 指摘を対応し、テスト追加漏れからプロセスギャップを特定・記録した。

## 実施内容

### レビュー指摘対応

Claude Auto Review から 2 件の指摘を受けて修正した。

1. Core Service `get_role` ハンドラのテナント分離（Medium）
   - `tenant_id` クエリパラメータを追加
   - システムロールは全テナントからアクセス可能、テナントロールは所属テナントのみアクセス可能
   - Core Service client、BFF ハンドラ、テスト mock を連動して更新
2. Elm `confirmAction` のクリアタイミング（Low）
   - `ConfirmStatusChange` 時点でクリアしていたため、非同期 API レスポンス受信時に `Nothing` になっていた
   - `GotStatusChangeResult` の成功・失敗両ブランチでクリアするよう修正

### テスト追加

`get_role` ハンドラのテナント分離に対するハンドラテストを 3 件追加した。

- システムロールは任意のテナントでアクセス可能
- テナントロールは所属テナントでアクセス可能
- テナントロールは他テナントで 404

### 改善記録作成

2 件の改善記録を作成した。

1. Issue 完了条件のドキュメント要件欠如（→ Issue #446）
2. テストリストがユニットテスト層のみをカバー（→ Issue #448）
   - テスト層の検討タイミングを「テストリスト作成時」から「計画ファイル作成時（設計段階）」に修正

## 判断ログ

- テスト層の検討タイミングについて、当初「テストリスト作成時」で提案したが、テスト層の選択は設計判断であり「計画ファイル作成時（設計段階）」が適切と修正した
- `get_role` のテナント分離は `list_roles` と同じパターン（`tenant_id` クエリパラメータ）を採用した

## 成果物

### コミット

| コミット | 内容 |
|---------|------|
| `ae26286` | 改善記録: Issue 完了条件のドキュメント要件欠如 |
| `1b04177` | `get_role` テナント分離修正、`confirmAction` タイミング修正 |
| `bf9ded2` | `get_role` テナント分離のハンドラテスト追加 |
| `33ad5c0` | 改善記録: テストリストがユニットテスト層のみをカバー |
| `435290d` | 改善記録修正: テスト層検討タイミングを設計段階に変更 |

### 作成・更新ファイル

- `prompts/improvements/2026-02/2026-02-11_1731_Issue完了条件のドキュメント要件欠如.md`（新規）
- `prompts/improvements/2026-02/2026-02-11_1731_テストリストがユニットテスト層のみをカバー.md`（新規・更新）
- `backend/apps/core-service/src/handler/role.rs`（テナント分離修正 + テスト追加）
- `backend/apps/bff/src/client/core_service/role_client.rs`（`tenant_id` パラメータ追加）
- `backend/apps/bff/src/handler/role.rs`（`tenant_id` 受け渡し）
- `backend/apps/bff/tests/auth_integration_test.rs`（mock 更新）
- `frontend/src/Page/User/Detail.elm`（`confirmAction` タイミング修正）

## 議論の経緯

- レビュー指摘の修正後、テストの追加漏れを指摘された
- 原因を分析したところ、テストリスト作成ガイダンスがユニットテスト層のみをカバーしている構造的問題を特定した
- 対策として「テストリスト作成時にテスト層を検討する」を提案したが、テスト層の選択は設計判断であるため「計画ファイル作成時（設計段階）」に検討すべきと修正した
