# ADT ベース状態マシンパターンの標準化

## 概要

#793（ワークフローデザイナーの初期ドラッグ不可バグ）の根本原因分析から、ADT ベース状態マシンをプロジェクト標準パターンとして採用し（ADR-054）、設計〜レビューの各段階に強制の仕組みを組み込んだ。

## 実施内容

### 1. 根本原因分析

#793 の直接原因（`init` で Loading 中に `requestCanvasBounds` を発行）の背後にある構造的原因を分析した。

- フラットな Model（約 25 フィールド）に `loadState: RemoteData` とキャンバス関連フィールドが混在
- Loading 状態でキャンバス関連フィールドが「存在するが無意味」な不正状態が表現可能
- `Maybe Bounds` が「非同期取得中」と「この状態では存在しない」の 2 つの意味を混同

### 2. ADR-054 作成

ADT ベース状態マシンをプロジェクト標準として採用する ADR を作成した。

- 選択肢: 規約ベース / ADT 状態マシン / Opaque Module
- 決定: ADT 状態マシンを標準、規約ベースを補助として併用
- ADR-016（Newtype）、ADR-051（TxContext）に続く「型による構造的強制」の系譜として位置づけ

### 3. 強制の仕組み（4 層）

ADR を書いただけではルールが守られない（ADR-051 の教訓）ため、プロセスの各段階にゲートを設置した。

| # | タイミング | 変更箇所 | 追加内容 |
|---|-----------|---------|---------|
| 1 | 設計時 | `zoom-rhythm.md` | 「状態網羅漏れ」を view + Cmd に拡張、「状態依存フィールド」観点を新設 |
| 2 | 実装前 | `pre-implementation.md` | 「型定義時の ADT 状態マシン判定」セクション追加 |
| 3 | TDD Refactor | `02_TDD開発フロー.md` | 設計原則レンズ「型の活用」に ADR-054 を追加 |
| 4 | レビュー | `claude-auto-review.yaml` | 型チェック観点に ADR-054 を明示 |

### 4. Issue 整理

| Issue | 内容 |
|-------|------|
| #795 | 方針コメント追加（型対策 + ギャップ観点の 2 段構え） |
| #796 | Designer.elm リファクタリング（新規起票） |
| #797 | 適用箇所の調査（新規起票） |

## 判断ログ

- ADT 状態マシン vs Opaque Module: Opaque Module は 1 つの Port コマンドに対して過剰。将来 Port が増えたら個別に検討
- 強制ポイントを 4 層にした: 「TDD Refactor の設計原則レンズにも必要」という指摘を受けて追加。設計時（計画段階）とレビュー（事後）の間にギャップがあった

## 成果物

### コミット

- `#795 Add ADR-054 and enforce ADT state machine pattern`

### 作成・更新ファイル

- `docs/05_ADR/054_ADTベース状態マシンパターンの標準化.md`（新規）
- `.claude/rules/zoom-rhythm.md`（更新）
- `.claude/rules/pre-implementation.md`（更新）
- `docs/04_手順書/04_開発フロー/02_TDD開発フロー.md`（更新）
- `.github/workflows/claude-auto-review.yaml`（更新）

### Issue

- #796: Designer.elm の Model を ADT ベース状態マシンにリファクタリングする
- #797: ADT ベース状態マシン適用箇所の調査

### PR

- #798: `docs/795-adt-state-machine-enforcement`

## 議論の経緯

1. #793 と #795 の再発防止について議論を開始
2. 根本原因分析で「フラット Model の構造的問題」を特定
3. 型システムでの強制可能性を検討 → 状態マシンパターン（アプローチ A）で落としどころ
4. ADT 状態マシンをプロジェクト全体の標準にする方針を合意（フロントエンド・バックエンド共通）
5. ADR-054 作成、関連 Issue 起票
6. 強制の仕組みについて: 設計時・実装前・レビュー時の 3 層 → TDD Refactor も必要という指摘で 4 層に拡張
