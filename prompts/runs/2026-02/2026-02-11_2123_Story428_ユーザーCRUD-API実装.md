# Story #428: ユーザー CRUD API 実装

## 概要

Issue #403 Phase 2-2 の Story #428 として、テナント管理者向けユーザー CRUD API を全5レイヤーにわたって実装した。Domain Model から BFF Handler まで、計画ファイルに基づいて5 Phase を完了。

## 実施内容

### Phase 1: Domain Model 拡張

- `User::with_name()` メソッドを追加（名前変更 + `updated_at` 更新）
- 既存の `with_status()` と同じパターンを踏襲
- TDD でテスト作成 → 実装

### Phase 2: Repository 拡張

`UserRepository` トレイトに10個のメソッドを追加:

- `insert`, `update`, `update_status`: ユーザー CRUD
- `find_by_display_number`, `find_all_by_tenant`: 検索
- `insert_user_role`, `replace_user_roles`: ロール操作
- `find_role_by_name`: ロール検索
- `count_active_users_with_role`: 最後の管理者保護用カウント
- `find_roles_for_users`: N+1 問題回避のバッチクエリ

統合テスト 14 件を `user_repository_test.rs` に追加。`just sqlx-prepare` でキャッシュ更新。

### Phase 3: Core Service ユーザー CRUD

- `UserUseCaseImpl` を新規作成（`create_user`, `update_user`, `update_user_status`）
- 自己無効化防止チェック（`requester_id == user_id`）
- 最後のテナント管理者保護（`count_active_users_with_role`）
- `UserState` に `usecase` フィールドを追加
- 4つのハンドラを追加: `create_user`, `get_user_by_display_number`, `update_user`, `update_user_status`
- `list_users` をステータスフィルタ対応に拡張
- `UserItemDto` にステータス・ロール情報を追加（`find_roles_for_users` でバッチ取得）

### Phase 4: BFF Client 拡張

- `CoreServiceUserClient` に4メソッド追加、`list_users` のシグネチャ拡張（`status` パラメータ）
- `AuthServiceClient` に `create_credentials` メソッド追加
- `CoreServiceError` に `EmailAlreadyExists` バリアント追加（409 対応）
- `AuthServiceError` に `BadRequest` バリアント追加
- テストスタブ更新（BFF ハンドラテスト + 統合テスト）

### Phase 5: BFF Handler + Router

- 新しい `UserState`（`core_service_client` + `auth_service_client` + `session_manager`）
- 5つのハンドラ: `list_users`, `create_user`, `get_user_detail`, `update_user`, `update_user_status`
- `generate_initial_password()`: 16文字のランダムパスワード生成（`rand` クレート使用）
- `create_user` フロー: 初期パスワード生成 → Core Service 作成 → Auth Service 認証情報作成
- 権限別ルートグループ: `user:read`（GET）、`user:create`（POST）、`user:update`（PATCH）
- `display_number` → UUID 解決を BFF 側で実施（`get_user_by_display_number`）

## 判断ログ

- Phase 3: `find_roles_for_users` バッチクエリで N+1 問題を回避。ユーザー一覧でロール情報を取得する際、個別の `find_with_roles` ではなく一括 JOIN を採用
- Phase 5: 権限別ルートグループ設計。axum の `merge` + `layer` で GET/POST/PATCH に異なる認可ミドルウェアを適用。将来のカスタムロール対応を見据えた柔軟な構造
- Phase 5: パスワード生成を BFF に配置。BFF は Auth Service と Core Service の両方を知るオーケストレーターであり、平文パスワードの生成は BFF の責務
- Phase 5: `update_user` / `update_user_status` で `display_number` → UUID 解決を BFF 側で実施。Core Service の更新 API は UUID ベースを維持

## 成果物

### コミット

1. `d8b4f80` — Implement User CRUD API in Domain, Repository, and Core Service（Phase 1-3）
2. `66a38fd` — Extend BFF clients for User CRUD operations（Phase 4）
3. `65c128c` — Implement BFF user CRUD handlers with permission-based routing（Phase 5）

### 主な変更ファイル

| レイヤー | ファイル | 変更内容 |
|---------|---------|---------|
| Domain | `domain/src/user.rs` | `with_name()` メソッド追加 |
| Repository | `infra/src/repository/user_repository.rs` | 10メソッド追加 |
| Repository Test | `infra/tests/user_repository_test.rs` | 14テスト追加 |
| Core Usecase | `core-service/src/usecase/user.rs` | 新規作成 |
| Core Handler | `core-service/src/handler/auth.rs` | 4ハンドラ + 型追加 |
| Core Router | `core-service/src/main.rs` | ルート追加 |
| BFF Client | `bff/src/client/core_service/user_client.rs` | 4メソッド追加 |
| BFF Client | `bff/src/client/auth_service.rs` | `create_credentials` 追加 |
| BFF Handler | `bff/src/handler/user.rs` | 5ハンドラ + UserState |
| BFF Router | `bff/src/main.rs` | 権限別ルートグループ |

### テスト結果

- ユニットテスト: 221 件全パス（`just check`）
- API テスト: 18 ファイル、83 リクエスト、100% 成功（`just test-api`）
