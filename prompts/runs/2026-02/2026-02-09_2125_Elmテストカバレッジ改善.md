# Elm テストカバレッジ改善

## 概要

Issue #331 に基づき、Elm フロントエンドのテストカバレッジを戦略的に改善した。elm-coverage 採用見送りの ADR を作成し、優先度「高」の JSON デコーダテスト・エンコーダテスト・Page update ロジックテストを追加した。合計 35 テストを追加（183 → 218）。

## 背景と目的

バックエンドのテストカバレッジ改善（#291）は完了していたが、フロントエンド（Elm）のテスト戦略が未検討だった。ソース 35 ファイル中 12 ファイルのみテスト済みで、特に外部境界（JSON デコーダ）とビジネスロジック（Page update）のテストが不足していた。

## 実施内容

### Phase 1: ADR-037 elm-coverage 採用見送り

elm-coverage を調査し、以下の理由から採用見送りを ADR に記録した:

- 4年間メンテナンスなし（最終コミット 2022年1月）
- elm-test revision17 との互換性未検証（revision7 までのサポート）
- LCOV 出力非対応（CI 統合困難）
- 代替ツールなし

### Phase 2: Data モジュールのデコーダテスト

- `Data.TaskTest`: 9 テスト（WorkflowSummary 3, TaskItem 3, listDecoder 2, detailDecoder 1）
- `Data.DashboardTest`: 2 テスト
- `Data.UserRefTest`: 2 テスト

### Phase 3: Api モジュールのデコーダ/エンコーダテスト

- `Api.AuthTest`: 6 テスト（csrfTokenDecoder 3, userDecoder 3）
- `Api.WorkflowTest`: 4 テスト（encodeCreateRequest 1, encodeSubmitRequest 1, encodeApproveRejectRequest 2）

エンコーダテストはプロジェクト初の試みで、エンコード → JSON 文字列化 → デコードの往復検証方式を採用した。

### Phase 4: Page.Workflow.New update テスト

- SaveDraft バリデーション: 3 テスト
- Submit バリデーション: 2 テスト
- 承認者キーボード操作: 4 テスト（ArrowDown, ArrowUp 循環, Enter 選択, Escape 閉じる）
- Dirty 状態管理: 3 テスト

Page update テストもプロジェクト初。`init` で初期 Model を取得し、`update` にメッセージを送って結果の Model を検証するアプローチを確立した。

## 設計上の判断

### テスト対象の exposing 拡張

内部関数をテストするため、一部モジュールの `exposing` を拡張した。Elm コミュニティでは一般的なプラクティスであり、Internal モジュール分離やコード再構成は過剰と判断。

対象: `Data.Task`, `Api.Auth`, `Api.Workflow`, `Page.Workflow.New`

### エンコーダテスト方式

エンコード → `Encode.encode 0` → `Decode.decodeString` で往復検証する方式を採用。JSON 文字列比較はフィールド順序に依存して脆いため不採用。

### テスト対象の選定

Api モジュールの大半（Dashboard, Task, User, WorkflowDefinition）は Data モジュールのデコーダを呼ぶだけのパススルーのため、テスト対象外とした。Api.Auth と Api.Workflow のみ独自のデコード/エンコードロジックを持つ。

## 判断ログ

特筆すべき判断なし。

## 成果物

### コミット

- `632cfa2` #331 Add ADR-037: Decide not to adopt elm-coverage
- `f9e739e` #331 Add decoder tests for Data.Task, Data.Dashboard, Data.UserRef
- `f787a65` #331 Add decoder/encoder tests for Api.Auth and Api.Workflow
- `243ec6e` #331 Add update logic tests for Page.Workflow.New
- `7224cc5` #331 Add implementation plan for Elm test coverage

### 作成ファイル

- `docs/05_ADR/037_Elmコードカバレッジツール選定.md`
- `frontend/tests/Data/TaskTest.elm` (9 テスト)
- `frontend/tests/Data/DashboardTest.elm` (2 テスト)
- `frontend/tests/Data/UserRefTest.elm` (2 テスト)
- `frontend/tests/Api/AuthTest.elm` (6 テスト)
- `frontend/tests/Api/WorkflowTest.elm` (4 テスト)
- `frontend/tests/Page/Workflow/NewTest.elm` (12 テスト)
- `prompts/plans/331_elm-test-coverage.md`

### 更新ファイル

- `frontend/src/Data/Task.elm` — exposing 拡張
- `frontend/src/Api/Auth.elm` — exposing 拡張
- `frontend/src/Api/Workflow.elm` — exposing 拡張
- `frontend/src/Page/Workflow/New.elm` — exposing 拡張

## 議論の経緯

ユーザーは `/resume` で作業を再開し、計画承認後は全 Phase をスムーズに実装した。技術的な議論は計画フェーズで完結しており、実装フェーズでは特別な議論は発生しなかった。

## 学んだこと

1. Elm のエンコーダテストは往復検証（encode → decode）が効果的。JSON 文字列比較よりも堅牢
2. Page update テストは `init` → `update` → Model 検証のパターンで、Cmd を無視して純粋な状態遷移を検証できる
3. Elm の型別名（type alias）は exposing すると内部フィールドにアクセス可能。テストでのレコード更新構文が使える

## 次のステップ

- PR #343 のレビュー対応
- Issue #331 のクローズ（PR マージ時に自動）
