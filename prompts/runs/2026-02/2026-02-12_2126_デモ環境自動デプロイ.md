# デモ環境自動デプロイ

## 概要

Lightsail デモ環境への自動デプロイを GitHub Actions で実現した。main ブランチへのマージ時に、GHCR にイメージをプッシュし、SSH 経由で Lightsail にデプロイする。

## 実施内容

### GitHub Actions ワークフロー作成

`.github/workflows/deploy-demo.yaml` を新規作成:

- トリガー: `push` to `main` + `workflow_dispatch`（手動実行）
- `docker/build-push-action` でバックエンド・フロントエンドイメージを GHCR にビルド・プッシュ
- GitHub Actions Cache で Docker レイヤーキャッシュ（cargo-chef のレイヤー分離が効く）
- SSH 経由で Lightsail にデプロイ（設定ファイル転送 + イメージ pull + サービス再起動）

### docker-compose.yaml のイメージ参照更新

`image: ringiflow-backend:latest` → `image: ghcr.io/ka2kama/ringiflow/backend:latest` に変更（3サービス分）。

### deploy.sh の互換性維持

手動デプロイスクリプトのイメージ名も GHCR パスに統一。`BACKEND_IMAGE` / `FRONTEND_IMAGE` 変数を導入し、タグ名の重複を排除。

### ナレッジベース更新

`docs/80_ナレッジベース/devtools/GitHubActions.md` に docker/* アクションの許可設定を追記。

## 判断ログ

- GHCR 方式を採用: レジストリ経由のイメージ配布は差分レイヤーのみ転送で効率的。SCP 方式（毎回フルイメージ転送）より適切
- tar over SSH で設定ファイルを転送: SCP の IPv6 アドレス角括弧問題を回避
- フロントエンド dist のコピー: frontend イメージ（busybox ベース）を直接 `docker run` してボリュームにコピー。deploy.sh の中間ステップ（ホストに展開→ボリュームにコピー）を省略

## 成果物

### コミット

- `5c529f0` Add automated demo deployment via GitHub Actions

### 作成・更新ファイル

| ファイル | 種別 |
|---------|------|
| `.github/workflows/deploy-demo.yaml` | 新規 |
| `infra/lightsail/docker-compose.yaml` | 更新 |
| `infra/lightsail/deploy.sh` | 更新 |
| `docs/80_ナレッジベース/devtools/GitHubActions.md` | 更新 |

### PR

- [#489](https://github.com/ka2kama/ringiflow/pull/489) Add automated demo deployment via GitHub Actions（Draft）
