# 固定テンプレート新スキーマ移行

関連: #727, PR #758

## 概要

Epic #405（ワークフローデザイナー）の最終 Story。既存シードデータ（固定テンプレート）に `position` フィールドを追加するマイグレーションを作成し、デザイナー形式の定義で申請→承認フローが動作することを E2E テストで検証した。

## 実施内容

### Phase 1: シードデータマイグレーション

- `20260221000001_add_position_to_seed_definitions.sql` を作成
- 汎用申請（4 ステップ）と 2 段階承認申請（5 ステップ）の全 step に `position` を追加
- JSON 全体置換方式を採用（`jsonb_set` では配列内全要素への追加が困難なため）

### Phase 2: E2E テスト

- `designer-workflow-flow.spec.ts` を作成
- API アシスト型テスト: 定義作成・公開を `page.request` で、申請・承認を UI で操作
- CSRF トークン取得が必要（`page.request` は Elm フロントエンドのヘッダー自動付与をバイパスするため）
- トラブルシューティング: `VersionMissing` → CSRF 403 → フィールド名の 3 段階で解決（→ [調査記録](../../../process/investigations/2026-02/2026-02-21_2125_E2EテストCSRFトークン取得失敗.md)）

### Phase 3: ドキュメント更新

- E2E テスト突合表の E2E-010 行を更新（「部分カバー」に変更）

## 判断ログ

- `sqlx::migrate!()` マクロのコンパイル時埋め込み: 新マイグレーション追加後に `touch db.rs` で再コンパイルを強制する必要があった
- CSRF トークン取得パターン: `page.request` を使う API 呼び出しでは CSRF トークンを明示的に取得・設定する必要がある。このパターンは今後の E2E テストでも再利用される

## 成果物

### コミット

1. `202d705` — #727 WIP: Migrate fixed templates to new schema
2. `410ccca` — #727 Add position to seed definitions and E2E test for designer workflow

### 作成/更新ファイル

| ファイル | 種別 |
|---------|------|
| `backend/migrations/20260221000001_add_position_to_seed_definitions.sql` | 新規 |
| `tests/e2e/tests/designer-workflow-flow.spec.ts` | 新規 |
| `docs/08_テスト/E2Eテスト突合表.md` | 更新 |
| `prompts/plans/727_migrate-fixed-templates.md` | 新規（計画ファイル） |
