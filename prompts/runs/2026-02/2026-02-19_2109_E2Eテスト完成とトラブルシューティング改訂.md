# E2E テスト完成とトラブルシューティングフレームワーク改訂

Issue: #713（Phase 2-3 E2E テスト）
PR: #717
ブランチ: `feature/713-e2e-multi-step-approval`

## 概要

#713 の E2E テスト実装を完了した。前セッションから引き継いだ 2 件の失敗テストを修正し、全 12 件の E2E テストが通過する状態にした。デバッグ過程で散弾銃デバッグの問題が顕在化し、トラブルシューティングフレームワークを全面改訂した。

## 実施内容

### 1. buildApprovers 順序バグの修正

2 段階承認テストで承認者の順序が入れ替わる問題を修正。`Dict.toList` が AVL tree のアルファベット順で返すため、定義のステップ順序と異なっていた。`WorkflowDefinition.approvalStepInfos` を使用して定義順序を保持するよう変更。

### 2. WorkflowDefinition デコーダバグの発見と修正

差し戻しテスト（E2E-006）の失敗原因を系統的に調査。API は 200 を返しているが、Elm 側でデコード失敗していた。

根本原因: `WorkflowDefinition.decoder` に `Decode.field "data"` ラッパーが欠落。API レスポンス `{"data": {...}}` に対してルートレベルの `"id"` を探すためデコード失敗。`Detail.elm` が `Failure` 時に `viewRawFormData`（生データ表示）にフォールバックするため、バグが隠蔽されていた。

修正: `detailDecoder = Decode.field "data" decoder` を `Data.WorkflowDefinition` に追加。

### 3. トラブルシューティングフレームワーク改訂

散弾銃デバッグの問題を受け、`troubleshooting.md` を全面改訂:

- 8 ステップの調査フロー（Reproduce → Observe → Hypothesize → Verify → Isolate → Identify → Fix → Verify）
- 仮説追跡を成果物要件化（修正前に検証結果の記録を必須とするゲート）
- 散弾銃デバッグの判定基準と防止策
- 問題空間の切り分け手法（レイヤー分離、二分探索）

### 4. デコーダ命名規約の追加

`frontend.md` に API レスポンスデコーダの命名規約を追加。`"data"` ラッパーのデコード責務は Data モジュール側に集約する規約。既存の不整合修正は Issue #718 で追跡。

### 5. 改善記録の作成

「散弾銃デバッグによるトラブルシューティング効率低下」の改善記録を作成。散弾銃デバッグと系統的アプローチの対比を記録。

## 判断ログ

- デコーダバグの調査で系統的トラブルシューティングを適用: `page.on("response")` で API 正常を確認 → デコーダ層に絞り込み → ページスナップショットで `viewRawFormData`（Failure フォールバック）を発見 → 根本原因特定
- デコーダ命名規約の配置先: ADR ではなく `frontend.md` のルールセクションに追加。既存コードの不整合修正は別 Issue (#718) に分離
- `detailDecoder` の命名: 既存の `listDecoder` と対称性を保つ命名を採用

## 成果物

### コミット

| コミット | 内容 |
|---------|------|
| `a4bfacc` | E2E テストインフラ拡張（マルチユーザー認証、共通ヘルパー） |
| `e220155` | 2 段階承認 E2E テスト (E2E-004) |
| `b2e1641` | 却下フロー E2E テスト (E2E-005) |
| `d0cdc68` | 差し戻し→再申請フロー E2E テスト (E2E-006) |
| `41d71cf` | E2E テスト突合表更新 |
| `5f34529` | E2E テストロケーター修正・非同期読み込み待機改善 |
| `8376639` | WorkflowDefinition デコーダ・buildApprovers 順序バグ修正 |
| `f2fc7bd` | トラブルシューティングフレームワーク改訂・改善記録 |
| `c67ad14` | デコーダ命名規約追加 |

### 作成・更新ファイル

- `frontend/src/Data/WorkflowDefinition.elm` — `detailDecoder` 追加
- `frontend/src/Api/WorkflowDefinition.elm` — `detailDecoder` 使用に変更
- `frontend/src/Page/Workflow/New.elm` — `buildApprovers` 順序修正
- `.claude/rules/troubleshooting.md` — 系統的トラブルシューティングに全面改訂
- `.claude/rules/frontend.md` — デコーダ命名規約追加
- `tests/e2e/tests/approval.spec.ts` — ヘルパー移行・2 段階承認テスト追加
- `tests/e2e/tests/rejection.spec.ts` — 却下フロー E2E テスト（新規）
- `tests/e2e/tests/request-changes.spec.ts` — 差し戻し→再申請 E2E テスト（新規）
- `tests/e2e/helpers/workflow.ts` — 共通ワークフローヘルパー（新規）
- `process/improvements/2026-02/2026-02-20_0012_散弾銃デバッグによるトラブルシューティング効率低下.md` — 改善記録（新規）

## 議論の経緯

### 散弾銃デバッグの問題提起

差し戻しテストのデバッグで推測ベースの修正を繰り返していたことへの指摘を受けた。auto compaction を含む複数セッションにわたり散弾銃デバッグが継続していた。

この指摘を受け、トラブルシューティングのベストプラクティスを調査し（David Agans の 9 ルール、科学的方法、Reproduce → Isolate → Identify → Fix → Verify）、改善記録と troubleshooting.md の改訂を実施した。

改訂した troubleshooting.md を直後に適用し、仮説検証 3 回・修正 1 回で根本原因を特定できた。散弾銃デバッグ（2+ セッション、4+ 回の失敗修正）との対比が明確になった。

### デコーダバグの予防策

同種のバグを防ぐため、「ルール + Issue」アプローチを採用。`frontend.md` にデコーダ命名規約を追加し、既存の不整合（`Api/Workflow.elm` のインライン `Decode.field "data"` 使用 9 箇所）は Issue #718 で追跡する方針を合意。
