# Phase 2-5 通知・ドキュメント管理設計

Issue: #846
PR: #872
ブランチ: `feature/846-phase-2-5-design`

## 概要

Phase 2-5（通知 + ドキュメント管理）の機能仕様書・詳細設計書を作成し、Epic/Story Issue で実装への道筋を確立した。コード実装は含まない設計専任のセッション。

主要な技術要素: AWS SES（メール通知）、AWS S3 Presigned URL（ドキュメント管理）

## 実施内容

### Phase 1: 機能仕様書の作成

- `docs/20_機能仕様書/05_通知機能.md` 新規作成
  - 5 通知イベント（承認依頼、ステップ承認、承認完了、却下、差し戻し）
  - 4 シナリオ（承認者/申請者の視点）
  - Phase 2-5 では通知設定画面なし（メール送信のみ）
- `docs/20_機能仕様書/06_ドキュメント管理.md` 新規作成
  - ファイルアップロード（対応形式、20MB/件、100MB/申請）
  - フォルダ管理（最大 5 階層）
  - 品質検証で S3 実装詳細の混入を検出・修正（「S3」→「ストレージ」）
- `docs/20_機能仕様書/00_はじめに.md` 読む順序に追加

### Phase 2: 詳細設計書の作成（通知機能）

- `docs/40_詳細設計書/16_通知機能設計.md` 新規作成
  - NotificationSender trait（Clock trait パターン準拠）
  - WorkflowNotification enum（5 バリアント）
  - notification_logs テーブル（PostgreSQL, RLS, CASCADE）
  - ユースケース統合ポイント: approve_step, reject_step, request_changes, submit_workflow の呼び出し後
  - Mailpit Docker Compose 設定

### Phase 3: 詳細設計書の作成（ドキュメント管理）

- `docs/40_詳細設計書/17_ドキュメント管理設計.md` 新規作成
  - Presigned URL 3 ステップフロー（URL 発行 → ブラウザ直接 PUT → 確認）
  - documents / folders テーブル（materialized path, depth CHECK <= 5）
  - S3 パス設計: `{tenant_id}/workflows/{instance_id}/{document_id}_{filename}`
  - 10 API エンドポイント
  - MinIO Docker Compose 設定
  - ワークフロー定義スキーマ拡張（file フィールド型）

### Phase 4: Epic/Story Issue 作成

- Epic #406 を 12 Story で更新
  - 通知機能: #875（基盤）, #876（承認依頼）, #877（完了/却下/差し戻し）, #878（ログ）, #879（SES）
  - ドキュメント管理: #880（S3 基盤）, #881（アップロード）, #882（ダウンロード/削除）, #883（フォルダ）, #884（申請添付）, #885（フロントエンド）, #886（退会削除+Terraform）
- テスト責任マッピングを Epic 本文に記載

## 判断ログ

10 件の設計判断を詳細設計書に記録:

1. SES 直接 API 呼び出し（同期）— テナント 10 社規模で十分、trait 抽象化で Phase 3 Outbox 移行可能
2. アプリ側テンプレート（tera）— コードでバージョン管理完結
3. ドメインイベント型 + ユースケース呼び出し — Phase 3 イベント駆動移行の基盤
4. Mailpit — MailHog メンテナンス停滞の後継
5. Presigned URL — サーバー負荷軽減、AWS ベストプラクティス
6. 単一 S3 バケット + テナントプレフィックス — テナント退会削除設計準拠
7. PostgreSQL materialized path — S3 はフラットストレージ、DB で階層管理
8. MinIO — 最も広く使われる S3 互換
9. elm/file + Http.request — Ports 不要、Elm 標準機能
10. PostgreSQL notification_logs — DynamoDB notifications は Phase 3 アプリ内通知用（PK: user_id で送信ログに不適）

- 品質検証で機能仕様書の S3 実装詳細混入を検出・修正

## 成果物

### コミット

- `#846 WIP: Design Phase 2-5 (Notifications + Document Management)` — 空コミット（Draft PR 用）
- `#846 Add Phase 2-5 feature specs and detailed designs` — 設計ドキュメント 5 ファイル

### 作成・更新ファイル

| ファイル | 操作 |
|---------|------|
| `docs/20_機能仕様書/00_はじめに.md` | 更新 |
| `docs/20_機能仕様書/05_通知機能.md` | 新規 |
| `docs/20_機能仕様書/06_ドキュメント管理.md` | 新規 |
| `docs/40_詳細設計書/16_通知機能設計.md` | 新規 |
| `docs/40_詳細設計書/17_ドキュメント管理設計.md` | 新規 |
| `prompts/plans/sorted-singing-whisper.md` | 新規（計画ファイル） |

### GitHub Issues

- Epic #406 更新
- Story: #875, #876, #877, #878, #879, #880, #881, #882, #883, #884, #885, #886
