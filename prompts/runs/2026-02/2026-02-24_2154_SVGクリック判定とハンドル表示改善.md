# 2026-02-24 SVG クリック判定とハンドル表示改善

## Issue

#907: ワークフローデザイナー: 接続線の始点・終点をドラッグで付け替え可能にする

## 概要

前回セッションで実装した接続線の端点ドラッグ付け替え機能に対して、SVG 接続線のクリック判定の不具合修正と、再接続ハンドルの視認性改善を行った。

## 実施内容

### 1. SVG 接続線のクリック判定修正

接続線をクリックしても選択できない問題を調査・修正した。

- `Svg.Events.onClick` → `Html.Events.stopPropagationOn "click"` に変更（イベント伝播の制御）
- `opacity="0"` → `stroke="transparent"` に変更（`opacity="0"` はブラウザのヒットテストから除外される）
- `pointer-events: stroke` → `pointer-events: all` に変更（透明ストロークでも確実にクリックを受け取る）

### 2. E2E テストによる検証

Playwright で SVG 接続線のクリック動作を検証するデバッグテストを作成した。

- `elementsFromPoint` で座標上の要素を列挙し、パス要素の有無を確認
- `getScreenCTM()` による正確な SVG 座標変換の必要性を発見（`preserveAspectRatio="xMidYMid meet"` による Y 軸 16px オフセット）
- 検証完了後、デバッグテストは削除

### 3. 再接続ハンドルの表示改善

選択した接続線のドラッグハンドルが見えない問題を修正した。

- 原因: SVG のレンダリング順序（DOM 順 = z-order）により、ハンドルがステップノードの下に隠れていた
- 対策: `viewReconnectionHandleLayer` を独立した SVG レイヤーとして `viewSteps` の後に配置
- ハンドルの視認性向上: 半径 6px → 10px、drop-shadow グロー効果を追加

## 判断ログ

- Refactor: ハンドル描画を `viewTransitionLine` から `viewReconnectionHandleLayer` に分離し、SVG レイヤー順序を明確化した
- Refactor: `viewReconnectionHandles` を `let ... in` ブロックでリファクタリングし、`handleAttrs` ヘルパーで SourceEnd / TargetEnd のコード重複を排除した

## 成果物

### コミット

| コミット | 内容 |
|---------|------|
| `67afd718` | `stopPropagationOn "click"` でイベント伝播を制御 |
| `272320d0` | `pointer-events` 属性を明示的に設定 |
| `c63f8c90` | `pointer-events="all"` で透明ストロークのクリック判定を修正 |
| `cf29998c` | ハンドルをステップノードの上に描画 + 視認性向上 |

### 作成/更新ファイル

| ファイル | 内容 |
|---------|------|
| `frontend/src/Page/WorkflowDefinition/Designer.elm` | クリック判定修正 + ハンドルレイヤー分離 |

### 関連ドキュメント

- 前回セッションログ: [接続線端点のドラッグ付け替え](2026-02-24_2126_接続線端点ドラッグ付け替え.md)
- 調査記録: [SVG 接続線クリックのヒットテスト失敗](../../../process/investigations/2026-02/2026-02-24_2154_SVG接続線クリックのヒットテスト失敗.md)
- ナレッジベース: [SVG ポインターイベントとヒットテスト](../../../docs/06_ナレッジベース/frontend/SVGポインターイベントとヒットテスト.md)

## 議論の経緯

- E2E テストでの検証を試みた際、SVG の `preserveAspectRatio` による座標オフセットを発見。`getScreenCTM()` を使うことで正確な座標変換が可能になった
- ハンドルが見えないとの指摘に対し、SVG の z-order（DOM 順序）問題を特定。レイヤー分離とハンドルサイズ拡大で対応した
