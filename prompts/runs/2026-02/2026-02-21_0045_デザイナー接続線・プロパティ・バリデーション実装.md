# デザイナー接続線・プロパティ・バリデーション実装

Issue: #726

## 概要

ワークフローデザイナーの接続線描画、プロパティパネル、API 統合、バリデーション・公開機能を実装した。5 Phase の計画のうち Phase 1〜5 を完了（Phase 1〜3 は前セッションから継続、Phase 4〜5 を本セッションで実装）。

## 実施内容

### Phase 4: API 統合

- `Designer.init` を 2 引数（`Shared`, `definitionId`）に変更し、初期化時に API から定義をロード
- `Main.elm` に `WorkflowDefinitionDesignerEdit` ルートの `initPage` ケースを追加
- `isCurrentPageDirty` に `DesignerPage` ケースを追加
- `RemoteData` パターンで Loading/Failure/Success の 3 状態を view で処理
- ツールバーに定義名入力と保存ボタンを配置
- `MessageAlert.view` で保存成功/失敗メッセージを表示
- `List.elm` に Draft 定義への「編集」リンクを追加
- `DirtyState.markDirty` を Delete/Backspace キーイベントに追加
- DesignerTest に API 統合テスト 8 件を追加

### Phase 5: バリデーション・公開

- Model に `validationResult`, `isValidating`, `isPublishing`, `pendingPublish` フィールドを追加
- 検証ボタン: `ValidateClicked` → API 呼び出し → `GotValidationResult` で結果表示
- 公開チェーン: `PublishClicked` → 確認ダイアログ → `ConfirmPublish` → dirty なら保存 → バリデーション → 成功時に公開 API 呼び出し
- `pendingPublish` フラグで複数 Msg にまたがる非同期チェーンを管理
- バリデーション結果パネル（有効: 緑、無効: エラー一覧）
- エラーステップの赤枠ハイライト（`strokeColor` で条件付きスタイリング）
- `ConfirmDialog` による公開確認ダイアログ
- DesignerTest にバリデーション・公開テスト 6 件を追加

### コンポーネント API の修正

実装中に以下の API 不一致を発見し修正:
- `ErrorMessage.fromApiError` → `ErrorMessage.toUserMessage { entityName = "..." }`
- `ErrorState.view` → `ErrorState.viewSimple`（リフレッシュ不要の場合）
- `MessageAlert.viewSuccess/viewError` → `MessageAlert.view { onDismiss, successMessage, errorMessage }`
- `NetworkError "timeout"` → `NetworkError`（引数なし）

### elm-review 修正

- `[x] ++ list` パターンを `x :: list`（cons 演算子）に置換

## 判断ログ

- 公開フローの非同期チェーン設計: 複雑なステートマシンではなく `pendingPublish` フラグで Msg チェーンを管理する方式を採用。TEA の単方向データフローに自然に適合し、各 update ハンドラが独立してテスト可能
- バリデーションエラーのステップハイライト: `viewStepNode` の引数に `errorStepIds` を追加し、`strokeColor`/`strokeWidth` を let バインディングで分離。選択状態とエラー状態の視覚フィードバックが独立して動作する設計
- `ErrorState.viewSimple` の採用: Designer にはリロードボタンがないため、`ErrorState.view { message, onRefresh }` ではなく `ErrorState.viewSimple` を使用

## 成果物

### コミット

| ハッシュ | メッセージ |
|---------|-----------|
| f0dfaac | #726 Integrate designer with API for loading and saving workflow definitions |
| 4faf30a | #726 Add validation, publish flow, and error step highlighting |

### 変更ファイル（Phase 4〜5）

| ファイル | 変更内容 |
|---------|---------|
| `frontend/src/Page/WorkflowDefinition/Designer.elm` | API 統合、バリデーション、公開フロー、エラーハイライト |
| `frontend/src/Page/WorkflowDefinition/List.elm` | Draft 定義への編集リンク追加 |
| `frontend/src/Main.elm` | DesignerEdit ルートの initPage、isCurrentPageDirty |
| `frontend/tests/Page/WorkflowDefinition/DesignerTest.elm` | API 統合テスト 8 件、バリデーション・公開テスト 6 件 |

### テスト

- Elm テスト: 445 件全通過
- `just check-all`: 全品質ゲート通過
