# 削除レジストリ信頼性向上

Issue: [#471](https://github.com/ka2kama/ringiflow/issues/471)
PR: [#610](https://github.com/ka2kama/ringiflow/pull/610)

## 概要

PR #466 のレビューで指摘された削除レジストリの信頼性問題を改善した。DynamoDB の `BatchWriteItem` で `unprocessed_items` が返された場合の exponential backoff リトライと、`delete_all` の部分失敗ハンドリングを実装した。

## 実施内容

### Phase 1: DynamoDB unprocessed_items リトライ

`DynamoDbAuditLogDeleter::delete` メソッドの `BatchWriteItem` ループに exponential backoff リトライを追加した。

- リトライパラメータ: 最大 5 回、初回 100ms、倍率 2、上限 5 秒
- `compute_backoff_ms` を純粋関数として抽出し、4 つのユニットテストを追加
- リトライ発生時は `tracing::warn!`、上限超過時は `tracing::error!` でログ出力

DynamoDB Local はスループット制限がないため `unprocessed_items` を再現できない。backoff 計算ロジックの正確性はユニットテストで担保した。

### Phase 2: DeletionReport 型と部分失敗ハンドリング

`delete_all` の戻り値を `Result<HashMap<..>, InfraError>` から `DeletionReport` に変更し、個別 Deleter のエラーで残りの Deleter が停止しないようにした。

- `DeletionReport` 型を `deletion/mod.rs` に追加（`succeeded` + `failed` フィールド）
- `Result` でラップしないことで、呼び出し元に `has_failures()` チェックを構造的に強制
- MockDeleter に `failing()` コンストラクタを追加し、5 つの部分失敗テストを追加
- 統合テスト `postgres_deleter_test.rs` を `DeletionReport` 型に適応

## 判断ログ

- `DeletionReport` を `Result` でラップしない設計を採用。`?` 演算子による安易な unwrap を防ぎ、部分失敗チェックを型レベルで強制する
- リトライ方式は手動 exponential backoff を選択。リトライ対象が 1 箇所のみのため `backon` クレート導入は YAGNI
- `count_all` の部分失敗ハンドリングはスコープ外。診断目的のため早期リターンで問題ない

## 成果物

### コミット

```
e3ee994 #471 WIP: Improve deletion registry reliability
5615e36 #471 Implement exponential backoff retry for DynamoDB BatchWriteItem unprocessed_items
768dca3 #471 Add DeletionReport type and partial failure handling for delete_all
3a72336 #471 Add implementation plan for deletion registry reliability
```

### 変更ファイル

| ファイル | 変更内容 |
|---------|---------|
| `backend/crates/infra/src/deletion/dynamodb_audit_log.rs` | exponential backoff リトライ追加、`compute_backoff_ms` 関数抽出、ユニットテスト 4 件追加 |
| `backend/crates/infra/src/deletion/mod.rs` | `DeletionReport` 型と `has_failures()` メソッド追加 |
| `backend/crates/infra/src/deletion/registry.rs` | `delete_all` の戻り値型変更、部分失敗ハンドリング、テスト 5 件追加 |
| `backend/crates/infra/tests/postgres_deleter_test.rs` | 統合テストを `DeletionReport` 型に適応 |
| `prompts/plans/stateless-forging-pinwheel.md` | 実装計画 |
