# BFF レスポンスハンドリング共通化

## 概要

BFF Client の Core Service 呼び出しにおける `match response.status()` パターンの重複を解消した。`handle_response<T>` 関数を新規作成し、19 メソッド（3 ファイル）のレスポンスハンドリングを統一した。

関連: #377, PR #421

## 実施内容

### Phase 1: handle_response 関数の実装

TDD で `response.rs` に `handle_response<T>` 関数を実装した。

- 8 パターンのユニットテスト（成功・404 あり/なし・400・403・409・500・不正 JSON）
- テストでの `reqwest::Response` 構築に `http` crate の `From<http::Response>` を活用
- `pub(super)` visibility で core_service モジュール内部のみに公開

### Phase 2: クライアントメソッドのリファクタリング

`user_client.rs`（3 メソッド）→ `task_client.rs`（4 メソッド）→ `workflow_client.rs`（12 メソッド）の順に `handle_response` へ置き換え。

各メソッドの差異は `not_found_error: Option<CoreServiceError>` の値のみ。list 系は `None`、個別取得系は `Some(XxxNotFound)` を渡す設計。

### 成果

- 変更行数: +201 / -360（net -159 行）
- jscpd: クローン数 126 → 120（-6）、重複率 12.21% → 10.69%（-1.52pp）

## 判断ログ

- Phase 1 設計: 関数 vs trait vs マクロを比較し、差異が NOT_FOUND のマッピング先だけであることから単純な関数を選択
- Phase 1 設計: BAD_REQUEST/FORBIDDEN/CONFLICT を全メソッドで一律処理する方針。一部メソッドが従来これらを処理していなかったが、一貫性向上のメリットが上回ると判断
- Refactor: `if status == NOT_FOUND { if let Some(err) = ... }` を let-chain 構文 `if status == NOT_FOUND && let Some(err) = ...` にリファクタリング（Rust 2024 の安定化済み構文）

## 成果物

### コミット

| コミット | 内容 |
|---------|------|
| `817523c` | WIP: Consolidate BFF client response handling |
| `982064a` | Implement handle_response helper for Core Service client |
| `330794e` | Refactor client methods to use handle_response |
| `4be84e2` | Refactor NOT_FOUND check to use let-chain syntax |

### 変更ファイル

| ファイル | 変更内容 |
|---------|---------|
| `backend/Cargo.toml` | `http = "1"` を workspace 依存に追加 |
| `backend/apps/bff/Cargo.toml` | `http` を dev-dependencies に追加 |
| `backend/apps/bff/src/client/core_service.rs` | `mod response;` 追加 |
| `backend/apps/bff/src/client/core_service/response.rs` | **新規** — `handle_response` + テスト |
| `backend/apps/bff/src/client/core_service/user_client.rs` | 3 メソッドを置き換え |
| `backend/apps/bff/src/client/core_service/task_client.rs` | 4 メソッドを置き換え |
| `backend/apps/bff/src/client/core_service/workflow_client.rs` | 12 メソッドを置き換え |
