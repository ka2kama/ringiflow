# テストカバレッジ改善（#291）

## 概要

Issue #291 に基づき、テストカバレッジの現状把握と改善を実施した。cargo-llvm-cov によるカバレッジ計測環境の整備、Domain 層エッジケーステスト 12 件の追加、API テスト突合表の作成、フォローアップ Issue の起票を行った。

## 背景と目的

- テストカバレッジの現状を定量的に把握する手段がなかった
- Domain 層の `cancelled()` メソッドにテストがゼロだった
- OpenAPI 仕様と API テスト（Hurl）の対応関係が不明確だった
- #290 のリファクタリングに備え、安全ネットとしてのテスト充実が必要だった

## 実施内容

### Phase 1: cargo-llvm-cov セットアップ

- `justfile` に `coverage` / `coverage-summary` タスクを追加
- `check-tools` に cargo-llvm-cov の確認を追加
- 開発環境構築手順書にインストール手順を追記
- ベースライン計測: 62.31% Lines, 64.39% Regions

### Phase 2: Domain エッジケーステスト追加（12 件）

| テスト対象 | テスト数 | 内容 |
|-----------|---------|------|
| `WorkflowInstance::cancelled()` | 6 | 正常系 3（Draft/Pending/InProgress → Cancelled）+ 異常系 3（Approved/Rejected/Cancelled → Err） |
| `WorkflowInstance::submitted()` 異常系 | 2 | Pending/InProgress からの再申請 → Err |
| `WorkflowDefinition` 状態遷移 | 3 | published(), archived() の正常系 + 重複公開エラー |
| `WorkflowStep::completed()` RequestChanges | 1 | 差戻し決定での完了 |

### Phase 3: API テスト突合表

`docs/08_テスト/APIテスト突合表.md` を作成。18 エンドポイント中 9 件カバー済み（50%）。

### Phase 4: フォローアップ Issue

- #321 API テスト追加（Hurl テストの 9 件のギャップ解消）
- #322 Usecase 層エラーパステスト追加

## 設計上の判断

| 判断 | 内容 | 参照 |
|------|------|------|
| カバレッジ計測ツール | cargo-llvm-cov を採用（cargo-tarpaulin ではなく） | ADR-035 |
| Handler 層テスト戦略 | ユニットテストは不要、API テスト（Hurl）で十分 | ADR-036 |
| ドキュメント配置 | API テスト突合表は `docs/08_テスト/` に配置 | 下記「議論の経緯」参照 |

## 判断ログ

| 種別 | 判断 | 背景 |
|------|------|------|
| ルール適用 | テスト追加は既存パターン（rstest fixtures、日本語テスト名）に完全準拠 | pre-implementation チェックリストに従い、既存テストを先に読んでからパターンを踏襲 |

## 成果物

コミット:
1. `#291 WIP: Improve test coverage for Handler and Usecase layers`
2. `#291 Add cargo-llvm-cov setup for code coverage measurement`
3. `#291 Add domain edge case tests for cancelled, submitted, definition, and RequestChanges`
4. `#291 Add API test coverage mapping table (OpenAPI vs Hurl)`
5. `#291 Move API test mapping table to knowledge base`
6. `#291 Add testing category to knowledge base README`
7. `#291 Move API test mapping table to docs/08_テスト/`

変更ファイル:
- `justfile` — coverage タスク追加、check-tools 更新
- `docs/04_手順書/01_開発参画/01_開発環境構築.md` — cargo-llvm-cov 追記
- `backend/crates/domain/src/workflow.rs` — テスト 12 件追加
- `docs/08_テスト/APIテスト突合表.md` — 新規作成
- `CLAUDE.md` — ドキュメント体系にテストディレクトリ追加

PR: #320

## 議論の経緯

### API テスト突合表の配置先

当初 `docs/03_詳細設計書/` に配置したが、ユーザーから「突合表は詳細設計なのか？」と指摘があった。突合表はプロジェクト固有のテスト追跡文書であり、技術知識でも設計書でもないことを確認。

一度ナレッジベース（`docs/06_ナレッジベース/testing/`）に移動したが、さらにユーザーから「テスト用のディレクトリがナレッジベースに属するのか」と指摘。ナレッジベースの「書かないこと」に「プロジェクト固有の設計詳細」が含まれており、テスト追跡文書は該当すると判断。

最終的に `docs/08_テスト/` を新設し、テスト仕様（受け入れテスト等）もテスト追跡（突合表）も包含する広いスコープのディレクトリとした。

## 学んだこと

- ドキュメントの配置は「その文書の性質は何か」を基準に判断する。追跡文書（プロジェクトの状態を記録するもの）は技術知識（ナレッジベース）でも設計書でもない
- cargo-llvm-cov は Rust 公式の LLVM ソースベースカバレッジを活用し、cargo-tarpaulin の ptrace 方式より精度が高い
- Domain 層のテストは rstest fixtures で状態を構築しやすく、エッジケースの網羅が効率的

## 次のステップ

- #321 API テスト追加
- #322 Usecase 層エラーパステスト追加
