# just check 並列化

## 概要

`just check` の実行時間を短縮するため、Rust レーンと Non-Rust レーンの 2 レーン並列化と、npm ツールのローカルインストール化（npx → pnpm exec）を実施した。

Issue: #469
PR: #484

## 実施内容

### Phase 1: ルート package.json の作成

ルートに `package.json` を新規作成し、`@redocly/cli` と `jscpd` を devDependencies として管理するようにした。

### Phase 2: npx → pnpm exec 変更

`lint-openapi` と `check-duplicates` の `npx --yes <pkg>@latest` を `pnpm exec <cmd>` に変更。`setup` チェーンに `setup-root-deps` レシピを追加。

### Phase 3: check レシピの並列化

`check` レシピを bash スクリプトに変更し、2 レーン並列実行を実装。

- Rust レーン（フォアグラウンド）: lint-rust → test-rust → test-rust-integration → sqlx-check → openapi-check
- Non-Rust レーン（バックグラウンド）: lint-elm → test-elm → build-elm → lint-shell → lint-ci → lint-openapi → check-unused-deps → check-file-size → check-duplicates

エラーハンドリング:
- メインスクリプトは `set -uo pipefail`（`-e` なし）で明示的エラー管理
- Non-Rust サブシェルは `set -e` で fail-fast
- 両レーンとも完了まで実行し、1 回で全失敗を把握

### Phase 4: CI ワークフロー更新

`openapi` ジョブと `code-quality` ジョブに pnpm セットアップ + `pnpm install --frozen-lockfile` を追加。

### Phase 5: ドキュメント更新

RedoclyCLI.md と ADR-042 の npx 記述を pnpm exec に更新。

## 判断ログ

- `set -euo pipefail` ではなく `set -uo pipefail` を採用: `-e` だと `|| rust_ok=false` パターンが機能しないため
- `check-unused-deps`（cargo machete）を Non-Rust レーンに配置: ファイル読み取りのみで Cargo ビルドロック不要のため

## 成果物

コミット:
- `b0cd61e` #469 Parallelize `just check` with Rust/Non-Rust lanes and local npm tools

作成ファイル:
- `package.json` — ルート開発ツール管理
- `pnpm-lock.yaml` — ロックファイル

更新ファイル:
- `justfile` — npx → pnpm exec、setup-root-deps 追加、check 並列化
- `.github/workflows/ci.yaml` — openapi/code-quality ジョブに pnpm セットアップ追加
- `docs/80_ナレッジベース/devtools/RedoclyCLI.md` — npx → pnpm exec
- `docs/70_ADR/042_コピペ検出ツールの選定.md` — npx → pnpm exec
