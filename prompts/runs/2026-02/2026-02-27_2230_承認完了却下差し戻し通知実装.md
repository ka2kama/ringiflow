# 承認完了・却下・差し戻し通知実装

日時: 2026-02-27 22:30
Issue: #877
PR: #964

## 概要

approve_step / terminate_step（reject / request_changes）のユースケースに通知送信を統合した。#875/#876 で構築済みの通知基盤（NotificationService, TemplateRenderer, テンプレート）を利用して、ワークフローの状態遷移時に申請者（および次の承認者）へメール通知を送信する。

## 実装内容

### Phase 1: approve_step への通知統合

- `approve_step` のトランザクション完了後に通知を送信
- 最終ステップ: `Approved` 通知 → 申請者
- 中間ステップ: `StepApproved` 通知 → 申請者 + `ApprovalRequest` 通知 → 次の承認者
- fire-and-forget パターン: ユーザー情報取得失敗時もワークフロー操作は成功

### Phase 2: terminate_step への通知統合

- `terminate_step` 共通フローにトランザクション完了後の通知を追加
- `StepTerminationType` で分岐: `Reject` → `Rejected` 通知、`RequestChanges` → `ChangesRequested` 通知
- 却下コメント・差し戻しコメントがメール本文に含まれる

### API テスト Mailpit 検証

- 5 つの Hurl ファイルに Mailpit 通知検証を追加
- 通知の送信先、件名パターン、通知数を検証

## 判断ログ

### terminate_step での通知統合場所

reject と request_changes は `terminate_step` 共通フローを共有しているため、`common.rs` 内の `terminate_step` メソッド末尾に通知処理を追加。`build_termination_notification` を純粋関数として抽出し、`StepTerminationType` による分岐で適切な通知バリアントを構築。approve_step と同じ fire-and-forget パターンを踏襲。

### 通知件名テンプレートの「要修正」表記

`ChangesRequested` 通知の件名は `[RingiFlow] 要修正:` であり、「差し戻し」ではない。API テスト（request_changes_step.hurl）での検証は `contains "[RingiFlow] 要修正"` を使用。テンプレートは `template_renderer.rs` で定義済み。

## 変更ファイル

### プロダクションコード

- `backend/apps/core-service/src/usecase/workflow/command/decision/approve.rs` - 承認通知ロジック + テスト
- `backend/apps/core-service/src/usecase/workflow/command/decision/common.rs` - 却下/差し戻し通知ロジック
- `backend/apps/core-service/src/usecase/workflow/command/decision/reject.rs` - 却下通知テスト
- `backend/apps/core-service/src/usecase/workflow/command/decision/request_changes.rs` - 差し戻し通知テスト
- `backend/apps/core-service/src/usecase/workflow/command/lifecycle/common.rs` - visibility 修正

### テスト

- `tests/api/hurl/workflow/approve_step.hurl` - 承認完了通知 Mailpit 検証
- `tests/api/hurl/workflow/reject_step.hurl` - 却下通知 Mailpit 検証
- `tests/api/hurl/workflow/request_changes_step.hurl` - 差し戻し通知 Mailpit 検証
- `tests/api/hurl/workflow/multi_step_approve.hurl` - 中間ステップ承認通知 Mailpit 検証
- `tests/api/hurl/workflow/multi_step_reject.hurl` - 2 段階却下通知 Mailpit 検証
