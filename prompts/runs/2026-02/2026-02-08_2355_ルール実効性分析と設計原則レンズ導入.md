# ルール実効性分析と設計原則レンズ導入

## 概要

`.claude/rules/` のルールが実際に機能しているか検証し、機能していなかった「往復のリズム」を設計原則レンズとして具体化した。

## 背景と目的

ユーザーから「rules の内、機能していないかもしれないものがある」という問題提起があり、特に `pre-implementation.md` と `zoom-rhythm.md` の実効性を調査した。

## 実施内容

### 1. ルール実効性の調査

セッションログ、改善記録、計画ファイルを横断的に調査し、各ルールの機能状況を評価した。

**調査結果:**

| ルール | 機能状況 | 根拠 |
|-------|---------|------|
| zoom-rhythm: ブラッシュアップループ | 機能している | 計画ファイル全件にループ記録・収束確認あり |
| zoom-rhythm: 往復のリズム | 機能していない | セッションログに実装中の俯瞰痕跡なし、改善記録に「俯瞰不足」インシデント複数 |
| pre-implementation.md | 部分的 | 明示的言及1件のみ。コンパイラが事実上の強制力を持つため違反が見えにくい |

### 2. 往復のリズムが機能しない原因分析

ブラッシュアップループ（機能する）との対比で構造的原因を特定:

| 要素 | ブラッシュアップループ | 往復のリズム |
|------|---------------------|-------------|
| トリガー | 計画初版完成（明確） | 「Refactor で」（曖昧） |
| 強制力 | 成果物要件（記載必須） | なし |
| 成果物 | ループ記録テーブル | なし |

根本原因: 「視点を上げろ」は人間の直感に頼る指示であり、AI には「何を見るか」の具体化が必要。

### 3. Want の分析と品質の2面性

Want: Ready for Review 時点の最終品質を最大限高めたい。

品質には「守り」（欠陥除去）と「攻め」（改善機会の統合）がある:
- 守り: ブラッシュアップループ + 品質チェックリストで概ねカバー済み
- 攻め: 仕組みなし → ここが往復のリズムの本来の役割

品質チェックリストに既に「ゼロ→プラス」観点（SRP、型の活用、シンプルさ）があるが、RfR でしか適用されていなかった。問題は原則の不在ではなく、適用タイミングが遅すぎること。

### 4. TDD Refactor の再定義

TDD Refactor を「きれいにする」→「設計を改善する」に再定義し、設計原則レンズを導入:

| タイミング | レンズ | 由来 |
|-----------|--------|------|
| 毎 Refactor | Simple Design（意図・重複・最小性） | Kent Beck |
| モジュール/関数完成時 | SRP・DIP・型の活用 | SOLID 原則 |
| Phase 完了時 | 全レンズ + 品質チェックリスト | 区切りでの全体俯瞰 |

## 設計上の判断

### 新原則の導入 vs 既存原則の適用タイミング前倒し

品質チェックリストに既にある観点（シンプルさ、責務の明確さ、型の活用）を Refactor にも移植する方針を選択。新しい原則を追加するのではなく、既存原則の適用タイミングを早めることで、ドキュメント間の一貫性を保った。

### 哲学と手順の分離

zoom-rhythm.md に「なぜ」（哲学）、TDD 開発フローに「どうやって」（手順）を配置し、参照で接続。同じ内容を2箇所に書かないことで、独立した進化を可能にした。

### OCP / LSP / ISP の見送り

SOLID の残り3原則（OCP、LSP、ISP）は現時点では導入しない。Rust / Elm の文脈では trait / 型クラス設計時に関わるが頻度が低く、必要が生じたら追加する。

## 判断ログ

このセッションは分析・設計がメインであり、コード実装中の判断ポイントはなかった。

## 成果物

### 変更ファイル

| ファイル | 変更内容 |
|---------|---------|
| `docs/60_手順書/04_開発フロー/02_TDD開発フロー.md` | Refactor を「設計を改善する」に再定義、設計原則レンズ追加 |
| `.claude/rules/zoom-rhythm.md` | 往復のリズムを具体化、二つの砦の図を更新、AI 指示を具体化 |
| `CLAUDE.md` | 俯瞰テーブルを設計原則レンズへの参照に更新 |

### 新規ファイル

| ファイル | 内容 |
|---------|------|
| `prompts/improvements/2026-02/2026-02-08_2355_往復のリズムが機能しない構造的原因.md` | 改善記録 |

## 議論の経緯

### ルールの実効性

ユーザーから「pre-implementation と zoom-rhythm があやしい」との問題提起。調査の結果、zoom-rhythm のブラッシュアップループは機能しているが往復のリズムは機能していないことが判明。ユーザーから「ブラッシュアップループが動いていることは知っている。往復のリズムが怪しい」と、より正確な問題の絞り込みがあった。

### なぜ AI に往復が機能しないのか

ユーザーから「人間にはコンテクストスイッチの負荷がキツいが、AI ならできると思った」という洞察。AI にコンテクストスイッチのコストはないが、「視点を上げろ」は AI にとって実行可能な指示になっていなかった。問題は能力ではなく指示の粒度。

### 攻めの品質は譲れない

ROI が低いかもしれないという選択肢に対し、ユーザーから「ベストプラクティス起点とも関係するが、攻めの品質は譲れない。仕組み作りが全然できていない以上、投資するのは悪い選択ではない」と方針が示された。

### 既存原則の再発見

品質チェックリストを確認したところ、SOLID / Simple Design 相当の観点が既に存在。新原則の導入ではなく、既存原則の適用タイミング前倒しで合意。

## 学んだこと

- ルールが機能するかどうかの分水嶺は「成果物要件化」。行動規範（「〜すべき」）は機能しにくく、成果物要件（「〜が記載されていること」）は機能する
- AI に「視点を上げろ」は抽象的すぎる。具体的な問いに分解することで実行可能になる
- 品質には「守り」と「攻め」がある。守りの仕組み（チェックリスト）は攻め（改善機会のキャプチャ）を構造的にカバーできない
- TDD の Refactor ステップは元々「設計改善」の場として設計されている。「きれいにする」への矮小化は TDD の本来の意図に反する

## 次のステップ

- 次の実装セッションで設計原則レンズの効果を検証する（判断ログへの記録が出始めるか）
- pre-implementation.md の扱いを別途検討する（今回のスコープ外）
