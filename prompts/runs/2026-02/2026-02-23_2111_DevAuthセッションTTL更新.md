# DevAuth セッション TTL 更新

## 概要

デモ環境（demo.ka2kama.com）でダッシュボードに「統計情報の取得に失敗しました」エラーが表示される問題を調査・修正した。原因は DevAuth セッションの Redis TTL（8時間）経過による自動消滅。バックグラウンドタスクによる定期更新で対策した。

## 実施内容

### 原因調査

1. スクリーンショートからエラー状態を確認（ダッシュボード統計取得エラー + 「未ログイン」表示）
2. DevAuth の仕組みを確認（BFF 起動時に Redis へ dev-session を 1 回作成）
3. ブラウザの DevTools で Cookie `session_id=dev-session` が存在することを確認 → フロントエンド側は正常
4. `session.rs` で `SESSION_TTL_SECONDS = 28800`（8時間）を確認 → セッションは TTL 経過で自動消滅
5. Redis の AOF 永続化は TTL 情報も保持するため、Redis 再起動では解決しないことを確認

### 修正

- `dev_auth.rs`: 4時間間隔でセッションを再作成する `spawn_dev_session_refresh` 関数を追加
- `main.rs`: DevAuth 初期化ブロック（`#[cfg(feature = "dev-auth")]`）内で更新タスクを spawn

### 応急対応

GitHub Actions の `workflow_dispatch` でデモ環境のデプロイを再実行し、BFF 再起動による即時復旧も実施。

## 判断ログ

- 更新間隔を TTL の半分（4時間）に設定（DNS TTL 更新戦略と同様のアプローチ）
- fire-and-forget パターンを採用（DevAuth はデモ専用機能のため graceful shutdown は不要）
- SessionManager トレイトの変更を避け、既存の `setup_dev_session` を再利用する方針

## 成果物

- PR: #792
- 変更ファイル:
  - `backend/apps/bff/src/dev_auth.rs`: `spawn_dev_session_refresh` 追加
  - `backend/apps/bff/src/main.rs`: DevAuth ブロック内で refresh タスク起動
