# 永続 worktree スロット実装

日時: 2026-02-18
Issue: #625
PR: #639

## 概要

worktree を「Issue ごとに生成・破棄するモデル」から「永続スロット方式」に変更した。`ringiflow-1`, `ringiflow-2`, ... として固定の worktree スロットを維持し、Issue 着手時はスロット内でブランチを切り替える方式。セットアップコスト（`pnpm install`、初回ビルド、DB マイグレーション）の繰り返しを排除。

## 実施内容

### Phase 1: 新規スクリプト + justfile コマンド

- `scripts/worktree-create.sh`: 永続スロットの初回作成（detached HEAD + .env 生成 + セットアップ）
- `scripts/worktree-switch.sh`: スロット内ブランチ切り替え（DB マイグレーション + pnpm 差分更新）
- justfile に `worktree-create` / `worktree-switch` コマンドを追加

### Phase 2: worktree-issue.sh 改修 + worktree-add 廃止

- `worktree-issue.sh` の引数を `NUMBER [SLOT]` に変更し、`worktree-switch.sh` に委譲する方式に変更
- `.worktree-slot` マーカーからのスロット自動検出を実装
- `scripts/worktree-add.sh` を削除

### Phase 3: cleanup.sh 改修

- `.worktree-slot` マーカーによる永続スロット判定を追加
- 永続スロットは削除ではなく `git switch --detach origin/main` でリセットする分岐を実装

### Phase 4: ドキュメント整備

- `/next` スキルをスロット方式に更新
- `.gitignore` に `.worktree-slot` を追加
- 手順書（並行開発）を全面改訂
- ADR-021 に永続スロット方式への移行の補遺を追加
- 実装解説（機能解説・コード解説）を全面改訂
- README の開発環境セクションを更新

## 判断ログ

- `env -u` による環境変数クリアを採用。justfile の `dotenv-load` が既存の環境変数を上書きしないため、親プロセスから継承されたポート変数を明示的にクリアする必要がある
- pnpm-lock.yaml の差分チェックで fail-open 方式を採用。diff 失敗時は安全側に倒して `pnpm install` を実行する（冪等操作のため不要な実行のコストは低い）
- 未コミット変更がある場合はエラーで拒否し、自動 stash は行わない判断。stash の紛失リスクを避け KISS を優先
- スロット自動選択は実装しない判断。どのスロットを使うかはユーザーが意識的に選ぶべき
- `API_TEST_*` 変数を `env -u` のリストに追加。旧 `worktree-add.sh` で欠けていた変数も修正

## 成果物

コミット:
- `#625 WIP: Change worktree to persistent slot model`（Draft PR + ブランチ作成）
- `#625 Add worktree-create and worktree-switch scripts`
- `#625 Reform worktree-issue to use slots, remove worktree-add`
- `#625 Update cleanup.sh to preserve persistent worktree slots`
- `#625 Update docs and skills for persistent worktree slots`
- `#625 Add plan files for persistent worktree slots`

作成・更新ファイル:
- 新規: `scripts/worktree-create.sh`, `scripts/worktree-switch.sh`
- 改修: `scripts/worktree-issue.sh`, `scripts/cleanup.sh`, `justfile`
- 削除: `scripts/worktree-add.sh`
- ドキュメント: 手順書、ADR-021、実装解説（機能解説・コード解説）、README、.gitignore、/next スキル
