# DBスキーマスナップショット自動生成

- Issue: #468
- PR: #486
- ブランチ: `feature/468-db`

## 概要

`pg_dump --schema-only` でDBスキーマスナップショット（`backend/schema.sql`）を自動生成し、Git 管理する仕組みを導入した。Rails の `db/structure.sql` に相当する。既存の `openapi-check`（utoipa → openapi.yaml 同期チェック）と同じ「生成→diff」パターンで実装した。

## 実施内容

### justfile コマンド追加

- `db-dump-schema`: `pg_dump` でスキーマスナップショットを生成
- `db-migrate`: マイグレーション実行 + スナップショット更新
- `schema-check`: スナップショットの同期チェック

### 既存コマンド修正

- `setup-db`: マイグレーション後にスキーマダンプを実行
- `reset-db`: DB リセット後にスキーマダンプを実行
- `check-tools`: `pg_dump` の存在確認を追加

### CI・チェック体系への統合

- `scripts/check-parallel.sh`: Rust レーンに `schema-check` を追加
- `.github/workflows/ci.yaml`: `rust-integration` ジョブにスキーマ同期チェックを追加

### pg_dump 出力の正規化

環境間差分を防止するため、以下を除去:

- `--no-owner --no-privileges --no-tablespaces`: 環境依存情報
- `--exclude-table=_sqlx_migrations`: sqlx 内部テーブル
- `sed` によるバージョン行の除去
- `sed` による `\restrict`/`\unrestrict` 行の除去（PostgreSQL 17 固有）

## 判断ログ

- PostgreSQL 17 の `\restrict`/`\unrestrict` ディレクティブが毎回ランダムトークンを生成し、冪等性を壊すことを手動検証で発見。`sed` で除去するパターンに追加した
  - → 改善記録: [pg_dump 出力の環境依存要素の事前調査不足](../../../process/improvements/2026-02/2026-02-12_2122_pg_dump出力の環境依存要素の事前調査不足.md)

## 成果物

### コミット

- `910eccf` #468 Add DB schema snapshot generation and sync check

### 作成・更新ファイル

| ファイル | 変更内容 |
|---------|---------|
| `justfile` | `db-dump-schema`, `db-migrate`, `schema-check` 追加。`setup-db`, `reset-db`, `check-tools` 修正 |
| `scripts/check-parallel.sh` | Rust レーンに `schema-check` 追加 |
| `.github/workflows/ci.yaml` | `rust-integration` にスキーマ同期チェック追加 |
| `backend/schema.sql` | 新規生成（1293 行） |
| `CLAUDE.md` | データストア操作セクションに新コマンド追記 |
