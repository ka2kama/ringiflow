# 多段階承認バックエンド実装

Issue: #475（複数ステップ承認のバックエンド実装）
Branch: `feature/475-multi-step-approval`
PR: #479

## 概要

Phase 1 の1段階承認を拡張し、2段階の順次承認をバックエンドで実装した。ワークフロー定義 JSON から承認ステップを抽出し、ステップ間の遷移ロジック（承認→次ステップ Active 化、却下→残ステップ Skipped）を追加した。

## 実施内容

### Phase 1: ドメインモデル拡張

- `WorkflowInstance.advance_to_next_step`: InProgress 状態で current_step_id を更新するメソッド
- `WorkflowStep.skipped`: Pending → Skipped 状態遷移メソッド
- 各メソッドに状態ガードとユニットテスト追加

### Phase 2: 定義 JSON パーサーと Submit ユースケース拡張

- `extract_approval_steps`: 定義 JSON の `steps` 配列から `type == "approval"` のステップを配列順で抽出
- Submit API を `assigned_to: Uuid` → `approvers: Vec<StepApprover>` に変更
- 承認ステップ数と approvers 数の一致バリデーション
- ステップ作成: 最初を Active、残りを Pending で生成

### Phase 3: Approve ユースケース拡張

- 承認時に定義から承認ステップ順序リストを取得
- 中間ステップ: 次ステップを Active 化、`advance_to_next_step` で current_step_id 更新
- 最終ステップ: `complete_with_approval` でインスタンスを Approved に遷移

### Phase 4: Reject ユースケース拡張

- 却下時に残りの Pending ステップを全て Skipped に遷移
- インスタンスを Rejected に遷移

### Phase 5-6: API 層更新、シードデータ、OpenAPI

- BFF/Core Service のリクエスト/レスポンス型を更新
- 2段階承認ワークフロー定義のシードデータ追加
- OpenAPI に `StepApproverRequest` スキーマ追加
- 全 API テスト（Hurl）を新 approvers 形式に更新
- `multi_step_approve.hurl`、`multi_step_reject.hurl` の E2E テスト追加
- BFF の `default-run` 設定追加（`cargo run -p ringiflow-bff` の binary 選択エラー修正）

## 判断ログ

- Phase 2: 定義 JSON の `transitions` は使用せず `steps` 配列の順序で承認順を決定した。理由: 順次承認では配列順で十分であり、条件分岐は Phase 3 で対応予定
- Phase 3 Refactor: approve_step のエラーチェック（403, 400, 409）を定義取得の前に配置し、既存のエラーパステストが定義 setup 不要な構造を維持
- Phase 5: E2E テスト（Playwright）が3件失敗するのは期待通り。フロントエンドが旧 `assigned_to` 形式で submit しているため。フロントエンド対応は Story #478 スコープ

## 成果物

### コミット

```
9da9e9d #475 Update workflow feature spec for multi-step approval, send-back, and comments
2d32d9a #475 Implement multi-step approval domain model and use cases
4de9e9b #475 Add multi-step approval API tests, seed data, and OpenAPI update
```

### 主な変更ファイル

| ファイル | 変更内容 |
|---------|---------|
| `backend/crates/domain/src/workflow/definition.rs` | `extract_approval_steps` 追加 |
| `backend/crates/domain/src/workflow/instance.rs` | `advance_to_next_step` 追加 |
| `backend/crates/domain/src/workflow/step.rs` | `skipped` メソッド追加 |
| `backend/apps/core-service/src/usecase/workflow/command.rs` | submit, approve, reject の拡張 + テスト19件 |
| `backend/apps/core-service/src/handler/workflow/command.rs` | StepApproverRequest → StepApprover 変換 |
| `backend/apps/bff/src/handler/workflow.rs` | SubmitWorkflowRequest に approvers 追加 |
| `openapi/openapi.yaml` | StepApproverRequest スキーマ追加 |
| `tests/api/hurl/workflow/multi_step_approve.hurl` | 2段階承認 E2E テスト |
| `tests/api/hurl/workflow/multi_step_reject.hurl` | 2段階却下 E2E テスト |
