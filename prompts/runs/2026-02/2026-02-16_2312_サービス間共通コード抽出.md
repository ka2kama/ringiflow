# サービス間共通コード抽出

Issue: #530（Epic #467 のサブ Issue）
ブランチ: `feature/530-issue`
PR: #588

## 概要

3 つのサービス（BFF, Core Service, Auth Service）間のコードクローン 13 件を評価し、プロダクションコードの 4 件に対処方針を決定・実装した。

## 実施内容

### As-Is 検証

Issue 記載の 13 クローンを現在のコードベースで検証した結果:
- 2 件は先行 Story（#527）で解消済み
- 5 件はテストコード（#531 スコープ）
- 残り 4 件（2 件は対処実施、2 件は対処不要）を評価

### Phase 1: HealthResponse 型を shared crate に抽出

- `backend/crates/shared/src/health.rs` に HealthResponse 型を新規作成
- `cfg_attr(feature = "openapi", derive(utoipa::ToSchema))` で OpenAPI 対応
- 3 サービスの handler/health.rs から shared の型を参照するよう変更
- handler 関数は各サービスに残す（shared に axum 依存を入れない方針）
- jscpd 検出解消のため、doc コメントをサービス固有の文言に変更

### Phase 2: main.rs に jscpd:ignore を適用

- 3 サービスの main.rs に `// jscpd:ignore-start` / `// jscpd:ignore-end` を追加
- 起動ボイラープレート（tracing init, DB pool, server start）を意図的重複としてマーク
- コメントに ADR-049 への参照を含める

### Phase 3: ADR 記録 + Issue 更新

- ADR-049（サービス間共通コード抽出の方針）を作成
- 4 つのクローンへの対処方針と理由を記録
- Issue #530 に精査結果と完了コメントを追加

## 判断ログ

- shared に axum 依存を追加しない方針を維持。型のみ抽出し、handler 関数は各サービスに残す
- `env!("CARGO_PKG_VERSION")` は各サービスの crate で展開されるべきため、handler を shared に移動しない
- main.rs の tracing-subscriber 設定はアプリ層の責務。ライブラリ層の shared に置くべきではない（ADR-023 準拠）
- BFF types ↔ Core handler 型の共通化はマイクロサービスの独立性を損なうため見送り
- ADR 番号の衝突: 計画では ADR-048 を想定していたが、既に「Rustフォーマッター設定の標準化」で使用済みのため ADR-049 に変更

## 成果物

### コミット

- `75dc605` #530 Extract cross-service common code and mark intentional duplication

### 作成・更新ファイル

| ファイル | 変更 |
|---------|------|
| `backend/crates/shared/src/health.rs` | 新規: HealthResponse 型（テスト付き） |
| `backend/crates/shared/src/lib.rs` | モジュール追加 + re-export |
| `backend/apps/auth-service/src/handler/health.rs` | shared からの import に変更 |
| `backend/apps/core-service/src/handler/health.rs` | 同上 |
| `backend/apps/bff/src/handler/health.rs` | 同上 |
| `backend/apps/auth-service/src/main.rs` | jscpd:ignore コメント追加 |
| `backend/apps/core-service/src/main.rs` | 同上 |
| `backend/apps/bff/src/main.rs` | 同上 |
| `docs/05_ADR/049_サービス間共通コード抽出の方針.md` | 新規: 設計判断の記録 |
| `prompts/plans/tranquil-percolating-clover.md` | 新規: 計画ファイル |
