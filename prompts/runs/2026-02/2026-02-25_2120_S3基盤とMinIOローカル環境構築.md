# S3 基盤と MinIO ローカル環境構築

Issue: #880
PR: #917
ブランチ: `feature/880-s3-minio-setup`

## 概要

Epic #406（ドキュメント管理）の最初の Story として、S3 クライアントモジュールと MinIO ローカル開発環境を構築した。後続 Story（#881 アップロード、#882 ダウンロード/削除等）の基盤となる。

## 実施内容

### Phase 1: MinIO Docker インフラ

- `docker-compose.yaml` に MinIO サービスと minio-init（バケット自動作成）を追加
- `docker-compose.api-test.yaml` にも同構成を追加
- `scripts/env/generate.sh` に MinIO ポート変数（4 種）と S3 環境変数を追加
- `.env.template` にデフォルトポートを追加

### Phase 2: S3 クライアントモジュール

- `aws-sdk-s3` をワークスペース依存に追加
- `S3Client` トレイトを定義（Presigned PUT/GET URL 生成、HEAD Object）
- `AwsS3Client` 構造体で実装
- `create_client` 関数: `Option<&str>` エンドポイントで MinIO / AWS S3 を切替
- `InfraError::S3(String)` バリアントを追加

### Phase 3: Core Service S3 設定

- `CoreConfig` に `s3_endpoint_url`（Optional）と `s3_bucket_name`（Required）を追加
- `main.rs` で S3 クライアントを初期化（`_s3_client` として未使用、#881+ で State に注入予定）

### Phase 4: MinIO 統合テスト

- `s3_test.rs` に 5 つの統合テストを作成
- `dotenvy::dotenv()` で `.env` からクレデンシャルを読み込み（DynamoDB Local と異なり MinIO は認証が必要）
- UUID v7 ベースの S3 キーでテスト間を分離

## 判断ログ

- Phase 2: `S3Client` トレイトを infra クレートに配置（`SessionManager`、`PasswordChecker` と同じパターン。ドメイン層に S3 関連の概念がまだないため）
- Phase 2: エンドポイントを `Option<&str>` にした（DynamoDB は常にエンドポイント必須だが、S3 は本番で未設定＝SDK デフォルト使用のため）
- Phase 2: MinIO の `force_path_style` はエンドポイント指定時のみ有効化
- Phase 4: テストで `dotenvy::dotenv()` が必要だった。DynamoDB Local は認証不要だが、MinIO は `AWS_ACCESS_KEY_ID` / `AWS_SECRET_ACCESS_KEY` が必要

## 成果物

### コミット

- `e16feae4` #880 WIP: Set up S3 infrastructure and MinIO local environment（空コミット、Draft PR 用）
- `4c97029f` #880 Add S3 client infrastructure and MinIO local environment

### 作成・変更ファイル

新規:
- `backend/crates/infra/src/s3.rs` — S3Client トレイト + AwsS3Client 実装 + create_client
- `backend/crates/infra/tests/s3_test.rs` — MinIO 統合テスト（5 件）

変更:
- `infra/docker/docker-compose.yaml` — MinIO + minio-init サービス追加
- `infra/docker/docker-compose.api-test.yaml` — API テスト用 MinIO 追加
- `scripts/env/generate.sh` — MinIO ポート・S3 環境変数の生成追加
- `.env.template` — MinIO ポートのデフォルト値追加
- `backend/Cargo.toml` — `aws-sdk-s3` ワークスペース依存追加
- `backend/crates/infra/Cargo.toml` — `aws-sdk-s3` + `reqwest`（dev）追加
- `backend/crates/infra/src/error.rs` — `S3(String)` バリアント追加
- `backend/crates/infra/src/lib.rs` — `pub mod s3` + re-export 追加
- `backend/apps/core-service/src/config.rs` — S3 設定フィールド追加
- `backend/apps/core-service/src/main.rs` — S3 クライアント初期化追加
