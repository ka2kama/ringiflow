# ユーティリティクレート追加

## 概要

開発者 ergonomics 向上のため、よく使われる Rust ユーティリティクレートを workspace に追加した。
併せて、semver バージョン指定のルールを `.claude/rules/rust.md` に追記した。

## 背景と目的

AI エージェント主導の開発では、「今必要なもの」に対して最小限の依存で解決する傾向がある。
しかし、人間の開発者にとっては「あると思考の流れが止まらない」クレートの価値がある。

Scala 経験者のオーナーから、`itertools` や `anyhow` など定番クレートを入れておきたいという要望があった。

## 実施内容

### 追加したクレート

| クレート | 用途 | バージョン |
|---------|------|-----------|
| `itertools` | イテレータ拡張 | 0.14 |
| `validator` | バリデーション（derive マクロ） | 0.20 |
| `strum` | enum の文字列変換・イテレート | 0.27 |
| `regex` | 正規表現 | 1 |
| `derive_more` | From, Display, Constructor などの derive マクロ | 2 |
| `maplit` | マップ/セットリテラルマクロ | 1 |
| `config` | 設定ファイル読み込み | 0.15 |
| `bytes` | バイト列操作 | 1 |
| `rand` | 乱数生成 | 0.9 |
| `url` | URL パース | 2 |
| `insta` | スナップショットテスト | 1 |

### バージョン指定ルールの策定

semver のメジャーバージョンで指定方法を分けることにした:

- **1.x 以上**: メジャーのみ（`"1"`）— semver 準拠が期待できる
- **0.x 系**: マイナーまで（`"0.14"`）— 破壊的変更がありうるため

このルールを `.claude/rules/rust.md` に追記した。

## 設計上の判断

### immutable collection（im クレート）の採用判断

Scala 経験者として、デフォルトを不変データ構造にすることを検討した。

結論: **Tier 3（必要になったら）のまま保留**

理由:
- Rust の所有権システムで得られる安全性と、Scala 的な immutable collection の安全性は解決する問題が異なる
- DB が source of truth なので、メモリ上の永続性の価値は限定的
- 実際に必要になったときに判断する

### config クレートの採用

当初は Tier 3（必要になったら）としていたが、エンタープライズ SaaS になると設定が複雑化することを考慮し、Tier 2 に格上げして追加した。

## 成果物

### コミット

1. `#231 Add commonly-used utility crates to workspace`
2. `#231 Add dependency version specification rule to rust.md`

### 変更ファイル

- `backend/Cargo.toml`: ユーティリティクレート追加
- `.claude/rules/rust.md`: バージョン指定ルール追記

### 関連 Issue/PR

- Issue #231: Add commonly-used utility crates to workspace（クローズ予定）
- PR #232: 上記 Issue の実装
- Issue #233: derive_more/strum によるボイラープレート削減（後続作業）

## 議論の経緯

### クレート選定の Tier 分け

ユーザーから定番クレートを入れたいという要望があり、以下の Tier に分類して提案した:

- Tier 1（今すぐ入れる）: itertools, validator, strum, regex
- Tier 2（入れておくと便利）: derive_more, maplit, config
- Tier 3（必要になったら）: im, tap

追加で bytes, rand, url, insta も推奨し、採用された。

### Cargo.lock と semver の関係

「メジャーのみ指定だと更新されなくなるのでは」という質問があった。

- Cargo.lock で実際のバージョンは固定される
- `cargo update` しない限り勝手に更新されない
- Dependabot が毎週更新 PR を出すので放置問題はない

### リファクタリングの扱い

追加したクレートで既存コードを改善できる箇所を調査した結果、Display / From / FromStr の手動実装が多数あることが判明した。

結論: 今回の PR のスコープはクレート追加のみとし、リファクタリングは別 Issue（#233）で対応する。

## 学んだこと

- AI エージェント時代でも、開発者 ergonomics のために定番クレートを入れておく価値がある
- semver のバージョン指定は、1.x 以上とは 0.x 系で戦略を分けるのが合理的
- Cargo.lock + Dependabot で、バージョン固定と定期更新を両立できる

## 次のステップ

- PR #232 のレビュー対応
- Issue #233（derive_more/strum によるボイラープレート削減）は優先度低として保留
