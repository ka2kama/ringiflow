# ドメイン層クローン削減

## 概要

Epic #467 の Story #528 として、ドメイン層（`ringiflow-domain` crate）の jscpd 検出クローン 15 件の削減とファイルサイズ超過 5 件の解消を実施した。宣言型マクロ 2 種とテストヘルパー関数 2 種を導入し、10 ファイルで net 370 行削減（275 追加 / 645 削除）を達成した。

## 実施内容

### Phase 1: `define_uuid_id!` マクロ導入

7 つの UUID ID 型（TenantId, UserId, RoleId, WorkflowInstanceId, WorkflowDefinitionId, WorkflowStepId, WorkflowCommentId）が同一パターンで定義されていたため、`macro_rules!` マクロで統一した。

- `backend/crates/domain/src/macros.rs` を新規作成
- `lib.rs` に `#[macro_use] mod macros;` を追加
- 各ファイルの手動定義をマクロ呼び出しに置換

### Phase 2: `define_validated_string!` マクロ導入

3 つのバリデーション付き文字列型（UserName, WorkflowName, TenantName）が label と max_length のみ異なる同一パターンだったため、マクロで統一した。

- TenantName（`derive_more::Display`）と UserName/WorkflowName（手動 `Display` impl）の差異はマクロ内で手動 Display 生成に統一して吸収

### Phase 3-4: テストヘルパー `record_from` 導入

step.rs と instance.rs のテスト内で WorkflowStepRecord / WorkflowInstanceRecord の構築が繰り返されていたため、`record_from` ヘルパー関数を導入し、構造体更新構文 (`..record_from(&before)`) で差異のあるフィールドだけ指定する形に簡素化した。

### Phase 5: jscpd 検証

最終的なクローン数: 15 → 10。残存 10 クローンはビジネスロジックの構造的類似性やテストフィクスチャのパターンであり、更なる抽象化は可読性を損なうため許容とした。

## 判断ログ

- マクロ vs トレイト: derive 属性と `#[display]` をトレイトでは共通化できないため、`macro_rules!` を選択
- マクロ配置先: `shared` ではなく `domain` crate 内に配置。`Uuid`, `derive_more`, `serde`, `DomainError` 等のドメイン固有依存があるため
- Display impl 統一: `derive_more::Display` と手動 impl が混在していたため、マクロでは手動 Display 生成で統一。機能的に等価
- テストヘルパー方式: Builder パターンではなく、Rust の構造体更新構文 (`..base`) を活用。外部公開不要なテスト内ローカル関数で十分

## 成果物

- コミット: `e0dca35` — `#528 Reduce domain layer clones and file sizes with declarative macros`
- PR: #580（Draft）
- 変更ファイル: 10 ファイル（275 追加 / 645 削除）
  - 新規: `backend/crates/domain/src/macros.rs`
  - 変更: `lib.rs`, `tenant.rs`, `user.rs`, `role.rs`, `value_objects.rs`, `comment.rs`, `definition.rs`, `instance.rs`, `step.rs`
