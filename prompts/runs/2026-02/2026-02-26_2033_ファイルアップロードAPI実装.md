# ファイルアップロード API 実装

Issue: #881
PR: #935
計画ファイル: `prompts/plans/eventual-swimming-teapot.md`

## 概要

Presigned URL 方式のファイルアップロード API を全 6 Phase で実装した。Domain → Migration → Repository → UseCase → Core Handler → BFF Handler の順にボトムアップで積み上げ、17 ユニットテスト + 9 ハンドラテストで検証した。

## 実施内容

### Phase 1: ドメインモデル + ユニットテスト

`backend/crates/domain/src/document.rs` を作成。

- `DocumentId`（UUID v7）、`DocumentStatus`（Uploading/Active/Deleted）
- `UploadContext` enum で `folder_id` / `workflow_instance_id` の XOR 制約を型レベルで強制
- `FileValidation` で Content-Type（10 種）・サイズ（20MB）・ファイル数（10）・合計サイズ（100MB）のバリデーション
- `S3KeyGenerator` でテナント分離・コンテキスト別の S3 キーを生成
- `Document` エンティティに `new_uploading` / `confirm` 状態遷移メソッド
- ユニットテスト 17 項目

### Phase 2: マイグレーション

`backend/migrations/20260226000001_create_documents.sql` を作成。

- `documents` テーブル（RLS 付き、`NULLIF(current_setting('app.tenant_id', true), '')::UUID` パターン）
- CHECK 制約: `folder_id` と `workflow_instance_id` の XOR
- 部分インデックス: `folder_id WHERE NOT NULL`、`workflow_instance_id WHERE NOT NULL`、`status WHERE != 'deleted'`

### Phase 3: リポジトリ

`backend/crates/infra/src/repository/document_repository.rs` を作成。

- `DocumentRepository` trait（find_by_id, insert, update_status, count_and_total_size_by_folder/workflow）
- `PostgresDocumentRepository` 実装（`sqlx::query!` + `from_db` 復元で `UploadContext` 変換）

### Phase 4: ユースケース

`backend/apps/core-service/src/usecase/document.rs` を作成。

- `request_upload_url`: UploadContext 構築 → FileValidation → Document 作成 → DB 保存 → Presigned URL 生成
- `confirm_upload`: find_by_id → ステータス確認 → S3 head_object → Document::confirm → DB 更新

### Phase 5: Core Service ハンドラ + テスト

`backend/apps/core-service/src/handler/document.rs` を作成。

- `POST /internal/documents/upload-url` + `POST /internal/documents/{document_id}/confirm`
- `TODO(#881)` 解消: `_s3_client` → `s3_client`、DocumentState 構築
- ハンドラテスト 9 項目（正常系 2 + 準正常系 7）、StubDocumentRepository + StubS3Client

### Phase 6: BFF ハンドラ + クライアント

- `backend/apps/bff/src/client/core_service/document_client.rs`: `CoreServiceDocumentClient` trait（ISP パターン）
- `backend/apps/bff/src/handler/document.rs`: セッション認証 → Core Service 委譲 → Uuid→String ID 変換
- `client_impl.rs` のスーパートレイトに `CoreServiceDocumentClient` 追加
- `openapi.rs` にハンドラ登録（計 43 ハンドラ）
- OpenAPI スナップショットテスト更新（パス数 29→31）

### 品質ゲート

- `just openapi-generate` で `openapi/openapi.yaml` 再生成
- ベースライン更新: `FILE_SIZE_MAX_COUNT` 30→33、`MISSING_NATURE` 70→0
- 全チェック通過（S3 統合テストはローカル MinIO ポート設定の環境依存問題）

## 判断ログ

- 設計（Phase 1）: `UploadContext` enum を導入し、`folder_id` / `workflow_instance_id` の XOR 制約を型レベルで強制。DB の CHECK 制約と二重防御
- 設計（Phase 1）: `S3KeyGenerator` をドメイン層に配置。テナント分離・コンテキスト別パスの知識はビジネスルール
- 設計（Phase 1）: `Document::confirm(self, now)` で uploading→active の遷移を管理。非 uploading からの遷移はエラー
- Refactor: 各 Phase で既存の folder パターンとの整合性を確認。新しい抽象化や中間層の追加は不要と判断

## 成果物

コミット:
1. `#881 WIP: Implement file upload API`（空コミット）
2. `#881 Add Document domain model with unit tests`
3. `#881 Add documents table migration with RLS`
4. `#881 Add DocumentRepository trait and PostgreSQL implementation`
5. `#881 Add DocumentUseCaseImpl for upload URL and confirm`
6. `#881 Add document handler with 9 handler tests and S3Client injection`
7. `#881 Add BFF document handler and CoreServiceDocumentClient`
8. `#881 Regenerate OpenAPI spec with document endpoints`
9. `#881 Update baselines: FILE_SIZE_MAX_COUNT 30→33, MISSING_NATURE 70→0`

作成ファイル:
- `backend/crates/domain/src/document.rs`（614行）
- `backend/crates/infra/src/repository/document_repository.rs`（266行）
- `backend/apps/core-service/src/usecase/document.rs`（205行）
- `backend/apps/core-service/src/handler/document.rs`（620行）
- `backend/apps/bff/src/handler/document.rs`（165行）
- `backend/apps/bff/src/client/core_service/document_client.rs`（66行）
- `backend/migrations/20260226000001_create_documents.sql`（43行）

更新ファイル:
- `openapi/openapi.yaml`（+197行）
- `backend/apps/core-service/src/main.rs`（S3Client AppState 注入）
- `backend/apps/bff/src/main.rs`（DocumentState + ルート登録）
- `backend/apps/bff/src/openapi.rs`（ハンドラ + タグ登録）
- その他 BFF/Core Service の re-export、型定義等
