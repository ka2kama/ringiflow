# #537 Core Service ユースケース層リファクタリング

## 概要

Issue #537 の実装。Core Service ユースケース層に散在する重複パターン（エラーハンドリング、権限チェック）を共通ヘルパーに抽出し、大ファイル（decision.rs, lifecycle.rs）を機能別サブモジュールに分割した。

## 実施内容

### Phase 1: ヘルパーモジュール作成

`usecase/helpers.rs` を新規作成し、2つのヘルパーを実装:

- `FindResultExt` トレイト: `Result<Option<T>, InfraError>` → `Result<T, CoreError>` の変換。`or_not_found("エンティティ名")` でメソッドチェーン可能
- `check_step_assigned_to` 関数: ステップの担当者チェック（承認・却下・差し戻し共通）

6 ユニットテストを TDD で作成。

### Phase 2: ヘルパー適用

6ファイルに対してヘルパーを適用:

| ファイル | `or_not_found` | `check_step_assigned_to` | 備考 |
|---------|---------------|------------------------|------|
| decision.rs | ~10箇所 | 3箇所 | — |
| lifecycle.rs | 7箇所 | — | `InfraError::Conflict` は手動のまま |
| task.rs | 3箇所 | — | 特殊ケース（L156-163）は手動維持 |
| comment.rs | 1箇所 | — | — |
| query.rs | 4箇所 | — | — |
| dashboard.rs | — | — | `Option` を含まず対象外 |

### Phase 3: decision.rs の分割

1855行 → 3 サブモジュール:

- `decision/approve.rs` (681行): approve_step + 6テスト
- `decision/reject.rs` (676行): reject_step + 6テスト
- `decision/request_changes.rs` (595行): request_changes_step + 5テスト

### Phase 4: lifecycle.rs の分割

1278行 → 3 サブモジュール:

- `lifecycle/create.rs` (219行): create_workflow + 2テスト
- `lifecycle/submit.rs` (544行): submit_workflow + 4テスト
- `lifecycle/resubmit.rs` (611行): resubmit_workflow + 5テスト

### Phase 5: 検証

- ユニットテスト: 80件 pass
- 統合テスト: 2件 pass
- API テスト: 24ファイル / 148リクエスト / 100% pass

## 判断ログ

- 拡張トレイト（`FindResultExt`）を採用。自由関数よりメソッドチェーンが自然で、`anyhow::Context` パターンに準拠する
- task.rs の `check_step_assigned_to` 適用を見送り。エラーメッセージのドメインが異なる（「タスクにアクセス」vs「ステップを承認」）
- task.rs のファイル分割を見送り。production code ~225行で分割不要な規模。超過分はテストコード
- `get_task` L156-163 の特殊ケース（`CoreError::Internal` で NotFound 相当を返すデータ整合性チェック）は `or_not_found` でカバー不可のため手動維持

## 成果物

### コミット

| ハッシュ | メッセージ |
|---------|----------|
| `35a15ef` | Add FindResultExt trait and check_step_assigned_to helper |
| `4dde3dd` | Apply FindResultExt and check_step_assigned_to helpers across usecase layer |
| `3451fc6` | Split decision.rs into approve/reject/request_changes submodules |
| `9c944d9` | Split lifecycle.rs into create/submit/resubmit submodules |

### 作成/更新ファイル

- 新規: `usecase/helpers.rs`, `decision/{approve,reject,request_changes}.rs`, `lifecycle/{create,submit,resubmit}.rs`
- 更新: `usecase.rs`, `decision.rs`, `lifecycle.rs`, `task.rs`, `comment.rs`, `query.rs`
- ドキュメント: ナレッジベース（FindResultExt）、セッションログ
