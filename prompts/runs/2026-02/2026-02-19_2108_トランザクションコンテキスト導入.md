# トランザクションコンテキスト導入

Issue: #687（Epic #685 の Story）
Branch: `feature/687-transaction-context`
PR: #693

## 概要

ワークフローリポジトリの書き込みメソッドに `TxContext` を必須引数として追加し、トランザクションなしの書き込みをコンパイルエラーにする「構造的強制」を導入した。3 Phase 構成で実施。

## 実施内容

### Phase 1: TxContext + TransactionManager 定義 + ADR-051

- `TxContext` 構造体の定義（`infra/src/db.rs`）
  - `TxContextInner` enum: `Pg(sqlx::Transaction)` + `Mock`（`#[cfg(any(test, feature = "test-utils"))]`）
  - `begin_pg`（`pub(crate)`）、`commit`（`pub`）、`conn`（`pub(crate)`）、`mock`（`pub`）
- `TransactionManager` trait + `PgTransactionManager` impl
- `MockTransactionManager`（mock.rs）
- 統合テスト: begin/commit/rollback の検証
- ADR-051 作成

### Phase 2: tenant_id 修正

- `WorkflowInstanceRepository::update_with_version_check` に `tenant_id: &TenantId` 引数追加
- WHERE 句に `AND tenant_id = $N` 追加（RLS 二重防御）
- 全呼び出し元（5 use case + 統合テスト）を更新
- 統合テスト: 別テナント更新拒否テスト追加

### Phase 3: 構造的強制 — 書き込みメソッドに TxContext 必須化

- 4 つの書き込みメソッドに `tx: &mut TxContext` を第2引数として追加
  - `WorkflowInstanceRepository`: `insert`, `update_with_version_check`
  - `WorkflowStepRepository`: `insert`, `update_with_version_check`
- Postgres impl: `&self.pool` → `tx.conn()` に置換
- テスト用拡張 trait 追加: `WorkflowInstanceRepositoryTestExt`, `WorkflowStepRepositoryTestExt`
  - blanket impl で `insert_for_test`, `update_for_test` を提供
- `WorkflowUseCaseImpl` に `tx_manager: Arc<dyn TransactionManager>` フィールド追加
- main.rs に `PgTransactionManager` の DI 注入
- 全ユースケース: per-call TxContext パターン（#688/#689 で統合予定）
- 約 80 箇所のテストコード更新（MockTransactionManager 注入 + insert_for_test 移行）

## 判断ログ

- Phase 1: `conn()` に `#[allow(dead_code)]` を付与（Phase 3 で使用されるまでの暫定措置）。Phase 3 完了時に削除
- Phase 3: `clippy::too_many_arguments`（8/7）に対して `#[allow]` で対処。DI コンテナ不使用の手動 DI では引数増加は不可避。deps 構造体への統合は別 Issue で検討
- Phase 3: per-call TxContext パターンを採用。各 write 呼び出しが独立した TxContext を持つ暫定パターン。#688/#689 で同一 TxContext を共有する形に統合予定

## 成果物

### コミット

1. `#687 WIP: Introduce transaction context to repository layer` — 計画ファイル
2. `#687 Add TxContext, TransactionManager, and ADR-051` — Phase 1
3. `#687 Add tenant_id to WorkflowInstanceRepository::update_with_version_check` — Phase 2
4. `#687 Enforce TxContext on repository write methods` — Phase 3

### 作成・更新ファイル（主要）

| ファイル | 変更内容 |
|---------|---------|
| `infra/src/db.rs` | TxContext, TransactionManager, PgTransactionManager |
| `infra/src/mock.rs` | MockTransactionManager, Mock impl の TxContext 対応 |
| `infra/src/repository/workflow_*_repository.rs` | trait + impl の TxContext 必須化、拡張 trait |
| `core-service/src/usecase/workflow.rs` | tx_manager フィールド追加 |
| `core-service/src/usecase/workflow/command/**` | per-call TxContext パターン |
| `core-service/src/main.rs` | PgTransactionManager DI 注入 |
| `docs/05_ADR/051_*.md` | ADR-051: トランザクションコンテキストによる構造的強制 |
