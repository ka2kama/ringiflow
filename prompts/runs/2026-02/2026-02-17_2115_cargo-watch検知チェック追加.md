# cargo-watch 検知チェック追加

## 概要

Issue #606: `just dev-all`（cargo-watch）実行中に `just test-api` / `just check-all` を実行すると、Cargo パッケージキャッシュのロック競合により起動タイムアウトで失敗する問題への対策として、テスト/チェックスクリプトに cargo-watch 検知チェックを追加した。

## 実施内容

### cargo-watch 検知ロジックの実装

3 つのスクリプトに、cargo コマンド実行前の cargo-watch 検知チェックを追加した:

- `scripts/run-api-tests.sh`
- `scripts/run-e2e-tests.sh`
- `scripts/check-parallel.sh`

検知ロジック:

1. `pgrep -x cargo-watch` でプロセス名の完全一致検索
2. `/proc/<pid>/cwd` で作業ディレクトリを確認し、同一プロジェクトの cargo-watch のみ検知

### 設計上のポイント

- `pgrep -f`（フルコマンドライン検索）ではなく `pgrep -x`（プロセス名完全一致）を採用。`-f` はシェルラッパーの eval 文字列に "cargo-watch" が含まれる場合に自己マッチする問題がある
- `/proc/<pid>/cwd` による作業ディレクトリ判定で、別プロジェクトの cargo-watch を誤検知しない
- 3 箇所の重複は各 6 行程度のため、共有ライブラリ化は過度な抽象化と判断しスクリプト内で自己完結させた

## 判断ログ

- `pgrep -f` → `pgrep -x` に変更: テスト中に `bash -c` 経由の実行で自己マッチが発生したため。`-x` はプロセス名の完全一致で、実行バイナリ名 `cargo-watch` のみにマッチする
- プロジェクト判定の追加: ユーザーの指摘により、他プロジェクトの cargo-watch と区別する必要性を認識。`/proc/<pid>/cwd` でプロジェクトルートとの前方一致判定を追加した

## 成果物

- コミット: `#606 Detect cargo-watch before running cargo commands in test scripts`
- PR: #607
