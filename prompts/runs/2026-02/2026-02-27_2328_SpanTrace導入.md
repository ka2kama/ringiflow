# SpanTrace 導入（#972）

## 概要

エラー型に `tracing-error::SpanTrace` を導入し、エラー発生時に論理的な呼び出しパス（スパントレース）を自動記録する機能を実装した。3 Phase に分けて shared → infra → apps の依存順に実装。

Issue: #972
PR: #974

## 実施内容

### Phase 1: ErrorLayer の導入（shared crate）

- `tracing_error::ErrorLayer` を subscriber に追加
- `ErrorLayer` が `SpanTrace::capture()` の前提条件となる
- 既存テスト全通過を確認

### Phase 2: InfraError のリファクタリング（infra crate）

- `InfraError` を enum から struct wrapper パターンに変更
  - `InfraError`（struct）= `InfraErrorKind`（enum）+ `SpanTrace`
  - `std::io::Error` と同じ設計パターン
- パターンマッチの移行: `match err { InfraError::Variant => }` → `match err.kind() { InfraErrorKind::Variant => }`
- Convenience constructors で `SpanTrace::capture()` を自動実行
- `From` 実装（sqlx, redis, serde_json）でも自動キャプチャ
- テスト 13 件を追加（From 実装、convenience constructors、Display/source/kind/as_conflict）

### Phase 3: SpanTrace のログ出力（app crates）

- `CoreError`、`AuthError` の `IntoResponse` 実装にスパントレースフィールドを追加
- `error.span_trace` フィールドとしてエラーログに出力
- 開発環境（pretty モード）: 人間可読な形式
- 本番環境（JSON モード）: 構造化フィールド

### その他

- rebase 後に clippy `redundant_closure` 警告を修正
  - `.map_err(|e| InfraError::dynamo_db(e))` → `.map_err(InfraError::dynamo_db)`
  - convenience constructors は `impl Into<String>` を受け取るため、関数参照として直接渡せる

## 判断ログ

- struct wrapper パターン（`std::io::Error` と同じ struct + enum 構造）を採用した。thiserror の `#[from]` による自動生成と手動の `From` 実装を組み合わせ、SpanTrace の自動キャプチャを実現
- `InfraErrorKind` の公開範囲を `pub` に維持した。apps crate でのパターンマッチに必要なため
- `into_parts()` / `from_parts()` メソッドを追加した。ユースケース層で InfraError を分解して別のエラー型に変換するパターンに対応
- Refactor: `as_conflict()` ヘルパーを追加。`kind()` で borrow → 別 arm で `self` を move する所有権の競合を回避

## 成果物

### コミット

1. `b149af9e` #972 WIP: Introduce SpanTrace for error types（空コミット / Draft PR）
2. `f7e21882` #972 Add SpanTrace design section to Observability spec
3. `3a09b9b5` #972 Add tracing-error ErrorLayer to tracing subscriber
4. `145bb532` #972 Refactor InfraError to struct wrapper pattern with SpanTrace
5. `279355a7` #972 Fix overly broad deny pattern for credentials files
6. `267ed9f1` #972 Add SpanTrace to error log output in IntoResponse impls
7. `e4e81b82` #972 Fix redundant closure lint warnings in map_err calls

### 作成/更新ファイル

- `docs/03_詳細設計書/14_Observability設計.md` — SpanTrace 設計セクション追加
- `backend/crates/shared/src/observability.rs` — ErrorLayer 追加
- `backend/crates/infra/src/error.rs` — struct wrapper パターンに全面リファクタリング
- `backend/crates/infra/src/lib.rs` — `InfraErrorKind` の re-export 追加
- apps/usecase 各ファイル — `kind()` メソッドによるパターンマッチへの移行
- `backend/apps/core-service/src/error.rs`、`backend/apps/auth-service/src/error.rs` — span_trace ログ出力追加
