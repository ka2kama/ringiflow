# ライフサイクル系ユースケースのトランザクション統合

Issue: [#689](https://github.com/ka2kama/ringiflow/issues/689)
PR: [#707](https://github.com/ka2kama/ringiflow/pull/707)
Epic: [#685](https://github.com/ka2kama/ringiflow/issues/685)

## 概要

submit_workflow と resubmit_workflow の複数エンティティ更新を単一トランザクションに統合した。#688（判断系ユースケース）で確立したパターンをライフサイクル系ユースケースに適用し、部分更新による不整合リスクを解消した。

## 実施内容

### Phase 1-2: submit / resubmit のトランザクション統合

- `submit.rs`: instance update（1回） + step insert（N回）が個別トランザクションだったものを単一トランザクションに統合
- `resubmit.rs`: 同一パターンの変更を適用
- エラーハンドリング文言は #688 パターンに準拠

変更パターン:

```
// Before: 3+ トランザクション
TX1: instance_repo.update_with_version_check → commit
TX2: step_repo.insert → commit
TX3: step_repo.insert → commit
...

// After: 1 トランザクション
TX: instance_repo.update_with_version_check
    + step_repo.insert (N回ループ)
    → commit
```

### Phase 3: 統合テスト追加

`transaction_concurrency_test.rs` に原子性検証テストを追加:

- ステップ INSERT 失敗時（主キー重複）にインスタンス更新もロールバックされることを検証
- submit/resubmit のフロー（instance update → step insert）で INSERT 失敗が起きた場合のシナリオを模擬

## 判断ログ

- #688 パターンの踏襲を選択。新規の設計判断なし
- batch insert メソッドが存在しないため、ループ内で個別 `insert` を同一 `&mut tx` に対して呼び出すパターンを採用（#688 の reject/request_changes と同一）
- snake_case 警告: テスト関数名の `INSERT` を `insert` に修正

## 成果物

### コミット

| コミット | 内容 |
|---------|------|
| `c2d8d91` | submit.rs + resubmit.rs のトランザクション統合 |
| `09a22d0` | 統合テスト追加（INSERT ロールバック原子性） |
| `cfdb056` | 計画ファイル追加 |

### 変更ファイル

- `backend/apps/core-service/src/usecase/workflow/command/lifecycle/submit.rs`
- `backend/apps/core-service/src/usecase/workflow/command/lifecycle/resubmit.rs`
- `backend/crates/infra/tests/transaction_concurrency_test.rs`
- `prompts/plans/689_lifecycle-usecase-transaction.md`
