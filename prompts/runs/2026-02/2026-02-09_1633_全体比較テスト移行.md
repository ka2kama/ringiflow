# #334 全体比較テスト移行

## 概要

ドメインエンティティに `PartialEq` + `Eq` を derive し、テストをフィールド単位アサーションから全体比較（`assert_eq!(result, expected)`）に移行した。7 エンティティ + `DashboardStats` に derive を追加し、ドメイン層 16 テスト（うち 6 テスト統合）+ ユースケース層 1 テストを移行した。

## 背景と目的

Issue #334。フィールド単位のアサーションは、新フィールド追加時に既存テストが壊れず、バグが暗黙にすり抜ける構造的な問題がある。全体比較に移行することで、テストの自己メンテナンス性を確保する。

## 実施内容

### Phase 1: `PartialEq, Eq` の derive 追加

7 エンティティ（`User`, `Tenant`, `WorkflowDefinition`, `WorkflowInstance`, `WorkflowStep`, `Role`, `UserRole`）と `DashboardStats` に `PartialEq, Eq` を derive。

### Phase 2: ドメイン層テストの全体比較移行

| ファイル | 移行テスト数 | 統合テスト数 | 備考 |
|---------|------------|------------|------|
| `user.rs` | 3 | 0 | `with_status`, `deleted`, `with_last_login_updated` |
| `tenant.rs` | 1 | 0 | `from_db` 復元テスト |
| `workflow.rs` (instance) | 7 | 2 | 初期状態、申請、承認、却下、取消 3 件 |
| `workflow.rs` (step) | 6 | 3 | 初期状態、アクティブ化、承認、コメント付き承認、却下、差戻し |
| `workflow.rs` (definition) | 2 | 0 | 公開、アーカイブ |
| `role.rs` | 1 | 1 | 初期状態 |

移行しなかったテスト: ブーリアンロジック（`is_active()` 等）、異常系（`is_err()`）、バリデーション。

### Phase 3: ユースケース層テスト移行

`DashboardStats` の「タスクがない場合はすべて 0 を返す」テストのみ移行。他のユースケース層テストは `Utc::now()` の時刻制御問題により対象外（Clock DI 導入後に対応）。

## 設計上の判断

| 判断 | 選択 | 理由 |
|------|------|------|
| テスト移行パターンの分類 | A: 状態変更→全体比較、B: ブーリアン→移行しない、C: 統合 | テストの意図が全体比較で不明確になるものは移行しない |
| `pretty_assertions` の配置 | 各サブモジュールに個別 import | 親モジュールに置くと `use super::*` で `assert_eq` が ambiguous になる |
| ユースケース層の対象範囲 | `DashboardStats` のみ | 他は `Utc::now()` 問題で全体比較が非決定的になる |

## 判断ログ

| 種別 | 判断 | 背景 |
|------|------|------|
| 発見 | `completed()` は version を非インクリメント、`approve()`/`reject()` はインクリメント | 差戻しテストの全体比較で version 不一致として検出。`..self` で残余フィールドを引き継ぐパターンの差異 |
| 発見 | `submitted()` 後のステータスは `Pending`（`Submitted` ではない） | 全体比較テスト作成時に実装を確認して判明 |
| 軌道修正 | `pretty_assertions` を親モジュールではなくサブモジュールに配置 | 親に配置すると `use super::*` で標準の `assert_eq` と ambiguous エラー |

## 成果物

コミット:
- `9fb3c33` Phase 1: Derive PartialEq and Eq for all entity types
- `6f58542` Phase 2: Migrate domain tests to whole-object comparison
- `879ed40` Phase 3: Migrate DashboardStats test to whole-object comparison

PR: #336

## 議論の経緯

特筆すべき議論なし。計画承認後、実装を進めた。

## 学んだこと

- 全体比較テストは、メソッド間の微妙な挙動の違い（version インクリメントの有無）を自動的に検出する。フィールド単位アサーションでは version を検証していないテストではこの差異が暗黙にすり抜けていた
- テスト統合（version テスト + ステータステスト → 1 つの全体比較テスト）により、テスト数は減るが検証範囲は拡大する
- `pretty_assertions` のスコープ管理: `use super::*` を使うテストモジュール構造では、import の配置場所に注意が必要

## 次のステップ

- Clock DI 導入後に、ユースケース層テスト（task.rs, workflow.rs）の全体比較移行を検討
