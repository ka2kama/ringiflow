# E2E テストデバッグとステータス表示修正

Issue: #724
PR: #734
ブランチ: `feature/724-workflow-definition-management`

## 概要

ワークフロー定義管理画面（#724）の E2E テスト実行中に発覚した複数の不具合を調査・修正した。特にステータス表示の不具合では 7 つの仮説を系統的に検証し、Rust の `Debug` フォーマットと Elm のデコーダ間のケース不一致（PascalCase vs lowercase）が根本原因であることを特定した。修正後、main ブランチとのリベースとコンフリクト解消も実施した。

## 実施内容

### E2E テストの段階的デバッグ

E2E テスト「テナント管理者が定義を公開・アーカイブできる」の実行中に 5 つのエラーに順に遭遇し、それぞれ修正した。

| # | エラー | 原因 | 修正 |
|---|--------|------|------|
| 1 | strict mode violation | `<button>` 内にインタラクティブ要素 | ボタンのセレクタを `getByRole` に変更 |
| 2 | ダイアログ操作が失敗 | ページ遷移完了前に操作 | `waitForURL` でページロード待機を追加 |
| 3 | 作成ダイアログが閉じない | `closeDialogAndClearForm` のステート更新順序 | `ClearCreateFormAndCloseDialog` パターンで一括リセット |
| 4 | 公開操作が 400 エラー | `definition` フィールドが空 JSON | 開始ステップを含むデフォルト定義を設定 |
| 5 | 公開後にステータスが「下書き」のまま | Debug フォーマットのケース不一致 | Elm 側を PascalCase に統一 |

### エラー 5 の系統的調査（7 仮説の検証）

ステータスが「公開済み」に更新されない問題について、レイヤーごとに 7 つの仮説を立てて検証した。

1. Core Service クライアントの実装差異 → 棄却（同じ `CoreServiceClientImpl`）
2. ドメインモデルの `published()` → 棄却（正しく `Published` を設定）
3. DB の UPDATE 文の失敗 → 棄却（API テスト通過済み）
4. ブラウザのキャッシュ → 棄却（`Cache-Control: no-store` 追加後も再現）
5. BFF ルーティングの問題 → 棄却（正しいエンドポイント）
6. Core Service 内部のルーティング不一致 → 棄却（正しい設定）
7. `format!("{:?}", ...)` が PascalCase を生成、Elm が lowercase を期待 → **支持**

根本原因: `format!("{:?}", def.status())` は Rust の `Debug` トレイトを使用し、enum バリアント名をそのまま出力する（`"Published"`）。ドメインモデルの `#[strum(serialize_all = "lowercase")]` は `Display` トレイトにのみ影響し、`Debug` には効かない。Elm 側の `statusFromString` は `"published"` を期待しており、`_ -> Draft` のフォールバックが `"Published"` を `Draft` に変換していた。

修正: Elm 側を PascalCase に統一（既存の `WorkflowInstance` モジュールと整合）。

### Cache-Control ミドルウェアの追加

仮説 4 の検証過程で BFF に `Cache-Control: no-store` ミドルウェアを追加した。結果的にステータス問題の原因ではなかったが、API レスポンスのキャッシュ防止として有用なため残置した。

- `backend/apps/bff/src/middleware/cache_control.rs`: `from_fn` ベースのミドルウェア
- `backend/apps/bff/src/main.rs`: ルーターに `no_cache` レイヤーを追加

### main ブランチとのリベース

PR #733（#725 ワークフローデザイナーキャンバス）がマージされたため、リベースを実施。3 ファイル・12 箇所のコンフリクトを解消した。

| ファイル | コンフリクト | 解消方針 |
|---------|------------|---------|
| `Component/Icons.elm` | 両ブランチが新規アイコンを追加 | 両方のアイコンを保持 |
| `Route.elm` | 両ブランチが新規ルートを追加（5 箇所） | 両方保持。パーサー順序は具体的なルートを先に配置 |
| `Main.elm` | 両ブランチが Page/Msg/update/view を追加（6 箇所） | 両方保持。`isRouteActive` で親子関係を設定 |

## 判断ログ

- Elm 側を PascalCase に合わせる方針を選択（バックエンドの `Debug` フォーマットを変更する案もあったが、既存の `WorkflowInstance` が PascalCase パターンを使用しており、フロントエンド内の一貫性を優先）
- Cache-Control ミドルウェアは問題の原因ではなかったが、API レスポンスのキャッシュ防止のベストプラクティスとして残置
- リベース時のルートパーサー順序: `/workflow-definitions/new`（具体的）を `/workflow-definitions`（汎用的）より前に配置（Elm の URL パーサーは先頭一致で最初にマッチしたルートを採用するため）
- `isRouteActive` に `WorkflowDefinitions` → `WorkflowDefinitionDesignerNew` の親子関係を追加（サイドバーのアクティブ状態表示のため）

## 成果物

### コミット

- `5929faa` #724 Add Cache-Control no-store middleware for API responses
- `c2958f8` #724 Fix status string case mismatch between backend and frontend

### 作成・更新ファイル

| ファイル | 種別 |
|---------|------|
| `backend/apps/bff/src/middleware/cache_control.rs` | 新規 |
| `backend/apps/bff/src/middleware.rs` | 変更 |
| `backend/apps/bff/src/main.rs` | 変更 |
| `frontend/src/Data/WorkflowDefinition.elm` | 変更 |
| `frontend/src/Page/WorkflowDefinition/List.elm` | 変更 |
| `frontend/tests/Data/WorkflowDefinitionStatusTest.elm` | 変更 |
| `frontend/src/Component/Icons.elm` | 変更（リベース） |
| `frontend/src/Main.elm` | 変更（リベース） |
| `frontend/src/Route.elm` | 変更（リベース） |

### 関連ドキュメント

- 調査記録: [E2E テスト: 公開後にステータスが「下書き」のまま表示される](../../../process/investigations/2026-02/2026-02-20_2211_E2Eテスト公開後ステータス表示不具合.md)
