# #333 dyn Trait DI 移行

## 概要

リポジトリ DI を静的ディスパッチ（ジェネリクス）から動的ディスパッチ（`Arc<dyn Trait>`）に移行し、全3サービスのジェネリクス汚染を解消した。22ファイル変更、net -494行。

## 背景と目的

Issue #333。全サービスでジェネリクスが UseCase → Handler → main.rs へと伝播し、以下の問題が発生していた:

- `WorkflowUseCaseImpl<D, I, S, U, C>` — 5個の型パラメータ
- core-service の main.rs に 20 個以上の turbofish アノテーション
- Handler 関数ごとに where 句でトレイト境界を繰り返す冗長さ

`Arc<dyn Trait>` パターンに統一し、アプリケーションコードのシンプルさを回復することが目的。

## 実施内容

3 Phase で段階的に移行した。

### Phase 1: Core Service

- `WorkflowUseCaseImpl<D, I, S, U, C>` → `WorkflowUseCaseImpl`（5型パラメータ除去）
- `TaskUseCaseImpl<I, S, U>` → `TaskUseCaseImpl`（3型パラメータ除去）
- `DashboardUseCaseImpl<I, S>` → `DashboardUseCaseImpl`（2型パラメータ除去）
- `UserState<R, T>` → `UserState`（2型パラメータ除去）
- 未使用の `WorkflowUseCase` トレイト + blanket impl を削除
- `resolve_user_names` の引数を `&impl UserRepository` → `&dyn UserRepository` に変更
- main.rs の turbofish 全除去、`Arc<dyn Repo>` での初期化に変更

### Phase 2: Auth Service

- `AuthUseCaseImpl<R, P>` → `AuthUseCaseImpl`（2型パラメータ除去）
- `AuthUseCase` トレイトは維持し、`AuthState` が `Arc<dyn AuthUseCase>` を保持
- blanket impl → 具象 impl に変更

### Phase 3: BFF

- `AuthState<C, A, S>` → `AuthState`（3型パラメータ除去）
- `WorkflowState<C, S>` → `WorkflowState`（2型パラメータ除去）
- `CsrfState<S>` → `CsrfState`（1型パラメータ除去、`#[derive(Clone)]` で対応）
- `get_session` ヘルパーを `&S where S: SessionManager` → `&dyn SessionManager` に変更
- main.rs の約20個の turbofish 除去
- 統合テスト（`auth_integration_test.rs`）も同様に更新

## 設計上の判断

### Auth Service で `AuthUseCase` トレイトを維持した理由

Core Service の UseCase は Handler が具象型を直接保持しているが、Auth Service は既にハンドラテストが `StubAuthUseCase` を使用する設計だった。トレイトを削除すると:
- テストパターンの変更が必要になる
- ハンドラと UseCase 実装が密結合になる

影響を最小限にし、既存のテスト設計パターンを活かすため維持した。

### `get_session` ヘルパーの引数変更

BFF の `get_session` は当初ジェネリクス `<S: SessionManager>` だったが、`Arc<dyn SessionManager>` から呼び出す際に型が合わない問題が発生した。`Arc<dyn Trait>` 自体は `Trait` を実装しないため、`&dyn SessionManager` に変更し、呼び出し側で `Arc::as_ref()` を使用する設計にした。

### DevAuth 互換性の確保

BFF の `setup_dev_session<S: SessionManager>(session_manager: &S)` はジェネリクスを使用している。dev_auth モジュールの変更を避けるため、`RedisSessionManager` を具象型のまま保持して DevAuth 処理を完了し、その後 `Arc<dyn SessionManager>` にラップする構成にした。

## 判断ログ

| 種別 | 判断 | 背景 |
|------|------|------|
| 発見 | `Arc<dyn Trait>` は `Trait` を実装しない | BFF の `get_session` で `&Arc<dyn SessionManager>` がトレイト境界を満たさない |
| 設計修正 | `get_session` を `&dyn SessionManager` に変更 | 12箇所の呼び出しを `as_ref()` に統一 |
| 設計修正 | DevAuth は具象型で処理後に Arc でラップ | dev_auth モジュールへの変更を回避 |

## 成果物

- コミット: `239ce4d` — #333 Adopt dynamic dispatch (dyn Trait) for repository DI
- 計画ファイル: `prompts/plans/wild-fluttering-quilt.md`
- PR: #335（Draft）
- ナレッジベース: `docs/06_ナレッジベース/rust/動的ディスパッチDI.md`

## 議論の経緯

### 計画レビュー

ユーザーに計画を提示し、3 Phase 構成（Core Service → Auth Service → BFF）で承認を得た。Auth Service の `AuthUseCase` トレイト維持、`CsrfState` の `Clone` 対応なども計画段階で詳細に設計済み。

## 学んだこと

- `Arc<dyn Trait>` は `Trait` を直接実装しない。`Arc::as_ref()` で `&dyn Trait` を取得する必要がある
- `Arc<dyn Trait>` は `Clone` を実装するため、axum の `from_fn_with_state` が要求する `Clone` 制約を自然に満たす
- ジェネリクス除去により main.rs のコードが劇的にシンプルになる（turbofish 20 個 → 0 個）
- 静的ディスパッチ → 動的ディスパッチの移行は段階的に実施でき、サービス単位での独立テストが有効

## 次のステップ

- PR #335 の CI 確認後、Ready for Review → マージ
