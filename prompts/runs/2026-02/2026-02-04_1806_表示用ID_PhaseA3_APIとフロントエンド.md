# 表示用 ID Phase A-3: API + フロントエンド

## 概要

表示用 ID（`WF-42` 形式）を API レスポンスとフロントエンドに反映した。Core Service DTO → BFF DTO → OpenAPI 仕様 → Hurl テスト → Elm デコーダー → Elm UI の 6 レイヤーにわたるフルスタック変更を実施。

Issue: [#207](https://github.com/ka2kama/ringiflow/issues/207)
PR: [#220](https://github.com/ka2kama/ringiflow/pull/220)

## 背景と目的

Phase A-1（DB スキーマ）と Phase A-2（採番サービス）が完了し、ドメイン層で `display_number` が自動採番されるようになった。Phase A-3 では、この値を `DisplayId::new(prefix, number).to_string()` で `"WF-42"` 形式の文字列に変換し、API レスポンスとフロントエンドに反映する。

## 実施内容

### バックエンド（Step 1-2）

1. Core Service の `WorkflowInstanceDto` に `display_id` フィールドを追加
   - `from_instance()` と `from_workflow_with_steps()` の両方で `DisplayId::new()` を使って構築
2. Core Service の `WorkflowSummaryDto`（タスク一覧用）にも同様に追加
3. BFF のクライアント DTO（`Deserialize`）とハンドラ DTO（`Serialize`）に `display_id` をパススルー

### API 仕様・テスト（Step 3-4）

4. OpenAPI 仕様書の `WorkflowInstance` と `TaskWorkflowSummary` スキーマに `display_id` プロパティを追加
5. Hurl テストに `jsonpath "$.data.display_id" exists` アサーションを追加

### フロントエンド（Step 6-7）

6. Elm `WorkflowInstance` 型 + デコーダーに `displayId` フィールドを追加（TDD）
7. Elm `Task.WorkflowSummary` 型 + デコーダーに `displayId` フィールドを追加
8. テストフィクスチャを更新し 139 テスト全通過を確認
9. ワークフロー一覧: ID 列を追加（`workflow.displayId`）
10. ワークフロー詳細: タイトル横に表示用 ID を表示（`span` で薄い色）
11. タスク一覧: ワークフロータイトルに表示用 ID を併記（`task.workflow.displayId ++ " " ++ task.workflow.title`）

## 設計上の判断

### 1. `display_id` の構築場所を Core Service DTO 層に配置

ドメインモデルは `display_number: DisplayNumber`（連番）を保持し、表示用文字列（`"WF-42"`）への変換は DTO 変換時に行う。BFF は文字列をそのままパススルーする。

理由: ドメインモデルにプレゼンテーション層の関心を混入させない。

### 2. タスク一覧の `display_id` をネスト構造に配置

設計書では `workflow_display_id`（トップレベル）と記載されていたが、既存実装はワークフロー情報を `workflow` オブジェクト内にネストしている。`workflow.display_id` として追加し、既存パターン（`workflow.id`, `workflow.title`）との一貫性を保った。

### 3. YAML の description にコロンを含む値をクォート

OpenAPI 仕様書で `description: 表示用 ID（例: WF-42）` と書いたところ、YAML パーサーが `例:` を別のマッピングキーとして解釈し、パースエラーになった。double quote で囲んで解決。

## 成果物

### コミット

```
dfb7769 #207 WIP: Add display_id to API responses and frontend
11f1191 #207 Add display_id field to workflow DTOs across all layers
8e88356 #207 Update OpenAPI spec and Hurl tests for display_id
33ff8c3 #207 Add displayId to Elm types, decoders, and views
1abe559 #207 Add improvement record: auto-review wait after force push
```

### 変更ファイル（15 ファイル）

| ファイル | 変更内容 |
|---------|---------|
| `backend/apps/core-service/src/handler/workflow.rs` | `WorkflowInstanceDto` に `display_id` + 構築ロジック |
| `backend/apps/core-service/src/handler/task.rs` | `WorkflowSummaryDto` に `display_id` + 構築ロジック |
| `backend/apps/bff/src/client/core_service.rs` | クライアント DTO に `display_id` 追加 |
| `backend/apps/bff/src/handler/workflow.rs` | ハンドラ DTO に `display_id` + From impl |
| `backend/apps/bff/src/handler/task.rs` | ハンドラ DTO に `display_id` + From impl |
| `openapi/openapi.yaml` | 2 スキーマに `display_id` プロパティ追加 |
| `tests/api/hurl/workflow/create_workflow.hurl` | `display_id` exists アサーション |
| `tests/api/hurl/workflow/submit_workflow.hurl` | `display_id` exists アサーション |
| `frontend/src/Data/WorkflowInstance.elm` | 型 + デコーダーに `displayId` |
| `frontend/src/Data/Task.elm` | `WorkflowSummary` 型 + デコーダーに `displayId` |
| `frontend/tests/Data/WorkflowInstanceTest.elm` | JSON フィクスチャ + アサーション更新 |
| `frontend/src/Page/Workflow/List.elm` | テーブルに ID 列追加 |
| `frontend/src/Page/Workflow/Detail.elm` | タイトル横に表示用 ID |
| `frontend/src/Page/Task/List.elm` | ワークフロータイトルに表示用 ID 併記 |

## 議論の経緯

### 設計書との不一致

設計書ではタスク一覧に `workflow_display_id` をトップレベルフィールドとして定義していたが、既存実装が `workflow` オブジェクトのネスト構造を使っていたため、`workflow.display_id` として追加した。設計書の意図（タスク一覧にワークフローの表示用 ID を含める）は満たしている。

## 学んだこと

1. YAML では値にコロン + スペース（`: `）を含む場合、クォートが必要。OpenAPI の description フィールドで「例: WF-42」と書くと、`例:` がマッピングキーとして誤解釈される
2. Elm の Pipeline Decoder ではフィールド追加時に型エイリアスとデコーダーの順序を厳密に一致させる必要がある。順序がずれるとコンパイルエラーではなく実行時のデコードエラーになる場合がある
3. フルスタック変更では、6 レイヤーの型定義を一貫して更新する必要があり、1 箇所でも漏れると Silent Failure（optional フィールドの null デフォルト値にフォールバック）が発生しうる

## 次のステップ

- PR #220 の CI 確認、E2E 手動テスト、マージ
- Phase B（workflow_steps への展開）は別 Issue で実施予定
