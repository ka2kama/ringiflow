# 2026-02-02 表示用 ID Phase A-1: DB スキーマ変更

## 概要

Issue #205: ワークフローインスタンスの表示用 ID（`WF-42` 形式）を実現するための DB スキーマ変更を実装した。3段階マイグレーション、`DisplayNumber` 値オブジェクト（TDD）、リポジトリ・ユースケース修正、テナント退会時データ削除設計の更新を含む。

## 背景と目的

ワークフローインスタンスは内部 ID として UUID v7 を使用しているが、ユーザーにとって可読性が低い。`WF-42` のようなテナント内で一意な連番 ID を導入するため、まず DB スキーマとドメインモデルの基盤を整備する。

親 Epic: #204（表示用 ID）
設計書: `docs/03_詳細設計書/12_表示用ID設計.md`

## 実施内容

| Step | 内容 | 変更ファイル数 |
|------|------|--------------|
| 1 | ブランチ作成 + Draft PR | 0 |
| 2 | マイグレーション 3 ファイル | 3（新規） |
| 3 | `DisplayNumber` 値オブジェクト（TDD） | 1 |
| 4 | `WorkflowInstance` モデル修正 | 1 |
| 5 | リポジトリ + 統合テスト修正 | 3 |
| 6 | ユースケース修正 | 3 |
| 7 | data-store ルール確認 + 全体チェック | 1 |

合計: 18 ファイル変更（+408 行 / -70 行）

## 設計上の判断

### 3段階マイグレーション

DDL（カラム追加）→ データ移行 → DDL（NOT NULL）の 3 段階に分割した。

理由:
- PostgreSQL では `ALTER COLUMN SET NOT NULL` は既存データが NULL でないことを要求する
- 1 ファイルにまとめると、NULLABLE カラム追加 → データ投入 → NOT NULL 化の順序依存が暗黙になる
- 3 ファイルに分けることで、各ステップの意図が明確になる

### NOT NULL を Phase A-1 に含めた

設計書では Phase A-2（採番サービス）で NOT NULL 化する案もあったが、Phase A-1 で適用した。

理由:
- Issue #205 の完了基準に NOT NULL が明記されている
- NULLABLE 期間を作ると NULL データ混入リスクが生じる
- 割れ窓理論: NULLABLE を放置するパターンが後続に伝播するリスク

### 暫定 display_number の生成方法

当初 `DisplayNumber::new(1).unwrap()` を計画していたが、CI の API テスト（Hurl）でシードデータとユニーク制約が衝突する問題が発生した。`Utc::now().timestamp_millis()` に変更して一意性を確保した。

Phase A-2 で正式な採番サービス（`SELECT FOR UPDATE` + カウンター更新）に置き換える。

### `DisplayNumber` の設計: `Version` パターンの踏襲

既存の `Version(u32)` 値オブジェクトと同じパターンで `DisplayNumber(i64)` を設計した。

| 要素 | Version | DisplayNumber |
|------|---------|---------------|
| 内部型 | `u32` | `i64` |
| コンストラクタ | `new(u32) → Result` | `new(i64) → Result` |
| DB アクセサ | `as_i32()` | `as_i64()` |
| DB 復元 | `TryFrom<i32>` | `TryFrom<i64>` |
| 表示 | `"v1"` | `"42"` |

`initial()` は追加しなかった。Version は常に 1 から始まるが、DisplayNumber はカウンターから取得する値であり「初期値」の概念が異なるため。

## 成果物

コミット:
- `d090348` #205 WIP: Add display_number schema
- `180ddf7` #205 Add display_number schema migrations
- `55daf2d` #205 Implement DisplayNumber value object and update existing code
- `357256d` #205 Fix display_number unique constraint violation in API tests
- `83d9ebf` #205 Add improvement record for test scope gap between local and CI

PR: [#215](https://github.com/ka2kama/ringiflow/pull/215)

関連 Issue:
- #205 表示用 ID: DB スキーマ変更（Phase A-1）
- #204 表示用 ID（親 Epic）
- #216 自己検証チェックリスト改善（本セッションで発見した問題）

## 議論の経緯

### 自己検証プロトコルの実施漏れ

コミット後にユーザーから「自己検証は指摘ゼロまで回したか？」と指摘された。Phase 完了後の実装チェックリスト（全体通し）を明示的に走らせずにコミットしていた。事後検証では指摘ゼロだったが、プロセスとしてはコミット前に実施すべきだった。

### API テスト失敗の原因分析

CI の API テスト失敗を受けて「なぜチェックが漏れたか？」をユーザーから問われた。根本原因を分析し、`check-all` と CI のテストスコープの差異（Mock vs 実 DB + シードデータ）を特定した。改善記録を作成し、恒久対策の Issue #216 を発行した。

## 学んだこと

- ローカルの `check-all` と CI のテストスコープは異なる。特に API テスト（Hurl）は実 DB + シードデータを使うため、ユニーク制約違反などを検出できるが、ローカルでは実行されない
- 暫定値やワークアラウンドを採用する際は「その値が通る全パス」を洗い出し、各パスで問題がないことを確認する必要がある
- 自己検証チェックリストの「レイヤー間接続」は出力方向（レスポンス）だけでなく入力方向（DB 書き込み制約）も含めて確認すべき

## 発見した問題

- 自己検証チェックリストの項目 5「レイヤー間接続」が出力方向のみの確認になりやすい → Issue #216 で対策

## 次のステップ

- CI 通過後に `gh pr ready` で PR を Ready for Review に変更
- Phase A-2: 採番サービスの実装（`SELECT FOR UPDATE` + カウンター更新）
- Phase A-3: API レスポンスへの `display_id` フィールド追加 + フロントエンド表示
