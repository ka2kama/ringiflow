# 表示用番号 URL パラメータ対応

## 概要

Issue #229 の全 Phase（1-5）を完了し、BFF の公開 API の URL パスパラメータを UUID から display_number（整数）に変更した。また、self-review.md に理想駆動の検証ループを追加した。

## 背景と目的

- URL を人間可読にする（UUID は長く、口頭伝達やチャット共有に不向き）
- UI と URL の一致（ユーザーが画面で見る番号と URL が同じ）
- エンタープライズツールの標準パターン（GitHub `/issues/42`、Jira `/browse/PROJ-123`）

```
Before: /api/v1/workflows/01924f3e-7a8b-7000-8000-000000000001
After:  /api/v1/workflows/42
```

## 実施内容

### Issue #229: 表示用番号 URL パラメータ対応

| Phase | 内容 |
|-------|------|
| 1 | リポジトリ層に `find_by_display_number` を追加 |
| 2 | Core Service に display_number 対応の新規エンドポイント追加（4件） |
| 3 | BFF のハンドラを display_number ベースに変更 |
| 4 | フロントエンドの Route を `String` → `Int` に変更、API 呼び出しを更新 |
| 5 | OpenAPI 仕様と Hurl テストを更新 |

### self-review.md の理想駆動フロー追加

- 検証ループを「理想状態（To-Be）と現状（As-Is）のギャップがゼロになるまで繰り返す」形式に改善
- 全チェックリストに「理想状態（To-Be）」列を追加
- To-Be の確定タイミングと更新条件を明文化

## 設計上の判断

### ID 解決アプローチ: 方案 C（新規エンドポイント）を採用

| 方案 | 概要 | 採否 |
|------|------|------|
| A: 2段階呼び出し | BFF が解決 API → 既存 API を順次呼び出し | ❌ パフォーマンス劣化 |
| B: 既存 API を両対応 | UUID と display_number のどちらでも受け付ける | ❌ 型安全性低下 |
| **C: 新規エンドポイント** | display_number 専用のエンドポイントを追加 | ✅ 採用 |
| D: クエリパラメータ拡張 | `?display_number={dn}` で検索 | ❌ REST セマンティクス |

理由: 1回の呼び出しで完結 + 型安全性を維持 + 既存 API は変更しない

### API レスポンスに display_number フィールドを追加

displayId（例: "WF-42"）からのパースではなく、API が直接 display_number を提供する設計を採用。理由:
- Single Source of Truth
- フォーマット変更時も壊れない

## 成果物

### コミット

```
3e72149 #229 WIP: Use display_number in URL path parameters
4567c9a #229 Add find_by_display_number to repositories and Core Service endpoints
2e514e5 #229 Implement display_number support in BFF public API (Phase 3)
75af1fe #229 Add display_number to API response and update frontend routing (Phase 4)
06bd72c #229 Update OpenAPI spec and Hurl tests for display_number (Phase 5)
```

### 変更ファイル（主要なもの）

| レイヤー | ファイル |
|---------|----------|
| リポジトリ | `workflow_instance_repository.rs`, `workflow_step_repository.rs` |
| Core Service | `handler/workflow.rs`, `usecase/workflow.rs` |
| BFF | `client/core_service.rs`, `handler/workflow.rs` |
| フロントエンド | `Route.elm`, `Api/Workflow.elm`, `Page/Workflow/*.elm` |
| 仕様 | `openapi/openapi.yaml` |
| テスト | `tests/api/hurl/workflow/*.hurl` |

## 議論の経緯

### 理想駆動の検証ループ

検証が「ループ」になっているかについて議論。現状の self-review.md には「指摘がゼロになるまで繰り返す」とあるが、何をもって「指摘ゼロ」とするかが曖昧だった。

解決策として、チェックリストに「理想状態（To-Be）」列を追加し、ギャップがゼロになるまで繰り返す形式に改善した。

### To-Be の確定と更新タイミング

To-Be をいつ確定し、いつ更新するかについて議論。

- 確定: 各フェーズの開始時（探索完了後、テスト前など）
- 更新条件: より良い理想状態の発見、外部からの要件変更、技術的制約の発見、探索での新知見

「より良い To-Be が見つかったとき」も更新条件に追加。理想を「上げる」変更は正当。

## 学んだこと

1. **Elm の型システムが変更箇所を自動検出**: Route.elm で `WorkflowDetail String` → `WorkflowDetail Int` に変更したら、コンパイラが全ての関連箇所を指摘してくれた
2. **理想駆動の検証ループには「理想状態の明示」が必須**: 収束条件が曖昧だと「なんとなく OK」で終わる

## 次のステップ

- PR を Ready for Review にする
- マージ後、Issue #229 をクローズ
