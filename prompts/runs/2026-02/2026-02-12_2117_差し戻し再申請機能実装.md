# 差し戻し・再申請機能実装

Issue: [#476](https://github.com/ka2kama/ringiflow/issues/476)
PR: [#488](https://github.com/ka2kama/ringiflow/pull/488)
計画: [476_request-changes-resubmit.md](../../plans/476_request-changes-resubmit.md)

## 概要

承認者が申請を差し戻し（request-changes）、申請者が修正して再申請（resubmit）できるバックエンド機能を実装した。6 Phase にわたり、ドメインモデル → ユースケース → Core Service → BFF → OpenAPI → API テストを構築した。

## 実施内容

### Phase 1: ドメインモデル + DB マイグレーション

- `WorkflowInstanceStatus::ChangesRequested` バリアントを追加
- `complete_with_request_changes(now)`: InProgress → ChangesRequested（completed_at は設定しない）
- `resubmitted(form_data, step_id, now)`: ChangesRequested → InProgress
- `WorkflowStep::request_changes(comment, now)`: Active → Completed(RequestChanges)
- DB マイグレーション: `workflow_instances.status` CHECK 制約に `changes_requested` を追加
- ユニットテスト 8 件追加

### Phase 2: ユースケース層

- `request_changes_step()` / `resubmit_workflow()` ユースケースと `_by_display_number` バリアント
- `ResubmitWorkflowInput` 型定義
- ユニットテスト 10 件追加（権限チェック、バージョン不一致、状態不正など）

### Phase 3: Core Service ハンドラ + ルート

- 4 ハンドラ追加（request_changes_step, resubmit_workflow + by_display_number 各2つ）
- `ResubmitWorkflowRequest` 型定義
- `/internal/workflows/...` に 4 ルート追加

### Phase 4: BFF クライアント + ハンドラ + ルート

- `CoreServiceWorkflowClient` に 2 メソッド追加
- BFF `ResubmitWorkflowRequest` 型定義
- 2 ハンドラ + 2 ルート追加（utoipa アノテーション含む）

### Phase 5: OpenAPI 仕様書更新

- `request-changes` / `resubmit` エンドポイント追加
- `ResubmitWorkflowRequest` スキーマ追加
- `WorkflowInstanceStatus` に `ChangesRequested` 追加
- OpenAPI スナップショット更新、パス数テスト修正（21 → 23）

### Phase 6: API テスト (Hurl)

- `request_changes_step.hurl`: 差し戻し + CSRF エラー + Not Found
- `resubmit_workflow.hurl`: 再申請 + 状態エラー
- `full_request_changes_resubmit_flow.hurl`: 2段階承認での差し戻し → 再申請 → 全承認フロー

## 判断ログ

- 設計判断は計画ファイルに記録済み（6 つの設計判断 + ブラッシュアップループ 5 回）
- `ChangesRequested` を中間状態として設計（`completed_at` を設定しない）— `Rejected`/`Approved` との差異を明確化
- `resubmit` では `initiated_by == user_id` の権限チェックを追加（`submit` にはない独自の判断）
- Phase 1-2 のコミットが前セッションのコンテキスト消失で失われていたため、3セッション目で追加コミット

## 成果物

コミット:

| コミット | 内容 |
|---------|------|
| `5097c09` | Phase 3: Core Service ハンドラ + ルート |
| `dcf792e` | Phase 4: BFF クライアント + ハンドラ + ルート |
| `3fe48e2` | Phase 5: OpenAPI 仕様書更新 |
| `81843a1` | Phase 6: Hurl API テスト |
| `d14f841` | Phase 1: ドメインモデル + DB マイグレーション |
| `84906e0` | Phase 2: ユースケース |
| `26a35a9` | OpenAPI スナップショット更新 |
| `228458a` | OpenAPI パス数テスト修正 |
| `9023a40` | Hurl テスト構文修正（JSONPath、CSRF 型） |

変更規模: 24 ファイル、+3172 行 / -338 行
