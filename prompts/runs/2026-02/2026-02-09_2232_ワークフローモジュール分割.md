# ワークフローモジュール分割

## 概要

Issue #290（Refactor oversized files）の最初の対応として、`backend/crates/domain/src/workflow.rs`（1665行）をエンティティ単位で 3 つのサブモジュールに分割した。

## 背景と目的

`workflow.rs` は 3 つのドメインエンティティ（WorkflowDefinition, WorkflowInstance, WorkflowStep）が同居しており、プロジェクトのファイルサイズ閾値（500行）を大幅に超過していた。Issue 作成時（1295行）から +370 行増加しており、割れ窓効果で肥大化が加速していた。

エンティティ間の結合は ID 型の参照のみ（Instance が DefinitionId を、Step が InstanceId を保持）であり、分割しても凝集度が下がらないことを確認した上で着手した。

## 実施内容

### Phase 1: ADR-039 作成

分割方針の意思決定を ADR-039 として記録。3 つの選択肢（エンティティ単位分割、テストのみ分離、現状維持）を比較し、エンティティ単位分割を選択。

### Phase 2-4: サブモジュール切り出し

ボトムアップの依存順序（Definition → Instance → Step）で切り出しを実施。

| Phase | 対象 | プロダクション行数 |
|-------|------|-------------------|
| 2 | definition.rs | ~205 行 |
| 3 | instance.rs | ~365 行 |
| 4 | step.rs | ~367 行 |

最終的な `workflow.rs` は 44 行（doc + mod 宣言 + pub use re-export）。

## 設計上の判断

### Re-export 戦略: `mod`（非 pub）+ `pub use *`

`handler.rs` は `pub mod` + 明示的 `pub use` を使用しているが、workflow は単一概念の内部分割のため `mod`（非 pub）+ `pub use *` を選択。サブモジュールの内部構造を隠蔽し、消費者のインポートパス `workflow::TypeName` を完全に維持した。

### sibling モジュール間の型参照

`instance.rs` は `use super::definition::WorkflowDefinitionId;`、`step.rs` は `use super::instance::WorkflowInstanceId;` で解決。Rust の可視性ルールにより、sibling の private module の public item には `super::` 経由でアクセス可能。

## 判断ログ

特筆すべき判断なし。計画段階で設計判断を完了しており、実装は純粋な移動作業だった。

## 成果物

### コミット

1. `#290 Add ADR-039: Workflow module split strategy`
2. `#290 Extract WorkflowDefinition into workflow/definition.rs`
3. `#290 Extract WorkflowInstance into workflow/instance.rs`
4. `#290 Extract WorkflowStep into workflow/step.rs and finalize parent module`
5. `#290 Add implementation plan for workflow module split`

### 作成・更新ファイル

| ファイル | 操作 |
|---------|------|
| `docs/70_ADR/039_ワークフローモジュールの分割方針.md` | 新規作成 |
| `backend/crates/domain/src/workflow.rs` | 1665行 → 44行に縮小 |
| `backend/crates/domain/src/workflow/definition.rs` | 新規作成 |
| `backend/crates/domain/src/workflow/instance.rs` | 新規作成 |
| `backend/crates/domain/src/workflow/step.rs` | 新規作成 |
| `prompts/plans/rippling-whistling-hollerith.md` | 新規作成 |

### PR

- #363（Draft）

## 議論の経緯

### 対象ファイルの選定

Issue #290 は複数ファイルの分割を対象としていたが、ドメイン層（依存の底）から着手する方針を提案し、ユーザーが承認した。

## 学んだこと

- Rust 2018+ の `parent.rs` + `parent/` パターンは、`mod.rs` を使わずにモジュール階層を表現でき、ファイル名でモジュールが識別しやすい
- `mod`（非 pub）+ `pub use *` で内部構造を隠蔽しつつ API 互換性を維持できる。これは「単一概念の内部分割」に適したパターン
- sibling module の public item は `super::module_name::TypeName` でアクセス可能（Rust の可視性ルール）

## 次のステップ

- #290 の残りのファイル分割（別 PR で対応）
