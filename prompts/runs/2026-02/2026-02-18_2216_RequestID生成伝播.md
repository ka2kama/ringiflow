# 2026-02-18_2216 Request ID 生成・伝播

## 概要

Issue #650（Epic #648 Observability 基盤の Story 2）として、Request ID の生成・伝播とログへの自動注入を実装した。BFF で UUID v7 の Request ID を生成し、レスポンスヘッダーに付与、tracing スパンに注入、BFF から Core Service / Auth Service への HTTP リクエストに伝播する仕組みを構築した。

## 実施内容

5 Phase で実装を完了した。

### Phase 1: 共有 observability 拡張

`ringiflow-shared` の `observability` モジュールに以下を追加:

- `MakeRequestUuidV7`: tower-http の `MakeRequestId` trait を実装し、UUID v7 を生成
- `make_request_span`: `X-Request-Id` ヘッダーからリクエスト ID を読み取り、tracing スパンに `request_id` フィールドとして記録するカスタムスパン作成関数
- `REQUEST_ID_HEADER`: ヘッダー名定数
- ユニットテスト 4 件

### Phase 2: BFF Request ID 設定

BFF の Router に tower-http のレイヤーを追加:

- `SetRequestIdLayer`: リクエスト受信時に UUID v7 を生成しヘッダーに設定
- `PropagateRequestIdLayer`: レスポンスに `X-Request-Id` をコピー
- `TraceLayer` の `make_span_with` をカスタマイズ
- ハンドラテスト 3 件

### Phase 3: Core Service / Auth Service のスパン注入

両サービスの `TraceLayer` に `make_request_span` を適用。BFF から伝播された `X-Request-Id` ヘッダーをスパンに記録。

### Phase 4: BFF → 内部サービスへの Request ID 伝播

- `tokio::task_local!` でリクエストスコープの Request ID を保存
- `store_request_id` ミドルウェアで `SetRequestIdLayer` が設定した `RequestId` を task-local に格納
- `inject_request_id` 自由関数で `reqwest::RequestBuilder` にヘッダーを注入
- 5 つのクライアントファイルの全 34 箇所の HTTP 呼び出しに適用
- ユニットテスト 3 件

### Phase 5: API テスト検証

`health.hurl` と `auth/login.hurl` に UUID v7 形式の `X-Request-Id` ヘッダーアサーションを追加。

## 判断ログ

- 設計判断: tower-http の `request-id` モジュールを活用（独自ミドルウェアより KISS）
- 設計判断: `tokio::task_local!` で Request ID を伝播（34 メソッドのシグネチャ変更を回避、横断的関心事に適切）
- 設計判断: `inject_request_id` を自由関数として配置（CoreServiceClient と AuthServiceClient の両方で共用可能）
- 設計判断: Core/Auth には `SetRequestIdLayer` を置かない（ID 生成は BFF のみの責務）
- Refactor: Phase 4 で `inject_request_id` のパターンが全クライアントで統一されていることを確認。追加の抽象化は不要（KISS）

## 成果物

コミット:
- `59554f4` Add Request ID utilities to shared observability module
- `0ddb870` Configure Request ID layers in BFF router
- `fb6ad3e` Apply custom make_request_span to Core and Auth Services
- `a3dec59` #650 Propagate Request ID from BFF to internal services via task-local
- `4e7c29e` #650 Add X-Request-Id header assertions to API tests
- `f664ba0` #650 Add implementation plan for Request ID propagation

PR: #669

主な変更ファイル:
- `backend/crates/shared/src/observability.rs` — Request ID ユーティリティ
- `backend/apps/bff/src/middleware/request_id.rs` — task-local + inject_request_id
- `backend/apps/bff/src/main.rs` — レイヤー構成
- `backend/apps/bff/src/client/` 配下 5 ファイル — inject_request_id 適用
- `backend/apps/core-service/src/main.rs` — make_request_span 適用
- `backend/apps/auth-service/src/main.rs` — make_request_span 適用
- `tests/api/hurl/` — X-Request-Id アサーション追加
