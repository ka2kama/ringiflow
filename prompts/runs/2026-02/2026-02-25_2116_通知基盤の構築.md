# 通知基盤の構築

Issue: #875
Branch: `feature/875-notification-infrastructure`
PR: #916

## 概要

Epic #406（Phase 2-5: 通知 + ドキュメント管理）の最初の Story として、メール通知の基盤を構築した。5 Phase に分けて実装し、後続 Story（#876-#879）がユースケース統合・ログ記録・SES 本番設定を積み上げる土台を完成させた。

## 実施内容

### Phase 1: ドメイン型の定義

domain クレートに通知関連の型を定義した。

- `NotificationError` — 送信失敗、テンプレート失敗、ログ失敗の 3 バリアント
- `EmailMessage` — to, subject, html_body, text_body
- `WorkflowNotification` — 5 バリアント（ApprovalRequest, StepApproved, Approved, Rejected, ChangesRequested）
- `NotificationLogId` — `define_uuid_id!` マクロによる UUID v7 newtype
- `NotificationEventType` — strum の Display/EnumString で snake_case シリアライズ

### Phase 2: NotificationSender trait + 3 実装

infra クレートに `NotificationSender` trait と 3 つの実装を作成した。

- `SmtpNotificationSender` — lettre の `AsyncSmtpTransport<Tokio1Executor>` で Mailpit に接続
- `SesNotificationSender` — aws-sdk-sesv2 の `Client` で SES v2 API を使用
- `NoopNotificationSender` — `tracing::info!` でログ出力のみ

### Phase 3: TemplateRenderer + メールテンプレート

tera テンプレートエンジンで 5 種類の通知メールを HTML/plaintext 両形式で生成する `TemplateRenderer` を実装した。

- `include_str!` でコンパイル時にテンプレートを埋め込み
- 件名パターン: `[RingiFlow] {イベント種別}: {title} {display_id}`
- ワークフロー詳細リンク: `{base_url}/workflows/{display_id}`

### Phase 4: NotificationLogRepository + Migration + NotificationService

- `notification_logs` テーブルの migration（RLS ポリシー + インデックス付き）
- `NotificationLogRepository` trait + PostgreSQL 実装
- `NotificationService`（render + send + log の統合、fire-and-forget パターン）
- `MockNotificationSender` / `MockNotificationLogRepository`（テスト用）
- event_log.rs への notification 定数追加

### Phase 5: Docker Compose + 環境変数 + DI 配線

- Mailpit を Docker Compose に追加（dev + api-test）
- generate.sh にポートオフセット付き環境変数を追加
- `NotificationConfig` を `CoreConfig` に統合
- main.rs で `NOTIFICATION_BACKEND` に基づく DI 配線
- cargo-deny skip リストに新しい推移的重複クレートを追加

## 判断ログ

- 設計判断: `NotificationSender` trait は infra クレートに配置した。`async-trait` 依存と外部サービス通信の性質から、domain よりも infra が適切と判断した
- 設計判断: `EmailMessage` / `WorkflowNotification` / `NotificationError` は domain クレートに配置した。ビジネスロジック表現の型であり infra に非依存なため
- 設計判断: テンプレートファイルは `core-service/templates/` に配置した。`include_str!` の制約から `TemplateRenderer` と同じクレート内に必要
- 設計判断: lettre 0.11 を SMTP 実装に採用した。SMTP プロトコルを自作する理由がなく、`AsyncSmtpTransport` が Tokio 環境で十分なサポートを提供
- 設計判断: `NotificationService::notify()` は fire-and-forget パターンを採用した。通知の送信失敗がワークフロー操作を失敗させるべきではない
- Phase 5: cargo-deny の duplicate crate チェックで `crypto-bigint@0.4`（aws-sigv4 経由）と `hashbrown@0.14`（lettre → chumsky 経由）を skip リストに追加

## 成果物

### コミット

- `2682fef4` #875 WIP: Build notification infrastructure
- `2b739611` #875 Implement notification infrastructure

### 新規ファイル

| ファイル | 内容 |
|---------|------|
| `backend/crates/domain/src/notification.rs` | ドメイン型定義（396 行） |
| `backend/crates/infra/src/notification.rs` | モジュールルート + NotificationSender trait |
| `backend/crates/infra/src/notification/smtp.rs` | SMTP 実装 |
| `backend/crates/infra/src/notification/ses.rs` | SES 実装 |
| `backend/crates/infra/src/notification/noop.rs` | Noop 実装 |
| `backend/crates/infra/src/repository/notification_log_repository.rs` | ログリポジトリ |
| `backend/apps/core-service/src/usecase/notification.rs` | モジュールルート |
| `backend/apps/core-service/src/usecase/notification/service.rs` | NotificationService |
| `backend/apps/core-service/src/usecase/notification/template_renderer.rs` | TemplateRenderer + テスト |
| `backend/apps/core-service/templates/notifications/` | 10 テンプレート（5 種類 × HTML/txt） |
| `backend/migrations/20260225000001_create_notification_logs.sql` | DB マイグレーション |
| `prompts/plans/indexed-kindling-taco.md` | 実装計画 |

### 更新ファイル

| ファイル | 変更内容 |
|---------|---------|
| `backend/Cargo.toml` | workspace deps に tera, lettre, aws-sdk-sesv2 追加 |
| `backend/crates/infra/Cargo.toml` | lettre, aws-sdk-sesv2 追加 |
| `backend/apps/core-service/Cargo.toml` | tera 追加 |
| `backend/apps/core-service/src/config.rs` | NotificationConfig 追加 |
| `backend/apps/core-service/src/main.rs` | DI 配線追加 |
| `backend/crates/infra/src/mock.rs` | Mock 実装追加 |
| `backend/crates/shared/src/event_log.rs` | notification 定数追加 |
| `backend/deny.toml` | duplicate crate skip エントリ追加 |
| `infra/docker/docker-compose.yaml` | Mailpit サービス追加 |
| `infra/docker/docker-compose.api-test.yaml` | Mailpit サービス追加 |
| `scripts/env/generate.sh` | Mailpit ポート + 通知環境変数追加 |
