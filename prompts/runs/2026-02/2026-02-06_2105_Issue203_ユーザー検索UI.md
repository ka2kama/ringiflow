# Issue #203 ユーザー検索 UI 実装

## 概要

承認者選択の UUID 直接入力をオートコンプリート検索 UI に置き換えた。バックエンド（DB → Core Service → BFF）とフロントエンド（Elm）のフルスタック実装を3 Phase で完了。

## 背景と目的

新規申請フォームの承認者選択で UUID を直接入力させる暫定実装を、名前検索 UI に改善する（Issue #203）。エンタープライズ SaaS では同姓同名ユーザーの区別が必須要件であり、表示用 ID（USER-N）とメールアドレスの併記で対応する。

前提として、Phase 1（User エンティティへの display\_number 追加）と Phase 2（ユーザー一覧 API のバックエンド実装）は前セッションで大部分が完了しており、本セッションではそれらの検証・コミットとフロントエンド実装（Phase 3）を実施した。

## 実施内容

### Phase 1: User エンティティに display\_number 追加

- マイグレーション: `display_number` カラム + 既存データへのバックフィル + NOT NULL 制約
- ドメイン: `User` 構造体に `display_number: DisplayNumber` フィールド追加
- インフラ: `UserRepository` の INSERT/SELECT に `display_number` 追加

### Phase 2: ユーザー一覧 API（フルスタック）

- インフラ: `find_all_active_by_tenant()` メソッド + テスト3件
- Core Service: `GET /internal/users` エンドポイント + `UserItemDto`
- BFF: `GET /api/v1/users` エンドポイント + `CoreServiceClient::list_users`
- OpenAPI: `/api/v1/users` エンドポイント定義

### Phase 3: フロントエンド（Elm）

- `Data/UserItem.elm`: 型定義 + デコーダー + `filterUsers` 関数
- `Api/User.elm`: API クライアント
- `Page/Workflow/New.elm`: 承認者選択をオートコンプリート UI に全面書き換え
- テスト: デコーダー5件 + フィルタリング7件 = 12件

## 設計上の判断

### 1. オートコンプリート型 UI の採用

3つの UI パターン（オートコンプリート、ドロップダウン、モーダル検索）を比較し、オートコンプリート型を採用。既存テキスト入力からの操作感の変化が最小で、キーボード操作との相性が良い。

### 2. ページ init 時の一括データ取得

テナント内ユーザー数が限定的（エンタープライズ SaaS の1テナントは通常数百人以下）であるため、入力のたびに API を呼ぶのではなく init 時に全件取得してフロントエンド側でフィルタリングする方式を採用。

### 3. onMouseDown パターンによる blur/click 競合の回避

ドロップダウン候補のクリック時、`onBlur`（入力フィールド）が `onClick` より先に発火してドロップダウンが消える問題がある。候補アイテムに `onMouseDown`（`blur` より先に発火）を使うことで、`Process.sleep` による遅延クローズなしにシンプルに解決した。

### 4. ApproverSelection 型による状態の型安全化

`approverInput : String`（UUID 文字列）を `ApproverSelection = NotSelected | Selected UserItem` に置き換え。空文字チェックというランタイムバリデーションを、コンパイル時の型保証に昇格させた。

## 成果物

### コミット

| コミット | 内容 |
|---------|------|
| `43abb5c` | Phase 1: User エンティティに display\_number 追加 |
| `460164e` | Phase 2: ユーザー一覧 API（バックエンドフルスタック） |
| `876de1f` | Phase 3: フロントエンド オートコンプリート UI |

### 新規作成ファイル

| ファイル | 役割 |
|---------|------|
| `frontend/src/Data/UserItem.elm` | ユーザーアイテム型 + デコーダー + フィルタリング |
| `frontend/src/Api/User.elm` | ユーザー一覧 API クライアント |
| `frontend/tests/Data/UserItemTest.elm` | デコーダー + フィルタリングテスト（12件） |
| `backend/migrations/20260206000001_add_display_number_to_users.sql` | マイグレーション |
| `backend/migrations/20260206000002_set_users_display_number_not_null.sql` | NOT NULL 制約 |
| `backend/apps/bff/src/handler/user.rs` | BFF ユーザーハンドラ |

### 主な変更ファイル

| ファイル | 変更内容 |
|---------|---------|
| `frontend/src/Page/Workflow/New.elm` | 承認者選択を全面書き換え（+290行） |
| `backend/crates/infra/src/repository/user_repository.rs` | `find_all_active_by_tenant` 追加 |
| `backend/apps/core-service/src/handler/auth.rs` | `list_users` ハンドラ追加 |
| `openapi/openapi.yaml` | `/api/v1/users` エンドポイント追加 |

## 議論の経緯

### 実装方針

ユーザーから「おまかせ」の指示を受け、計画を策定して承認を得てから実装に入った。オートコンプリート型 UI、init 時一括取得、Page 内インライン実装の3つの設計判断について選択肢を比較し、計画に記載した。

## 学んだこと

1. Elm の `onMouseDown` と `onBlur` の発火順序を活用することで、Process.sleep による遅延ハックなしにドロップダウンの競合問題を解決できる
2. Union Type（`ApproverSelection`）で状態遷移を表現すると、`case` 式の網羅性チェックにより状態の抜け漏れがコンパイル時に検出される
3. `filterUsers` を Data 層に配置することで、Page モジュールの内部実装に依存せずテスト可能になる

## 次のステップ

- PR #254 を Ready for Review にしてマージ
- 将来の改善候補:
  - ログインユーザー自身を候補から除外
  - ARIA 属性の完全実装（アクセシビリティ向上）
