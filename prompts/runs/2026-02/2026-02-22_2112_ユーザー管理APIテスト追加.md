# ユーザー管理 API テスト追加

Story #776 — PR #782

## 概要

API テストカバレッジギャップ解消 Epic (#774) の Story 2 として、ユーザー管理 API の全 4 エンドポイントに対する Hurl テストを追加した。テスト作成過程で、ドキュメントと実装の乖離を 2 件発見した。

## 実施内容

### テストファイル作成

| ファイル | エンドポイント | テストケース |
|---------|-------------|------------|
| `create_user.hurl` | POST /api/v1/users | 正常系 201 + バリデーション 422 + CSRF なし 403 |
| `get_user_detail.hurl` | GET /api/v1/users/{dn} | 正常系 200 + 404 |
| `update_user.hurl` | PATCH /api/v1/users/{dn} | 名前更新 + ロール変更 |
| `update_user_status.hurl` | PATCH /api/v1/users/{dn}/status | 無効化 + 再有効化 |

`vars.env` にロール ID（`tenant_admin_role_id`, `user_role_id`）を追加。

### テスト失敗の調査と修正

初回実行で 2 ファイルが失敗。コード読解で原因を特定し修正した。

1. `create_user.hurl` line 80: axum 0.8 の `Json<T>` extractor は missing required field に対して 422（`JsonDataError`）を返す。400 ではない。OpenAPI ドキュメントは 400 と記載しているが、カスタム rejection handler がないため実際は 422。テストを 422 に修正。

2. `get_user_detail.hurl` line 37: BFF `get_user_detail` ハンドラが `format!("USR-{:06}", display_number)` でハードコードしており、Core Service の `DisplayId` 型（`USER-N` 形式）と不整合。テストは実際の BFF 動作（`USR-000001`）に合わせた。

修正後、全 28 ファイル / 166 リクエスト 100% pass を確認。

## 判断ログ

- テスト方針: バリデーションエラーのステータスコードは実際の動作（422）に合わせた。OpenAPI ドキュメントとの乖離は PR 本文に記載
- テスト方針: `get_user_detail` の `display_id` フォーマット不整合は BFF 側のバグだが、テストは実際の動作に合わせた。バグ修正は別途対応

## 成果物

- コミット: `abbec45` — `#776 Add user management API tests (4 endpoints)`
- Draft PR: #782
- 新規ファイル: 4 Hurl テスト + 計画ファイル
- 変更ファイル: `tests/api/hurl/vars.env`
