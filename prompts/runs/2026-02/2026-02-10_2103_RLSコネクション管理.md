# RLS コネクション管理: after_release フックと TenantConnection

## 概要

Issue #408（Phase 2-1: マルチテナント RLS）の一環として、DB コネクション返却時のテナントコンテキストリセット機構と、テナントスコープ付きコネクション型を実装した。

## 実施内容

### Phase 1: after_release フック + pool_options

- `pool_options()` 関数を抽出し、`after_release` フックを追加
- `create_pool()` を `pool_options()` を使うように変更
- 統合テスト: コネクション返却時に `app.tenant_id` がリセットされることを検証

### Phase 2: TenantConnection

- `TenantConnection` 構造体を新設（`PoolConnection<Postgres>` + `TenantId` を保持）
- `acquire()` で `set_config('app.tenant_id', $1, false)` を実行
- `Deref`/`DerefMut` で `PgConnection` として使用可能に
- 統合テスト 4 件: acquire 時のセッション変数設定、drop 後のリセット、連続テナント切り替え、Send 実装のコンパイル時検証

### テスト基盤

- `dotenvy` を dev-dependencies に追加（テスト時の `.env` 読み込み）
- `max_connections(1)` で同一物理接続の再取得を保証するテストプール

## 判断ログ

- Phase 1 Refactor: `create_test_pool()` ヘルパーを抽出（Phase 2 でも再利用）
- Phase 2 Refactor: 変更なし（Simple Design の問いに該当なし。TenantConnection は計画通りの最小設計）

## 成果物

### コミット

1. `#408 WIP: Implement after_release hook and TenantConnection`（空コミット、Draft PR 用）
2. `#408 Add implementation plan for RLS connection management`
3. `#408 Implement after_release hook for tenant context reset`
4. `#408 Implement TenantConnection with tenant-scoped session variable`

### 作成・更新ファイル

| ファイル | 種別 |
|---------|------|
| `backend/crates/infra/src/db.rs` | 変更（pool_options + TenantConnection 追加） |
| `backend/crates/infra/tests/db_test.rs` | 新規（統合テスト 5 件） |
| `backend/crates/infra/Cargo.toml` | 変更（dotenvy 追加） |
| `prompts/plans/408_rls-connection-management.md` | 新規（実装計画） |
