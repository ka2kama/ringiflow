# Mock リポジトリ共通化

## 概要

Issue #379 に対応し、core-service の 3 つのユースケーステストファイルで重複していた Mock リポジトリ定義を、infra クレートの共有モジュールに集約した。

## 実施内容

### Phase 1: infra クレートに mock モジュールを作成

- `backend/crates/infra/Cargo.toml` に `[features] test-utils = []` を追加
- `backend/crates/infra/src/lib.rs` に `#[cfg(any(test, feature = "test-utils"))] pub mod mock;` を追加
- `backend/crates/infra/src/mock.rs` を新規作成し、5 つの Mock リポジトリを実装:
  - `MockWorkflowDefinitionRepository`
  - `MockWorkflowInstanceRepository`
  - `MockWorkflowStepRepository`
  - `MockUserRepository`
  - `MockDisplayIdCounterRepository`

### Phase 2: core-service テストを共有モックに移行

- `task.rs` のインライン Mock 定義（~240 行）を削除し、`ringiflow_infra::mock` からのインポートに置換
- `dashboard.rs` のインライン Mock 定義（~190 行）を削除し、同様に置換
- `command.rs` のインライン Mock 定義（~335 行）を削除し、同様に置換
- Clippy の `new_without_default` 警告に対応し、4 つの Mock 構造体に `Default` derive を追加

## 判断ログ

- 配置先: infra クレートに feature gate で公開。domain クレートの `FixedClock`（`#[cfg(any(test, feature = "test-support"))]`）と同じパターンを採用
- feature 名: `test-utils`（domain の `test-support` とは異なるセマンティクスのため名前を分けた）
- カノニカル実装: `command.rs` 版を採用（`update_with_version_check` がフルの楽観的ロック動作を持つスーパーセット）
- BFF のサービスクライアントスタブは対象外とした（リポジトリモックとは異なるカテゴリ）
- Rust のトレイトスコープルール: `task.rs` と `dashboard.rs` はプロダクションコードでトレイトをインポート済みのため `use super::*` で引き継がれたが、`command.rs` はトレイトを直接インポートしていなかったためテストモジュールで明示的なインポートが必要だった

## 成果物

### コミット

| コミット | 内容 |
|---------|------|
| `327c557` | Phase 1: infra クレートに mock モジュール追加 |
| `f68636a` | Phase 2: core-service テストを共有モックに移行 |
| `9d6ca68` | 計画ファイル追加 |

### 作成・更新ファイル

- `backend/crates/infra/Cargo.toml` — feature 追加
- `backend/crates/infra/src/lib.rs` — mock モジュール宣言追加
- `backend/crates/infra/src/mock.rs` — 新規作成（383 行）
- `backend/apps/core-service/Cargo.toml` — dev-dependency に feature 追加
- `backend/apps/core-service/src/usecase/task.rs` — Mock 定義削除
- `backend/apps/core-service/src/usecase/dashboard.rs` — Mock 定義削除
- `backend/apps/core-service/src/usecase/workflow/command.rs` — Mock 定義削除

### PR

- #439: Consolidate mock repositories in usecase tests
