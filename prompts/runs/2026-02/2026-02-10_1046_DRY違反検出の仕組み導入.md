# DRY 違反検出の仕組み導入

Issue: #373

## 概要

AI 主導の開発におけるコード重複（DRY 違反）を機械的に検出する仕組みを導入した。jscpd（JavaScript Copy/Paste Detector）を選定し、justfile タスク・CI ジョブ・プロセス改善・フォローアップ Issue を一括で整備した。

## 実施内容

### Phase 1: ツール評価 + justfile 統合

- jscpd のローカル試行で Rust 126 クローン（12.21%）、Elm 12 クローン（4.32%）を検出
- jscpd の Elm フォーマットバグを発見し、Haskell トークナイザーでの代用策を確立
- `.jscpd.json` 設定ファイルのパース不具合を発見し、CLI 引数のみでの運用に方針転換
- justfile に `check-duplicates` タスクを追加し、`check` タスクに統合

### Phase 2: CI 統合

- 専用 `code-quality` ジョブを `.github/workflows/ci.yaml` に追加
- 既存 Actions のみ使用（GitHub Actions 許可設定の追加不要）
- 警告のみ（exit 0）で CI をブロックしない設計

### Phase 3: ADR-042 作成

- jscpd / duplicate_code / PMD CPD の3候補を比較
- 発見されたバグとワークアラウンドを記録

### Phase 4: プロセス改善

- TDD 開発フローの「重複の排除」レンズを具体的な Grep アクションに改善
- structural-review.md に重複検出セクションを追加

### Phase 5: フォローアップ Issue 作成

- #377: BFF Client レスポンスハンドリング共通化
- #378: Infra 層 Row→Entity 変換共通化
- #379: UseCase テスト Mock リポジトリ共通化

## 判断ログ

- jscpd の Elm フォーマットに公式バグがあるため、Haskell トークナイザーで代用する判断。Elm と Haskell は構文が類似しており、トークンベースの検出には十分機能する
- `--formats-exts` と複数 `--format` の併用にバグがあるため、Rust と Elm を別々の jscpd 呼び出しで実行する判断
- `.jscpd.json` 設定ファイルが正しく動作しないため、CLI 引数のみで運用する判断。justfile で管理しているため実用上の問題はない
- CI の `code-quality` ジョブを `ci-success` に追加しない判断。既存重複が約 730 行あるため、初期は警告のみとし、段階的に解消後に閾値を設定する

## 成果物

### コミット

- `#373 Add check-duplicates task using jscpd for copy-paste detection`
- `#373 Add code-quality CI job for copy-paste detection`
- `#373 Add ADR-042 for copy-paste detection tool selection`
- `#373 Improve DRY violation detection in design principle lens and structural review`

### 作成・更新ファイル

| ファイル | 変更 |
|---------|------|
| `justfile` | `check-duplicates` タスク追加、`check` に統合 |
| `.github/workflows/ci.yaml` | `code-quality` ジョブ追加 |
| `docs/05_ADR/042_コピペ検出ツールの選定.md` | 新規作成 |
| `docs/04_手順書/04_開発フロー/02_TDD開発フロー.md` | 設計原則レンズ更新 |
| `.claude/rules/structural-review.md` | 重複検出セクション追加 |

### GitHub Issue

- #377: BFF Client のレスポンスハンドリング共通化
- #378: Infra 層の Row→Entity 変換コード共通化
- #379: UseCase テストの Mock リポジトリ共通化

## 議論の経緯

- worktree の作成: 他セッションとブランチが競合したため、`git worktree add ../ringiflow-373` で独立した作業ディレクトリを作成した
- jscpd 設定ファイル vs CLI 引数: `.jscpd.json` でフォーマット設定が正しく解釈されない問題を発見。デバッグの結果、設定値は読み込まれているがフォーマット判定で無視される挙動を確認し、CLI 引数のみの運用に切り替えた
