# Story #431: フロントエンド管理画面実装

## 概要

Epic #403 Phase 2-2 の最終 Story として、ユーザー管理・ロール管理・監査ログ閲覧のフロントエンド画面（Elm）を実装した。5 Phase に分けて基盤からページモジュールまでを段階的に構築し、横断検証で全レイヤーの整合性を確認した。

## 実施内容

### Phase 1: 基盤（Route, Data, Api, Shared, サイドバー）

- Route に 8 つの新ルートを追加（Users, UserDetail, UserNew, UserEdit, Roles, RoleNew, RoleEdit, AuditLogs）
- Data モジュール 3 つを新規作成（AdminUser, Role, AuditLog）
- Api モジュール 3 つを新規作成（AdminUser, Role, AuditLog）
- Api.elm に `patch` と `deleteNoContent` を追加
- Shared に `isAdmin` を追加
- Main.elm にサイドバー管理セクション（権限制御付き）と全ページの骨格を追加
- Route, Data, Shared のテストを追加（274 テスト）

### Phase 2: ユーザー一覧・詳細

- `Page/User/List.elm`: ステータスフィルタ付き一覧、行クリックで詳細遷移
- `Page/User/Detail.elm`: 基本情報表示、ConfirmDialog によるステータス変更（自己無効化防止付き）

### Phase 3: ユーザー作成・編集

- `Page/User/New.elm`: メール・名前・ロール入力フォーム、作成成功後に初期パスワード表示画面
- `Page/User/Edit.elm`: 名前・ロール編集（メールは読み取り専用）、ユーザー詳細とロール一覧の並行取得、ロール名→ID 解決でレース条件を処理
- dirty tracking パターン適用（`markDirty` / `clearDirty` + `Ports.setBeforeUnloadEnabled`）

### Phase 4: ロール管理

- `Component/PermissionMatrix.elm`: リソース×アクションのチェックボックスグリッド、行ごとの「すべて選択」
- `Page/Role/List.elm`: システム/カスタムロールのセクション分け、削除は ConfirmDialog 経由
- `Page/Role/New.elm`: ロール名・説明・権限設定フォーム
- `Page/Role/Edit.elm`: DJ-3（詳細と編集を統合）、システムロールは読み取り専用表示

### Phase 5: 監査ログ一覧

- `Page/AuditLog/List.elm`: 期間・ユーザー・アクション・結果の 4 フィルタ
- カーソルベースページネーション（「次のページ」ボタン）
- インライン展開（アコーディオン）で操作詳細・IP・JSON を表示
- 並行取得（監査ログ + ユーザー一覧）でフィルタ用データを準備

### 横断検証

- Route → Main.elm → Page → Api → Data の全レイヤーでデータフロー整合を確認
- elm-review 管理（`ReviewConfig.elm`）: 各 Phase 完了時に不要な ignoreErrorsForFiles を除去
- `just check-all` 実行: E2E テスト（`@playwright/test` 未インストール）を除き全 pass

## 判断ログ

- Refactor: `Encode.list Encode.string (Set.toList ...)` → `Encode.set Encode.string ...`（elm-review Simplify ルールが検出、Role/New と Role/Edit で修正）
- Refactor: `viewExpandedDetail` の未使用 `Time.Zone` パラメータを除去（elm-review NoUnused.Parameters が検出）
- Phase 3 の `UserEdit` でロール一覧とユーザー詳細の並行取得時、両方の完了順を処理するパターンを採用（`GotUserDetail` と `GotRoles` の両方でロール名→ID 解決を試行）
- Phase 4 の `PermissionMatrix` を独立コンポーネントとして分離（DJ-5: Role/New と Role/Edit で再利用）
- `Data.AuditLog.resultToCssClass` は Badge パターン移行で未使用となったが、将来の利用可能性を考慮して Exports ignore で保持

## 成果物

### コミット

| ハッシュ | 内容 |
|---------|------|
| `94f59b6` | Phase 1: 基盤（Route, Data, Api, Shared, サイドバー） |
| `61cec9b` | Phase 2: ユーザー一覧・詳細 |
| `57e04d6` | Phase 3: ユーザー作成・編集 |
| `4d6ff99` | Phase 4: ロール管理 + PermissionMatrix |
| `a9a08a0` | Phase 5: 監査ログ一覧 |

### 新規ファイル

| ファイル | 内容 |
|---------|------|
| `frontend/src/Data/AdminUser.elm` | ユーザー管理用型定義（AdminUserItem, UserDetail, CreateUserResponse, UserResponse） |
| `frontend/src/Data/Role.elm` | ロール管理用型定義（RoleItem, RoleDetail） |
| `frontend/src/Data/AuditLog.elm` | 監査ログ型定義（AuditLogItem, AuditLogList） |
| `frontend/src/Api/AdminUser.elm` | ユーザー API クライアント（5 関数） |
| `frontend/src/Api/Role.elm` | ロール API クライアント（5 関数） |
| `frontend/src/Api/AuditLog.elm` | 監査ログ API クライアント（1 関数 + フィルタ型） |
| `frontend/src/Component/PermissionMatrix.elm` | 権限マトリクスコンポーネント |
| `frontend/src/Page/User/List.elm` | ユーザー一覧ページ |
| `frontend/src/Page/User/Detail.elm` | ユーザー詳細ページ |
| `frontend/src/Page/User/New.elm` | ユーザー作成ページ |
| `frontend/src/Page/User/Edit.elm` | ユーザー編集ページ |
| `frontend/src/Page/Role/List.elm` | ロール一覧ページ |
| `frontend/src/Page/Role/New.elm` | ロール作成ページ |
| `frontend/src/Page/Role/Edit.elm` | ロール編集・詳細ページ |
| `frontend/src/Page/AuditLog/List.elm` | 監査ログ一覧ページ |
| `frontend/tests/Data/AdminUserTest.elm` | AdminUser デコーダーテスト |
| `frontend/tests/Data/RoleTest.elm` | Role デコーダーテスト |
| `frontend/tests/Data/AuditLogTest.elm` | AuditLog デコーダーテスト |
| `frontend/tests/RouteTest.elm` | ルーティングテスト |
| `frontend/tests/SharedTest.elm` | Shared.isAdmin テスト |

### 変更ファイル（主要）

| ファイル | 変更内容 |
|---------|---------|
| `frontend/src/Main.elm` | 全ページの Page/Msg/init/update/view 統合、サイドバー管理セクション追加 |
| `frontend/src/Route.elm` | 8 ルート追加、パーサー・toString・isRouteActive・pageTitle 拡張 |
| `frontend/src/Api.elm` | `patch`, `deleteNoContent` 追加 |
| `frontend/src/Shared.elm` | `isAdmin` 追加 |
| `frontend/review/src/ReviewConfig.elm` | Phase 完了に伴う ignoreErrorsForFiles の段階的除去 |
