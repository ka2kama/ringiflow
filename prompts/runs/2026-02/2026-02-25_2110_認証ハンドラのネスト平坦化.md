# 認証ハンドラのネスト平坦化

## 概要

#923 で確立した Rust 関数内スタイル（「ネスト 2 段以上は平坦化する」）に対する既存コードの準拠状況を調査し、違反箇所をリファクタリングした。

## 実施内容

### 準拠状況の調査

#923 の3層アプローチ（clippy lint / `rust.md` 判断基準 / 既存パターン踏襲）に対して、6カテゴリで現在のコードを検証した。

| カテゴリ | 違反数 |
|---------|-------|
| 制御フロー（ネスト） | 5 箇所 |
| `let-else` 活用 | 0 |
| イテレータ vs `for` | 1（軽微） |
| 変数束縛 | 0 |
| クロージャ / メソッド参照 | 0 |
| `impl` ブロック構成順序 | 0 |

制御フローのネスト違反が BFF 認証ハンドラ層に集中していた。

### リファクタリング

| ファイル | 関数 | Before | After | 手法 |
|---------|------|--------|-------|------|
| `bff/handler/auth/login.rs` | `login` | 4段 | 0段 | `match` → `let` + 早期リターン |
| `bff/handler/auth/session.rs` | `me` | 2段 | 0段 | session_data を `let` で抽出 |
| `bff/handler/auth/session.rs` | `csrf` | 3段 | 1段 | セッション確認をガード節化 |
| `core-service/usecase/user.rs` | `update_user_status` | 3段 | 1段 | `is_last_tenant_admin` ヘルパー抽出 |

## 判断ログ

- `infra/deletion/dynamodb_audit_log.rs`（4段ネスト）をスコープ外とした。BatchWriteItem + リトライ + ページネーションの本質的複雑さ（essential complexity）によるもので、平坦化しても認知的負荷が下がらないと判断

## 成果物

- コミット: `83b0583b` #923 Flatten deeply nested control flow in auth handlers and user usecase
- PR: #925
