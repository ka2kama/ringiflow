# RLS ドキュメントと ADR 更新

Issue: #411 | PR: #425 | Branch: `feature/411-rls`

## 概要

Epic #402（マルチテナント RLS 実装）の最終 Story。Story 1-4 の実装完了を受けて、設計判断を ADR に記録し、関連する基本設計書とロードマップを更新した。

## 実施内容

### ADR-044 作成

RLS 導入における 2 つの主要な設計判断を記録:

1. コネクション管理方式: `after_release` フック + `TenantConnection`（3 案比較）
2. tenant_id カラム追加（非正規化）vs JOIN ベースの RLS ポリシー（2 案比較）

加えて、RLS ポリシーの SQL パターン（`set_config` + `NULLIF` + `current_setting`）を記載。

### 基本設計書更新

- `03_インフラとDB設計.md` 7.1.3 節: 二重防御テーブルの「実装例」列を実装に合わせて更新。RLS 実装方式サブセクション（SQL パターン、全 9 テーブルのポリシー一覧）を追加。実装状態マーカーを追加（アプリ層 + DB 層は実装済み、監査は Phase 2-2 以降）
- `00_アーキテクチャ概要.md`: マルチテナントセクションの SQL 例を NULLIF パターンに更新。二重防御の説明を追加

### ロードマップ更新

- Phase 2-1 の完了基準 4 項目すべてにチェック
- 現状記述を「未実装」から「実装済み」に変更
- ADR-044 を設計ドキュメント準備状況に追記

## 判断ログ

- 基本設計書 7.2 節の ER 図で `workflow_steps` に `tenant_id` が反映されていない点を検出。本 Issue のスコープ（マルチテナントセクション + ロードマップ）外のため、後続対応として PR 備考に記載

## 成果物

### コミット

- `8c52e17` Add ADR-044 and update design docs for RLS implementation

### 変更ファイル

| ファイル | 変更内容 |
|---------|---------|
| `docs/70_ADR/044_PostgreSQL_RLSによるマルチテナント分離の実装方式.md` | 新規作成 |
| `docs/30_基本設計書/03_インフラとDB設計.md` | 7.1.3 節に RLS 実装方式サブセクション追加 |
| `docs/30_基本設計書/00_アーキテクチャ概要.md` | マルチテナントセクション更新 |
| `docs/40_詳細設計書/00_実装ロードマップ.md` | Phase 2-1 完了基準チェック、ADR-044 追記 |
