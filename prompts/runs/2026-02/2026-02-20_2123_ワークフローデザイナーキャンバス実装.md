# ワークフローデザイナー キャンバスとステップ配置の実装

Issue: #725
PR: #733
ブランチ: `feature/725-workflow-designer-canvas`

## 概要

ワークフローデザイナーの中核 UI を実装した。ADR-053 で決定した SVG + Elm 直接レンダリング方式に基づき、キャンバス上にステップをドラッグ&ドロップで配置・操作する機能を構築した。フロントエンドのみの変更で、バックエンド API 連携は後続 Story で対応する。

## 実施内容

### Phase 1: データ型、ルート、ページスキャフォールド

- `Data/DesignerCanvas.elm`: StepType, StepNode, Position, Bounds, DraggingState 等の型と純粋関数を定義
- `Route.elm`: `WorkflowDefinitionDesignerNew` ルート（`/workflow-definitions/new`）を追加
- `Page/WorkflowDefinition/Designer.elm`: TEA ページモジュールのスキャフォールドを作成
- `Main.elm`: Nested TEA の 7 integration points（Page, Msg, initPage, update, viewPage, subscriptions, updatePageShared）を追加
- `Icons.elm`: workflowDesigner アイコンを追加
- サイドバーに「ワークフロー定義」ナビゲーションリンクを追加

### Phase 2: SVG キャンバス描画とステップパレット

- 20px グリッド線の SVG 描画（secondary-200 色、stroke-width: 0.5）
- ステップノードの SVG 描画（角丸矩形 120x60、種別ごとの色分け）
- ステップパレット UI（開始・承認・終了の 3 種、ミニアイコン付き）
- デザインガイドラインのカラートークン（success-100/600, primary-100/600, secondary-100/600）を適用

### Phase 3: Ports とドラッグ&ドロップ

- `Ports.elm`: requestCanvasBounds / receiveCanvasBounds を追加
- `main.js`: getBoundingClientRect を requestAnimationFrame で取得する Port ハンドラを追加
- Browser.Events（onMouseMove, onMouseUp, onKeyDown）による条件付き subscription
- clientX/clientY → SVG viewBox 座標への変換ロジック
- パレットからキャンバスへのドラッグ&ドロップでステップを配置

### Phase 4: ステップ操作

- クリックによるステップ選択（破線リングハイライト）
- ドラッグによるステップ移動（グリッドスナップ付き）
- Delete/Backspace キーによるステップ削除
- 背景クリックによる選択解除

## 判断ログ

- Refactor: SVG レイヤー順序を修正。`viewCanvasBackground` が最後（前面）に描画されステップのクリックを妨げていたため、最初（背面）に移動した
- Refactor: グリッドの `<g>` 要素に `pointerEvents "none"` を追加。グリッド線がクリックイベントを奪わないようにした
- Refactor: `StepMouseDown` の引数を offset から clientX/clientY に変更。SVG の `onMouseDown` イベントから要素内 offset を直接取得するのは困難なため、clientX/clientY を受け取り update 内で座標変換してから offset を計算する方式に改善した
- Refactor: elm-review 指摘対応。`CanvasMouseUp` の未使用引数（Float Float）を除去し引数なしに変更。`NoOp` コンストラクタと `Position` の未使用 import を削除

## 成果物

コミット:
- `8af6f09` #725 WIP: Implement workflow designer canvas and step placement
- `0c3cb79` #725 Implement workflow designer canvas and step placement

新規ファイル:
- `frontend/src/Data/DesignerCanvas.elm` — 型定義と純粋関数（235 行）
- `frontend/src/Page/WorkflowDefinition/Designer.elm` — デザイナーページ（615 行）
- `frontend/tests/Data/DesignerCanvasTest.elm` — データ型テスト（282 行）
- `frontend/tests/Page/WorkflowDefinition/DesignerTest.elm` — update ロジックテスト（322 行）
- `prompts/plans/cached-mixing-music.md` — 計画ファイル

変更ファイル:
- `frontend/src/Route.elm` — ルート追加
- `frontend/src/Main.elm` — ページ統合
- `frontend/src/Ports.elm` — Canvas Bounds Ports 追加
- `frontend/src/main.js` — Port ハンドラ追加
- `frontend/src/Component/Icons.elm` — アイコン追加
- `frontend/tests/RouteTest.elm` — ルートテスト追加

テスト: 382 件パス（うち新規 22 件）
