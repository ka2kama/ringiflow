# usecase/workflow.rs の Query/Command 分割

## 概要

Issue #290（500行超ファイルのリファクタリング）の一環として、`core-service/usecase/workflow.rs`（1938行）を Query/Command 分割で3ファイルに分割した。前回の domain/workflow.rs 分割（PR #363）に続く2番目のファイル分割。

## 背景と目的

`usecase/workflow.rs` は14個の pub メソッド、5個の型定義、11個のテスト、5個の Mock リポジトリを含む1938行のファイル。構造品質の維持ルール（500行閾値）に基づき、分割が必要だった。

前回の domain 分割では「型ごとにファイルを分ける + `pub use *`」パターンを使ったが、ユースケース層は単一構造体 `WorkflowUseCaseImpl` の impl ブロック分割という異なるアプローチが求められた。

## 実施内容

### Phase 1: query.rs の切り出し

読み取り系メソッド5個を `workflow/query.rs` に移動:

- `list_workflow_definitions`
- `get_workflow_definition`
- `list_my_workflows`
- `get_workflow`
- `get_workflow_by_display_number`

### Phase 2: command.rs の切り出し + テスト移動

状態変更系メソッド7個 + 全テストを `workflow/command.rs` に移動:

- `create_workflow`, `submit_workflow`, `approve_step`, `reject_step`
- `submit_workflow_by_display_number`, `approve_step_by_display_number`, `reject_step_by_display_number`
- Mock リポジトリ5個 + テスト11個

### 最終構成

| ファイル | 行数 | 内容 |
|---------|------|------|
| `workflow.rs`（親） | ~120行 | 型定義、構造体、`new()`、`resolve_user_names()`、`collect_user_ids_from_workflow()` |
| `workflow/query.rs` | ~170行 | 読み取りメソッド5個 |
| `workflow/command.rs` | ~1700行（テスト含む） | 状態変更メソッド7個 + テスト |

## 設計上の判断

### 分割軸: Query/Command（CQRS ライク）

エンティティ分割（Definition / Instance / Step）ではなく、メソッドの責務（読み取り vs 状態変更）で分割した。

理由:
- 操作がエンティティ境界を横断する（`approve_step` は Step と Instance 両方を更新）
- コード内の既存セクション分け（`// ===== GET 系メソッド =====`）と自然に一致
- エンティティ分割だと approve/reject の配置が曖昧になる

### Re-export 不要

domain 分割では `pub use *` で子モジュールの型を再公開したが、今回は不要。子モジュールは新しい型を公開せず、親の構造体に impl ブロックを追加するのみ。メソッドは構造体を通じてアクセスされるため、モジュールの可視性は影響しない。

### テスト配置: command.rs に集約

全11テストが command メソッド（create, submit, approve, reject）のみをテストしていたため、command.rs に集約した。Mock リポジトリも command テスト内でのみ使用されている。

## 判断ログ

特筆すべき判断なし。計画通りの定型的な分割作業。

## 成果物

### コミット

| コミット | 内容 |
|---------|------|
| `a14b5f8` | Phase 1: query メソッドの切り出し |
| `8810bee` | Phase 2: command メソッドとテストの切り出し |
| `e8b4685` | 計画ファイルの追加 |

### 作成ファイル

- `backend/apps/core-service/src/usecase/workflow/query.rs`（新規）
- `backend/apps/core-service/src/usecase/workflow/command.rs`（新規）
- `prompts/plans/290_split-usecase-workflow-module.md`（計画ファイル）

### 更新ファイル

- `backend/apps/core-service/src/usecase/workflow.rs`（1938行 → 120行）

### PR

- [#364](https://github.com/ka2kama/ringiflow/pull/364)（Draft）

## 議論の経緯

### 分割アプローチの選択

plan mode で Query/Command 分割とエンティティ分割の2案を提示し、Query/Command 分割を選択。エンティティ横断操作の存在が決め手となった。

## 学んだこと

- Rust の impl ブロック分割は `pub use` 不要で、domain 分割（型の再公開が必要）よりシンプル
- 子モジュールから親の private フィールドにアクセスできるため、可視性の変更なしに分割が成立する

## 次のステップ

Issue #290 の残りの 500 行超過ファイル（`dashboard.rs`, `task.rs`, `bff/handler/auth.rs` 等）の分割を別 PR で対応。
