# Core Service ハンドラ層のクローン削減・ファイルサイズ削減

Issue: #527（Epic #467 Story 4）
ブランチ: `feature/527-core`

## 概要

Core Service ハンドラ層に存在する約35のコードクローンを削減し、500行閾値を超過する3ファイル（command.rs, Core auth.rs, BFF auth.rs）のサイズを削減するリファクタリングを実施した。

## 実施内容

5 Phase に分けて段階的にリファクタリングを実施した。

### Phase 1: Workflow VO parse ヘルパー + convert_approvers 抽出

`workflow.rs` に3つのヘルパー関数を追加し、command.rs と query.rs の重複パターンを統合した。

- `parse_display_number`: DisplayNumber 変換（11箇所統合）
- `parse_version`: Version 変換（8箇所統合）
- `convert_approvers`: StepApprover 変換（4箇所統合）

各ヘルパーのユニットテスト（正常系・異常系）を追加した。

### Phase 2: Workflow ユーザー名解決メソッド抽出

「collect_user_ids → resolve_user_names → build DTO」の3段階フローを `WorkflowInstanceDto` の async メソッドに集約した。

- `resolve_from_instance`: ステップなしのインスタンス変換（3箇所統合）
- `resolve_from_workflow_with_steps`: ステップ付きワークフロー変換（10箇所統合）

### Phase 3: Role/Auth クローン削減

- `From<&Role> for RoleDetailDto`: 7フィールドの DTO 構築を trait impl に統一（3箇所統合）
- `build_user_with_permissions`: 権限集約 + DTO 構築ヘルパー（2箇所統合）

### Phase 4: Core auth.rs サブモジュール分割

Core auth.rs（993行）をディレクトリ構造に変換し、テストモジュールを分離した。

```
handler/auth/
├── mod.rs      # 型定義 + ハンドラ + ヘルパー (~561行)
└── tests.rs    # テストコード (~432行)
```

### Phase 5: BFF auth.rs サブモジュール分割

BFF auth.rs（1076行）を CQRS 的な責務分離でサブモジュール化した。

```
handler/auth/
├── mod.rs       # 共有型 + State + Cookie ヘルパー + テストスタブ (~412行)
├── login.rs     # login + logout + テスト (~438行)
└── session.rs   # me + csrf + テスト (~288行)
```

テストスタブは `mod.rs` の `#[cfg(test)] pub(super) mod test_utils` で共有した。

utoipa の `#[utoipa::path]` マクロが生成する `__path_*` 型がサブモジュールに移動した問題に対し、workflow モジュールの前例に倣い `pub use login::*; pub use session::*;` で re-export することで解決した。

## 判断ログ

- Phase 5 で utoipa `__path_*` 型のアクセシビリティ問題を発見。明示的な re-export (`pub use login::{login, logout}`) では不十分で、`pub use login::*` が必要だった。workflow モジュールが `pub use command::*` を使用している前例と一致
- utoipa マクロ内で `ErrorResponse` 型が解決できない問題を発見。login.rs と session.rs に `ringiflow_shared::ErrorResponse` の import を追加して解決

## 成果物

### コミット

1. `1b405fc` - Phase 1: Extract parse_display_number, parse_version, convert_approvers helpers
2. `14e7bdb` - Phase 2: Extract resolve_from_instance and resolve_from_workflow_with_steps
3. `d7b8572` - Phase 3: Add From<&Role> for RoleDetailDto and build_user_with_permissions helper
4. `31387f4` - Phase 4: Split Core auth.rs into auth/mod.rs and auth/tests.rs
5. `333881e` - Phase 5: Split BFF auth.rs into login.rs and session.rs submodules

### 変更ファイル

| ファイル | 変更内容 |
|---------|---------|
| `core-service/handler/workflow.rs` | ヘルパー関数3つ + resolve メソッド2つ + テスト7件追加 |
| `core-service/handler/workflow/command.rs` | 21箇所のクローンをヘルパー呼び出しに置換 |
| `core-service/handler/workflow/query.rs` | 4箇所のクローンをヘルパー呼び出しに置換 |
| `core-service/handler/role.rs` | `From<&Role>` impl 追加、3箇所を置換 |
| `core-service/handler/auth.rs` → `auth/mod.rs` + `auth/tests.rs` | テストモジュール分離 |
| `bff/handler/auth.rs` → `auth/mod.rs` + `login.rs` + `session.rs` | 責務別サブモジュール分割 |
