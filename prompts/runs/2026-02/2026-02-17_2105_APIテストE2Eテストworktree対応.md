# #617 API テスト・E2E テストを worktree 並行開発に対応

## 概要

開発環境（`dev-deps`）で既に実現されているポートオフセット方式を、API テスト・E2E テスト環境（`api-test-deps`）に横展開した。これにより、複数の worktree で `just test-api` / `just test-e2e` を同時に実行してもポート競合・DB 汚染が発生しなくなる。

## 実施内容

### Phase 1: 環境変数ファイル体系の変更

- `backend/.env.api-test` を git 追跡ファイルからテンプレート方式（`.env.api-test.template`）に変更
- `generate-env.sh` を拡張し、API テスト用ポート 7 種（PostgreSQL, Redis, DynamoDB, BFF, Core, Auth, E2E Vite）を動的生成
- `setup-env.sh` にテンプレートコピーを追加
- `.env.template` に API テスト Docker ポートを追加

### Phase 2: Docker Compose & justfile の動的化

- `docker-compose.api-test.yaml` のハードコードポートを環境変数参照（`${API_TEST_POSTGRES_PORT}:5432` 等）に変更
- `justfile` の `api-test-deps`, `api-test-reset-db`, `api-test-stop`, `api-test-clean` を動的プロジェクト名・ポートに変更

### Phase 3: テストスクリプトの動的化

- `run-api-tests.sh` / `run-e2e-tests.sh` を `set -a && source .env.api-test && set +a` 方式にリファクタリング
- ヘルスチェック URL を `$BFF_PORT`, `$CORE_PORT`, `$AUTH_PORT` で動的参照
- `vars.env` から `bff_url` を削除し、`--variable` フラグで動的に渡す方式に変更

### Phase 4: CI ワークフロー更新

- `api-test` / `e2e-test` ジョブに `just setup-env` ステップを追加
- ハードコードポート参照を環境変数に置換

### Phase 5: ドキュメント更新

- 並行開発手順書のポートオフセット表を開発環境・テスト環境に分割
- テスト実行セクションを追加

## 判断ログ

- hurl の `--variable` は `--variables-file` をオーバーライドしない（重複変数はエラー）。計画段階で想定していたオーバーライド方式を変更し、`vars.env` から `bff_url` を削除して `--variable` のみで渡す方式に修正した
- ポートスキームとして、開発環境とテスト環境の間でインフラポートは +1、サービスポートは +1000 の差分を設定。100 単位のオフセット内で衝突しない設計
- `DATABASE_URL` 変更による cargo 全再コンパイルの発生を確認。sqlx のコンパイル時クエリ検証に起因する既存の挙動であり、本変更による退行ではない
- `setup-env.sh` が `.env` の存在のみで早期 exit し、`backend/.env.api-test` が欠けていてもスキップするバグを発見。rebase 後に `.env.api-test` が消失するケースで発覚。既存オフセットを維持して不足ファイルのみ再生成する方式に修正した

## 成果物

### コミット

| コミット | 内容 |
|---------|------|
| `c1b9fb2` | Phase 1: 環境変数ファイル体系の変更 |
| `788bc36` | Phase 2: Docker Compose & justfile の動的化 |
| `5dc7040` | Phase 3: テストスクリプトの動的化 |
| `b651ef5` | Phase 4: CI ワークフロー更新 |
| `ca7b501` | Phase 5: ドキュメント更新 |
| — | 実装解説ドキュメント追加 |
| — | `setup-env.sh` のファイル欠損時再生成修正 |

### 変更ファイル（13 ファイル）

- `.env.template`, `.gitignore`, `backend/.env.api-test.template`
- `scripts/generate-env.sh`, `scripts/setup-env.sh`
- `infra/docker/docker-compose.api-test.yaml`
- `justfile`
- `scripts/run-api-tests.sh`, `scripts/run-e2e-tests.sh`
- `tests/api/hurl/vars.env`
- `.github/workflows/ci.yaml`
- `docs/60_手順書/04_開発フロー/04_並行開発（Worktree）.md`
- `prompts/plans/stateless-skipping-avalanche.md`

### PR

- [#624](https://github.com/ka2kama/ringiflow/pull/624)（Draft）
