# audit_log テスト並列実行の安定化

## 概要

Issue #540 に対応し、`audit_log_repository_test.rs` のテーブルセットアップを `tokio::sync::OnceCell` で共有化、`justfile` から `--test-threads=1` を削除して統合テストの並列実行を安定化した。

## 実施内容

### Issue 精査

- 現在の main ブランチで元の dispatch failure が再現するか検証（audit_log テスト 5 回、全統合テスト 3 回、全て成功）
- `--test-threads=1` は PR #536 で導入された回避策であり、構造的修正は未実施だったことを確認

### 設計と実装

1. `tokio::sync::OnceCell<()>` でテーブルセットアップの一度だけ実行を保証
2. DynamoDB クライアントは各テストで独立に作成（コネクションプール分離）
3. `justfile` から `--test-threads=1` と関連コメントを削除

### 実装時の発見: クライアント共有の問題

最初の実装では `DynamoDbAuditLogRepository` 全体を `OnceCell` で共有したが、6/9 テストが成功、3/9 が dispatch failure で失敗した。

原因: AWS SDK の `Client` が内部に持つ HTTP コネクションプールがボトルネックとなり、9 テストが同時リクエストを発行するとプールが枯渇する。

対策: テーブルセットアップのみ `OnceCell<()>` で共有し、各テストが独自のクライアント（独自のコネクションプール）を作成する設計に変更。全 9 テストが並列実行で安定的に成功するようになった。

## 判断ログ

- `tokio::sync::OnceCell` を選択（`std::sync::LazyLock` は async 非対応、`once_cell` クレートは tokio 組み込みで代替可能）
- テーブルセットアップのみ共有に方針変更（クライアント全体共有でコネクションプール競合を実験的に発見）
- `dynamodb_test.rs` は対象外と判断（各テストが UUID ベースの独自テーブル名で分離済み）
- `dynamodb_endpoint()` の共通化は見送り（重複 2 箇所で DRY ルール「3 回まで許容」の範囲内）

## 成果物

### コミット

- `#540 Share DynamoDB table setup via OnceCell and remove --test-threads=1`

### 変更ファイル

- `backend/crates/infra/tests/audit_log_repository_test.rs` — OnceCell によるテーブルセットアップ共有化
- `justfile` — `--test-threads=1` の削除

### PR

- #600 (Draft)

## 議論の経緯

- `once_cell` クレートの現状について質問があり、`once_cell::sync::OnceCell` → `std::sync::OnceLock`（Rust 1.70）、`once_cell::sync::Lazy` → `std::sync::LazyLock`（Rust 1.80）への統合を解説。ただし async 初期化には引き続き `tokio::sync::OnceCell` が必要。
