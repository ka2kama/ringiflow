# Lightsail デプロイ構成

## 概要

AWS Lightsail + Cloudflare による個人検証環境を構築した。OS を AlmaLinux 9.4、プランを $7（1GB）の IPv6-only で構成し、実際のデプロイまで完了した。

## 背景と目的

- ローカル以外の環境で動作確認・デモができる検証環境が必要だった
- ADR-030 で Lightsail + Cloudflare の方針を決定済み
- PR #91（`feature/lightsail-deploy`）として段階的に構成を整備

## 実施内容

1. OS を Ubuntu 24.04 から AlmaLinux 9.4 に変更（RHEL 系の学習効果を重視）
2. プランを $10（2GB）から $7（1GB）に変更（Rust の軽量さを活かす）
3. IPv6-only インスタンスを採用（$5 プラン、Cloudflare が IPv4 → IPv6 変換）
4. SSH 鍵を SSH エージェント（1Password）対応に変更
5. setup.sh を起動スクリプト（root 実行）対応に修正
6. Cloudflare の設定（DNS、SSL/TLS: Flexible）
7. デプロイ実行、全サービス起動確認
8. マイグレーション実行（psql 経由）
9. `https://demo.ka2kama.com` でのアクセス確認

## 設計上の判断

| 判断 | 選択 | 理由 |
|------|------|------|
| OS | AlmaLinux 9.4 | RHEL 系の実戦経験（SELinux、firewalld、dnf）がキャリア上の差別化になる |
| プラン | $7（1GB） | Rust サービスは軽量（3サービス合計 ~90MB）で 1GB に収まる |
| ネットワーク | IPv6-only | Cloudflare が IPv4 変換を担うため問題なし。コスト削減 |
| SSL モード | Flexible | オリジン側に SSL 設定が不要。Full は 443 接続が必要 |
| Elm インストール | Dockerfile で `npm install -g` | ADR-002 のグローバルインストール方針を Docker 内でも踏襲 |
| マイグレーション | psql 直接実行 | IPv6-only 環境で Docker コンテナからインターネットに出られないため |

## 成果物

### コミット

| コミット | 内容 |
|---------|------|
| `839c4e4` | Lightsail デプロイ構成を追加 |
| `0ecebdd` | ShellCheck の警告を修正 |
| `1b483b7` | 現行アーキテクチャに合わせてデプロイ設定を更新 |
| `1298870` | OS を Ubuntu 24.04 から AlmaLinux 9.4 に変更 |
| `5784b68` | プランを $10（2GB）から $7（1GB）に変更 |
| `b501b17` | SSH 鍵をオプション化（SSH エージェント対応） |
| `7446f17` | setup.sh を起動スクリプト対応に修正 |
| `5a5949e` | デプロイの問題修正（IPv6 SCP、Elm、vim） |

### 作成・更新ファイル

- `backend/Dockerfile` — バックエンド Docker イメージ
- `frontend/Dockerfile` — フロントエンド Docker イメージ（Elm グローバルインストール追加）
- `infra/lightsail/` — デプロイ構成一式（docker-compose.yaml、setup.sh、deploy.sh、nginx 設定等）
- `docs/05_ADR/030_Lightsail個人環境の構築.md` — 変更履歴追記

## 議論の経緯

### OS の選定

Ubuntu がサーバーで一般的かという議論から、AlmaLinux の選択肢が浮上。Lightsail で AlmaLinux 9.4 が利用可能であることを確認し、RHEL 系の学習効果（SELinux、firewalld、dnf）を重視して採用した。

### IPv6-only の採用

デュアルスタックと IPv6-only の価格差に気づき、Cloudflare が IPv4 → IPv6 変換を行えることを確認して IPv6-only を採用。結果として Docker コンテナからの外部接続問題が発生し、マイグレーション手順の変更が必要になった。

### Elm の Docker ビルドエラー

Docker ビルドで `elm` が見つからないエラーが発生。最初は `package.json` に追加しようとしたが、手順書に「Elm はグローバルインストール前提（ADR-002）」と明記されていることを指摘され、Dockerfile で `npm install -g elm` する方針に修正した。

### SSL モードの選択

Cloudflare の SSL モードを Full に設定していたが、522 エラーが発生。Full モードは Cloudflare がオリジンに HTTPS（ポート 443）で接続するが、Nginx は HTTP（ポート 80）のみだったため。Flexible に変更して解決。

## 学んだこと

- IPv6-only + Docker は要注意: Docker のデフォルトブリッジネットワークは IPv4 のみ。コンテナ内からの外部通信は追加設定が必要
- SCP と IPv6: SCP はコロンをホスト/パス区切りに使うため、IPv6 アドレスは角括弧で囲む必要がある（SSH は不要）
- Cloudflare SSL モード: Full は 443、Flexible は 80 に接続。オリジンの構成に合わせる
- Lightsail リソース名: SSH キーペアとインスタンスで名前が衝突する（名前空間が共通）
- 既存ドキュメントの確認は必須: 手順書に明記された設計判断を見落として誤った対策を出してしまった

## 発見した問題

- Docker コンテナからの IPv6 外部接続: デーモン設定で対応可能だが未実施
- README の SSL モード記述が Full のまま（Flexible に修正が必要）
- マイグレーション手順が sqlx-cli 前提（psql 代替手順の追記が必要）

## 次のステップ

- README 更新（SSL モード、マイグレーション手順、IPv6 注意事項）
- 認証・ログイン機能の確認（本番環境では DevAuth 無効）
- Cloudflare キャッシュルール・セキュリティ設定の確認
