# #859 型安全ステートマシン: 既存実装の新判断基準での再評価

## 概要

#855 で変更された判断基準（「ADT で表現できるか」→「不正な状態遷移が型レベルで防止されているか」）に基づき、既存6実装を再評価した。特定された4つの改善候補のうち3つを実装した。

## 実施内容

### Phase 1: CancelledState 遷移元 ADT 分離（backend）

- `CancelledState` を flat struct から enum に変更（`FromDraft`/`FromPending`/`FromActive`）
- 遷移元ごとに異なるフィールド組み合わせを型レベルで強制
- `from_db()` のパターンマッチで不正な相関（`current_step_id=Some, submitted_at=None`）を自然に検出
- `completed_at()` のワイルドカード `_ => None` を全バリアント列挙に変更
- ヘルパーメソッド（`completed_at()`, `current_step_id()`, `submitted_at()`）を `CancelledState` に定義し getter からデリゲート
- TDD で新規テスト（不正相関拒否）を追加、既存33テスト全通過

### Phase 2: Detail.elm EditState 分離（frontend）

- `isEditing: Bool` + フラットフィールドを `EditState = Viewing | Editing EditingState` ADT に変更
- 編集中のみ有効なフィールド（`editFormData`, `editApprovers`, `resubmitValidationErrors`, `isResubmitting`）を `EditingState` に移動
- `updateEditing` ヘルパー関数で編集状態更新を一元化
- `validateResubmit`/`buildResubmitApprovers` の引数を `EditingState` に変更
- view 関数群を `EditState` の case 式に対応させ、`EditingState` を明示的に引き回し
- New.elm の `FormState = SelectingDefinition | Editing EditingState` パターンと一貫
- Elm コンパイラの型チェック通過、全456テスト通過

## 判断ログ

- 設計判断: Candidate 1（ロジックバリデーション）→ Candidate 3（ADT 分離）に変更。理由: 型制約はコンパイラが強制、ロジック制約は将来の開発者/AI が削除・回避・書き忘れるリスクがある
- 設計判断: `users` フィールドは `EditingState` に移動せず `LoadedState` に残す。理由: New.elm との一貫性、編集セッション間のキャッシュ可能性
- Refactor: `updateEditing` ヘルパーを抽出し、`case loaded.editState of` の繰り返しパターンを削減
- Refactor: `viewEditableFormData` に `EditingState` 引数を追加し、型で閲覧モードでの編集データアクセスを防止

## 議論の経緯

- 初期設計で Candidate 1（`from_db()` に `if` 文を追加するロジックバリデーション）を提案したところ、「型ではなくロジックで制約を組んでいるように見えるが、今後 AI がそこを間違えないと言えるか」という指摘を受けた
- この指摘はプロジェクトの設計原則「型で表現できるものは型で表現する」に合致しており、Candidate 3（型レベルの ADT 分離）に修正した
- KISS を設計品質を妥協する根拠にしてはならないという原則（CLAUDE.md）の実践例となった

## 成果物

### コミット

- `05da05b` #859 WIP: Re-evaluate type-safe state machine implementations
- `7be5090` #859 Separate CancelledState into ADT variants by transition source
- `d59ea3b` #859 Separate editing state into EditState ADT in Detail.elm

### 作成/更新ファイル

- `backend/crates/domain/src/workflow/instance.rs` — CancelledState ADT 分離
- `frontend/src/Page/Workflow/Detail.elm` — EditState ADT 分離
- `prompts/plans/859_type-safe-state-machine-reevaluation.md` — 計画ファイル

### PR

- [#864](https://github.com/ka2kama/ringiflow/pull/864) — Draft → Ready for Review 待ち
