# フロントエンド: 多段階承認・差し戻し・コメント UI

## 概要

Issue #478 のフロントエンド UI を実装。バックエンド API（#475, #476, #477）に対応する Elm フロントエンドを 6 Phase で構築した。

## 実施内容

### Phase A: Data 層（型・デコーダー・API）

- `Data.WorkflowInstance`: `ChangesRequested` ステータスと `DecisionRequestChanges` を追加。各ヘルパー関数（statusToString, statusToJapanese, statusToCssClass 等）を更新
- `Data.WorkflowComment`: 新規モジュール。コメントの型とデコーダー
- `Data.WorkflowDefinition`: `approvalStepInfos` 関数を追加。定義 JSON からステップ ID + 名前のペアを抽出
- `Api.Workflow`: `requestChangesStep`, `resubmitWorkflow`, `listComments`, `postComment` を追加
- `Route.elm`: `changes_requested` クエリパラメータ対応

### Phase B: ステータス表示

- `Page.Workflow.List`: statusOptions に「差し戻し」フィルターを追加
- `Page.Workflow.Detail`: `viewStepProgress` でステップ進行状況をバー表示

### Phase C: 差し戻しフロー

- `PendingAction` に `ConfirmRequestChanges` を追加
- `ConfirmDialog` に `Warning` バリアント（黄色系スタイル）を追加
- 承認者がアクティブステップで「差し戻し」を実行可能に

### Phase D: コメントセクション

- Detail.elm の Model に `comments`, `newComment`, `isPostingComment` を追加
- 詳細ページ下部にコメント一覧 + 投稿フォームを表示
- 投稿成功時はリスト末尾に追加（再取得不要）

### Phase E: 再提出フロー

- `ChangesRequested` かつ起案者の場合に「再提出」ボタンを表示
- インライン編集モード（`isEditing` フラグ）でフォームデータと承認者を再設定
- `resubmitWorkflow` API 呼び出しで再提出

### Phase F: 多段階承認者選択

- `New.elm` の承認者を `ApproverSelector.State` → `Dict String ApproverSelector.State` に変更
- Msg にステップ ID を第一引数として追加（例: `ApproverKeyDown String String`）
- `viewApproverSection` を `WorkflowDefinition -> Model -> Html Msg` に変更し、各ステップごとに独立した ApproverSelector を描画

### テスト

- `WorkflowInstanceTest`: ChangesRequested/DecisionRequestChanges の全ヘルパー関数
- `WorkflowCommentTest`: デコーダーテスト
- `WorkflowDefinitionTest`: `approvalStepInfos` フィルタリングテスト
- `RouteTest`: ChangesRequested クエリパラメータ
- `NewTest`: Dict ベース多段階承認者選択に対応

## 判断ログ

- Phase A: `approvalStepInfos` を `approvalStepIds`（ID のみ）ではなく `{ id, name }` ペアで返す設計に変更。UI でステップ名表示が必要なため
- Phase C: `ConfirmDialog` に `Warning` バリアント追加。既存 `Danger` バリアントとは意味が異なる（差し戻しは却下より軽い操作）
- Phase F: `Dict String ApproverSelector.State` を採用。List ではなくステップ ID ルックアップが頻繁なため
- Phase F: 不要になった `approvalStepIds` 関数を削除。elm-review の NoUnused.Exports が検出

## 成果物

コミット:
- `e92c81e` #478 Implement frontend multi-step approval, request-changes, and comment UI

新規ファイル:
- `frontend/src/Data/WorkflowComment.elm`
- `frontend/tests/Data/WorkflowCommentTest.elm`

主な変更ファイル:
- `frontend/src/Page/Workflow/Detail.elm`（+772 行）
- `frontend/src/Page/Workflow/New.elm`（+361/-226 行）
- `frontend/src/Api/Workflow.elm`（+143 行）
