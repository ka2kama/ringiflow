# CI シフトレフト

Issue: #450 CI で初めて検出される問題のシフトレフト

## 概要

CI でのみ検出されていた問題（フォーマット違反、静的チェック違反）をローカルの Git フック（lefthook）と `just check` に組み込み、開発者がプッシュ前に検出できるようにした。

## 実施内容

### Issue 精査

- Issue #450 の As-Is を検証: CI で初めて検出される問題のカテゴリを分類
- pre-push の実行時間についてユーザーと議論し、lint + unit test のみ（DB 不要、約1-2分）にスコープを決定

### Phase 1: pre-commit フォーマットチェック

- `lefthook.yaml` に `rustfmt-check` と `elm-format-check` を追加
- `glob` + `{staged_files}` で staged ファイルのみ対象（秒単位で完了）
- 既存の `no-yml-extension` と `parallel: true` で並列実行

### Phase 2: 静的チェックスクリプト

3つの新規チェックスクリプトを作成し、`just check` に統合:

1. `scripts/check-doc-links.sh`: ドキュメント内の相対パスリンク切れチェック
   - 対象: `docs/`, `prompts/`, `.claude/`, `CLAUDE.md`
   - HTTP リンク、アンカー、テンプレート変数をスキップ
   - 167件の既存リンク切れがあるため warning-only（exit 0）
2. `scripts/check-impl-docs.sh`: 実装解説の命名規則チェック
   - ディレクトリ名（`NN_<機能名>/`）とファイル名（`NN_<トピック>_{機能解説,コード解説}.md`）を検証
   - 機能解説とコード解説のペアチェック（トピック単位で照合）
   - 2件の既存違反があるため warning-only（exit 0）
3. `just lint-rules`（既存 `check-rule-files.sh` の just レシピ化）

### Phase 3: pre-push フック

- `check-parallel.sh` に `--skip-db` オプションを追加
- DB 不要のチェックのみ実行: lint-rust, test-rust, openapi-check + Non-Rust レーン全体
- `just check-pre-push` レシピを追加し、lefthook の pre-push から呼び出し

### 改善記録の再発対応

- `/restore` スキルの不要な確認プロンプト再発に対応
- 既存改善記録に検証セクションを追加
- スキル定義を「確認は不要」から「**禁止:**」形式に強化

## 判断ログ

- チェック階層の設計: pre-commit（秒）→ pre-push（1-2分、DB 不要）→ `just check`（3-5分、DB 必要）→ `just check-all`（5-10分、全体）
- pre-push スコープの決定: ユーザーとの議論で「lint + unit test のみ」を選択。DB 接続が必要な統合テスト・sqlx-check・schema-check は除外
- warning-only パターン: 既存違反がある check-doc-links.sh と check-impl-docs.sh は exit 0 で警告のみ。既存の check-file-size.sh, check-duplicates と同じパターン
- check-impl-docs.sh のペアチェック: NN 番号ではなくトピック部分で照合。同一トピックの機能解説とコード解説が異なる NN 番号を持つケースに対応

## 成果物

### コミット

1. `#450 WIP: Shift left CI-detected issues to local hooks and checks`（空コミット、Draft PR 用）
2. `#450 Add pre-commit format checks (rustfmt + elm-format)`
3. `#450 Add static check scripts (rule-files, doc-links, impl-docs) to just check`
4. `#450 Add pre-push hook with DB-independent check subset`
5. `#450 Strengthen restore skill anti-confirmation rule (improvement recurrence fix)`
6. `#450 Add plan file for CI shift-left implementation`

### 変更ファイル

| ファイル | 変更内容 |
|---------|---------|
| `lefthook.yaml` | pre-commit に rustfmt-check, elm-format-check 追加。pre-push に check-pre-push 追加 |
| `justfile` | lint-rules, check-doc-links, check-impl-docs, check-pre-push レシピ追加 |
| `scripts/check-parallel.sh` | --skip-db オプション追加、Non-Rust レーンに新チェック追加 |
| `scripts/check-doc-links.sh` | 新規作成 |
| `scripts/check-impl-docs.sh` | 新規作成 |
| `.claude/skills/restore/SKILL.md` | 確認禁止ルール強化 |
| `prompts/improvements/2026-02/2026-02-16_2312_restoreスキルの冗長な確認プロンプト.md` | 検証セクション追加 |
| `prompts/plans/450-ci-shift-left.md` | 計画ファイル |

### Draft PR

- PR #595: https://github.com/ka2kama/ringiflow/pull/595

## 議論の経緯

- `/restore` で不要な確認を挟んだことに対するユーザーの指摘。既存改善記録の再発であり、スキル定義の強化で対応
- pre-push の実行時間について「シフトレフトするには実行時間の問題も無視できない」とユーザーから指摘。CI の実行時間データを測定し、DB 不要の subset（約1-2分）を提案。ユーザーが「lint + unit test のみ」を選択
