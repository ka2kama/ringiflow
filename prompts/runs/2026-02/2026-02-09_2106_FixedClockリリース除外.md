# FixedClock リリース除外

## 概要

`FixedClock` をリリースビルドから除外するため、domain クレートに `test-support` feature flag を導入し、`FixedClock` を条件付きコンパイル（`#[cfg(any(test, feature = "test-support"))]`）にした。

## 背景と目的

Issue: #348

#338 で `Clock` trait と `FixedClock` を `domain` クレートに導入した。`FixedClock` はテスト専用だが `#[cfg(test)]` なしで定義されており、リリースビルドに含まれていた。ユーザーがこれに気づき、#348 として Issue 化した。

## 実施内容

### feature flag 導入と条件付きコンパイル

- `domain` クレートの `Cargo.toml` に `[features] test-support = []` を追加
- `FixedClock` の struct、`impl FixedClock`、`impl Clock for FixedClock` の3箇所に `#[cfg(any(test, feature = "test-support"))]` を付与
- `core-service` の `[dev-dependencies]` に `ringiflow-domain = { workspace = true, features = ["test-support"] }` を追加

## 設計上の判断

### feature flag vs テスト専用クレート

Issue では「テスト専用クレート（`test-support`）を作成」を提案していたが、feature flag アプローチを採用した。

| 方法 | 判断 | 理由 |
|------|------|------|
| feature flag（採用） | `FixedClock` は `Clock` trait のテストダブルであり、trait の隣に置くのが自然（凝集度）。構造体1つのために新クレートは過剰（KISS/YAGNI） | |
| テスト専用クレート（不採用） | 明確な分離は得られるが、現時点ではオーバーエンジニアリング | |

Rust エコシステムでは `tokio` の `test-util` など、feature flag でテスト用コードをゲートするパターンが広く使われている。

### `#[cfg(any(test, feature = "test-support"))]` の設計

`#[cfg(test)]` はそのクレート自身のテスト時にしか有効にならない。`core-service` のテスト時に `domain` クレートの `#[cfg(test)]` は有効にならないため、feature flag で補完する必要がある。

| ビルド | test | test-support | FixedClock |
|--------|------|-------------|------------|
| `cargo build`（リリース含む） | false | false | 除外 |
| `cargo test -p ringiflow-domain` | true | false | 含む |
| `cargo test -p ringiflow-core-service` | false（domain 側） | true | 含む |

## 判断ログ

特筆すべき判断なし。設計フェーズで全ての判断が完了しており、実装は計画通りに進行した。

## 成果物

### コミット

| コミット | 内容 |
|---------|------|
| `f6f08d6` | feature flag 導入、FixedClock の条件付きコンパイル化 |

### 変更ファイル

| ファイル | 変更内容 |
|---------|---------|
| `backend/crates/domain/Cargo.toml` | `[features] test-support = []` 追加 |
| `backend/crates/domain/src/clock.rs` | `FixedClock` に cfg ゲート付与（3箇所） |
| `backend/apps/core-service/Cargo.toml` | dev-dependencies に features 付き ringiflow-domain 追加 |

## 議論の経緯

### FixedClock のリリースビルド混入

前セッション（#338 Clock DI 導入）の PR #346 を Ready for Review にした後、ユーザーから「FixedClock はリリースビルドに含めるのですか？」と指摘を受けた。対策の選択肢を4つ提示し、テスト専用クレートを推奨した。ユーザーは「別 Issue で対応する」と判断し、#348 を作成した。

### feature flag vs テスト専用クレート

#348 着手時、Issue の精査で「テスト専用クレート」を How として検証した。構造体1つのために新クレートを作るのは YAGNI であり、feature flag の方がシンプルで凝集度も高いと判断した。計画ファイルに記載し、ユーザーの承認を得て feature flag で実装した。

## 学んだこと

- `#[cfg(test)]` のスコープはクレート境界で切れる。依存先クレートのテスト時に依存元の `#[cfg(test)]` は有効にならない。クロスクレートでテスト用コードを共有するには feature flag または別クレートが必要
- `dev-dependencies` で workspace 依存に features を追加指定すると、テスト時のみ feature が有効化される。リリースビルドには影響しない

## 次のステップ

- PR #349 を Ready for Review にする
