# 削除レジストリ基盤実装

Issue: #449
PR: #466
ブランチ: `feature/449-issue`

## 概要

テナント退会時のデータ削除を一元管理する削除レジストリ基盤を実装した。`TenantDeleter` トレイトで各データストアの削除操作を統一し、`DeletionRegistry` で全 Deleter を集約して一括削除・件数取得を提供する。全7データストア（PostgreSQL x4、Auth、DynamoDB、Redis）の Deleter を実装し、登録漏れ検出テスト・統合テストを整備した。

## 実施内容

### Phase 1: TenantDeleter トレイト + DeletionRegistry

- `TenantDeleter` トレイト定義（`#[async_trait]` + `Send + Sync`）
  - `name()`: Deleter 識別名（`&'static str`）
  - `delete()`: テナントデータ削除、削除件数を返す
  - `count()`: テナントデータ件数取得
- `DeletionResult` 構造体（`deleted_count: u64`）
- `DeletionRegistry`: `Vec<Box<dyn TenantDeleter>>` で Deleter を集約
  - `delete_all()` / `count_all()`: 全 Deleter を順次実行し HashMap で返却
- `deletion/mod.rs` でモジュール定義、`lib.rs` に `pub mod deletion` 追加

### Phase 2: PostgreSQL Deleter x4 + Auth Credentials Deleter

- `PostgresUserDeleter`: `DELETE FROM users WHERE tenant_id = $1`（user_roles は CASCADE）
- `PostgresRoleDeleter`: `DELETE FROM roles WHERE tenant_id = $1`
- `PostgresWorkflowDeleter`: FK 安全な順序で削除（steps → instances → definitions）、合計件数を返却
- `PostgresDisplayIdCounterDeleter`: `DELETE FROM display_id_counters WHERE tenant_id = $1`
- `AuthCredentialsDeleter`: `DELETE FROM auth.credentials WHERE tenant_id = $1`
- 統合テスト 8件（`#[sqlx::test]` 使用、他テナント非影響テスト含む）

### Phase 3: DynamoDB Audit Log Deleter

- `DynamoDbAuditLogDeleter`: Query でキー取得 → BatchWriteItem で 25件ずつ削除
  - ページネーション対応（`last_evaluated_key`）
  - `count()` は `Select::Count` で効率的に取得

### Phase 4: Redis Session Deleter

- `RedisSessionDeleter`: `session:{tenant_id}:*` と `csrf:{tenant_id}:*` の2パターンを SCAN + DEL
  - `scan_count()` / `scan_and_delete()` ヘルパーメソッドで共通化

### Phase 5: DeletionRegistry factory + 登録漏れ検出テスト

- `with_all_deleters()`: 全 Deleter を登録済みの Registry を生成するファクトリメソッド
- `expected_deleter_names()`: 期待される Deleter 名の定数リスト（DB 接続不要）
- 登録漏れ検出テスト 3件（重複なし、全カテゴリカバー、具体的内容の完全一致）

### Phase 6: 仕上げ

- `.claude/rules/data-store.md` のパス参照を更新
- Clippy 対応（`Default` impl 追加）

## 判断ログ

- ワークフロー削除順序: FK 制約（`workflow_steps → workflow_instances → workflow_definitions`）に従い steps → instances → definitions の順で削除。CASCADE に任せず明示的に順序制御した理由は、削除件数の正確な報告のため
- DynamoDB 削除パターン: BatchWriteItem を採用。DeleteTable + 再作成は他テナントのデータを巻き込むため不可。25件/バッチの AWS 制限に対応
- Redis 削除パターン: KEYS コマンドは本番環境でブロッキングのリスクがあるため SCAN を採用。session と csrf の2パターンを網羅
- 登録漏れ検出: `expected_deleter_names()` を定数関数として定義し、DB 接続不要でテスト可能にした。`with_all_deleters()` は実接続が必要なため、構造的な検証のみ実施

## 成果物

### コミット

- `#449 Implement deletion registry for tenant data cleanup`

### 作成ファイル

| ファイル | 内容 |
|---------|------|
| `backend/crates/infra/src/deletion/mod.rs` | モジュール定義、TenantDeleter トレイト、DeletionResult |
| `backend/crates/infra/src/deletion/registry.rs` | DeletionRegistry（ファクトリ + 一括操作 + 単体テスト） |
| `backend/crates/infra/src/deletion/postgres_user.rs` | PostgresUserDeleter |
| `backend/crates/infra/src/deletion/postgres_role.rs` | PostgresRoleDeleter |
| `backend/crates/infra/src/deletion/postgres_workflow.rs` | PostgresWorkflowDeleter |
| `backend/crates/infra/src/deletion/postgres_display_id.rs` | PostgresDisplayIdCounterDeleter |
| `backend/crates/infra/src/deletion/auth_credentials.rs` | AuthCredentialsDeleter |
| `backend/crates/infra/src/deletion/dynamodb_audit_log.rs` | DynamoDbAuditLogDeleter |
| `backend/crates/infra/src/deletion/redis_session.rs` | RedisSessionDeleter |
| `backend/crates/infra/tests/postgres_deleter_test.rs` | PostgreSQL + Auth 統合テスト（8件） |
| `backend/crates/infra/tests/deletion_registry_test.rs` | 登録漏れ検出テスト（3件） |
| `prompts/plans/449_deletion-registry.md` | 実装計画 |

### 更新ファイル

| ファイル | 変更内容 |
|---------|---------|
| `backend/crates/infra/src/lib.rs` | `pub mod deletion` 追加 |
| `.claude/rules/data-store.md` | 削除ハンドラのパス参照を更新 |
