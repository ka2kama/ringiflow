# ワークフローコメント機能実装

Issue: #477

## 概要

ワークフローに対するコメントスレッド機能を全レイヤー（DB → Domain → Infra → UseCase → Core Service → BFF → OpenAPI → API テスト）で実装した。承認プロセス中に申請者と承認者がコメントでやり取りできるようになる。

## 実施内容

計画ファイル `prompts/plans/477_workflow-comments.md` に基づき、6 Phase を実装した。

### Phase 1: マイグレーション + ドメインモデル（前セッション）

- `workflow_comments` テーブル作成（RLS + テナント分離）
- `WorkflowComment` エンティティ、`CommentBody` 値オブジェクト（1〜2000 文字）
- `WorkflowCommentId` UUID v7 Newtype

### Phase 2: リポジトリ（前セッション）

- `WorkflowCommentRepository` trait（`insert`, `find_by_instance`）
- `PostgresWorkflowCommentRepository` 実装
- `MockWorkflowCommentRepository` 追加
- テナント削除レジストリへの登録
- 統合テスト 5 件

### Phase 3: ユースケース

- `WorkflowUseCaseImpl` に `comment_repo` 依存追加
- `post_comment`: 権限チェック（`is_participant`）+ コメント作成
- `list_comments`: display_number でインスタンス解決 + コメント一覧取得
- ユニットテスト 6 件（申請者投稿、承認者投稿、非関与者 403、NotFound、一覧取得）
- 既存テスト 18 箇所の `new()` 呼び出しに `comment_repo` パラメータ追加

### Phase 4: Core Service ハンドラ

- `PostCommentRequest`, `WorkflowCommentDto` 型追加
- `post_comment` ハンドラ（POST、201 Created）
- `list_comments` ハンドラ（GET、200 OK + ユーザー名一括解決）
- ルート登録: `/internal/workflows/by-display-number/{dn}/comments`

### Phase 5: BFF + OpenAPI + CoreServiceClient

- `PostCommentCoreRequest`, `WorkflowCommentDto` — Core Service 通信用型
- `CoreServiceWorkflowClient` トレイトに `post_comment`, `list_comments` 追加
- `PostCommentRequest`, `WorkflowCommentData` — BFF 公開 API 型（ToSchema）
- BFF ハンドラ: セッション認証 + CSRF + Core Service 呼び出し
- OpenAPI: 2 エンドポイント + 4 スキーマ追加

### Phase 6: API テスト（Hurl）

- 7 テストシナリオ: 申請者投稿 201、CSRF 403、空文字 400、承認者投稿 201、一覧取得 200（時系列順）、存在しない WF 投稿 404、存在しない WF 一覧 404

## 判断ログ

- Phase 3: `is_participant` を `WorkflowUseCaseImpl` のプライベートメソッドとして配置。独立 UseCase にすると依存が重複するため
- Phase 4: `list_comments` でユーザー名一括解決パターンを踏襲（`list_my_workflows` と同じ `HashSet` → `resolve_user_names` パターン）
- Phase 5: `client.rs` の re-export に `PostCommentCoreRequest` と `WorkflowCommentDto` を追加する必要があった（初回コンパイルで検出）
- Phase 6: 「関与していないユーザーは投稿できない」テストは省略。テスト環境に admin/user の 2 ユーザーしかおらず、admin は申請者、user は承認者で両方とも関与者のため

## 成果物

### コミット

- `dfc4917` #477 Implement workflow comment feature (Phases 1-5)
- `d05996f` #477 Add workflow comments API test (Phase 6)

### 新規ファイル

| ファイル | 内容 |
|---------|------|
| `backend/migrations/20260212000002_create_workflow_comments.sql` | マイグレーション |
| `backend/crates/domain/src/workflow/comment.rs` | ドメインモデル |
| `backend/crates/infra/src/repository/workflow_comment_repository.rs` | リポジトリ |
| `backend/crates/infra/tests/workflow_comment_repository_test.rs` | 統合テスト |
| `tests/api/hurl/workflow/comments.hurl` | API テスト |

### 変更ファイル（26 ファイル）

全レイヤーの変更。詳細は `git diff --stat main...HEAD` を参照。
