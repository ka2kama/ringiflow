# CI セキュリティスキャニング（cargo-deny）

## 概要

CI パイプラインに cargo-deny による依存関係のセキュリティスキャニングを追加した。脆弱性検出（RustSec Advisory DB）、ライセンスチェック、禁止クレートチェック、ソース制限の 4 つのチェックを CI とローカル開発の両方で実行できるようにした。

## 背景と目的

要件定義書（CORE-02 12.8 節）で「依存関係スキャン | Rust クレート | cargo audit | 毎 CI」と定義されていた。Dependabot による週次の依存更新は有効だったが、CI でのブロッキングチェック（脆弱性検出時にマージを防止）は未導入だった。

Issue #289 として管理。

## 実施内容

1. cargo-deny のインストールと `cargo deny list` によるライセンス一覧の調査
2. `backend/deny.toml` の作成（advisories, licenses, bans, sources の 4 セクション）
3. `justfile` への統合（`audit` タスク、`check-tools` 追加、`check` に統合）
4. CI ワークフローに `security` ジョブを追加（`EmbarkStudios/cargo-deny-action@v2`）
5. ADR-033（セキュリティスキャニングツールの選定）の作成
6. 開発環境構築手順書の更新

## 設計上の判断

### cargo-deny 単体の採用（ADR-033）

cargo-audit ではなく cargo-deny 単体を採用した。

- cargo-deny の advisories チェックは cargo-audit と同じ RustSec Advisory DB を使用しており、脆弱性検出は完全に包含される
- 追加でライセンスチェック（12 ライセンス + 1 例外を許可）、禁止クレート、ソース制限もカバー
- 公式 GitHub Action（`EmbarkStudios/cargo-deny-action@v2`）があり、Rust ツールチェインのセットアップ不要

要件定義書の「cargo audit」は機能要件（脆弱性検出）の記述であり、cargo-deny で要件を満たせると判断した。

### ライセンス例外（r-efi）

`cargo deny list` の結果、r-efi クレートが LGPL-2.1-or-later であることが判明。EFI/UEFI 環境専用のライブラリで本プロジェクトでは直接使用しない（Windows ビルドの推移的依存）ため、allow リストに LGPL を追加せず、`[[licenses.exceptions]]` で個別の例外として処理した。

## 成果物

PR: #295

コミット:
- `8eac7c9` — cargo-deny 設定ファイル（`deny.toml`）作成
- `e605f5f` — justfile への統合
- `524104d` — CI に `security` ジョブ追加
- `b11054a` — ADR-033 と開発環境構築手順書の更新

作成・更新ファイル:
- `backend/deny.toml`（新規）
- `justfile`（更新）
- `.github/workflows/ci.yaml`（更新）
- `docs/05_ADR/033_セキュリティスキャニングツールの選定.md`（新規）
- `docs/04_手順書/01_開発参画/01_開発環境構築.md`（更新）

## 議論の経緯

特筆すべき議論はなし。Issue #289 の完了基準が明確だったため、計画承認後に順次実装を進めた。

## 学んだこと

### cargo-deny v0.19.0 の破壊的変更

初回の `deny.toml` 作成時、旧形式（`vulnerability = "deny"`, `unmaintained = "warn"` 等）で記述したところ、設定エラーが発生した。cargo-deny v0.19.0 以降では `[advisories]` セクションの `vulnerability`, `unsound`, `notice` は常にエラー扱いとなり設定不可になった。同様に `[licenses]` セクションの `unlicensed`, `deny`, `copyleft` も削除された。

公式ドキュメントを確認して正しい形式で書き直すことで解決。ツール設定はトレーニングデータではなく、インストール済みバージョンの公式ドキュメントで確認すべきという教訓。

### cargo-deny-action の独立性

`EmbarkStudios/cargo-deny-action@v2` は Action 内部で cargo-deny バイナリを独自に取得するため、CI ジョブに Rust ツールチェインのセットアップが不要。これにより `security` ジョブが軽量（Checkout + Action のみ）になった。
