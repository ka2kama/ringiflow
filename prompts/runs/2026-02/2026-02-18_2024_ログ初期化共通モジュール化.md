# ログ初期化共通モジュール化と構造化ログ対応

- Issue: #649（Story）、Epic #648（Observability 基盤）
- PR: #658

## 概要

3サービス（BFF / Core Service / Auth Service）で重複していたログ初期化コードを `ringiflow_shared::observability` モジュールに集約し、環境変数 `LOG_FORMAT` による JSON/Pretty 出力切替に対応した。ADR-049 の判断変更（クローン 2: jscpd:ignore → 共通関数抽出）を補遺として記録した。

## 実施内容

### Phase 1: LogFormat enum + TracingConfig（TDD）

- `LogFormat` enum（Json/Pretty、Default で Pretty）を作成
- `TracingConfig` struct（service_name, log_format）を作成
- `parse()` と `from_env()` を分離（Rust 2024 edition で `std::env::set_var` が `unsafe` のため、純粋関数のみテスト対象に）
- 5 つのユニットテスト作成・通過

### Phase 2: init_tracing() 実装

- `tracing_subscriber::fmt::layer().json()` と `fmt::layer()` の異なる型を `.boxed()` で `Box<dyn Layer<S>>` に統一
- `#[cfg(feature = "observability")]` による条件付きコンパイル
- JSON モードでは `flatten_event(true)`, `with_current_span(true)`, `with_span_list(false)` を設定

### Phase 3: 3サービス統合

- 3 つの main.rs から tracing_subscriber の直接利用を除去し、`ringiflow_shared::observability` に置換
- 各 app の Cargo.toml から `tracing-subscriber` 直接依存を削除
- shared の Cargo.toml に `observability` feature gate を追加
- `.env.template` と `.env.api-test.template` に `LOG_FORMAT=pretty` を追加
- `jscpd:ignore` マーカーを削除（サーバー起動パターン部分は残存）

### Phase 4: ADR 補遺

- ADR-049 に「補遺: クローン 2 の判断変更（#649）」を追加
- Observability 基盤により「変更頻度が低い」前提が崩れたことを記録

### 追加修正: cargo machete 対応

- `cargo machete` が shared の `tracing` 依存を未使用と検出
- `tracing` は shared 内で直接使用されず、`tracing_subscriber` の推移的依存で十分
- `observability` feature から `dep:tracing` を除去

## 判断ログ

- `.boxed()` 型消去を採用（JSON/Pretty フォーマッタの型統一。動的ディスパッチのオーバーヘッドはログ I/O に比べて無視できる）
- `LogFormat::parse` と `LogFormat::from_env` を分離（Rust 2024 edition の `unsafe set_var` 制約への対応。純粋関数のテスタビリティを確保）
- サービス名のスパンは `init_tracing()` 外部の main.rs で設定（`tracing::info_span!("app", service = "bff").entered()`）。init_tracing の責務を初期化のみに限定
- `observability` feature gate を採用（`openapi` feature の先例に倣い、shared の依存を最小化）
- `tracing` 直接依存を除去（`tracing_subscriber` の推移的依存で十分。`cargo machete` で検出）

## 成果物

### コミット

1. `#649 WIP: Centralize logging initialization and add structured JSON logging`（空コミット、Draft PR 用）
2. `#649 Add LogFormat enum and TracingConfig with TDD`（Phase 1）
3. `#649 Implement init_tracing() with JSON/Pretty format switching`（Phase 2）
4. `#649 Migrate 3 services to shared observability module`（Phase 3）
5. `#649 Add addendum to ADR-049 for clone 2 decision change`（Phase 4）
6. `#649 Remove unused tracing dependency from shared crate`（machete 修正）
7. `#649 Add implementation plan for structured logging`（計画ファイル）

### 作成・更新ファイル

| ファイル | 種別 |
|---------|------|
| `backend/crates/shared/src/observability/mod.rs` | 新規 |
| `backend/crates/shared/src/lib.rs` | 更新 |
| `backend/crates/shared/Cargo.toml` | 更新 |
| `backend/apps/bff/src/main.rs` | 更新 |
| `backend/apps/core-service/src/main.rs` | 更新 |
| `backend/apps/auth-service/src/main.rs` | 更新 |
| `backend/apps/bff/Cargo.toml` | 更新 |
| `backend/apps/core-service/Cargo.toml` | 更新 |
| `backend/apps/auth-service/Cargo.toml` | 更新 |
| `backend/.env.template` | 更新 |
| `backend/.env.api-test.template` | 更新 |
| `docs/05_ADR/049_サービス間共通コード抽出の方針.md` | 更新 |
| `prompts/plans/curried-humming-glacier.md` | 新規 |
