# ダッシュボードカードナビゲーション

## 概要

Issue #267: ダッシュボードの KPI カード（承認待ちタスク、申請中、本日完了）をクリックして対応するフィルタ付き一覧ページに遷移できるようにした。

フロントエンド（Elm）のみの変更。Phase 0〜3 の 4 段階で実装。

## 背景と目的

ダッシュボードの KPI カードは静的な数値表示のみだった。ユーザーが件数を見て詳細を確認したいとき、手動で一覧ページに遷移してフィルタを設定する必要があった。カードをクリックするだけで対応するフィルタ付き一覧ページに遷移できるようにすることで、UX を改善する。

## 実施内容

### Phase 0: 設計ブラッシュアップループの形式知化

Issue #267 の設計過程で確立した設計のブラッシュアップループを `zoom-rhythm.md` に形式知化。ギャップ発見の 6 観点、完了基準、ループ記録フォーマットを追加。

### Phase 1: Route 層の URL クエリパラメータ対応

- `Route` 型を `Workflows` → `Workflows WorkflowFilter` に変更
- `WorkflowFilter` 型（`status : Maybe Status`, `completedToday : Bool`）を定義
- `Url.Parser.Query` の `Query.enum`（status）と `Query.custom`（completedToday）でパース
- `Url.Builder.absolute` でクエリパラメータ付き URL を生成
- `isRouteActive` でフィルタを無視して比較（サイドバーのアクティブ表示用）

### Phase 2: 申請一覧のフィルタ連動

- `init` にフィルタと `Nav.Key` を渡し、URL クエリパラメータからフィルタを初期化
- `SetStatusFilter` で `Nav.replaceUrl` を呼び URL と同期（履歴を汚さない）
- `completedToday` クライアントサイドフィルタ: `Iso8601.toTime` + タイムゾーン対応日付比較
- Main.elm に同一ページ判定を追加（フィルタ変更時はデータ再取得しない）
- "本日完了のみ" バッジ + "×" 解除ボタンの UI

### Phase 3: ダッシュボードカードのリンク化

- `viewStatCard` を `viewStatCardLink` に変更（`div` → `a` 要素）
- 各カードの遷移先: 承認待ちタスク → `/tasks`、申請中 → `/workflows?status=in_progress`、本日完了 → `/workflows?completed_today=true`
- ホバーエフェクト追加

### 横断検証

`just check` で `Page/Workflow/Detail.elm` の `Route.Workflows` 引数漏れを発見・修正。

## 設計上の判断

### 1. `Url.Parser.Query` の採用

手動の `url.query` パースではなく、Elm 標準ライブラリの `Url.Parser.Query` を採用。`Query.enum` で型安全なパースが宣言的に記述でき、車輪の再発明を避けた。

### 2. `completedToday` のパーサー: `Query.custom`

`Query.enum` は `Maybe a` を返すため `Bool` に不適。`Query.custom` でキー absent → `[]` → `False` を自然に表現。

### 3. `completedToday` 優先

`completedToday=True` 時に `status` フィルタを無視するプリセット優先方式を採用。AND 結合では `status=draft&completed_today=true` で空結果になり非直感的。

### 4. `applyFilter` の返り値: `(Model, Cmd Msg)`

同一ページ遷移フローで `completedToday` が `True` に変わる際、フレッシュな `Time.now` が必要。純粋関数 `Model -> Model` では Cmd を発行できない。

### 5. `Tasks` ルートは変更なし

バックエンド API が Active タスクのみ返すため、クライアント側フィルタは無意味。

### 6. `Url.Builder` による URL 生成

手動の文字列結合ではなく `Url.Builder.absolute` を使用。URL エンコーディングの自動処理。

## 成果物

### コミット

1. `4874725` — Phase 0: 設計ブラッシュアップループの形式知化
2. `31406f8` — Phase 1: Route 層の URL クエリパラメータ対応
3. `f7a14d9` — Phase 2: 申請一覧のフィルタ連動
4. `aed8537` — Phase 3: ダッシュボードカードのリンク化
5. `802d211` — 横断検証修正: Detail.elm の Route.Workflows 引数追加

### 主要な変更ファイル

| ファイル | 変更内容 |
|---------|---------|
| `frontend/src/Route.elm` | `WorkflowFilter` 型、クエリパラメータのパース/生成 |
| `frontend/src/Main.elm` | 同一ページ判定、`initPage` シグネチャ変更 |
| `frontend/src/Page/Workflow/List.elm` | フィルタ連動、URL 同期、`completedToday` フィルタ |
| `frontend/src/Page/Home.elm` | KPI カードのリンク化 |
| `frontend/tests/RouteTest.elm` | クエリパラメータのパース/生成/ラウンドトリップテスト |
| `frontend/tests/Page/Workflow/ListFilterTest.elm` | フィルタロジックのテスト |
| `.claude/rules/zoom-rhythm.md` | 設計ブラッシュアップループの形式知化 |

### PR

- [#268](https://github.com/ka2kama/ringiflow/pull/268)（Draft）

## 議論の経緯

### 設計計画のブラッシュアップ（前セッション）

設計計画を 3 回のブラッシュアップループで改訂。主な改訂点:

1. ループ 1: 手動パース → `Url.Parser.Query` に変更。Task フィルタ削除（API が Active のみ返すため）
2. ループ 2: `completedTodayParser` を `Query.custom` で具体定義。`applyFilter` の返り値を `(Model, Cmd Msg)` に変更
3. ループ 3: `completedToday` と `status` の優先順位ルール確定。フィルタ UI のバッジ + ドロップダウン連動仕様確定。`Url.Builder` 採用

### 横断検証での発見

Phase 3 完了後の `just check` で `Page/Workflow/Detail.elm` の `Route.Workflows` 引数漏れを発見。計画の「変更対象ファイル一覧」に含まれていなかったファイルでの影響。Elm コンパイラが型エラーとして検出したため、ビルドステップで発見できた。

## 学んだこと

1. **`Url.Parser.Query` の使い分け**: `Query.enum` は `Maybe a` を返すため列挙型に適し、`Query.custom` は `List String` を受け取るため `Bool` や複数値のパースに適する。`<?>` コンビネータはパスマッチに影響しない
2. **同一ページ判定パターン**: `Nav.replaceUrl` は `onUrlChange` を発火するため、Main.elm の `UrlChanged` で `(model.page, newRoute)` をパターンマッチして同一ページ遷移を検出し、不要なデータ再取得を回避する
3. **設計ブラッシュアップの重要性**: 設計計画を 3 回反復することで、6 つのギャップ（`completedTodayParser` 未定義、`applyFilter` 返り値矛盾、優先順位未定義、UI 未定義、`toString` 手動結合、ドロップダウン連動）を発見・解決できた

## 次のステップ

- 手動確認テスト（PR の Test plan に記載）
- PR レビュー対応
