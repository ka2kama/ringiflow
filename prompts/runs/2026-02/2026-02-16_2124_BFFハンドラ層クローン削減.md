# BFF ハンドラ層クローン削減

## 概要

BFF ハンドラ層（7ファイル、27ハンドラ）で繰り返されていたボイラープレートを3つの共通ヘルパーで削減した。`authenticate` ヘルパー、`IntoResponse for CoreServiceError`、`log_and_convert_core_error` を `error.rs` に追加し、全27ハンドラを `Result<Response, Response>` 戻り値に統一した。

## 実施内容

### Phase 1: 共通インフラ（`error.rs` 拡張）

`error.rs` に以下を追加:

- `authenticate(session_manager, headers, jar) -> Result<SessionData, Response>`: `extract_tenant_id` + `get_session` を統合（10行 → 1行）
- `impl IntoResponse for CoreServiceError`: 全11バリアントを適切なステータスコード・エラーレスポンスにマッピング
- `log_and_convert_core_error(context, err) -> Response`: `Network`/`Unexpected` のみ `tracing::error!` でログ出力し、他はそのまま変換

18ユニットテストを追加（`authenticate` 5件、`IntoResponse` 11件、`log_and_convert_core_error` 2件）。

### Phase 2: workflow ハンドラ（command.rs + query.rs）

13ハンドラ全てカテゴリ A（監査ログなし）。戻り値を `Result<Response, Response>` に変更し、`authenticate` + `log_and_convert_core_error` で全面的に `?` 化。

### Phase 3: user.rs / role.rs

カテゴリ A（4ハンドラ: `list_users`, `get_user_detail`, `list_roles`, `get_role`）は Phase 2 と同パターン。カテゴリ B（6ハンドラ: `create_user`, `update_user`, `update_user_status`, `create_role`, `update_role`, `delete_role`）はセッション取得を `?` 化、Core Service Err パスを `log_and_convert_core_error` で簡略化。Ok パスは監査ログ記録のため `match` を維持。

### Phase 4: task.rs / dashboard.rs / audit_log.rs

`list_my_tasks`、`get_dashboard_stats` はカテゴリ A パターン。`list_audit_logs` は DB 直接アクセスのため `CoreServiceError` ではなく、セッション取得のみ `?` 化。DB エラーの `match` は維持。

## 判断ログ

- `Result<Response, Response>` を採用: axum の `Result<T, E>: IntoResponse` を活用。カスタムエラー型は KISS 違反のため不採用
- `IntoResponse for CoreServiceError` を `error.rs` に配置: `client/core_service/error.rs` は HTTP レスポンスの知識を持つべきでない
- ログコンテキストは `log_and_convert_core_error` で提供: `IntoResponse::into_response()` にはコンテキスト引数がないため
- 監査ログ付きハンドラ（カテゴリ B）は Ok パスの `match` を維持: 監査ログ記録が必要なため `?` 化できない
- テスト作成時、`ErrorResponse` の `error_type` フィールドが `#[serde(rename = "type")]` で JSON シリアライズされること、値が URI 形式であることを確認し、`assert_error_type_ends_with` ヘルパーで対応

## 成果物

コミット: `66d3906` — `#526 Reduce BFF handler boilerplate with authenticate helper and centralized error mapping`

変更ファイル:

| ファイル | 変更内容 |
|---------|---------|
| `backend/apps/bff/src/error.rs` | `authenticate`, `IntoResponse for CoreServiceError`, `log_and_convert_core_error` + 18テスト |
| `backend/apps/bff/src/handler/workflow/command.rs` | 7ハンドラ変換 |
| `backend/apps/bff/src/handler/workflow/query.rs` | 6ハンドラ変換 |
| `backend/apps/bff/src/handler/user.rs` | 5ハンドラ変換 |
| `backend/apps/bff/src/handler/role.rs` | 5ハンドラ変換 |
| `backend/apps/bff/src/handler/task.rs` | 1ハンドラ変換 |
| `backend/apps/bff/src/handler/dashboard.rs` | 1ハンドラ変換 |
| `backend/apps/bff/src/handler/audit_log.rs` | 1ハンドラ変換 |
| `prompts/plans/526_bff-handler-clone-reduction.md` | 計画ファイル |
