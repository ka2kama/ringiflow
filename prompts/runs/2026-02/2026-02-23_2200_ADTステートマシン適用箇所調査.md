# ADT ベースステートマシン適用箇所の調査

## 概要

#797: ADR-054（ADT ベースステートマシンパターンの標準化）に基づき、既存コードベース全体を調査し、適用候補を特定した。

## 実施内容

### 1. フロントエンド調査

16 ページの Model 定義を ADR-054 の適用基準で評価した。

適用候補 6 件（+ Designer.elm は #796 で対応済み）:

| # | ページ | 優先度 | 問題 |
|---|--------|--------|------|
| 1 | Workflow/Detail.elm | 高 | 18 フィールドのフラット Model。承認/コメント/再提出の 3 モード混在 |
| 2 | Workflow/New.elm | 高 | 定義未選択時にフォームフィールドが無効 |
| 3 | Task/Detail.elm | 高 | Loading 中に承認/却下操作が型レベルで可能 |
| 4 | WorkflowDefinition/List.elm | 中 | ダイアログ開閉 + 確認操作の状態混在 |
| 5 | Role/List.elm | 中 | 削除確認ダイアログ（`Maybe + Bool` パターン） |
| 6 | User/Detail.elm | 中 | ステータス変更確認ダイアログ |

適用しない: Home, Task/List, Workflow/List, User/List, User/Edit, User/New, Role/New, Role/Edit, AuditLog/List, NotFound

### 2. バックエンド調査

domain クレートの構造体を ADR-054 の適用基準で評価した。

適用候補 2 件:

| # | 構造体 | 優先度 | 問題 |
|---|--------|--------|------|
| 1 | WorkflowInstance | 高 | 7 状態遷移。`current_step_id`/`submitted_at`/`completed_at` が状態依存 |
| 2 | WorkflowStep | 高 | 4 状態遷移。`decision`/`started_at`/`completed_at` が状態依存 |

適用しない: WorkflowDefinition（状態フラグで十分）、User（状態非依存）、Role, Tenant, WorkflowComment（状態フィールドなし）

### 3. Epic・Issue 起票

Epic #822 を作成し、高優先度 5 件を Sub-issues として紐づけた。

| Issue | 対象 |
|-------|------|
| #822 | Epic: ADT ベースステートマシンの既存コード適用 |
| #816 | Workflow/Detail.elm |
| #817 | Workflow/New.elm |
| #818 | Task/Detail.elm |
| #819 | WorkflowInstance |
| #820 | WorkflowStep |

### 4. 中優先度の共通パターン

フロントエンドの中優先度 3 件は `Maybe item + Bool isProcessing` の確認ダイアログパターンが共通。高優先度のリファクタリング実績を積んだ後、共通パターンとして一括対応を推奨。

## 判断ログ

- WorkflowDefinition を「適用しない」と判定: 状態フィールド（Draft/Published/Archived）は存在するが、他フィールドの有効性が状態に依存しない。`can_publish()` 等のメソッドガードで十分
- User を「適用しない」と判定: `last_login_at: Option` はログイン有無の意味であり、UserStatus に依存しない
- 中優先度を Issue 化しなかった理由: 影響範囲が小さく、共通パターンとして一括対応する方が効率的

## 成果物

### Issue

- #822（Epic: ADT ベースステートマシンの既存コード適用）
- #816, #817, #818, #819, #820（高優先度の個別 Story、#822 の Sub-issues）
- #797 に調査結果コメントを追加
