# デプロイ時 DB マイグレーション自動化

## 概要

Issue #559 に対応し、アプリケーション起動時に `sqlx::migrate!()` で DB マイグレーションを自動実行する仕組みを導入した。Lightsail デプロイ時のマイグレーション適用忘れを防止する。

## 実施内容

1. `backend/crates/infra/src/db.rs` に `run_migrations()` 関数を追加
   - `sqlx::migrate!("../../migrations")` でマイグレーション SQL をバイナリに埋め込み
   - パスは `CARGO_MANIFEST_DIR` からの相対パス
2. Core Service・Auth Service の `main()` でプール作成直後にマイグレーションを実行
3. Dockerfile の Builder ステージに `COPY migrations/ migrations/` を追加
   - `sqlx::migrate!()` はコンパイル時にファイルを埋め込むため、Builder ステージで必要

## 判断ログ

- 案 1（デプロイスクリプト変更）vs 案 2（起動時マイグレーション）の選択は Issue #559 で検討済み。案 2 を採用（コードとスキーマの同期保証、デプロイパスの統一不要、冪等性）
- `run_migrations()` の配置先は infra crate を選択。Core Service と Auth Service の両方が既に `ringiflow_infra::db` に依存しており、重複を避けるため
- テストは既存の `#[sqlx::test(migrations = ...)]` が同等のカバレッジを提供しているため、新規テスト追加は不要と判断

## 成果物

- コミット: `5ea87c2` — #559 Add automatic database migration on application startup
- PR: #560
