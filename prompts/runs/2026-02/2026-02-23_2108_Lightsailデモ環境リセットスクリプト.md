# Lightsail デモ環境リセットスクリプト

## 概要

Lightsail デモ環境の全データストア（PostgreSQL, Redis, DynamoDB）を初期シード状態にリセットするスクリプトを作成し、実際にリセットを実行した。

## 実施内容

1. Lightsail デモ環境の構成を調査（docker-compose.yaml, deploy.sh, backup.sh, マイグレーションファイル）
2. `infra/lightsail/reset.sh` を新規作成
3. `infra/lightsail/README.md` にリセット手順を追記
4. Lightsail 上でリセットを実行し、全データストアを初期シードに復元
5. ShellCheck の指摘を修正

### リセットスクリプトの主な機能

- アプリサービス停止 → DB 接続切断 → PostgreSQL リセット → Redis フラッシュ → DynamoDB 再起動 → サービス再起動
- sqlx 互換のチェックサム記録（`sha384sum` で計算）
- ヘルスチェックによる起動確認
- `--yes` フラグによる確認プロンプトスキップ

## 判断ログ

- sqlx-cli の Rust コンパイルが 1GB RAM の Lightsail で OOM になるため、psql でマイグレーションを直接適用する方式に変更
- `_sqlx_migrations` テーブルのチェックサムを `sha384sum` で計算することで sqlx との互換性を確保。ローカル DB の値と照合して一致を確認
- アプリサービスがアクティブな DB 接続を保持しているため、リセット前にサービスを停止する手順を追加

## 成果物

### コミット

- `Add Lightsail demo environment reset script`

### 作成・更新ファイル

| ファイル | 変更内容 |
|---------|---------|
| `infra/lightsail/reset.sh` | 新規作成（リセットスクリプト） |
| `infra/lightsail/README.md` | データリセット手順を追記 |

### PR

- #814: Add Lightsail demo environment reset script

### 関連ドキュメント

- 調査記録: [Lightsail デモ環境リセットでの sqlx マイグレーション互換性問題](../../../process/investigations/2026-02/2026-02-23_2108_Lightsailリセットでのsqlxマイグレーション互換性問題.md)
- ナレッジベース: [sqlx マイグレーションチェックサム互換](../../../docs/80_ナレッジベース/infra/sqlxマイグレーションチェックサム互換.md)
