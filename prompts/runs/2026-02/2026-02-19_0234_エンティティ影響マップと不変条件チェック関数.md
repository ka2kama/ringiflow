# エンティティ影響マップと不変条件チェック関数

Issue: [#686](https://github.com/ka2kama/ringiflow-3/issues/686)
PR: [#691](https://github.com/ka2kama/ringiflow-3/pull/691)

## 概要

ワークフロー関連エンティティ（WorkflowInstance, WorkflowStep）のエンティティ影響マップを作成し、不変条件を形式知化した。さらに、不変条件を統合テストで自動検証する `assert_workflow_invariants` 関数を実装し、既存テストに組み込んだ。

## 実施内容

### Phase 1-2: エンティティ影響マップの作成

- WorkflowInstance の影響マップ: 7つの更新パス、競合リスク、状態遷移図、不変条件（INV-I1〜I4）
- WorkflowStep の影響マップ: 8つの更新パス、競合リスク、状態遷移図、不変条件（INV-S1〜S4）
- クロスエンティティ不変条件: INV-X1〜X4

### Phase 3: README 更新

- `docs/03_詳細設計書/エンティティ影響マップ/README.md` に2つのマップへのリンクを追加

### 追加: 不変条件チェック関数の実装

計画時はドキュメントのみの予定だったが、スイスチーズモデルの多層防御として統合テストでの自動検証（Layer 2）も実装した。

- `assert_workflow_invariants` 関数を `tests/common/mod.rs` に追加
  - INV-I1〜I4（Instance 不変条件）
  - INV-S1〜S4（Step 不変条件）
  - INV-X1〜X3（クロスエンティティ不変条件）
- 既存統合テスト5箇所に不変条件チェックを追加
  - `workflow_instance_repository_test.rs`: 2テスト
  - `workflow_step_repository_test.rs`: 3テスト
- `StepTestContext` に `pool` フィールドを追加（不変条件チェックに `PgPool` が必要なため）

## 判断ログ

- ドキュメントのみの計画からテストコード実装に拡張した（スイスチーズモデルの Layer 2 として、自動検証の価値が高いと判断）
- Clippy 指摘: `DoubleEndedIterator` での `.filter().last()` を `.rfind()` に修正（Rust のイディオムに準拠）

## 成果物

### コミット

| コミット | 内容 |
|---------|------|
| `d795151` | WorkflowInstance と WorkflowStep のエンティティ影響マップ作成 |
| `bb488d2` | 計画ファイル追加 |
| `d4e93a0` | 不変条件チェック関数の実装と統合テストへの組み込み |
| `59f1a6f` | Clippy 修正: `rfind` を使用 |

### 作成・更新ファイル

| ファイル | 操作 |
|---------|------|
| `docs/03_詳細設計書/エンティティ影響マップ/WorkflowInstance.md` | 新規作成 |
| `docs/03_詳細設計書/エンティティ影響マップ/WorkflowStep.md` | 新規作成 |
| `docs/03_詳細設計書/エンティティ影響マップ/README.md` | 更新 |
| `backend/crates/infra/tests/common/mod.rs` | 新規作成 |
| `backend/crates/infra/tests/workflow_instance_repository_test.rs` | 更新 |
| `backend/crates/infra/tests/workflow_step_repository_test.rs` | 更新 |
| `prompts/plans/686_entity-impact-map.md` | 新規作成 |
