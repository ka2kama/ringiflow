# フォーム dirty-state 検出による未保存データ損失防止

## 概要

新規申請フォーム（`Page/Workflow/New.elm`）で入力中にナビゲーションした場合のデータ損失を防止する機能を実装した。ブラウザレベル（beforeunload）と SPA 内レベル（ConfirmDialog）の 2 層で保護する。

## 背景と目的

Issue [#177](https://github.com/ka2kama/ringiflow/issues/177) として登録されていた機能。フォームに入力中のデータが、タブ閉じ・リロード・SPA 内リンククリックで警告なく失われる問題を解決する。

## 実施内容

### Phase 1: isDirty フラグ + Port 連携

- `Ports.elm` に `setBeforeUnloadEnabled : Bool -> Cmd msg` ポートを追加
- `main.js` に beforeunload リスナー管理を追加
- `New.elm` に `isDirty_` フィールド、`isDirty` 関数、`markDirty`/`clearDirty` ヘルパーを追加
- 各 Msg に対する dirty 管理を実装（入力系 → markDirty、保存/申請成功 → clearDirty）

### Phase 2: SPA 内ナビゲーション遷移阻止

- `Main.elm` に `pendingNavigation : Maybe Url` を追加
- `LinkClicked` ハンドラで dirty チェックを行い、dirty なら ConfirmDialog を表示
- ESC キーでダイアログを閉じる subscriptions を追加
- `Detail.elm` の既存 PendingAction + ConfirmDialog パターンを踏襲

## 設計上の判断

### 1. dirty 検出方法: `isDirty` Bool フラグ

初期値との値比較ではなく、シンプルな Bool フラグを採用。Issue の実装案と一致し、値比較は YAGNI。

### 2. Port 設計: 専用 `setBeforeUnloadEnabled` ポート

汎用 `sendMessage` ポートを使う選択肢もあったが、責務が明確に異なるため専用ポートとした。Elm の型安全性を活かし、`Bool -> Cmd msg` で呼び出し側のミスを防ぐ。

### 3. ConfirmDialog の配置: Main.elm

`Nav.Key` は Main.elm のみが保持しており、ナビゲーション制御は Main の責務。ページ側で ConfirmDialog を表示するとナビゲーション実行のために Key を渡す必要があり、責務の漏洩になる。

### 4. markDirty/clearDirty の状態遷移ガード

Port Cmd は状態が実際に変わるときのみ発行する設計。`markDirty` は `isDirty_ = False` のときのみ、`clearDirty` は `isDirty_ = True` のときのみ Cmd を生成する。冗長な JS 通信を防ぐ。

## 成果物

### コミット

1. `bc6a737` — `#177 Add isDirty flag and beforeunload port to prevent unsaved data loss`
2. `87b1e07` — `#177 Add navigation interception with ConfirmDialog for dirty forms`

### 変更ファイル

| ファイル | 変更内容 |
|---------|---------|
| `frontend/src/Ports.elm` | `setBeforeUnloadEnabled` ポート追加 |
| `frontend/src/main.js` | beforeunload リスナー管理 |
| `frontend/src/Page/Workflow/New.elm` | isDirty フラグ、markDirty/clearDirty、dirty 管理 |
| `frontend/src/Main.elm` | pendingNavigation、LinkClicked インターセプト、ConfirmDialog、ESC サブスクリプション |

## 議論の経緯

### 作業の選定

`/next` で推奨作業を確認し、#177（フォーム dirty-state）を選択。同時に、Draft PR #91（Lightsail デプロイ）に `idea` ラベルを付けて MVP 後の作業として整理した。

### 設計フェーズ

Plan mode で設計を行い、以下を確認・決定した:

- Elm の `Browser.application` では、ブラウザの戻る/進むボタンは `UrlChanged` のみを発火し `LinkClicked` を経由しないため、SPA 内の遷移阻止は `<a>` タグのクリックに限定される。`beforeunload` がブラウザレベルの保護をカバーする。
- `handleApproverKeyDown` の Enter パスは `SelectApprover` Msg を経由せずに直接モデルを変更するため、別途 `markDirty` が必要であることを識別した。
- `Detail.elm` の既存 PendingAction パターン（ConfirmDialog + ESC + focusDialogCancel）をそのまま踏襲する方針を決定した。

## 学んだこと

1. **Elm の Browser.application におけるナビゲーションイベントの非対称性**: `onUrlRequest`（LinkClicked）は `<a>` タグのクリックにのみ発火し、ブラウザの戻る/進むは `onUrlChange`（UrlChanged）のみ。SPA 内の遷移阻止はこの制約の下で設計する必要がある。

2. **Elm の命名衝突回避**: レコードフィールド名と関数名が衝突する場合、フィールド名にアンダースコアサフィックス（`isDirty_`）を付ける手法。公開 API（`isDirty` 関数）をクリーンに保ちつつ内部実装を分離できる。

3. **Port Cmd の冗長発行防止**: 状態遷移ガード（`markDirty` は False→True のみ、`clearDirty` は True→False のみ）を設けることで、冗長な JS 通信を構造的に排除できる。

## 次のステップ

- 手動テスト（計画に記載した 10 シナリオ）の実施
- PR #264 の Ready for Review
