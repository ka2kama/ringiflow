# テストコード共通化（Issue #531）

## 概要

Epic #467 のサブ Issue。統合テストファイル間のコード重複（26クローン）を共通化するリファクタリングを実施した。6ファイルを対象に、6フェーズで段階的にヘルパー関数を抽出・適用した。テストの数や検証内容は変更していない。

PR: #586

## 実施内容

### Phase 1: common/mod.rs の拡充

`backend/crates/infra/tests/common/mod.rs` に2つのヘルパーを追加:

- `create_other_tenant()`: 別テナント作成（テナント分離テスト用）
- `insert_user_raw()`: SQL 直接挿入（リポジトリ経由しないユーザー作成）

### Phase 2: auth_integration_test.rs の共通化（10クローン）

3つのヘルパー関数を抽出し、8テストに適用:

- `login_and_get_session()`: ログイン + セッション ID 取得
- `get_csrf_token_via_api()`: CSRF トークン取得
- `cleanup_auth_session()`: Redis セッション・CSRF クリーンアップ

ログイン検証がテスト目的の2テストには適用せず。

### Phase 3: user_repository_test.rs の共通化（6クローン）

Phase 1 のヘルパーを活用:

- 3箇所のインラインテナント作成 → `create_other_tenant()` に置換
- 6箇所のインラインユーザー INSERT → `insert_user_raw()` に置換

### Phase 4: workflow_step_repository_test.rs の共通化（3クローン）

`StepTestContext` 構造体と `setup_repos_with_instance()` ヘルパーを抽出。13テスト中10テストに適用。

### Phase 5: rls_test.rs の共通化（3クローン）

`query_uuids_as_tenant()` ヘルパーを抽出。RLS コンテキスト設定 → クエリ実行 → リセットの定型パターンを共通化。7テストに適用。

計画からの変更: テーブル名パラメータではなくクエリ文字列を受け取る設計に変更。`auth.credentials` テーブルのように `SELECT id FROM {table}` では対応できないケースに汎用的に対応するため。

### Phase 6: postgres_deleter_test.rs の共通化（2クローン）

- `setup_two_tenants()`: Phase 1 のヘルパーで簡潔化
- `assert_count_delete_count<T: TenantDeleter>()`: count → delete → count=0 の共通アサーション

### 結果

- 6ファイル変更: -506/+319 (net -187行)
- jscpd クローン数: 158→143（15削減）
- 全91テスト通過（infra: 79, bff: 12）

## 判断ログ

- Phase 5: `query_ids_as_tenant` → `query_uuids_as_tenant` にリネームし、テーブル名ではなくクエリ文字列を引数にした（`auth.credentials` 等の非標準テーブルに対応するため）
- Phase 6: `assert_count_delete_count` をジェネリクス `<T: TenantDeleter>` で実装（`async fn in trait` は object-safe でないため `&dyn` 不可）
- `audit_log_repository_test` が DynamoDB Local 接続のタイミング問題で一時的に失敗。個別実行では成功を確認し、PR の変更とは無関係と判断

## 成果物

コミット:

1. `#531 WIP: Consolidate test code to reduce duplication`（空コミット、Draft PR 用）
2. `#531 Add test helpers: create_other_tenant and insert_user_raw`
3. `#531 Extract auth test helpers: login_and_get_session, get_csrf_token_via_api, cleanup_auth_session`
4. `#531 Replace inline tenant/user INSERT with common helpers in user_repository_test`
5. `#531 Extract StepTestContext and setup_repos_with_instance helper in workflow_step_repository_test`
6. `#531 Extract query_uuids_as_tenant helper in rls_test`
7. `#531 Simplify setup_two_tenants and extract assert_count_delete_count in postgres_deleter_test`

変更ファイル:

- `backend/crates/infra/tests/common/mod.rs`
- `backend/apps/bff/tests/auth_integration_test.rs`
- `backend/crates/infra/tests/user_repository_test.rs`
- `backend/crates/infra/tests/workflow_step_repository_test.rs`
- `backend/crates/infra/tests/rls_test.rs`
- `backend/crates/infra/tests/postgres_deleter_test.rs`
