# インフラ層クローン削減

Issue: [#529](https://github.com/ka2kama/ringiflow/issues/529)
PR: [#577](https://github.com/ka2kama/ringiflow/pull/577)
計画ファイル: [529_infra-layer-clone-reduction.md](../../plans/529_infra-layer-clone-reduction.md)

## 概要

Epic #467（`just check` / `check-all` の警告をゼロにする）の Story 6。
インフラ層（`backend/crates/infra/src/`）に jscpd が検出した 21 クローン（338行、6.01%）のうち 14 クローンを対象に削減を実施し、最終的に 13 クローン解消（8 クローン残存、1.78%）を達成した。`user_repository.rs` のファイルサイズも 784 行 → 679 行に削減。

## 実施内容

5 Phase に分けて実装した。

### Phase 1: session.rs の SCAN ループ共通化

`delete_all_for_tenant` と `delete_all_csrf_for_tenant` の 21 行の SCAN+DELETE ループを `scan_and_delete_keys` ヘルパー関数に抽出。

### Phase 2: deletion/ の PostgreSQL 共通化マクロ

`postgres_user.rs`、`postgres_role.rs`、`postgres_display_id.rs` の 3 ファイルを `postgres_simple.rs` に統合。`define_simple_postgres_deleter!` 宣言的マクロで構造を共通化した。SQL リテラルを直接渡すことで `sqlx::query!` のコンパイル時検証を維持。

### Phase 3: WorkflowDefinition の Row + TryFrom 導入

`WorkflowDefinitionRow` 構造体と `TryFrom` 実装を追加し、`sqlx::query!` → `sqlx::query_as!` に変更。workflow_step/instance_repository で確立済みのパターンを踏襲。

### Phase 4: Permission パース/変換の共通化

`role_repository.rs` の `parse_permissions` と新規追加の `permissions_to_json` を `pub(crate)` に変更し、`user_repository.rs` からも共有。

### Phase 5: User 行マッピングの共通化

`UserRow` 構造体と `TryFrom<UserRow> for User` を実装し、6 つの find 関数で `sqlx::query!` + インライン `User::from_db(...)` を `sqlx::query_as!(UserRow, ...)` + `User::try_from` に置換。

## 判断ログ

- Phase 2: `sqlx::query!` は proc macro であり `concat!` では動作しないため、マクロにSQL全文をリテラルとして渡す設計を採用
- Phase 4: `parse_permissions` と `permissions_to_json` は独立モジュールに切り出すほどの複雑さではないため、`role_repository.rs` 内に `pub(crate)` で配置
- Phase 5: `find_all_by_tenant` の match 両分岐で `UserRow` を共通使用できることを確認。`rows` 変数を match の外に引き上げて変換ロジックを一本化
- `auth_credentials.rs` はディレクトリ権限の問題で読み取れず、Phase 2 への統合を断念（計画段階で確認事項として記載済み）
- API テストのサービス起動タイムアウトは環境起因（cargo file lock 競合）であり、事前ビルド後の再実行で全テスト通過を確認

## 成果物

### コミット

1. `bbed7cc` - Extract scan_and_delete_keys helper in session.rs
2. `c71518e` - Consolidate simple PostgreSQL deleters with declarative macro
3. `859ccea` - Introduce WorkflowDefinitionRow + TryFrom for row mapping
4. `cfbd4c5` - Share permission parse/serialize helpers across repositories
5. `e63cab8` - Introduce UserRow + TryFrom for user row mapping

### 変更ファイル

- `backend/crates/infra/src/session.rs` — SCAN ループヘルパー抽出
- `backend/crates/infra/src/deletion/mod.rs` — モジュール宣言更新
- `backend/crates/infra/src/deletion/postgres_simple.rs` — 新規、マクロベースの統合
- `backend/crates/infra/src/deletion/postgres_user.rs` — 削除
- `backend/crates/infra/src/deletion/postgres_role.rs` — 削除
- `backend/crates/infra/src/deletion/postgres_display_id.rs` — 削除
- `backend/crates/infra/src/repository/workflow_definition_repository.rs` — Row + TryFrom
- `backend/crates/infra/src/repository/role_repository.rs` — pub(crate) ヘルパー
- `backend/crates/infra/src/repository/user_repository.rs` — UserRow + TryFrom

### 削減効果

| 指標 | Before | After | 削減 |
|------|--------|-------|------|
| クローン数 | 21 | 8 | -13 (62%) |
| 重複行率 | 6.01% | 1.78% | -4.23pt |
| user_repository.rs 行数 | 784 | 679 | -105 行 |
