# #860 型安全ステートマシン: 中優先度 Story のアプローチ見直し

## 概要

Epic #822 の中優先度 Story（確認ダイアログ共通パターン）を ADR-054 の新判断基準（「不正な状態遷移が型レベルで防止されているか」）で評価し、必要な箇所のみ改善を実施した。

## 実施内容

### 評価

3 ファイルの確認ダイアログ状態を ADR-054 適用基準「状態によって有効なフィールドが異なる」で評価:

| ファイル | 判定 | 理由 |
|---------|------|------|
| Role/List.elm | 変更不要 | `Maybe RoleItem` + `isDeleting : Bool` — Bool 1 つの差異は適用基準外 |
| User/Detail.elm | 変更不要 | `Maybe ConfirmAction` + `isSubmitting : Bool` — 同上 |
| WorkflowDefinition/List.elm 確認ダイアログ | 変更不要 | `Maybe PendingAction` + `isProcessing : Bool` — 同上 |
| WorkflowDefinition/List.elm 作成ダイアログ | **改善** | `showCreateDialog : Bool` + 4 フラットフィールドが適用基準に該当 |

### 実装（Phase 1）

WorkflowDefinition/List.elm の作成ダイアログのフォーム状態を `Maybe CreateDialogState` に抽出:

- `showCreateDialog : Bool` + `createName` + `createDescription` + `createValidationErrors` → `createDialog : Maybe CreateDialogState`
- `isProcessing` を確認ダイアログ専用に限定し、`CreateDialogState.isSubmitting` を新設
- `viewCreateDialog` の引数を `Model -> Html Msg` → `CreateDialogState -> Html Msg` に変更

### Epic #822 更新（Phase 2）

- 完了基準: 「確認ダイアログの共通パターンが型安全ステートマシンで統一される」→「確認ダイアログの状態管理が型安全性の観点で評価され、必要な箇所が改善されている」
- タスクリスト: 3 項目を評価結果に基づいて更新（全て完了）
- テスト責任マッピング: 中優先度の行を追加

## 判断ログ

- ADR-054 適用基準の判定: 確認ダイアログの `Maybe + Bool` パターンは「状態が 2 つで差異が小さい」に該当し、型安全ステートマシンの適用基準外と判定。Elm の update 関数を通じた遷移では不正状態が到達不能であることも考慮
- `isProcessing` の分離: Detail.elm の `EditingState.isResubmitting` パターンに準拠し、状態固有の処理中フラグはその状態の中に配置する設計を採用
- `Maybe CreateDialogState` vs Custom Type: 状態が 2 つ（開/閉）で「閉」に追加データがないため `Maybe` を選択。`Maybe PendingAction` と同じパターン
- Epic 完了基準の更新: 手段（「型安全ステートマシンで統一」）を前提とした基準を、目的（「型安全性の観点で評価・改善」）に修正。#855 の「Want と How の区別」原則の実践
- `GotCreateResult Err` 時のダイアログ維持: エラー時にダイアログを閉じるとユーザーがフォーム内容を確認・修正できないため、`isSubmitting = False` に戻してダイアログを維持する設計を採用

## 成果物

### コミット

- `aaec72e` #860 Extract create dialog form state into Maybe CreateDialogState
- `4d94103` #860 Add implementation plan for dialog state approach review

### PR

- [#870](https://github.com/ka2kama/ringiflow/pull/870) — Draft

### 作成/更新ファイル

- `frontend/src/Page/WorkflowDefinition/List.elm` — CreateDialogState 抽出
- `prompts/plans/860_dialog-state-approach-review.md` — 計画ファイル

### GitHub 更新

- Issue #860: 評価結果と完了基準を追加
- Epic #822: 完了基準・タスクリスト・テスト責任マッピングを更新
