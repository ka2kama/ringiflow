# Infra 層 Row→Entity 変換コード共通化

Issue: #378

## 概要

jscpd (#373) で検出された Row→Entity 変換コードの重複を、`query_as!` + Row 構造体 + `TryFrom` で解消した。2ファイルで合計 -144 行（9 メソッドの重複ブロックを各1箇所に集約）。

## 実施内容

### Phase 1: WorkflowStepRepository

- `WorkflowStepRow` 構造体を定義（16 フィールド、raw DB 型）
- `TryFrom<WorkflowStepRow> for WorkflowStep` を実装
- `find_by_id`, `find_by_instance`, `find_by_assigned_to`, `find_by_display_number` の 4 メソッドを `query_as!` + `try_from` にリファクタ
- 副次的正規化: `from_str()` → `.parse::<T>()`

### Phase 2: WorkflowInstanceRepository

- `WorkflowInstanceRow` 構造体を定義（15 フィールド）
- `TryFrom<WorkflowInstanceRow> for WorkflowInstance` を実装
- `find_by_id`, `find_by_tenant`, `find_by_initiated_by`, `find_by_ids`, `find_by_display_number` の 5 メソッドをリファクタ
- 副次的正規化: `DisplayNumber::try_from()` → `DisplayNumber::new()`

### Phase 3: 最終検証

- `just sqlx-prepare`: `.sqlx/` キャッシュに変更なし（SQL 文自体は変更なしのため）
- `just check-all`: 全テスト通過（lint + ユニットテスト + 統合テスト 28 件 + API テスト 18/18 + E2E テスト）

## 判断ログ

- 設計判断: `query_as!` + Row 構造体 + `TryFrom`（3案比較の結果、案 A を採用）。理由は計画ファイルに記載
- Refactor: 変更なし（リファクタリング Issue のため、新規設計判断は計画段階で完了）

## 成果物

コミット:
- `a22afc1` #378 Consolidate Row-to-Entity conversion in WorkflowStepRepository
- `3436548` #378 Consolidate Row-to-Entity conversion in WorkflowInstanceRepository

PR: #441（Draft）

変更ファイル:
- `backend/crates/infra/src/repository/workflow_step_repository.rs`（-62 行）
- `backend/crates/infra/src/repository/workflow_instance_repository.rs`（-82 行）

計画ファイル: `prompts/plans/378_infra-row-conversion.md`（リネーム予定）
