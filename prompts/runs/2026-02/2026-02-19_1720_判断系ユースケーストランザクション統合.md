# 判断系ユースケースのトランザクション統合

Issue: #688
PR: #704

## 概要

判断系ユースケース（approve_step, reject_step, request_changes_step）の複数エンティティ更新を、それぞれ独立した複数トランザクションから単一トランザクションに統合した。あわせて、楽観的ロックとトランザクション原子性の統合テストを追加した。

## 実施内容

### Phase 1: approve_step のトランザクション統合

3つの独立トランザクション（step 更新 → next step 活性化 → instance 更新）を1つに統合。

変更パターン:
- `find_by_instance` と next step の `activated()` ドメインロジックをトランザクション開始前に移動
- 3つの `begin/commit` ブロックを1つに統合
- `&mut TxContext` を各書き込み操作に順次渡す

### Phase 2: reject_step のトランザクション統合

N+2 個のトランザクション（rejected step → 各 pending step の skip → instance 更新）を1つに統合。

変更パターン:
- 全読み取りとドメインロジックをトランザクション前に実行
- pending ステップの `skipped()` 結果を `Vec<(WorkflowStep, Version)>` に蓄積
- 単一トランザクション内でループ書き込み

### Phase 3: request_changes_step のトランザクション統合

Phase 2 と同一パターン。差分は状態遷移のみ（`reject()` → `request_changes()`、`complete_with_rejection()` → `complete_with_request_changes()`）。

### Phase 4: 並行操作の統合テスト

`backend/crates/infra/tests/transaction_concurrency_test.rs` を新規作成。

テスト 1: 楽観的ロックで古いバージョンの更新が Conflict を返す
- TX_A が step と instance を更新してコミット → TX_B が古いバージョンで step 更新 → Conflict

テスト 2: トランザクション原子性で部分更新がロールバックされる
- TX_A が step を更新してコミット → TX_B が instance 更新（成功）後に step 更新で Conflict → TX_B ドロップで instance 更新もロールバック

## 判断ログ

- Phase 4: `sqlx::test` は単一接続の savepoint ベースプールのため、`tokio::spawn` による真の並行テストが不可能。逐次実行で同等の競合シナリオを検証する方式を採用
- Phase 4: テスト配置先を infra crate に決定。core-service への sqlx dev-dependency 追加を避け、既存テストインフラ（`common/mod.rs`、`sqlx::test`）を再利用
- reject/request_changes 間のコード重複解消はスコープ外とし、別 Issue で対応する方針

## 成果物

コミット:
- `#688 WIP: Unify decision usecase transactions`（空コミット）
- `#688 Add implementation plan for decision usecase transaction unification`
- `#688 Unify approve_step to single transaction`
- `#688 Unify reject_step transactions into single atomic operation`
- `#688 Unify request_changes_step transactions into single atomic operation`
- `#688 Add integration tests for optimistic locking and transaction atomicity`

変更ファイル:
- `backend/apps/core-service/src/usecase/workflow/command/decision/approve.rs`
- `backend/apps/core-service/src/usecase/workflow/command/decision/reject.rs`
- `backend/apps/core-service/src/usecase/workflow/command/decision/request_changes.rs`
- `backend/crates/infra/tests/transaction_concurrency_test.rs`（新規）
- `prompts/plans/688_decision-usecase-transaction.md`（計画ファイル）
