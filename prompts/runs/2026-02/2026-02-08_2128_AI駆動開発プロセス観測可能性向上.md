# AI 駆動開発プロセスの観測可能性向上

Issue: #315

## 概要

AI 駆動開発の品質改善サイクルをデータ駆動で回すため、思考プロセスの観測可能性を高める仕組みを構築した。改善記録33件の分析から AI の6つの構造的特性（クセ）を特定し、セッションログへの判断ログ追加、改善記録への分類・検証体系の導入、定期分析ガイドの作成を行った。

## 背景と目的

AI 駆動開発では改善記録（`prompts/improvements/`）を蓄積してきたが、「なんとなく良くなっている」状態から「どこが弱く、何を改善すれば効果が高いか」を判断できる状態にしたかった。特に:

- 設計段階はブラッシュアップループで観測可能性が高いが、実装段階の判断プロセスは暗黙知のまま消えている
- 改善記録に分類体系がなく、パターン分析・傾向把握ができない
- 対策の有効性を検証するフィードバックループが閉じていない

## 実施内容

### Phase 1: セッションログの判断ログセクション

`prompts/runs/README.md` にセッション記録の新セクション「判断ログ」を追加。実装中の in-action な判断を記録する仕組み。

4つの種別を定義: 設計修正、軌道修正、ルール適用、発見

### Phase 2: 改善記録の分類・検証セクション

`prompts/improvements/README.md` に分類体系を追加:

- 6カテゴリ（AI 構造的特性）: 参照漏れ、単一パス検証、即座の対策、視点不足、コンテキスト引きずり、知識-実行乖離
- 3失敗タイプ: 知識ギャップ、実行ギャップ、プロセスギャップ
- 検証セクション: 対策実行後の効果追記

### Phase 3: wrap-up スキルの更新

`.claude/skills/wrap-up/SKILL.md` を更新し、判断ログのリアルタイム記録とセッションログ仕上げのフローに対応。

### Phase 4: 定期分析ガイド

`docs/80_ナレッジベース/methodology/AI思考特性の分析ガイド.md` を新規作成。改善記録と判断ログのパターン分析手順を定義。

### 設計変更: リアルタイム記録方式への移行

当初は wrap-up 時にまとめて記載する設計だったが、ユーザーとの議論で修正。判断ログはセッション中にリアルタイムで記録する方式に変更した。

## 設計上の判断

### 記録場所: セッションログに統合

4つの選択肢（セッションログ拡張、Issue コメント、専用ファイル、PR Self-review 拡張）を比較し、セッションログ拡張を選択。理由: 成果物要件として構造的強制が効く、既存のファイル体系への影響が最小。

### 記録タイミング: リアルタイム

当初の wrap-up 再構成方式から、リアルタイム記録方式に変更。理由: wrap-up 時の再構成では判断時のコンテキスト（検討した選択肢、棄却理由、違和感の正体）が失われる。squash merge でコミットメッセージも消えるため、再構成の手がかりにできない。

### 分類体系: 6カテゴリ + 3タイプの二軸分類

33件の分析で帰納的に抽出した6つの AI 構造的特性をカテゴリとし、根本原因の層（知識・実行・プロセス）を失敗タイプとした。二軸は直交しており、独立に分析できる。

### 「設計上の判断」と「判断ログ」の棲み分け

- 設計上の判断: 設計フェーズでの Why レベルの意思決定
- 判断ログ: 実装フェーズでの in-action な判断

リフレクティブ・プラクティス（Schon）の reflection-on-action と reflection-in-action の区別に対応する。

## 判断ログ

特筆すべき判断なし（仕組みの構築前のセッションのため）。

## 成果物

### コミット

| コミット | 内容 |
|---------|------|
| e70a599 | セッションログに判断ログセクション追加 |
| 8f644e1 | 改善記録に分類・検証セクション追加 |
| 69450df | wrap-up スキルの更新 |
| 6e13a02 | AI 思考特性の分析ガイド作成 |
| f161971 | 計画ファイル追加 |
| 78c74a0 | リアルタイム記録方式への変更 |

### 作成・更新ファイル

- `prompts/runs/README.md`（更新）
- `prompts/improvements/README.md`（更新）
- `.claude/skills/wrap-up/SKILL.md`（更新）
- `docs/80_ナレッジベース/methodology/AI思考特性の分析ガイド.md`（新規）
- `docs/80_ナレッジベース/README.md`（更新）
- `prompts/plans/sharded-giggling-dragonfly.md`（新規）

## 議論の経緯

### 改善記録の分析アプローチ

33件の改善記録を分析し、AI の思考パターンを帰納的に抽出。「行動規範 < 成果物要件」という明確な序列を確認した。ユーザーは分析結果に基づいて Issue #315 の作成を指示。

### 記録場所の設計

4つの選択肢を比較検討した。セッションログ拡張を選択した理由として、既存の成果物要件（wrap-up で作成が強制される）に統合することで構造的強制が効くことを挙げた。

### リアルタイム記録への転換

ユーザーが「行動規範は失敗するという制約を外した場合の To-Be は？」と問いかけたことで、当初の設計（wrap-up 時の再構成）が妥協案であったことが明らかになった。

さらに「squash merge しているからコミットメッセージは消える」という指摘で、再構成の手がかりも失われることが判明。

最終的にユーザーが「wrap-up をセッション完了後にやろうという決まりを設けたつもりはない。自動作成の仕組みがあった方が便利だっただけ」と明確にし、判断ログのリアルタイム記録 + wrap-up でのセッションログ仕上げという方式に着地した。

## 学んだこと

- 「行動規範は失敗する」という知見を制約として受け入れすぎると、理想を不必要に下げてしまう。制約を外して To-Be を再考することで、より良い設計に到達できる場合がある
- squash merge 環境ではコミットメッセージは永続的な記録としては使えない。この制約を見落としていた
- 暗黙の前提（「wrap-up はセッション完了後」）を疑うことで設計の自由度が広がる
- SPC（統計的工程管理）の考え方は、AI エージェントの「思考工程」の品質管理にも応用できる

## 次のステップ

- 次回のセッションで判断ログのリアルタイム記録を実際に試し、コストが許容範囲か検証する
- 改善記録が10件追加された時点で、分析ガイドに従い初回の定期分析を実施する
