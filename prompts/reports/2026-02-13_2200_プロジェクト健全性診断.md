# プロジェクト健全性診断（2026-02-13）

## 概要

`/assess` スキルによる月次診断。前回（2026-02-10）からの差分・トレンドを含む。

## 前回比トレンド

| 指標 | 2/10 | 2/13 | 変化 |
|------|------|------|------|
| Phase | Phase 1 完了後（品質改善期） | Phase 2-3 実質完了 | Phase 2-1〜2-3 を 3 日で完走 |
| オープン Issue | 14 | 18 | +4 |
| 停滞 Issue | 0 | 0 | → |
| 大型ファイル（500 行超） | 16 | 16 | →（ただし最大: 1696→3501） |
| TODO/FIXME | 2 | 3 | +1 |
| 未使用依存 | 0 | 0 | → |
| ADR | 40 | 44 | +4 |
| 改善記録（2 月） | 33 | 43 | +10 |
| セッションログ（2 月） | 51 | 92 | +41 |
| バックエンド統合テスト | 8 | 18 | +10 |
| API テスト | 20 | 26 | +6 |
| E2E テスト | 0 | 3 | +3（新規導入） |
| 機能仕様書 | 2 | 4 | +2 |

主な変化:
- Phase 2-1（RLS）、Phase 2-2（ユーザー管理+監査ログ）、Phase 2-3（多段階承認+差し戻し+コメント）を完了
- テスト基盤が大幅に拡充（統合テスト +10、API テスト +6、E2E テスト新規導入）
- `workflow/command.rs` が 1696→3501 行に倍増（Phase 2-3 の機能追加による）
- 前回の推奨アクション「Feature と Maintain のバランス回復」が達成された

## 📋 診断結果

### 🔭 Discovery（攻め）

**現在の Phase**: Phase 2-3（複数ステップ承認 + 差し戻し + コメント）— 実質完了
**Phase 進捗**: Phase 2 全体で 3/5 サブフェーズ完了（60%）

| Phase | 状態 | 根拠 |
|-------|------|------|
| Phase 0: 基盤構築 | 完了 | ロードマップ確認済み |
| Phase 1: MVP | 完了 | ロードマップ確認済み |
| Phase 2-1: マルチテナント RLS | 完了 | 完了基準 4/4 チェック済み |
| Phase 2-2: ユーザー管理 + 監査ログ | 実質完了 | Story #428-#432 全クローズ。ロードマップの完了基準未更新 |
| Phase 2-3: 複数ステップ承認 + 差し戻し + コメント | 実質完了 | Story #475-#478 全クローズ（2/12-13）。Epic #404 未クローズ |
| Phase 2-4: ワークフローデザイナー | 未着手 | Epic #405 |
| Phase 2-5: 通知 + ドキュメント管理 | 未着手 | Epic #406 |

#### 未実装の主要機能

| 機能 | Phase | 要件 ID | 学習価値 | 備考 |
|------|-------|---------|---------|------|
| ワークフローデザイナー | 2-4 | WF-001, WFD-001〜005 | 高 | GUI ビルダー、Elm Ports、JSON スキーマ |
| 通知（メール） | 2-5 | NOTIFY-001 | 中 | AWS SES 連携 |
| ドキュメント管理 | 2-5 | DOC-001, DOC-003 | 中 | AWS S3 連携、署名付き URL |
| SSO/MFA | 3 | AUTH-002〜004 | 高 | 外部 IdP 連携 |
| 条件分岐・並列承認 | 3 | WF-002, WF-003 | 高 | 高度な状態遷移 |
| イベントソーシング/CQRS | 4 | OPS-10 | 高 | アーキテクチャ刷新 |

#### 設計ドキュメント準備状況

| Phase | 要件定義 | 機能仕様書 | 詳細設計 |
|-------|---------|-----------|---------|
| 2-4 | 定義済み | 未作成 | 未作成 |
| 2-5 | 定義済み | 未作成 | 未作成 |

#### 推奨: 次に取り組む機能候補

1. **Phase 2-4: ワークフローデザイナー** — Phase 2-3 完了により前提条件が揃った。GUI ビルダー・Elm Ports・JSON スキーマ設計と学習価値が最も高い。Phase 2 の目玉機能
2. **Phase 2-5: 通知 + ドキュメント管理** — AWS サービス連携（SES, S3）を学ぶ機会。Phase 2-3 完了が前提で着手可能

---

### 📊 Delivery（実行）

**バックログ**: オープン 18 件（epic: 3, priority:medium: 2, priority:low: 5, ラベルなし: 8）
**消化ペース**: 直近 3 日（2/11-13）で 20 件クローズ
**停滞**: 0 件

#### バックログ内訳

| カテゴリ | 件数 | 代表 Issue |
|---------|------|-----------|
| Epic（Phase 2-3〜2-5） | 3 | #404, #405, #406 |
| DX 改善 | 3 | #447 CI ビルド時間短縮, #450 シフトレフト, #467 警告ゼロ |
| アイデア / 検討中 | 4 | #445 UI/UX 改善, #389 ラベル乖離検知, #302 ルール棚卸し, #137 API 整合性 |
| 技術的負債 | 3 | #492 ダミー値排除, #471 削除レジストリ信頼性, #460 prompts 再定義 |
| 低優先度 | 5 | #323 docs リナンバリング, #276 Lightsail dual-stack, #104 技術ノート分離, #123 gRPC 検討, #136 シード分離 |

#### 注意が必要な Issue

| Issue | 状態 | 理由 |
|-------|------|------|
| #404 Phase 2-3 Epic | 未クローズ | Story 全完了済みだが Epic 未クローズ |
| #492 ApproverSelector ダミー値排除 | 新規 | Phase 2-3 実装中に発見された技術的負債 |

---

### 🛡️ Sustainability（守り）

#### コード健全性

- **大型ファイル（500 行超）: 16 件**（前回比: ±0 件、ただし最大ファイルが 1696→3501 行に倍増）

| ファイル | 行数 | 前回比 |
|---------|------|--------|
| `core-service/usecase/workflow/command.rs` | 3501 | +1805 |
| `frontend/src/Page/Workflow/Detail.elm` | 1367 | 新規 |
| `bff/handler/auth.rs` | 1071 | +86 |
| `frontend/src/Page/Workflow/New.elm` | 1046 | -69 |
| `domain/workflow/instance.rs` | 1003 | 新規 |
| `core-service/handler/auth.rs` | 965 | 新規 |
| `domain/workflow/step.rs` | 809 | 新規 |
| `core-service/usecase/task.rs` | 796 | 新規 |
| `infra/repository/user_repository.rs` | 782 | 新規 |
| 他 7 ファイル | 539〜650 | — |

- **TODO/FIXME: 3 件**（前回比: +1）
  - `backend/.../dynamodb_audit_log.rs` — `TODO(#471)` Issue 紐づき済み
  - `frontend/src/Page/Home.elm` — `TODO(human)` KPI カードデザイン
  - `frontend/src/Page/Workflow/New.elm` — `TODO` 保存→申請の連続処理
- **未使用依存: 0 件**

#### ドキュメント整合性

- 未実装マーカー: 24 箇所（前回比: +6。Phase 2-2, 2-3 の設計書追加による）
- ADR 総数: 44 件（前回比: +4）
- 改善記録（今月）: 43 件（前回比: +10）

#### 依存関係

- Rust outdated: `cargo-outdated` 未インストール（スキップ）— 前回同様
- Frontend outdated: 出力なし — 前回同様
- セキュリティ脆弱性: `cargo-audit` 未インストール（スキップ）— 前回同様、2 回連続未対応

#### テスト

| テスト層 | ファイル数 | 前回比 |
|---------|-----------|--------|
| バックエンド統合テスト | 18 | +10 |
| API テスト（Hurl） | 26 | +6 |
| E2E テスト（Playwright） | 3 | +3（新規） |

#### プロセス

| 指標 | 前回（2/10） | 今回（2/13） | 変化 |
|------|-------------|-------------|------|
| 改善記録（2 月累計） | 33 件 | 43 件 | +10 |
| セッションログ（2 月累計） | 51 件 | 92 件 | +41 |

---

### 🎯 推奨アクション

| 優先度 | カテゴリ | アクション | 根拠 | Issue |
|--------|---------|---------|------|-------|
| High | Maintain | `workflow/command.rs` (3501 行) を分割する | ADR-043 の 500 行閾値を 7 倍超過。3 日で倍増しており急務 | 新規作成 |
| High | Maintain | `cargo-audit` を導入しセキュリティチェックを有効化する | セキュリティは重点品質特性。2 回連続未対応 | 新規作成 |
| High | Improve | Phase 2-2/2-3 のロードマップ更新と Epic #404 クローズ | 完了した作業の記録が未反映 | 新規作成 |
| Medium | Feature | Phase 2-4 ワークフローデザイナーの設計に着手する | Phase 2-3 完了で前提条件クリア | #405 |
| Medium | Maintain | 1000 行超のファイル群（5 ファイル）の段階的分割 | 大型ファイルが累積中 | 上記 Issue に含む |
| Medium | Maintain | `cargo-outdated` を導入し依存関係の鮮度を可視化する | 前回同様未対応 | 上記 Issue に含む |
| Low | Maintain | #492 ApproverSelector のダミー値排除 | 技術的負債 | #492 |
| Low | Improve | フロントエンド TODO コメント 2 件を Issue 化 | Issue 紐づけなし | — |

#### 前回推奨アクションの対応状況

| 前回の推奨 | 対応状況 |
|-----------|---------|
| #290: 500 行超ファイルの分割 | Issue クローズ済みだが問題は悪化（最大 3501 行） |
| `cargo-outdated` / `cargo-audit` インストール | 未対応（2 回連続） |
| Feature と Maintain のバランス回復 | 達成（Phase 2-1〜2-3 完走） |
| Phase 2 計画策定 | 達成（Phase 2-1〜2-3 完了） |
| コード共通化 #379, #378, #377 | 全クローズ済み |
| E2E テスト #128 導入 | 達成（Playwright 3 ファイル） |

---

### セルフレビュー記録

| ループ | 観点 | 修正内容 |
|-------|------|---------|
| 1回目 | データ正確性 | Phase 2-2 を「実質完了（ロードマップ未更新）」に修正。前回比の行数差分を精査 |
| 1回目 | 診断の偏り | 依存関係チェックツール未インストールのため Sustainability の依存関係評価が不十分。推奨アクションに追加 |
| 1回目 | 推奨の根拠 | 全推奨アクションがデータに紐づいていることを確認 |

## 総合所見

前回診断（2/10）から 3 日で Phase 2-1〜2-3 を完走し、プロダクトの機能面が大幅に前進した。テスト基盤も統合テスト +10、API テスト +6、E2E テスト新規導入と充実。

一方、急速な機能追加に伴い `workflow/command.rs` が 3501 行に膨張（前回の 2 倍超）しており、保守性のリスクが高い。また、`cargo-audit` 未導入が 2 回連続で指摘されており、セキュリティチェック基盤の整備が急がれる。

次のフォーカスは、Phase 2-4（ワークフローデザイナー）への着手と、技術的負債（大型ファイル分割）の解消のバランスを取ること。
