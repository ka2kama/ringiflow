# ローカルと CI のテストスコープ差異による検証漏れ

**発生日時**: 2026-02-02
**重大度**: 中

## 問題

Issue #205（表示用 ID: DB スキーマ変更）で、`create_workflow()` に暫定値 `DisplayNumber::new(1).unwrap()` を設定した。ローカルの `just check-all`（144 Rust テスト + lint + sqlx check）はすべて通過したが、CI の API テスト（Hurl）で `POST /api/v1/workflows` が 500 エラーになった。

原因: シードデータの `display_number = 1` と暫定値がテナント内ユニーク制約で衝突した。

## 原因分析

### 直接原因

**ローカルの `check-all` と CI のテストスコープの差異を認識していなかった。**

| 検証レベル | DB 制約の適用 | シードデータの有無 | 暫定値の衝突検出 |
|-----------|-------------|------------------|----------------|
| ユニットテスト（Mock） | なし | なし | ❌ |
| 統合テスト（`#[sqlx::test]`） | あり | なし（テスト毎に独立） | ❌ |
| `just check-all` | 上記 2 つの合計 | — | ❌ |
| API テスト（Hurl） | あり | あり | ✅ |
| CI | 全部 | — | ✅ |

### 根本原因

**自己検証チェックリスト項目 5「レイヤー間接続」の確認が片方向だった。**

自己検証では「`WorkflowInstance` は `Serialize` を derive していないので API レスポンスに影響しない → OK」と判断した。これは**出力方向**（レスポンスへの `display_number` 露出）のみの確認であり、**入力方向**（`create_workflow` が実 DB に INSERT するときのユニーク制約衝突）を見落とした。

さらに深掘りすると:

1. 計画段階で「暫定値は本番で衝突するが Phase A-2 を即座に実装するため許容」と記載していた
2. この「許容範囲」の判断で**API テストの存在を考慮していなかった**
3. 「衝突する」と認識しつつ「影響範囲」の洗い出しを怠った

**暫定値・ワークアラウンドを採用する際に「その値が通る全パス」を洗い出すステップが欠如していた。**

## 対策

### 1. 自己検証チェックリストの「レイヤー間接続」補足（即時対応）

実装フェーズチェックリスト項目 5 に、入力方向の確認を追記する。

修正前:
> 既存 API のレスポンス拡張が必要な箇所を見落としていないか

修正後:
> フルスタック変更の場合、既存 API のレスポンス拡張が必要な箇所を見落としていないか。また、書き込みパスで DB 制約（UNIQUE、FK、NOT NULL）に影響する変更がないか

Issue #216

### 2. 暫定値・ワークアラウンド採用時の影響パス洗い出し（即時対応）

暫定値やワークアラウンドを計画に記載する際、「その値が通る全パス」を列挙し、各パスで問題がないことを確認する。

今回の例:

```
DisplayNumber::new(1) が通るパス:
1. ユニットテスト → Mock リポジトリ → DB 制約なし → OK
2. 統合テスト → #[sqlx::test] → シードデータなし → OK
3. API テスト → 実 DB + シードデータ → display_number=1 が衝突 → NG ← ここを見落とした
4. 開発サーバー → 実 DB + シードデータ → 衝突 → NG（計画で許容済み）
```

この洗い出しを行っていれば、パス 3 で問題に気付けた。

Issue #216（上記と同一 Issue で対応）

## 次のアクション

- [x] 暫定値を `Utc::now().timestamp_millis()` に修正（本セッション内で対応済み）
- [x] 改善記録を作成（本ファイル）
- [ ] 自己検証チェックリストを更新（Issue #216）

## 関連

- Issue: #205 表示用 ID: DB スキーマ変更（Phase A-1）
- PR: #215
- 自己検証プロトコル: [`.claude/rules/zoom-rhythm.md`](../../.claude/rules/zoom-rhythm.md)
- 類似: [計画段階での置換対象と設計決定の網羅性不足](2026-02-02_1023_計画段階での置換対象と設計決定の網羅性不足.md) — 計画の自己検証不足が共通課題

## 分類

- カテゴリ: 視点不足
- 失敗タイプ: 実行ギャップ

## 検証（対策実行後に追記）

- 実施日: 2026-02-06
- 対策の実行状況: 実行済み
- 効果: `.claude/rules/zoom-rhythm.md` の「収束確認のチェックリスト > 実装フェーズ」に「暫定値・ワークアラウンド採用時の影響パス洗い出し」が追加された。計画段階で影響パスを明示的に列挙する構造的な仕組みが確立された
- 備考: なし
