# 自己検証ループの自動実行欠如

**発生日時**: 2026-02-05
**重大度**: 中
**カテゴリ**: 検証プロセス

## 問題

Issue #222 の実装計画を作成し ExitPlanMode で提示した際、設計・計画フェーズの自己検証ループを実施していなかった。

ユーザーの指摘を受けて事後的に検証したところ、以下 3 件の指摘が見つかった:

| # | 種別 | 内容 |
|---|------|------|
| 1 | 事実誤り | 呼び出し元のパスが `bff/src/handler/auth.rs` → 正しくは `core-service/src/handler/auth.rs` |
| 2 | 曖昧な記述 | 「User::new() 使用箇所が**あれば**更新」— grep 1 回で確定できる事実が未確認 |
| 3 | 概算値 | Phase 2 の呼び出し箇所数が「~15箇所」等の概算 — grep で実数を確定可能 |

いずれも計画提示前に grep 数回で発見・修正できたものだった。

## 原因分析

### 直接原因

計画を生成した後、自己検証を実施せずに ExitPlanMode を呼んだ。

```
探索 → 計画作成 → [自己検証なし] → ExitPlanMode → ユーザーが指摘 → 事後検証
```

### 根本原因

**自己検証プロトコルが「知識」として存在するが、ワークフローに構造的に組み込まれていない。**

自己検証プロトコル（`.claude/rules/self-review.md`）は、計画段階での網羅性不足（2026-02-02）を受けて作成された。しかし現状のプロトコルは「提示前に検証すること」という行動規範であり、検証の実施を強制する構造的な仕組みがない。

これは改善記録 [Hurl 仕様未確認の再発と改善記録の形骸化](2026-02-02_1735_Hurl仕様未確認の再発と改善記録の形骸化.md) で指摘された「チェックリストの存在だけでは行動変容を担保できない」と同じ構造の問題である。

### 再発パターン

```
問題発生 → 改善記録 → プロトコル/ルール追加 → 遵守されない → 再発
```

過去の類似インシデント:

| 日付 | 問題 | 対策 | 結果 |
|------|------|------|------|
| 2026-02-01 | Hurl 仕様未確認 | チェックリスト項目 7 追加 | 翌日再発 |
| 2026-02-02 | 計画の網羅性不足 | 自己検証プロトコル策定 | 3日後に未実施（本件） |

## 対策

### 恒久対策: 計画ファイルに自己検証セクションを必須化

計画ファイルに `## 自己検証` セクションの記載を必須とする。チェックリストの各項目に対する判定結果を明記しなければ、計画が完成したとみなさない。

計画ファイルの末尾に以下を記載する:

```markdown
## 自己検証（設計・計画）

| # | 観点 | 判定 | 確認内容 |
|---|------|------|---------|
| 1 | 網羅性 | OK / NG | [具体的な確認内容] |
| 2 | 曖昧さ排除 | OK / NG | [具体的な確認内容] |
| 3 | 設計判断の完結性 | OK / NG | [具体的な確認内容] |
| 4 | スコープ境界 | OK / NG | [具体的な確認内容] |
| 5 | 技術的前提 | OK / NG | [具体的な確認内容] |
| 6 | 既存ドキュメント整合 | OK / NG | [具体的な確認内容] |
```

構造的な強制力:

- 自己検証セクションが計画ファイルの**一部**になることで、「検証したか」が成果物として可視化される
- 行動規範（「検証すること」）ではなく、成果物要件（「検証結果が記載されていること」）にすることで、欠落が目に見える

CLAUDE.md の自己検証プロトコルへの追記が必要。

## 次のアクション

- [x] 自己検証プロトコル（`.claude/rules/self-review.md`）に「計画ファイルへの検証結果記載」セクションを追加

## 関連

- Issue: #222 ドメインモデルから非決定的な値の生成を排除する
- PR: #228
- 自己検証プロトコル: [`.claude/rules/self-review.md`](../../.claude/rules/self-review.md)
- 前提となった改善記録: [計画段階での置換対象と設計決定の網羅性不足](2026-02-02_1023_計画段階での置換対象と設計決定の網羅性不足.md)
- 同構造の問題: [Hurl 仕様未確認の再発と改善記録の形骸化](2026-02-02_1735_Hurl仕様未確認の再発と改善記録の形骸化.md)
