# pnpm 直接実行による環境変数未読み込み

## 事象

開発サーバーを起動するために `pnpm run dev` を直接実行したところ、Vite のプロキシ設定でエラーが発生した。

```
TypeError: Invalid URL
  code: 'ERR_INVALID_URL',
  input: 'http://localhost:undefined',
```

`vite.config.js` のプロキシ設定で `process.env.BFF_PORT` が `undefined` になっていた。

## 原因分析

このプロジェクトでは、環境変数はルートの `.env` ファイルで管理し、justfile の `set dotenv-load := true` で読み込む設計になっている。

```
# justfile
set dotenv-load := true

# vite.config.js
proxy: {
  "/api": {
    target: `http://localhost:${process.env.BFF_PORT}`,
    ...
  },
},
```

`pnpm run dev` を直接実行すると:

1. justfile を経由しないため `.env` が読み込まれない
2. `BFF_PORT` が `undefined` のまま Vite が起動
3. プロキシの target URL が不正となりエラー

`just dev-web` を使えば:

1. justfile が `.env` を読み込む
2. 環境変数が設定された状態で `pnpm run dev` が実行される

## 対策

開発サーバーの起動には必ず `just` コマンドを使用する。

| 操作 | 正しいコマンド | 避けるべきコマンド |
|------|--------------|------------------|
| フロントエンド開発サーバー | `just dev-web` | `pnpm run dev` |
| バックエンド開発サーバー | `just dev-bff` | `cargo run` |
| 全体起動 | `just dev` | - |

### 根本原因: ドキュメントの不備

`vite.config.js` のコメントには以下の記載がある:

```javascript
/**
 * Vite 設定
 *
 * ポート番号はルートの .env ファイルで設定（justfile の dotenv-load で読み込み）
 * ...
 */
```

しかし、この情報は:

- CLAUDE.md には記載されていない
- 開発環境構築手順書にも明示されていない

AI エージェントが「フロントエンドを起動して」と依頼されたとき、`just` を経由せず直接 `pnpm run dev` を実行してしまった。

## 次のアクション

1. [x] 改善記録を作成（本ファイル）
2. [x] 技術ノートに環境変数管理の仕組みを記載（[Vite.md](../../../docs/06_技術ノート/Vite.md#環境変数管理)）
3. [x] CLAUDE.md に開発サーバー起動の注意事項を追加

## 分類

- カテゴリ: 参照漏れ
- 失敗タイプ: 知識ギャップ
