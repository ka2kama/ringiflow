# API デコーダー整合性確認不足

**発生日時**: 2026-01-28
**重大度**: 中
**カテゴリ**: 実装品質

## 問題

詳細画面で「データの読み込みに失敗しました」エラーが発生。API からはデータが正常に返却されていたが、Elm デコーダーがレスポンス形式と一致していなかった。

### 原因

- BFF の API レスポンスは `{"data": {...}}` 形式（ラッパー付き）
- `listDecoder` は `Decode.field "data"` で正しく処理していた
- `getWorkflow` のデコーダーは `data` ラッパーを処理していなかった
- 一覧画面は動作し、詳細画面だけ失敗するという部分的な不具合

### 根本原因

1. API 実装時に Elm デコーダーとの整合性を確認していなかった
2. OpenAPI / BFF / Elm の3箇所が独立しており、手動同期に依存
3. デコーダーのユニットテストが不足

## 対策

### 即時対策（実施済み）

- `getWorkflow` のデコーダーを修正: `Decode.field "data" WorkflowInstance.decoder`

### 恒久対策（Issue #137）

**Phase 1: E2E テスト導入**
- Playwright で実際の BFF を起動し、画面表示を検証
- デコーダーの書き間違いを実行時に確実に検知

**Phase 2: Code First 移行**
- Rust → utoipa → OpenAPI → Elm コード生成
- 手動同期を排除し、コンパイル時に整合性を担保

### 採用しなかった対策

- **Elm ユニットテストで JSON ハードコード**: 実 API との乖離を検知できない
- **Mock BFF**: Mock のレスポンス形式が間違っていたら意味がない

## AI エージェントへの教訓

API エンドポイントを実装・修正した場合:

1. **レスポンス形式を確認**: 既存の類似エンドポイントと形式を比較
2. **デコーダーの一貫性**: 同じリソースの一覧/詳細で同じパターンを使用しているか確認
3. **curl でテスト**: 実際のレスポンス JSON を確認してからデコーダーを書く

```bash
# レスポンス形式の確認
curl -s -b "session_id=dev-session" -H "X-Tenant-ID: ..." \
  "http://localhost:13100/api/v1/workflows/{id}" | jq .
```

## 関連

- セッションログ: `2026-01-28_DevAuth設定と詳細画面バグ修正.md`
- Issue: #137 API 仕様と実装の整合性担保
