# worktree 環境でのポート競合

## 事象

worktree 環境で `just dev-deps` を実行したところ、ポートが既に使用中でコンテナが起動できなかった。

```
Error response from daemon: Bind for 0.0.0.0:16379 failed: port is already allocated
```

原因は `.env` にオフセット 0（メイン用）のポートが設定されており、メインの ringiflow コンテナと競合していた。

## 原因分析

### 直接原因

worktree の `.env` ファイルにメイン用のポート番号が設定されていた：

```
POSTGRES_PORT=15432  # メインと同じ
REDIS_PORT=16379     # メインと同じ
```

### 根本原因

`just setup` または `just setup-env` を実行すると、`.env.template` から `.env` がコピーされる。

```bash
# justfile の setup-env
@test -f .env || (cp .env.template .env && echo "  作成: .env")
```

`.env.template` にはオフセット 0 のポートがハードコードされているため、worktree 用に `generate-env.sh` で設定したポートオフセットが上書きされてしまう。

### 発生条件

1. `just worktree-add` で worktree を作成（ポートオフセットが設定される）
2. その後、何らかの理由で `just setup-env` を実行（または手動で .env を削除後に実行）
3. `.env.template` からコピーされ、オフセット 0 に戻る

## 対策

### 方針

`setup-env` を worktree 対応にする。worktree を検出した場合は、既存の `.env` を保持するか、適切なオフセットで再生成する。

### 実装

`justfile` の `setup-env` タスクを修正：

1. worktree かどうかを検出（`git rev-parse --git-dir` で判定）
2. worktree の場合、`.env` が存在すれば保持（上書きしない）
3. worktree で `.env` がない場合は、空きオフセットを探して `generate-env.sh` を実行

## 次のアクション

1. [x] 改善記録を作成（本ファイル）
2. [x] `justfile` の `setup-env` を worktree 対応に修正
3. [ ] 技術ノート「並行開発（Worktree）」にトラブルシューティングを追記（任意）
