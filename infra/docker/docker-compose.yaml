# RingiFlow ローカル開発環境
#
# 起動: docker compose up -d
# 停止: docker compose down
# 削除（データ含む）: docker compose down -v
#
# PostgreSQL は Aurora PostgreSQL 17 互換
# Redis は ElastiCache Redis 7 互換
#
# ポート番号は .env ファイルで設定（他プロジェクトとの競合回避）
# 起動前に just setup-env で .env ファイルを作成すること
#
# worktree 対応:
#   プロジェクト名を変えることで、複数のインスタンスを並行起動可能
#   docker compose -p ringiflow-auth up -d
#   → コンテナ名: ringiflow-auth-postgres-1, ringiflow-auth-redis-1
#   → ボリューム名: ringiflow-auth_postgres_data, ringiflow-auth_redis_data
#   詳細: [並行開発（Worktree）](../../docs/04_手順書/04_開発フロー/04_並行開発（Worktree）.md)

services:
  # PostgreSQL データベース
  # 本番環境: Aurora PostgreSQL Serverless v2
  postgres:
    image: postgres:17-alpine
    # container_name は指定しない（プロジェクト名ベースで自動命名）
    environment:
      POSTGRES_USER: ringiflow
      POSTGRES_PASSWORD: ringiflow
      POSTGRES_DB: ringiflow_dev
      # タイムゾーン設定（本番環境と統一）
      TZ: Asia/Tokyo
      PGTZ: Asia/Tokyo
    ports:
      - "${POSTGRES_PORT}:5432"
    volumes:
      # データ永続化
      - postgres_data:/var/lib/postgresql/data
      # 初期化スクリプト
      - ./init:/docker-entrypoint-initdb.d:ro
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ringiflow -d ringiflow_dev"]
      interval: 5s
      timeout: 5s
      retries: 5
      start_period: 10s
    restart: unless-stopped

  # Redis キャッシュ/セッションストア
  # 本番環境: ElastiCache Redis
  # 用途:
  #   - セッション管理（HTTPOnly Cookie のバックエンド）
  #   - CSRF トークン
  #   - キャッシュ（Read Model）
  #   - レート制限
  #   - WebSocket Pub/Sub
  redis:
    image: redis:7-alpine
    # container_name は指定しない（プロジェクト名ベースで自動命名）
    command: redis-server --appendonly yes
    ports:
      - "${REDIS_PORT}:6379"
    volumes:
      # データ永続化
      - redis_data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 5s
      retries: 5
      start_period: 5s
    restart: unless-stopped

  # DynamoDB Local（監査ログストア）
  # 本番環境: Amazon DynamoDB
  # 用途:
  #   - 監査ログ（ユーザー操作、ロール操作の記録）
  # -inMemory: データはメモリ上のみ（コンテナ再起動でリセット）
  # -sharedDb: 全リクエストで同一 DB を共有（リージョン・認証情報に依存しない）
  dynamodb:
    image: amazon/dynamodb-local:latest
    ports:
      - "${DYNAMODB_PORT}:8000"
    command: ["-jar", "DynamoDBLocal.jar", "-sharedDb", "-inMemory"]
    healthcheck:
      test: ["CMD-SHELL", "curl -s -o /dev/null http://localhost:8000 || exit 1"]
      interval: 5s
      timeout: 5s
      retries: 5
      start_period: 5s
    restart: unless-stopped

# 名前付きボリューム
# name を指定しない → プロジェクト名がプレフィックスとして付与される
# 例: ringiflow_postgres_data, ringiflow-auth_postgres_data
volumes:
  postgres_data:
  redis_data:
