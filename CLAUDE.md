# CLAUDE.md

このファイルはClaude Codeがこのリポジトリで作業する際のガイダンスを提供する。
Codex / Gemini CLI / Junie等を使う場合も同様に参照すること。

## 言語

常に日本語で応答する。コミットメッセージ、コメント、ドキュメントも日本語で記述する。

## プロジェクト概要

RingiFlow: 承認フロー・タスク管理・ドキュメント管理を一元化するエンタープライズ向けワークフロー管理システム（SaaS）

| レイヤー | 技術 |
|---------|------|
| バックエンド | Rust + axum（BFF / Core API） |
| フロントエンド | Elm |
| インフラ | AWS（ECS Fargate, Aurora PostgreSQL, ElastiCache Redis） |
| IaC | Terraform |

## プロジェクト理念

このプロジェクトには2つの確固たる理念がある。すべての作業・設計・判断においてこれを最優先する。

### 理念1: 学習効果の最大化

このプロジェクトはオーナーの技術的学びを深める場である。
AIエージェントは単にコードを書くだけでなく、オーナーの理解促進を常に意識すること。

- 設計判断を伴う箇所では、なぜその選択をしたか解説する
- 代替案とトレードオフを示し、思考プロセスを共有する
- 応用パターンやベストプラクティスの観点から説明する

詳細は「学習支援」セクションを参照。

### 理念2: 品質の追求

外部品質（ユーザー体験、信頼性）と内部品質（保守性、可読性）の両方を追求する。

**外部品質** — ユーザーが直接体験する品質

| 観点 | 内容 |
|------|------|
| 信頼性 | バグが少なく、期待通りに動作する |
| パフォーマンス | 応答が速く、リソースを無駄にしない |
| セキュリティ | 脆弱性がなく、データが保護されている |
| ユーザビリティ | エラー時も適切なフィードバックがある |

**内部品質** — 開発者が体験する品質。長期的な外部品質を支える基盤

| 観点 | 内容 |
|------|------|
| 可読性 | コードの意図が明確で、他者（将来の自分含む）が理解できる |
| 保守性 | 変更が容易で、修正が他の箇所を壊さない |
| テスタビリティ | 自動テストが書きやすい構造になっている |

**品質を実現する手段**

設計原則:
- シンプルさを保つ（KISS）。必要十分な複雑さに留める
- 責務を明確に分離する。一つのモジュール/関数は一つの責務
- 依存関係の方向を意識する。詳細が抽象に依存する構造
- 変更の影響範囲を局所化する設計を心がける

型システムの活用（Rust / Elmの強みを活かす）:
- 型で表現できるものは型で表現する（文字列や整数の濫用を避ける）
- 不正な状態を表現不可能にする（Make Illegal States Unrepresentable）
- コンパイラを味方につけ、実行時エラーよりコンパイルエラーを選ぶ
- 安易なunwrap / expectを避け、エラーを適切に型で扱う

テスト:
- 自動テストでリグレッションを防ぐ
- テストは仕様のドキュメントでもある
- テストしやすい設計は、良い設計である可能性が高い

コードの明確さ:
- 意図が伝わる命名を心がける
- コメントは「なぜ」を書く。「何を」はコードで表現する
- 過度な抽象化・過度なDRYを避ける。3回繰り返すまでは重複を許容

継続的な改善:
- ボーイスカウトルール: 触ったコードは少し良くして去る
- 技術的負債は意識的に管理する。放置しない

---

これらの理念は「あれば良い」ではなく「必須」である。
速度や利便性のためにこれらを犠牲にしない。

## 暗黙知ゼロ

このプロジェクトは一切の暗黙知を許容しない。

- すべての知識はコード・実装・文書で明示する
- 新規参画者（人間・AI問わず）が文書だけで作業を完遂できる状態を維持する

### ドキュメント体系

| 知りたいこと | 参照先 | 起点 |
|-------------|--------|------|
| 何を作るか（WHAT） | [`docs/01_要件定義書/`](docs/01_要件定義書/) | [`00_はじめに.md`](docs/01_要件定義書/00_はじめに.md) |
| 全体設計（HOW） | [`docs/02_基本設計書/`](docs/02_基本設計書/) | [`00_アーキテクチャ概要.md`](docs/02_基本設計書/00_アーキテクチャ概要.md) |
| 実装設計（HOW） | [`docs/03_詳細設計書/`](docs/03_詳細設計書/) | [`00_実装ロードマップ.md`](docs/03_詳細設計書/00_実装ロードマップ.md) |
| どう操作するか（HOW TO） | [`docs/04_手順書/`](docs/04_手順書/) | [`00_はじめに.md`](docs/04_手順書/00_はじめに.md) |
| なぜその決定か（WHY） | [`docs/05_ADR/`](docs/05_ADR/) | [`README.md`](docs/05_ADR/README.md) |
| 技術の知識（WHAT/HOW） | [`docs/06_技術ノート/`](docs/06_技術ノート/) | [`README.md`](docs/06_技術ノート/README.md) |
| セッション記録 | [`prompts/runs/`](prompts/runs/) | [`README.md`](prompts/runs/README.md) |

### ドキュメントの役割分担

**要件定義書（WHAT）の役割:**
- 機能要件・非機能要件の定義
- ユースケース、業務フロー
- 用語集

**基本設計書（HOW - 全体設計）の役割:**
- システムアーキテクチャ
- インフラ構成
- コンポーネント間の関係
- 運用設計

**詳細設計書（HOW - 実装設計）の役割:**
- データベース設計
- API 設計
- 実装ロードマップ・実装計画
- コーディング規約・ガイドライン
- 個別機能の設計

**手順書（HOW TO）の原則:**
- 自動化できるものは `justfile` にタスク化する
- 手順書には自動化できない操作のみ記載する（外部サービス設定、UI操作など）
- UI操作よりCLI操作を優先する
- 設計判断・設計意図は手順書に書かない（設計書へのリンクに留める）
- トラブルシューティングは手順書に残す

**ADR（WHY）の役割:**
- 重要な意思決定の記録
- 検討した選択肢と採用理由
- 将来の参照用（なぜこの技術を選んだか等）

**技術ノート（WHAT/HOW）の役割:**
- ツール・ライブラリの使い方
- 技術概念の解説（TEA パターン、CQRS など）
- Tips、ベストプラクティス
- ADR とは異なり、更新可能

```
自動化可能な操作 → justfile
自動化不可な操作 → 手順書
全体設計         → 基本設計書
実装設計         → 詳細設計書
重要な意思決定   → ADR
技術の知識       → 技術ノート
```

AIエージェントが手順を案内する場合:
- 操作手順を聞かれたら `justfile` または手順書を参照するよう案内する
- 会話の中で手順を独自に生成・要約しない
- 新しい手順が必要なら、justfile か手順書に追記して形式知化する

### 技術ノートの活用方針

**コードコメントは簡潔に、詳細は技術ノートへ:**
- コード内のコメントは「何をしているか」を簡潔に
- 「なぜ」「どう使うか」の詳細解説は技術ノートに書き、コードからリンク

```rust
//! 詳細: [BFF パターン](../../../docs/06_技術ノート/BFFパターン.md)
```

```elm
{-| 詳細: [TEA パターン](../../../docs/06_技術ノート/Elmアーキテクチャ.md) -}
```

**技術ノートを作成するタイミング:**
- 新しい技術・パターンを導入したとき
- 会話の中で技術解説が発生したとき
- コードのコメントが長くなりそうなとき

**技術ノートを作成しないケース:**
- プロジェクト固有の設計（→ 設計書へ）
- 技術選定の理由（→ ADR へ）
- 一度きりの手順（→ 手順書へ）

作業開始時は [`docs/01_要件定義書/00_はじめに.md`](docs/01_要件定義書/00_はじめに.md) から読み、全体像を把握すること。

### ドキュメント自動作成ルール

セッション中に以下の条件に該当した場合、対応するドキュメントを作成する。

**ADR（意思決定記録）** — 以下のいずれかに該当する場合:
- 技術・ライブラリ・ツールを選定した
- 複数の実装方針から一つを選択した
- 将来変更される可能性のある設計判断をした
- 「採用しない」という判断をした（見送りの記録も重要）

**技術ノート** — 以下のいずれかに該当する場合:
- 新しいツール・ライブラリ・パターンを導入した
- 会話内で技術的な解説を行った（その内容を形式知化）
- 既存の技術ノートに追記すべき知見が得られた

**セッションログ** — 以下のいずれかに該当する場合:
- コードの変更（新規作成・修正・削除）があった
- 設計判断・技術選定があった
- 調査・検討の結果、何らかの結論に至った

フォーマットは [`prompts/runs/README.md`](prompts/runs/README.md) に従うこと。

## 学習支援

このプロジェクトはAIエージェントによる実装実験であると同時に、オーナーの技術的学びを深める場でもある。
AIはコードを書くだけでなく、オーナーの理解促進を支援すること。

### 解説のタイミング

以下のような「設計判断を伴う箇所」では、コードとともに解説を提供する:

- アーキテクチャ上の決定（なぜこの構造にしたか）
- 複数の実装パターンから一つを選択した場面
- 非自明なロジックやイディオム
- トレードオフが存在する選択

単純なCRUD実装や定型的な修正では解説は不要。

### 解説の内容

1. 意図: なぜこのコード/設計にしたか
2. 代替案: 他にどんな選択肢があったか、なぜ採用しなかったか
3. トレードオフ: この選択のメリット・デメリット
4. 関連知識: 理解を深めるための概念や参考情報

### 想定レベル

オーナーは中級者（各技術の基礎は理解済み）。
基本構文の説明は不要。応用パターンやベストプラクティスの観点から解説する。

### 注力領域

特に以下の領域では、より詳細な解説を心がける:

- アーキテクチャ設計（DDD, CQRS, イベント駆動など）
- Elm/TEAパターン（状態管理、Ports設計、関数型の考え方）
- 全般的なソフトウェア設計原則

## ドキュメント規約

→ [`.claude/rules/docs.md`](.claude/rules/docs.md)（`docs/**/*.md` 編集時に自動適用）

## データストア追加時の必須対応

新しいデータストア（テーブル、DynamoDB テーブル、S3 バケット、Redis キーパターン等）を追加する場合、テナント退会時のデータ削除を考慮した設計が必須である。

→ [`.claude/rules/data-store.md`](.claude/rules/data-store.md)（マイグレーション・インフラ編集時に自動適用）

### 必須チェック項目

1. **tenant_id による削除が可能か**
   - PostgreSQL: `tenant_id` カラム + `ON DELETE CASCADE/SET NULL`
   - DynamoDB: パーティションキーに `tenant_id`
   - S3: パス先頭に `{tenant_id}/`
   - Redis: キーに `{tenant_id}` を含む

2. **削除レジストリに登録したか**
   - 削除ハンドラ（`TenantDeleter` 実装）を追加
   - `DeletionRegistry::new()` に登録
   - テストの期待リストを更新

3. **設計書を更新したか**
   - `docs/03_詳細設計書/06_テナント退会時データ削除設計.md` の削除対象一覧に追記

**これらを忘れると、テナント退会時にデータが残存するリスクがある。**

詳細: [06_テナント退会時データ削除設計.md](docs/03_詳細設計書/06_テナント退会時データ削除設計.md)

## PRレビュー

Claude Code Action による自動PRレビューが有効化されている。

→ [`.github/workflows/claude-review.yml`](.github/workflows/claude-review.yml)

### レビュー方針

プロジェクト理念（学習効果の最大化、品質の追求）に基づいてレビューする。

**必須チェック:**

1. **バグ・正確性**: 実行時エラー、ロジックミス、エッジケースの見落とし
2. **セキュリティ**: 脆弱性、認証/認可の問題、機密データの露出
3. **パフォーマンス**: 明らかなボトルネック、N+1クエリ、メモリリーク
4. **型システムの活用**: Rust/Elmの強みを活かしているか
5. **テスト**: 新機能・バグ修正に対応するテストがあるか
6. **設計**: 責務の混在、依存関係の方向違反、過度な複雑さ

**学習機会の提供:**

設計判断を伴う重要な箇所では、学習のため簡潔に解説する。
すべての箇所に解説は不要。学びになるポイントのみ。

**指摘しないこと:**

- コードスタイルの好み（フォーマッタが担う領域）
- 既存コードとの些細な不整合（このPRの責務外）
- 明確な理由のない「こうした方がより良い」

### 承認基準

| 重大度 | 基準 | アクション |
|--------|------|-----------|
| Critical/High | マージ前に必ず修正が必要 | request-changes |
| Medium/Low | 改善推奨だがマージ可能 | approve + コメント |
| None | 問題なし | approve |

学習のための解説コメントは承認判断に影響しない。

### 使い方

- **自動レビュー:** PRオープン/更新時に自動実行（進捗トラッキング付き）
- **対話的レビュー:** PRコメントで `@claude` とメンションして質問

### 指摘対応フロー

PRを出してからマージするまでの標準フロー:

1. **CI チェック確認**
   ```bash
   gh pr checks
   ```

2. **レビューコメント確認**
   - GitHub の PR ページでレビューコメントを確認
   - または `gh pr view --comments` で取得

3. **指摘対応**
   - TDD で修正（テスト追加 → RED → 実装 → GREEN）
   - コミット＆プッシュ

4. **会話スレッド解決**
   - **重要:** 先に対応理由を返信してから resolve する
   - 返信例: 「○○ で修正しました（コミット: abc1234）」
   - 理由なしで resolve しない

5. **マージ**
   ```bash
   gh pr merge --squash --delete-branch --auto
   ```

**注意事項:**
- Auto Review が `cancelled` になった場合は concurrency 設定による中断。再実行を待つか手動で re-run
- `max-turns` 制限で途中終了した場合は、残りの指摘を手動で確認

## ツール設定

| ツール | 設定ファイル |
|--------|-------------|
| Claude Code | [`.claude/settings.json`](.claude/settings.json) |
| Junie | [`.junie/guidelines.md`](.junie/guidelines.md) |

secrets・`.env`の取り扱い、破壊的コマンドの回避、危険なgit操作時の確認については各設定ファイルを参照。

## Issue 駆動開発

このプロジェクトでは GitHub Projects + Issue 駆動で開発を進める。

→ [手順書: Issue 駆動開発](docs/04_手順書/04_開発フロー/01_Issue駆動開発.md)

### 基本フロー

1. Issue を確認または作成する
2. Issue 番号を含むブランチを作成する（例: `feature/34-user-auth`）
3. 実装する
4. PR を作成し、`Closes #34` で Issue と紐づける
5. マージすると Issue が自動クローズされる

### AI エージェントへの指示

- 新しい機能を実装する前に、対応する Issue が存在するか確認すること
- Issue が存在しない場合は、ユーザーに確認するか、新しい Issue を作成すること
- ブランチ名には Issue 番号を含めること（例: `feature/34-user-auth`）
- PR 作成時は `Closes #N` で Issue と紐づけること
- 小さな修正（typo、フォーマットなど）は Issue なしで進めてよい

### リソース

- [Project Board](https://github.com/users/ka2kama/projects/1)
- [Milestones](https://github.com/ka2kama/ringiflow/milestones)
- [Issues](https://github.com/ka2kama/ringiflow/issues)

## Git 操作ルール

### ブランチ戦略

**作業開始時に feature ブランチを作成する**

```bash
# 新機能開発
git checkout -b feature/機能名

# バグ修正
git checkout -b fix/バグ名
```

**ブランチ命名規則:**
- `feature/機能名` (例: `feature/phase1-domain-model`)
- `fix/バグ名` (例: `fix/user-validation`)

**禁止事項:**
- main ブランチで直接作業・コミットしない
- 後から feature ブランチを作成して main を巻き戻す運用をしない

### コミット前

```bash
just check-all
```

### Force Push

```bash
git push --force-with-lease --force-if-includes
```

### PR マージ

```bash
gh pr merge --squash --delete-branch --auto
```

**禁止事項:**
- `--admin` フラグで CI をバイパスしない
- CI が失敗している状態で強制マージしない
