# ADR-023: バックエンドアーキテクチャパターンの選択

## ステータス

承認済み

## コンテキスト

RingiFlow のバックエンドアーキテクチャについて、現在の水平レイヤー構造を維持すべきか、Vertical Slice Architecture に移行すべきかを検討する必要があった。

背景:
- 現在は `apps/` + `crates/{domain, infra, shared}` の水平レイヤー構造を採用
- Vertical Slice Architecture は近年注目されているパターンで、機能単位での凝集を重視
- プロジェクト理念（学習効果の最大化、品質追求）との整合性を評価する必要がある

関連する制約条件:
- マルチテナント要件（Pool モデル + RLS による行レベル分離）
- テナント退会時の完全削除要件（ADR-007）
- Phase 4 での CQRS + イベントソーシング導入予定
- 個人開発（学習目的）

## 検討した選択肢

### 選択肢 1: 水平レイヤー構造（現状維持）

```
backend/
├── apps/          ← API 層（BFF, Core, Auth）
└── crates/
    ├── domain/    ← ドメイン層（エンティティ、traits）
    ├── infra/     ← インフラ層（リポジトリ実装）
    └── shared/    ← 共有ユーティリティ
```

評価:
- 利点:
  - 横断的関心事（マルチテナント検証、削除ポリシー）を一元管理できる
  - Rust の型システム（traits）と相性が良い
  - DDD、SOLID、依存方向の原則を体系的に学べる
  - ADR-022 の方針と整合
- 欠点:
  - 機能追加時に複数層を横断して変更が必要
  - 層が肥大化すると見通しが悪くなる可能性

### 選択肢 2: Vertical Slice Architecture

```
backend/
├── features/
│   ├── workflow/
│   │   ├── submit/      ← 申請スライス
│   │   │   ├── handler.rs
│   │   │   ├── command.rs
│   │   │   ├── repository.rs
│   │   │   └── tests.rs
│   │   └── approve/     ← 承認スライス
│   ├── task/
│   └── document/
└── shared/              ← 横断的関心事
```

評価:
- 利点:
  - 機能追加がスライス内で完結
  - CQRS 導入時に自然なマッピング
  - 機能単位でのテスト・デプロイが容易
- 欠点:
  - マルチテナント検証が各スライスに重複
  - 共有ドメインロジック（承認、通知）の置き場所が曖昧
  - Cargo workspace との相性問題（crate 分割の粒度）
  - 新規スライス追加時にテナント削除処理の漏れリスク

### 選択肢 3: ハイブリッドアプローチ

水平レイヤーを基盤としつつ、handlers をスライス志向で整理する。

```
backend/
├── apps/
│   └── core-service/
│       └── src/
│           ├── handlers/           ← スライス志向で整理
│           │   └── workflow/
│           │       ├── submit.rs
│           │       └── approve.rs
│           └── usecases/           ← 必要な場合のみ
└── crates/
    ├── domain/                     ← 共有ドメインモデル
    └── infra/                      ← 横断的関心事
```

評価:
- 利点:
  - 横断的関心事を Infra 層に集約しつつ、機能単位の見通しも確保
  - ADR-022 と整合（usecase 層は必要な場合のみ）
  - Phase 4 の CQRS 導入に備えられる（handlers を Command/Query に分割可能）
- 欠点:
  - 純粋な Vertical Slice ほどスライスの独立性が高くない
  - 設計判断が増える（どこまでスライス化するか）

### 比較表

| 観点 | 水平レイヤー | Vertical Slice | ハイブリッド |
|------|-------------|----------------|-------------|
| マルチテナント対応 | ◎ 一元管理 | △ 重複リスク | ◎ 一元管理 |
| テナント削除対応 | ◎ 集約可能 | △ 分散リスク | ◎ 集約可能 |
| CQRS 導入準備 | ○ 対応可能 | ◎ 自然 | ○ 対応可能 |
| 学習効果 | ◎ 古典的原則 | ○ 最新パターン | ◎ 両方学べる |
| Rust/Cargo 親和性 | ◎ 高い | △ 課題あり | ◎ 高い |
| 変更の局所性 | △ 複数層 | ◎ スライス内 | ○ 中間 |

## 決定

**選択肢 3: ハイブリッドアプローチ**を採用する。

主な理由:
1. マルチテナント要件とテナント削除要件を安全に満たせる（横断的関心事の一元管理）
2. プロジェクト理念（学習効果の最大化）に合致（水平レイヤーと Vertical Slice 両方の考え方を学べる）
3. ADR-022 の方針と整合しており、既存の設計判断を活かせる

Vertical Slice を却下した理由:
- マルチテナント検証の重複が RingiFlow の要件と相性が悪い
- テナント削除時の漏れリスクが ADR-007 の「完全削除」要件と矛盾
- Cargo workspace での crate 分割粒度の問題

## 帰結

### 肯定的な影響

- マルチテナント検証、監査ログ、テナント削除処理を Infra 層に集約できる
- handlers をスライス志向で整理することで、機能追加時の見通しが良くなる
- Phase 4 の CQRS 導入時に、handlers を Command/Query に分割する土台ができる

### 否定的な影響・トレードオフ

- 純粋な Vertical Slice ほどスライスの独立性が高くない
- handlers 内の構造について、追加の設計判断が必要になる場合がある

### 関連ドキュメント

- 設計書: [02_プロジェクト構造設計.md](../02_基本設計書/02_プロジェクト構造設計.md)
- ADR: [ADR-007 テナント退会時のデータ削除方針](007_テナント退会時のデータ削除方針.md)
- ADR: [ADR-022 バックエンドサービスの命名規則と層構造の統一](022_バックエンドサービスの命名規則と層構造の統一.md)

---

## 変更履歴

| 日付 | 変更内容 |
|------|---------|
| 2026-01-25 | 初版作成 |
