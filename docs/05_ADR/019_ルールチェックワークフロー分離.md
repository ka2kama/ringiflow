# ADR-019: ルールチェックワークフロー分離

## ステータス

承認済み

## コンテキスト

Claude Auto Review ワークフローに以下の責務が集中していた:

1. バグ・正確性のチェック
2. セキュリティチェック
3. パフォーマンスチェック
4. 型システムの活用チェック
5. テストの有無チェック
6. 設計チェック
7. ルール準拠チェック（`.claude/rules/`）
8. 学習機会の提供

問題点:
- レビューの見落としがあるかどうかを判断できない
- 「何がチェックされたか」が不明確
- 1つのワークフローに責務が集中しすぎている

## 検討した選択肢

### 選択肢 1: 現状維持

1つのワークフローで全ての責務をカバーする。

評価:
- 利点: シンプルな構成、1回のAPI呼び出しで完結
- 欠点: 焦点がぼやける、見落としの検出が困難

### 選択肢 2: 並列実行で責務分離

ルールチェックを別ワークフローに分離し、CI 成功後に並列実行する。

```
CI Success
├─→ Claude Rules Check
└─→ Claude Auto Review
```

評価:
- 利点: 責務が明確、「チェック完了」が観測可能、実行時間が増えない
- 欠点: 管理するワークフローが増える、API呼び出しが2回

### 選択肢 3: 直列実行

ルールチェックを先に実行し、成功した場合のみコードレビューを実行する。

```
CI → Rules Check → Code Review
```

評価:
- 利点: ルール違反時にコードレビューをスキップできる（効率的）
- 欠点: 実行時間が増える、ルール違反時もコードの問題点は知りたい場合が多い

### 比較表

| 観点 | 選択肢 1 | 選択肢 2 | 選択肢 3 |
|------|---------|---------|---------|
| 観測可能性 | 低 | 高 | 高 |
| 実行時間 | 基準 | 同等 | 増加 |
| API コスト | 1回 | 2回 | 条件付き2回 |
| 実装の複雑さ | 低 | 低 | 中 |
| フィードバック | 混在 | 分離 | 分離 |

## 決定

**選択肢 2: 並列実行で責務分離** を採用する。

主な理由:
1. 「ルールチェック完了」「コードレビュー完了」が PR のステータスとして明確に分かる
2. 実行時間への影響が最小限（並列実行）
3. 片方が失敗しても、もう片方の結果は見れる

選択肢 1 を却下した理由:
- 「見落としがあるかどうか判断できない」という問題が解決しない

選択肢 3 を却下した理由:
- ルール違反があっても、コードの問題点は知りたいケースが多い
- 直列実行は待ち時間が増える

## 帰結

### 肯定的な影響

- PR に2つの独立したステータスが表示され、何がチェックされたか明確になる
- 問題発生時の切り分けが容易になる
- 将来的に片方だけ設定変更・無効化が可能

### 否定的な影響・トレードオフ

- 管理するワークフローファイルが増える（1 → 2）
- API 呼び出しが2回になる（コスト増）
- 両ワークフローが同じ PR に対してコメントするため、通知が増える可能性

### 関連ドキュメント

- 手順書: [GitHub 設定](../04_手順書/02_プロジェクト構築/03_GitHub設定.md)
- ワークフロー: `.github/workflows/claude-rules-check.yaml`, `.github/workflows/claude-auto-review.yaml`

---

## 変更履歴

| 日付 | 変更内容 |
|------|---------|
| 2026-01-19 | 初版作成 |
