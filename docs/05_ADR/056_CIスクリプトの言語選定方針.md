# ADR-056: CI スクリプトの言語選定方針

## ステータス

承認済み

## コンテキスト

#813 で `.github/scripts/match-rules.py`（177行、Python）を導入した。これはプロジェクト初の Python スクリプトであり、glob パターンの正規表現変換（`glob_to_regex`）を含む複雑なロジックを持つ。

プロジェクトの技術スタックは Rust + Elm であり、Shell と Python はいずれも好みの言語ではない。ADR-015（開発スクリプトの品質担保方針）の将来の移行基準に「スクリプトに複雑なロジック（正規表現パース、条件分岐が多い等）が必要になった場合、rust-script または dev-tools クレートへの移行を検討する」と明記されていた。

`match-rules.py` は正規表現パースを含むため、この移行基準に該当する。

## 検討した選択肢

### 選択肢 1: Shell に統一

既存の 24 個のシェルスクリプトと一貫性を保つ。

評価:
- 利点: 既存スクリプトと一貫、依存追加なし
- 欠点: POSIX regex では非キャプチャグループが使えず、glob-to-regex 変換が複雑化。可読性・保守性が低下

### 選択肢 2: Python を許容

Python スクリプトをそのまま維持し、CI スクリプトでの Python 使用を許容する。

評価:
- 利点: 既に動作する実装がある、変更不要
- 欠点: プロジェクトの技術スタック外の言語を許容する前例を作る

### 選択肢 3: rust-script で Rust に移行

ADR-015 が明示した移行先である `rust-script` を使用し、単一ファイルの Rust スクリプトとして書き直す。

評価:
- 利点: プロジェクトの技術スタックと一致、ADR-015 の移行パスに合致、`globset` クレートにより glob-to-regex 変換が不要、型安全
- 欠点: CI に `rust-script` のインストールが必要、初回コンパイル時間

### 選択肢 4: ワークスペースクレートとして Rust 化

`backend/tools/match-rules/` にワークスペースメンバーとして配置する。

評価:
- 利点: 標準的な Rust プロジェクト構造、ワークスペース依存管理
- 欠点: ~80行のスクリプトに対してプロジェクト構造が過剰（KISS に反する）

### 比較表

| 観点 | Shell 統一 | Python 許容 | rust-script | ワークスペースクレート |
|------|----------|-----------|-------------|-----------------|
| 技術スタック一致 | - | × | ◎ | ◎ |
| ADR-015 整合 | × | × | ◎ | ○ |
| KISS | × | ◎ | ◎ | △ |
| 保守性 | 低 | 中 | 高 | 高 |
| 追加依存 | なし | なし | rust-script | なし |

## 決定

**選択肢 3: rust-script で Rust に移行** を採用する。

主な理由:

1. **ADR-015 の移行基準に該当**: 正規表現パースを含む複雑なロジックが必要になった時点で、ADR-015 が定めた移行基準に合致する。ADR-015 が移行先として rust-script を明示していた
2. **技術スタックとの一致**: Rust はプロジェクトのプライマリ言語であり、新たな言語（Python）の導入を避けられる
3. **globset による簡素化**: Python 版の手動 glob-to-regex 変換（~40行）が `globset` クレートのネイティブ glob マッチングで不要になり、コードが大幅に簡潔になる（177行 → ~100行）
4. **KISS**: 単一ファイルスクリプトとして `.github/scripts/match-rules.rs` に配置。ワークスペースクレートの構造は不要

選択肢 4（ワークスペースクレート）を却下した理由: ~80行のスクリプトに対して Cargo.toml + src/ 構造は過剰。KISS 原則に反する。

### 将来の移行パス

`cargo script`（RFC 3424）が安定化（Rust 1.94-1.95 見込み）された場合、`rust-script`（外部ツール）から `cargo` の組み込み機能に移行でき、追加ツールのインストールが不要になる。

## 帰結

### 肯定的な影響

- プロジェクトの技術スタックと一致する言語で CI スクリプトが書かれる
- `globset` によりパターンマッチングの正確性が向上（手動正規表現変換のバグリスクを排除）
- ADR-015 の移行パスが初めて実際に適用され、方針の有効性が確認された

### 否定的な影響・トレードオフ

- CI ワークフロー（`claude-rules-check.yaml`）に Rust ツールチェインのセットアップが必要になる（初回 ~1-2分、キャッシュ後は数秒）
- `rust-script` という外部ツールへの依存が追加される（将来 cargo script で解消見込み）

### 適用ルール

| スコープ | 言語 | 根拠 |
|---------|------|------|
| `scripts/` | Shell（デフォルト）/ Rust（rust-script） | シンプルなスクリプトは Shell、ADR-015 の移行基準に該当する場合は rust-script |
| `.github/scripts/` | Rust（rust-script）| 技術スタック一致、複雑なロジックに適する |
| ワークフロー内のインライン `run` | Shell | ワークフロー YAML 内は Shell が自然 |

複雑なロジックを伴わないシンプルなスクリプトは、引き続き Shell で書いてもよい。

### 関連ドキュメント

- Issue: #815, #813, #841
- ADR: [ADR-015: 開発スクリプトの品質担保方針](015_開発スクリプトの品質担保方針.md)
- ワークフロー: `.github/workflows/claude-rules-check.yaml`
- スクリプト: `.github/scripts/match-rules.rs`, `scripts/check/instrumentation.rs`

---

## 変更履歴

| 日付 | 変更内容 |
|------|---------|
| 2026-02-23 | `scripts/` スコープで rust-script を許容するよう拡大（#841） |
| 2026-02-23 | 初版作成 |
