# ADR-046: Story-per-PR ブランチ戦略

## ステータス

承認済み

## コンテキスト

Phase 2-2（#403）で Epic 全体を 1 PR（#426）にまとめた結果、以下の問題が発生した:

- レビュータイミングの遅延: 全 Story 完了後に一括レビュー。フィードバックが遅く、手戻りの範囲が大きい
- サブ Issue のクローズ漏れ: PR 本文に `Closes #403` のみ記載し、サブ Issue（#427〜#432）が OPEN のまま残った
- PR の巨大化: レビュー品質の低下

手順書の Epic/Story 運用フローは「Story ごとに実装 → クローズ」を想定しているが、実際の運用では Epic 全体を 1 feature ブランチで扱っていた。手順とプラクティスの乖離がプロセスギャップとなっていた。

制約条件:
- 個人開発プロジェクトであり、並行作業によるコンフリクトは発生しない
- DB マイグレーションは後方互換（Expand/Contract パターン）が運用設計書で MUST（OPS-06 10.5）
- GitHub Flow を基本戦略として採用済み（ADR-012）

## 検討した選択肢

### 選択肢 1: GitHub Flow + Story-per-PR

各 Story を個別 PR で main にマージする。Integration branch（develop 等）は使用しない。

評価:
- 利点: 1 PR = 1 Story = 1 `Closes` で Issue が自然にクローズされる。レビュー粒度が小さく、フィードバックが早期化。PR サイズが適切でレビュー品質が高い
- 欠点: Story 分解の品質が重要になる（各 Story が独立して main にマージ可能でなければならない）

### 選択肢 2: GitHub Flow + Epic-per-PR（現状）

Epic 全体を 1 feature ブランチで開発し、1 PR でまとめてマージする。

評価:
- 利点: ブランチ管理がシンプル（1 Epic = 1 ブランチ）。Story 間の依存を気にしなくてよい
- 欠点: PR が巨大化しレビュー品質が低下する。サブ Issue のクローズに `Closes` を複数列挙する必要があり、漏れやすい。フィードバックが全 Story 完了後になる

### 選択肢 3: Git Flow（develop ブランチ活用）

develop ブランチで Story を統合し、リリース時に main にマージする。

評価:
- 利点: 統合テストの場が明確。複数人チームでのリリース管理に適している
- 欠点: 個人開発では develop ブランチの統合テストの必要性が低い。ブランチ管理の複雑さが増す。CI 設定が複雑になる

### 比較表

| 観点 | Story-per-PR | Epic-per-PR | Git Flow |
|------|-------------|-------------|----------|
| PR サイズ | 小（Story 単位） | 大（Epic 全体） | 中〜大 |
| レビュー品質 | 高 | 低 | 中 |
| フィードバック速度 | 早い（Story 毎） | 遅い（Epic 完了後） | 中 |
| Issue 自動クローズ | 自然（1:1） | 不自然（1:N） | 中 |
| Story 分解の品質要求 | 高 | 低 | 中 |
| ブランチ管理の複雑さ | 低 | 低 | 高 |
| 個人開発との適合 | 高 | 中 | 低 |

## 決定

選択肢 1: GitHub Flow + Story-per-PR を採用する。

理由:
1. 1 PR = 1 Story = 1 `Closes` の対応関係により、Issue クローズ漏れを構造的に防止できる
2. PR サイズが適切になり、AI レビュー（Claude Code Action）の品質が向上する
3. Story 分解の品質基準を設けることで、設計力の向上にも寄与する（学習効果）

原則: Story が main に独立してマージできないなら、Story の分解が不十分である。

## 帰結

### 肯定的な影響

- レビュー粒度の適正化によるフィードバックの早期化
- Issue ライフサイクルと PR ライフサイクルの 1:1 対応
- Story 分解スキルの向上（独立動作・後方互換の検証が設計力を鍛える）

### 否定的な影響・トレードオフ

- Story 分解時に「独立して main にマージ可能か」を検証する工数が増える
- Story 間で共有する内部 API 変更がある場合、先行 Story で準備が必要

### 関連ドキュメント

- 設計書: [運用設計書 10.2 ブランチ戦略](../02_基本設計書/04_運用設計.md#102-ブランチ戦略)
- 手順書: [Issue 駆動開発 > Epic / Story 運用](../04_手順書/04_開発フロー/01_Issue駆動開発.md#epic--story-運用)
- 関連 ADR: [ADR-012 Issue 駆動開発の採用](012_Issue駆動開発の採用.md)、[ADR-013 Draft PR 運用の導入](013_Draft_PR運用の導入.md)
- 改善記録: [Epic 単位 PR によるサブ Issue クローズ漏れ](../../prompts/improvements/2026-02/2026-02-11_2200_Epic単位PRによるサブIssueクローズ漏れ.md)

---

## 変更履歴

| 日付 | 変更内容 |
|------|---------|
| 2026-02-11 | 初版作成 |
