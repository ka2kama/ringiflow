# ADR-047: Lightsail の IPv6-only からデュアルスタックへの切り替え

## ステータス

承認済み

## コンテキスト

[ADR-030](030_Lightsail個人環境の構築.md) で構築した Lightsail インスタンスは、コスト最小化のため IPv6-only プラン（$5/月）を選択した。しかし、運用を通じて以下の問題が顕在化した:

1. **Docker コンテナからインターネットに出られない**: Docker のデフォルトブリッジネットワークは IPv4 のみで動作するため、コンテナ内から外部通信ができない。`cargo install`、`npm install` 等のパッケージ取得が失敗する
2. **SCP での IPv6 アドレスの取り扱い**: SCP はコロン（`:`）をホスト/パス区切りに使うため、IPv6 アドレスと衝突する。角括弧での囲みが必要で、さらに zsh ではグロブ展開を防ぐクォートも必要
3. **deploy.sh での `SSH_TARGET` / `SCP_TARGET` 分離**: 上記の SCP 問題に対処するため、SSH 用と SCP 用でターゲット変数を分離するワークアラウンドが必要

これらは IPv6-only 環境固有の問題であり、IPv4 が使えれば発生しない。

## 検討した選択肢

### 選択肢 1: 現状維持（IPv6-only, $5/月）

ワークアラウンドで対処し続ける。

評価:
- 利点:
  - コストが最小（$5/月）
  - 既に動作している
- 欠点:
  - Docker コンテナから外部通信不可の制約が残る（sqlx-cli のインストール等に影響）
  - デプロイスクリプトにワークアラウンドが残り続ける
  - IPv6 固有の問題に遭遇するたびに対処が必要

### 選択肢 2: デュアルスタックに切り替え（$7/月）

Lightsail コンソールで IPv6-only からデュアルスタックに変更し、静的 IPv4 アドレスをアタッチする。

評価:
- 利点:
  - Docker コンテナから外部通信可能になる
  - SCP/SSH のアドレス処理が統一される
  - デプロイスクリプトが簡略化される
  - 標準的な運用方法が使える
- 欠点:
  - 月額 $2 増（$5 → $7）

### 選択肢 3: インスタンス再作成（IPv4 のみ）

IPv4 のみの新インスタンスを作成し、環境を移行する。

評価:
- 利点:
  - シンプルな構成
  - IPv6 関連の知識が不要
- 欠点:
  - 環境の再構築が必要
  - IPv6 の学びを捨てることになる
  - IPv6 対応は今後ますます重要になる

### 比較表

| 観点 | 現状維持 | デュアルスタック | インスタンス再作成 |
|------|---------|----------------|------------------|
| 月額コスト | $5 | $7 | $5-7 |
| Docker 外部通信 | 不可 | 可 | 可 |
| スクリプト複雑さ | 高 | 低 | 低 |
| 移行コスト | なし | 最小（設定変更のみ） | 高（再構築） |
| IPv6 の学び | 維持 | 維持 | 喪失 |

## 決定

**選択肢 2: デュアルスタックに切り替え** を採用する。

主な理由:

1. **コスト対効果**: 月額 $2 の追加で、3つの問題がすべて解消される
2. **移行コスト最小**: インスタンスの再作成不要。AWS コンソールでの設定変更 + 静的 IP アタッチで完了
3. **IPv6 の学びを保持**: デュアルスタックなので IPv6 の知識も引き続き活用できる

選択肢 1 を却下した理由: $2/月の節約のためにワークアラウンドを維持し続ける合理性がない
選択肢 3 を却下した理由: 環境再構築のコストが不相応に高く、IPv6 の学びも失われる

## 帰結

### 肯定的な影響

- Docker コンテナから外部パッケージのインストールが可能に（sqlx-cli 等）
- デプロイスクリプト（`deploy.sh`）の `SCP_TARGET` 分岐が不要になり、コードが簡略化される
- SCP/SSH のアドレス処理で IPv6 固有の注意が不要になる
- マイグレーション方法として sqlx-cli を標準的に使用可能に

### 否定的な影響・トレードオフ

- 月額コストが $2 増加（$5 → $7）

### 関連ドキュメント

- 設計書: なし（インフラ運用の変更）
- 実装:
  - `infra/lightsail/deploy.sh` — IPv6 ワークアラウンドの簡略化
  - `infra/lightsail/README.md` — コスト・手順の更新
  - `docs/06_ナレッジベース/infra/IPv6-only環境でのDocker運用.md` — アーカイブ注記追加

---

## 変更履歴

| 日付 | 変更内容 |
|------|---------|
| 2026-02-14 | 初版作成 |
