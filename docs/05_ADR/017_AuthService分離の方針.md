# ADR-017: Auth Service 分離の方針

## ステータス

承認済み

## コンテキスト

### 現状

RingiFlow の認証機能は現在、以下のように BFF と Core API に分散している：

| コンポーネント | 責務 |
|---------------|------|
| BFF | セッション管理、Cookie、CSRF 防御、IdP との OIDC 連携 |
| Core API | パスワード検証（`/internal/auth/verify`）、ユーザー情報管理 |

### 課題

1. **責務の分散**
   - 認証に関する責務が BFF と Core API に分散しており、将来の拡張時に責務境界が曖昧になるリスクがある

2. **将来の認証要件の複雑さ**
   - 要件定義書で以下が「必須」として定義されている：
     - AUTH-002: SSO（SAML 2.0）
     - AUTH-003: SSO（OIDC）
     - AUTH-004: MFA（TOTP/SMS）
   - これらを Core API に追加すると、Core API の責務が肥大化する

3. **プロジェクト理念との整合**
   - 本プロジェクトは「学習効果の最大化」を理念として掲げている
   - 認証基盤を自前で設計・実装することは、セキュリティとマイクロサービス設計の深い理解につながる

### 制約

- 上流アーキテクチャの変更は後からのコストが高い
- セキュリティ要件を満たす必要がある（セキュリティ監査で重大な脆弱性が検出されないこと）
- YAGNI を尊重しつつも、「なんとかなれ精神」ではなく計画的に進める

## 検討した選択肢

### 選択肢 1: 現状維持（Core API に認証ロジックを含める）

Core API 内に認証ロジックを保持し続ける。

評価:
- 利点:
  - シンプルな構成、運用コスト低
  - サービス間通信のオーバーヘッドなし
- 欠点:
  - Core API の責務が肥大化するリスク
  - SSO/MFA 追加時に Core API が複雑化
  - 責務境界が曖昧

### 選択肢 2: Auth Service として分離

認証専用のマイクロサービスを作成し、Core API から認証ロジックを分離する。

評価:
- 利点:
  - 認証ドメインの独立したスケーリング
  - セキュリティ監査の範囲を限定できる
  - マイクロサービス設計の学習効果が高い
  - 将来の SSO/MFA/SCIM 対応が容易
- 欠点:
  - サービス間通信の複雑化
  - 運用コスト増（デプロイ、監視、障害対応）
  - 初期実装コストが高い

### 選択肢 3: 外部 IdP（Auth0, Cognito 等）を採用

認証機能を外部サービスに委譲する。

評価:
- 利点:
  - SSO/MFA/SCIM が即座に利用可能
  - セキュリティのベストプラクティスが組み込み済み
  - 運用負荷を外部に委譲できる
- 欠点:
  - ベンダーロックイン
  - コスト（ユーザー数課金）
  - 学習効果が低い（プロジェクト理念に反する）
  - カスタマイズの制限

### 比較表

| 観点 | 選択肢 1: 現状維持 | 選択肢 2: Auth Service | 選択肢 3: 外部 IdP |
|------|-------------------|----------------------|-------------------|
| 学習効果 | 中 | **高** | 低 |
| 品質・保守性 | 中（責務分散） | **高**（責務明確） | 高 |
| SSO 実装コスト | 非常に高 | 高 | **低** |
| 運用コスト | **低** | 中 | 低 |
| セキュリティリスク | 高 | 中 | **低** |
| 将来の変更容易性 | 困難 | **容易** | 容易 |
| プロジェクト理念整合 | 中 | **高** | 低 |

## 決定

**選択肢 2: Auth Service として分離** を採用する。

### 主な理由

1. **プロジェクト理念との整合**
   - 「学習効果の最大化」という理念に最も合致する
   - マイクロサービス設計、認証ドメインの深い理解が得られる

2. **将来の拡張性**
   - SSO（OIDC/SAML）、MFA、SCIM といった複雑な認証要件を、独立したサービスとして管理できる
   - Core API の責務を明確に保てる

3. **上流アーキテクチャとしての安定性**
   - 認証は後から構造を変えにくい領域であり、最初から分離しておくことで将来の変更コストを抑える

### 却下理由

- **選択肢 1（現状維持）**: 将来の SSO/MFA 対応時に Core API が複雑化するリスクが高い
- **選択肢 3（外部 IdP）**: 学習効果が低く、プロジェクト理念に反する

## 段階的ロードマップ

一度にすべてを実装するのではなく、段階的に進める：

### Phase 2: Auth Service 分離（次のステップ）

現在 Core API にある認証ロジックを Auth Service として分離する。

**スコープ:**
- メール/パスワード認証
- セッション検証の委譲
- ユーザー認証情報の管理

**学習ポイント:**
- サービス間通信の設計
- 認証専用 API の設計
- データ分離の判断

### Phase 3: MFA 対応

TOTP（Google Authenticator 等）による多要素認証を実装する。

**スコープ:**
- TOTP シークレット管理
- QR コード生成
- 検証フロー

**学習ポイント:**
- TOTP アルゴリズム（RFC 6238）
- リカバリコードの設計

### Phase 4: SSO 対応（OIDC）

外部 IdP との OIDC 連携を実装する。

**スコープ:**
- OIDC 認可コードフロー + PKCE
- トークン検証
- ユーザープロビジョニング（JIT）

**学習ポイント:**
- OAuth 2.0 / OIDC の内部動作
- IdP メタデータの解析

### Phase 5: SSO 対応（SAML 2.0）と SCIM

**判断ポイント:** この Phase では以下を再評価する：

| 選択肢 | 説明 |
|--------|------|
| A: フル自前実装 | XML 署名検証等を自前で実装（学習効果最大、リスク高） |
| B: ライブラリ活用 | Rust の SAML/SCIM ライブラリを活用（実用性とのバランス） |

SAML 2.0 は実装が非常に複雑であり、セキュリティ脆弱性を作りやすい。この Phase に入る時点で、学習効果とセキュリティリスクのトレードオフを再評価する。

## 帰結

### 肯定的な影響

- 認証ドメインの深い理解が得られる
- マイクロサービス設計の実践経験
- 将来の SSO/MFA/SCIM 対応が容易になる
- Core API の責務が明確になる

### 否定的な影響・トレードオフ

- サービス間通信のオーバーヘッドが発生する
- 運用対象のサービスが増える
- 初期実装コストが高い
- 自前実装によるセキュリティリスク（特に Phase 5）

### 今後必要になる作業

1. Auth Service の設計（API、データモデル、サービス間通信）
2. 既存の認証ロジック（Core API）の移行計画
3. 基本設計書の更新（アーキテクチャ図の修正）
4. Phase 2 の Issue 作成

### 関連ドキュメント

- 要件定義書: [01_コア要件.md - 4.1 認証・認可機能](../01_要件定義書/01_コア要件.md)
- 基本設計書: [01_アーキテクチャ設計.md](../02_基本設計書/01_アーキテクチャ設計.md)
- 技術ノート: [BFFパターン.md](../06_技術ノート/BFFパターン.md)

---

## 変更履歴

| 日付 | 変更内容 |
|------|---------|
| 2026-01-18 | 初版作成 |
