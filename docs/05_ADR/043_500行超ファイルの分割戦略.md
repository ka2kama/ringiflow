# ADR-043: 500行超ファイルの分割戦略

## ステータス

承認済み

## コンテキスト

Issue #290 で、プロジェクトのファイルサイズ閾値 500 行（`.claude/rules/structural-review.md`）を超過するファイルのリファクタリングが提起された。

Issue 作成時点で 5 つの Backend ファイルと 2 つの Frontend ファイルが対象として記載されていた。その後、ADR-039（ドメインモジュール分割）と ADR-041（CoreServiceClient サブトレイト分割）により Backend 3 ファイルの分割が完了し、状況が大きく変化した。

本 ADR は残りのファイルについて、structural-review.md の判断プロセス（行数超過 → 責務分析 → 分割 or 例外許容）に基づき、対応方針を確定する。

### 分析: プロダクションコード vs テストコードの分離

行数超過の原因を正確に把握するため、`#[cfg(test)]` / テストモジュールの開始位置を特定し、プロダクションコードとテストコードの比率を調査した。

**Issue 記載ファイル（Backend）:**

| ファイル | 合計 | prod | test | 状態 |
|---------|------|------|------|------|
| `core-service/usecase/workflow.rs` | 119 | — | — | 完了（ADR-039, CQRS 分割） |
| `domain/src/workflow.rs` | 43 | — | — | 完了（ADR-039, エンティティ分割） |
| `bff/client/core_service.rs` | 30 | — | — | 完了（ADR-041, ISP 分割） |
| `bff/handler/auth.rs` | 985 | 442 | 543 | prod < 500 |
| `core-service/usecase/task.rs` | 1042 | 225 | 817 | 例外（ADR-041 で判断済み） |

**Issue 記載ファイル（Frontend）:**

| ファイル | 合計 | 判定 |
|---------|------|------|
| `Page/Workflow/New.elm` | 1115 | 複合責務（分割検討対象） |
| `Main.elm` | 832 | アーキテクチャパターンの帰結 |

**Issue 未記載で閾値超過のファイル:**

| ファイル | 合計 | prod | test | 判定 |
|---------|------|------|------|------|
| `core-service/handler/workflow.rs` | 780 | 780 | 0 | 全てプロダクションコード |
| `bff/handler/workflow.rs` | 754 | 754 | 0 | 全てプロダクションコード |
| `domain/value_objects.rs` | 650 | 437 | 213 | prod < 500 |

## 検討した選択肢

### 対象 1: handler/workflow.rs（core-service: 780行 / bff: 754行）

テストを含まず全行がプロダクションコードであり、分割の必要性が最も高い。

#### 選択肢 A: CQRS パターンで分割（command.rs / query.rs）

usecase 層の分割（ADR-039）と同じ軸で、ハンドラを読み取り系と状態変更系に分離する。

評価:
- 利点: usecase 層と分割軸が一致し、レイヤー間の構造的対応が明確になる。既にプロジェクトで確立されたパターン
- 欠点: ハンドラの引数パターン（AppState 抽出子など）が両ファイルで重複する可能性

#### 選択肢 B: エンドポイントグループ別に分割

`definition.rs`（定義関連）、`instance.rs`（インスタンス関連）、`step.rs`（ステップ関連）のようにエンティティ単位で分離する。

評価:
- 利点: domain 層のエンティティ分割（ADR-039）と対応する
- 欠点: エンティティ間の関連が密な操作（例: インスタンス操作がステップも返す）で境界が曖昧

#### 選択肢 C: 現状維持

評価:
- 利点: 変更リスクゼロ
- 欠点: 780行/754行はすべてプロダクションコードであり、閾値を大きく超過。テストによる膨張とは異なり、責務の混在が原因

#### 比較表

| 観点 | 選択肢 A (CQRS) | 選択肢 B (エンティティ) | 選択肢 C (現状維持) |
|------|----------------|----------------------|-------------------|
| 既存パターンとの一貫性 | usecase 層と一致 | domain 層と一致 | — |
| 分割の明確さ | 高（読み取り/変更は明確） | 中（境界が曖昧なケースあり） | — |
| ファイル数 | 2 + 親 = 3 | 3 + 親 = 4 | 1 |
| 機械的な適用可能性 | 高（HTTP メソッドで判定可能） | 中（共通的な操作の帰属に判断が必要） | — |

### 対象 2: Page/Workflow/New.elm（1115行）

ADR-041 では「TEA パターンの典型的ページ → 例外として許容（要検討）」としていたが、改めて責務分析した結果、複合責務の混在を確認した。

ファイル内に独立性の高い UI コンポーネント（承認者選択ドロップダウン）が埋め込まれており、コンポーネント抽出の対象となる。

#### 選択肢 A: ApproverSelector コンポーネント抽出

承認者選択の状態管理と UI を `Component/ApproverSelector.elm` として抽出する。

評価:
- 利点: 責務が明確に分離される。TEA の標準的なコンポーネント化パターン。抽出対象の入出力が明確
- 欠点: ~180行の削減にとどまり、New.elm は ~935行で閾値付近に残る

#### 選択肢 B: Nested TEA で複数サブモジュールに分割

ページ内を DefinitionSelector、ApproverSelector、FormSubmit の 3 つの Nested TEA コンポーネントに分割する。

評価:
- 利点: New.elm を大幅に削減できる（~400行程度に）
- 欠点: Elm の Nested TEA は型のバケツリレーが複雑になる。Page が既に Nested TEA の単位であり、さらに細分化するとボイラープレートが増加

#### 選択肢 C: 現状維持（例外許容）

評価:
- 利点: 変更リスクゼロ
- 欠点: 1115行は閾値の 2 倍以上。複合責務の混在が解消されない

#### 比較表

| 観点 | 選択肢 A (Component) | 選択肢 B (Nested TEA) | 選択肢 C (現状維持) |
|------|---------------------|----------------------|-------------------|
| 削減効果 | ~180行 → ~935行 | ~700行 → ~400行 | なし |
| 実装難度 | 低（入出力が明確） | 高（型のバケツリレー） | なし |
| 既存パターンとの一致 | Component/ に Button 等の先例あり | 前例なし | — |
| 段階的拡張 | B への足がかりになる | — | — |

### 例外許容の判断

#### bff/handler/auth.rs（985行 = prod 442 + test 543）

プロダクションコードが 442 行で閾値未満。4 つのエンドポイント（login, logout, me, csrf）はすべて認証関連で高凝集。ADR-041 の ISP 分割によりテストスタブが削減され、985行まで縮小済み。

判断: **例外として許容**（task.rs と同じ判定パターン: prod < 500 + 高凝集）

#### domain/value_objects.rs（650行 = prod 437 + test 213）

プロダクションコードが 437 行で閾値未満。複数の値オブジェクト型（Version, DisplayNumber, DisplayId 等）を集約するファイルだが、各型は独立しており、他のファイルに分散させるとインポートパスが煩雑になる。

判断: **例外として許容**（prod < 500 + 値オブジェクト集約は凝集度が高い）

#### Main.elm（832行）

Elm の SPA エントリポイント。Nested TEA パターンにより、ページ状態の管理・Msg ルーティング・subscriptions の一元管理が不可避。分割すると全ページの型情報を参照する必要から循環依存が発生する。

判断: **例外として許容**（ADR-041 と同じ判断。アーキテクチャパターンの帰結）

## 決定

### 分割対象

| ファイル | 分割方法 | 理由 |
|---------|---------|------|
| core-service/handler/workflow.rs (780行) | CQRS 分割（選択肢 A） | usecase 層と分割軸を統一、明確な判定基準 |
| bff/handler/workflow.rs (754行) | CQRS 分割（選択肢 A） | 同上、core-service と同じパターンを適用 |
| Page/Workflow/New.elm (1115行) | Component 抽出（選択肢 A） | 最小限の変更で責務を分離、段階的拡張の足がかり |

**Backend handler の CQRS 分割**を選択した理由:

1. usecase 層で既に確立された分割軸（ADR-039）を handler 層にも統一適用することで、レイヤー間の構造的対応が明確になる
2. HTTP メソッドで機械的に判定可能（GET = query、POST/PUT/PATCH/DELETE = command）であり、境界が曖昧にならない
3. エンティティ別分割（選択肢 B）はドメインエンティティ間の関連が密な操作で帰属判断が必要となる

**Frontend の Component 抽出**を選択した理由:

1. ApproverSelector は入出力が明確な独立コンポーネントであり、抽出の難易度が低い
2. Nested TEA の深い階層化（選択肢 B）は Elm の型システムでボイラープレートが増大する
3. Component/ ディレクトリに Button, LoadingSpinner 等の先例があり、パターンが確立されている

### 例外許容

| ファイル | prod行数 | 理由 |
|---------|---------|------|
| bff/handler/auth.rs | 442 | prod < 500、認証関連で高凝集 |
| core-service/usecase/task.rs | 225 | prod < 500（ADR-041 で判断済み） |
| domain/value_objects.rs | 437 | prod < 500、値オブジェクト集約 |
| Main.elm | 832 | TEA + Nested TEA ルーターの帰結 |

### 実施優先順位

| 順位 | ファイル | 理由 |
|------|---------|------|
| 1 | core-service/handler/workflow.rs | 最大のプロダクションコード超過（780行全て prod） |
| 2 | bff/handler/workflow.rs | 同上パターンの適用（754行全て prod） |
| 3 | Page/Workflow/New.elm | 複合責務の分離（1115行） |

## 帰結

### 肯定的な影響

- Issue #290 の全ファイルについて、分割 vs 例外許容の判断が確定し、後続作業の見通しが立つ
- CQRS 分割を handler 層にも統一適用することで、usecase 層との構造的対応が明確になる
- 例外許容の基準（prod < 500 + 高凝集）が確立され、今後の判断に一貫性をもたらす

### 否定的な影響・トレードオフ

- 例外許容としたファイルが今後のコード追加でさらに肥大化する可能性がある（定期的な再評価が必要）
- New.elm は Component 抽出後も ~935行で閾値付近に残る。追加の分割が必要になる可能性がある

### 関連ドキュメント

- Issue: [#290](https://github.com/ka2kama/ringiflow/issues/290)（Refactor oversized files）
- 先行 ADR: [ADR-039](039_ワークフローモジュールの分割方針.md)（ドメインモジュール分割）
- 先行 ADR: [ADR-041](041_CoreServiceClientのサブトレイト分割.md)（CoreServiceClient サブトレイト分割）
- 構造レビュー: `.claude/rules/structural-review.md`

---

## 変更履歴

| 日付 | 変更内容 |
|------|---------|
| 2026-02-10 | 初版作成 |
