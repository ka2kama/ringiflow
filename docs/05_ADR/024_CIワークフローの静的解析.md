# ADR-024: CI ワークフローの静的解析

## ステータス

承認済み

## コンテキスト

GitHub Actions ワークフロー（`.github/workflows/*.yaml`）の品質を担保する仕組みが必要になった。

課題：
- YAML の構文エラーが CI 実行時まで検出されない
- `run:` ブロック内のシェルスクリプトが shellcheck の対象外
- 未定義の変数参照やセキュリティ問題を事前に検出したい

関連：[ADR-015: 開発スクリプトの品質担保方針](015_開発スクリプトの品質担保方針.md) で shellcheck を導入済み。

## 検討した選択肢

### 選択肢 1: actionlint（curl でダウンロード + just タスク）

actionlint を curl でダウンロードし、`just lint-ci` タスクで実行する。

評価：
- 利点：シンプル、依存が少ない、確実に動作する
- 欠点：ダウンロード時間がかかる（数秒）

### 選択肢 2: reviewdog/action-actionlint

reviewdog と統合された GitHub Action。PR にインラインコメントを付与できる。

評価：
- 利点：PR レビュー体験の向上、バージョン管理が容易
- 欠点：startup_failure が発生し動作しなかった（原因不明）

### 選択肢 3: actionlint のみ（ローカル専用）

ローカル開発でのみ actionlint を使用し、CI では実行しない。

評価：
- 利点：CI の設定がシンプル
- 欠点：CI での自動チェックがない、漏れが発生しやすい

### 比較表

| 観点 | curl + just | reviewdog/action-actionlint | ローカル専用 |
|------|-------------|---------------------------|-------------|
| 動作の安定性 | ◎ | × (startup_failure) | - |
| セットアップの簡易さ | ○ | ◎ | ◎ |
| CI での自動チェック | ◎ | ◎ | × |
| ローカルとの一貫性 | ◎ | △ | ○ |

## 決定

選択肢 1「actionlint（curl でダウンロード + just タスク）」を採用する。

理由：
1. reviewdog/action-actionlint は startup_failure が発生し、原因を特定できなかった
2. curl + just 方式は依存が少なく確実に動作する
3. ローカルと CI で同じ `just lint-ci` コマンドを使えるため一貫性がある

### 実装方針

```yaml
# CI での実行
- name: Install actionlint
  run: |
    bash <(curl -sSL https://raw.githubusercontent.com/rhysd/actionlint/main/scripts/download-actionlint.bash)
    sudo mv actionlint /usr/local/bin/
- name: Lint GitHub Actions
  run: just lint-ci
```

```just
# justfile
lint-ci:
    actionlint
```

## 帰結

### 肯定的な影響

- GitHub Actions ワークフローの構文エラーを早期に検出できる
- `run:` ブロック内のシェルスクリプトも shellcheck でチェックされる
- `just lint` でローカルでも CI でも同じチェックが実行される

### 否定的な影響・トレードオフ

- ローカル開発者は actionlint のインストールが必要
- CI での actionlint ダウンロードに数秒かかる（キャッシュ不可）

### reviewdog/action-actionlint の startup_failure について

本 ADR 作成時点で、このリポジトリで reviewdog/action-actionlint@v1 を使用すると startup_failure が発生した。最小設定（オプションなし）でも同様。原因は特定できなかったが、以下の可能性が考えられる：

- action の依存解決の問題
- GitHub Actions ランナー環境との相性
- 一時的なインフラの問題

将来的に再検討する場合は、この問題が解決しているか確認すること。

### 関連ドキュメント

- 設計書：なし
- 実装：`.github/workflows/ci.yaml`、`justfile`
- 手順書：[開発環境構築](../04_手順書/01_開発参画/01_開発環境構築.md)

---

## 変更履歴

| 日付 | 変更内容 |
|------|---------|
| 2026-01-26 | 初版作成 |
