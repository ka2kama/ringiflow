# ADR-035: コードカバレッジ計測ツール選定

## ステータス

承認済み

## コンテキスト

テストカバレッジの現状を定量的に把握し、改善の指針とするために、Rust コードのカバレッジ計測ツールを導入する必要がある。

要件:
- Rust workspace 全体のカバレッジを計測できる
- HTML レポートおよびターミナル出力に対応
- 精度が高く、信頼性のある結果が得られる
- 将来の CI 統合が容易

## 検討した選択肢

### 選択肢 1: cargo-llvm-cov

Rust の `-C instrument-coverage` フラグ（LLVM ソースベースカバレッジ）を活用するツール。taiki-e がメンテナンス。

評価:
- 利点: LLVM ソースベースで精度が高い、クロスプラットフォーム対応、Rust 公式推奨の計測方式、活発なメンテナンス
- 欠点: `llvm-tools-preview` rustup component が必要

### 選択肢 2: cargo-tarpaulin

ptrace ベースのカバレッジ計測ツール。Linux のみ対応。

評価:
- 利点: 歴史が長く、知名度が高い、設定がシンプル
- 欠点: Linux のみ、ptrace ベースで精度が低い（複雑なコードで不正確）、ソースベースではなく行ベース

### 比較表

| 観点 | cargo-llvm-cov | cargo-tarpaulin |
|------|---------------|-----------------|
| 計測方式 | LLVM ソースベース | ptrace（Linux only） |
| 精度 | 高（ブランチ・リージョンレベル） | 中（行ベース、複雑なコードで不正確） |
| プラットフォーム | クロスプラットフォーム | Linux のみ |
| メンテナンス | taiki-e が活発にメンテナンス | 継続しているが LLVM ベースに比べ旧式 |
| Rust 公式との整合 | 公式推奨方式を使用 | 独自方式 |

## 決定

cargo-llvm-cov を採用する。

理由:
1. Rust 公式が推奨する LLVM ソースベースカバレッジを使用しており、精度が高い
2. クロスプラットフォーム対応で、将来の CI 環境にも柔軟に対応できる
3. 行ベースだけでなくリージョン（分岐）レベルのカバレッジも取得でき、より詳細な分析が可能

## 帰結

### 肯定的な影響

- 高精度なカバレッジ計測でテストの穴を正確に把握できる
- `just coverage` / `just coverage-summary` でワンコマンドで計測可能
- 将来 CI に統合する際もそのまま使える

### 否定的な影響・トレードオフ

- `llvm-tools-preview` rustup component の追加インストールが必要
- cargo-tarpaulin に比べ知名度がやや低い（ただし近年はこちらが主流になりつつある）

### 関連ドキュメント

- 実装: `justfile`（coverage タスク）
- 手順書: `docs/04_手順書/01_開発参画/01_開発環境構築.md`

---

## 変更履歴

| 日付 | 変更内容 |
|------|---------|
| 2026-02-08 | 初版作成（#291） |
