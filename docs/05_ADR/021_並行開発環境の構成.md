# ADR-021: 並行開発環境の構成

## ステータス

承認済み

## コンテキスト

複数のタスクを同時に進める必要がある場面が増えている:

- 複数の Claude Code セッションを並行して動かす
- 機能開発中にホットフィックスが必要になる
- 異なるブランチを IDE で同時に開いて比較する

通常の開発フローでは、ブランチ切り替えが必要になり作業が中断される。
また、Docker コンテナやデータベースが共有されているため、並行作業時にポートやデータが競合する問題がある。

## 検討した選択肢

### 選択肢 1: 複数クローン方式

リポジトリを複数回クローンして、それぞれで独立した作業を行う。

```bash
ghq get github.com/ka2kama/ringiflow --rename ringiflow-auth
```

評価:
- 利点: 設定不要で完全に独立
- 欠点: `.git` の重複によるディスク消費、リモート同期が煩雑

### 選択肢 2: git worktree + Docker Compose プロジェクト名

git worktree で作業ディレクトリを分離し、Docker Compose のプロジェクト名でコンテナを分離する。

```bash
git worktree add ../ringiflow-auth feature/auth
docker compose -p ringiflow-auth up -d
```

評価:
- 利点: Git 公式機能で安定、ディスク効率が良い、コンテナ・ボリュームも自動分離
- 欠点: ポートの手動管理が必要（→ 自動化で解決可能）

### 選択肢 3: Docker / Dev Container

各作業環境を Docker コンテナ内で完全に隔離する。

評価:
- 利点: 最も隔離度が高い
- 欠点: オーバーヘッドが大きい、IDE 連携が複雑

### 比較表

| 観点 | 複数クローン | worktree + Compose | Dev Container |
|------|-------------|-------------------|---------------|
| ディスク効率 | × 低い | ○ 高い | △ 中程度 |
| セットアップ | ○ 簡単 | ○ 簡単 | × 複雑 |
| 隔離度 | ○ 高い | ○ 高い | ◎ 最高 |
| ポート管理 | × 手動 | △ 自動化可能 | ○ 自動 |
| Git 操作 | × 煩雑 | ○ 統合 | ○ 統合 |

## 決定

**選択肢 2: git worktree + Docker Compose プロジェクト名** を採用する。

理由:
1. Git 公式機能で安定しており、学習効果も高い
2. Docker Compose のプロジェクト名機能でコンテナ・ボリュームが自動分離される
3. ポート管理は自動化スクリプトで解決できる

## 帰結

### 肯定的な影響

- 複数のタスクを完全に並行して進められる
- ブランチ切り替えによる作業中断がなくなる
- 各環境が独立したデータベースを持つため、テストデータの競合がない

### 否定的な影響・トレードオフ

- worktree ごとに初回セットアップが必要（`pnpm install`、`cargo build`）
- 最大 9 個までの制限（ポートオフセット 1-9）
- ディスク使用量が増加（`node_modules/`、`target/` が独立）

### 関連ドキュメント

- 手順書: [並行開発（Worktree）](../04_手順書/04_開発フロー/04_並行開発（Worktree）.md)
- 技術ノート: [git_worktree](../06_技術ノート/git_worktree.md)

---

## 変更履歴

| 日付 | 変更内容 |
|------|---------|
| 2026-01-22 | 初版作成 |
