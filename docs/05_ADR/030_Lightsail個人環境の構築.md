# ADR-030: Lightsail 個人環境の構築

## ステータス

承認済み

## コンテキスト

RingiFlow は本番環境として AWS の ECS Fargate + Aurora PostgreSQL + ElastiCache Redis を想定している（[基本設計書](../02_基本設計書/)参照）。しかし、この構成は月額数百ドル以上のコストがかかる。

以下の目的で、低コストな検証・個人開発環境が必要となった:

1. 機能開発中の動作確認（ローカル以外の環境で）
2. 外部サービス連携のテスト（Cloudflare、外部 API など）
3. デモ・プレゼンテーション用環境
4. 本番デプロイ前のステージング

要件:

- 月額 $20 以下で維持可能
- 本番構成と同じコンテナイメージを使用可能
- HTTPS でアクセス可能
- DDoS 防御が最低限あること
- HA（高可用性）は不要

## 検討した選択肢

### 選択肢 1: AWS Lightsail + Cloudflare

単一の Lightsail インスタンス（$10/月、2GB RAM）に全コンポーネントをデプロイ。Cloudflare Free プランで SSL 終端と CDN を提供。

構成:

```
Cloudflare (SSL終端、CDN、DDoS防御)
    ↓ HTTP (Port 80)
Lightsail ($10/月)
    ├── Nginx (リバースプロキシ)
    ├── BFF (セッション管理)
    ├── Core Service (ビジネスロジック)
    ├── Auth Service (認証)
    ├── PostgreSQL (データベース)
    └── Redis (セッション)
```

評価:

- 利点:
  - 月額 $10 と非常に低コスト
  - Cloudflare Free で SSL 終端、CDN、基本的な DDoS 防御が無料
  - Lightsail は AWS の一部なので、将来の拡張時に知識が活かせる
  - Docker Compose でローカルと同じ構成が使える
- 欠点:
  - 単一インスタンスなので HA なし
  - リソース制限（2GB RAM）があり、負荷テストには不向き
  - Lightsail と他の AWS サービスとの連携は制限がある

### 選択肢 2: EC2 t3.micro + Cloudflare

EC2 t3.micro（無料枠または $8-10/月）を使用。

評価:

- 利点:
  - AWS の他サービスとの連携が容易
  - より細かな設定が可能
- 欠点:
  - t3.micro は 1GB RAM で、全コンポーネント稼働には不十分
  - t3.small（2GB）は $15/月程度
  - EBS、データ転送などの追加コストが発生
  - セットアップが Lightsail より複雑

### 選択肢 3: 自宅サーバー + Cloudflare Tunnel

自宅の PC やサーバーで Docker Compose を実行し、Cloudflare Tunnel で公開。

評価:

- 利点:
  - 追加コストなし（電気代以外）
  - リソースは自宅マシンに依存するので柔軟
- 欠点:
  - PC を常時稼働させる必要がある
  - 自宅のネットワーク障害時にアクセス不可
  - デモ時の安定性に不安
  - セキュリティ上のリスク（自宅ネットワークとの境界）

### 選択肢 4: Fly.io / Railway などの PaaS

コンテナ PaaS を利用。

評価:

- 利点:
  - デプロイが非常に簡単（git push でデプロイ）
  - 無料枠あり
  - 複数リージョンへの展開が容易
- 欠点:
  - PostgreSQL と Redis を別サービスで契約すると $10-20 追加
  - AWS との差異が大きく、本番移行時の学びが少ない
  - プラットフォーム固有の制約がある

### 比較表

| 観点 | Lightsail + Cloudflare | EC2 + Cloudflare | 自宅サーバー | PaaS |
|------|------------------------|------------------|-------------|------|
| 月額コスト | $10 | $15-20 | $0 | $15-30 |
| セットアップ難易度 | 中 | 高 | 低 | 低 |
| 可用性 | 中 | 中 | 低 | 高 |
| 本番との類似性 | 高 | 高 | 中 | 低 |
| 学習効果 | 高 | 高 | 中 | 低 |

## 決定

**選択肢 1: AWS Lightsail + Cloudflare** を採用する。

主な理由:

1. **コスト最適**: 月額 $10 で全要件を満たせる
2. **本番との整合性**: 同じ Docker イメージを使用でき、デプロイフローの学習になる
3. **適度な複雑さ**: 簡単すぎず難しすぎず、インフラの学習に適している

他の選択肢を却下した理由:

- EC2: 同等構成で Lightsail より高コスト
- 自宅サーバー: 安定性に不安があり、デモ用途に不適
- PaaS: 本番 AWS 構成との差異が大きく、学習効果が低い

## 帰結

### 肯定的な影響

- 月額 $10 で検証環境を維持可能
- Docker Compose ベースなのでローカルとの差異が小さい
- Cloudflare の設定経験が得られる（将来の本番でも活用可能）
- デプロイスクリプトの作成を通じて、CI/CD への足がかりになる

### 否定的な影響・トレードオフ

- 単一インスタンスなので、インスタンス障害時はサービス停止
- 2GB RAM の制限があり、本格的な負荷テストは不可
- 手動デプロイが必要（CI/CD 自動化は今回スコープ外）
- バックアップは手動運用（ただしスクリプト化する）

### 関連ドキュメント

- 設計書: 未作成（本 ADR で方針決定）
- 実装:
  - `backend/Dockerfile` - バックエンド Docker イメージ（BFF / Core Service / Auth Service）
  - `frontend/Dockerfile` - フロントエンド Docker イメージ
  - `infra/lightsail/docker-compose.yml` - Lightsail 用 Compose 構成
  - `infra/lightsail/` - デプロイスクリプト群・Nginx 設定

---

## 変更履歴

| 日付 | 変更内容 |
|------|---------|
| 2026-01-19 | 初版作成 |
