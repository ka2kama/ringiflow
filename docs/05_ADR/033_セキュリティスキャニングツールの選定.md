# ADR-033: セキュリティスキャニングツールの選定

## ステータス

承認済み

## コンテキスト

要件定義書（CORE-02 12.8 節）で「依存関係スキャン | Rust クレート | cargo audit | 毎 CI」と定義されている。CI パイプラインにこの要件を実装するにあたり、ツールを選定する必要がある。

現状:

- Dependabot による依存関係の自動更新は有効（週次）
- CI パイプラインでの脆弱性スキャン・ライセンスチェックは未導入

Dependabot は「依存を最新に保つ」ツールであり、CI でのブロッキングチェック（脆弱性が検出されたらマージを防止）とは役割が異なる。

## 検討した選択肢

### 選択肢 1: cargo-audit のみ

RustSec Advisory DB に対する脆弱性スキャンに特化したツール。

評価:

- 利点: シンプル、単一目的、軽量
- 欠点: ライセンスチェック機能がない、公式 GitHub Action がない（`cargo install` が必要）

### 選択肢 2: cargo-deny のみ

EmbarkStudios が開発する多機能な依存関係チェックツール。advisories（脆弱性）、licenses（ライセンス）、bans（禁止クレート）、sources（ソース制限）の 4 つのチェックを提供する。

評価:

- 利点: cargo-audit の機能を包含し、追加でライセンスチェックも可能。公式 GitHub Action（`EmbarkStudios/cargo-deny-action@v2`）があり CI 統合が容易
- 欠点: deny.toml の設定ファイル管理が必要

### 選択肢 3: 両方

cargo-audit と cargo-deny を併用する。

評価:

- 利点: 冗長性による安心感
- 欠点: advisories チェックが重複（同じ RustSec Advisory DB を使用）、2 ツールの管理コスト

### 比較表

| 観点 | cargo-audit | cargo-deny | 両方 |
|------|-------------|------------|------|
| 脆弱性スキャン | ○ | ○（同じ DB） | 重複 |
| ライセンスチェック | × | ○ | ○ |
| 禁止クレート | × | ○ | ○ |
| ソース制限 | × | ○ | ○ |
| CI Action | なし | `EmbarkStudios/cargo-deny-action@v2` | — |
| メンテナンスコスト | 低 | 低 | 高 |

## 決定

選択肢 2: cargo-deny のみを採用する。

理由:

1. cargo-deny の advisories チェックは cargo-audit と同じ RustSec Advisory DB を使用しており、脆弱性検出の機能は完全に包含される
2. ライセンスチェックが追加で得られる（MIT プロジェクトとして、LGPL 等の copyleft ライセンスの混入を防止）
3. 公式 GitHub Action により CI 統合が容易（Rust ツールチェインのセットアップ不要）
4. 1 ツールで 4 つの懸念をカバーでき、管理コストが低い

要件定義書の「cargo audit」はツール名ではなく機能要件（依存関係の脆弱性検出）の記述であり、cargo-deny で要件を満たせる。

## 帰結

### 肯定的な影響

- CI で既知の脆弱性が自動検出され、マージ前に対処できる
- ライセンス違反（意図しない copyleft ライセンスの混入等）を防止できる
- セキュリティ要件 CORE-02.2.3（「セキュリティ監査において重大な脆弱性が検出されないこと」）への対応が進む

### 否定的な影響・トレードオフ

- `deny.toml` の管理が必要（新しいライセンスの依存が追加されたとき、allow リストの更新が必要）
- `cargo deny check` の実行時間が CI に加わる（ただしビルド不要で数秒程度）

### 運用ルール

- 新しいクレートを追加する際、ライセンスが allow リストに含まれるか確認する
- CI でライセンスエラーが出た場合、ライセンスの互換性を確認してから allow リストに追加する
- 既知の脆弱性が検出された場合、要件定義書の SLA（Critical: 24 時間以内、High: 7 日以内）に従い対応する

### 関連ドキュメント

- 要件定義書: [CORE-02 12.8 セキュリティテスト要件](../../01_要件定義書/01_コア要件.md)
- 設定ファイル: `backend/deny.toml`
- CI ワークフロー: `.github/workflows/ci.yaml`（security ジョブ）
- cargo-deny 公式: https://embarkstudios.github.io/cargo-deny/
- GitHub Action: https://github.com/EmbarkStudios/cargo-deny-action

---

## 変更履歴

| 日付 | 変更内容 |
|------|---------|
| 2026-02-07 | 初版作成 |
