# ADR-005: データベースツールキットの選定

## ステータス

承認済み（2026-01-14）

## コンテキスト

RingiFlow のバックエンドは Rust + axum で構築する。
PostgreSQL へのアクセスとマイグレーション管理のため、データベースツールキットを選定する必要がある。

### 要件

1. 非同期対応: axum は tokio ベースの非同期フレームワークであり、DB アクセスも非同期である必要がある
2. 型安全性: Rust の型システムを活かし、クエリのミスをコンパイル時に検出したい
3. PostgreSQL サポート: Aurora PostgreSQL を使用するため、PostgreSQL 固有機能（UUID、JSONB 等）をサポートすること
4. マイグレーション管理: スキーマ変更を追跡・適用できること
5. 学習コスト: プロジェクトの学習目的を考慮し、理解しやすいこと

## 検討した選択肢

### 選択肢 1: SQLx

純粋な SQL を書き、コンパイル時にクエリを検証するツールキット。ORM ではなく、SQL ファーストのアプローチ。

評価:
- 利点:
  - コンパイル時クエリ検証により、SQL の誤りを実行前に検出
  - 生の SQL を書くため、PostgreSQL 固有機能をフル活用可能
  - 非同期ネイティブ（tokio 対応）
  - マイグレーション機能を内蔵
  - ORM の抽象化がないため、実行される SQL が明確
- 欠点:
  - コンパイル時に DB 接続が必要（オフラインモードで回避可能）
  - SQL を直接書くため、複雑なクエリは冗長になる可能性

### 選択肢 2: Diesel

Rust で最も成熟した ORM。スキーマファーストで型安全なクエリビルダーを提供。

評価:
- 利点:
  - 成熟したエコシステム、豊富なドキュメント
  - スキーマから Rust の型を自動生成
  - 型安全なクエリビルダー
- 欠点:
  - 非同期サポートが限定的（diesel-async は別クレート）
  - DSL の学習コストが高い
  - PostgreSQL 固有機能を使う際に制約がある場合がある
  - ORM の抽象化により、実際の SQL が見えにくい

### 選択肢 3: SeaORM

非同期ファーストの ORM。ActiveRecord パターンを採用。

評価:
- 利点:
  - 非同期ネイティブ
  - マイグレーション機能を内蔵
  - Entity の自動生成
- 欠点:
  - SQLx より抽象度が高く、学習目的では SQL の理解が深まりにくい
  - まだ比較的新しく、エコシステムが発展途上

### 比較表

| 観点 | SQLx | Diesel | SeaORM |
|------|------|--------|--------|
| 非同期サポート | ◎ ネイティブ | △ 別クレート | ◎ ネイティブ |
| コンパイル時検証 | ◎ クエリ全体 | ○ 型レベル | ○ 型レベル |
| 学習コスト | ◎ SQL 知識が活きる | △ DSL 習得が必要 | ○ ORM パターン |
| SQL 可視性 | ◎ 直接記述 | △ DSL に隠蔽 | △ 抽象化 |
| PostgreSQL 機能 | ◎ フルサポート | ○ 一部制約 | ○ 一部制約 |
| 成熟度 | ○ 安定 | ◎ 最も成熟 | △ 発展途上 |

## 決定

**SQLx を採用する。**

### 理由

1. 非同期ネイティブ: axum + tokio との親和性が最も高い

2. 学習効果の最大化: SQL を直接書くことで、ORM の抽象化に隠れがちなデータベースの動作を理解できる。プロジェクト理念「学習効果の最大化」に合致する

3. コンパイル時検証: クエリの型チェックがコンパイル時に行われるため、実行時エラーを減らせる。プロジェクト理念「品質の追求」に合致する

4. PostgreSQL フルサポート: Aurora PostgreSQL の機能（UUID、JSONB、配列型など）を制約なく使用できる

### Diesel を選ばなかった理由

- 非同期サポートが追加クレート依存
- DSL の学習コストが高く、SQL そのものの学習機会が減る
- 抽象化により「何が実行されているか」が見えにくい

### SeaORM を選ばなかった理由

- ORM の抽象化が学習目的に適さない
- エコシステムがまだ発展途上

## 帰結

### 肯定的な影響

- SQL の知識がそのまま活かせる
- 実行されるクエリが明確で、パフォーマンスチューニングしやすい
- コンパイル時にクエリエラーを検出できる
- PostgreSQL の高度な機能をフル活用できる

### 否定的な影響・トレードオフ

- 複雑なクエリを手書きする必要がある（クエリビルダーがない）
- 開発時に DB 接続が必要（オフラインモードで CI は対応可能）
- Diesel のような自動スキーマ生成がない

### 関連ドキュメント

- 技術ノート: [sqlx-cli.md](../06_技術ノート/sqlx-cli.md)
- 設計書: データベース設計（Phase 1 で作成予定）

---

## 変更履歴

| 日付 | 変更内容 |
|------|---------|
| 2026-01-14 | 初版作成 |
