# ADR-039: ワークフローモジュールの分割方針

## ステータス

承認済み

## コンテキスト

`backend/crates/domain/src/workflow.rs` は 1665 行に達しており、プロジェクトのファイルサイズ閾値 500 行（`.claude/rules/structural-review.md`）を大幅に超過している。Issue 作成時（#290）から +370 行増加しており、肥大化が加速している。

このファイルには 3 つのドメインエンティティが同居している:

| エンティティ | 行数 | 責務 |
|------------|------|------|
| WorkflowDefinition | ~205 行 | ワークフローテンプレートの管理、状態遷移（Draft→Published→Archived） |
| WorkflowInstance | ~365 行 | 実行中の案件管理、状態遷移（Draft→Pending→InProgress→Approved/Rejected/Cancelled） |
| WorkflowStep | ~367 行 | 承認ステップの管理、状態遷移（Pending→Active→Completed/Skipped） |

エンティティ間の結合は ID 型の参照のみ（Instance が DefinitionId を、Step が InstanceId を保持）。状態遷移ロジックは各エンティティ内で完結しており、structural-review.md の許容条件「密結合なドメインロジックで、分割すると凝集度が低下する場合」には該当しない。

## 検討した選択肢

### 選択肢 1: エンティティ単位で分割（`workflow/` ディレクトリ）

`workflow.rs` を親モジュールとし、`workflow/definition.rs`、`workflow/instance.rs`、`workflow/step.rs` に分割する。`pub use *` で re-export し、消費者のインポートパスを維持する。

評価:

- 利点: 1 ファイル 1 エンティティで責務が明確、各ファイル 205-367 行で閾値以内、テストもエンティティ単位で配置され保守性向上
- 欠点: ファイル数が増える、テストフィクスチャの `now()` が各ファイルで重複定義

### 選択肢 2: テストのみ分離

プロダクションコードは `workflow.rs` に残し、テスト（670 行）を別ファイルに移動する。

評価:

- 利点: プロダクションコードの変更が最小限
- 欠点: プロダクションコード自体が 989 行で依然として閾値超過、テスト専用ファイルの配置場所が不自然

### 選択肢 3: 現状維持

structural-review.md の許容条件を適用し、ADR にその判断を記録する。

評価:

- 利点: 変更リスクゼロ
- 欠点: 閾値超過が続き、さらなる肥大化を誘引する（割れ窓効果）

### 比較表

| 観点 | 選択肢 1 | 選択肢 2 | 選択肢 3 |
|------|---------|---------|---------|
| プロダクションコード行数 | 各 205-367 行 | 989 行（閾値超過） | 989 行（閾値超過） |
| 消費者への影響 | なし（re-export） | なし | なし |
| 保守性向上 | 大（責務明確化） | 小（テストのみ） | なし |
| 変更リスク | 低（純粋リファクタリング） | 低 | なし |
| 既存パターンとの整合 | handler.rs + handler/ と同一 | 前例なし | — |

## 決定

選択肢 1: エンティティ単位で分割する。

理由:

1. エンティティ間の結合度が ID 型の参照のみであり、分割しても凝集度が下がらない
2. 各ファイルが 205-367 行に収まり、テスト込みでもプロダクションコードは閾値以内
3. `handler.rs` + `handler/` の既存パターンと一致し、プロジェクト内の一貫性を維持

分割後の構造:

```
domain/src/
├── workflow.rs          # 親モジュール（doc + mod 宣言 + pub use re-export）
└── workflow/
    ├── definition.rs    # WorkflowDefinition
    ├── instance.rs      # WorkflowInstance
    └── step.rs          # WorkflowStep
```

re-export 戦略: `mod`（非 pub）+ `pub use *` を使用し、消費者のインポートパス `workflow::TypeName` を維持する。

## 帰結

### 肯定的な影響

- 各ファイルが単一エンティティに集中し、コードの理解・変更が容易になる
- テストがエンティティ単位で分離され、テスト対象が明確になる
- 後続の Issue #290 対応（他ファイル分割）のパターンを確立する

### 否定的な影響・トレードオフ

- テストフィクスチャ `now()` が各ファイルで重複定義される（1 行定義のため許容）
- ファイル数が 1 → 4 に増加するが、各ファイルの責務は明確

### 関連ドキュメント

- Issue: #290（Refactor oversized files）
- 構造レビュー: `.claude/rules/structural-review.md`
- Rust 規約: `.claude/rules/rust.md`（mod.rs 禁止、Rust 2018+ パターン）

---

## 変更履歴

| 日付 | 変更内容 |
|------|---------|
| 2026-02-09 | 初版作成 |
