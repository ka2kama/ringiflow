# ADR-022: バックエンドサービスの命名規則と層構造の統一

## ステータス

提案

## コンテキスト

### 現状

ADR-017 に基づき Auth Service を分離した結果、バックエンドに複数のサービスが存在するようになった：

| サービス | 命名パターン | 層構造 |
|---------|------------|--------|
| BFF | 略語 | handler のみ |
| core-api | `xxx-api` | handler のみ |
| auth-service | `xxx-service` | handler + usecase |

### 課題

1. **サービス名の不統一**
   - `core-api` と `auth-service` で命名パターンが異なる
   - 新規サービス追加時にどちらに合わせるべきか不明確

2. **層構造の不統一**
   - core-api: handler が直接 Repository を呼び出す
   - auth-service: handler → usecase → Repository の 2 層構造
   - 将来の保守性・拡張性に影響

3. **環境変数の不統一**
   - `CORE_API_HOST` vs `AUTH_SERVICE_HOST`（単語数が異なる）
   - 一貫性がなく、設定管理が煩雑

4. **その他の命名の揺れ**
   - 設定構造体: `CoreApiConfig` vs `AuthServiceConfig`
   - State 構造体: `UserState` vs `AuthState`
   - Request/Response 型の命名スタイル

### 制約

- ADR-017 で Auth Service 分離の方針は決定済み
- プロジェクト理念として「品質追求」「シンプルさ（KISS）」を重視
- 過度な抽象化は避ける

## 検討した選択肢

### 決定 1: サービス名の統一

#### 選択肢 1-A: `xxx-service` に統一

`core-api` を `core-service` にリネームする。

評価:
- 利点:
  - マイクロサービスアーキテクチャの文脈で自然な命名
  - auth-service の設計が新しく洗練されているため、こちらに合わせる方が自然
  - 内部サービスとしての役割を明確に表現
- 欠点:
  - 既存の core-api に関する参照（設計書、コード、設定）の変更が必要
  - クレート名 `ringiflow-core-api` も変更が必要

#### 選択肢 1-B: `xxx-api` に統一

`auth-service` を `auth-api` にリネームする。

評価:
- 利点:
  - REST API を提供していることを明確に表現
  - core-api は既に実装済みのため変更範囲が小さい
- 欠点:
  - auth-service 設計書（ADR-017、詳細設計書）の変更が必要
  - マイクロサービスの文脈では `service` の方が一般的

#### 選択肢 1-C: 現状維持

各サービスの性質に応じて個別に命名する。

評価:
- 利点:
  - 変更コストがゼロ
- 欠点:
  - 一貫性がなく、新規参画者が混乱する
  - 新規サービス追加時の命名指針がない

### 決定 2: 層構造（usecase 層）の使い分け

#### 選択肢 2-A: 一貫して usecase 経由

すべてのビジネスロジックを usecase 層に配置する。

評価:
- 利点:
  - 一貫性が高い
  - 将来ロジック追加時に変更不要
- 欠点:
  - 単純な CRUD でも usecase を経由する冗長さ
  - KISS 原則に反する

#### 選択肢 2-B: ビジネスロジックがある場合のみ usecase

ビジネスロジックの有無で層を使い分ける。

評価:
- 利点:
  - KISS 原則に沿う
  - 過度な抽象化を避けられる
- 欠点:
  - 「ビジネスロジックがあるか」の判断基準が必要
  - 境界が曖昧になるリスク

#### 選択肢 2-C: サービスごとに判断

サービスの特性に応じて、usecase 層の有無をサービス単位で決定する。

評価:
- 利点:
  - 各サービスの特性に合わせた設計
- 欠点:
  - 一貫性がない
  - 新規サービス追加時の判断が難しい
  - 同一サービス内でも処理によってロジックの有無が異なる場合に対応できない

### 比較表

| 観点 | 1-A: xxx-service | 1-B: xxx-api | 1-C: 現状維持 |
|------|-----------------|--------------|--------------|
| 一貫性 | **高** | **高** | 低 |
| 変更コスト | 中 | 中 | **なし** |
| マイクロサービス文脈 | **自然** | やや不自然 | — |
| 新規サービス追加の指針 | **明確** | **明確** | 不明確 |

| 観点 | 2-A: 常に usecase | 2-B: ロジック時のみ | 2-C: サービスごと |
|------|------------------|-------------------|------------------|
| シンプルさ（KISS） | 低 | **高** | 中 |
| 一貫性 | **高** | 中 | 低 |
| 判断の明確さ | **高** | 基準必要 | 低 |

## 決定

### 決定 1: **選択肢 1-A: `xxx-service` に統一**

`core-api` を `core-service` にリネームし、すべてのバックエンドサービスを `xxx-service` パターンで統一する。

主な理由:
1. マイクロサービスアーキテクチャの文脈で自然な命名
2. auth-service が新しい設計パターン（usecase 層）を採用しており、こちらに合わせる方が将来的な保守性が高い
3. BFF の背後にあるサービス群として概念的に整合

### 決定 2: **選択肢 2-B: ビジネスロジックがある場合のみ usecase**

usecase 層は、ビジネスロジックが存在する場合にのみ導入する。

主な理由:
1. KISS 原則に沿う
2. 過度な抽象化を避け、必要十分な複雑さに留める
3. プロジェクト理念「品質追求」の中の「シンプルさを保つ」に合致

#### usecase 層の導入基準

| 処理の種類 | usecase | 理由 |
|-----------|---------|------|
| health check | 不要 | インフラレベルの疎通確認、ビジネスロジックなし |
| DB/Redis 疎通確認 | 不要 | インフラ確認はビジネスではない |
| 単純な CRUD（1 リポジトリの単純呼び出し） | 不要 | ロジックなし、handler で直接可 |
| 複数リポジトリの協調 | **必要** | オーケストレーションが必要 |
| ビジネスルール判定を含む | **必要** | ロジックの分離が必要 |
| トランザクション境界の管理 | **必要** | 複数操作の整合性管理 |

判断に迷った場合:
- 「この処理を別の場所から呼び出したいか？」→ Yes なら usecase
- 「テスト時に HTTP 層を介さずテストしたいか？」→ Yes なら usecase

## 帰結

### 肯定的な影響

- 命名規則が統一され、新規参画者が理解しやすくなる
- 新規サービス追加時の命名・設計指針が明確になる
- 過度な抽象化を避け、シンプルな構造を維持できる

### 否定的な影響・トレードオフ

- `core-api` → `core-service` のリネームに伴う変更作業が発生
- usecase 層の導入判断に主観が入る余地がある（基準表で軽減）

### 今後必要になる作業

1. 設計書の作成: 命名規則統一リファクタリング設計
2. `core-api` → `core-service` のリネーム実装
3. 環境変数の命名統一
4. 関連ドキュメントの更新

### 命名規則まとめ

#### サービス名・クレート名

| 項目 | 規則 | 例 |
|------|------|-----|
| ディレクトリ名 | `xxx-service` | `core-service`, `auth-service` |
| クレート名 | `ringiflow-xxx-service` | `ringiflow-core-service` |
| 例外 | BFF は略語のまま | `bff`, `ringiflow-bff` |

#### 環境変数

| 項目 | 規則 | 例 |
|------|------|-----|
| 接頭辞 | `{SERVICE}_` | `CORE_`, `AUTH_`, `BFF_` |
| 変数名 | `{SERVICE}_{PROPERTY}` | `CORE_HOST`, `AUTH_PORT` |

変更前後:

| 変更前 | 変更後 |
|--------|--------|
| `CORE_API_HOST` | `CORE_HOST` |
| `CORE_API_PORT` | `CORE_PORT` |
| `AUTH_SERVICE_HOST` | `AUTH_HOST` |
| `AUTH_SERVICE_PORT` | `AUTH_PORT` |

#### 設定構造体

| 項目 | 規則 | 例 |
|------|------|-----|
| 構造体名 | `{Service}Config` | `CoreConfig`, `AuthConfig`, `BffConfig` |

#### State 構造体

| 項目 | 規則 | 例 |
|------|------|-----|
| 構造体名 | `{Domain}State` | `UserState`, `AuthState` |
| 保持するもの | usecase がある場合は usecase、ない場合は Repository | — |

#### エラー型

| 項目 | 規則 | 例 |
|------|------|-----|
| enum 名 | `{Domain}Error` | `AuthError`, `UserError` |
| RFC 9457 | 統一されたエラーレスポンス形式を採用 | — |

### 関連ドキュメント

- ADR: [ADR-017: Auth Service 分離の方針](017_AuthService分離の方針.md)
- 設計書: [08_AuthService設計.md](../03_詳細設計書/08_AuthService設計.md)
- 設計書: [09_命名規則統一リファクタリング設計.md](../03_詳細設計書/09_命名規則統一リファクタリング設計.md)（新規作成）

---

## 変更履歴

| 日付 | 変更内容 |
|------|---------|
| 2026-01-22 | 初版作成 |
