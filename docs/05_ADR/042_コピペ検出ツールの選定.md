# ADR-042: コピペ検出ツールの選定

## ステータス

承認済み

## コンテキスト

AI 主導の開発では、コンテキストウィンドウの制約により、過去に書いたコードとの類似性を AI が能動的に検出できない。結果として、同じパターンのコードが複数箇所に蓄積する構造的な DRY 違反が発生する。現時点で約 730 行の重複コードが存在する（Rust 126 クローン、Elm 12 クローン）。

行動規範（「DRY を意識しろ」）は認知の問題であり、構造的に解決困難。機械的な検出の仕組みが必要である。

Issue #151（構造劣化の検出メカニズム）および #373（DRY 違反検出の仕組み導入）の一環として、CI でコード重複を機械的に検出するツールを導入する。

## 検討した選択肢

### 選択肢 1: jscpd（JavaScript Copy/Paste Detector）

150 以上の言語に対応するコピー＆ペースト検出ツール。トークンベースで類似コードブロックを検出する。

評価:

- 利点: Rust + Elm 両対応、Node.js エコシステム（`npx` で即時実行可能）、成熟度が高い（150+ 言語対応）、CI 統合が容易
- 欠点: Elm の公式サポートにバグあり（`elm` フォーマット指定で "Format undefined" になる）。Haskell トークナイザーで代用可能だが、ワークアラウンドが必要

### 選択肢 2: duplicate_code（Rust 専用）

Rust コードの重複を検出する Cargo サブコマンド。

評価:

- 利点: Rust に特化した分析
- 欠点: Rust のみ対応（Elm 非対応）、メンテナンス状況が不明、`cargo install` が必要

### 選択肢 3: PMD CPD（Copy/Paste Detector）

PMD プロジェクトのコピー＆ペースト検出モジュール。多言語対応で活発にメンテナンスされている。

評価:

- 利点: 多言語対応、活発なメンテナンス、高精度
- 欠点: JDK 必須（プロジェクトの既存エコシステムにない）、CI セットアップが重い、Rust 対応が未確認

### 比較表

| 観点 | jscpd | duplicate_code | PMD CPD |
|------|-------|----------------|---------|
| 対応言語 | 150+（Rust + Elm 両対応） | Rust のみ | 多言語（Rust 非確認） |
| エコシステム | Node.js（`npx` で即時実行） | `cargo install` | JDK 必要 |
| 出力形式 | console, json, html, markdown | JSON | XML, CSV |
| CI 統合 | `npx --yes jscpd@latest`（インストール不要） | `cargo install` 要 | JDK セットアップ要 |
| メンテナンス | 活発 | 不明 | 活発 |

## 決定

選択肢 1: jscpd を採用する。

理由:

1. Rust + Elm 両方をカバーできる唯一の選択肢。プロジェクトは両言語を使用しており、単一ツールでの統一的な検出が望ましい
2. Node.js は既存のエコシステム（`npx @redocly/cli@latest` パターンが `lint-openapi` で確認済み）。新しい依存を追加する必要がない
3. `npx` で即時実行できるため、開発者のローカル環境にグローバルインストールが不要（`check-tools` への追加も不要）
4. 実際にプロジェクトで実行し、既知の重複パターンを正しく検出できることを確認済み

### 発見されたバグと対策

実装時に以下のバグを発見した:

1. **Elm フォーマットバグ**: `--format "elm"` を指定すると "jscpd has issue with support of 'elm'" と警告が出て、全ファイルが "Format undefined" になる。対策: `--format "haskell" --formats-exts "haskell:elm"` で Haskell トークナイザーを Elm ファイルに適用する（構文が類似しているため十分に機能する）
2. **複数フォーマット + formats-exts の併用バグ**: `--format "rust,haskell" --formats-exts "haskell:elm"` を指定すると、Rust の検出が消失する。対策: Rust と Elm を別々の jscpd 呼び出しで実行する
3. **設定ファイルのフォーマット解析バグ**: `.jscpd.json` で `format` と `formatsExts` を設定しても、.rs ファイルが "Format undefined" になる。対策: 設定ファイルを使わず、CLI 引数のみで実行する

これらのバグは jscpd の利便性を損なうが、ワークアラウンドで回避可能であり、検出精度自体には影響しない。

## 帰結

### 肯定的な影響

- CI で重複コードが機械的に検出され、新規の DRY 違反の蓄積を可視化できる
- 初期は警告のみ（`exit 0`）で CI をブロックしない。既存重複の段階的な解消後、閾値を設定して CI ブロックに移行できる
- `just check-duplicates` でローカルでも手軽に確認できる

### 否定的な影響・トレードオフ

- jscpd のバグにより、設定ファイルが使えず CLI 引数のみで運用する必要がある。justfile で管理しているため実用上の問題はない
- Elm の検出は Haskell トークナイザーでの代用であり、Elm 固有の構文では精度が低下する可能性がある
- Rust と Elm を別々に実行するため、CI ジョブの実行時間がわずかに増加する

### 関連ドキュメント

- Issue: #151（構造劣化の検出メカニズム）、#373（DRY 違反検出の仕組み導入）
- CI ワークフロー: `.github/workflows/ci.yaml`（code-quality ジョブ）
- justfile: `check-duplicates` レシピ
- jscpd 公式: https://github.com/kucherenko/jscpd

---

## 変更履歴

| 日付 | 変更内容 |
|------|---------|
| 2026-02-10 | 初版作成 |
