# ADR-038: 未使用依存検出ツールの選定

## ステータス

承認済み

## コンテキスト

Cargo.toml に宣言された依存が実際にはコード内で使用されていないケースがある。未使用依存はコンパイル時間の増加、攻撃対象面の拡大、保守コストの増加を招く。しかし `cargo clippy` や `cargo deny` は Cargo.toml レベルの未使用依存を検出しない。

Issue #151（構造劣化の検出メカニズム）の一環として、CI で未使用依存を機械的に検出する仕組みを導入する。

## 検討した選択肢

### 選択肢 1: cargo-machete

ヒューリスティック（正規表現）ベースで未使用依存を検出するツール。ripgrep + rayon を使用し高速に動作する。

評価:

- 利点: stable ツールチェインで動作、高速（数秒）、偽陽性を ignore リストで管理可能、CI 統合が容易（`cargo install` のみ）
- 欠点: ヒューリスティックベースのため、マクロ経由でのみ使用される依存で偽陽性が発生しうる

### 選択肢 2: cargo-udeps

nightly コンパイラのコンパイルアーティファクトを分析し、実際に使用されていない依存を検出する。

評価:

- 利点: コンパイルベースの分析で高精度、偽陽性が少ない
- 欠点: nightly コンパイラ必須、フルコンパイルが必要（CI 時間が数分増加）、nightly の互換性問題が発生しうる

### 比較表

| 観点 | cargo-machete | cargo-udeps |
|------|---------------|-------------|
| 要求ツールチェイン | stable | nightly |
| 検出方式 | ヒューリスティック（正規表現） | コンパイルアーティファクト分析 |
| 速度 | 高速（数秒） | 低速（フルコンパイル） |
| 精度 | やや低い（偽陽性あり） | 高精度 |
| 偽陽性対策 | `[package.metadata.cargo-machete]` ignore | — |
| CI 統合 | `cargo install` + `cargo machete` | `cargo +nightly` + `cargo install` |
| メンテナンスコスト | 低（stable で動作） | 高（nightly 追従が必要） |

## 決定

選択肢 1: cargo-machete を採用する。

理由:

1. このプロジェクトの nightly は rustfmt の unstable 機能専用であり、メインビルドは stable (1.93.0)。cargo-udeps のためだけに CI で nightly コンパイルを行うのは CI 時間の浪費
2. cargo-machete の偽陽性は `[package.metadata.cargo-machete]` の ignore リストで管理でき、実用上問題ない
3. stable ツールチェインで動作するため、nightly の互換性問題に悩まされない
4. 実際にプロジェクトで実行したところ、5 つの真の未使用依存を検出し、実用性を確認済み

## 帰結

### 肯定的な影響

- CI で未使用依存が機械的に検出され、蓄積を防止できる
- コンパイル時間の削減と攻撃対象面の縮小に寄与する
- `just check-unused-deps` でローカルでも手軽に確認できる

### 否定的な影響・トレードオフ

- ヒューリスティックベースのため、マクロ経由の依存で偽陽性が発生しうる。発生した場合は ignore リストで管理する
- 開発者のローカル環境に `cargo-machete` のインストールが必要（`check-tools` で確認）

### 関連ドキュメント

- Issue: #151（構造劣化の検出メカニズム）
- CI ワークフロー: `.github/workflows/ci.yaml`（rust ジョブ）
- justfile: `check-unused-deps` レシピ
- cargo-machete 公式: https://github.com/bnjbvr/cargo-machete

---

## 変更履歴

| 日付 | 変更内容 |
|------|---------|
| 2026-02-09 | 初版作成 |
