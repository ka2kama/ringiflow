# ADR-032: テスト設計方針

## ステータス

提案

## コンテキスト

Issue #106 で、テストコードの一覧性・可読性・一貫性の向上が求められた。現状の課題:

1. Given（前提条件の準備）が煩雑で、When-Then の見通しが悪い
2. テストファイルを開いても「どんなテストがあるか」を一目で把握できない
3. Unit / Integration / API / E2E でレイヤーごとに書き方がバラバラになりやすい

テスト方針は現在、複数のドキュメントに分散している:

- TDD 開発フロー（`docs/04_手順書/04_開発フロー/02_TDD開発フロー.md`）: TDD サイクルとテストリスト
- 品質チェックリスト（`docs/04_手順書/04_開発フロー/01_Issue駆動開発.md` セクション 6.2）: テスト品質の検証項目
- API テストルール（`.claude/rules/api-test.md`）: Hurl のアサーション方針
- zoom-rhythm.md: テストフェーズの収束確認

テスト設計方針（表現形式、命名規則、構造化方法）を統一的に定義する ADR が不在のため、新機能実装時にテストの書き方がぶれやすい。

### 前提（既に確定している事項）

- TDD 採用済み（開発プロセス）
- AAA（Arrange-Act-Assert）用語は #279 で採用済み
- テストピラミッド（75% Unit / 20% Integration / 5% E2E）は要件定義 CORE-12 で定義済み
- API テストのアサーション方針は `.claude/rules/api-test.md` で定義済み

## 検討した選択肢

### 選択肢 1: 現状維持

各レイヤーで自由にテストを書く。統一的な方針は設けない。

評価:
- 利点: 導入コストゼロ。各開発者が最適と思う形式を選択できる
- 欠点: 一貫性がなく、テストファイルの見通しが悪い。新機能実装時に毎回「どう書くか」を判断する必要がある

### 選択肢 2: BDD（cucumber-rs）の全面採用

cucumber-rs を導入し、Gherkin 形式（`.feature` ファイル）で全テストを記述する。

評価:
- 利点: 仕様と実装が分離され、テストの一覧性が最も高い。非技術者との仕様共有に優れる
- 欠点: 個人開発プロジェクトでは非技術者との共有が不要。TDD の素早いフィードバックサイクル（Red-Green-Refactor）に摩擦が生じる（`.feature` ファイル + ステップ定義の二重管理）。既存テストの移行コストが大きい

### 選択肢 3: データ駆動 + 目次（rstest 活用）

rstest のパラメータ化テストを中心に据え、ファイル先頭にテスト目次を配置する。

評価:
- 利点: rstest が既にプロジェクト全体で活用されており、基盤が整っている。段階的に適用可能
- 欠点: rstest はパラメータ化に強いが、構造化（グルーピング、セクション分け）は別途ルールが必要

### 選択肢 4: 折衷案 — レイヤーごとの使い分け（採用）

レイヤーの特性に応じて表現形式を使い分ける。既存パターンを形式知化し、統一ルールとする。

評価:
- 利点: 各レイヤーの特性に最適な形式を選択できる。既存コードとの一貫性が保たれる。新規導入コストが最小限
- 欠点: レイヤーごとに異なるルールを覚える必要がある（ただし差異は表現形式のみで、構造化方法と命名規則は共通）

### 比較表

| 観点 | 現状維持 | BDD 全面採用 | データ駆動 + 目次 | 折衷案 |
|------|---------|-------------|-----------------|-------|
| 一覧性 | 低 | 高 | 中 | 中〜高 |
| 導入コスト | なし | 大 | 小 | 小 |
| 既存コードとの一貫性 | — | 低（全面移行） | 中 | 高 |
| TDD との親和性 | — | 低（二重管理） | 高 | 高 |
| レイヤー特性への適合 | — | 中（一律 Gherkin） | 中 | 高 |

## 決定

選択肢 4「折衷案 — レイヤーごとの使い分け」を採用する。

主な理由:
1. 既存コードに確立されたパターン（mod グルーピング、セクションコメント、テスト目次、rstest 活用）が既に存在しており、それを形式知化することで導入コストを最小化できる
2. cucumber-rs の最大利点（非技術者への仕様共有）が個人開発プロジェクトでは活きない。TDD の素早いフィードバックサイクルとの摩擦も避けられる
3. レイヤーごとの特性（Unit は AAA、API テストは Given-When-Then）に最適な表現形式を選択できる

cucumber-rs の見送りは「BDD が不要」ではなく「BDD の価値が発揮される条件がこのプロジェクトにない」という判断。チーム開発や非技術者との仕様共有が必要になった場合は再評価する。

### 1. レイヤーごとのテスト表現形式

| レイヤー | ツール | 表現形式 | 構造化コメント |
|---------|--------|---------|-------------|
| Unit（Domain） | Rust + rstest | AAA | `// Arrange` / `// Act` / `// Assert`（必要時） |
| Unit（Elm） | elm-test | describe + test 階層 | フレームワークが構造を強制 |
| Integration（Infra） | Rust + sqlx::test | AAA | Unit と一貫 |
| Integration（BFF） | Rust + axum | AAA（Given-When-Then も許容） | シナリオ的テストでは自然な方を選択 |
| API | Hurl | Given-When-Then | 現状維持（api-test.md 定義済み） |
| E2E | Playwright（予定） | Given-When-Then | ユーザーシナリオに適合 |

AAA と Given-When-Then の使い分け基準:

| 基準 | AAA | Given-When-Then |
|------|-----|-----------------|
| テストの性質 | 単一操作の検証 | シナリオ（複数ステップ）の検証 |
| 前提条件 | 単純なセットアップ | 状態遷移を伴う複雑なセットアップ |
| 可読性の観点 | 技術的な振る舞い | ユーザー視点の操作フロー |

### 2. 命名規則

| 項目 | 規則 | 例 |
|------|------|-----|
| Rust テスト関数 | `test_[振る舞いの説明]`（日本語） | `test_新規作成時にversionは1()` |
| Rust テストモジュール | `mod tests`（単一）または `mod [snake_case]`（複数） | `mod tests`, `mod workflow_instance` |
| Rust rstest フィクスチャ | `[対象の説明]`（日本語） | `fn システムロール() -> Role` |
| Elm テスト名 | 日本語で条件を明確に | `test "/ → Home"` |
| Hurl ファイル名 | snake_case 英語 | `submit_workflow.hurl` |
| Hurl セクション名 | 日本語コメント | `# 正常系: ワークフローを申請できる` |

ASCII プレフィクスの理由: `test_` の ASCII プレフィクスにより、関数名だけでテストを識別できる。grep や IDE のシンボル検索でも分類しやすい。フィクスチャは `#[fixture]` 属性で識別可能なため、プレフィクスは不要。rstest の引数名マッチング機構でプレフィクスが全呼び出し側に伝播し、テストコードの可読性を下げるため採用しない。

日本語命名の理由: テスト名は「仕様の文書化」であり、自然言語で書くことで可読性が高まる。Rust と Elm は日本語関数名をサポートしており、技術的制約はない。

### 3. テストコードの構造化方法

4つの手法を組み合わせて、テストの一覧性と可読性を向上させる。

#### 3.1 mod によるグルーピング

対象機能ごとに `mod` で分離する。ファイル内のテスト数が多い場合に有効。

```rust
#[cfg(test)]
mod tests {
    // Version のテスト

    #[test]
    fn test_バージョンの初期値は1() { /* ... */ }

    // DisplayNumber のテスト

    #[test]
    fn test_表示用連番0は無効() { /* ... */ }
}
```

#### 3.2 セクションコメント

正常系・異常系・境界値をコメントで区切る。統合テストファイルでは区切り線を使用する。

```rust
// ===== find_by_email テスト =====

#[sqlx::test(migrations = "../../migrations")]
async fn test_メールアドレスでユーザーを取得できる(pool: PgPool) { /* ... */ }

// ===== find_all_active_by_tenant テスト =====

#[sqlx::test(migrations = "../../migrations")]
async fn test_テナント内のアクティブユーザー一覧を取得できる(pool: PgPool) { /* ... */ }
```

Hurl では:

```hurl
# =============================================================================
# 正常系: 有効な認証情報でログインできる
# =============================================================================
# Given: シードデータの管理者ユーザーが存在する
# When: 正しいメールアドレスとパスワードでログインする
# Then: ユーザー情報とセッション Cookie が返される
```

#### 3.3 ファイル先頭のテスト目次

統合テストファイルの冒頭に doc コメントでテストケース一覧と実行方法を記載する。

```rust
//! UserRepository 統合テスト
//!
//! データベースを使用したテスト。sqlx::test マクロを使用して、
//! テストごとにトランザクションを作成しロールバックする。
//!
//! 実行方法:
//! ```bash
//! cd backend && cargo test -p ringiflow-infra --test user_repository_test
//! ```
```

ユニットテストでは、テスト数が少なければ目次は不要。

#### 3.4 AAA コメントの適用基準

AAA コメント（`// Arrange` / `// Act` / `// Assert`）は以下の場合に付与する:

- テストの意図がコードから明らかでない場合
- Arrange が複雑で Act との境界が不明瞭な場合
- レビュー時に構造を素早く把握したい場合

単純なテスト（数行で完結するもの）には不要。

### 4. 既存テストへの移行方針

段階的適用とし、一括移行は行わない。

| フェーズ | 対象 | タイミング |
|---------|------|-----------|
| Phase 0 | ADR のマージ | 即時 |
| Phase 1 | 新規テスト | 即時（本 ADR のルールに従って書く） |
| Phase 2 | 既存テストの漸進的適用 | 各機能実装時にボーイスカウトルールで改善 |
| Phase 3 | 一括適用（任意） | 必要に応じて専用 Issue を作成 |

Phase 2 の適用範囲: 変更対象のテストファイルのみ。無関係なファイルまで修正しない。

## 帰結

### 肯定的な影響

- テストの書き方に迷わなくなる: レイヤーごとに「こう書く」が明確
- テストファイルの一覧性が向上する: 目次・セクションコメントにより「何がテストされているか」を素早く把握可能
- 既存パターンの形式知化: 暗黙のルールが明文化され、一貫性が維持しやすくなる
- 段階的適用により、既存テストへの影響を最小限に抑えられる

### 否定的な影響・トレードオフ

- レイヤーごとに異なる表現形式（AAA / Given-When-Then）を使い分ける必要がある。ただし、差異は表現形式のみで構造化方法と命名規則は共通
- セクションコメントやテスト目次の維持コストが発生する。ただし、TDD のテストレビューステップ（#279 で導入済み）が自然な確認タイミングとなる
- cucumber-rs の学習機会を見送る。ただし、個人開発での実用性が低いため学習効果も限定的

### 関連ドキュメント

- Issue: [#106](https://github.com/ka2kama/ringiflow/issues/106)
- 要件定義: CORE-12（テストピラミッド）
- TDD 開発フロー: [`docs/04_手順書/04_開発フロー/02_TDD開発フロー.md`](../04_手順書/04_開発フロー/02_TDD開発フロー.md)
- API テストルール: [`.claude/rules/api-test.md`](../../.claude/rules/api-test.md)
- #279 PR: [#283](https://github.com/ka2kama/ringiflow/pull/283)（TDD テストと品質保証テストの区別）

---

## 変更履歴

| 日付 | 変更内容 |
|------|---------|
| 2026-02-07 | 初版作成 |
| 2026-02-08 | `fixture_` プレフィックスを削除。`#[fixture]` 属性で識別可能なため不要 |
