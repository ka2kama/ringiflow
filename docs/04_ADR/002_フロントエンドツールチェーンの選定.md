# ADR-002: フロントエンドツールチェーンの選定

## ステータス

承認済み（2026-01-14）

## コンテキスト

RingiFlow のフロントエンドは Elm で構築する。Elm の開発には以下のツールが必要:

- `elm`: Elm コンパイラ
- `elm-format`: コードフォーマッタ
- `elm-test`: テストランナー
- `vite` + `vite-plugin-elm`: ビルドツール

これらのツールをどのようにインストール・管理するかを決定する必要がある。

### 技術的制約

**elm npm パッケージの特性:**

elm, elm-format, elm-test の npm パッケージは、JavaScript ではなく**ネイティブバイナリ**を配布する。`postinstall` スクリプトで OS/アーキテクチャに応じたバイナリをダウンロードする仕組み。

**パッケージマネージャーごとの挙動の違い:**

| パッケージマネージャー | bin エントリの扱い | ネイティブバイナリ |
|----------------------|-------------------|------------------|
| npm | シンボリックリンク | 動作する |
| pnpm | Node.js シムスクリプト経由 | 動作しない |
| Bun | 直接リンク | 動作する |

pnpm は `node_modules/.bin/` にシムスクリプトを生成し、すべてのコマンドを `node` 経由で実行しようとする。これはネイティブバイナリには適用できず、`SyntaxError: Invalid or unexpected token` エラーが発生する。

## 検討した選択肢

### 選択肢 1: すべてローカルインストール（npm）

npm を使用し、elm 系ツールも `devDependencies` に含める。

評価:
- 利点: プロジェクト単位でバージョン固定、CI でも同じバージョンを使用
- 欠点: npm は pnpm/Bun より遅い、node_modules が肥大化

### 選択肢 2: すべてローカルインストール（pnpm）

pnpm を使用し、elm 系ツールも `devDependencies` に含める。

評価:
- 利点: ディスク効率が良い、高速
- 欠点: **elm のネイティブバイナリが動作しない**（技術的に不可能）

### 選択肢 3: elm 系はグローバル、ビルドツールはローカル

elm, elm-format, elm-test はグローバルインストールし、vite 等はローカルで管理。

評価:
- 利点: パッケージマネージャーに依存しない、どの PM でも動作
- 欠点: グローバルツールのバージョン管理が必要（mise 等で対応可能）

### 選択肢 4: すべてローカルインストール（Bun）

Bun を使用し、elm 系ツールも `devDependencies` に含める。

評価:
- 利点: 高速、ネイティブバイナリも動作する
- 欠点: Bun は比較的新しく、エコシステムの成熟度で npm に劣る

### 比較表

| 観点 | npm | pnpm | グローバル + ローカル | Bun |
|------|-----|------|---------------------|-----|
| elm 動作 | OK | NG | OK | OK |
| 速度 | 遅い | 速い | 速い | 最速 |
| ディスク効率 | 低い | 高い | 高い | 中 |
| PM 選択の自由度 | npm 固定 | 不可 | 自由 | Bun 固定 |
| バージョン管理 | package.json | - | mise 等 | package.json |
| 成熟度 | 高い | 高い | 高い | 中 |

## 決定

**選択肢 3: elm 系はグローバル、ビルドツールはローカル**を採用する。

理由:

1. パッケージマネージャー非依存: npm/pnpm/Bun いずれでも動作する柔軟性
2. 技術的制約の回避: pnpm のシムスクリプト問題を根本的に解決
3. バージョン管理は mise で対応: グローバルツールのバージョンは mise（または asdf）で管理可能

### パッケージマネージャーの選択

**ローカル依存の管理には pnpm を推奨**する。npm, Bun も選択可能だが、以下の比較に基づき pnpm を標準とする。

#### pnpm vs Bun 詳細比較

| 観点 | pnpm | Bun |
|------|------|-----|
| 成熟度 | 高（2017年〜、広く採用） | 発展中（2022年〜） |
| インストール速度 | 高速（npm比 2-3倍） | 非常に高速（npm比 10倍以上） |
| ディスク効率 | 優秀（ハードリンク共有） | 良好 |
| Vite 互換性 | 完全 | ほぼ完全（一部 edge case あり） |
| モノレポサポート | workspaces が成熟 | workspaces 対応済み |
| ドキュメント豊富さ | 非常に豊富 | 発展中 |
| CI/CD 安定性 | 高い | 概ね安定（まれに予期せぬ挙動） |
| エコシステム互換性 | ほぼ100% | 99%+（まれに非互換） |
| 本番運用実績 | 多数（Microsoft, Vue.js 等） | 増加中だが相対的に少ない |

#### pnpm を推奨する理由

1. 暗黙知ゼロの原則との整合性: pnpm はトラブルシューティング情報が豊富で、「文書だけで作業完遂」の観点で有利
2. エンタープライズ要件: 本番運用実績が多く、安定性・信頼性が高い
3. 学習の転用性: npm 互換の知識は他プロジェクトにも応用可能
4. Vite との相性: pnpm + Vite の組み合わせは十分高速で、Bun の速度優位性は限定的

#### Bun への切り替えを検討するトリガー

- CI/CD のインストール時間がボトルネックになった場合
- Bun の成熟度が向上し、エンタープライズ採用実績が十分に増えた場合
- Vite から Bun ネイティブのバンドラーに移行する場合

## 帰結

### 肯定的な影響

- パッケージマネージャーを自由に選択できる
- pnpm の高速性とディスク効率を活用できる
- CI 環境でも同様の構成で動作する

### 否定的な影響・トレードオフ

- グローバルツールのバージョン管理に mise 等が必要
- 新規参画者は elm のグローバルインストールが追加手順となる
- package.json だけでは elm のバージョンが明示されない（`.mise.toml` で管理）

### 関連ドキュメント

- 手順書: [`docs/03_手順書/01_開発参画/01_開発環境構築.md`](../03_手順書/01_開発参画/01_開発環境構築.md)

---

## 変更履歴

| 日付 | 変更内容 |
|------|---------|
| 2026-01-14 | 初版作成 |
| 2026-01-14 | pnpm vs Bun 詳細比較を追記 |
