# ADR-007: テナント退会時のデータ削除方針

## ステータス

承認済み

## コンテキスト

テナントが RingiFlow を退会する際、個人情報を含むデータの削除が必要になる。この際、以下の課題がある。

1. **Event Sourcing との衝突**: RingiFlow は Event Sourcing パターンを採用しており、イベントは原則として不変（Immutable）である。しかし、個人情報の完全削除要求と不変性は本質的に衝突する。

2. **「削除」の定義**: Crypto Shredding（暗号鍵削除による実質的なアクセス不能化）を「削除」とみなせるかは、顧客や法域によって解釈が異なる。エンタープライズ顧客から「物理的に消してくれ」と要求される可能性がある。

3. **複数データストアの整合性**: PostgreSQL、DynamoDB、S3、Redis など複数のデータストアに跨るデータを漏れなく削除する必要がある。

4. **将来の要件変化**: 契約時点では「匿名化で可」としていても、退会時に「やはり完全削除を」と要求されるケースがある。後から対応しようとすると大幅な改修が必要になる。

## 検討した選択肢

### 選択肢 1: Crypto Shredding（暗号鍵削除）

個人情報を含むデータは暗号化して保存し、削除時は暗号鍵のみを削除する。イベント自体は残るが、復号不可能になる。

評価:
- 利点: Event Sourcing の不変性を維持できる、イベントの連続性が保たれる
- 欠点: 物理的にデータは残るため「削除した」と言い切れない、顧客が納得しない可能性、将来暗号が破られるリスク

### 選択肢 2: テナント単位での物理削除

退会テナントのデータは物理的に削除する。Event Sourcing の不変性は「テナント単位では」破ることを許容する。

評価:
- 利点: 「完全に削除した」と言える、実装がシンプル、顧客対応が容易
- 欠点: Event Sourcing の原則に反する（ただしテナント単位なので他テナントには影響なし）

### 選択肢 3: イベントの匿名化（上書き）

削除対象の個人情報フィールドをマスク/ハッシュ化して上書きする。

評価:
- 利点: イベントの構造は維持される、因果関係は追える
- 欠点: Event Sourcing の不変性を破る、「データは残っている」ことに変わりない

### 選択肢 4: 個人情報の分離保存

個人情報を含むフィールドは Event Store とは別のテーブルに保存し、Event からは参照のみ。削除時は参照先のみ削除。

評価:
- 利点: Event Sourcing の不変性を維持できる
- 欠点: 設計が複雑化、既存設計の大幅変更が必要、パフォーマンス影響

### 比較表

| 観点 | Crypto Shredding | 物理削除 | 匿名化 | 分離保存 |
|------|-----------------|---------|--------|---------|
| 「完全削除」と言えるか | △ | ✅ | △ | ✅ |
| Event Sourcing 原則 | ✅ | △ | △ | ✅ |
| 実装の単純さ | ○ | ✅ | ✅ | ✗ |
| 顧客説明の容易さ | △ | ✅ | △ | ✅ |
| 既存設計への影響 | 中 | 小 | 小 | 大 |

## 決定

**選択肢 2: テナント単位での物理削除** を採用する。

主な理由:

1. **ビジネス要件優先**: エンタープライズ向け SaaS として、「完全に削除した」と顧客に明言できることは営業上・コンプライアンス上重要である。

2. **実害なし**: 退会テナントのイベントを将来再構築する必要はない。テナント単位で削除するため、残るテナントの Event Sourcing は影響を受けない。

3. **技術的純粋さより実用性**: Event Sourcing の不変性は重要な原則だが、「退会して二度と使わないデータ」に対してまでこの原則を守る実益がない。

他の選択肢を却下した理由:
- Crypto Shredding: 「データは残っている」という事実が顧客対応で問題になる可能性
- 匿名化: Crypto Shredding と同様の問題に加え、不変性も破る
- 分離保存: 既存設計への影響が大きく、複雑化するメリットが見合わない

## 帰結

### 肯定的な影響

- テナント退会時に「データを完全に削除しました」と言える
- 顧客からの「物理削除してほしい」という要求に対応可能
- 将来の法規制変更（GDPR 等）にも対応しやすい

### 否定的な影響・トレードオフ

- Event Sourcing の「不変性」原則を厳密には守れない（ただしテナント単位での削除なので、システム全体の整合性は維持される）
- すべてのデータストアで tenant_id による削除が可能な設計が必須となる
- 新規データストア追加時に削除処理の実装を忘れると漏れが発生するリスク

### 関連ドキュメント

- 設計書: [07_テナント退会時データ削除設計.md](../02_設計書/07_テナント退会時データ削除設計.md)
- 要件: [01_コア要件.md](../01_要件定義書/01_コア要件.md) - 4.8 データガバナンス・プライバシー要件

---

## 変更履歴

| 日付 | 変更内容 |
|------|---------|
| 2025-01-15 | 初版作成 |
