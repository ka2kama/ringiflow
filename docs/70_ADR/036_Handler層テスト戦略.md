# ADR-036: Handler 層テスト戦略

## ステータス

承認済み

## コンテキスト

Issue #291 のテストカバレッジ改善において、Handler 層（BFF / Core Service）にユニットテストを追加すべきか判断する必要がある。

現状:
- BFF Handler: ユニットテストなし。auth handler のみ統合テスト 12 件でカバー
- Core Service Handler: ユニットテストなし
- API テスト（Hurl）: 18 エンドポイント中 9 件カバー済み

## 検討した選択肢

### 選択肢 1: Handler 層にユニットテストを追加

各 Handler 関数に対してユニットテスト（Mock を使用）を作成する。

評価:
- 利点: Handler 単体のロジックを検証できる、テスト実行が高速
- 欠点: Handler が薄いプロキシの場合、テストの価値が低い。Mock のメンテナンスコストが発生

### 選択肢 2: API テスト（Hurl）で十分とする

Handler のユニットテストは追加せず、API テスト（Hurl）による E2E テストでカバーする。

評価:
- 利点: 実際のリクエスト/レスポンスを検証できる、セッション管理・CSRF・エラーマッピングを含めた E2E 検証、テストの保守コストが低い
- 欠点: テスト実行がやや遅い、障害の局所化が困難な場合がある

### 比較表

| 観点 | ユニットテスト追加 | API テスト（Hurl）で十分 |
|------|-------------------|------------------------|
| テスト対象 | Handler 関数単体 | リクエスト→レスポンスの E2E |
| テスト価値 | 薄いプロキシの場合は低い | セッション・CSRF 含めて高い |
| 保守コスト | Mock のメンテナンス必要 | 低い |
| 実行速度 | 高速 | やや遅い |

## 決定

Handler 層にユニットテストは追加しない。API テスト（Hurl）で十分とする。

理由:

1. BFF Handler は薄いプロキシ層: セッション取得 → Core Service クライアント呼び出し → レスポンスマッピング。テストすべきビジネスロジックが存在しない
2. Core Service Handler も同様: Usecase 呼び出し → DTO 変換。ビジネスロジックは Usecase 層に集約されている
3. API テスト（Hurl）でセッション管理・CSRF 検証・エラーマッピング・DTO 変換を含めた E2E 検証が可能で、ユニットテストよりも高い信頼性を提供する

## 帰結

### 肯定的な影響

- Mock のメンテナンスコストを回避できる
- API テストに注力することで、ユーザー視点でのテストカバレッジが向上する
- 既存の auth handler 統合テスト（12 件）のパターンが他の handler にも適用可能

### 否定的な影響・トレードオフ

- Handler 内のエッジケース（特殊なエラーマッピング等）の検証は API テスト依存になる
- API テストの実行にはサービス起動が必要で、フィードバックループがやや遅い

### 注意事項

この判断は Handler が「薄いプロキシ」であることが前提。Handler にビジネスロジックが増える場合は、この判断を見直す必要がある。

### 関連ドキュメント

- テスト突合表: `docs/50_テスト/APIテスト突合表.md`
- フォローアップ: #321 API テスト追加

---

## 変更履歴

| 日付 | 変更内容 |
|------|---------|
| 2026-02-08 | 初版作成（#291） |
