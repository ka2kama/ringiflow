# ADR-051: トランザクションコンテキストによる構造的強制

## ステータス

承認済み

## コンテキスト

ワークフローユースケース（approve, reject, request_changes, submit, resubmit, create）は複数リポジトリの書き込みメソッドを呼び出すが、各呼び出しは独立した DB 接続で実行されていた。中間状態で障害が発生するとデータ不整合が生じるリスクがある。

`.claude/rules/repository.md` にはトランザクション管理のルールが明記されていたが、全 6 ユースケースでルールが守られなかった。ルールの存在だけでは品質は保証されない。

Epic #685 の Story #687 として、型レベルでの構造的強制を導入する。

## 検討した選択肢

### 選択肢 A: Transaction 直接渡し

書き込みメソッドに `&mut Transaction<'static, Postgres>` を直接渡す。

評価:
- 利点: シンプル、sqlx の型をそのまま使用
- 欠点: sqlx の型がドメイン境界に露出する。テスト時に実際の DB 接続が必要

### 選択肢 B: Executor ジェネリクス

`E: sqlx::Executor<'_, Database = Postgres>` をジェネリクスで受ける。

評価:
- 利点: Pool も Transaction も受けられる柔軟性
- 欠点: `Arc<dyn Repository>` と非互換（ジェネリクスは trait object にできない）。Pool も渡せるため構造的強制にならない

### 選択肢 C: Unit of Work パターン

`UnitOfWork` trait で Transaction を抽象化する。

評価:
- 利点: DB 依存を完全に隠蔽
- 欠点: 抽象化層が増える。現時点では過剰

### 選択肢 D: A+C ハイブリッド（TxContext）

`TxContext` 型で Transaction をラップ（C 的）し、書き込みメソッドの必須引数とする（A 的）。

評価:
- 利点: 構造的強制（TxContext なしの書き込みはコンパイルエラー）。trait object 互換（`Arc<dyn Repository>` で使用可能）。Mock テストに対応（enum で Pg / Mock を切り替え）
- 欠点: 独自のラッパー型を導入する

## 決定

選択肢 D（A+C ハイブリッド: TxContext）を採用する。

構造的強制の要件（TxContext なしの書き込みをコンパイルエラーにする）を満たし、かつ `Arc<dyn Repository>` による trait object パターンとの互換性を維持できる唯一の選択肢。

### 設計の詳細

```rust
// TxContext: Transaction のラッパー（構造的強制）
pub struct TxContext(TxContextInner);

enum TxContextInner {
    Pg(Transaction<'static, Postgres>),
    #[cfg(any(test, feature = "test-utils"))]
    Mock,
}

// TransactionManager: ユースケース層の抽象化
pub trait TransactionManager: Send + Sync {
    async fn begin(&self) -> Result<TxContext, InfraError>;
}
```

可視性の設計:
- `begin_pg()`: `pub(crate)` — `PgTransactionManager` のみが使用
- `conn()`: `pub(crate)` — Postgres リポジトリ実装のみが使用
- `mock()`: `pub` — テストコードから直接呼び出し
- `commit()`: `pub` — ユースケース層から呼び出し

### スコープ

対象リポジトリ:
- `WorkflowStepRepository`: `insert`, `update_with_version_check`
- `WorkflowInstanceRepository`: `insert`, `update_with_version_check`

対象外:
- `WorkflowCommentRepository`（独立した書き込み操作）
- `UserRepository`, `RoleRepository` 等（将来の拡張で検討）
- 読み取りメソッド（トランザクション不要）

## 帰結

正の影響:
- トランザクションなしの書き込みがコンパイルエラーになる（構造的強制）
- ルール違反が型レベルで防止され、コードレビューに依存しない
- テストでは `TxContext::mock()` で軽量にテスト可能

負の影響:
- 書き込みメソッドの全呼び出し元を修正する必要がある（約 80 箇所）
- テストセットアップに `TxContext::mock()` の生成が追加される（拡張 trait で緩和）

## 参照

- Epic: #685
- Story: #687
- 関連: ADR-044（RLS 二重防御方針）
