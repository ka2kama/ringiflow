# ADR-060: テストダブル戦略と Handler 層テスト方針

## ステータス

承認済み

置換対象: [ADR-036](036_Handler層テスト戦略.md)

## コンテキスト

ADR-036 は「Handler 層にユニットテストは追加しない。API テスト（Hurl）で十分とする」と決定し、「Handler が薄いプロキシであること」を前提としていた。

しかし、以下の変化が発生した:

- auth handler にユーザー検索・権限集約のビジネスロジックが追加された
- workflow/folder/role/document/workflow_definition の各 handler にバリデーションヘルパーが追加された
- BFF handler にも auth/session/audit_log のテストが追加された

ADR-036 の注意事項にも「Handler にビジネスロジックが増える場合は、この判断を見直す必要がある」と記載されており、見直しの条件を満たした。

また、以下の 2 つの問題も同時に解決する:

1. テストダブルの命名不整合: `mock.rs` の実装は Fake（インメモリ実装 + 状態検証）だが Mock と命名されている。TDD 手順書の定義（Mock = 呼び出しを検証）と矛盾する
2. テスト学派の未明文化: プロジェクト全体で古典学派（状態検証）を一貫して採用しているが、意図的な設計判断として記録されていない

## 検討した選択肢

### Handler テスト方針

| 選択肢 | 評価 |
|--------|------|
| A: Handler テスト不要（ADR-036 維持） | 前提（薄いプロキシ）が崩れており、実態と乖離 |
| B: 条件付き追加（採用） | Handler の性質に応じて判断。実態とも整合 |
| C: 全 Handler にテスト追加 | 薄いプロキシの場合はコスト対効果が低い |

### テスト学派

| 選択肢 | 評価 |
|--------|------|
| A: 古典学派 / Detroit School（採用） | 状態検証。リファクタリング耐性が高い。Rust の trait ベース DI と自然に整合 |
| B: ロンドン学派 / London School | 相互作用検証。リファクタリングで内部の呼び出しパターンが変わるとテストが壊れる |

### テストダブルの命名

| 選択肢 | 評価 |
|--------|------|
| A: Mock のまま維持 | 業界慣行として通用するが、プロジェクト内の定義と矛盾 |
| B: Fake にリネーム（採用） | xUnit Patterns の分類に準拠。学習効果の最大化（プロジェクト理念） |

## 決定

### 1. Handler テスト方針

Handler にテストすべきロジックがある場合はハンドラテストを追加する。薄いプロキシの場合は API テスト（Hurl）に委譲する。

| Handler の性質 | テスト方針 |
|---------------|-----------|
| ビジネスロジックを含む（バリデーション、変換、権限集約等） | ハンドラテストを追加 |
| 薄いプロキシ（Usecase 呼び出し → DTO 変換のみ） | API テスト（Hurl）に委譲 |

### 2. テスト学派: 古典学派（Detroit School）

状態検証を基本とする。「結果がこうなっているか？」を検証し、「このメソッドが呼ばれたか？」は検証しない。

採用理由:

- Rust の trait ベース DI でレイヤーを分離し、Fake（インメモリ実装）で各層を独立にテストできる
- 状態検証はリファクタリング耐性が高い（内部実装の変更でテストが壊れにくい）
- t_wada の TDD 手法を参考としており、Kent Beck の古典学派の系譜に位置する
- Fake は実際のフィルタリング・挿入等の振る舞いを持ち、Stub より高い信頼性を提供する

### 3. テストダブルの使い分け

| 種類 | 定義 | 検証方法 | 用途 | 例 |
|------|------|---------|------|-----|
| Stub | 固定値を返す | — | テスト対象の依存を単純化 | `StubUserRepository`（handler テスト） |
| Fake | 簡易だが動作するインメモリ実装 | 状態検証 | Usecase テストで依存を差し替え | `FakeWorkflowInstanceRepository` |
| Mock | 呼び出しを記録し期待を検証 | 相互作用検証 | 原則不使用 | — |

Stub と Fake の選択基準:

| 基準 | Stub | Fake |
|------|------|------|
| テストが依存の振る舞いに関心があるか | なし（固定値で十分） | あり（フィルタリング、挿入等の動作が必要） |
| 複数テストでデータの状態変化を追跡するか | なし | あり |

### 4. テストダブルの命名規則

| 種類 | 命名パターン | 配置 |
|------|------------|------|
| Fake | `Fake` + 対象名 | `backend/crates/infra/src/fake.rs` |
| Stub | `Stub` + 対象名 | テストファイル内にローカル定義 |

## 帰結

### 肯定的な影響

- テストダブルの命名が xUnit Patterns の定義と一致し、学習効果が向上する
- Handler テストの追加基準が明確になり、判断に迷わなくなる
- テスト学派の選択が形式知化され、一貫性が保たれる

### 否定的な影響・トレードオフ

- `mock.rs` → `fake.rs`、`Mock*` → `Fake*` のリネームコスト（一度限り）
- 業界で広く使われる「Mock」との用語のずれ（ただし、正確な用語の方が教育的価値が高い）

### 関連ドキュメント

- テスト戦略概要: `docs/50_テスト/00_テスト戦略概要.md`
- TDD 開発フロー: `docs/60_手順書/04_開発フロー/02_TDD開発フロー.md`
- テスト突合表: `docs/50_テスト/APIテスト突合表.md`
- テストピラミッド: `docs/80_ナレッジベース/methodology/テストピラミッド.md`

### 参考文献

- Gerard Meszaros (2007) "xUnit Test Patterns" — テストダブルの分類（Stub, Mock, Fake, Spy, Dummy）
- Martin Fowler (2007) "Mocks Aren't Stubs" — 古典学派 vs ロンドン学派
- Kent Beck (2002) "Test-Driven Development: By Example" — 古典学派の原典
- Vladimir Khorikov (2020) "Unit Testing: Principles, Practices, and Patterns" — 古典学派 vs ロンドン学派の体系的比較

---

## 変更履歴

| 日付 | 変更内容 |
|------|---------|
| 2026-02-28 | 初版作成（#988） |
