# ADR-016: プリミティブ型の Newtype 化方針

## ステータス

承認済み

## コンテキスト

ドメインモデルにおいて、`String` や `i32` などのプリミティブ型が直接使用されている箇所があった。

```rust
// Before
pub struct User {
    name: String,           // 他の String フィールドと取り違え可能
    // ...
}

pub struct WorkflowDefinition {
    name: String,           // 同上
    version: i32,           // 負数も表現可能（不正状態）
    // ...
}
```

これにより以下の問題が生じていた:

1. **型の取り違えリスク**: `email` と `name` など、同じ `String` 型のフィールドを誤って渡してもコンパイルエラーにならない
2. **不正状態の表現可能性**: `version` が `i32` のため、負数やゼロが表現できてしまう
3. **意図の不明確さ**: 型シグネチャから「これはユーザー名である」という意図が読み取れない

プロジェクトの設計原則「型で表現できるものは型で表現する」「不正な状態を表現不可能にする」に従い、Newtype 化の方針を決定する必要があった。

## 検討した選択肢

### 選択肢 1: 全てのフィールドを Newtype 化

全ての `String` / 数値型フィールドを Newtype でラップする。

評価:
- 利点: 最大限の型安全性
- 欠点: ボイラープレートが大幅に増加、description 等の自由形式テキストまで型を作るのは過剰

### 選択肢 2: ドメイン的な意味を持つフィールドのみ Newtype 化

ID、名前、バージョンなど、ドメイン概念として意味を持つフィールドを Newtype 化。
description、comment などの自由形式テキストは `String` のまま残す。

評価:
- 利点: 型安全性と実装コストのバランスが取れる
- 欠点: 判断基準が必要（どこまでを「ドメイン的な意味を持つ」とするか）

### 選択肢 3: 現状維持（ID のみ Newtype）

既存の ID 型（UserId, TenantId 等）のみ Newtype とし、他は `String` / `i32` のまま。

評価:
- 利点: 追加の実装コストなし
- 欠点: 型安全性の向上が限定的

### 比較表

| 観点 | 全て Newtype 化 | 意味のある型のみ | 現状維持 |
|------|----------------|----------------|---------|
| 型安全性 | ◎ 最高 | ○ 高い | △ 限定的 |
| 実装コスト | × 高い | ○ 中程度 | ◎ なし |
| 保守性 | △ ボイラープレート多 | ○ 適切 | ○ シンプル |
| 設計原則との整合 | ◎ | ○ | × |

## 決定

選択肢 2「ドメイン的な意味を持つフィールドのみ Newtype 化」を採用する。

具体的な Newtype 化の基準:

| 対象 | Newtype 化 | 理由 |
|------|-----------|------|
| ID 型 | ○ 必須 | 取り違え防止が最重要 |
| 名前系（UserName, WorkflowName 等） | ○ 推奨 | ドメイン概念として意味を持つ |
| バージョン番号 | ○ 推奨 | 不正値（0、負数）を排除 |
| メール、パスワード | ○ 必須 | バリデーション・セキュリティ要件 |
| description, comment | × 不要 | 自由形式テキスト、バリデーション不要 |

## 帰結

### 肯定的な影響

- コンパイル時に型の取り違えを検出できる
- バージョン番号の不正値（0、負数）が型レベルで排除される
- 型シグネチャからドメインの意図が読み取れる
- 将来的なバリデーション追加が容易（Newtype の `new()` メソッドに追加するだけ）

### 否定的な影響・トレードオフ

- 若干のボイラープレートが増加（`UserName::new()`, `.as_str()` 等）
- インフラ層での型変換処理が必要（DB 取得時に `UserName::new()` を呼ぶ）
- 新しいドメイン概念追加時に Newtype 化の判断が必要

### 関連ドキュメント

- ナレッジベース: [Newtype パターン](../80_ナレッジベース/rust/Newtypeパターン.md)
- 実装: `backend/crates/domain/src/value_objects.rs`

---

## 変更履歴

| 日付 | 変更内容 |
|------|---------|
| 2026-01-18 | 初版作成 |
