# ADR-008: 環境変数ファイルの分離方針

## ステータス

承認済み（2026-01-15）

## コンテキスト

モノレポ構成のプロジェクトにおいて、環境変数（`.env`）ファイルをどのように管理するかを決定する必要がある。

現状、以下の3箇所に `.env.template` が存在する：

```
/.env.template           # Docker Compose 用
/apps/api/.env.template  # Rust バックエンド用
/apps/web/.env.template  # Vite フロントエンド用
```

これを一元化すべきか、分離を維持すべきかを検討した。

## 検討した選択肢

### 選択肢 1: ルートに一元化

```
/.env                    # すべての設定を集約
```

各アプリはプロジェクトルートの `.env` を参照する。

評価:
- 利点: 設定が一箇所で完結、値の重複がない
- 欠点: 各アプリが親ディレクトリを参照する必要がある、アプリ単体でのテストや実行がしづらい

### 選択肢 2: 各アプリごとに分離（現状維持）

```
/.env                    # Docker Compose 用
/apps/api/.env           # Rust 用
/apps/web/.env           # Vite 用
```

各アプリは自身のディレクトリの `.env` を参照する。

評価:
- 利点: 各アプリが独立して動作可能、モノレポの慣習に沿っている、責務が明確
- 欠点: 同じ値（例: BFF_PORT）が複数箇所に存在する可能性

### 選択肢 3: 設定ファイル（TOML/YAML）を使用

```
/config/default.toml     # 共通設定
/config/local.toml       # ローカル上書き
```

評価:
- 利点: 型安全な設定管理、コメントで意図を記述可能
- 欠点: 設定ライブラリの導入が必要、Docker Compose は `.env` を期待

### 比較表

| 観点 | 一元化 | 分離 | 設定ファイル |
|------|--------|------|-------------|
| 設定の重複 | なし | あり（一部） | なし |
| アプリの独立性 | 低い | 高い | 中程度 |
| 導入コスト | 中程度 | なし | 高い |
| モノレポ慣習 | 非標準 | 標準的 | 非標準 |
| 責務の明確さ | 曖昧 | 明確 | 明確 |

## 決定

**選択肢 2: 各アプリごとに分離**を採用する。

理由：

1. **責務の違い**: 各コンポーネントが必要とする設定は異なる
   - Docker: `POSTGRES_PORT`, `REDIS_PORT`
   - Rust: `DATABASE_URL`, `REDIS_URL`, `BFF_PORT`
   - Vite: `VITE_PORT`, `BFF_PORT`
   - 例えば、Elm/Vite は Docker のポート番号を知る必要がない

2. **独立性の維持**: 各アプリが単体でテスト・実行可能であることは、モノレポの利点を活かす上で重要

3. **慣習への準拠**: 多くのモノレポプロジェクトで採用されている標準的なパターン

## 帰結

### 肯定的な影響

- 各アプリが必要な設定のみを持ち、責務が明確
- アプリ単体での開発・テストが容易
- 新しいアプリを追加する際も、既存の設定に影響を与えない

### 否定的な影響・トレードオフ

- `BFF_PORT` のように複数箇所で必要な値は重複する
- ポート番号を変更する際は複数ファイルの更新が必要

### 緩和策

- `just setup-env` で全ての `.env` ファイルを一括作成
- ポート番号はデフォルト値をコードに持たず、`.env` 必須とすることで「どこを変更すべきか」を明確化

### 関連ドキュメント

- 実装: `/.env.template`, `/apps/api/.env.template`, `/apps/web/.env.template`
- 手順書: [02_プロジェクトセットアップ.md](../60_手順書/01_開発参画/02_プロジェクトセットアップ.md)

---

## 変更履歴

| 日付 | 変更内容 |
|------|---------|
| 2026-01-15 | 初版作成 |
