# ADR-059: 品質ゲートのローカル実行範囲変更

## ステータス

承認済み（2026-02-28）

## コンテキスト

品質ゲート（dev-flow-issue.md 6.1）では Ready for Review 前に `just check-all` の実行が必須だった。`just check-all` は lint + ユニットテスト + 統合テスト + API テスト + E2E テスト + セキュリティ監査をすべてローカルで逐次実行するため、10〜20 分かかる。

一方、CI（GitHub Actions）は同じテストを並列ジョブで実行し、wall clock 約 5 分で完了する。品質ゲートの 6.7（`gh pr checks --watch`）で CI の通過を確認するフローは既に存在しており、ローカルでの API テスト・E2E テストは CI と重複していた。

また、pre-push hook（lefthook）が `just check-pre-push`（lint + ユニットテスト + ビルド + 構造品質チェック、DB 不要）を自動実行しており、プッシュ前の基本的な品質チェックは担保されていた。

### 実行時間の比較

| チェック | ローカル実行時間 | CI 実行時間 |
|---------|----------------|-----------|
| `just check-pre-push` | ~1-2 分 | — |
| `just check` | ~3-5 分 | — |
| `just check-all` | ~10-20 分 | — |
| CI 全体（並列） | — | ~5 分 |

## 検討した選択肢

### 選択肢 1: 品質ゲートのローカル実行を `just check` に変更する

品質ゲートの必須ステップを `just check`（lint + ユニットテスト + 統合テスト + コード品質チェック）に変更する。API テスト・E2E テストは品質ゲートの必須ステップから外すが、関連する変更がある場合はローカルで個別に実行する。CI がフルスイートを網羅的に実行する。

利点:
- 品質ゲートの必須実行時間が 10-20 分 → 3-5 分に短縮
- CI の方がテスト環境が安定（release ビルド、クリーンな環境）
- 開発リズムの改善

欠点:
- 変更の影響範囲を見誤った場合、CI で初めて失敗を検出するラウンドトリップが発生

### 選択肢 2: 現状維持（`just check-all` をローカルで実行）

利点:
- push 前にすべての問題を検出できる

欠点:
- 10-20 分の待ち時間が開発リズムを阻害
- CI と重複した実行（ローカル逐次 + CI 並列）

### 選択肢 3: 品質ゲートのローカル実行を `just check-pre-push` に変更する

DB 不要の軽量チェックのみをローカルで実行し、統合テストも CI に委ねる。

利点:
- 最も高速（~1-2 分）

欠点:
- 統合テストの失敗もすべて CI 依存になり、ラウンドトリップが増加
- DB スキーマ変更のフィードバックが遅くなる

## 決定

選択肢 1: 品質ゲートのローカル実行を `just check` に変更する。

### 判断理由

- `just check` は統合テスト・SQLx チェック・スキーマチェックを含むため、DB 関連の問題はローカルで検出できる
- API テスト・E2E テストは CI の方が高速（並列実行）かつ安定（release ビルド、クリーンな環境）
- CI のフィードバック ~5 分は許容範囲
- pre-push hook で lint + ユニットテストは既に自動実行されている

### 品質ゲートの変更

| ステップ | 変更前 | 変更後 |
|---------|--------|--------|
| 6.1 自動チェック | `just check-all` | `just check` |
| 6.7 CI 確認 | `gh pr checks --watch` | `gh pr checks --watch`（変更なし、API/E2E の保証を担う） |

### テスト実行の責任分担

| テスト | 品質ゲート必須（`just check`） | 変更時にローカル実行 | CI |
|--------|-------------------------------|--------------------|----|
| lint（Rust, Elm, Shell, OpenAPI） | ✓ | — | ✓ |
| ユニットテスト | ✓ | — | ✓ |
| 統合テスト（DB 接続） | ✓ | — | ✓ |
| コード品質チェック | ✓ | — | ✓ |
| API テスト（hurl） | — | `just test-api` | ✓ |
| E2E テスト（Playwright） | — | `just test-e2e` | ✓ |
| セキュリティ監査（cargo deny） | — | — | ✓ |

API テスト・E2E テストは変更内容に応じてローカルで個別に実行する。品質ゲートの変更は必須ステップの範囲のみで、`just check-all` コマンドは引き続き使用可能。

## 帰結

正:
- 品質ゲートのローカル実行時間が 10-20 分 → 3-5 分に短縮される
- CI の並列実行を活用し、全体のフィードバック時間が改善される
- 開発リズムが向上する

負:
- 品質ゲートとして毎回実行しないため、API/E2E テストに関係する変更を見落とした場合、CI で初めて失敗を検出するラウンドトリップ（~5 分）が発生する

リスク軽減:
- 変更内容に応じて `just test-api` / `just test-e2e` をローカルで実行する
- CI の失敗は `gh pr checks --watch` で検出し、Ready for Review の前に修正する

## 関連

- [ADR-004: CI 並列化と変更検出](004_CI並列化と変更検出.md)
- [ADR-014: lefthook 導入](014_lefthook導入.md)
- Issue: #979
