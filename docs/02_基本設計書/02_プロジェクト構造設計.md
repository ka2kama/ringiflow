# RingiFlow プロジェクト構造設計

## 概要

本ドキュメントは、RingiFlow プロジェクトのリポジトリ構成、ディレクトリ構造、モジュール分割を定義する。

## リポジトリ構成

### 採用方式: モノレポ

```
ringiflow/
├── backend/                    # Rust バックエンド
├── frontend/                   # Elm フロントエンド
├── infra/                      # Terraform、Docker
├── docs/                       # ドキュメント
├── prompts/                    # AI セッション知識
└── process/                    # 開発プロセス知識
```

### 採用理由

| 観点 | モノレポのメリット |
|------|------------------|
| 学習効率 | 全体を一箇所で把握できる |
| 依存管理 | バージョン不整合が起きにくい |
| CI/CD | パイプラインが単純化 |
| リファクタリング | 横断的な変更が容易 |
| コードレビュー | 関連する変更をまとめて確認できる |

### トップレベルの設計判断

| 判断 | 理由 |
|------|------|
| `backend/` を切り出す | Rust コードが完結。Cargo.toml がトップを汚さない |
| `crates/` を使う | Rust の慣習に従う。中身が Rust だと自明 |
| `frontend/` 直下に Elm | YAGNI。モバイルアプリ追加時に再構成すればよい |

---

## 全体ディレクトリ構造

```
ringiflow/
├── .github/
│   └── workflows/
│       ├── ci.yaml              # CI パイプライン
│       └── cd.yaml              # CD パイプライン（将来）
│
├── backend/                    # Rust バックエンド
│   ├── Cargo.toml              # ワークスペース定義
│   ├── Cargo.lock
│   ├── rust-toolchain.toml
│   ├── .rustfmt.toml
│   ├── apps/                   # 実行可能バイナリ
│   │   ├── auth-service/      # Auth Service
│   │   ├── bff/               # BFF サービス
│   │   └── core-service/      # Core Service サービス
│   └── crates/                 # 共有ライブラリ
│       ├── domain/             # ドメイン層
│       ├── infra/              # インフラ層
│       └── shared/             # 共有ユーティリティ
│
├── frontend/                   # Elm フロントエンド
│   ├── elm.json
│   ├── src/
│   │   ├── Main.elm
│   │   ├── Pages/              # ページモジュール
│   │   ├── Components/         # UI コンポーネント
│   │   ├── Api/                # API クライアント
│   │   └── Ports.elm           # Ports 定義
│   ├── static/                 # 静的アセット
│   ├── js/                     # JavaScript（Ports ブリッジ）
│   └── tests/                  # elm-test
│
├── infra/
│   ├── terraform/
│   │   ├── environments/
│   │   │   ├── dev/
│   │   │   ├── stg/
│   │   │   └── prod/
│   │   └── modules/
│   └── docker/
│       └── docker-compose.yaml  # ローカル開発環境
│
├── docs/
│   ├── 01_要件定義書/
│   ├── 02_設計書/
│   └── 03_手順書/
│
├── tests/                     # 統合テスト
│   ├── api/                   # API テスト（Hurl）
│   └── e2e/                   # E2E テスト（Playwright）
│
├── prompts/                    # AI セッション知識
│   ├── plans/
│   ├── runs/
│   └── recipes/
│
├── process/                    # 開発プロセス知識
│   ├── improvements/
│   └── reports/
│
├── .gitignore
├── CLAUDE.md                   # Claude Code 用ガイダンス
├── README.md
└── justfile                    # タスクランナー
```

---

## Rust バックエンド構造

### Cargo Workspace 構成

BFF、Auth Service、Core Service は独立したサービスとして分離し、共有コードは `crates/` 配下で管理する。
`backend/` ディレクトリに Cargo Workspace を配置し、全クレートを一元管理する。

```toml
# backend/Cargo.toml
[workspace]
resolver = "2"
members = [
    "apps/auth-service",
    "apps/bff",
    "apps/core-service",
    "crates/domain",
    "crates/infra",
    "crates/shared",
]

[workspace.package]
version = "0.1.0"
edition = "2024"
license = "MIT"

[workspace.dependencies]
# 内部クレート
ringiflow-domain = { path = "crates/domain" }
ringiflow-infra = { path = "crates/infra" }
ringiflow-shared = { path = "crates/shared" }

# 主要な外部クレート（バージョンは Cargo.toml を参照）
# - axum: Web フレームワーク
# - tokio: 非同期ランタイム
# - sqlx: データベース（PostgreSQL）
# - redis: キャッシュ・セッション
# - serde: シリアライゼーション
# - tracing: ロギング・トレーシング
```

### サービス分離の意図

| 観点 | 説明 |
|------|------|
| 独立デプロイ | BFF と Core Service を別々にデプロイ可能 |
| サービス境界 | API 契約による明確な境界を学習 |
| スケーリング | 負荷特性に応じた個別スケーリング |
| 障害分離 | 片方の障害が他方に波及しにくい |

### クレート構成図

```mermaid
graph TB
    subgraph "backend/apps/"
        AuthService["apps/auth-service<br/>Auth Service"]
        BFF["apps/bff<br/>BFF サービス"]
        CoreService["apps/core-service<br/>Core Service サービス"]
    end

    subgraph "backend/crates/"
        Domain["crates/domain<br/>ドメイン層"]
        Infra["crates/infra<br/>インフラ層"]
        Shared["crates/shared<br/>共有ユーティリティ"]
    end

    BFF -->|HTTP| AuthService
    BFF -->|HTTP| CoreService
    BFF --> Shared

    AuthService --> Domain
    AuthService --> Infra
    AuthService --> Shared

    CoreService --> Domain
    CoreService --> Infra
    CoreService --> Shared

    Domain --> Shared
    Infra --> Domain
    Infra --> Shared
```

### レイヤー依存関係と依存性逆転の原則

クレート間の依存方向は「外側から内側へ」を原則とする。
依存性逆転の詳細はナレッジベースを参照。

→ [Cargo Workspace と依存性逆転](../06_ナレッジベース/rust/Cargoワークスペース.md)

```
apps (api)
    ↓ 依存
crates/infra
    ↓ 依存
crates/domain
    ↓ 依存
crates/shared
```

| クレート | 役割 | 依存先 |
|---------|------|--------|
| `shared` | 共通ユーティリティ | なし（最も内側） |
| `domain` | エンティティ、trait 定義 | `shared` のみ |
| `infra` | trait 実装、外部連携 | `domain`, `shared` |
| `api` | HTTP ハンドラ、DI | 全クレート |

**重要: domain は infra に依存しない（依存性逆転の原則）**

### 各クレートの責務

#### `bff` - BFF サービス

```
backend/apps/bff/
├── Cargo.toml
├── src/
│   ├── lib.rs
│   ├── main.rs                 # エントリーポイント
│   ├── config.rs               # 設定
│   ├── routes/                 # ルーティング
│   │   ├── mod.rs
│   │   ├── auth.rs             # 認証エンドポイント
│   │   └── api.rs              # Core Service プロキシ
│   ├── middleware/             # ミドルウェア
│   │   ├── mod.rs
│   │   ├── session.rs          # セッション管理
│   │   ├── csrf.rs             # CSRF 防御
│   │   └── request_id.rs       # リクエストID付与
│   ├── session/                # セッション
│   │   ├── mod.rs
│   │   └── redis_store.rs
│   ├── client/                 # Core Service クライアント
│   │   └── core_api.rs
│   └── error.rs                # エラーハンドリング
└── tests/                      # 統合テスト
```

責務:
- セッション管理（HTTPOnly Cookie + Redis）
- CSRF 防御
- Core Service へのプロキシ
- セキュリティヘッダ付与
- レート制限

#### `core-service` - Core Service サービス

```
backend/apps/core-service/
├── Cargo.toml
├── src/
│   ├── lib.rs
│   ├── main.rs                 # エントリーポイント
│   ├── config.rs               # 設定
│   ├── routes/                 # ルーティング
│   │   ├── mod.rs
│   │   ├── workflows.rs        # ワークフロー API
│   │   ├── tasks.rs            # タスク API
│   │   ├── users.rs            # ユーザー API
│   │   └── health.rs           # ヘルスチェック
│   ├── handlers/               # リクエストハンドラ
│   │   ├── mod.rs
│   │   ├── workflow_handler.rs
│   │   └── task_handler.rs
│   ├── middleware/             # ミドルウェア
│   │   ├── mod.rs
│   │   ├── auth.rs             # 認証検証
│   │   └── tenant.rs           # テナントコンテキスト
│   └── error.rs                # エラーハンドリング
├── migrations/                 # SQLx マイグレーション
└── tests/                      # 統合テスト
```

責務:
- ビジネスロジックの実行
- ドメイン層の呼び出し
- 認可チェック

#### `auth-service` - Auth Service

```
backend/apps/auth-service/
├── Cargo.toml
└── src/
    ├── main.rs                 # エントリーポイント
    ├── config.rs               # 設定
    ├── handler.rs              # ハンドラモジュール
    │   ├── auth.rs             # 認証エンドポイント
    │   └── health.rs           # ヘルスチェック
    ├── usecase.rs              # ユースケースモジュール
    │   └── auth.rs             # 認証ユースケース
    └── error.rs                # エラーハンドリング
```

責務:
- パスワード認証（資格情報の検証）
- 資格情報管理

#### `domain` - ドメイン層（共有パッケージ）

```
backend/crates/domain/
├── Cargo.toml
└── src/
    ├── lib.rs
    ├── entities/               # エンティティ
    │   ├── mod.rs
    │   ├── user.rs
    │   ├── tenant.rs
    │   ├── workflow.rs
    │   ├── workflow_definition.rs
    │   └── task.rs
    ├── value_objects/          # 値オブジェクト
    │   ├── mod.rs
    │   ├── email.rs
    │   ├── workflow_status.rs
    │   └── task_status.rs
    ├── services/               # ドメインサービス
    │   ├── mod.rs
    │   ├── workflow_service.rs
    │   └── auth_service.rs
    ├── repositories/           # リポジトリインターフェース
    │   ├── mod.rs
    │   ├── user_repository.rs
    │   ├── workflow_repository.rs
    │   └── task_repository.rs
    ├── events/                 # ドメインイベント（Phase 4）
    │   └── mod.rs
    └── errors.rs               # ドメインエラー
```

責務:
- ビジネスルールの定義
- エンティティ・値オブジェクトの定義
- リポジトリインターフェースの定義

#### `infra` - インフラ層（共有パッケージ）

```
backend/crates/infra/
├── Cargo.toml
├── src/
│   ├── lib.rs                      # パブリックインターフェース
│   ├── db.rs                       # PostgreSQL 接続管理
│   ├── dynamodb.rs                 # DynamoDB 接続管理
│   ├── s3.rs                       # S3 接続管理（Presigned URL 生成）
│   ├── redis.rs                    # Redis 接続管理
│   ├── session.rs                  # セッション管理
│   ├── password.rs                 # パスワード検証（Argon2）
│   ├── deletion/                   # テナント退会時データ削除
│   │   ├── mod.rs                  # モジュール定義
│   │   ├── registry.rs             # 削除レジストリ
│   │   └── s3_document.rs          # S3 ドキュメント削除
│   ├── error.rs                    # インフラ層エラー定義
│   ├── mock.rs                     # テスト用 Mock 実装
│   ├── repository.rs               # リポジトリトレイト定義・再エクスポート
│   └── repository/                 # リポジトリ実装
│       ├── user_repository.rs      # PostgreSQL: ユーザー
│       ├── tenant_repository.rs    # PostgreSQL: テナント
│       ├── role_repository.rs      # PostgreSQL: ロール
│       ├── workflow_definition_repository.rs   # PostgreSQL
│       ├── workflow_instance_repository.rs     # PostgreSQL
│       ├── workflow_step_repository.rs         # PostgreSQL
│       ├── display_id_counter_repository.rs    # PostgreSQL
│       ├── credentials_repository.rs           # PostgreSQL: 認証情報
│       └── audit_log_repository.rs             # DynamoDB: 監査ログ
└── tests/                          # 統合テスト
    ├── user_repository_test.rs
    ├── role_repository_test.rs
    ├── audit_log_repository_test.rs
    ├── dynamodb_test.rs
    ├── s3_test.rs
    ├── deletion_registry_test.rs
    └── ...
```

責務:
- リポジトリの実装（PostgreSQL / DynamoDB）
- データベース接続管理（PostgreSQL, DynamoDB）
- S3 操作（Presigned URL 生成、オブジェクト確認）
- キャッシュ操作（Redis）
- セッション管理
- パスワード暗号化・検証
- テナント退会時データ削除

#### `shared` - 共有ユーティリティ（共有パッケージ）

```
backend/crates/shared/
├── Cargo.toml
└── src/
    ├── lib.rs
    ├── config.rs               # 設定読み込み
    ├── telemetry.rs            # ロギング・トレーシング設定
    ├── error.rs                # 共通エラー型
    └── types.rs                # 共通型定義
```

責務:
- クレート横断で使用するユーティリティ
- 設定管理
- ロギング・トレーシング初期化

---

## Elm フロントエンド構造

```
frontend/
├── elm.json
├── src/
│   ├── Main.elm                # エントリーポイント
│   ├── Route.elm               # ルーティング定義
│   ├── Shared.elm              # 共有状態
│   │
│   ├── Pages/                  # ページモジュール
│   │   ├── Home.elm            # ダッシュボード
│   │   ├── Login.elm           # ログイン
│   │   ├── Workflow/
│   │   │   ├── List.elm        # ワークフロー一覧
│   │   │   ├── Detail.elm      # ワークフロー詳細
│   │   │   └── New.elm         # ワークフロー申請
│   │   ├── Task/
│   │   │   ├── List.elm        # タスク一覧
│   │   │   └── Detail.elm      # タスク詳細
│   │   └── NotFound.elm        # 404
│   │
│   ├── Components/             # 再利用可能コンポーネント
│   │   ├── Header.elm
│   │   ├── Sidebar.elm
│   │   ├── Button.elm
│   │   ├── Form.elm
│   │   ├── Table.elm
│   │   └── Modal.elm
│   │
│   ├── Api/                    # API クライアント
│   │   ├── Api.elm             # 共通処理
│   │   ├── Endpoint.elm        # エンドポイント定義
│   │   ├── Workflow.elm        # ワークフロー API
│   │   ├── Task.elm            # タスク API
│   │   └── Auth.elm            # 認証 API
│   │
│   ├── Data/                   # データモデル
│   │   ├── User.elm
│   │   ├── Workflow.elm
│   │   └── Task.elm
│   │
│   └── Ports.elm               # Ports 定義
│
├── js/
│   ├── main.js                 # Elm 初期化
│   └── ports/
│       └── index.js            # Ports ブリッジ
│
├── static/
│   ├── index.html
│   └── styles/
│       └── main.css
│
├── tests/                      # elm-test
│   └── ...
│
├── vite.config.js              # Vite 設定
└── package.json
```

### Elm モジュール構成図

```mermaid
graph TB
    subgraph Entry
        Main["Main.elm"]
    end

    subgraph Pages
        Home["Pages/Home"]
        Login["Pages/Login"]
        WFList["Pages/Workflow/List"]
        WFDetail["Pages/Workflow/Detail"]
        TaskList["Pages/Task/List"]
    end

    subgraph SharedModules["Shared"]
        Route["Route"]
        SharedState["Shared"]
        Components["Components/*"]
        Api["Api/*"]
        Data["Data/*"]
        Ports["Ports"]
    end

    Main --> Route
    Main --> SharedState
    Main --> Home
    Main --> Login
    Main --> WFList
    Main --> WFDetail
    Main --> TaskList

    Home --> Components
    Home --> Api
    Home --> Data

    WFList --> Components
    WFList --> Api
    WFList --> Data

    Api --> Ports
```

---

## Terraform 構造

```
infra/terraform/
├── environments/
│   ├── dev/
│   │   ├── main.tf
│   │   ├── variables.tf
│   │   ├── outputs.tf
│   │   └── terraform.tfvars
│   ├── stg/
│   │   └── ...
│   └── prod/
│       └── ...
│
├── modules/
│   ├── vpc/
│   │   ├── main.tf
│   │   ├── variables.tf
│   │   └── outputs.tf
│   ├── ecs/
│   │   └── ...
│   ├── rds/
│   │   └── ...
│   ├── elasticache/
│   │   └── ...
│   ├── s3/
│   │   └── ...
│   ├── alb/
│   │   └── ...
│   └── cloudfront/
│       └── ...
│
└── shared/
    └── backend.tf              # S3 バックエンド設定
```

### Terraform 設計意図

環境分離（environments/）:
- `dev`, `stg`, `prod` を完全に分離
- 同じモジュールを異なるパラメータで再利用
- State ファイルは環境ごとに分離（誤って本番を変更するリスクを軽減）

モジュール化（modules/）:
- 再利用可能なリソース定義を配置
- 環境間での一貫性を保証
- 変更の影響範囲を限定（vpc を変更しても ecs に影響しない）

State 管理（S3 + DynamoDB）:
- State ファイルを S3 に保存（ローカルに持たない）
- DynamoDB で State ロック（チーム開発での競合防止）
- S3 バージョニングで State の履歴を保持（誤操作からの復旧）

```hcl
# environments/dev/backend.tf
terraform {
  backend "s3" {
    bucket         = "ringiflow-terraform-state-{account-id}"
    key            = "dev/terraform.tfstate"  # 環境ごとに異なるキー
    region         = "ap-northeast-1"
    dynamodb_table = "ringiflow-terraform-lock"
    encrypt        = true
  }
}
```

この設計の利点:
- 環境ごとに独立して変更可能
- 本番への影響を最小化
- チーム開発で State の競合が発生しない

---

## Docker 構成

```
infra/docker/
├── docker-compose.yaml    # ローカル開発用依存サービス
└── init/
    └── 01_extensions.sql # PostgreSQL 初期化スクリプト
```

### Docker 設計意図

ローカル開発環境の統一:
- 「自分の環境では動く」問題を防止
- 依存サービス（PostgreSQL, Redis）のバージョンを固定
- チームメンバー間で同一環境を保証

サービス構成:

| サービス | イメージ | ポート | 用途 |
|---------|---------|--------|------|
| postgres | postgres:17-alpine | 5432 | メインデータベース |
| redis | redis:7-alpine | 6379 | キャッシュ・セッション |

設計判断:
- Alpine イメージ採用（軽量、セキュリティ更新が速い）
- Healthcheck 設定（起動完了検知、CI での順序保証）
- 名前付きボリューム（データ永続化）

---

## 開発ワークフロー

### ローカル開発

```mermaid
sequenceDiagram
    participant Dev as 開発者
    participant Docker as Docker Compose
    participant BFF as BFF
    participant Core as Core Service
    participant Web as Elm Web
    participant DB as PostgreSQL
    participant Cache as Redis

    Dev->>Docker: docker compose up -d
    Docker->>DB: 起動
    Docker->>Cache: 起動

    Dev->>Core: just dev-core-service
    Core->>DB: 接続

    Dev->>BFF: just dev-bff
    BFF->>Cache: 接続
    BFF->>Core: HTTP 通信

    Dev->>Web: just dev-web
    Web->>BFF: API リクエスト
```

### justfile タスク

```just
# 依存サービスの起動
dev-deps:
    docker compose -f infra/docker/docker-compose.yaml up -d

# BFF の起動（ポート 3000）
dev-bff:
    cd backend && cargo run -p ringiflow-bff

# Core Service の起動（ポート 3001）
dev-core-service:
    cd backend && cargo run -p ringiflow-core-service

# フロントエンドの起動
dev-web:
    cd frontend && pnpm run dev

# テスト実行
test:
    cd backend && cargo test --all-features
    cd frontend && pnpm run test

# リント
lint:
    cd backend && cargo fmt --check
    cd backend && cargo clippy --workspace
    cd frontend && pnpm run format:check

# ビルド
build:
    cd backend && cargo build --release
    cd frontend && pnpm run build
```

---

## 命名規則

### Rust

| 種別 | 規則 | 例 |
|------|------|-----|
| クレート名 | kebab-case | `core-service`, `ringiflow-domain` |
| モジュール名 | snake_case | `workflow_service` |
| 構造体/列挙型 | PascalCase | `Workflow`, `TaskStatus` |
| 関数/メソッド | snake_case | `create_workflow` |
| 定数 | SCREAMING_SNAKE_CASE | `MAX_RETRY_COUNT` |

### Elm

| 種別 | 規則 | 例 |
|------|------|-----|
| モジュール名 | PascalCase | `Pages.Workflow.List` |
| 型名 | PascalCase | `Workflow`, `Model` |
| 関数名 | camelCase | `viewWorkflowList` |
| メッセージ型 | PascalCase | `GotWorkflows`, `ClickedApprove` |

### ファイル・ディレクトリ

| 種別 | 規則 | 例 |
|------|------|-----|
| Rust ファイル | snake_case | `workflow_service.rs` |
| Elm ファイル | PascalCase | `WorkflowList.elm` |
| ディレクトリ | 小文字またはPascalCase | `routes/`, `Pages/` |
| ドキュメント | 日本語可、連番プレフィックス | `01_プロジェクト構造設計.md` |

---

## 変更履歴

| 日付 | 変更内容 | 担当 |
|------|---------|------|
| 2026-02-07 | Auth Service を追加（ディレクトリ構造、Cargo.toml、クレート構成図、責務セクション） | - |
| 2026-01-16 | backend/frontend 分離構成に変更 | - |
| 2026-01-12 | 初版作成 | - |
