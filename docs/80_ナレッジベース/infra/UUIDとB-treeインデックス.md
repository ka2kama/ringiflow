# UUID と B-tree インデックス

## 概要

UUID を主キーとして使用する場合、バージョンの選択がデータベースのパフォーマンスに影響する。本ノートでは UUID v4 と v7 の構造的な違いと、B-tree インデックスへの影響を解説する。

## UUID のバージョン別構造

### UUID v4（ランダム）

```
UUID v4 構造 (128bit):
┌────────────────────────────────────────────────────────┐
│ Random (122bit) + Version (4bit) + Variant (2bit)      │
└────────────────────────────────────────────────────────┘
例: 550e8400-e29b-41d4-a716-446655440000
```

- 122 ビットがランダム
- 生成順序と値に相関なし
- 衝突確率: 約 2^61 回生成で 50%（実質ゼロ）

### UUID v7（タイムスタンプ + ランダム）

```
UUID v7 構造 (128bit):
┌───────────────────┬────┬──┬─────────────────────────────┐
│ Timestamp (48bit) │ Ver│Va│ Random (74bit)              │
│ ミリ秒精度         │ 4b │2b│                             │
└───────────────────┴────┴──┴─────────────────────────────┘
例: 018e5e6c-7f5a-7b3d-8f1a-2b3c4d5e6f7a
    ^^^^^^^^ ← タイムスタンプ部分
```

- 先頭 48 ビットがミリ秒タイムスタンプ
- 生成順でソート可能
- RFC 9562（2024年5月標準化）

## B-tree インデックスへの影響

### B-tree の基本動作

B-tree は「隣接するキーを同じページに格納」することで効率を得る。

```
理想的な挿入（シーケンシャル）:
┌─────────────────────────────────────┐
│ Page 1: [1, 2, 3, 4, 5]             │  ← 末尾追記
│ Page 2: [6, 7, 8, 9, 10]            │
│ Page 3: [11, 12, ...]               │
└─────────────────────────────────────┘
```

### UUID v4 の問題

ランダムな値の挿入は、木構造全体に散らばる。

```
UUID v4 の挿入パターン:
┌─────────────────────────────────────┐
│ Page 1: [0a1b..., 2c3d..., 8e9f...]│  ← 隙間に挿入
│ Page 2: [1f2g..., 5h6i..., 9j0k...]│  ← ページ分割発生
│ Page 3: [3l4m..., 7n8o..., ...]    │
└─────────────────────────────────────┘

結果:
- ページ分割が頻発
- インデックスの断片化
- キャッシュ効率の悪化
```

### UUID v7 の改善

タイムスタンプにより、ほぼシーケンシャルな挿入になる。

```
UUID v7 の挿入パターン:
┌─────────────────────────────────────┐
│ Page 1: [018e5e6c..., 018e5e6d...]  │  ← 時系列順
│ Page 2: [018e5e6e..., 018e5e6f...]  │  ← ほぼ末尾追記
│ Page 3: [018e5e70..., ...]          │
└─────────────────────────────────────┘

結果:
- ページ分割が最小限
- 断片化を抑制
- キャッシュ効率が良い
```

## 使い分けの指針

| テーブル特性 | 推奨 UUID | 理由 |
|-------------|----------|------|
| 高頻度挿入（運用データ） | v7 | B-tree 効率、ソート可能 |
| 低頻度挿入（マスタデータ） | v4 | 問題が顕在化しにくい |
| 作成時刻を隠したい | v4 | v7 はタイムスタンプを含む |
| Event Sourcing のイベント | v7 | 時系列順序が重要 |

## セキュリティ考慮事項

### UUID v7 のタイムスタンプ漏洩

UUID v7 から作成時刻が推測可能。

| リスク | 評価 | 対策 |
|--------|------|------|
| 作成時刻の推測 | 低〜中 | `created_at` を返す設計なら同等 |
| 列挙攻撃 | 極低 | 74bit ランダム部で実質不可能 |
| 認可バイパス | なし | ID の知識と認可は独立 |

**結論:** API で `created_at` を返す設計であれば、UUID v7 のタイムスタンプ漏洩は許容範囲。

## 代替パターン: BIGSERIAL + UUID

内部 ID と外部公開 ID を分離するパターン。

```sql
CREATE TABLE entities (
    id BIGSERIAL PRIMARY KEY,           -- 内部用（FK、JOIN）
    public_id UUID NOT NULL UNIQUE,     -- 外部公開用（API、URL）
    ...
);
```

| 観点 | UUID のみ | BIGSERIAL + UUID |
|------|----------|------------------|
| B-tree 効率 | v7 でほぼ解決 | 最高 |
| JOIN 性能 | 16 bytes | 8 bytes（高速） |
| 設計のシンプルさ | ○ | △（2つの ID 体系） |
| 分散生成 | ○ | △（auto increment は単一 DB 依存） |

**採用判断:** 想定規模と分散システム要件を考慮して選択する。

## RingiFlow での採用

| 用途 | UUID バージョン | 対象 |
|------|----------------|------|
| 参照系（マスタ） | v4 | tenants, users, roles, workflow_definitions |
| 時系列系（運用） | v7 | workflow_instances, workflow_steps, events |

詳細: [ADR-001: ID 形式の選定](../../70_ADR/001_ID形式の選定.md)

## 参考資料

- [RFC 9562 - Universally Unique IDentifiers (UUIDs)](https://www.rfc-editor.org/rfc/rfc9562.html)
- [PostgreSQL UUID Type](https://www.postgresql.org/docs/current/datatype-uuid.html)

---

## 変更履歴

| 日付 | 変更内容 |
|------|---------|
| 2026-01-17 | 初版作成 |
