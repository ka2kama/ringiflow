# 認証機能 実装解説

## 対応 Issue

[#34 ユーザー認証（ログイン/ログアウト）](https://github.com/ka2kama/ringiflow/issues/34)

## 機能概要

メール/パスワードでのログイン・ログアウト機能を実装する。

### 完了基準

- [x] POST /auth/login でログインできる
- [x] POST /auth/logout でログアウトできる
- [x] GET /auth/me で現在のユーザー情報を取得できる
- [x] GET /auth/csrf で CSRF トークンを取得できる
- [x] CSRF トークンによる保護が機能する

## アーキテクチャ

```mermaid
sequenceDiagram
    participant Browser as ブラウザ
    participant BFF as BFF
    participant Core as Core Service
    participant DB as PostgreSQL
    participant Redis as Redis

    Browser->>BFF: POST /auth/login
    BFF->>Core: POST /internal/auth/verify
    Core->>DB: ユーザー検索 + パスワード検証
    Core-->>BFF: UserWithRoles
    BFF->>Redis: セッション保存
    BFF-->>Browser: Set-Cookie + UserResponse
```

### 責務分担

| レイヤー | 責務 |
|---------|------|
| **BFF** | セッション管理、Cookie 処理、CSRF 防御 |
| **Core Service** | パスワード検証、ユーザー情報取得 |
| **Redis** | セッションストア |
| **PostgreSQL** | ユーザー永続化 |

## 実装フェーズ

| Phase | 内容 | 状態 |
|-------|------|------|
| [Phase 1](01_Phase1_UserRepository.md) | UserRepository | 完了 |
| [Phase 2](02_Phase2_PasswordHasher.md) | PasswordChecker | 完了 |
| [Phase 3](03_Phase3_SessionManager.md) | SessionManager | 完了 |
| [Phase 4](04_Phase4_CoreServiceエンドポイント.md) | Core Service エンドポイント | 完了 |
| [Phase 5](05_Phase5_BFF認証ハンドラ.md) | BFF ハンドラ | 完了 |
| [Phase 6](06_Phase6_統合テスト.md) | 統合テスト | 完了 |
| [Phase 7](07_Phase7_CSRFトークン.md) | CSRF トークン | 完了 |

## 関連ドキュメント

- 設計書: [07_認証機能設計.md](../../03_詳細設計書/07_認証機能設計.md)
- 技術ノート: [エンタープライズ認証とID管理.md](../../06_技術ノート/エンタープライズ認証とID管理.md)
