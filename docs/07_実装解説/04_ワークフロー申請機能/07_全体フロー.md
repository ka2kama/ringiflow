# ワークフロー申請機能 - 全体フロー

## 概要

このドキュメントでは、ワークフロー申請機能の全体的なデータフローと、各レイヤーのファイル・関数の連携を解説する。

---

## アーキテクチャ概観

```mermaid
flowchart TB
    subgraph Frontend ["Frontend (Elm)"]
        Browser["ブラウザ"]
    end

    subgraph BFF ["BFF (backend/apps/bff)"]
        BFFHandler["handler/workflow.rs"]
        BFFClient["client/core_service.rs"]
        SessionMgr["SessionManager"]
    end

    subgraph Core ["Core Service (backend/apps/core-service)"]
        CoreHandler["handler/workflow.rs"]
        UseCase["usecase/workflow.rs"]
    end

    subgraph Infra ["Infrastructure (backend/crates/infra)"]
        DefRepo["WorkflowDefinitionRepository"]
        InstRepo["WorkflowInstanceRepository"]
        StepRepo["WorkflowStepRepository"]
    end

    subgraph DB ["PostgreSQL"]
        DefTable["workflow_definitions"]
        InstTable["workflow_instances"]
        StepTable["workflow_steps"]
    end

    Browser -->|"POST /api/v1/workflows"| BFFHandler
    BFFHandler --> SessionMgr
    BFFHandler --> BFFClient
    BFFClient -->|"POST /internal/workflows"| CoreHandler
    CoreHandler --> UseCase
    UseCase --> DefRepo
    UseCase --> InstRepo
    UseCase --> StepRepo
    DefRepo --> DefTable
    InstRepo --> InstTable
    StepRepo --> StepTable
```

---

## 主要コンポーネント一覧

### BFF 層

| ファイル | 責務 |
|---------|------|
| [`backend/apps/bff/src/handler/workflow.rs`](../../../backend/apps/bff/src/handler/workflow.rs) | 公開 API ハンドラ。セッション検証、Core Service 呼び出し |
| [`backend/apps/bff/src/client/core_service.rs`](../../../backend/apps/bff/src/client/core_service.rs) | Core Service への HTTP クライアント |
| [`backend/apps/bff/src/main.rs`](../../../backend/apps/bff/src/main.rs) | ルーティング定義 |

### Core Service 層

| ファイル | 責務 |
|---------|------|
| [`backend/apps/core-service/src/handler/workflow.rs`](../../../backend/apps/core-service/src/handler/workflow.rs) | 内部 API ハンドラ。リクエスト変換、UseCase 呼び出し |
| [`backend/apps/core-service/src/usecase/workflow.rs`](../../../backend/apps/core-service/src/usecase/workflow.rs) | ビジネスロジック。ワークフロー作成・申請処理 |
| [`backend/apps/core-service/src/error.rs`](../../../backend/apps/core-service/src/error.rs) | エラー型定義。RFC 7807 変換 |
| [`backend/apps/core-service/src/main.rs`](../../../backend/apps/core-service/src/main.rs) | ルーティング定義、DI 設定 |

### Infrastructure 層

| ファイル | 責務 |
|---------|------|
| [`backend/crates/infra/src/repository/workflow_definition_repository.rs`](../../../backend/crates/infra/src/repository/workflow_definition_repository.rs) | ワークフロー定義の永続化 |
| [`backend/crates/infra/src/repository/workflow_instance_repository.rs`](../../../backend/crates/infra/src/repository/workflow_instance_repository.rs) | ワークフローインスタンスの永続化 |
| [`backend/crates/infra/src/repository/workflow_step_repository.rs`](../../../backend/crates/infra/src/repository/workflow_step_repository.rs) | 承認ステップの永続化 |

---

## フロー 1: ワークフロー作成（POST /api/v1/workflows）

### シーケンス図

```mermaid
sequenceDiagram
    participant Browser as ブラウザ
    participant BFF as BFF Handler
    participant Session as SessionManager
    participant Client as CoreServiceClient
    participant Core as Core Handler
    participant UC as WorkflowUseCase
    participant DefRepo as DefinitionRepository
    participant InstRepo as InstanceRepository
    participant DB as PostgreSQL

    Browser->>BFF: POST /api/v1/workflows
    Note over Browser,BFF: Cookie: session_id<br/>Header: X-Tenant-ID

    BFF->>BFF: extract_tenant_id()
    BFF->>Session: get(tenant_id, session_id)
    Session-->>BFF: SessionData { tenant_id, user_id }

    BFF->>Client: create_workflow(req)
    Client->>Core: POST /internal/workflows
    Note over Client,Core: tenant_id, user_id を<br/>リクエストボディに含める

    Core->>Core: ID を Uuid → ドメイン型に変換
    Core->>UC: create_workflow(input, tenant_id, user_id)

    UC->>DefRepo: find_by_id(definition_id, tenant_id)
    DefRepo->>DB: SELECT FROM workflow_definitions
    DB-->>DefRepo: WorkflowDefinition
    DefRepo-->>UC: Option<WorkflowDefinition>

    UC->>UC: 定義が公開済みか検証
    UC->>UC: WorkflowInstance::new()
    UC->>InstRepo: save(instance)
    InstRepo->>DB: INSERT INTO workflow_instances
    DB-->>InstRepo: OK
    InstRepo-->>UC: Ok(())

    UC-->>Core: Ok(WorkflowInstance)
    Core->>Core: WorkflowInstance → DTO 変換
    Core-->>Client: 201 Created + JSON
    Client-->>BFF: WorkflowResponse
    BFF-->>Browser: 201 Created + JSON
```

### 処理ステップ詳細

| ステップ | レイヤー | ファイル:関数 | 処理内容 |
|---------|---------|---------------|----------|
| 1 | BFF | `handler/workflow.rs:create_workflow()` | X-Tenant-ID ヘッダーを抽出 |
| 2 | BFF | `handler/workflow.rs:get_session()` | Cookie からセッションを取得、認証検証 |
| 3 | BFF | `client/core_service.rs:create_workflow()` | Core Service へ HTTP POST |
| 4 | Core | `handler/workflow.rs:create_workflow()` | Uuid をドメイン型に変換 |
| 5 | Core | `usecase/workflow.rs:create_workflow()` | ビジネスロジック実行 |
| 6 | Infra | `workflow_definition_repository.rs:find_by_id()` | 定義を DB から取得 |
| 7 | Core | `usecase/workflow.rs` | 定義が `published` か検証 |
| 8 | Domain | `WorkflowInstance::new()` | インスタンスを `draft` 状態で生成 |
| 9 | Infra | `workflow_instance_repository.rs:save()` | DB に INSERT (UPSERT) |
| 10 | Core | `handler/workflow.rs` | `WorkflowInstance` → `WorkflowInstanceDto` 変換 |

---

## フロー 2: ワークフロー申請（POST /api/v1/workflows/{id}/submit）

### シーケンス図

```mermaid
sequenceDiagram
    participant Browser as ブラウザ
    participant BFF as BFF Handler
    participant Session as SessionManager
    participant Client as CoreServiceClient
    participant Core as Core Handler
    participant UC as WorkflowUseCase
    participant DefRepo as DefinitionRepository
    participant InstRepo as InstanceRepository
    participant StepRepo as StepRepository
    participant DB as PostgreSQL

    Browser->>BFF: POST /api/v1/workflows/{id}/submit
    Note over Browser,BFF: assigned_to (承認者ID)

    BFF->>BFF: extract_tenant_id()
    BFF->>Session: get(tenant_id, session_id)
    Session-->>BFF: SessionData

    BFF->>Client: submit_workflow(workflow_id, req)
    Client->>Core: POST /internal/workflows/{id}/submit

    Core->>UC: submit_workflow(input, instance_id, tenant_id)

    UC->>InstRepo: find_by_id(instance_id, tenant_id)
    InstRepo->>DB: SELECT FROM workflow_instances
    DB-->>InstRepo: WorkflowInstance
    InstRepo-->>UC: Option<WorkflowInstance>

    UC->>UC: status == draft か検証

    UC->>DefRepo: find_by_id(definition_id, tenant_id)
    DefRepo->>DB: SELECT FROM workflow_definitions
    DB-->>DefRepo: WorkflowDefinition
    DefRepo-->>UC: Option<WorkflowDefinition>

    UC->>UC: WorkflowStep::new()
    UC->>UC: step.activated()
    UC->>UC: instance.submitted()
    UC->>UC: instance.with_current_step()

    UC->>InstRepo: save(in_progress_instance)
    InstRepo->>DB: UPDATE workflow_instances
    DB-->>InstRepo: OK

    UC->>StepRepo: save(active_step)
    StepRepo->>DB: INSERT INTO workflow_steps
    DB-->>StepRepo: OK

    UC-->>Core: Ok(WorkflowInstance)
    Core-->>Client: 200 OK + JSON
    Client-->>BFF: WorkflowResponse
    BFF-->>Browser: 200 OK + JSON
```

### 処理ステップ詳細

| ステップ | レイヤー | ファイル:関数 | 処理内容 |
|---------|---------|---------------|----------|
| 1 | BFF | `handler/workflow.rs:submit_workflow()` | パスパラメータから workflow_id を抽出 |
| 2 | BFF | `handler/workflow.rs:get_session()` | 認証検証 |
| 3 | BFF | `client/core_service.rs:submit_workflow()` | Core Service へ HTTP POST |
| 4 | Core | `handler/workflow.rs:submit_workflow()` | ID 変換 |
| 5 | Core | `usecase/workflow.rs:submit_workflow()` | ビジネスロジック開始 |
| 6 | Infra | `workflow_instance_repository.rs:find_by_id()` | インスタンスを取得 |
| 7 | Core | `usecase/workflow.rs` | `status == draft` か検証 |
| 8 | Infra | `workflow_definition_repository.rs:find_by_id()` | 定義を取得（将来の拡張用） |
| 9 | Domain | `WorkflowStep::new()` | 承認ステップを生成 |
| 10 | Domain | `step.activated()` | ステップを active 状態に |
| 11 | Domain | `instance.submitted()` | `draft` → `pending` 遷移 |
| 12 | Domain | `instance.with_current_step()` | `pending` → `in_progress` 遷移 |
| 13 | Infra | `workflow_instance_repository.rs:save()` | インスタンスを更新 |
| 14 | Infra | `workflow_step_repository.rs:save()` | ステップを保存 |

---

## 状態遷移

### WorkflowInstance の状態

```mermaid
stateDiagram-v2
    [*] --> Draft: new()
    Draft --> Pending: submitted()
    Pending --> InProgress: with_current_step()
    InProgress --> Approved: approve() [将来実装]
    InProgress --> Rejected: reject() [将来実装]
    Approved --> [*]
    Rejected --> [*]
```

### WorkflowStep の状態

```mermaid
stateDiagram-v2
    [*] --> Pending: new()
    Pending --> Active: activated()
    Active --> Approved: approve() [将来実装]
    Active --> Rejected: reject() [将来実装]
    Approved --> [*]
    Rejected --> [*]
```

---

## データ変換の流れ

### リクエストの変換

```
[Frontend]
    CreateWorkflowRequest (BFF公開API用)
        ├── definition_id: Uuid
        ├── title: String
        └── form_data: serde_json::Value

    ↓ BFF: セッションから tenant_id, user_id を追加

[BFF → Core Service]
    CreateWorkflowRequest (内部API用)
        ├── definition_id: Uuid
        ├── title: String
        ├── form_data: serde_json::Value
        ├── tenant_id: Uuid      ← 追加
        └── user_id: Uuid        ← 追加

    ↓ Core Handler: Uuid → ドメイン型

[UseCase]
    CreateWorkflowInput
        ├── definition_id: WorkflowDefinitionId
        ├── title: String
        └── form_data: JsonValue
    +
    tenant_id: TenantId
    user_id: UserId
```

### レスポンスの変換

```
[UseCase → Core Handler]
    WorkflowInstance (ドメインモデル)

    ↓ Core Handler: From<WorkflowInstance> for WorkflowInstanceDto

[Core Service → BFF]
    WorkflowInstanceDto
        ├── id: String
        ├── title: String
        ├── status: String (Debug形式)
        ├── ...
        └── updated_at: String (RFC3339)

    ↓ BFF: From<WorkflowInstanceDto> for WorkflowData

[BFF → Frontend]
    WorkflowResponse
        └── data: WorkflowData
```

---

## エラーハンドリングの流れ

### エラー伝播

```mermaid
flowchart LR
    subgraph Infra ["Infrastructure"]
        InfraErr["InfraError"]
    end

    subgraph Core ["Core Service"]
        CoreErr["CoreError"]
        CoreResp["RFC 7807 Response"]
    end

    subgraph BFF ["BFF"]
        ClientErr["CoreServiceError"]
        BFFResp["RFC 7807 Response"]
    end

    InfraErr -->|"map_err"| CoreErr
    CoreErr -->|"IntoResponse"| CoreResp
    CoreResp -->|"HTTP 4xx/5xx"| ClientErr
    ClientErr -->|"match"| BFFResp
```

### エラー種別とステータスコード

| エラー | Core Service | BFF | HTTP Status |
|-------|-------------|-----|-------------|
| 定義が見つからない | `CoreError::NotFound` | `CoreServiceError::WorkflowDefinitionNotFound` | 404 |
| インスタンスが見つからない | `CoreError::NotFound` | `CoreServiceError::WorkflowInstanceNotFound` | 404 |
| draft 以外の申請 | `CoreError::BadRequest` | `CoreServiceError::ValidationError` | 400 |
| 未公開定義での作成 | `CoreError::BadRequest` | `CoreServiceError::ValidationError` | 400 |
| DB エラー | `CoreError::Internal` | `CoreServiceError::Unexpected` | 500 |

---

## テナント分離

すべてのデータアクセスでテナント ID を検証し、クロステナントアクセスを防止する。

### 検証ポイント

| レイヤー | 検証方法 |
|---------|---------|
| BFF | セッションの tenant_id と X-Tenant-ID ヘッダーを照合 |
| Repository | すべての SELECT/UPDATE に `WHERE tenant_id = $N` を含める |
| workflow_steps | 親テーブル (workflow_instances) と JOIN してテナントを検証 |

### SQL での分離例

```sql
-- workflow_instances の取得
SELECT * FROM workflow_instances
WHERE id = $1 AND tenant_id = $2;

-- workflow_steps の取得（JOIN による分離）
SELECT ws.* FROM workflow_steps ws
INNER JOIN workflow_instances wi ON ws.instance_id = wi.id
WHERE ws.id = $1 AND wi.tenant_id = $2;
```

---

## 関連ドキュメント

- [Phase 1: WorkflowDefinitionRepository](./01_Phase1_WorkflowDefinitionRepository.md)
- [Phase 2: WorkflowInstanceRepository](./02_Phase2_WorkflowInstanceRepository.md)
- [Phase 3: WorkflowStepRepository](./03_Phase3_WorkflowStepRepository.md)
- [Phase 4: WorkflowUseCase](./04_Phase4_WorkflowUseCase.md)
- [Phase 5: Core Service API](./05_Phase5_CoreServiceAPI.md)
- [Phase 7: BFF API](./06_Phase7_BFFAPI.md)
- [API 設計書](../../03_詳細設計書/03_API設計.md)
- [データベース設計書](../../03_詳細設計書/02_データベース設計.md)

---

## 変更履歴

| 日付 | 変更内容 | 担当 |
|------|---------|------|
| 2026-01-26 | 全体フロードキュメントを追加 | - |
