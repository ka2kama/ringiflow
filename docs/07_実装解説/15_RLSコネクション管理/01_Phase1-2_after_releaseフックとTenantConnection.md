# Phase 1-2: after_release ãƒ•ãƒƒã‚¯ã¨ TenantConnection

## æ¦‚è¦

DB ã‚³ãƒã‚¯ã‚·ãƒ§ãƒ³ãƒ—ãƒ¼ãƒ«ã« RLS ç”¨ã®ãƒ†ãƒŠãƒ³ãƒˆã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆç®¡ç†ã‚’å°å…¥ã—ãŸã€‚ã‚³ãƒã‚¯ã‚·ãƒ§ãƒ³è¿”å´æ™‚ã®ãƒªã‚»ãƒƒãƒˆãƒ•ãƒƒã‚¯ã¨ã€ãƒ†ãƒŠãƒ³ãƒˆã‚¹ã‚³ãƒ¼ãƒ—ä»˜ãã‚³ãƒã‚¯ã‚·ãƒ§ãƒ³å‹ã‚’å®Ÿè£…ã€‚

### å¯¾å¿œ Issue

[#408 RLS ã‚³ãƒã‚¯ã‚·ãƒ§ãƒ³ç®¡ç†](https://github.com/ka2kama/ringiflow/issues/408)ï¼ˆEpic [#402 Phase 2-1: ãƒãƒ«ãƒãƒ†ãƒŠãƒ³ãƒˆ RLS](https://github.com/ka2kama/ringiflow/issues/402)ï¼‰

### è¨­è¨ˆæ›¸ã¨ã®å¯¾å¿œ

- [åŸºæœ¬è¨­è¨ˆæ›¸ 7.1.3 ãƒ†ãƒŠãƒ³ãƒˆåˆ†é›¢](../../02_åŸºæœ¬è¨­è¨ˆæ›¸/07_ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¨­è¨ˆ.md): äºŒé‡é˜²å¾¡ï¼ˆã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³å±¤ + DB å±¤ï¼‰ã® DB å±¤éƒ¨åˆ†

## å®Ÿè£…ã—ãŸã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ

| ãƒ•ã‚¡ã‚¤ãƒ« | è²¬å‹™ |
|---------|------|
| [`backend/crates/infra/src/db.rs`](../../../backend/crates/infra/src/db.rs) | ãƒ—ãƒ¼ãƒ«ä½œæˆã€after_release ãƒ•ãƒƒã‚¯ã€TenantConnection |
| [`backend/crates/infra/tests/db_test.rs`](../../../backend/crates/infra/tests/db_test.rs) | çµ±åˆãƒ†ã‚¹ãƒˆ |

## å®Ÿè£…å†…å®¹

### pool_options() ã¨ after_release ãƒ•ãƒƒã‚¯

`pool_options()` ã¯ `after_release` ãƒ•ãƒƒã‚¯ã‚’å«ã‚€ `PgPoolOptions` ã‚’è¿”ã™ã€‚ã‚³ãƒã‚¯ã‚·ãƒ§ãƒ³ãŒãƒ—ãƒ¼ãƒ«ã«è¿”å´ã•ã‚Œã‚‹éš›ã« `app.tenant_id` ã‚»ãƒƒã‚·ãƒ§ãƒ³å¤‰æ•°ã‚’ç©ºæ–‡å­—åˆ—ã«ãƒªã‚»ãƒƒãƒˆã™ã‚‹ã€‚

```rust
pub fn pool_options() -> PgPoolOptions {
   PgPoolOptions::new().after_release(|conn, _meta| {
      Box::pin(async move {
         sqlx::query("SELECT set_config('app.tenant_id', '', false)")
            .execute(&mut *conn)
            .await?;
         Ok(true)
      })
   })
}
```

`create_pool()` ã¯ `pool_options()` ã«æœ¬ç•ªè¨­å®šï¼ˆmax_connections, timeoutï¼‰ã‚’è¿½åŠ ã™ã‚‹ã€‚

### TenantConnection

ãƒ†ãƒŠãƒ³ãƒˆã‚¹ã‚³ãƒ¼ãƒ—ä»˜ãã‚³ãƒã‚¯ã‚·ãƒ§ãƒ³ã€‚`acquire` ã§ `app.tenant_id` ã‚’è¨­å®šã—ã€ãƒ‰ãƒ­ãƒƒãƒ—æ™‚ã« `after_release` ãƒ•ãƒƒã‚¯ã§ãƒªã‚»ãƒƒãƒˆã•ã‚Œã‚‹ã€‚

```rust
pub struct TenantConnection {
   conn: PoolConnection<Postgres>,
   tenant_id: TenantId,
}
```

ä¸»è¦ãƒ¡ã‚½ãƒƒãƒ‰:

- `acquire(pool, tenant_id)`: ãƒ—ãƒ¼ãƒ«ã‹ã‚‰æ¥ç¶šã‚’å–å¾—ã—ã€`set_config` ã§ãƒ†ãƒŠãƒ³ãƒˆ ID ã‚’è¨­å®š
- `tenant_id()`: è¨­å®šã•ã‚Œã¦ã„ã‚‹ãƒ†ãƒŠãƒ³ãƒˆ ID ã‚’å–å¾—

`Deref<Target = PgConnection>` / `DerefMut` ã‚’å®Ÿè£…ã—ã€sqlx ã®ã‚¨ã‚°ã‚¼ã‚­ãƒ¥ãƒ¼ã‚¿ã¨ã—ã¦ç›´æ¥ä½¿ç”¨å¯èƒ½ã€‚

## ãƒ†ã‚¹ãƒˆ

| ãƒ†ã‚¹ãƒˆå | æ¤œè¨¼å†…å®¹ |
|---------|---------|
| `test_after_releaseã§tenant_idãŒãƒªã‚»ãƒƒãƒˆã•ã‚Œã‚‹` | ã‚³ãƒã‚¯ã‚·ãƒ§ãƒ³è¿”å´æ™‚ã®ãƒªã‚»ãƒƒãƒˆ |
| `test_acquireã§ãƒ†ãƒŠãƒ³ãƒˆidãŒã‚»ãƒƒã‚·ãƒ§ãƒ³å¤‰æ•°ã«è¨­å®šã•ã‚Œã‚‹` | acquire æ™‚ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³å¤‰æ•°è¨­å®š |
| `test_dropå¾Œã«æ¥ç¶šãŒãƒ—ãƒ¼ãƒ«ã«è¿”å´ã•ã‚Œtenant_idãŒãƒªã‚»ãƒƒãƒˆã•ã‚Œã‚‹` | ãƒ‰ãƒ­ãƒƒãƒ—å¾Œã®ãƒªã‚»ãƒƒãƒˆï¼ˆE2Eï¼‰ |
| `test_ç•°ãªã‚‹ãƒ†ãƒŠãƒ³ãƒˆã§é€£ç¶šã—ã¦acquireã§ãã‚‹` | ãƒ†ãƒŠãƒ³ãƒˆåˆ‡ã‚Šæ›¿ãˆ |
| `test_tenant_connectionã¯sendã‚’å®Ÿè£…ã—ã¦ã„ã‚‹` | Send ã®ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«æ™‚æ¤œè¨¼ |

å®Ÿè¡Œæ–¹æ³•:

```bash
just dev-deps
cd backend && cargo test -p ringiflow-infra --test db_test
```

## é–¢é€£ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ

- [å®Ÿè£…è¨ˆç”»](../../../prompts/plans/408_rls-connection-management.md)

---

## è¨­è¨ˆè§£èª¬

### 1. pool_options() ã®æŠ½å‡º

å ´æ‰€: [`backend/crates/infra/src/db.rs:96-105`](../../../backend/crates/infra/src/db.rs)

ãªãœã“ã®è¨­è¨ˆã‹: `after_release` ãƒ•ãƒƒã‚¯ã®å®šç¾©ã‚’ä¸€ç®‡æ‰€ã«é›†ç´„ã—ã€`create_pool()` ã¨ ãƒ†ã‚¹ãƒˆã®ä¸¡æ–¹ã§å†åˆ©ç”¨ã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹ã€‚ãƒ†ã‚¹ãƒˆã§ã¯ `pool_options().max_connections(1)` ã¨ã—ã¦åŒä¸€ç‰©ç†æ¥ç¶šã®å†å–å¾—ã‚’ä¿è¨¼ã™ã‚‹ã€‚

ä»£æ›¿æ¡ˆ:

| æ¡ˆ | ãƒ¡ãƒªãƒƒãƒˆ | ãƒ‡ãƒ¡ãƒªãƒƒãƒˆ | åˆ¤æ–­ |
|----|---------|-----------|------|
| `pool_options()` ã‚’æŠ½å‡º | ãƒ•ãƒƒã‚¯å®šç¾©ã®é‡è¤‡ãªã—ã€ãƒ†ã‚¹ãƒˆã§æŸ”è»Ÿã«è¨­å®šå¯èƒ½ | é–¢æ•°ãŒå¢—ãˆã‚‹ | æ¡ç”¨ |
| `create_pool()` ã®ã¿ | é–¢æ•°ãŒå°‘ãªã„ | ãƒ†ã‚¹ãƒˆã§ `max_connections(1)` ã‚’ä½¿ãˆãªã„ã€ãƒ•ãƒƒã‚¯å®šç¾©ãŒé‡è¤‡ã™ã‚‹ | è¦‹é€ã‚Š |

### 2. Deref/DerefMut ãƒ‘ã‚¿ãƒ¼ãƒ³

å ´æ‰€: [`backend/crates/infra/src/db.rs:157-169`](../../../backend/crates/infra/src/db.rs)

ãªãœã“ã®è¨­è¨ˆã‹: `TenantConnection` ã‚’ sqlx ã®ã‚¨ã‚°ã‚¼ã‚­ãƒ¥ãƒ¼ã‚¿ã¨ã—ã¦ç›´æ¥ä½¿ãˆã‚‹ã‚ˆã†ã«ã™ã‚‹ãŸã‚ã€‚`PoolConnection<Postgres>` è‡ªä½“ãŒ `Deref<Target = PgConnection>` ã‚’å®Ÿè£…ã—ã¦ã„ã‚‹ã‚¹ãƒãƒ¼ãƒˆãƒã‚¤ãƒ³ã‚¿ã§ã‚ã‚Šã€`TenantConnection` ã‚‚åŒã˜ãƒ‘ã‚¿ãƒ¼ãƒ³ã«å¾“ã†ã€‚

```rust
// TenantConnection ã‚’ç›´æ¥ sqlx ã®ã‚¨ã‚°ã‚¼ã‚­ãƒ¥ãƒ¼ã‚¿ã¨ã—ã¦ä½¿ç”¨ã§ãã‚‹
let mut conn = TenantConnection::acquire(&pool, &tenant_id).await?;
sqlx::query("SELECT 1").fetch_one(&mut *conn).await?;
```

ä»£æ›¿æ¡ˆ:

| æ¡ˆ | ãƒ¡ãƒªãƒƒãƒˆ | ãƒ‡ãƒ¡ãƒªãƒƒãƒˆ | åˆ¤æ–­ |
|----|---------|-----------|------|
| Deref/DerefMut | sqlx ã¨è‡ªç„¶ã«çµ±åˆã€`&mut *conn` ã§ä½¿ãˆã‚‹ | Deref ä¹±ç”¨ã®æ‡¸å¿µ | æ¡ç”¨: ã‚¹ãƒãƒ¼ãƒˆãƒã‚¤ãƒ³ã‚¿ãƒ‘ã‚¿ãƒ¼ãƒ³ã«è©²å½“ |
| `as_conn()` ãƒ¡ã‚½ãƒƒãƒ‰ | æ˜ç¤ºçš„ | ä½¿ã„å‹æ‰‹ãŒæ‚ªåŒ–ï¼ˆ`conn.as_conn()` ãŒæ¯å›å¿…è¦ï¼‰ | è¦‹é€ã‚Š |
| Executor ãƒˆãƒ¬ã‚¤ãƒˆå®Ÿè£… | æœ€ã‚‚å‹å®‰å…¨ | å®Ÿè£…ãŒè¤‡é›‘ã€sqlx ã®å†…éƒ¨ãƒˆãƒ¬ã‚¤ãƒˆ | è¦‹é€ã‚Š |

â˜… Insight â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
- `Deref`/`DerefMut` ã¯ã‚¹ãƒãƒ¼ãƒˆãƒã‚¤ãƒ³ã‚¿å‹ï¼ˆå†…éƒ¨ã®å€¤ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ã‚’æä¾›ã™ã‚‹å‹ï¼‰ã§ä½¿ã†ã®ãŒé©åˆ‡ã€‚`TenantConnection` ã¯ `PoolConnection` ã‚’ãƒ©ãƒƒãƒ—ã—ã¦è¿½åŠ æ©Ÿèƒ½ï¼ˆãƒ†ãƒŠãƒ³ãƒˆã‚¹ã‚³ãƒ¼ãƒ—ï¼‰ã‚’æä¾›ã™ã‚‹ã‚¹ãƒãƒ¼ãƒˆãƒã‚¤ãƒ³ã‚¿ã¨è¦‹ãªã›ã‚‹ãŸã‚ã€ã“ã®ãƒ‘ã‚¿ãƒ¼ãƒ³ã«åˆè‡´ã™ã‚‹
- `set_config` ã® `is_local` ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã¯ `false`ï¼ˆã‚»ãƒƒã‚·ãƒ§ãƒ³å…¨ä½“ï¼‰ã‚’ä½¿ç”¨ã€‚`true` ã«ã™ã‚‹ã¨ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³å†…ã®ã¿æœ‰åŠ¹ã«ãªã‚‹ãŒã€RLS ãƒãƒªã‚·ãƒ¼ã¯ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³å¤–ã®ã‚¯ã‚¨ãƒªã«ã‚‚é©ç”¨ã™ã‚‹å¿…è¦ãŒã‚ã‚‹

ğŸ“ In English: `Deref`/`DerefMut` is appropriate here because `TenantConnection` acts as a smart pointer wrapping `PoolConnection` with tenant-scoping behavior â€” the same pattern `PoolConnection` itself uses to expose `PgConnection`.
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

### 3. ãƒ†ã‚¹ãƒˆæ–¹é‡: max_connections(1) ã«ã‚ˆã‚‹ç‰©ç†æ¥ç¶šã®å†å–å¾—ä¿è¨¼

å ´æ‰€: [`backend/crates/infra/tests/db_test.rs:23-29`](../../../backend/crates/infra/tests/db_test.rs)

ãªãœã“ã®è¨­è¨ˆã‹: `after_release` ãƒ•ãƒƒã‚¯ã®æ¤œè¨¼ã«ã¯ã€åŒä¸€ç‰©ç†æ¥ç¶šãŒå†å–å¾—ã•ã‚Œã‚‹ã“ã¨ã‚’ä¿è¨¼ã™ã‚‹å¿…è¦ãŒã‚ã‚‹ã€‚`max_connections(1)` ã«ã™ã‚‹ã“ã¨ã§ã€ãƒ—ãƒ¼ãƒ«å†…ã®æ¥ç¶šãŒ 1 æœ¬ã«åˆ¶é™ã•ã‚Œã€è¿”å´å¾Œã«å–å¾—ã™ã‚Œã°ç¢ºå®Ÿã«åŒã˜æ¥ç¶šãŒè¿”ã‚‹ã€‚

`#[sqlx::test]` ã§ã¯ãªã `#[tokio::test]` + `dotenvy` ã‚’ä½¿ç”¨ã—ãŸç†ç”±:
- `#[sqlx::test]` ã¯ãƒ†ã‚¹ãƒˆç”¨ DB ã‚’ä½œæˆã—ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å®Ÿè¡Œã™ã‚‹ãŒã€æœ¬ãƒ†ã‚¹ãƒˆã§ã¯ãƒ†ãƒ¼ãƒ–ãƒ«ãŒä¸è¦ï¼ˆ`set_config` / `current_setting` ã¯ãƒ“ãƒ«ãƒˆã‚¤ãƒ³é–¢æ•°ï¼‰
- `Pool::connect_options()` ã¯ sqlx ã® `any` feature ãŒå¿…è¦ã§ã€ç¾ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã§ã¯ç„¡åŠ¹
- `session_test.rs` ã§ `#[tokio::test]` + ç’°å¢ƒå¤‰æ•°ãƒ‘ã‚¿ãƒ¼ãƒ³ã®å‰ä¾‹ã‚ã‚Š
