# ダッシュボード - 実装解説

## 概要

ホームページ（`/`）をダッシュボード化し、KPI 統計情報（承認待ちタスク数・申請中ワークフロー数・本日完了数）を表示する。

### 対応 Issue

[#38 ダッシュボード](https://github.com/ka2kama/ringiflow/issues/38)

## Phase 構成

| Phase | 内容 | 状態 | 解説 |
|-------|------|------|------|
| Phase 1 | OpenAPI 仕様書更新 | ✅ 完了 | 下記参照 |
| Phase 2 | Core Service（ユースケース + ハンドラ） | ✅ 完了 | [解説](./01_Phase2_CoreServiceユースケース.md) |
| Phase 3 | BFF（クライアント + ハンドラ） | ✅ 完了 | 下記参照 |
| Phase 4 | フロントエンド | ✅ 完了 | [解説](./02_Phase4_フロントエンド.md) |
| Phase 5 | 統合・仕上げ | ✅ 完了 | - |

## 設計書

- [OpenAPI 仕様書](../../../openapi/openapi.yaml)（`GET /api/v1/dashboard/stats`）

## API 設計

### エンドポイント

```
GET /api/v1/dashboard/stats
```

### レスポンス

```json
{
  "data": {
    "pending_tasks": 3,
    "my_workflows_in_progress": 2,
    "completed_today": 5
  }
}
```

### KPI 定義

| KPI | データソース | フィルタ条件 |
|-----|------------|-------------|
| 承認待ちタスク数 | `workflow_steps` | status = Active, assigned_to = user |
| 申請中ワークフロー数 | `workflow_instances` | status = InProgress, initiated_by = user |
| 本日完了タスク数 | `workflow_steps` | completed_at = today, assigned_to = user |

## Phase 1: OpenAPI 仕様書更新

変更ファイル:
- [`openapi/openapi.yaml`](../../../openapi/openapi.yaml)

追加内容:
- `/api/v1/dashboard/stats` エンドポイント
- `DashboardStatsResponse`、`DashboardStats` スキーマ
- `dashboard` タグ

## Phase 3: BFF（クライアント + ハンドラ）

既存のパターン（ワークフロー API）に従い、Core Service への透過的プロキシとして実装。

変更ファイル:
- [`backend/apps/bff/src/client/core_service.rs`](../../../backend/apps/bff/src/client/core_service.rs) — `CoreServiceClient` トレイトに `get_dashboard_stats` を追加
- [`backend/apps/bff/src/handler/dashboard.rs`](../../../backend/apps/bff/src/handler/dashboard.rs)（新規）— BFF ハンドラ
- [`backend/apps/bff/src/handler.rs`](../../../backend/apps/bff/src/handler.rs) — モジュール登録
- [`backend/apps/bff/src/main.rs`](../../../backend/apps/bff/src/main.rs) — ルーティング追加

設計判断:
- `WorkflowState<C, S>` を再利用（Dashboard 専用の State は不要）
- セッションからユーザー情報を取得し、Core Service にクエリパラメータで渡す

## 学習ポイント

1. **フルスタック実装の流れ**: OpenAPI → Core Service → BFF → Frontend の一気通貫パイプライン
2. **既存パターンの活用**: ワークフロー API と同じパターンで新エンドポイントを追加する際の定型作業を体験
3. **アプリケーション層でのフィルタリング**: MVP では新規クエリを書かず、既存リポジトリメソッドの結果をアプリケーションコードでフィルタリング
4. **Elm の Stateless → Stateful 変換**: Home ページを TEA パターンの Nested TEA に変換

## PR

- https://github.com/ka2kama/ringiflow/pull/166
