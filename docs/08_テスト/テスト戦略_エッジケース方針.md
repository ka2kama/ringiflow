# テスト戦略: エッジケース・境界値・不変条件テスト方針

## 目的

テストピラミッドの各層で「何を」「どこまで」テストするかの方針を定義する。手動の探索的テストで見つかるような不具合を自動テストで事前に防ぐことが目標。

## 基本原則

### 原則 1: 同じことを複数層でテストしない

テストピラミッドの各層は独自の責務を持つ。上位層で下位層の検証を繰り返さない。

| テスト層 | 独自の責務 | 検証しない（他層に委譲） |
|---------|-----------|---------------------|
| ユニットテスト | ドメインルールの正確さ、境界値、エラー型 | HTTP 層への伝播、UI 表示 |
| ハンドラテスト | HTTP ステータスコード、認可、エラーマッピング | ドメインロジックの詳細、UI |
| API テスト（Hurl） | ルールの HTTP 層への伝播、実 DB との結合、状態遷移 | ドメインルール網羅、UI 操作 |
| E2E テスト（Playwright） | ユーザー操作の完結性、UI 固有の問題 | API レスポンス詳細、境界値 |

**伝播の検証は重複ではない。** ユニットテストで「空文字は拒否される」を検証し、API テストで「空文字 POST → 422 が返る」を検証するのは、異なる責務（ルールの正確さ vs HTTP 層への伝播）を検証している。ただし API テストで全境界値を網羅する必要はなく、代表的な 1-2 ケースで伝播を確認すればよい。

### 原則 2: 操作列ではなく不変条件をテストする

操作列の組み合わせは指数的に増加し、手動列挙では漏れが生じる。代わりに「どんな操作列の後でも成り立つべき性質（不変条件）」を検証する。

```
操作列のテスト:    「申請 → 承認 → 結果確認」を個別テスト
不変条件のテスト:  「任意の操作列の後で、Approved なら全ステップが Completed か Skipped」を検証
```

不変条件はエンティティ影響マップ（`docs/03_詳細設計書/エンティティ影響マップ/`）で定義済み。テストでは `assert_workflow_invariants()` による統合検証と、プロパティベーステストによるランダム操作列の探索を組み合わせる。

→ 不変条件の一覧: [エンティティ影響マップ](../03_詳細設計書/エンティティ影響マップ/)
→ proptest の導入判断: [ADR-058](../05_ADR/058_プロパティベーステスト導入.md)

## テスト層ごとのエッジケース責務分担

### ユニットテスト

**責務:** ドメインルールの正確さと境界値の網羅。

| カテゴリ | テスト対象 | 例 |
|---------|-----------|-----|
| 値オブジェクトの境界値 | 空文字、最大長、最小値/最大値、不正形式 | `UserName("")` → Error、`UserName("a" * 101)` → Error |
| 特殊文字 | 制御文字、改行、タブ、絵文字、HTML タグ | `WorkflowName("<script>")` の挙動 |
| 状態遷移ガード | 全状態 × 全操作のマトリクス（Error セル） | Draft から `complete_with_approval()` → Error |
| バリデーションルール | 複合条件、エッジケースの組み合わせ | 開始ステップなし + 終了ステップなしの同時エラー |
| 不変条件 | エンティティ影響マップの INV-* | `assert_workflow_invariants()` |

→ 状態遷移表: [状態遷移表（WorkflowInstance）](状態遷移表_WorkflowInstance.md)、[状態遷移表（WorkflowStep）](状態遷移表_WorkflowStep.md)

### API テスト（Hurl）

**責務:** ユニットテストで守ったルールが HTTP 層まで伝播していることの確認。

| カテゴリ | テスト対象 | 説明 |
|---------|-----------|------|
| 入力値境界（伝播確認） | 空文字、最大長超過 | 各カテゴリ 1-2 ケースで 422 を確認。全パターンの網羅はユニットテストの責務 |
| ページネーション無効値 | limit=0、offset=-1、極大値 | 一覧 API 共通のエッジケース |
| 権限境界 | 他テナント/他ユーザーのリソースアクセス | 403 / 404 を確認 |
| 状態遷移異常系 | 無効な状態からの操作 | 完了済みワークフローへの承認 → 409 |
| 楽観的ロック競合 | 古い version での更新 | 409 Conflict を確認 |

→ 詳細: [API テストルール](../../.claude/rules/api-test.md)

### E2E テスト（Playwright）

**責務:** ユーザー操作の完結性と、他の層で検証できない UI 固有の問題。

| カテゴリ | テスト対象 | 説明 |
|---------|-----------|------|
| 二重送信防止 | ボタン連打時の動作 | ボタンの disabled 化、loading 表示を確認 |
| セッション切れ | 操作中の認証期限切れ | ログイン画面への遷移を確認 |
| エラー画面表示 | 404、500、ネットワークエラー | クリティカルなエラー画面のみ |
| フォームバリデーション | UI 上のバリデーションメッセージ | フロントエンド固有のバリデーション表示を確認 |

→ 詳細: [E2E テストルール](../../.claude/rules/e2e-test.md)

## エッジケースカテゴリの体系

テストリスト作成時に、以下のカテゴリを体系的に検討する。

### 入力値のエッジケース

| カテゴリ | テストケース | 担当層 |
|---------|-------------|--------|
| 空文字 / null | 必須フィールドに空文字を送信 | ユニット（網羅） + API（伝播 1-2 件） |
| 最大長境界 | max_length ちょうど、max_length + 1 | ユニット |
| 特殊文字 | HTML タグ、改行 `\n`、制御文字、SQL 特殊文字 | ユニット |
| Unicode | 絵文字、全角スペース、サロゲートペア | ユニット |
| 数値境界 | 0、負数、i64::MAX、オーバーフロー | ユニット |
| 型不一致 | 文字列フィールドに数値、数値フィールドに文字列 | API（HTTP 層で 400） |

### 状態のエッジケース

| カテゴリ | テストケース | 担当層 |
|---------|-------------|--------|
| 無効な状態遷移 | 状態遷移表の全 Error セル | ユニット（網羅） + API（代表ケース） |
| 楽観的ロック | 古い version での更新 | API |
| 存在しないリソース | 無効な ID でのアクセス | API |
| 重複データ | 一意制約違反（同じ email で 2 度作成等） | API |

### UI のエッジケース

| カテゴリ | テストケース | 担当層 |
|---------|-------------|--------|
| 二重送信 | ボタン連打、Enter キー連打 | E2E |
| セッション切れ | トークン期限切れ後の操作 | E2E |
| エラー表示 | バリデーションエラー、サーバーエラー | E2E（クリティカルのみ） |
| 空データ | データ 0 件時の表示 | E2E（クリティカルのみ） |

## テストリスト作成時のチェックリスト

テストリスト作成時に、以下を体系的に確認する:

1. 正常系の操作パスを列挙する
2. 各操作パスの入力値について上記のエッジケースカテゴリを検討する
3. 状態遷移を伴う操作について状態遷移表の Error セルを確認する
4. 各テストケースを適切なテスト層に配置する（責務分担表に従う）
5. 不変条件の検証が必要な操作を特定する

## 関連ドキュメント

- [ADR-032: テスト設計方針](../05_ADR/032_テスト設計方針.md)
- [ADR-036: Handler 層テスト戦略](../05_ADR/036_Handler層テスト戦略.md)
- [ADR-054: 型安全ステートマシンパターンの標準化](../05_ADR/054_型安全ステートマシンパターンの標準化.md)
- [API テストルール](../../.claude/rules/api-test.md)
- [E2E テストルール](../../.claude/rules/e2e-test.md)
- [TDD 開発フロー](../../.claude/rules/dev-flow-tdd.md)
- [エンティティ影響マップ](../03_詳細設計書/エンティティ影響マップ/)
- [状態遷移表（WorkflowInstance）](状態遷移表_WorkflowInstance.md)
- [状態遷移表（WorkflowStep）](状態遷移表_WorkflowStep.md)
- [API テスト突合表](APIテスト突合表.md)
- [E2E テスト突合表](E2Eテスト突合表.md)

---

## 変更履歴

| 日付 | 変更内容 |
|------|---------|
| 2026-02-27 | 初版作成（#939） |
