# 開発環境構築手順

## 目的

RingiFlow の開発に必要なツールをインストールする。
本手順完了後、Phase 0 の各手順を実行できる状態になる。

## 概要

本手順でインストールするツール:

| カテゴリ | ツール | バージョン | 用途 |
|---------|--------|----------|------|
| 言語 | Rust | 1.93+ | バックエンド開発 |
| ランタイム | Node.js | 22 LTS | フロントエンドビルド |
| パッケージマネージャー | pnpm | 最新 | フロントエンド依存管理 |
| 言語 | Elm | 0.19.1 | フロントエンド開発（グローバル） |
| コンテナ | Docker | 27+ | 依存サービス実行 |
| コンテナ | Docker Compose | 2.x | コンテナオーケストレーション |
| タスクランナー | just | 最新 | 開発タスク実行 |
| データベース | sqlx-cli | 最新 | マイグレーション管理 |
| Git フック | lefthook | 最新 | コミット時の自動処理 |
| ファイルウォッチ | cargo-watch | 最新 | バックエンドのホットリロード（自動リビルド） |
| プロセスマネージャー | mprocs | 最新 | 開発サーバー一括起動 |
| リンター | ShellCheck | 最新 | シェルスクリプト静的解析 |
| E2E テスト | hurl | 最新 | HTTP API テスト |
| リンター | actionlint | 最新 | GitHub Actions ワークフロー静的解析 |
| CLI | gh (GitHub CLI) | 最新 | Issue/PR 操作、ラベル管理 |
| DB クライアント | psql | 最新 | PostgreSQL 操作（`just db-*`） |
| DB クライアント | redis-cli | 最新 | Redis 操作（`just redis-*`） |
| セキュリティ | cargo-deny | 最新 | 依存関係の脆弱性・ライセンスチェック |
| カバレッジ | cargo-llvm-cov | 最新 | コードカバレッジ計測（LLVM ベース） |
| 未使用依存検出 | cargo-machete | 最新 | Cargo.toml の未使用依存検出 |

技術選定の詳細は [ADR-002: フロントエンドツールチェーンの選定](../../05_ADR/002_フロントエンドツールチェーンの選定.md) を参照。

---

## 1. Rust のインストール

バックエンド開発に使用するプログラミング言語。メモリ安全性と高パフォーマンスを両立する。

公式: https://www.rust-lang.org/

### 1.1 rustup のインストール

```bash
curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh
```

インストーラの質問には、デフォルト（1）を選択する。

### 1.2 環境変数の反映

```bash
source ~/.cargo/env
```

### 1.3 バージョン確認

```bash
rustc --version
# 出力例: rustc 1.93.0 (xxx)

cargo --version
# 出力例: cargo 1.93.0 (xxx)
```

### 1.4 追加コンポーネントのインストール

```bash
# フォーマッタ・リンター
rustup component add rustfmt clippy
```

### 1.5 確認

```bash
rustfmt --version
# 出力例: rustfmt 1.9.0-stable (xxx)

cargo clippy --version
# 出力例: clippy 0.1.93 (xxx)
```

---

## 2. Node.js と pnpm のインストール

Node.js はフロントエンドのビルドツール実行に必要な JavaScript ランタイム。
pnpm は高速でディスク効率の良いパッケージマネージャー。

- Node.js: https://nodejs.org/
- pnpm: https://pnpm.io/

### 2.1 Node.js のインストール

バージョン 22 LTS をインストールする。インストール方法の例:

```bash
# Volta (https://volta.sh/)
curl https://get.volta.sh | bash
source ~/.bashrc
volta install node@22

# mise (https://mise.jdx.dev/)
mise use -g node@22

# nvm (https://github.com/nvm-sh/nvm)
nvm install 22
```

### 2.2 pnpm のインストール

```bash
# Volta
volta install pnpm

# mise
mise use -g pnpm

# corepack
corepack enable
corepack prepare pnpm@latest --activate

# npm
npm install -g pnpm
```

### 2.3 バージョン確認

```bash
node --version
# 出力例: v22.x.x

pnpm --version
# 出力例: 10.x.x
```

---

## 3. Elm のインストール

フロントエンド開発に使用する関数型言語。コンパイル時エラーチェックにより実行時エラーを防ぐ。

公式: https://elm-lang.org/

Elm ツール群（elm, elm-format, elm-test）は**グローバルにインストール**する。

理由: これらの npm パッケージはネイティブバイナリを配布しており、一部のパッケージマネージャー（pnpm 等）ではローカルインストール時に正しく動作しない。詳細は [ADR-002](../../05_ADR/002_フロントエンドツールチェーンの選定.md) を参照。

### 3.1 npm でグローバルインストール

```bash
npm install -g elm elm-format elm-test
```

### 3.2 バージョン確認

```bash
elm --version
# 出力例: 0.19.1

elm-format --version
# 出力例: 0.8.7

elm-test --version
# 出力例: 0.19.1-revision17
```

---

## 4. Docker のインストール

コンテナ仮想化プラットフォーム。PostgreSQL や Redis などの依存サービスをローカルで実行する。

公式: https://www.docker.com/

### 4.1 OS 別インストール手順

各 OS の公式手順に従う:

- macOS: [Docker Desktop for Mac](https://docs.docker.com/desktop/install/mac-install/)
- Windows: [Docker Desktop for Windows](https://docs.docker.com/desktop/install/windows-install/)
- Linux (Ubuntu): 以下のコマンドを実行

```bash
# Ubuntu の場合
curl -fsSL https://get.docker.com | sh

# ユーザーを docker グループに追加（再ログインが必要）
sudo usermod -aG docker $USER
```

### 4.2 バージョン確認

```bash
docker --version
# 出力例: Docker version 27.x.x, build xxx

docker compose version
# 出力例: Docker Compose version v2.x.x
```

### 4.3 動作確認

```bash
docker run --rm hello-world
# "Hello from Docker!" が表示されれば OK
```

---

## 5. just のインストール

コマンドランナー。プロジェクトの開発タスク（ビルド、テスト、リント等）を `just <タスク名>` で実行できる。

公式: https://github.com/casey/just

### 5.1 インストール方法（いずれか）

```bash
# mise
mise use -g just

# Cargo
cargo install just

# プリビルドバイナリ（Linux）
curl --proto '=https' --tlsv1.2 -sSf https://just.systems/install.sh | bash -s -- --to ~/.local/bin

# Homebrew（macOS）
brew install just
```

### 5.2 バージョン確認

```bash
just --version
# 出力例: just 1.x.x
```

---

## 6. cargo-watch のインストール

Cargo のサブコマンドとして動作するファイルウォッチツール。ソースコードの変更を検知し、自動でリビルド＆再起動する。`just dev-bff` 等の開発サーバー起動で使用する。

公式: https://github.com/watchexec/cargo-watch

### 6.1 Cargo でインストール

```bash
cargo install cargo-watch
```

### 6.2 バージョン確認

```bash
cargo watch --version
# 出力例: cargo-watch 8.x.x
```

---

## 7. mprocs のインストール

TUI（テキストユーザーインターフェース）プロセスマネージャー。`just dev-all` で全開発サーバーを一括起動する際に使用する。

公式: https://github.com/pvolok/mprocs

### 7.1 インストール方法（いずれか）

```bash
# Cargo
cargo install mprocs

# Homebrew（macOS / Linux）
brew install mprocs

# mise
mise use -g mprocs
```

### 7.2 バージョン確認

```bash
mprocs --version
# 出力例: mprocs 0.x.x
```

---

## 8. sqlx-cli のインストール

SQLx 用の CLI ツール。データベースマイグレーションの実行やコンパイル時クエリ検証に使用する。

公式: https://github.com/launchbadge/sqlx

詳細は [sqlx-cli ナレッジベース](../../06_ナレッジベース/rust/sqlx-cli.md) を参照。

### 8.1 Cargo でインストール

```bash
cargo install sqlx-cli --no-default-features --features rustls,postgres
```

### 8.2 バージョン確認

```bash
cargo sqlx --version
# 出力例: sqlx-cli x.x.x
```

---

## 9. lefthook のインストール

Git フック管理ツール。コミット時に Issue 番号を自動付与する。

公式: https://github.com/evilmartians/lefthook

### 9.1 インストール方法（いずれか）

```bash
# mise
mise use -g lefthook

# Homebrew（macOS / Linux）
brew install lefthook

# Go
go install github.com/evilmartians/lefthook@latest

# npm
npm install -g lefthook
```

### 9.2 バージョン確認

```bash
lefthook --version
# 出力例: 1.x.x
```

---

## 10. ShellCheck のインストール

シェルスクリプトの静的解析ツール。構文エラーやバグを検出する。

公式: https://www.shellcheck.net/

### 10.1 インストール方法（いずれか）

```bash
# mise
mise use -g shellcheck

# apt（Ubuntu / Debian）
sudo apt install shellcheck

# Homebrew（macOS / Linux）
brew install shellcheck

# Cabal（Haskell）
cabal update && cabal install ShellCheck
```

### 10.2 バージョン確認

```bash
shellcheck --version
# 出力例: ShellCheck - shell script analysis tool
# version: 0.x.x
```

---

## 11. hurl のインストール

HTTP API テストツール。curl に似た構文でリクエストとアサーションを記述でき、E2E テストに使用する。

公式: https://hurl.dev/

### 11.1 インストール方法（いずれか）

```bash
# mise
mise use -g hurl

# Cargo
cargo install hurl

# Homebrew（macOS / Linux）
brew install hurl

# apt（Ubuntu / Debian）
sudo apt install hurl
```

### 11.2 バージョン確認

```bash
hurl --version
# 出力例: hurl 6.x.x
```

---

## 12. actionlint のインストール

GitHub Actions ワークフローの静的解析ツール。YAML の構文エラー、未定義の変数参照、セキュリティ問題を検出する。内部で shellcheck を使用し、`run:` ブロック内のシェルスクリプトもチェックする。

公式: https://github.com/rhysd/actionlint

### 12.1 インストール方法（いずれか）

```bash
# mise
mise use -g actionlint

# Homebrew（macOS / Linux）
brew install actionlint

# Go
go install github.com/rhysd/actionlint/cmd/actionlint@latest
```

### 12.2 バージョン確認

```bash
actionlint --version
# 出力例: 1.x.x
```

---

## 13. GitHub CLI (gh) のインストール

GitHub の Issue、PR、ラベル、Projects を CLI から操作するツール。Issue 駆動開発で多用する。

公式: https://cli.github.com/

### 13.1 インストール方法（いずれか）

```bash
# mise
mise use -g gh

# Homebrew（macOS / Linux）
brew install gh

# apt（Ubuntu / Debian）
sudo apt install gh

# winget（Windows）
winget install GitHub.cli
```

### 13.2 バージョン確認

```bash
gh --version
# 出力例: gh version 2.x.x
```

### 13.3 認証

```bash
gh auth login
# ブラウザで認証、または Token を入力
```

### 13.4 認証確認

```bash
gh auth status
# 出力例: Logged in to github.com account xxx
```

---

## 14. psql のインストール

PostgreSQL のコマンドラインクライアント。`just db-tables`、`just db-schema`、`just db-query` で使用する。

公式: https://www.postgresql.org/

### 14.1 インストール方法（いずれか）

```bash
# Fedora
sudo dnf install postgresql

# Ubuntu / Debian
sudo apt install postgresql-client

# Homebrew（macOS / Linux）
brew install libpq && brew link --force libpq

# Arch Linux
sudo pacman -S postgresql-libs
```

注意: PostgreSQL サーバーは Docker で起動するため、クライアント（psql）のみインストールすれば十分。

### 14.2 バージョン確認

```bash
psql --version
# 出力例: psql (PostgreSQL) 18.x
```

---

## 15. redis-cli のインストール

Redis のコマンドラインクライアント。`just redis-keys`、`just redis-get` で使用する。

公式: https://redis.io/

### 15.1 インストール方法（いずれか）

```bash
# Fedora
sudo dnf install redis

# Ubuntu / Debian
sudo apt install redis-tools

# Homebrew（macOS / Linux）
brew install redis

# Arch Linux
sudo pacman -S redis
```

注意: Redis サーバーは Docker で起動するため、クライアント（redis-cli）のみインストールすれば十分。

### 15.2 バージョン確認

```bash
redis-cli --version
# 出力例: redis-cli x.x.x
```

---

## 16. cargo-deny のインストール

依存関係のセキュリティスキャニングツール。脆弱性（RustSec Advisory DB）、ライセンス違反、禁止クレート、ソース制限をチェックする。`just audit` で使用する。

公式: https://embarkstudios.github.io/cargo-deny/

選定理由: [ADR-033](../../05_ADR/033_セキュリティスキャニングツールの選定.md)

### 16.1 Cargo でインストール

```bash
cargo install --locked cargo-deny
```

### 16.2 バージョン確認

```bash
cargo deny --version
# 出力例: cargo-deny 0.19.0
```

---

## 17. cargo-llvm-cov のインストール

LLVM ベースのコードカバレッジ計測ツール。`just coverage` でカバレッジレポートを生成する。Rust 公式の `-C instrument-coverage` を利用するため高精度。

公式: https://github.com/taiki-e/cargo-llvm-cov

### 17.1 インストール

```bash
# LLVM ツールコンポーネント（必須）
rustup component add llvm-tools-preview

# cargo-llvm-cov
cargo install cargo-llvm-cov
```

### 17.2 バージョン確認

```bash
cargo llvm-cov --version
# 出力例: cargo-llvm-cov 0.x.x
```

---

## 18. cargo-machete のインストール

Cargo.toml に宣言されているが実際には使用されていない依存を検出するツール。`just check-unused-deps` で使用する。

公式: https://github.com/bnjbvr/cargo-machete

選定理由: [ADR-038](../../05_ADR/038_未使用依存検出ツールの選定.md)

### 18.1 Cargo でインストール

```bash
cargo install cargo-machete --locked
```

### 18.2 バージョン確認

```bash
cargo machete --version
# 出力例: cargo-machete 0.9.1
```

---

## 19. 全ツールの確認

以下のコマンドをすべて実行し、エラーがないことを確認する:

```bash
# Rust
rustc --version && cargo --version && rustfmt --version && cargo clippy --version

# Node.js / pnpm / Elm
node --version && pnpm --version && elm --version

# Docker
docker --version && docker compose version

# タスクランナー
just --version

# ファイルウォッチ（バックエンドホットリロード）
cargo watch --version

# プロセスマネージャー
mprocs --version

# データベースツール
cargo sqlx --version

# Git フック
lefthook --version

# シェルスクリプトリンター
shellcheck --version

# E2E テスト
hurl --version

# GitHub Actions リンター
actionlint --version

# GitHub CLI
gh --version

# DB クライアント
psql --version
redis-cli --version

# セキュリティ
cargo deny --version

# カバレッジ
cargo llvm-cov --version

# 未使用依存検出
cargo machete --version
```

すべてのコマンドがバージョン情報を出力すれば、開発環境構築は完了。

または `just check-tools` で一括確認:

```bash
just check-tools
# ✓ 全ツール確認済み
```

---

## 20. IDE 設定（推奨）

### 20.1 VS Code 推奨拡張機能

`.vscode/extensions.json`:

```json
{
  "recommendations": [
    "rust-lang.rust-analyzer",
    "tamasfe.even-better-toml",
    "serayuzgur.crates",
    "elmtooling.elm-ls-vscode",
    "ms-azuretools.vscode-docker",
    "hashicorp.terraform",
    "skellock.just"
  ]
}
```

### 20.2 VS Code 設定

`.vscode/settings.json`:

```json
{
  "editor.formatOnSave": true,
  "[rust]": {
    "editor.defaultFormatter": "rust-lang.rust-analyzer"
  },
  "[elm]": {
    "editor.defaultFormatter": "elmtooling.elm-ls-vscode"
  },
  "rust-analyzer.cargo.features": "all",
  "rust-analyzer.check.command": "clippy"
}
```

### 20.3 IntelliJ IDEA / WebStorm 設定

#### Elm プラグインのインストール

1. **Settings → Plugins → Marketplace** で「Elm」を検索
2. **Elm** プラグインをインストール
3. IDE を再起動

#### Elm プロジェクトの設定

1. elm-stuff を生成（型情報の取得に必要）:

```bash
cd apps/web
elm make src/Main.elm --output=/dev/null
```

2. **Settings → Languages & Frameworks → Elm** を開く

3. **Elm path** を設定:

```bash
# パスを確認
which elm
# 例: /home/user/.npm-global/bin/elm
```

4. **Lamdera path** は**空欄のまま**にする（RingiFlow では Lamdera を使用しない）

5. **Projects** タブで elm.json が認識されていることを確認
   - 認識されていない場合: `apps/web/elm.json` を右クリック → **Attach elm.json project**

#### elm-format の設定

1. **Settings → Languages & Frameworks → Elm**
2. **elm-format path** を設定:

```bash
which elm-format
# 例: /home/user/.npm-global/bin/elm-format
```

3. **Run elm-format on save** にチェック（任意）

#### キャッシュのクリア（型検出が動作しない場合）

**File → Invalidate Caches → Invalidate and Restart** を実行。

---

## トラブルシューティング

### `rustup: command not found`

```bash
# パスが通っていない場合
export PATH="$HOME/.cargo/bin:$PATH"
echo 'export PATH="$HOME/.cargo/bin:$PATH"' >> ~/.bashrc
```

### `pnpm: command not found`

```bash
# Volta を使っている場合
volta install pnpm

# corepack を使う場合
corepack enable
corepack prepare pnpm@latest --activate
```

### `docker: permission denied`

```bash
# ユーザーを docker グループに追加
sudo usermod -aG docker $USER

# 再ログイン（または以下を実行）
newgrp docker
```

### Rust のビルドが遅い

```bash
# sccache をインストール（ビルドキャッシュ）
cargo install sccache

# 環境変数に追加
echo 'export RUSTC_WRAPPER=sccache' >> ~/.bashrc
source ~/.bashrc
```

### pnpm のアップグレード

```bash
# Volta を使っている場合
volta install pnpm@latest

# corepack を使う場合
corepack prepare pnpm@latest --activate

# npm でインストールしている場合
npm install -g pnpm@latest
```

### IntelliJ Elm プラグイン: `Must specify a valid path to Lamdera binary`

Lamdera は使用しないが、プラグインの仕様でパスが必要な場合がある。
回避策として **Lamdera path** に elm バイナリのパスを設定する:

1. **Settings → Languages & Frameworks → Elm**
2. **Lamdera path** に elm のパスを設定（例: `~/.volta/bin/elm`）

```bash
# パスを確認
which elm
```

実際に Lamdera として使用されることはないため、elm のパスで問題ない。

### IntelliJ Elm プラグイン: 型が検出されない

1. elm-stuff を再生成:

```bash
cd apps/web
rm -rf elm-stuff
elm make src/Main.elm --output=/dev/null
```

2. **File → Invalidate Caches → Invalidate and Restart**

3. それでも解決しない場合、Elm 設定をリセット:

```bash
# プロジェクトの .idea から Elm 設定を削除
rm -f .idea/elm.xml
```

その後 IDE を再起動し、`apps/web/elm.json` を右クリック → **Attach elm.json project**

---

## 次のステップ

開発環境構築が完了したら、[`02_プロジェクトセットアップ.md`](02_プロジェクトセットアップ.md) に進む。

---

## 変更履歴

| 日付 | 変更内容 | 担当 |
|------|---------|------|
| 2026-02-09 | cargo-machete のインストール手順を追加（未使用依存検出） | - |
| 2026-02-08 | cargo-llvm-cov のインストール手順を追加（コードカバレッジ計測） | - |
| 2026-02-07 | cargo-deny のインストール手順を追加（セキュリティスキャニング） | - |
| 2026-02-06 | cargo-watch のインストール手順を追加（バックエンドホットリロード） | - |
| 2026-01-31 | psql / redis-cli のインストール手順を追加（データストア操作用） | - |
| 2026-01-28 | mprocs のインストール手順を追加（開発サーバー一括起動） | - |
| 2026-01-27 | GitHub CLI (gh) のインストール手順を追加 | - |
| 2026-01-26 | actionlint のインストール手順を追加（GitHub Actions リンター） | - |
| 2026-01-25 | hurl のインストール手順を追加（E2E テスト用） | - |
| 2026-01-17 | ShellCheck のインストール手順を追加 | - |
| 2026-01-17 | lefthook のインストール手順を追加 | - |
| 2026-01-14 | IntelliJ IDEA Elm プラグイン設定を追加 | - |
| 2026-01-14 | Bun → Node.js + pnpm に変更、Elm グローバルインストールの理由を明記 | - |
| 2026-01-12 | 初版作成 | - |
