# 開発環境構築手順

## 目的

RingiFlow の開発に必要なツールをインストールする。
本手順完了後、Phase 0 の各手順を実行できる状態になる。

---

## Dev Containers を使う場合（推奨）

Dev Containers を使うと、Docker さえあれば 5 分で開発環境を構築できる。VS Code および JetBrains Gateway に対応。

詳細: [ADR-018: Dev Containers 導入](../../05_ADR/018_DevContainers導入.md)

### 前提条件

- Docker Desktop または Docker Engine がインストール済み
- VS Code または JetBrains Gateway がインストール済み

### VS Code で開く

1. リポジトリをクローン

```bash
git clone https://github.com/ka2kama/ringiflow.git
cd ringiflow
```

2. VS Code でフォルダを開く

```bash
code .
```

3. VS Code が Dev Container の検出を通知したら「Reopen in Container」をクリック

または、コマンドパレット（`Ctrl+Shift+P` / `Cmd+Shift+P`）から「Dev Containers: Reopen in Container」を実行。

4. 初回はコンテナのビルドが実行される（5〜10 分程度）

5. ビルド完了後、依存関係のインストールが自動実行される

6. 以下のコマンドで動作確認:

```bash
rustc --version    # 1.92.0
node --version     # v22.x
elm --version      # 0.19.1
just check-all     # リント + テスト
```

### JetBrains Gateway で開く

1. JetBrains Gateway を起動

2. 「Dev Containers」を選択

3. リポジトリのパスを指定し、「Connect」をクリック

4. 使用する IDE を選択（CLion, RustRover, IntelliJ IDEA 等）

5. コンテナのビルドと接続が完了したら開発開始

### 開発サーバーの起動

コンテナ内でターミナルを開き、以下を実行:

```bash
# BFF 起動（localhost:13000）
just dev-bff

# フロントエンド起動（localhost:15173）
just dev-web
```

ホストマシンのブラウザから `http://localhost:15173` にアクセス可能。

### トラブルシューティング

#### コンテナのビルドに失敗する

```bash
# キャッシュをクリアして再ビルド
docker compose -f .devcontainer/docker-compose.yml build --no-cache
```

#### ファイルの変更が反映されない

named volume にキャッシュされている可能性がある:

```bash
# node_modules を再インストール
rm -rf frontend/node_modules
pnpm install

# cargo target をクリア
cargo clean
cargo build
```

#### ポートが競合する

既存の `infra/docker/docker-compose.yml` と Dev Containers は別のコンテナを使用するが、ポートが競合する場合は既存コンテナを停止:

```bash
docker compose -f infra/docker/docker-compose.yml down
```

---

## 手動でセットアップする場合

Dev Containers を使わず、ローカル環境に直接ツールをインストールする場合は以下の手順に従う。

## 概要

本手順でインストールするツール:

| カテゴリ | ツール | バージョン | 用途 |
|---------|--------|----------|------|
| 言語 | Rust | 1.92+ | バックエンド開発 |
| ランタイム | Node.js | 22 LTS | フロントエンドビルド |
| パッケージマネージャー | pnpm | 最新 | フロントエンド依存管理 |
| 言語 | Elm | 0.19.1 | フロントエンド開発（グローバル） |
| コンテナ | Docker | 27+ | 依存サービス実行 |
| コンテナ | Docker Compose | 2.x | コンテナオーケストレーション |
| タスクランナー | just | 最新 | 開発タスク実行 |
| データベース | sqlx-cli | 最新 | マイグレーション管理 |
| Git フック | lefthook | 最新 | コミット時の自動処理 |
| リンター | ShellCheck | 最新 | シェルスクリプト静的解析 |

技術選定の詳細は [ADR-002: フロントエンドツールチェーンの選定](../../05_ADR/002_フロントエンドツールチェーンの選定.md) を参照。

---

## 1. Rust のインストール

バックエンド開発に使用するプログラミング言語。メモリ安全性と高パフォーマンスを両立する。

公式: https://www.rust-lang.org/

### 1.1 rustup のインストール

```bash
curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh
```

インストーラの質問には、デフォルト（1）を選択する。

### 1.2 環境変数の反映

```bash
source ~/.cargo/env
```

### 1.3 バージョン確認

```bash
rustc --version
# 出力例: rustc 1.92.0 (xxx)

cargo --version
# 出力例: cargo 1.92.0 (xxx)
```

### 1.4 追加コンポーネントのインストール

```bash
# フォーマッタ・リンター
rustup component add rustfmt clippy
```

### 1.5 確認

```bash
rustfmt --version
# 出力例: rustfmt 1.9.0-stable (xxx)

cargo clippy --version
# 出力例: clippy 0.1.92 (xxx)
```

---

## 2. Node.js と pnpm のインストール

Node.js はフロントエンドのビルドツール実行に必要な JavaScript ランタイム。
pnpm は高速でディスク効率の良いパッケージマネージャー。

- Node.js: https://nodejs.org/
- pnpm: https://pnpm.io/

### 2.1 Node.js のインストール

バージョン 22 LTS をインストールする。インストール方法の例:

```bash
# Volta (https://volta.sh/)
curl https://get.volta.sh | bash
source ~/.bashrc
volta install node@22

# mise (https://mise.jdx.dev/)
mise use -g node@22

# nvm (https://github.com/nvm-sh/nvm)
nvm install 22
```

### 2.2 pnpm のインストール

```bash
# Volta
volta install pnpm

# mise
mise use -g pnpm

# corepack
corepack enable
corepack prepare pnpm@latest --activate

# npm
npm install -g pnpm
```

### 2.3 バージョン確認

```bash
node --version
# 出力例: v22.x.x

pnpm --version
# 出力例: 10.x.x
```

---

## 3. Elm のインストール

フロントエンド開発に使用する関数型言語。コンパイル時エラーチェックにより実行時エラーを防ぐ。

公式: https://elm-lang.org/

Elm ツール群（elm, elm-format, elm-test）は**グローバルにインストール**する。

理由: これらの npm パッケージはネイティブバイナリを配布しており、一部のパッケージマネージャー（pnpm 等）ではローカルインストール時に正しく動作しない。詳細は [ADR-002](../../05_ADR/002_フロントエンドツールチェーンの選定.md) を参照。

### 3.1 npm でグローバルインストール

```bash
npm install -g elm elm-format elm-test
```

### 3.2 バージョン確認

```bash
elm --version
# 出力例: 0.19.1

elm-format --version
# 出力例: 0.8.7

elm-test --version
# 出力例: 0.19.1-revision17
```

---

## 4. Docker のインストール

コンテナ仮想化プラットフォーム。PostgreSQL や Redis などの依存サービスをローカルで実行する。

公式: https://www.docker.com/

### 4.1 OS 別インストール手順

各 OS の公式手順に従う:

- macOS: [Docker Desktop for Mac](https://docs.docker.com/desktop/install/mac-install/)
- Windows: [Docker Desktop for Windows](https://docs.docker.com/desktop/install/windows-install/)
- Linux (Ubuntu): 以下のコマンドを実行

```bash
# Ubuntu の場合
curl -fsSL https://get.docker.com | sh

# ユーザーを docker グループに追加（再ログインが必要）
sudo usermod -aG docker $USER
```

### 4.2 バージョン確認

```bash
docker --version
# 出力例: Docker version 27.x.x, build xxx

docker compose version
# 出力例: Docker Compose version v2.x.x
```

### 4.3 動作確認

```bash
docker run --rm hello-world
# "Hello from Docker!" が表示されれば OK
```

---

## 5. just のインストール

コマンドランナー。プロジェクトの開発タスク（ビルド、テスト、リント等）を `just <タスク名>` で実行できる。

公式: https://github.com/casey/just

### 5.1 インストール方法（いずれか）

```bash
# mise
mise use -g just

# Cargo
cargo install just

# プリビルドバイナリ（Linux）
curl --proto '=https' --tlsv1.2 -sSf https://just.systems/install.sh | bash -s -- --to ~/.local/bin

# Homebrew（macOS）
brew install just
```

### 5.2 バージョン確認

```bash
just --version
# 出力例: just 1.x.x
```

---

## 6. sqlx-cli のインストール

SQLx 用の CLI ツール。データベースマイグレーションの実行やコンパイル時クエリ検証に使用する。

公式: https://github.com/launchbadge/sqlx

詳細は [sqlx-cli 技術ノート](../../06_技術ノート/sqlx-cli.md) を参照。

### 6.1 Cargo でインストール

```bash
cargo install sqlx-cli --no-default-features --features rustls,postgres
```

### 6.2 バージョン確認

```bash
cargo sqlx --version
# 出力例: sqlx-cli x.x.x
```

---

## 7. lefthook のインストール

Git フック管理ツール。コミット時に Issue 番号を自動付与する。

公式: https://github.com/evilmartians/lefthook

### 7.1 インストール方法（いずれか）

```bash
# mise
mise use -g lefthook

# Homebrew（macOS / Linux）
brew install lefthook

# Go
go install github.com/evilmartians/lefthook@latest

# npm
npm install -g lefthook
```

### 7.2 バージョン確認

```bash
lefthook --version
# 出力例: 1.x.x
```

---

## 8. ShellCheck のインストール

シェルスクリプトの静的解析ツール。構文エラーやバグを検出する。

公式: https://www.shellcheck.net/

### 8.1 インストール方法（いずれか）

```bash
# apt（Ubuntu / Debian）
sudo apt install shellcheck

# Homebrew（macOS / Linux）
brew install shellcheck

# Cabal（Haskell）
cabal update && cabal install ShellCheck
```

### 8.2 バージョン確認

```bash
shellcheck --version
# 出力例: ShellCheck - shell script analysis tool
# version: 0.x.x
```

---

## 9. 全ツールの確認

以下のコマンドをすべて実行し、エラーがないことを確認する:

```bash
# Rust
rustc --version && cargo --version && rustfmt --version && cargo clippy --version

# Node.js / pnpm / Elm
node --version && pnpm --version && elm --version

# Docker
docker --version && docker compose version

# タスクランナー
just --version

# データベースツール
cargo sqlx --version

# Git フック
lefthook --version

# シェルスクリプトリンター
shellcheck --version
```

すべてのコマンドがバージョン情報を出力すれば、開発環境構築は完了。

---

## 10. IDE 設定（推奨）

### 10.1 VS Code 推奨拡張機能

`.vscode/extensions.json`:

```json
{
  "recommendations": [
    "rust-lang.rust-analyzer",
    "tamasfe.even-better-toml",
    "serayuzgur.crates",
    "elmtooling.elm-ls-vscode",
    "ms-azuretools.vscode-docker",
    "hashicorp.terraform",
    "skellock.just"
  ]
}
```

### 10.2 VS Code 設定

`.vscode/settings.json`:

```json
{
  "editor.formatOnSave": true,
  "[rust]": {
    "editor.defaultFormatter": "rust-lang.rust-analyzer"
  },
  "[elm]": {
    "editor.defaultFormatter": "elmtooling.elm-ls-vscode"
  },
  "rust-analyzer.cargo.features": "all",
  "rust-analyzer.check.command": "clippy"
}
```

### 10.3 IntelliJ IDEA / WebStorm 設定

#### Elm プラグインのインストール

1. **Settings → Plugins → Marketplace** で「Elm」を検索
2. **Elm** プラグインをインストール
3. IDE を再起動

#### Elm プロジェクトの設定

1. elm-stuff を生成（型情報の取得に必要）:

```bash
cd apps/web
elm make src/Main.elm --output=/dev/null
```

2. **Settings → Languages & Frameworks → Elm** を開く

3. **Elm path** を設定:

```bash
# パスを確認
which elm
# 例: /home/user/.npm-global/bin/elm
```

4. **Lamdera path** は**空欄のまま**にする（RingiFlow では Lamdera を使用しない）

5. **Projects** タブで elm.json が認識されていることを確認
   - 認識されていない場合: `apps/web/elm.json` を右クリック → **Attach elm.json project**

#### elm-format の設定

1. **Settings → Languages & Frameworks → Elm**
2. **elm-format path** を設定:

```bash
which elm-format
# 例: /home/user/.npm-global/bin/elm-format
```

3. **Run elm-format on save** にチェック（任意）

#### キャッシュのクリア（型検出が動作しない場合）

**File → Invalidate Caches → Invalidate and Restart** を実行。

---

## トラブルシューティング

### `rustup: command not found`

```bash
# パスが通っていない場合
export PATH="$HOME/.cargo/bin:$PATH"
echo 'export PATH="$HOME/.cargo/bin:$PATH"' >> ~/.bashrc
```

### `pnpm: command not found`

```bash
# Volta を使っている場合
volta install pnpm

# corepack を使う場合
corepack enable
corepack prepare pnpm@latest --activate
```

### `docker: permission denied`

```bash
# ユーザーを docker グループに追加
sudo usermod -aG docker $USER

# 再ログイン（または以下を実行）
newgrp docker
```

### Rust のビルドが遅い

```bash
# sccache をインストール（ビルドキャッシュ）
cargo install sccache

# 環境変数に追加
echo 'export RUSTC_WRAPPER=sccache' >> ~/.bashrc
source ~/.bashrc
```

### pnpm のアップグレード

```bash
# Volta を使っている場合
volta install pnpm@latest

# corepack を使う場合
corepack prepare pnpm@latest --activate

# npm でインストールしている場合
npm install -g pnpm@latest
```

### IntelliJ Elm プラグイン: `Must specify a valid path to Lamdera binary`

Lamdera は使用しないが、プラグインの仕様でパスが必要な場合がある。
回避策として **Lamdera path** に elm バイナリのパスを設定する:

1. **Settings → Languages & Frameworks → Elm**
2. **Lamdera path** に elm のパスを設定（例: `~/.volta/bin/elm`）

```bash
# パスを確認
which elm
```

実際に Lamdera として使用されることはないため、elm のパスで問題ない。

### IntelliJ Elm プラグイン: 型が検出されない

1. elm-stuff を再生成:

```bash
cd apps/web
rm -rf elm-stuff
elm make src/Main.elm --output=/dev/null
```

2. **File → Invalidate Caches → Invalidate and Restart**

3. それでも解決しない場合、Elm 設定をリセット:

```bash
# プロジェクトの .idea から Elm 設定を削除
rm -f .idea/elm.xml
```

その後 IDE を再起動し、`apps/web/elm.json` を右クリック → **Attach elm.json project**

---

## 次のステップ

開発環境構築が完了したら、[`02_プロジェクトセットアップ.md`](02_プロジェクトセットアップ.md) に進む。

---

## 変更履歴

| 日付 | 変更内容 | 担当 |
|------|---------|------|
| 2026-01-18 | Dev Containers セクションを追加 | - |
| 2026-01-17 | ShellCheck のインストール手順を追加 | - |
| 2026-01-17 | lefthook のインストール手順を追加 | - |
| 2026-01-14 | IntelliJ IDEA Elm プラグイン設定を追加 | - |
| 2026-01-14 | Bun → Node.js + pnpm に変更、Elm グローバルインストールの理由を明記 | - |
| 2026-01-12 | 初版作成 | - |
