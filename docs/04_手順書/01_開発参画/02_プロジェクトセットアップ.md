# プロジェクトセットアップ手順

## 目的

RingiFlow のローカル開発環境をセットアップする。
`just setup` コマンドで以下を自動的に行う:

- 開発ツールの存在確認
- 環境変数ファイルの作成
- 依存関係のインストール
- Docker サービスの起動
- データベースマイグレーション

## 前提条件

- [`01_開発環境構築.md`](01_開発環境構築.md) に従い、必須ツールがインストール済み
- Git リポジトリがクローン済み

---

## 1. セットアップの実行

### 操作

プロジェクトルートで以下を実行:

```bash
just setup
```

### 期待される出力

```
開発ツールを確認中...
✓ 全ツール確認済み
環境変数ファイルを確認中...
  作成: .env
  作成: apps/core-service/.env
  作成: apps/web/.env
✓ 環境変数ファイル準備完了
依存関係をインストール中...
  Rust...
  Elm/Vite...
✓ 依存関係インストール完了
[+] Running ...
✓ Docker サービス起動完了
データベースをセットアップ中...
✓ マイグレーション完了

✓ セットアップ完了
  - just dev-api  : バックエンド起動
  - just dev-web  : フロントエンド起動
```

---

## 2. セットアップの確認

### 2.1 バックエンドの動作確認

```bash
# ターミナル1: バックエンド起動
just dev-api
```

別ターミナルで:

```bash
curl -s http://localhost:13000/health | jq .
```

期待される出力:

```json
{
  "status": "healthy",
  "version": "0.1.0"
}
```

### 2.2 フロントエンドの動作確認

```bash
# ターミナル2: フロントエンド起動
just dev-web
```

ブラウザで `http://localhost:15173/` を開き、ページが表示されることを確認。

### 2.3 データベース接続確認

```bash
# Docker 経由で接続
docker exec -it ringiflow-postgres psql -U ringiflow -d ringiflow -c "SELECT 1"
```

---

## 3. 各サブタスクの説明

`just setup` は以下のサブタスクを順に実行する。
個別に実行することも可能。

### check-tools

```bash
just check-tools
```

開発に必要なツールがインストールされているか確認する。
不足がある場合、エラーメッセージを表示して終了する。

確認するツール:
- `rustc`, `cargo` - Rust コンパイラ
- `node`, `pnpm` - Node.js 環境
- `elm` - Elm コンパイラ
- `docker` - コンテナ実行環境
- `sqlx` - データベースマイグレーション

### setup-env

```bash
just setup-env
```

`.env.template` から `.env` を作成する。
既存の場合はスキップ（上書きしない）。

作成するファイル:
- `/.env` - プロジェクトルート
- `/apps/core-service/.env` - Core Service
- `/apps/web/.env` - フロントエンド

### setup-deps

```bash
just setup-deps
```

依存関係をインストールする。

- Rust: `cargo build` でクレートをダウンロード・ビルド
- Elm/Vite: `pnpm install` で npm パッケージをインストール

### dev-deps

```bash
just dev-deps
```

Docker で依存サービス（PostgreSQL, Redis）を起動する。

→ 参照: [`/infra/docker/docker-compose.yaml`](/infra/docker/docker-compose.yaml)

### setup-db

```bash
just setup-db
```

SQLx マイグレーションを実行する。
Docker サービス起動後、少し待ってから実行する（接続待ち）。

→ 参照: [`/backend/migrations/`](/backend/migrations/)

---

## トラブルシューティング

### `just check-tools` でエラー

```
ERROR: xxx がインストールされていません
```

[`01_開発環境構築.md`](01_開発環境構築.md) を参照してインストールする。

### `just setup-deps` でビルドエラー

```bash
# Rust ビルドエラーの場合
cargo build 2>&1 | head -50

# 依存クレートのバージョン競合の場合
rm Cargo.lock
cargo build
```

### Docker サービスが起動しない

```bash
# 状態確認
docker compose -f infra/docker/docker-compose.yaml ps

# ログ確認
docker compose -f infra/docker/docker-compose.yaml logs postgres
docker compose -f infra/docker/docker-compose.yaml logs redis

# 再起動
docker compose -f infra/docker/docker-compose.yaml down
docker compose -f infra/docker/docker-compose.yaml up -d
```

### ポート 15432 が使用中

```bash
# 使用中のプロセスを確認
lsof -i :15432

# ローカルの PostgreSQL を停止
sudo systemctl stop postgresql
```

### `just setup-db` でマイグレーションエラー

```bash
# PostgreSQL が起動完了しているか確認
docker exec -it ringiflow-postgres pg_isready -U ringiflow

# 手動でマイグレーション実行
cd apps/core-service && sqlx migrate run
```

### Rust のビルドが遅い

sccache がインストール済みであれば、`backend/.cargo/config.toml` により自動的にキャッシュが有効になっている。

```bash
# sccache の動作確認
sccache --show-stats

# インストールされていない場合
cargo install sccache --locked
```

---

## 開発時のよく使うコマンド

| 操作 | コマンド |
|------|---------|
| バックエンド起動 | `just dev-api` |
| フロントエンド起動 | `just dev-web` |
| Docker 起動 | `just dev-deps` |
| フォーマット | `just fmt` |
| リント | `just lint` |
| テスト | `just test` |
| 全チェック（CI相当） | `just ci` |
| クリーンアップ | `just clean` |

---

## 次のステップ

セットアップが完了したら、開発を開始できる。

- 要件定義: [`docs/01_要件定義書/00_はじめに.md`](../../01_要件定義書/00_はじめに.md)
- 設計・実装ロードマップ: [`docs/03_詳細設計書/00_実装ロードマップ.md`](../../03_詳細設計書/00_実装ロードマップ.md)

---

## 変更履歴

| 日付 | 変更内容 | 担当 |
|------|---------|------|
| 2026-01-13 | 初版作成 | - |
