# 実装ガイドライン

## 概要

本ドキュメントは、RingiFlow の実装における共通ガイドラインを定義する。
言語・フレームワーク固有の規約とプロジェクト横断の原則を含む。

---

## Elm フロントエンド

### Ports 設計

Ports は `Ports` または `Interop` モジュールに集約する。

```elm
-- src/Ports.elm
port module Ports exposing
    ( sendMessage
    , receiveMessage
    )

import Json.Encode as Encode

port sendMessage : Encode.Value -> Cmd msg
port receiveMessage : (Encode.Value -> msg) -> Sub msg
```

### メッセージエンベロープ

Ports を介したメッセージは以下の形式を使用する。

```json
{
  "v": 1,
  "type": "WORKFLOW_UPDATED",
  "payload": { ... },
  "correlationId": "550e8400-e29b-41d4-a716-446655440000",
  "ts": 1705142400000
}
```

| フィールド | 型 | 説明 |
|-----------|-----|------|
| v | Int | メッセージバージョン |
| type | String | メッセージタイプ |
| payload | Value | ペイロード |
| correlationId | String | 追跡用 ID |
| ts | Int | タイムスタンプ（Unix ms） |

### 受信データの検証

Ports からの受信データは必ず `Json.Decode` で検証する。

```elm
receiveMessage : Encode.Value -> Msg
receiveMessage value =
    case Decode.decodeValue messageDecoder value of
        Ok message ->
            ReceivedMessage message

        Err error ->
            ReceivedInvalidMessage (Decode.errorToString error)
```

### WebSocket 再接続

JavaScript 側で指数バックオフ + ジッタを使用する。

```javascript
// 再接続ロジック
const reconnect = (attempt) => {
  const baseDelay = 1000;
  const maxDelay = 30000;
  const jitter = Math.random() * 1000;
  const delay = Math.min(baseDelay * Math.pow(2, attempt), maxDelay) + jitter;

  setTimeout(() => connect(), delay);
};
```

再接続時またはシーケンスギャップ検出時は HTTP 経由で状態を再同期する。

---

## Rust バックエンド

### correlationId の伝播

構造化ログに `correlationId` を全レイヤーで伝播する。

```rust
use tracing::{info, span, Level};

async fn handle_request(
    correlation_id: CorrelationId,
    request: Request,
) -> Response {
    let span = span!(Level::INFO, "request", correlation_id = %correlation_id);
    let _enter = span.enter();

    info!("Processing request");
    // ...
}
```

### エラー分類

エラーは以下のカテゴリに分類する。

| カテゴリ | HTTP Status | 説明 | 例 |
|---------|-------------|------|-----|
| 入力不正 | 400 | クライアントからの不正入力 | バリデーションエラー |
| 認証エラー | 401 | 認証失敗 | トークン無効 |
| 認可エラー | 403 | 権限不足 | アクセス拒否 |
| 競合 | 409 | リソース状態の競合 | 楽観的ロック失敗 |
| 依存障害 | 502/503 | 外部サービス障害 | DB 接続失敗 |
| 資源枯渇 | 429/503 | リソース制限 | レート制限 |
| 内部不具合 | 500 | 予期しないエラー | パニック |

```rust
#[derive(Debug, thiserror::Error)]
pub enum AppError {
    #[error("入力が不正です: {0}")]
    InvalidInput(String),

    #[error("認証が必要です")]
    Unauthorized,

    #[error("アクセスが拒否されました")]
    Forbidden,

    #[error("リソースが競合しています")]
    Conflict,

    #[error("外部サービスが利用できません: {0}")]
    DependencyFailure(String),

    #[error("リソースが枯渇しています")]
    ResourceExhausted,

    #[error("内部エラーが発生しました")]
    Internal(#[from] anyhow::Error),
}
```

### 冪等性保証

コマンド/イベントハンドラは `commandId`/`eventId` による冪等性を保証する。

```rust
async fn handle_command(
    command_id: CommandId,
    command: Command,
) -> Result<(), AppError> {
    // 既に処理済みかチェック
    if command_store.exists(&command_id).await? {
        return Ok(()); // 冪等: 成功として返す
    }

    // コマンド処理
    let events = process_command(command)?;

    // コマンドとイベントを保存（トランザクション）
    command_store.save(&command_id, &events).await?;

    Ok(())
}
```

### 外部依存の保護

外部依存にはサーキットブレーカとレート制限を適用する。

```rust
use governor::{Quota, RateLimiter};
use std::num::NonZeroU32;

// レート制限
let rate_limiter = RateLimiter::direct(
    Quota::per_second(NonZeroU32::new(100).unwrap())
);

// サーキットブレーカ
let circuit_breaker = CircuitBreaker::new()
    .failure_threshold(5)
    .success_threshold(3)
    .timeout(Duration::from_secs(30));
```

---

## 横断的関心事

### ログ出力

| レベル | 用途 |
|--------|------|
| ERROR | 即時対応が必要なエラー |
| WARN | 注意が必要だが継続可能 |
| INFO | 重要なビジネスイベント |
| DEBUG | 開発時のデバッグ情報 |
| TRACE | 詳細なトレース情報 |

本番環境では INFO 以上を出力する。

### 設定管理

環境変数で設定を注入する。秘匿情報はシークレットマネージャーを使用する。

```rust
// 設定読み込み
#[derive(Debug, Clone, serde::Deserialize)]
pub struct Config {
    #[serde(default = "default_port")]
    pub port: u16,

    pub database_url: String,  // 環境変数から
}
```

### テスト方針

| テスト種別 | 対象 | ツール |
|-----------|------|--------|
| 単体テスト | ドメインロジック | cargo test |
| 統合テスト | API エンドポイント | cargo test + testcontainers |
| E2E テスト | ユーザーシナリオ | Playwright |
| プロパティテスト | 不変条件 | proptest |

---

## 関連ドキュメント

- アーキテクチャ概要: [05_アーキテクチャ概要.md](05_アーキテクチャ概要.md)
- ID 設計規約: [04_ID設計規約.md](04_ID設計規約.md)
- API 設計: [03_API設計_MVP.md](03_API設計_MVP.md)

---

## 変更履歴

| 日付 | 変更内容 | 担当 |
|------|---------|------|
| 2026-01-13 | 初版作成（CLAUDE.md から分離） | - |
