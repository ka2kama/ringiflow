# アーキテクチャ概要

## 概要

本ドキュメントは RingiFlow のシステムアーキテクチャの全体像を定義する。

## システム構成図

```mermaid
flowchart TB
    subgraph Internet
        User["ユーザー"]
    end

    subgraph Edge["エッジ層"]
        CF["CloudFront"]
        WAF["WAF"]
    end

    subgraph Web["Web 層"]
        ALB["ALB"]
        BFF["BFF\nRust/axum"]
        Static["Static\nS3 + Elm App"]
    end

    subgraph App["App 層"]
        Core["Core API\nRust/axum"]
    end

    subgraph Data["Data 層"]
        Aurora["Aurora\nPostgreSQL"]
        DynamoDB["DynamoDB\nEvent Store"]
        S3["S3\nFiles"]
        Redis["ElastiCache\nRedis"]
    end

    subgraph External["外部"]
        IdP["外部 IdP\nOIDC/SAML"]
    end

    User --> CF
    CF --> WAF
    WAF --> ALB
    ALB --> BFF
    ALB --> Static
    BFF -->|HTTP 内部| Core
    BFF --> Redis
    Core --> Aurora
    Core --> DynamoDB
    Core --> S3
    BFF -.-> IdP
```

## レイヤー構成

| レイヤー | 責務 | 技術 |
|---------|------|------|
| CDN | 静的配信、キャッシュ、DDoS 緩和 | CloudFront |
| WAF | Web アプリケーション防御 | AWS WAF |
| LB | ルーティング、TLS 終端 | ALB |
| BFF | セッション管理、認証、API プロキシ | Rust/axum |
| Core API | ビジネスロジック、ドメイン処理 | Rust/axum |
| Data | 永続化、キャッシュ | Aurora, DynamoDB, S3, Redis |

## 主要なアーキテクチャパターン

### BFF パターン

ブラウザは BFF（Backend for Frontend）とのみ通信する。

```mermaid
flowchart LR
    Browser["Browser"] --> BFF["BFF"]
    BFF --> CoreAPI["Core API"]
    CoreAPI --> Database["Database"]
    BFF --> Session["Session\nRedis"]
```

利点:
- トークンをフロントエンドに露出しない
- セッション管理をサーバサイドに集約
- フロントエンド向けに最適化された API を提供

### セッション管理

HTTPOnly Cookie + Redis によるサーバサイドセッション。

| 項目 | 値 |
|------|-----|
| Cookie 属性 | HttpOnly, Secure, SameSite=Strict |
| セッションストア | ElastiCache Redis |
| セッション ID | UUID v4 |
| 有効期限 | 設定可能（デフォルト 24 時間） |

### マルチテナント

Pool モデル（共有 DB + tenant_id による行レベル分離）。

```sql
-- すべてのテーブルに tenant_id を持つ
CREATE TABLE tasks (
    id UUID PRIMARY KEY,
    tenant_id UUID NOT NULL,  -- 分離キー
    ...
);

-- Row Level Security (RLS) で強制
ALTER TABLE tasks ENABLE ROW LEVEL SECURITY;
CREATE POLICY tenant_isolation ON tasks
    USING (tenant_id = current_setting('app.tenant_id')::UUID);
```

### イベント駆動

CQRS + Event Sourcing パターン。

```mermaid
flowchart LR
    Command["Command"] --> Handler["Command Handler"]
    Handler --> Event["Event"]
    Event --> Store["Event Store\nDynamoDB"]
    Event --> EventHandler["Event Handler"]
    EventHandler --> ReadModel["Read Model\nAurora"]
```

特徴:
- コマンドとクエリの分離
- イベントによる状態変更の記録
- 結果整合性モデル

### WebSocket 通信

接続管理は JavaScript 側、Elm は Ports 経由でイベントを受信。

```mermaid
flowchart LR
    subgraph Browser
        JS["JavaScript"]
        Elm["Elm App"]
        JS -->|Ports| Elm
    end
    JS <-->|WebSocket| BFF["BFF"]
    BFF --> Core["Core API"]
```

## コンポーネント間通信

| 通信 | プロトコル | 認証 |
|------|-----------|------|
| Browser → BFF | HTTPS | Session Cookie |
| BFF → Core API | HTTP (内部) | 内部トークン or mTLS |
| Core API → Aurora | PostgreSQL | IAM 認証 |
| Core API → DynamoDB | HTTPS | IAM 認証 |
| Core API → S3 | HTTPS | IAM 認証 |
| BFF → Redis | Redis Protocol | AUTH |

## セキュリティ境界

```mermaid
flowchart TB
    subgraph Public["Public Zone"]
        CF["CloudFront"]
        WAF["WAF"]
    end

    subgraph PrivateWeb["Private Subnet - Web"]
        ALB["ALB"]
        BFF["BFF"]
    end

    subgraph PrivateApp["Private Subnet - App"]
        Core["Core API"]
    end

    subgraph PrivateData["Private Subnet - Data"]
        Aurora["Aurora"]
        Redis["ElastiCache"]
        DynamoDB["DynamoDB Endpoint"]
    end

    Public --> PrivateWeb
    PrivateWeb --> PrivateApp
    PrivateApp --> PrivateData
```

## 関連ドキュメント

- プロジェクト構造: [01_プロジェクト構造設計.md](01_プロジェクト構造設計.md)
- データベース設計: [02_データベース設計_MVP.md](02_データベース設計_MVP.md)
- API 設計: [03_API設計_MVP.md](03_API設計_MVP.md)

## 変更履歴

| 日付 | 変更内容 | 担当 |
|------|---------|------|
| 2026-01-13 | 初版作成（CLAUDE.md から分離） | - |
