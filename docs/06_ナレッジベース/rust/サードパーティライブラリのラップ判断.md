# サードパーティライブラリのラップ判断

## 概要

Rust は標準ライブラリが意図的に小さく、日時（chrono）、UUID（uuid）、非同期ランタイム（tokio）など、他の言語なら標準で提供される機能がサードパーティクレートに依存する。

このドキュメントでは、ドメイン層でサードパーティクレートの型を直接使用するか、Newtype ラッパーで隔離するかの判断基準を整理する。

注意: ここで扱うのは「依存隔離のためのラップ」であり、型安全性のための Newtype（例: `UserId(Uuid)` で `Uuid` の取り違えを防ぐ）とは目的が異なる。型安全性のための Newtype については [Newtype パターン](Newtypeパターン.md) を参照。

## 判断基準

ラップの要否は **安定性** と **置換可能性** で判断する。

### ラップ不要: 言語標準の延長

エコシステム全体が依存し、置換コストが非現実的なクレートの型。

| クレート | 型の例 | 理由 |
|---------|--------|------|
| chrono | `DateTime<Utc>` | Rust のデファクト日時型。sqlx, serde 等が直接サポート |
| uuid | `Uuid` | 同上。DB 層との統合がシームレス |
| rust_decimal | `Decimal` | 金融計算の標準 |
| serde | `Serialize`, `Deserialize` | derive マクロ経由。ラップしようがない |

これらは「外部ライブラリ」というより「言語標準の延長」として扱える。

### ラップ不要: trait で抽象化済み

Repository パターンなどで間接化されているインフラ層の依存。

| クレート | 扱い | 理由 |
|---------|------|------|
| sqlx | Repository trait の背後 | ドメイン層に型が漏れない |
| redis | 同上 | 同上 |
| reqwest | HTTP クライアント trait の背後 | 同上 |

型自体をラップする必要はなく、アーキテクチャのレイヤー分離で制御する。

### ラップを検討: 置換可能性がある

API が大きく、実装詳細が漏れやすいライブラリ。

| 状況 | 例 |
|------|-----|
| 暗号ライブラリの差し替え可能性 | `ring` → `aws-lc-rs` |
| バリデーションライブラリ | ドメインルールと密結合するため |
| 特定ベンダーの SDK | クラウドプロバイダ変更の可能性 |

## 判定フロー

```
将来別のクレートに差し替える現実的なシナリオがあるか？
├── No → ラップ不要。直接使用
└── Yes → ドメイン層にその型が露出するか？
    ├── No → ラップ不要。レイヤー分離で十分
    └── Yes → ラップを検討
```

## データ型とインフラ依存の区別

ドメイン層に `DateTime<Utc>` が出てくることと、ドメイン層で `sqlx::query` を呼ぶことは本質的に異なる。

| 分類 | 例 | ドメイン層での扱い |
|------|-----|-------------------|
| データ型 | `DateTime<Utc>`, `Uuid`, `Decimal` | 直接使用して問題ない |
| インフラ依存 | `sqlx`, `reqwest`, `redis` | trait 境界で隔離すべき |

データ型はドメインモデルの「語彙」の一部であり、インフラ依存はドメインモデルの「実装詳細」。この区別が判断の核心。

## RingiFlow での適用

| クレート | 判断 | 根拠 |
|---------|------|------|
| chrono | 直接使用 | デファクト日時型。テスタビリティはコンストラクタ注入で確保済み |
| uuid | 直接使用 | デファクト UUID 型。Newtype は型安全性目的（`UserId` 等）で使用 |
| sqlx | レイヤー分離 | Repository trait で抽象化。ドメイン層に型が漏れない |
| serde | 直接使用 | derive マクロ経由。ラップ不可能 |
| tokio | 直接使用 | 非同期ランタイム。apps 層に閉じている |
| axum | 直接使用 | Web フレームワーク。apps 層に閉じている |

## 関連ドキュメント

- [Newtype パターン](Newtypeパターン.md) — 型安全性のための Newtype
- [ADR-016: プリミティブ型の Newtype 化方針](../../05_ADR/016_プリミティブ型のNewtype化方針.md)

---

変更履歴:

| 日付 | 変更内容 |
|------|---------|
| 2026-02-05 | 初版作成。chrono ラップ判断の議論から知見を整理 |
