# 実装ガイドライン

## 概要

本ドキュメントは、RingiFlow の実装における共通ガイドラインを定義する。
言語・フレームワーク固有の規約とプロジェクト横断の原則を含む。

---

## Elm フロントエンド

### Ports 設計

Ports の詳細な設計パターンはナレッジベースを参照。

→ [Elm Ports（JavaScript 連携）](../06_ナレッジベース/elm/Elmポート.md)

本プロジェクトでの方針:
- Ports は `src/Ports.elm` に集約
- メッセージエンベロープ形式を使用（バージョン管理対応）
- WebSocket 再接続は指数バックオフ + ジッタ

---

## Rust バックエンド

### correlationId の伝播

構造化ログに `correlationId` を全レイヤーで伝播する。

```rust
use tracing::{info, span, Level};

async fn handle_request(
    correlation_id: CorrelationId,
    request: Request,
) -> Response {
    let span = span!(Level::INFO, "request", correlation_id = %correlation_id);
    let _enter = span.enter();

    info!("Processing request");
    // ...
}
```

### エラー分類

エラーハンドリングの詳細はナレッジベースを参照。

→ [Rust エラーハンドリング](../06_ナレッジベース/rust/Rustエラーハンドリング.md)

本プロジェクトでの方針:
- `thiserror` + `anyhow` を使用
- RFC 7807 準拠のエラーレスポンス
- 内部エラーの詳細はログのみ（セキュリティ考慮）

### 冪等性保証

コマンド/イベントハンドラは `commandId`/`eventId` による冪等性を保証する。

```rust
async fn handle_command(
    command_id: CommandId,
    command: Command,
) -> Result<(), AppError> {
    // 既に処理済みかチェック
    if command_store.exists(&command_id).await? {
        return Ok(()); // 冪等: 成功として返す
    }

    // コマンド処理
    let events = process_command(command)?;

    // コマンドとイベントを保存（トランザクション）
    command_store.save(&command_id, &events).await?;

    Ok(())
}
```

### 外部依存の保護

外部依存にはサーキットブレーカとレート制限を適用する。

```rust
use governor::{Quota, RateLimiter};
use std::num::NonZeroU32;

// レート制限
let rate_limiter = RateLimiter::direct(
    Quota::per_second(NonZeroU32::new(100).unwrap())
);

// サーキットブレーカ
let circuit_breaker = CircuitBreaker::new()
    .failure_threshold(5)
    .success_threshold(3)
    .timeout(Duration::from_secs(30));
```

---

## 横断的関心事

### ログ出力

| レベル | 用途 |
|--------|------|
| ERROR | 即時対応が必要なエラー |
| WARN | 注意が必要だが継続可能 |
| INFO | 重要なビジネスイベント |
| DEBUG | 開発時のデバッグ情報 |
| TRACE | 詳細なトレース情報 |

本番環境では INFO 以上を出力する。

### 設定管理

環境変数で設定を注入する。秘匿情報はシークレットマネージャーを使用する。

```rust
// 設定読み込み
#[derive(Debug, Clone, serde::Deserialize)]
pub struct Config {
    #[serde(default = "default_port")]
    pub port: u16,

    pub database_url: String,  // 環境変数から
}
```

### テスト方針

| テスト種別 | 対象 | ツール |
|-----------|------|--------|
| 単体テスト | ドメインロジック | cargo test |
| 統合テスト | API エンドポイント | cargo test + testcontainers |
| E2E テスト | ユーザーシナリオ | Playwright |
| プロパティテスト | 不変条件 | proptest |

---

## 関連ドキュメント

- アーキテクチャ概要: [02_基本設計書/00_アーキテクチャ概要.md](../02_基本設計書/00_アーキテクチャ概要.md)
- ID 設計規約: [04_ID設計規約.md](04_ID設計規約.md)
- API 設計: [03_API設計.md](03_API設計.md)

---

## 変更履歴

| 日付 | 変更内容 | 担当 |
|------|---------|------|
| 2026-01-13 | 初版作成（CLAUDE.md から分離） | - |
