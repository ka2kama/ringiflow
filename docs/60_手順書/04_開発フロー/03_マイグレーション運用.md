# マイグレーション運用

## 概要

データベーススキーマの変更（マイグレーション）に関する運用手順。

技術詳細: [sqlx-cli](../../80_ナレッジベース/rust/sqlx-cli.md)

---

## マイグレーションファイル追加後の手順

マイグレーションファイルを追加・変更した後は、以下を実行する。

### 1. マイグレーションを適用

```bash
just setup-db
```

または直接:

```bash
cd backend && sqlx migrate run
```

### 2. SQLx キャッシュを更新（必要な場合）

`sqlx::query!` マクロを使用するクエリを追加・変更した場合のみ:

```bash
cd backend && cargo sqlx prepare --workspace -- --all-targets
git add backend/.sqlx/
```

### 3. 動作確認

```bash
just test
```

---

## データベースを初期状態に戻す

シードデータを含めて最初からやり直す場合:

```bash
just reset-db
```

内部で実行される処理:
1. データベースを削除（drop）
2. データベースを作成（create）
3. 全マイグレーションを適用（migrate run）

---

## よくある操作

| 操作 | コマンド |
|------|---------|
| 新規マイグレーション追加 | `cd backend && sqlx migrate add <name>` |
| マイグレーション適用 | `just setup-db` |
| データベースリセット | `just reset-db` |
| マイグレーション状態確認 | `cd backend && sqlx migrate info` |
| SQLx キャッシュ更新 | `cd backend && cargo sqlx prepare --workspace -- --all-targets` |

---

## 変更履歴

| 日付 | 変更内容 | 担当 |
|------|---------|------|
| 2026-01-17 | 初版作成 | - |
