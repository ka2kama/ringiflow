---
name: explain
description: 機能やPRの解説ドキュメントを生成する。機能ベースとソースコードベースの2つの視点で、図表を多用した理解促進ドキュメントを作成する。
argument-hint: <PR番号, ブランチ名, または機能領域名（例: 認証フロー, Page/Workflow/Detail.elm）>
user-invocable: true
---

# 解説ドキュメント生成

対象を分析し、2つの視点（機能・コード）で解説ドキュメントを生成する。

## 引数

$ARGUMENTS

## モード判定

引数が省略された場合は、何を解説するかユーザーに質問する。

引数がある場合は、種類でモードを自動判定する。

| 引数 | モード | 分析対象 |
|------|--------|---------|
| PR 番号（例: `123`） | diff | PR の差分 |
| ブランチ名（例: `feature/34-user-auth`） | diff | ブランチの差分 |
| 機能領域名（例: `認証フロー`） | feature | 既存コード |
| ファイルパス（例: `Page/Workflow/Detail.elm`） | feature | 指定ファイル周辺のコード |
| 省略 | — | ユーザーに質問する |

## 出力

2つのドキュメントを対で生成する。

| ドキュメント | 視点 | diff モード | feature モード |
|-------------|------|-----------|---------------|
| 機能解説 | What / Why | 変更内容と理由を記述 | 機能の動作と設計理由を記述 |
| コード解説 | How / Where | 変更されたコードの詳細を記述 | コード構成と実装の詳細を記述 |

配置先: `docs/07_実装解説/` の該当機能ディレクトリ

### 設計判断の棲み分け

設計判断は2つのドキュメントで視点が異なる。同じ判断を二重に書かない。

| | 機能解説の設計判断 | コード解説の設計解説 |
|---|---|---|
| 視点 | 仕組み・方式の選択（What / Why） | コードパターン・実装の選択（How / Where） |
| 問い | 「どういう仕組みを採用するか」 | 「その仕組みをどう実装するか」 |
| 例 | セッション変数 vs ロール切替 vs パラメータ | `pool_options()` 関数抽出 vs 直接埋め込み |
| 例 | 返却時リセット vs 取得時リセット | `Deref/DerefMut` vs `as_conn()` メソッド |

## 手順

### Step 1: 対象の情報を収集

#### diff モード

```bash
# PR 番号指定の場合
gh pr view <PR番号> --json title,body,baseRefName,headRefName,files
gh pr diff <PR番号>

# 現在のブランチの場合
git log --oneline --reverse HEAD --not main
git diff --stat main...HEAD
git diff main...HEAD
```

| 情報 | コマンド | 用途 |
|------|---------|------|
| コミット履歴 | `git log --oneline --reverse HEAD --not main` | 変更の時系列 |
| 変更ファイル統計 | `git diff --stat main...HEAD` | 影響範囲の把握 |
| 差分全体 | `git diff main...HEAD` | 詳細分析 |
| 関連 Issue | PR 本文から抽出 | コンテキスト |
| 設計書 | Issue や PR から特定 | Before の把握 |

#### feature モード

1. 指定された機能領域に関連するファイルを特定する（Glob / Grep）
2. 関連する設計書、要件定義書を確認する
3. 主要なファイルを Read で読み込む
4. アーキテクチャ上の位置づけを把握する

### Step 2: 出力先を決定

1. `docs/07_実装解説/` の既存ディレクトリを確認する
2. 該当する機能ディレクトリがあればそこに配置、なければ新規作成する

ファイル命名:

```
docs/07_実装解説/NN_<機能名>/
├── ...（既存ファイル）
├── NN_<トピック>_機能解説.md
└── NN_<トピック>_コード解説.md
```

- `NN` はディレクトリ内の次の連番
- 命名規則の詳細: [`docs/07_実装解説/README.md`](../../../docs/07_実装解説/README.md#ファイル命名規則)

出力先をユーザーに提示し、確認を得てから Step 3 に進む。

### Step 3: 機能解説ドキュメントを生成

各セクションには Mermaid 図またはテーブルを含める。

---

#### 3.1 概要

```markdown
# <機能名> - 機能解説

<!-- diff モード -->
対応 PR: #<PR番号>
対応 Issue: #<Issue番号>

<!-- feature モード -->
対象: <機能領域の説明>

## 概要

<1-2段落で記述>
```

#### 3.2 背景

変更の動機、前提知識、全体の中での位置づけを記述する。読者が「なぜこの機能/変更が必要なのか」を把握できるようにする。

**diff モード:**

```markdown
## 背景

### <前提となるアーキテクチャ/設計方針>

<この変更が必要になった前提を記述>

### <変更前の課題>

<変更前の状態と、何が問題だったかを記述>
<課題のポイントを箇条書き>

### <設計方針との対応>

<設計書や要件で定められた方針を引用し、この変更がどこに該当するか>

| 項目 | 内容 |
|------|------|
| ... | ... |

### <Epic/Issue 全体の中での位置づけ>

<全体の構成を示し、本 PR がどの部分を担うか>

<Mermaid flowchart: Issue 間の依存関係>

| Issue | 内容 | 状態 |
|-------|------|------|
| ... | ... | ... |
```

**feature モード:**

```markdown
## 背景

### <この機能が必要な理由>

<業務上・技術上の動機>

### <アーキテクチャ上の位置づけ>

<全体構成の中でこの機能がどこにあるか>
```

新規機能（背景が薄い場合）でも、最低限「なぜこの機能が存在するか」「全体のどこに位置するか」を記述する。

#### 3.3 用語・概念

```markdown
## 用語・概念

| 用語 | 説明 | 関連コード |
|------|------|-----------|
| <用語> | <説明> | `<型名 or モジュール>` |
```

含める対象:
- ドメイン固有の概念
- 技術的な概念
- 理解に必要な前提知識

#### 3.4 フロー

モードによって構成が異なる。

**diff モード — ビフォー・アフター:**

変更前後のフローを対比する。

```markdown
## ビフォー・アフター

### Before（変更前）

<変更前の状態・フロー・制約を記述>
<Mermaid 図>

#### 制約・課題

- <変更が必要だった理由>

### After（変更後）

<変更後の状態・フロー・改善点を記述>
<Mermaid 図: Before と同じ種類で対比>

#### 改善点

- <改善された点>
```

新規機能（Before がない場合）はビフォー・アフターを省略し、After のフローのみ記述する。

**feature モード — 現在のフロー:**

```markdown
## フロー

<現在の状態・フローを記述>
<Mermaid 図>
```

図の種類の選択基準:

| 対象の性質 | 推奨する図 |
|----------|-----------|
| API | sequenceDiagram（リクエストフロー） |
| 状態管理 | stateDiagram-v2（状態遷移） |
| アーキテクチャ | flowchart（コンポーネント構成） |
| UI | flowchart（画面遷移）+ テーブル（UI 要素） |
| データモデル | erDiagram（ER 図）または classDiagram |

#### 3.5 アーキテクチャ

関連するレイヤーとコンポーネントの全体像を示す。

```markdown
## アーキテクチャ

<Mermaid flowchart: レイヤー構成とデータの流れ>
```

subgraph でレイヤーを分離する。diff モードでは変更したコンポーネントを明示する。

#### 3.6 データフロー

主要な操作のデータフローをシーケンス図で記述する。

```markdown
## データフロー

### フロー N: <操作名>

<Mermaid sequenceDiagram>

#### 処理ステップ

| # | レイヤー | ファイル:関数 | 処理内容 |
|---|---------|-------------|---------|
| 1 | ... | ... | ... |
```

#### 3.7 状態遷移（該当する場合）

```markdown
## 状態遷移

### <エンティティ名>

<Mermaid stateDiagram-v2>
```

#### 3.8 データ変換の流れ（該当する場合）

```markdown
## データ変換

### リクエストの変換

<型変換の流れ>

### レスポンスの変換

<型変換の流れ>
```

#### 3.9 エラーハンドリング（該当する場合）

```markdown
## エラーハンドリング

| エラー | 発生箇所 | HTTP Status | ユーザーへの表示 |
|-------|---------|-------------|---------------|
| ... | ... | ... | ... |
```

#### 3.10 設計判断

仕組み・方式レベルの判断を記載する。コード実装レベルの判断はコード解説の設計解説に記載する。

各判断は以下の構成で記述する:

1. **見出し**: 「問い」の形にする（「〜をどうするか」）
2. **文脈**: なぜその判断が必要だったかを 1-2 文で説明
3. **比較テーブル**: 選択肢を並べ、判断に最も影響する軸をテーブルの列にする
4. **採用理由**: 1-2 文で結論

```markdown
## 設計判断

機能・仕組みレベルの判断を記載する。コード実装レベルの判断は[コード解説](./<NN>_コード解説.md#設計解説)を参照。

### N. <〜をどうするか>

<なぜこの判断が必要だったか: 1-2文の文脈説明>

| 案 | <判断軸1> | <判断軸2> | <判断軸3> |
|----|----------|----------|----------|
| **<採用案>（採用）** | ... | ... | ... |
| <代替案1> | ... | ... | ... |
| <代替案2> | ... | ... | ... |

**採用理由**: <1-2文>
```

#### 3.11 関連ドキュメント

```markdown
## 関連ドキュメント

- [コード解説](./<NN>_コード解説.md)
- [設計書](...)
```

---

### Step 4: コード解説ドキュメントを生成

コード解説の主役は**コードフロー**。ファイル一覧や変更統計ではなく、「コードがどう流れるか」をライフサイクル順に追う。

---

#### 4.1 ヘッダー

```markdown
# <機能名> - コード解説

<!-- diff モード -->
対応 PR: #<PR番号>
対応 Issue: #<Issue番号>

<!-- feature モード -->
対象: <機能領域の説明>
```

#### 4.2 主要な型・関数

コードフローに登場する型・関数のクイックリファレンス。型同士に包含・委譲・Deref 連鎖などの関係がある場合は、テーブルに加えて **classDiagram** で関係を可視化する。

```markdown
## 主要な型・関数

| 型/関数 | ファイル | 責務 |
|--------|---------|------|
| `TypeName` | [`path:line`](relative-link) | <説明> |

### 型の関係

<Mermaid classDiagram: 主要な型の関係（ラップ、Deref、トレイト実装など）>
```

型の関係図が不要なケース（関数のみ、型が 1 つだけ等）は省略してよい。

#### 4.3 コードフロー

**コード解説の中心セクション。** コードをライフサイクル順（時系列）に追い、各ステップでコード抜粋と注目ポイントを記述する。

レイヤー別（ファイル別）ではなく、処理の流れに沿って構成する。

```markdown
## コードフロー

コードをライフサイクル順に追う。各ステップの構造を図で示した後、対応するコードを解説する。

<Mermaid flowchart: ライフサイクルの概要図（ステップ間の遷移）>

### N. <ステップ名>（<いつ実行されるか>）

<このステップで何が起きるかを 1-2 文で説明>

<Mermaid 図: このステップの構造・関係・流れを可視化>

```rust
// path/to/file.rs:LN-LM
<コード抜粋。重要な行にはインラインコメント（① ② ③）を付与>
```

注目ポイント:

- ① <コメントの解説>
- ② <コメントの解説>
```

コードフローの構成方針:

| 原則 | 説明 |
|------|------|
| ライフサイクル順 | 起動 → リクエスト → レスポンス → クリーンアップなど、時系列で追う |
| ファイル横断 | 1つのステップが複数ファイルにまたがる場合もあり。ファイル単位ではなく処理単位 |
| 図 → コードの順 | 各ステップで**先に Mermaid 図で構造を示し、次にコード**を示す。コード片だけではコードリーディングと変わらない |
| コード抜粋 + 解説 | 各ステップにコード抜粋と注目ポイントを含める |
| 伏線回収 | 「ここで登録したフックは、ステップ N で発動する」のように前後を繋ぐ |

各ステップの図の選択基準:

| ステップの性質 | 推奨する図 |
|--------------|-----------|
| コンポーネント間のやり取り | sequenceDiagram |
| 構築・変換の流れ | flowchart（ビルダーチェーン、パイプライン） |
| 型の変換・委譲 | flowchart（Deref 連鎖、型変換） |
| 分岐・条件付き処理 | flowchart（条件分岐） |

#### 4.4 テスト

テストがコードフローのどのステップを検証しているかを可視化する。

```markdown
## テスト

各テストがライフサイクルのどのステップを検証しているかを示す。

<Mermaid flowchart: ライフサイクルのステップとテストの対応関係>

| テスト | 検証対象のステップ | 検証内容 |
|-------|------------------|---------|
| `test_name` | N | <何を検証しているか> |

### 実行方法

```bash
<テスト実行コマンド>
```
```

テストが少数（1-2 件）の場合はマッピング図を省略してよい。

#### 4.5 マイグレーション（該当する場合）

```markdown
## マイグレーション

### <マイグレーション名>

ファイル: `path/to/migration.sql`

```sql
<SQL>
```

<ER 図>
```

#### 4.6 依存関係（該当する場合、diff モードのみ）

```markdown
## 依存関係

| クレート/パッケージ | バージョン | 追加理由 |
|-------------------|-----------|---------|
| `crate-name` | `1.0.0` | <理由> |
```

#### 4.7 設計解説

コード実装レベルの判断を記載する。機能・仕組みレベルの判断は機能解説の設計判断に記載する。

各判断はコード例を含め、「なぜこの書き方か」を解説する。

```markdown
## 設計解説

コード実装レベルの判断を記載する。機能・仕組みレベルの判断は[機能解説](./<NN>_機能解説.md#設計判断)を参照。

### N. <トピック>

場所: `path/to/file.rs:line`

```rust
<コード例>
```

なぜこの実装か:
<理由>

代替案:

| 案 | メリット | デメリット | 判断 |
|----|---------|-----------|------|
| ... | ... | ... | 採用/見送り |
```

#### 4.8 関連ドキュメント

```markdown
## 関連ドキュメント

- [機能解説](./<NN>_機能解説.md)
- [設計書](...)
```

---

### Step 5: 確認と仕上げ

1. 生成した2つのドキュメントをユーザーに提示する
2. 図表の正確性、リンクの整合性を確認する
3. コミットするかユーザーに確認する
4. コミットメッセージの例: `Add explanation docs for <機能名>`

## セクションの取捨選択

全セクションを機械的に生成しない。対象の性質に応じて取捨選択する。

| セクション | 含める条件 |
|-----------|-----------|
| 背景 | 常に含める。最低限「なぜこの機能/変更が存在するか」を記述 |
| 用語・概念 | 新しい概念がある場合、または既存概念の理解が前提となる場合 |
| ビフォー・アフター | diff モードで既存の振る舞いが変更された場合 |
| 状態遷移 | エンティティの状態遷移がある場合 |
| データ変換 | レイヤー間で型変換がある場合 |
| エラーハンドリング | エラーケースがある場合 |
| マイグレーション | DB スキーマがある場合 |
| 依存関係 | diff モードで新しいクレート/パッケージが追加された場合 |

## ドキュメント規約

- 図表: Mermaid 記法（[docs.md](../../../.claude/rules/docs.md)）
- ノードラベル: `ID["ラベル"]`（flowchart）、`participant ID as ラベル`（sequenceDiagram）
- ファイルリンク: 相対パス
- コード参照: `ファイルパス:行番号` 形式
- サニタイズ: [docs.md のドキュメント生成時の自己チェック](../../../.claude/rules/docs.md#ドキュメント生成時の自己チェック)
