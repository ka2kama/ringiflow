---
name: explain
description: 機能やPRの解説ドキュメントを生成する。機能ベースとソースコードベースの2つの視点で、図表を多用した理解促進ドキュメントを作成する。
argument-hint: <PR番号, ブランチ名, または機能領域名（例: 認証フロー, Page/Workflow/Detail.elm）>
user-invocable: true
---

# 解説ドキュメント生成

対象を分析し、2つの視点（機能・コード）で解説ドキュメントを生成する。

## 引数

$ARGUMENTS

## モード判定

引数が省略された場合は、何を解説するかユーザーに質問する。

引数がある場合は、種類でモードを自動判定する。

| 引数 | モード | 分析対象 |
|------|--------|---------|
| PR 番号（例: `123`） | diff | PR の差分 |
| ブランチ名（例: `feature/34-user-auth`） | diff | ブランチの差分 |
| 機能領域名（例: `認証フロー`） | feature | 既存コード |
| ファイルパス（例: `Page/Workflow/Detail.elm`） | feature | 指定ファイル周辺のコード |
| 省略 | — | ユーザーに質問する |

## 出力

2つのドキュメントを対で生成する。

| ドキュメント | 視点 | diff モード | feature モード |
|-------------|------|-----------|---------------|
| 機能解説 | What / Why | 何が変わったのか？なぜ？ | この機能はどう動くのか？なぜこう設計されたか？ |
| コード解説 | How / Where | どのコードがどう変わったのか？ | どのコードがどう構成されているか？ |

配置先: `docs/07_実装解説/` の該当機能ディレクトリ

## 手順

### Step 1: 対象の情報を収集

#### diff モード

```bash
# PR 番号指定の場合
gh pr view <PR番号> --json title,body,baseRefName,headRefName,files
gh pr diff <PR番号>

# 現在のブランチの場合
git log --oneline --reverse HEAD --not main
git diff --stat main...HEAD
git diff main...HEAD
```

| 情報 | コマンド | 用途 |
|------|---------|------|
| コミット履歴 | `git log --oneline --reverse HEAD --not main` | 変更の時系列 |
| 変更ファイル統計 | `git diff --stat main...HEAD` | 影響範囲の把握 |
| 差分全体 | `git diff main...HEAD` | 詳細分析 |
| 関連 Issue | PR 本文から抽出 | コンテキスト |
| 設計書 | Issue や PR から特定 | Before の把握 |

#### feature モード

1. 指定された機能領域に関連するファイルを特定する（Glob / Grep）
2. 関連する設計書、要件定義書を確認する
3. 主要なファイルを Read で読み込む
4. アーキテクチャ上の位置づけを把握する

### Step 2: 出力先を決定

1. `docs/07_実装解説/` の既存ディレクトリを確認する
2. 該当する機能ディレクトリがあればそこに配置、なければ新規作成する

ファイル命名:

```
docs/07_実装解説/NN_<機能名>/
├── ...（既存ファイル）
├── NN_機能解説.md
└── NN_コード解説.md
```

- `NN` はディレクトリ内の次の連番

出力先をユーザーに提示し、確認を得てから Step 3 に進む。

### Step 3: 機能解説ドキュメントを生成

各セクションには Mermaid 図またはテーブルを含める。

---

#### 3.1 概要

```markdown
# <機能名> - 機能解説

<!-- diff モード -->
対応 PR: #<PR番号>
対応 Issue: #<Issue番号>

<!-- feature モード -->
対象: <機能領域の説明>

## 概要

<1-2段落で記述>
```

#### 3.2 用語・概念

```markdown
## 用語・概念

| 用語 | 説明 | 関連コード |
|------|------|-----------|
| <用語> | <説明> | `<型名 or モジュール>` |
```

含める対象:
- ドメイン固有の概念
- 技術的な概念
- 理解に必要な前提知識

#### 3.3 フロー

モードによって構成が異なる。

**diff モード — ビフォー・アフター:**

変更前後のフローを対比する。

```markdown
## ビフォー・アフター

### Before（変更前）

<変更前の状態・フロー・制約を記述>
<Mermaid 図>

#### 制約・課題

- <変更が必要だった理由>

### After（変更後）

<変更後の状態・フロー・改善点を記述>
<Mermaid 図: Before と同じ種類で対比>

#### 改善点

- <改善された点>
```

新規機能（Before がない場合）は「背景・動機」セクションに置換する。

**feature モード — 現在のフロー:**

```markdown
## フロー

<現在の状態・フローを記述>
<Mermaid 図>
```

図の種類の選択基準:

| 対象の性質 | 推奨する図 |
|----------|-----------|
| API | sequenceDiagram（リクエストフロー） |
| 状態管理 | stateDiagram-v2（状態遷移） |
| アーキテクチャ | flowchart（コンポーネント構成） |
| UI | flowchart（画面遷移）+ テーブル（UI 要素） |
| データモデル | erDiagram（ER 図）または classDiagram |

#### 3.4 アーキテクチャ

関連するレイヤーとコンポーネントの全体像を示す。

```markdown
## アーキテクチャ

<Mermaid flowchart: レイヤー構成とデータの流れ>
```

subgraph でレイヤーを分離する。diff モードでは変更したコンポーネントを明示する。

#### 3.5 データフロー

主要な操作のデータフローをシーケンス図で記述する。

```markdown
## データフロー

### フロー N: <操作名>

<Mermaid sequenceDiagram>

#### 処理ステップ

| # | レイヤー | ファイル:関数 | 処理内容 |
|---|---------|-------------|---------|
| 1 | ... | ... | ... |
```

#### 3.6 状態遷移（該当する場合）

```markdown
## 状態遷移

### <エンティティ名>

<Mermaid stateDiagram-v2>
```

#### 3.7 データ変換の流れ（該当する場合）

```markdown
## データ変換

### リクエストの変換

<型変換の流れ>

### レスポンスの変換

<型変換の流れ>
```

#### 3.8 エラーハンドリング（該当する場合）

```markdown
## エラーハンドリング

| エラー | 発生箇所 | HTTP Status | ユーザーへの表示 |
|-------|---------|-------------|---------------|
| ... | ... | ... | ... |
```

#### 3.9 設計判断

```markdown
## 設計判断

### N. <判断内容>

- 選択: <採用した方式>
- 代替案: <検討した他の方式>
- 理由: <選択の理由>
```

#### 3.10 関連ドキュメント

```markdown
## 関連ドキュメント

- [コード解説](./<NN>_コード解説.md)
- [設計書](...)
```

---

### Step 4: コード解説ドキュメントを生成

---

#### 4.1 サマリー

モードによってヘッダーが異なる。

**diff モード:**

```markdown
# <機能名> - コード解説

対応 PR: #<PR番号>
対応 Issue: #<Issue番号>

## 変更サマリー

| カテゴリ | ファイル数 | 主な変更 |
|---------|----------|---------|
| ドメイン層 | N | <概要> |
| ... | ... | ... |
```

**feature モード:**

```markdown
# <機能名> - コード解説

対象: <機能領域の説明>

## 構成サマリー

| カテゴリ | ファイル数 | 責務 |
|---------|----------|------|
| ドメイン層 | N | <概要> |
| ... | ... | ... |
```

#### 4.2 ファイル一覧

**diff モード:**

```markdown
## 変更ファイル一覧

### <レイヤー名>

| ファイル | 変更種別 | 変更行数 | 概要 |
|---------|---------|---------|------|
| [`path/to/file.rs`](relative-link) | 追加/変更/削除 | +N/-M | <概要> |
```

**feature モード:**

```markdown
## ファイル一覧

### <レイヤー名>

| ファイル | 責務 |
|---------|------|
| [`path/to/file.rs`](relative-link) | <説明> |
```

レイヤー順序: ドメイン → インフラ → Core Service → BFF → フロントエンド → マイグレーション → テスト → 設定

#### 4.3 主要な型・関数

**diff モード:**

```markdown
## 主要な型・関数

### 新規追加

| 型/関数 | ファイル | 責務 |
|--------|---------|------|
| `TypeName` | `path:line` | <説明> |

### 変更

| 型/関数 | ファイル | 変更内容 |
|--------|---------|---------|
| `TypeName` | `path:line` | <Before → After> |
```

**feature モード:**

```markdown
## 主要な型・関数

| 型/関数 | ファイル | 責務 |
|--------|---------|------|
| `TypeName` | `path:line` | <説明> |
```

#### 4.4 レイヤー別コードウォークスルー

両モード共通。各レイヤーのコードをコード例付きで解説する。

```markdown
## レイヤー別コードウォークスルー

### <レイヤー名>

#### <コンポーネント名>

ファイル: [`path/to/file.rs`](relative-link)

<説明>

```rust
// path/to/file.rs:L10-L25
<コード抜粋>
```

<コードの解説: なぜこう書いたか、注目ポイント>
```

注目ポイントの選択基準:
- 新しいパターンの導入
- 非自明なロジック
- 設計判断が反映された箇所
- 他のレイヤーとの接続点

#### 4.5 テスト

```markdown
## テスト

### テストケース一覧

| テスト | ファイル | 検証内容 |
|-------|---------|---------|
| `test_name` | `path:line` | <何を検証しているか> |

### 実行方法

```bash
<テスト実行コマンド>
```
```

#### 4.6 マイグレーション（該当する場合）

```markdown
## マイグレーション

### <マイグレーション名>

ファイル: `path/to/migration.sql`

```sql
<SQL>
```

<ER 図>
```

#### 4.7 依存関係（該当する場合、diff モードのみ）

```markdown
## 依存関係

| クレート/パッケージ | バージョン | 追加理由 |
|-------------------|-----------|---------|
| `crate-name` | `1.0.0` | <理由> |
```

#### 4.8 設計解説

```markdown
## 設計解説

### N. <トピック>

場所: `path/to/file.rs:line`

```rust
<コード例>
```

なぜこの設計か:
<理由>

代替案:
<検討した他の選択肢とトレードオフ>
```

#### 4.9 関連ドキュメント

```markdown
## 関連ドキュメント

- [機能解説](./<NN>_機能解説.md)
- [設計書](...)
```

---

### Step 5: 確認と仕上げ

1. 生成した2つのドキュメントをユーザーに提示する
2. 図表の正確性、リンクの整合性を確認する
3. コミットするかユーザーに確認する
4. コミットメッセージの例: `Add explanation docs for <機能名>`

## セクションの取捨選択

全セクションを機械的に生成しない。対象の性質に応じて取捨選択する。

| セクション | 含める条件 |
|-----------|-----------|
| 用語・概念 | 新しい概念がある場合、または既存概念の理解が前提となる場合 |
| ビフォー・アフター | diff モードで既存の振る舞いが変更された場合 |
| 状態遷移 | エンティティの状態遷移がある場合 |
| データ変換 | レイヤー間で型変換がある場合 |
| エラーハンドリング | エラーケースがある場合 |
| マイグレーション | DB スキーマがある場合 |
| 依存関係 | diff モードで新しいクレート/パッケージが追加された場合 |

## ドキュメント規約

- 図表: Mermaid 記法（[docs.md](../../../.claude/rules/docs.md)）
- ノードラベル: `ID["ラベル"]`（flowchart）、`participant ID as ラベル`（sequenceDiagram）
- ファイルリンク: 相対パス
- コード参照: `ファイルパス:行番号` 形式
- サニタイズ: [docs.md のドキュメント生成時の自己チェック](../../../.claude/rules/docs.md#ドキュメント生成時の自己チェック)
