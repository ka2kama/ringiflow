# 実装前の確認（Pre-Implementation Verification）

## 原則

- コードを書く前に、型・API・パターンを確認する
- 「推測 → コンパイル → エラー修正」のサイクルは許容しない
- コンパイラに頼る前に、自分で型の整合性を確認する

## 確認の3カテゴリ

リスクの高い順。

### カテゴリ1: ライブラリ API（最重要）

Read ツールでソースを確認できないため、最もリスクが高い。

検証手順:

1. Grep で既存の使用パターンを探す — プロジェクト内で同じ関数・メソッドが既に使われていないか検索する。使われていれば、そのパターンに従う（最も信頼性が高い）
2. 初めて使う API の場合、公式ドキュメントを確認する — Rust: docs.rs、Elm: package.elm-lang.org で関数シグネチャ・引数の型・戻り値の型を正確に把握する
3. 確認手段がない場合は、推測に基づく旨をコメントに残す

### カテゴリ2: プロジェクト内の型と構造

Read ツールで直接確認する。

- 構造体のフィールド名と型
- enum のバリアント
- トレイトのメソッドシグネチャ
- エラー型の定義とバリアント
- インポートパス（既存コードのパターンに従う）

### カテゴリ3: 既存パターン

類似の実装を先に読んでからパターンを踏襲する。

- 同じレイヤーの他のモジュール（ハンドラなら他のハンドラ）
- テストユーティリティ、テストのパターン
- エラーハンドリングのパターン

## リファクタリング操作の確認

ファイル分割やモジュール再構成を計画に含む場合、上記の3カテゴリに加えて以下を確認する。

### ファイル分割

分割対象ファイル内の重複パターンを事前に洗い出す。

確認手順:

1. 分割対象ファイル内の類似処理（同じ構造の関数群、パターンが繰り返されるコード）を特定する
2. 重複パターンがある場合: 共通化を先に（または同時に）実施してからファイル分割を行う
3. 計画ファイルの確認事項に「分割対象ファイルの重複パターン」をチェック項目として記載する

改善の経緯: [ファイル分割がクローン数を増加させた](../../process/improvements/2026-02/2026-02-17_1731_ファイル分割がクローン数を増加させた.md)

## 構造的な強制: 計画ファイルの確認事項

計画ファイルの各 Phase に「確認事項」セクションを設け、成果物要件とする。

→ 計画ファイルの必須要素: [zoom-rhythm.md > 計画ファイルへの記載](zoom-rhythm.md#計画ファイルへの記載必須)
→ 実施タイミング: [TDD 開発フロー > 確認事項の実施](../../docs/04_手順書/04_開発フロー/02_TDD開発フロー.md#確認事項の実施)

確認事項は **ゲート条件**（前提条件）として宣言する。Phase の実装を開始する前に、確認事項を Read/Grep で実施しなければならない。確認事項が不要な Phase は「確認事項: なし（既知のパターンのみ）」と明示する。

計画ファイルは確認すべき内容の仕様であり、実施状態の追跡は行わない。確認の証跡は Read/Grep ツールの実行そのもので担保する。確認の結果、設計判断の変更が生じた場合のみセッションログの判断ログにも記録する。

→ 設計判断の経緯: [#747](https://github.com/ka2kama/ringiflow/issues/747) — チェックボックスの「計画時に書く→実装時に更新する」という2タイムポイント方式は、AI エージェントにとって不自然なコンテキストスイッチを強いるため、66.9% の確認事項が未チェックだった。ゲート条件方式はこの問題を構造的に解消する。

既知手法との関連: Design by Contract（Bertrand Meyer, 1986）の前提条件の考え方。「確認してからでないと次に進めない」をルールとして宣言し、追跡メカニズムは持たない。

## AI エージェントへの指示

- 計画作成時: 各 Phase で使用する型・パターン・ライブラリ API、およびリファクタリング操作の影響を確認事項として記載する
- Phase 開始時: 確認事項を Read/Grep で実施してから実装に入る
- ライブラリ API を初めて使う場合: 必ず Grep で既存使用を探し、なければ公式ドキュメントで確認する
- 確認の結果、設計判断の変更が生じた場合: セッションログの判断ログにも記録する
- 確認手段がない場合: 推測で書いた旨を明示する

## 禁止事項

- 確認事項セクションのない計画で実装を開始すること
- 確認事項を実施せずに Phase の実装を開始すること
- ライブラリ API を既存使用パターンの確認なしに推測で書くこと
- 「コンパイルして確認すればいい」と考えること
