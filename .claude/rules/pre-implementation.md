# 実装前の確認（Pre-Implementation Verification）

## 原則

コンパイラはガードレールであり、頼るものではない。

「推測 → コンパイル → エラー修正」のサイクルは、最終的に正しいコードを生み出すとしても許容しない。
理解してから書く規律には固有の価値がある。推測で書いて通ったコードは、なぜ動くのか説明できない。

- 「書いて試す」ではなく「読んで理解してから書く」
- 型システムは「エラー検出」ではなく「設計を導くもの」
- コンパイラに頼る前に、自分で型の整合性を確認する

## 確認の3カテゴリ

リスクの高い順。

### カテゴリ1: ライブラリ API（最重要）

AI の最大の失敗モード。プロジェクトコードと違い Read ツールでソースを確認できないため、訓練データに基づく推測が唯一の情報源になりやすい。訓練データは古い・不正確なことがある。

検証手順:

1. **Grep で既存の使用パターンを探す** — プロジェクト内で同じ関数・メソッドが既に使われていないか検索する。使われていれば、そのパターンに従う（最も信頼性が高い）
2. **初めて使う API の場合、公式ドキュメントを確認する** — Rust: docs.rs でクレートの該当バージョンを確認。Elm: package.elm-lang.org で該当パッケージを確認。関数シグネチャ、引数の型、戻り値の型を正確に把握する
3. **訓練データだけに頼らない** — 確認手段がない場合は、推測に基づく旨をコメントに残す

### カテゴリ2: プロジェクト内の型と構造

プロジェクトコードは Read ツールで直接確認できるため、検証コストが低い。

- 構造体のフィールド名と型
- enum のバリアント
- トレイトのメソッドシグネチャ
- エラー型の定義とバリアント
- インポートパス（既存コードのパターンに従う）

### カテゴリ3: 既存パターン

コンパイラでは一貫性を検出できない。類似の実装を先に読んでからパターンを踏襲する。

- 同じレイヤーの他のモジュール（ハンドラなら他のハンドラ）
- テストユーティリティ、テストのパターン
- エラーハンドリングのパターン

## 構造的な強制: 計画ファイルの確認事項

原則だけでは機能しない。計画ファイルに確認事項セクションを設け、成果物要件とする。

→ 計画ファイルの必須要素: [zoom-rhythm.md > 計画ファイルへの記載](zoom-rhythm.md#計画ファイルへの記載必須)
→ 実施タイミング: [TDD 開発フロー > 確認事項の実施](../../docs/04_手順書/04_開発フロー/02_TDD開発フロー.md#確認事項の実施)

各 Phase に「確認事項」を記載する:

```
### Phase N: コンポーネント名

#### 確認事項
- 型: UserState の定義 → `handler/auth.rs`
- パターン: 既存ハンドラの引数パターン → `handler/workflow.rs`
- ライブラリ: axum State 抽出子 → Grep `State(` in handlers

#### テストリスト
- [ ] ...
```

確認事項が不要な Phase（既知のパターンのみ）は「確認事項: なし（既知のパターンのみ）」と明示する。

## AI エージェントへの指示

- 計画作成時: 各 Phase で使用する型・パターン・ライブラリ API を確認事項として記載する
- Phase 開始時: 確認事項を Read/Grep で実施してからテストを書き始める
- ライブラリ API を初めて使う場合: 必ず Grep で既存使用を探し、なければ公式ドキュメントで確認する
- 確認手段がない場合: 推測で書いた旨を明示する

## 禁止事項

- 確認事項セクションのない計画で実装を開始すること
- ライブラリ API を既存使用パターンの確認なしに推測で書くこと
- 「コンパイルして確認すればいい」と考えること

## 改善の経緯

- [ルール実効性分析と設計原則レンズ導入](../../prompts/runs/2026-02/2026-02-08_2355_ルール実効性分析と設計原則レンズ導入.md)
- [往復のリズムが機能しない構造的原因](../../prompts/improvements/2026-02/2026-02-08_2355_往復のリズムが機能しない構造的原因.md)
