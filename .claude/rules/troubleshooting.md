# 技術的トラブルシューティングの基本原則

CI エラー、ビルドエラー、実行時エラー等の技術的問題を調査する際の原則。

## 核心原則: データが先、仮説が後、修正は最後

```
観察 → 仮説 → 検証 → （検証結果に基づき）修正
                ↑              ↓
                └── 棄却 ←─── 不一致
```

修正は**検証済みの仮説**に対してのみ行う。検証をスキップして修正に入ってはならない。

## 原則

### 1. エラーメッセージは仮説であり、真実ではない

エラーメッセージは以下の可能性がある:

- 古い情報（キャッシュ、タイムラグ）
- 誤った情報（バグ、不正確な判定）
- 文脈依存（特定条件下でのみ真）

エラーメッセージを「仮説」として扱い、ソースデータで検証する。

### 2. 推測（「〜のはずだ」）は検証が必要なサイン

「〜のはずだ」と思ったら、それを確認するコマンド・API を実行する。確認手段が存在するなら、必ず使用する。

### 3. 実際の状態をソースデータで確認する

エラーメッセージが指摘する対象の実際の値・設定を取得する。推測ではなく、コマンド・API で取得した事実を根拠にする。

## 調査フロー

### ステップ 1: 再現する（Reproduce）

問題を確実に再現する。再現条件を特定する。

- 再現手順を明確にする
- 再現できない場合、条件を変えて試行する
- 再現性が不安定な場合、それ自体が手がかり（タイミング、リソース競合等）

### ステップ 2: 観察する（Observe）

症状を正確に記録する。この段階では解釈を加えない。

- エラーメッセージの全文
- 発生状況（どの操作の後、どのタイミングで）
- 関連するログ、ネットワークレスポンス、状態

### ステップ 3: 仮説を立てる（Hypothesize）

観察結果から考えられる原因を列挙する。

- 仮説は複数立てる（1つに絞らない）
- 各仮説に対して「この仮説が正しければ、何が観察されるはずか」を予測する
- 仮説の検証優先順位: 検証コストが低いものから（二分探索の原則）

### ステップ 4: 検証する（Verify） ← ゲート

仮説を**データで**検証する。このステップを飛ばして修正に入ってはならない。

検証の方法:

| 状況 | 検証手段 |
|------|---------|
| API レスポンスが疑わしい | 実際のステータスコードとボディを取得 |
| データの状態が疑わしい | DB クエリ、Redis 確認で実際の値を取得 |
| コードのパスが疑わしい | ログ追加、デバッガ、テスト用の条件分岐で確認 |
| タイミングが疑わしい | 遅延追加、ログのタイムスタンプで確認 |
| E2E テストの UI 状態が疑わしい | `page.route` でインターセプト、スクリーンショット、`page.content()` で確認 |

検証結果は以下のいずれか:

- **支持**: 予測と観察が一致 → ステップ 5 へ
- **棄却**: 予測と観察が不一致 → ステップ 3 に戻り別の仮説を検証
- **不明確**: さらなるデータが必要 → 追加観察を行いステップ 4 を継続

### ステップ 5: 切り分ける（Isolate）

問題のレイヤー・コンポーネントを特定する。

切り分けの手法:

| 手法 | 適用場面 |
|------|---------|
| レイヤー切り分け | フロントエンド / BFF / Core Service / DB のどの層か |
| 二分探索 | 多段処理のどのステップで問題が発生するか |
| `git bisect` | どのコミットで問題が混入したか |
| 最小再現 | 問題を再現する最小のコードや手順は何か |

### ステップ 6: 根本原因を特定する（Identify）

切り分けた範囲内で根本原因を特定する。

### ステップ 7: 修正する（Fix）

特定された根本原因に対してのみ修正を行う。

### ステップ 8: 検証する（Verify fix）

修正が問題を解決し、副作用がないことを確認する。

## 仮説追跡（成果物要件）

トラブルシューティングが 2 回以上の試行に及ぶ場合、仮説の追跡を行う。

### 会話内での追跡

調査中は会話内にインラインで仮説追跡表を記録する。

```
## 仮説追跡

| # | 仮説 | 予測（正しければ何が観察されるか） | 検証手段 | 結果 |
|---|------|--------------------------------|---------|------|
| 1 | API が 404 を返している | レスポンスステータスが 404 | page.route でインターセプト | ？ |
| 2 | デコーダが失敗している | API は 200 だが Elm が Failure | コンソールログ確認 | ？ |
| 3 | タイミング問題 | API 未完了で操作が先行 | ログのタイムスタンプ | ？ |
```

仮説追跡表がないまま 2 回目の修正試行に入ることは散弾銃デバッグの兆候。

### 調査記録への永続化

問題解決後、仮説追跡の結果を調査記録として永続化する。

→ テンプレートと規約: [`process/investigations/README.md`](../../process/investigations/README.md)

## 散弾銃デバッグの検出と防止

### 散弾銃デバッグとは

根本原因を特定せずに、推測に基づく修正を繰り返すアンチパターン。系統的手法より解決時間が約 50% 長いとされる。

### 検出基準

以下のいずれかに該当する場合、散弾銃デバッグに陥っている:

| 兆候 | 説明 |
|------|------|
| 修正の根拠が「〜かもしれない」 | 仮説を検証せず修正に入っている |
| 2 回目の修正で仮説追跡表がない | 問題空間を構造的に管理できていない |
| 修正後に「なぜ効いたか」説明できない | 根本原因を理解していない |
| 同じ症状に対して異なる修正を試している | Isolate（切り分け）をスキップしている |

### 検出時の対応

散弾銃デバッグを検出したら、修正を止めて以下を実行する:

1. 現在の理解を整理する（分かっていること / 分かっていないこと）
2. 仮説追跡表を作成する
3. 最もコストの低い検証手段で仮説を1つずつ検証する
4. 検証結果に基づいてのみ修正に入る

## 根本原因分析の観点

調査フローのステップ 6（根本原因を特定する）で、局所的な状態確認に加えて以下の間接的な影響を分析する。

| 観点 | 確認内容 |
|------|---------|
| 直接的依存 | コードの依存関係、インポート、関数呼び出し |
| 間接的影響 | リソース競合（DB 接続、メモリ、CPU）、並列実行負荷、タイミング、システム全体への波及 |
| 環境差異 | CI と開発環境の違い（並列度、リソース制限、設定） |
| 変更の波及 | ブランチ間の差分が何に影響するか（コードの直接変更以外も含む） |

改善の経緯: [間接的な因果関係の見落とし](../../process/improvements/2026-02/2026-02-15_1237_間接的な因果関係の見落とし.md)

## よくあるパターンと確認手段

| 問題 | エラーメッセージの例 | 確認手段 |
|------|---------------------|---------|
| GitHub Actions 許可設定 | "action is not allowed" | `gh api /repos/{owner}/{repo}/actions/permissions/selected-actions` |
| 環境変数の不足 | "environment variable not set" | `env`, `printenv`, コンテナ内で直接確認 |
| ファイルの不存在 | "file not found" | `ls`, Read ツール |
| 依存関係の不足 | "package not found" | `cargo tree`, `pnpm list` |
| ポートの競合 | "address already in use" | `lsof -i :PORT`, `ss -tlnp` |
| 権限の不足 | "permission denied" | `ls -la`, `stat` |
| API レスポンス異常 | UI にデータが表示されない | `curl` / `page.route` でレスポンスを直接確認 |
| 非同期処理のタイミング | 操作が不安定・たまに失敗 | ログのタイムスタンプ、`waitForResponse` + ステータス確認 |

## 禁止事項

- エラーメッセージのみを根拠に原因を断定すること
- 確認手段が存在するのに使用せず推測で判断すること
- 「〜のはずだ」を検証せずに対策を提案すること
- 仮説を検証せずに修正を試みること（散弾銃デバッグ）
- 仮説追跡表なしに 2 回目の修正試行に入ること

## 既知手法との関連

| 既知手法 | 本フレームワークとの対応 |
|---------|----------------------|
| 科学的方法（Scientific Method） | 調査フロー全体（観察→仮説→予測→検証→分析） |
| Reproduce → Isolate → Identify → Fix → Verify | ステップ 1〜8 |
| David Agans "Quit thinking and look" | 原則 3（ソースデータで確認） |
| 二分探索 / `git bisect` | ステップ 5（切り分け） |

改善の経緯: [散弾銃デバッグによるトラブルシューティング効率低下](../../process/improvements/2026-02/2026-02-20_0012_散弾銃デバッグによるトラブルシューティング効率低下.md)
