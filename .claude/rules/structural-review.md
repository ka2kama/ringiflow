---
paths:
  - "backend/**/*.rs"
  - "backend/**/Cargo.toml"
  - "frontend/src/**/*.elm"
---

# 構造レビュー指針

コードベースの構造劣化を防止するための指針。

背景: [Issue #151](https://github.com/ka2kama/ringiflow/issues/151)

## 新モジュール追加時のチェック

新しいモジュール（ファイル/ディレクトリ）を追加する際は、以下を確認する:

1. 既存モジュールとの責務重複がないか — 同じ関心事を扱うモジュールが既に存在しないか確認する
2. 適切なレイヤーに配置されているか — 依存関係の方向（`apps → domain → shared`, `apps → infra → shared`）に違反していないか
3. モジュール名が責務を正確に表現しているか

## ファイルサイズ閾値

1 ファイル 500 行を超えたら**責務分析**を行い、対応を判断する（テストファイルを除く）。

`just check-file-size` で閾値超過ファイルを確認できる。

### 判断プロセス

行数超過はトリガーであり、自動的に分割が必要とは限らない。責務分析に基づいて判断する:

```
500 行超過 → 超過の原因を分析 → 分割 or 例外として許容
```

| 超過の原因 | 対応 | 例 |
|-----------|------|-----|
| 複数の責務が混在 | 責務単位で分割 | ADR-039: 3 エンティティ混在 → エンティティ単位で分割 |
| ISP 違反（巨大インターフェース） | サブトレイト分割 | ADR-041: 20 メソッドトレイト → 3 サブトレイトに分割 |
| 本体は適正だがテストが大きい | 例外として許容 | `task.rs`: 実装 225 行 + テスト 817 行 |
| アーキテクチャパターンの帰結 | 例外として許容（要検討） | TEA パターンのページ、SPA エントリポイント |

### 許容する場合の記録

例外として許容する場合は、なぜ分割しないかをコードコメントまたは ADR に記録する。

## 未使用依存の検出

`just check-unused-deps` で Cargo.toml の未使用依存を検出できる。

新しい依存を追加したとき、または依存を使用するコードを削除したときに実行する。

## Phase 完了時の構造確認

Phase 完了時の品質チェックリスト（[Issue 駆動開発 > 品質チェックリスト](../../docs/04_手順書/04_開発フロー/01_Issue駆動開発.md#62-品質チェックリスト)）の一部として、以下を確認する:

- `just check-unused-deps` で未使用依存がないこと
- `just check-file-size` で新たに閾値を超えたファイルがないこと（既存の超過は許容）
