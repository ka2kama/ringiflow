---
paths:
  - "backend/**/*.rs"
  - "backend/**/Cargo.toml"
  - "frontend/src/**/*.elm"
---

# 構造レビュー指針

コードベースの構造劣化を防止するための指針。

背景: [Issue #151](https://github.com/ka2kama/ringiflow/issues/151)

## 新モジュール追加時のチェック

新しいモジュール（ファイル/ディレクトリ）を追加する際は、以下を確認する:

1. 既存モジュールとの責務重複がないか — 同じ関心事を扱うモジュールが既に存在しないか確認する
2. 適切なレイヤーに配置されているか — 依存関係の方向（`apps → domain → shared`, `apps → infra → shared`）に違反していないか
3. モジュール名が責務を正確に表現しているか

## ファイルサイズ閾値

1 ファイル 500 行を超えたら**責務分析**を行い、対応を判断する（テストファイルを除く）。

`just check-file-size` で閾値超過ファイルを確認できる。

### 判断プロセス

行数超過はトリガーであり、自動的に分割が必要とは限らない。責務分析に基づいて判断する:

```
500 行超過 → 超過の原因を分析 → 分割 or 例外として許容
```

| 超過の原因 | 対応 | 例 |
|-----------|------|-----|
| 複数の責務が混在 | 責務単位で分割 | ADR-039: 3 エンティティ混在 → エンティティ単位で分割 |
| ISP 違反（巨大インターフェース） | サブトレイト分割 | ADR-041: 20 メソッドトレイト → 3 サブトレイトに分割 |
| 本体は適正だがテストが大きい | 例外として許容 | `task.rs`: 実装 225 行 + テスト 817 行 |
| アーキテクチャパターンの帰結 | 例外として許容（要検討） | TEA パターンのページ、SPA エントリポイント |

### 許容する場合の記録

例外として許容する場合は、なぜ分割しないかをコードコメントまたは ADR に記録する。

## 関数の行数閾値

1 関数 50 行を超えたら**責務分析**を行い、対応を判断する（テスト関数を除く）。

`just check-fn-size` で閾値超過関数を確認できる。内部では clippy の [`too_many_lines`](https://rust-lang.github.io/rust-clippy/master/index.html#/too_many_lines) lint を使用し、閾値は `backend/clippy.toml` で設定している。

注: clippy は空行とコメント行を除外してカウントする。

### 判断プロセス

ファイルサイズ閾値と同様、行数超過はトリガーであり自動的に分割が必要とは限らない:

```
50 行超過 → 超過の原因を分析 → 分割 or 例外として許容
```

| 超過の原因 | 対応 | 例 |
|-----------|------|-----|
| 複数の責務が混在 | 関数の抽出・分割 | ビジネスロジック + バリデーション + 変換が混在 |
| パターンマッチの分岐が多い | 例外として許容（要検討） | 多段階の状態遷移ロジック |
| ルーター定義 | 例外として許容 | `main.rs` のルーティング設定 |
| BFF ハンドラのリクエスト変換 | 例外として許容（要検討） | Core Service へのプロキシでフィールドマッピングが多い場合 |

### `just check` との関係

`check-fn-size` は clippy を再実行するため `just check` には含めない。Phase 完了時の構造確認で手動実行する。

## 未使用依存の検出

`just check-unused-deps` で Cargo.toml の未使用依存を検出できる。

新しい依存を追加したとき、または依存を使用するコードを削除したときに実行する。

## コード重複の検出

`just check-duplicates` でコピー＆ペーストを検出できる。

新しいコードを追加したとき、または既存コードを拡張したときに実行する。

選定理由: [ADR-042](../../docs/05_ADR/042_コピペ検出ツールの選定.md)

### AI エージェントへの指示

TDD Refactor ステップで、以下を実施する:

1. 書いたコードの主要パターンのキーワードを Grep で既存コードと照合する
2. 類似パターンが見つかった場合、共通化を検討する
3. 共通化が現スコープ外であれば、セッションログに記録する

## Phase 完了時の構造確認

Phase 完了時の品質チェックリスト（[Issue 駆動開発 > 品質チェックリスト](dev-flow-issue.md#62-品質チェックリスト)）の一部として、以下を確認する:

- `just check-unused-deps` で未使用依存がないこと
- `just check-file-size` で新たに閾値を超えたファイルがないこと（既存の超過は許容）
- `just check-fn-size` で新たに閾値を超えた関数がないこと（既存の超過は許容）
- `just check-duplicates` で新たなコード重複がないこと（既存の重複は許容）

## アーキテクチャ構成変更時の必須対応

以下のいずれかに該当する変更を行った場合、基本設計書を確認・更新する。

該当する変更:
- サービス（アプリケーション）の追加・削除
- 共有クレートの追加・削除
- 外部連携先の追加・削除
- サービス間通信パターンの変更

確認・更新する設計書:

1. [`00_アーキテクチャ概要.md`](../../docs/02_基本設計書/00_アーキテクチャ概要.md) — 構成図、レイヤー表、通信表、セキュリティ境界図
2. [`01_アーキテクチャ設計.md`](../../docs/02_基本設計書/01_アーキテクチャ設計.md) — 詳細構成図、コンポーネント図、レイヤー表
3. [`02_プロジェクト構造設計.md`](../../docs/02_基本設計書/02_プロジェクト構造設計.md) — ディレクトリ構造、Cargo.toml、クレート構成図

**禁止:** アーキテクチャ構成を変更しながら基本設計書を更新しないこと
