# 俯瞰・実装リズム（Zoom In/Out Rhythm）

全体（俯瞰）と局所（実装）を往復する。

## 前提: 設計段階では設計を詰める

- 設計段階: 網羅性、完結性、整合性を確認してから実装に入る
- 実装段階: 設計を前提に実装しつつ、必要に応じて設計に戻る
- 設計段階で収束していない計画は、実装に入ってはならない

### 設計ブラッシュアップループ

To-Be と As-Is のギャップがゼロになるまでループする。

1. 計画の初版を書く
2. ギャップを体系的に洗い出す（[ギャップ発見の観点](#ギャップ発見の観点)を使用）
3. 各ギャップを調査・解決する（コード探索、API 検証、仕様確認）
4. 計画を更新する（設計判断を追加、コードスニペットを修正）
5. ループ記録に追記する
6. 2 に戻る（ギャップゼロになるまで）

#### ギャップ発見の観点

**欠陥の発見（マイナス → ゼロ）**:

| 観点 | 探すもの |
|------|---------|
| 未定義 | 参照されているが定義されていないもの |
| 曖昧 | 複数の解釈が可能な記述 |
| 競合・エッジケース | 組み合わせの挙動が未定義のもの |
| 不完全なパス | 状態遷移やエラーパスに漏れがあるもの |
| アーキテクチャ不整合 | レイヤー境界や責務分担の矛盾 |
| 既存手段の見落とし | 標準ライブラリや既存パターンに代替があるもの |
| デザイントークン乖離 | [デザインガイドライン](../../docs/03_詳細設計書/13_デザインガイドライン.md)に沿っていない実装 |
| アクセシビリティ欠陥 | WCAG 2.1 AA 違反（セマンティック HTML、ARIA、キーボード操作、コントラスト比） |
| 状態網羅漏れ | RemoteData の全バリアント（NotAsked/Loading/Failure/Success）と空データの一部が、view または Cmd（特に DOM 依存の Ports）で未処理のもの |
| 状態依存フィールド | 特定の状態でのみ有効なフィールドがフラットな型に混在しているもの。ADT ベース状態マシンで分離すべき（[ADR-054](../../docs/05_ADR/054_ADTベース状態マシンパターンの標準化.md)） |
| テスト層網羅漏れ | テストリストで全テスト層（ユニット/ハンドラ/API/E2E）が明示されていないもの |
| 操作パス網羅漏れ | 完了基準に対応する操作パス（正常系・準正常系・異常系）がテストリストに反映されていないもの |
| テスト責任の断絶 | Epic の完了基準に紐づく操作パス（正常系・準正常系・異常系）が、テストピラミッドのいずれかの層で、いずれの Story のテスト責任にも割り当てられていないもの |

**品質の向上（ゼロ → プラス）**:

| 観点 | 問い |
|------|------|
| シンプルさ | 同じ結果をより少ない概念で実現できないか |
| 型の活用 | 不正な状態を型レベルで防げないか |
| 責務の明確さ | 各コンポーネントの責務は単一か |
| ベストプラクティス | その分野の推奨パターンに沿っているか |
| ユーザーフィードバック | 操作に対する視覚的フィードバック（loading、success/error 表示）が適切か |
| 視覚的階層 | 情報の優先度がタイポグラフィ・色・スペーシングで表現されているか |
| ビジュアルバランス | 要素のコントラスト・整列・余白が[デザインガイドライン](../../docs/03_詳細設計書/13_デザインガイドライン.md)の原則に沿っているか |

対象の性質に応じて観点を追加する。

#### 完了基準

1. 上記の観点で体系的に探索してギャップがゼロ
2. 各設計判断に選択肢・理由・トレードオフが記載されている
3. 具体的なコードスニペット（関数シグネチャ、型定義）で挙動が一意に確定する

ループ完了後に[収束確認チェックリスト（設計・計画フェーズ）](#設計計画フェーズ)で成果物の品質を検証する。

#### ループ記録（計画ファイルの必須要素）

「観点」列は[ギャップ発見の観点](#ギャップ発見の観点)に対応する。

```markdown
### ブラッシュアップループの記録

| ループ | 検出したギャップ | 観点 | 対応 |
|-------|----------------|------|------|
| 1回目 | [何を検出したか] | [観点] | [計画をどう変更したか] |
```

## 往復のリズム

### 実装中の俯瞰: 設計原則レンズ

TDD Refactor ステップで設計原則レンズを適用する。
→ 具体的な問いとトリガー: [TDD 開発フロー > Refactor](../../docs/04_手順書/04_開発フロー/02_TDD開発フロー.md#-refactor-設計を改善する)

| タイミング | レンズ |
|-----------|--------|
| 毎 Refactor | Simple Design（意図・重複・最小性） |
| モジュール/関数の完成時 | SRP・DIP・型の活用 |
| Phase 完了時 | 全レンズ + [品質チェックリスト](../../docs/04_手順書/04_開発フロー/01_Issue駆動開発.md#62-品質チェックリスト) |

発見があった場合のみ、セッションログの判断ログに記録する。

### その他の作業での俯瞰

| タイミング | 俯瞰の内容 |
|-----------|-----------|
| 一つの変更を完了したとき | この変更は全体と調和しているか？ |
| 予期しない発見時 | 局所的対処でいいか？全体に組み込むべきか？ |
| 区切りのとき | ここまでの成果は全体と調和しているか？ |

## 理想駆動による収束

1. To-Be を先に定義する
2. As-Is を To-Be に近づける
3. 俯瞰してギャップを確認する
4. ギャップがゼロになるまで 2-3 を繰り返す

### To-Be の確定と更新

確定タイミング: 設計・計画は探索完了後、実装はテストを書く前、テストはテストリスト作成時、横断検証は全 Phase 完了後。

更新条件: より良い理想状態の発見、外部からの要件変更、技術的制約の発見、探索での新知見。更新する場合は変更理由を明示してから新しい To-Be で往復を再開する。

**禁止:**

- 往復の中で暗黙で To-Be を変更すること
- 「実装が難しいから」という理由で理想を下げること
- 変更理由を記録せずに To-Be を変えること

## 収束確認のチェックリスト

### 設計・計画フェーズ

| # | 観点 | 理想状態（To-Be） | 確認内容 |
|---|------|------------------|---------|
| 1 | 網羅性 | 探索で発見された全対象が計画に含まれている | 対象リストと探索結果を突合し、差分がゼロ。除外はすべて理由付きで記載 |
| 2 | 曖昧さ排除 | 不確定な記述がゼロ | 「あれば」「必要に応じて」等を検索し、該当ゼロを確認 |
| 3 | 設計判断の完結性 | 全ての差異・バリエーションに判断が記載されている | 探索で見つかった差異と計画の判断を突合し、未決定ゼロ |
| 4 | スコープ境界 | 対象と対象外が両方明記されている | 「対象」「対象外」セクションが存在し、暗黙の除外がない |
| 5 | 技術的前提 | コードに現れない前提が考慮されている | HTML/CSS 仕様、フレームワーク挙動、ツール制約を確認済み |
| 6 | 既存ドキュメント整合 | 既存ドキュメントと矛盾がない | 要件定義書、設計書、ADR と照合し、矛盾ゼロ |

### 実装フェーズ

各 TDD サイクルの Refactor で [設計原則レンズ](../../docs/04_手順書/04_開発フロー/02_TDD開発フロー.md#設計原則レンズ) の問いに答える。

コミット前に品質チェックリストの「コード品質確認」がすべて OK であること。Phase 完了後に全体を通して検証する。→ [品質チェックリスト](../../docs/04_手順書/04_開発フロー/01_Issue駆動開発.md#62-品質チェックリスト)

| # | 観点 | 理想状態（To-Be） |
|---|------|------------------|
| 1 | アーキテクチャ一貫性 | レイヤー違反がゼロ |
| 2 | 既存パターン整合 | 既存コードと一貫している |
| 3 | 型安全性・エラーハンドリング | 型で表現できるものは型で表現されている |
| 4 | 仕様突合 | OpenAPI 仕様と実装が一致している |
| 5 | レイヤー間接続 | 全レイヤーにフィールド変更が伝播している |
| 6 | YAGNI/KISS の正しい適用 | 機能スコープと設計品質が区別されている |
| 7 | 技術的前提の確認 | ツール仕様が公式ドキュメントで確認されている |

#### 暫定値・ワークアラウンド採用時の影響パス洗い出し

暫定値やワークアラウンドを計画に記載する際は、その値が通る全パス（ユニットテスト、統合テスト、API テスト、開発サーバー）を列挙し、各パスで問題がないことを確認する。

### テストフェーズ

→ [品質チェックリスト](../../docs/04_手順書/04_開発フロー/01_Issue駆動開発.md#62-品質チェックリスト)

| # | 観点 | 理想状態（To-Be） |
|---|------|------------------|
| 1 | テストリスト突合 | 計画と実装が 1:1 で対応している |
| 2 | カバレッジ | 正常系・異常系・境界値が網羅されている |
| 3 | E2E 視点 | ユーザーが UI から操作を完了できる |
| 4 | TDD 遵守 | Red → Green → Refactor のサイクルを守っている |
| 5 | テスト品質 | 各テストが独立した仕様を表現し、冗長なテストがない |

### 横断検証フェーズ（複数 Phase の PR で全 Phase 完了後に実施）

| # | 観点 | 理想状態（To-Be） |
|---|------|------------------|
| 1 | Phase 間データフロー整合 | 全レイヤーでデータが一致している |
| 2 | 仕様との端到端突合 | OpenAPI → Core → BFF → フロントエンドでデータが一貫している |
| 3 | 完了基準の E2E 検証 | Issue の完了基準がすべて達成されている |

## 品質を守る二つの砦

設計 → 最初の砦（ブラッシュアップ）→ 実装（設計原則レンズ）→ 最後の砦（品質ゲート）→ レビュー

| | 最初の砦 | 最後の砦 |
|---|---------|---------|
| タイミング | 設計段階（実装前） | 品質ゲート（実装後） |
| プロセス | [ブラッシュアップループ](#設計ブラッシュアップループ) | [品質ゲート](../../docs/04_手順書/04_開発フロー/01_Issue駆動開発.md#6-品質ゲートと-ready-for-review) |
| マイナス→ゼロ | ギャップ発見（欠陥の発見） | 整合性チェックリスト |
| ゼロ→プラス | ギャップ発見（品質の向上） | 品質向上の最終確認 |

特定コンテキストの詳細ルール（[api.md](api.md), [repository.md](repository.md), [data-store.md](data-store.md)）は俯瞰時の観点を提供する。

## 計画ファイルへの記載（必須）

記載されていない計画は完成とみなさない。

### 確認事項（各 Phase）

実装前に確認すべき型・パターン・ライブラリ API・リファクタリング操作の影響をゲート条件として記載する。
→ 原則: [実装前の確認](pre-implementation.md)

確認事項は Phase の実装に入る前提条件を宣言するもの。Phase 開始時に Read/Grep で実施する。計画ファイルへの状態更新（チェックボックス等）は不要。

```markdown
#### 確認事項
- 型: [確認する型] → [ファイルパス]
- パターン: [参照するパターン] → [参照ファイル]
- ライブラリ: [使用する API] → [Grep 既存使用 or docs.rs URL]
- リファクタリング: [分割対象の重複パターン] → [対象ファイル]
```

確認事項が不要な Phase は「確認事項: なし（既知のパターンのみ）」と明示する。

確認事項は Phase 内部に配置する（テストリストと同じレベル）。ブラッシュアップループや収束確認は計画全体に関わるため末尾に配置する。

### 操作パス（テストリスト作成の前提）

テストリスト作成前に、ユーザーの操作パスを列挙する。操作パスはテスト設計のトップダウンな入力として機能する。

→ 列挙手順と分類の詳細: [TDD 開発フロー > 操作パスの列挙](../../docs/04_手順書/04_開発フロー/02_TDD開発フロー.md#操作パスの列挙テストリスト作成の前に)

```markdown
#### 操作パス

| # | 操作パス | 分類 | テスト層 |
|---|---------|------|---------|
| 1 | [ユーザーの操作を記述] | 正常系 | E2E |
| 2 | [エラー処理の操作を記述] | 準正常系 | API |
```

操作パスが不要な Phase は「操作パス: 該当なし（ドメインロジックのみ）」と明示する。
ドキュメント・インフラ系の Issue で操作パスが存在しない場合は「操作パス: 該当なし（操作パスが存在しない）」と明示する。

### テストリスト（各 Phase）

テストピラミッドの各層を明記する。該当しない層は「該当なし」と記載し、省略しない。

```markdown
#### テストリスト

ユニットテスト:
- [ ] 正常系のテスト

ハンドラテスト（該当なし）
API テスト（該当なし）
E2E テスト（該当なし）
```

テスト層の判断基準: HTTP ハンドラ → ハンドラテスト、公開 API → API テスト、UI 操作 → E2E テスト。

### ブラッシュアップループの記録

ループが 1 回以上記録されていること。

```markdown
### ブラッシュアップループの記録

| ループ | 検出したギャップ | 観点 | 対応 |
|-------|----------------|------|------|
| 1回目 | [何を検出したか] | [観点] | [計画をどう変更したか] |
```

### 収束確認チェックリスト

```markdown
## 収束確認（設計・計画）

| # | 観点 | 理想状態（To-Be） | 判定 | 確認内容 |
|---|------|------------------|------|---------|
| 1 | 網羅性 | 全対象が計画に含まれている | OK | [確認内容] |
| 2 | 曖昧さ排除 | 不確定な記述がゼロ | OK | [確認内容] |
| 3 | 設計判断の完結性 | 全ての差異に判断が記載 | OK | [確認内容] |
| 4 | スコープ境界 | 対象と対象外が両方明記 | OK | [確認内容] |
| 5 | 技術的前提 | 前提が考慮されている | OK | [確認内容] |
| 6 | 既存ドキュメント整合 | 矛盾がない | OK | [確認内容] |
```

## PR 本文への記載（必須）

PR 本文の **Self-review セクション** に収束確認結果を記載する。記載なしで Ready for Review にしない。

品質チェックリスト（6.2）のカテゴリ別に確認内容 1 行で記載する。該当しないカテゴリは `N/A（理由）`。全カテゴリが記載され、各行にコロン以降の確認内容があること。

**実装の場合:**
```markdown
## Self-review

- 設計・ドキュメント: 詳細設計書更新済み、ADR該当なし
- Issue との整合: 完了基準・実装計画すべて達成、Want/To-Be 突合で過不足なし
- テスト: テストリスト全項目実装、全層カバー
- コード品質（マイナス→ゼロ）: レイヤー違反なし、既存パターン準拠、OpenAPI同期確認済み
- 品質向上（ゼロ→プラス）: 不要な中間層なし、責務単一
- UI/UX: N/A（バックエンドのみ）
- 横断検証: N/A（単一Phase）
- `just check-all` pass: 全テスト通過
```

**ドキュメント修正の場合:**
```markdown
## Self-review

- 参照の網羅性: 関連ファイルの参照をすべて更新
- 用語の統一: 新旧用語が混在していないことを確認
- 意図の明確さ: 変更の目的が読み手に伝わることを確認
- `just check-all` pass: 全テスト通過
```

## AI エージェントへの指示

- 実装中は TDD Refactor の設計原則レンズで俯瞰する。具体的な問いに答える
- 発見があった場合のみ、セッションログの判断ログに記録する
- TDD 以外の作業では、変更完了時・発見時・区切りで視点を上げる
- 成果物の提示・コミット前に収束を確認する
- 計画ファイルには収束確認セクションを必ず記載する
- PR 本文の Self-review セクションに収束確認結果を記載する
- 往復の実施を逐一報告する必要はない

**禁止:**

- 視点を上げずに実装だけを続けること
- 収束確認を実施せずに成果物を提示・コミットすること
- 収束確認で指摘が見つかったにもかかわらず修正せずに提示すること
- 収束確認セクションのない計画ファイルを提示すること
- Self-review セクションが空または不十分な状態で品質ゲートを通過済みとすること
