# 自己検証プロトコル（Self-Review Protocol）

設計・実装・テストの成果物を提示・コミットする前に、理想駆動の自己検証ループを実施する。

## 理想駆動の検証ループ

検証ループは「理想状態（To-Be）と現状（As-Is）のギャップがゼロになるまで繰り返す」ことで収束する。

```
┌─────────────────────────────────────┐
│ 1. 初版を生成する                    │
└─────────────────────────────────────┘
              ↓
┌─────────────────────────────────────┐
│ 2. 各項目の「理想状態」と照合する     │
└─────────────────────────────────────┘
              ↓
┌─────────────────────────────────────┐
│ 3. ギャップを特定する                │
└─────────────────────────────────────┘
              ↓
          ギャップ = 0 ?
              │
       No ────┴──── Yes
        │            │
        ↓            ↓
     修正して     提示/コミット
     2 に戻る
```

収束条件: チェックリストの全項目で「理想状態」に達している（ギャップがゼロ）。

重要: 修正によって新たなギャップが生じる場合がある。1回や2回の改善で終わらせず、収束するまで繰り返す。

### To-Be の確定と更新

#### 確定タイミング

| フェーズ | To-Be 確定タイミング |
|---------|---------------------|
| 設計・計画 | 探索完了後、計画を書き始める前 |
| 実装 | テストを書く前（TDD の前提） |
| テスト | テストリスト作成時 |
| 横断検証 | 全 Phase 完了後、検証開始前 |

#### 更新の条件

検証ループ中は To-Be を固定し、As-Is を To-Be に近づける。ただし、以下の場合は To-Be の更新を検討する：

| 条件 | 例 |
|------|-----|
| より良い理想状態の発見 | 実装中にもっとエレガントな設計パターンを発見 |
| 外部からの要件変更 | ユーザーからの指摘、新しい要件の追加 |
| 技術的制約の発見 | 理想が達成不可能と判明 |
| 探索での新知見 | 前提が誤っていたことが判明 |

To-Be を更新する場合は、検証ループを一時停止し、変更理由を明示してから新しい To-Be でループを再開する。

**禁止事項:**

- 検証ループ中に暗黙で To-Be を変更すること
- 「実装が難しいから」という理由で理想を下げること
- 変更理由を記録せずに To-Be を変えること

## フェーズ別チェックリスト

### 設計・計画フェーズ

| # | 観点 | 理想状態（To-Be） | 確認内容 |
|---|------|------------------|---------|
| 1 | 網羅性 | 探索で発見された全対象が計画に含まれている | 対象リストと探索結果を突合し、差分がゼロ。除外はすべて理由付きで記載 |
| 2 | 曖昧さ排除 | 不確定な記述がゼロ | 「あれば」「必要に応じて」等を検索し、該当ゼロを確認 |
| 3 | 設計判断の完結性 | 全ての差異・バリエーションに判断が記載されている | 探索で見つかった差異と計画の判断を突合し、未決定ゼロ |
| 4 | スコープ境界 | 対象と対象外が両方明記されている | 「対象」「対象外」セクションが存在し、暗黙の除外がない |
| 5 | 技術的前提 | コードに現れない前提が考慮されている | HTML/CSS 仕様、フレームワーク挙動、ツール制約を確認済み |
| 6 | 既存ドキュメント整合 | 既存ドキュメントと矛盾がない | 要件定義書、設計書、ADR と照合し、矛盾ゼロ |

出典: 項目 1-5 は [計画段階での網羅性不足](../../prompts/improvements/2026-02/2026-02-02_1023_計画段階での置換対象と設計決定の網羅性不足.md) の対策から抽出。項目 6 は CLAUDE.md 既存ルール（技術選定・設計判断の原則 > 2. 既存ドキュメントの確認を必須とする）。

### 実装フェーズ

TDD サイクルの Refactor ステップで適用する。Refactor は1回の改善で終わりではなく、全項目が理想状態に達するまで繰り返す。

**コミット前の必須確認**: 各 Phase のコミット前に、以下のチェックリストがすべて OK であることを確認する。確認せずにコミットしてはならない。

Phase 完了後にも改めて全体を通して検証する。

| # | 観点 | 理想状態（To-Be） | 確認内容 |
|---|------|------------------|---------|
| 1 | アーキテクチャ一貫性 | レイヤー違反がゼロ | ハンドラ→リポジトリ直接呼び出し等のショートカットがない |
| 2 | 既存パターン整合 | 既存コードと一貫している | 命名、構造、エラー処理が既存パターンに準拠 |
| 3 | 型安全性・エラーハンドリング | 型で表現できるものは型で表現されている | String/整数の濫用、安易な unwrap/expect がない |
| 4 | 仕様突合 | OpenAPI 仕様と実装が一致している | フィールド、ステータスコード、型を突合し、差分ゼロ |
| 5 | レイヤー間接続 | 全レイヤーにフィールド変更が伝播している | API レスポンス拡張が必要な箇所を見落としていない |
| 6 | YAGNI/KISS の正しい適用 | 機能スコープと設計品質が区別されている | シンプル化を理由にしたレイヤー違反・型安全性省略がない |
| 7 | 技術的前提の確認 | ツール仕様が公式ドキュメントで確認されている | 推測に基づく実装がない |

出典: 項目 1, 3, 6 は [YAGNI-KISS の拡大解釈](../../prompts/improvements/2026-02/2026-02-01_0004_YAGNI-KISSの拡大解釈による設計品質低下.md)。項目 4 は [OpenAPI 仕様突合漏れ](../../prompts/improvements/2026-01/2026-01-29_1445_Phase5実装時のOpenAPI仕様突合漏れ.md)。項目 5 は [E2E 視点の完了基準欠如](../../prompts/improvements/2026-01/2026-01-29_1304_E2E視点の完了基準欠如.md)。項目 7 は [Hurl 仕様未確認のまま機能を推奨](../../prompts/improvements/2026-02/2026-02-01_0003_Hurl仕様未確認のまま機能を推奨.md)。項目 2 は品質原則に基づく補完項目。

### テストフェーズ

| # | 観点 | 理想状態（To-Be） | 確認内容 |
|---|------|------------------|---------|
| 1 | テストリスト突合 | 計画と実装が 1:1 で対応している | 実装計画のテストリストと実際のテストを突合し、差分ゼロ |
| 2 | カバレッジ | 正常系・異常系・境界値が網羅されている | 各パターンのテストが存在し、漏れゼロ |
| 3 | E2E 視点 | ユーザーが UI から操作を完了できる | フルスタック機能の場合、E2E シナリオを確認済み |
| 4 | TDD 遵守 | Red → Green → Refactor のサイクルを守っている | テストを先に書き、プロダクションコードは後 |

出典: 項目 1 は TDD 開発フローのテストリスト進め方。項目 2 は TDD 開発フロー チェックリスト。項目 3 は [E2E 視点の完了基準欠如](../../prompts/improvements/2026-01/2026-01-29_1304_E2E視点の完了基準欠如.md)。項目 4 は TDD 開発フローのサイクル定義。

### 横断検証フェーズ（複数 Phase の PR で全 Phase 完了後に実施）

各 Phase が個別に整合していても、Phase 間の接続でずれが生じることがある。全 Phase 完了後に、PR 全体を俯瞰して検証する。

| # | 観点 | 理想状態（To-Be） | 確認内容 |
|---|------|------------------|---------|
| 1 | Phase 間データフロー整合 | 全レイヤーでデータが一致している | 下位レイヤーの出力と上位レイヤーの入力を突合し、差分ゼロ |
| 2 | 仕様との端到端突合 | OpenAPI → Core → BFF → フロントエンドでデータが一貫している | Silent Failure（オプショナルフィールドでのフォールバック）がない |
| 3 | 完了基準の E2E 検証 | Issue の完了基準がすべて達成されている | E2E 基準「ユーザーが UI から操作を完了できる」を確認済み |

出典: 項目 1, 2 は [OpenAPI 仕様突合漏れ](../../prompts/improvements/2026-01/2026-01-29_1445_Phase5実装時のOpenAPI仕様突合漏れ.md) および [E2E 視点の完了基準欠如](../../prompts/improvements/2026-01/2026-01-29_1304_E2E視点の完了基準欠如.md)。これらのインシデントでは、各 Phase は個別に正しかったがレイヤー間の接続で Silent Failure が発生した。

## 既存の検証プロセスとの関係

自己検証プロトコルは、既存の検証プロセスと**補完関係**にある。

| 既存プロセス | 役割 | 自己検証との関係 |
|-------------|------|----------------|
| [Ready for Review チェックリスト](../../docs/04_手順書/04_開発フロー/01_Issue駆動開発.md#62-整合性チェックリスト) | PR 提出前の最終確認 | 自己検証 = 開発中の各フェーズで実施。Ready for Review = PR 提出前の横断チェック |
| [TDD Refactor ステップ](../../docs/04_手順書/04_開発フロー/02_TDD開発フロー.md#-refactor-きれいにする) | コード内部品質の改善 | Refactor 自体が「改善→確認→改善→...→指摘ゼロ」の検証ループ。実装チェックリストはその収束基準として機能する |
| 既存 rules（[api.md](api.md), [repository.md](repository.md), [data-store.md](data-store.md)） | 特定コンテキストの詳細ルール | 自己検証は「いつ・何を検証するか」の上位構造。各 rules は具体的手順を提供 |

## 計画ファイルへの検証結果記載（必須）

計画ファイル（plan mode で作成するファイル）には、末尾に自己検証セクションを記載する。検証結果が記載されていない計画は完成とみなさない。

```markdown
## 自己検証（設計・計画）

| # | 観点 | 理想状態（To-Be） | 判定 | 確認内容 |
|---|------|------------------|------|---------|
| 1 | 網羅性 | 探索で発見された全対象が計画に含まれている | OK | [具体的に何を確認したか] |
| 2 | 曖昧さ排除 | 不確定な記述がゼロ | OK | [具体的に何を確認したか] |
| 3 | 設計判断の完結性 | 全ての差異に判断が記載されている | OK | [具体的に何を確認したか] |
| 4 | スコープ境界 | 対象と対象外が両方明記されている | OK | [具体的に何を確認したか] |
| 5 | 技術的前提 | コードに現れない前提が考慮されている | OK | [具体的に何を確認したか] |
| 6 | 既存ドキュメント整合 | 既存ドキュメントと矛盾がない | OK | [具体的に何を確認したか] |
```

目的: 行動規範（「検証すること」）ではなく成果物要件（「検証結果が記載されていること」）にすることで、検証の欠落を構造的に防ぐ。理想状態を明示することで、何をもって「OK」とするかが明確になる。

改善の経緯: [自己検証ループの自動実行欠如](../../prompts/improvements/2026-02/2026-02-05_2100_自己検証ループの自動実行欠如.md)

## AI エージェントへの指示

- 成果物（計画、設計書、コード、テスト）を提示・コミットする前に、該当フェーズのチェックリストで自己検証を実施する
- 指摘がゼロになるまで修正→再検証を繰り返す
- 計画ファイルには自己検証セクションを必ず記載する
- 検証の実施を逐一報告する必要はない。品質は結果で示す

**禁止事項:**

- 自己検証を実施せずに成果物を提示・コミットすること
- 検証で指摘が見つかったにもかかわらず修正せずに提示すること
- 自己検証セクションのない計画ファイルを提示すること

## 参照

- 改善記録:
  - [自己検証ループの自動実行欠如](../../prompts/improvements/2026-02/2026-02-05_2100_自己検証ループの自動実行欠如.md)
  - [計画段階での置換対象と設計決定の網羅性不足](../../prompts/improvements/2026-02/2026-02-02_1023_計画段階での置換対象と設計決定の網羅性不足.md)
  - [YAGNI-KISS の拡大解釈による設計品質低下](../../prompts/improvements/2026-02/2026-02-01_0004_YAGNI-KISSの拡大解釈による設計品質低下.md)
  - [Hurl 仕様未確認のまま機能を推奨](../../prompts/improvements/2026-02/2026-02-01_0003_Hurl仕様未確認のまま機能を推奨.md)
  - [E2E 視点の完了基準欠如](../../prompts/improvements/2026-01/2026-01-29_1304_E2E視点の完了基準欠如.md)
  - [Phase 5 実装時の OpenAPI 仕様突合漏れ](../../prompts/improvements/2026-01/2026-01-29_1445_Phase5実装時のOpenAPI仕様突合漏れ.md)
- 既存プロセス:
  - [Issue 駆動開発](../../docs/04_手順書/04_開発フロー/01_Issue駆動開発.md)
  - [TDD 開発フロー](../../docs/04_手順書/04_開発フロー/02_TDD開発フロー.md)
