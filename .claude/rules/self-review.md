# 自己検証プロトコル（Self-Review Protocol）

設計・実装・テストの成果物を提示・コミットする前に、自己検証ループを実施する。

## 検証ループ

```
生成 → 検証 → 修正 → 再検証 → ... → 指摘ゼロ → 提示/コミット
```

1. 初版を生成する
2. 該当フェーズのチェックリストで検証する
3. 指摘があれば修正する
4. 修正箇所を含めて再度チェックリストで検証する
5. **指摘がゼロになるまで 2-4 を繰り返す**
6. 指摘ゼロを確認してから提示またはコミットする

重要: 修正によって新たな問題が生じる場合がある。1回の修正で終わらせず、収束するまで繰り返す。

## フェーズ別チェックリスト

### 設計・計画フェーズ

| # | 観点 | 確認内容 |
|---|------|---------|
| 1 | 網羅性 | 探索・調査で発見された全パターン・全ファイルが対象リストに含まれているか。含まないものは「対象外」に理由付きで記載されているか |
| 2 | 曖昧さ排除 | 「あれば」「必要に応じて」等の不確定な記述が残っていないか。探索で確認可能な事実はすべて確定させたか |
| 3 | 設計判断の完結性 | 探索で見つかった差異・バリエーションに対して、すべて具体的な判断と影響が記載されているか |
| 4 | スコープ境界 | 対象と対象外の両方が明記されているか。暗黙の除外がないか |
| 5 | 技術的前提 | HTML/CSS の仕様、フレームワークの挙動、ツールの制約など、コードに現れない前提も考慮したか |
| 6 | 既存ドキュメント整合 | 要件定義書、設計書、ADR と矛盾する記述がないか |

出典: 項目 1-5 は [計画段階での網羅性不足](../../prompts/improvements/2026-02/2026-02-02_1023_計画段階での置換対象と設計決定の網羅性不足.md) の対策から抽出。項目 6 は CLAUDE.md 既存ルール（技術選定・設計判断の原則 > 2. 既存ドキュメントの確認を必須とする）。

### 実装フェーズ

| # | 観点 | 確認内容 |
|---|------|---------|
| 1 | アーキテクチャ一貫性 | レイヤー違反がないか。ハンドラからリポジトリを直接呼ぶなど、ショートカットしていないか |
| 2 | 既存パターン整合 | 既存コードのパターン（命名、構造、エラー処理）と一貫しているか |
| 3 | 型安全性・エラーハンドリング | String/整数の濫用がないか。安易な unwrap/expect を使っていないか。エラーを適切な型で扱っているか |
| 4 | 仕様突合 | API を含む場合、OpenAPI 仕様書と実装が一致しているか（フィールド、ステータスコード、型） |
| 5 | レイヤー間接続 | フルスタック変更の場合、既存 API のレスポンス拡張が必要な箇所を見落としていないか |
| 6 | YAGNI/KISS の正しい適用 | 「シンプルにする」を理由にレイヤー違反や型安全性の省略をしていないか。機能スコープと設計品質を区別しているか |
| 7 | 技術的前提の確認 | ツール・ライブラリの仕様を公式ドキュメントで確認したか。推測に基づく実装をしていないか |

出典: 項目 1, 3, 6 は [YAGNI-KISS の拡大解釈](../../prompts/improvements/2026-02/2026-02-01_0004_YAGNI-KISSの拡大解釈による設計品質低下.md)。項目 4 は [OpenAPI 仕様突合漏れ](../../prompts/improvements/2026-01/2026-01-29_1445_Phase5実装時のOpenAPI仕様突合漏れ.md)。項目 5 は [E2E 視点の完了基準欠如](../../prompts/improvements/2026-01/2026-01-29_1304_E2E視点の完了基準欠如.md)。項目 7 は [Hurl 仕様未確認のまま機能を推奨](../../prompts/improvements/2026-02/2026-02-01_0003_Hurl仕様未確認のまま機能を推奨.md)。項目 2 は品質原則に基づく補完項目。

### テストフェーズ

| # | 観点 | 確認内容 |
|---|------|---------|
| 1 | テストリスト突合 | 実装計画のテストリストと、実際に書いたテストが 1:1 で対応しているか |
| 2 | カバレッジ | 正常系・異常系・境界値が網羅されているか |
| 3 | E2E 視点 | フルスタック機能の場合、「ユーザーが UI から操作を完了できる」ことを確認したか |
| 4 | TDD 遵守 | テストを先に書いてからプロダクションコードを書いたか。Red → Green → Refactor のサイクルを守ったか |

出典: 項目 1 は TDD 開発フローのテストリスト進め方。項目 2 は TDD 開発フロー チェックリスト。項目 3 は [E2E 視点の完了基準欠如](../../prompts/improvements/2026-01/2026-01-29_1304_E2E視点の完了基準欠如.md)。項目 4 は TDD 開発フローのサイクル定義。

## 既存の検証プロセスとの関係

自己検証プロトコルは、既存の検証プロセスと**補完関係**にある。

| 既存プロセス | 役割 | 自己検証との関係 |
|-------------|------|----------------|
| [Ready for Review チェックリスト](../../docs/04_手順書/04_開発フロー/01_Issue駆動開発.md#62-整合性チェックリスト) | PR 提出前の最終確認 | 自己検証 = 開発中の各フェーズで実施。Ready for Review = PR 提出前の横断チェック |
| [TDD Refactor ステップ](../../docs/04_手順書/04_開発フロー/02_TDD開発フロー.md#-refactor-きれいにする) | コード内部品質の改善 | 自己検証はそれに加えて設計との整合性、パターンの一貫性を確認する上位概念 |
| 既存 rules（[api.md](api.md), [repository.md](repository.md), [data-store.md](data-store.md)） | 特定コンテキストの詳細ルール | 自己検証は「いつ・何を検証するか」の上位構造。各 rules は具体的手順を提供 |

## AI エージェントへの指示

- 成果物（計画、設計書、コード、テスト）を提示・コミットする前に、該当フェーズのチェックリストで自己検証を実施する
- 指摘がゼロになるまで修正→再検証を繰り返す
- 検証の実施を逐一報告する必要はない。品質は結果で示す

**禁止事項:**

- 自己検証を実施せずに成果物を提示・コミットすること
- 検証で指摘が見つかったにもかかわらず修正せずに提示すること

## 参照

- 改善記録:
  - [計画段階での置換対象と設計決定の網羅性不足](../../prompts/improvements/2026-02/2026-02-02_1023_計画段階での置換対象と設計決定の網羅性不足.md)
  - [YAGNI-KISS の拡大解釈による設計品質低下](../../prompts/improvements/2026-02/2026-02-01_0004_YAGNI-KISSの拡大解釈による設計品質低下.md)
  - [Hurl 仕様未確認のまま機能を推奨](../../prompts/improvements/2026-02/2026-02-01_0003_Hurl仕様未確認のまま機能を推奨.md)
  - [E2E 視点の完了基準欠如](../../prompts/improvements/2026-01/2026-01-29_1304_E2E視点の完了基準欠如.md)
  - [Phase 5 実装時の OpenAPI 仕様突合漏れ](../../prompts/improvements/2026-01/2026-01-29_1445_Phase5実装時のOpenAPI仕様突合漏れ.md)
- 既存プロセス:
  - [Issue 駆動開発](../../docs/04_手順書/04_開発フロー/01_Issue駆動開発.md)
  - [TDD 開発フロー](../../docs/04_手順書/04_開発フロー/02_TDD開発フロー.md)
