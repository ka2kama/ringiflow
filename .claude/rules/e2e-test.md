---
paths:
  - "tests/e2e/**"
---

# E2E テスト（Playwright）のルール

このルールは Playwright E2E テストファイルを追加・変更する際に適用される。

## スコープ方針: クリティカルパスに集中する

E2E テストはテストピラミッドの最上位（5%）。以下の原則に従う。→ [テストピラミッドの概念整理](../../docs/80_ナレッジベース/methodology/テストピラミッド.md)

| 原則 | 説明 |
|------|------|
| クリティカルパスのみ | ユーザーが操作を完結できるかを検証する。詳細なバリデーションやエッジケースは Unit/API テストで担う |
| 重複テストしない | API テスト（Hurl）で検証済みのレスポンス構造・ステータスコードを E2E で再検証しない |
| シナリオ単位 | 1 テストファイル = 1 ユーザーシナリオ（申請フロー、承認フロー等） |

## UI 固有エッジケースの方針

E2E テストは他の層で検証できない UI 固有の問題のみをカバーする。入力値の境界値や API レスポンスの詳細はユニット/API テストの責務。

### カバーすべきエッジケース

| カテゴリ | テスト対象 | 検証内容 |
|---------|-----------|---------|
| 二重送信防止 | 送信ボタンの連打 | ボタンの disabled 化、loading 表示 |
| セッション切れ | トークン期限切れ後の操作 | ログイン画面への遷移 |
| エラー画面表示 | 404、サーバーエラー | エラーメッセージの表示、回復手段の案内 |
| フォームバリデーション | フロントエンド固有のバリデーション | インラインエラーメッセージの表示 |
| 空データ表示 | データ 0 件の一覧画面 | 空状態メッセージ（EmptyState コンポーネント） |

### E2E で検証しないエッジケース

以下はユニット/API テストに委譲する:

- 入力値の全境界値（空文字、最大長、特殊文字）→ ユニットテスト
- API レスポンスの詳細構造 → API テスト
- 状態遷移の全セルの検証 → ユニットテスト
- ページネーションの無効パラメータ → API テスト

→ 全体方針: [テスト戦略: エッジケース方針](../../docs/50_テスト/テスト戦略_エッジケース方針.md)

## テストの書き方

### 表現形式

ADR-032 に従い、Given-When-Then 形式で記述する。

```typescript
test.describe("シナリオ名", () => {
  test("テスト名（日本語）", async ({ page }) => {
    // Given: 前提条件

    // When: 操作

    // Then: 検証
    await expect(page.getByText("期待する表示")).toBeVisible();
  });
});
```

### テストデータの分離

テスト間でデータが衝突しないよう、ユニークな識別子を使う:

```typescript
const uniqueTitle = `E2E テスト申請 ${Date.now()}`;
```

### ロケーター戦略

Playwright 推奨の優先順位に従う:

| 優先度 | ロケーター | 用途 |
|--------|-----------|------|
| 1 | `getByRole` | ARIA ロールで特定（最も安定） |
| 2 | `getByText` / `getByLabel` | テキスト・ラベルで特定 |
| 3 | `getByPlaceholder` | プレースホルダーで特定 |
| 4 | `locator`（CSS セレクタ） | 上記で特定できない場合の最終手段 |

CSS クラス名やテスト用 data 属性への依存は最小限にする。

## 認証パターン

storageState を使用する。テスト実行前に `auth.setup.ts` で API ログインし、Cookie を保存する。

新しいロール（ユーザー種別）のテストを追加する場合:

1. `helpers/test-data.ts` にユーザー定数を追加
2. `tests/auth.setup.ts` に新しいセットアップを追加
3. `playwright.config.ts` に新しいプロジェクトを追加（`storageState` パスを変更）

## テストデータ管理

- **シードデータ**: テナント、ユーザー、ワークフロー定義はシードデータ（`backend/migrations/20260115000008_seed_system_data.sql`）に依存
- **テスト固有データ**: 各テスト内で動的に作成し、`Date.now()` 等でユニーク化
- **定数**: `helpers/test-data.ts` でシードデータと対応する定数を管理

## 必須チェック項目

### 1. E2E テスト突合表の更新

E2E テストを追加・削除した場合、[E2E テスト突合表](../../docs/50_テスト/E2Eテスト突合表.md)を更新する。

### 2. CI 通過確認

`just test-e2e` または `just check-all` でテストが通ることを確認する。

### 3. 既存テストへの影響確認

UI 変更を伴うコード修正では、既存の E2E テストが影響を受けないか確認する。特にロケーター（テキスト、ロール名、プレースホルダー）の変更に注意する。

## AI エージェントへの指示

E2E テストを追加する際:

1. 要件定義の E2E シナリオ（CORE-12 セクション 12.6）を確認し、対応するシナリオを特定する
2. 既存テストのパターン（`tests/e2e/tests/*.spec.ts`）に従って記述する
3. テスト追加後、E2E テスト突合表を更新する
4. `just test-e2e` でテストが通ることを確認する

**禁止事項:**

- API テストで検証済みの詳細（レスポンス JSON 構造、ステータスコード等）を E2E で重複検証すること
- E2E テスト突合表を更新せずにテストを追加・削除すること
- テスト間でデータが衝突する（ユニーク化されていない）テストを書くこと

## 参照

- Playwright ナレッジベース: [docs/80_ナレッジベース/devtools/Playwright.md](../../docs/80_ナレッジベース/devtools/Playwright.md)
- API テストルール: [.claude/rules/api-test.md](api-test.md)
- テスト設計方針: [docs/70_ADR/032_テスト設計方針.md](../../docs/70_ADR/032_テスト設計方針.md)
- E2E テスト突合表: [docs/50_テスト/E2Eテスト突合表.md](../../docs/50_テスト/E2Eテスト突合表.md)
