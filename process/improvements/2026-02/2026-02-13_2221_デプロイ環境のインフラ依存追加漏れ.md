# デプロイ環境のインフラ依存追加漏れ

## 事象

DynamoDB（監査ログ用）が BFF の必須依存として追加されたが、Lightsail デモ環境の `docker-compose.yaml` が更新されなかった。その結果、デモ環境で BFF が `DYNAMODB_ENDPOINT` 未設定でパニックし、起動に失敗した。

ローカル開発環境の `infra/docker/docker-compose.yaml` には DynamoDB Local が追加されていたため、ローカルでは問題なく動作していた。

## 原因分析

### 表層的原因

DynamoDB 追加時に Lightsail の docker-compose を更新しなかった。

### 根本原因

サービスに新しいインフラ依存を追加する際、**全デプロイ環境の構成を同期する**チェックがプロセスに存在しない。

既存ルールとの比較:

| ルール | 対象 | カバー範囲 |
|--------|------|-----------|
| `data-store.md` | 新データストア追加 | 削除レジストリへの登録 |
| アーキテクチャ構成変更 | サービス追加・削除 | 基本設計書の更新 |
| （なし） | インフラ依存の追加 | 全デプロイ環境の docker-compose 同期 |

「新データストアの追加」と「デプロイ環境への反映」が別の関心事として扱われており、後者を保証する仕組みがなかった。

## 対策

### 対策形式の検討

| 形式 | 案 | 評価 |
|------|-----|------|
| 行動規範 | 「全 docker-compose を更新すること」 | 低（忘れる） |
| 成果物要件 | `data-store.md` にデプロイ環境同期のチェック項目を追加 | 高 |
| フロー組み込み | CI で docker-compose 間の service 定義を比較 | 高いが過剰 |

成果物要件として、`data-store.md` の手順にデプロイ環境の docker-compose 同期を追加する。

Issue #506

## 分類

- カテゴリ: 視点不足
- 失敗タイプ: プロセスギャップ
