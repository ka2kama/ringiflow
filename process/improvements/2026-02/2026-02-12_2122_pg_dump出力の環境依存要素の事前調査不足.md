# pg_dump 出力の環境依存要素の事前調査不足

## 事象

`pg_dump` でスキーマスナップショットを生成する仕組みの計画時に、バージョン行（`Dumped from/by`）は想定していたが、PostgreSQL 17 で追加された `\restrict`/`\unrestrict` ディレクティブ（ランダムトークン付き）を想定できなかった。

手動検証で `just schema-check` を実行した際に、毎回異なるトークンが生成されて diff が出ることを発見し、対応した。手動検証がなければ CI で初めて失敗していた。

## 原因分析

計画段階で `pg_dump` の出力に含まれる環境依存要素を、既知の知識（バージョン行）のみで列挙した。実際の出力を確認する手順を踏まなかった。

`\restrict`/`\unrestrict` は PostgreSQL 17 で追加された新しい機能であり、訓練データに含まれていない可能性が高い。ライブラリ API と同様に、ツール出力も「推測ではなく実際に確認する」原則が適用される。

## 対策

計画段階で `pg_dump` を試行実行し、出力を確認するステップを確認事項に含めるべきだった。今回は手動検証で検出できたため実害はなし。

対策形式の検証:
- 行動規範（「出力を確認する」）→ 成果物要件に転換: 計画の確認事項に「ツール出力の実際の確認」を含めることで、チェックボックスとして可視化される
- [pre-implementation.md](../../.claude/rules/pre-implementation.md) のカテゴリ1（ライブラリ API）と同じ考え方。外部ツールの出力もソースを直接確認できないため、実行して確認する

恒久対策の Issue 化: 不要（既存の確認事項の運用で対応可能。新しいルールの追加は不要）

## 次のアクション

- なし（既存の pre-implementation ルールの適用範囲内。今回の事例を改善記録として残すことで十分）

## 分類

- カテゴリ: 単一パス検証
- 失敗タイプ: 知識ギャップ
- 問題の性質: 技術的
