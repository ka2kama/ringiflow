# 散弾銃デバッグによるトラブルシューティング効率低下

## 事象

E2E テスト（request-changes.spec.ts）の失敗調査において、2セッション（auto compaction を含む）にわたり散弾銃デバッグ（shotgun debugging）を継続した。定義 API の実際の HTTP レスポンスを確認せず、テストコードの修正を繰り返した。

具体的な修正試行:

| 試行 | 修正内容 | 結果 |
|------|---------|------|
| 1 | `waitForResponse` で定義 API レスポンスを待機 | 失敗 |
| 2 | SPA リンククリックから `page.goto(href!)` に変更 | 失敗 |
| 3 | フォームデータの heading 表示待ちを追加 | 失敗 |
| 4 | 「テスト件名」テキストの表示待ちを追加 | 失敗 |

いずれも「定義が読み込まれていない」という症状に対する推測ベースの修正であり、**定義 API が実際に何を返しているか**を一度も確認していなかった。

## 原因分析

### 直接的原因

仮説を立てた後、検証をスキップして修正に飛ぶパターンを繰り返した。

```
正しい流れ:  観察 → 仮説 → 検証 → 修正
実際の流れ:  観察 → 仮説 → 修正 → 失敗 → 別の仮説 → 修正 → 失敗 → ...
```

### 構造的原因

troubleshooting.md の調査フローに以下の欠陥がある:

1. **修正に入る前のゲートがない**: 仮説を立てた直後に修正に飛べる構造。「検証結果を記録してから修正に入る」という成果物要件がない
2. **仮説追跡の仕組みがない**: どの仮説を立て、どれを検証し、どれを棄却したか追跡する構造がない
3. **散弾銃デバッグのアンチパターンが明示されていない**: 「禁止事項」に推測での判断は書いてあるが、「仮説を検証せず修正を試す」パターンが明示されていない
4. **問題空間の切り分け（Isolate）が不在**: 現在のフローは「ソースデータで確認」と抽象的に書くのみで、二分探索やレイヤー切り分けなどの具体的な手法がない

## 対策

### 1. troubleshooting.md に「仮説検証ループ」を追加

調査フローを「観察 → 仮説 → 検証 → 修正」の明示的なループに再構成する。修正に入る前に「検証結果の記録」をゲートとする（成果物要件）。

### 2. 散弾銃デバッグのアンチパターンを明示

禁止事項に「仮説を検証せずに修正を試みること」を追加。判定基準: 修正の根拠が「〜かもしれない」「試してみよう」であれば散弾銃デバッグ。

### 3. 問題空間の切り分け手法を追加

二分探索（binary search）やレイヤー切り分けの具体的なパターンを追加する。

## 系統的アプローチの適用結果

改善した troubleshooting.md のフレームワークを直後に適用し、以下の結果を得た。

### 仮説追跡

| # | 仮説 | 予測 | 検証手段 | 結果 |
|---|------|------|---------|------|
| 1 | API が非 200 を返している | レスポンスステータスが 4xx/5xx | `page.on("response")` でインターセプト | **棄却**: 200 を返していた |
| 2 | API は 200 だがデコーダが失敗 | レスポンスは 200 だが Elm が Failure にする | ページスナップショットで `viewRawFormData`（Failure 時のフォールバック）の出力を確認 | **支持** |
| 3 | API リクエスト自体が発行されていない | リクエストが記録されない | `page.on("response")` で確認 | **棄却**: 1 件記録された |

### 根本原因

`WorkflowDefinition.decoder` に `Decode.field "data"` ラッパーが欠落していた。API レスポンス `{"data": {...}}` に対して、デコーダはルートレベルで `"id"` フィールドを探すためデコード失敗。

Detail.elm の `viewFormData` が `Failure` 時に `viewRawFormData`（生データ表示）にフォールバックするため、ユーザーにはやや見栄えが悪い程度にしか見えず、バグが長期間隠蔽されていた。

### 対比

| 指標 | 散弾銃デバッグ | 系統的アプローチ |
|------|-------------|---------------|
| 所要時間 | 2 セッション（auto compaction 含む） | 仮説検証 3 回 |
| 修正試行回数 | 4 回以上（すべて失敗） | 1 回（成功） |
| 根本原因の特定 | できなかった | `page.on("response")` で即座に API は正常と判明 → デコーダに絞り込み |

## 次のアクション

- [x] troubleshooting.md の強化（本セッション内で実施済み）

## 分類

- カテゴリ: 即座の対策
- 失敗タイプ: プロセスギャップ
- 問題の性質: プロセス的

## 既知手法との関連

- David Agans "Debugging: The 9 Indispensable Rules" — 特に "Quit thinking and look"（推測を止めてデータを見ろ）
- 科学的方法（Scientific Method）— 観察 → 仮説 → 予測 → 実験 → 分析のサイクル
- Reproduce → Isolate → Identify → Fix → Verify — 業界標準のデバッグワークフロー
- Shotgun debugging — Wikipedia に定義される「無方向な変更」のアンチパターン
