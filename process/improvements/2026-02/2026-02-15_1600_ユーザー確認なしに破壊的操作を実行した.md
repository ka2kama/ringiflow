# ユーザー確認なしに破壊的操作を実行した

## 事象

worktree 削除の方法に関する質問を受けた際、ユーザーの確認を得ずに `just worktree-remove 276` を実行した。

経緯:
1. worktree のディレクトリ削除方法について質問を受ける
2. `git worktree list` で `ringiflow-276` worktree を確認
3. ユーザーの確認なしに `just worktree-remove 276` を即座に実行
4. worktree 削除完了を報告
5. ユーザーから作業中の worktree だったことを指摘される
6. ブランチは残っていたため、worktree を再作成して対応
7. 破壊的操作を確認なしに実行したことを指摘される

## 原因分析

### 表層的な原因

worktree 削除方法の質問を、削除の実行依頼と誤解し、即座に削除コマンドを実行した。

### 根本原因

CLAUDE.md の「Executing actions with care」に明確に記載されているにもかかわらず、破壊的操作の実行前にユーザー確認を求めなかった。

**CLAUDE.md の該当箇所:**

> For actions that are hard to reverse, affect shared systems beyond your local environment, or could otherwise be risky or destructive, check with the user before proceeding.

> Examples of the kind of risky actions that warrant user confirmation:
> - Destructive operations: deleting files/branches, dropping database tables, killing processes, rm -rf, **overwriting uncommitted changes**

`just worktree-remove` は内部で `git worktree remove --force` を使用しており、未コミットの変更があっても問答無用で削除される。これは典型的な「hard to reverse」な操作である。

本来あるべきフロー:
1. 状況確認（`git worktree list`, `cd` して `git status` で未コミットの変更を確認）
2. ユーザーに確認を求める（例: 276 の worktree を削除してよいか、未コミットの変更が失われる旨を伝える）
3. 承認を得てから実行

## 対策

### 恒久対策

成果物要件に転換し、AI エージェントのチェックリストに組み込む。

**CLAUDE.md 「Executing actions with care」セクションに追加:**

破壊的操作の判定チェックリスト（実行前に必ず確認）:

| # | 確認項目 | 判定基準 |
|---|---------|---------|
| 1 | 操作は可逆か？ | 削除、`--force`、上書きは不可逆 → 確認必要 |
| 2 | データ損失の可能性は？ | 未コミットの変更、未 push のコミットが失われる可能性 → 確認必要 |
| 3 | ユーザーの意図は明示的か？ | 質問と依頼を区別する。意図が曖昧なら確認必要 |

これらのいずれかに該当する場合、実行前にユーザーに確認を求める。

**禁止事項に追加:**
- ユーザーの発言を推測で解釈し、確認なしに破壊的操作を実行すること

Issue #549

### 暫定対策（即時適用）

破壊的操作を実行する前に、以下のパターンでユーザーに確認を求める:

```
[操作の内容] を実行してよろしいですか？
- 影響: [何が失われるか、何が変更されるか]
- 可逆性: [元に戻せるか、戻せない場合の補足]
```

## 次のアクション

- CLAUDE.md の「Executing actions with care」セクションに破壊的操作の判定チェックリストを追加する Issue を作成
- 禁止事項に「ユーザーの発言を推測で解釈し、確認なしに破壊的操作を実行すること」を追加する

## 分類

- カテゴリ: 即座の対策
- 失敗タイプ: 実行ギャップ
- 問題の性質: プロセス的
