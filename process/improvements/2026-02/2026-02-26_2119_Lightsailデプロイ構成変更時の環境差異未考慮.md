# Lightsail デプロイ構成変更時の環境差異未考慮

## 事象

PR #917（S3 infrastructure and MinIO local environment）のマージ後、Lightsail デプロイが 2 回連続で失敗した。

- 1 回目（07:03）: MinIO コンテナが unhealthy となり `docker compose up` が失敗（exit 1）
- 2 回目（08:37）: SSH 接続が `Broken pipe` で切断（exit 255）

直前の成功 run（01:06、コミット `3a50bd32`）と最初の失敗 run（07:03、コミット `c0ecb526`）の間に PR #917 のマージがあり、MinIO 追加が直接のトリガーだった。

## 原因分析

### 直接原因

1. MinIO ヘルスチェックの猶予が Lightsail の低スペック環境に対して不足していた（最大 35 秒）
2. SSH 接続に keepalive 設定がなく、docker pull 等の長時間処理中に接続が切断された

### 根本原因

**環境差異の未考慮**: ローカル開発環境のヘルスチェック設定をそのまま Lightsail 用 docker-compose にも適用した。ローカル環境とリソースの限られた Lightsail インスタンスではコンテナ起動時間が異なるが、その差異が検討されなかった。

**潜在リスクの顕在化**: SSH keepalive の欠如は MinIO 追加以前から存在していた。コンテナ数が少なくデプロイ時間が短いうちは問題にならなかったが、MinIO 追加によりコンテナ数・pull 時間が増加し閾値を超えた。

### 品質ゲートとの関係

PR #917 の品質ゲート時点で Lightsail の docker-compose を変更した事実はあったが、「デプロイ対象環境でのリソース特性」を確認する観点が品質チェックリストに存在しなかった。CI は通るが、実際のデプロイは main マージ後に初めて実行されるため、マージ前に検証する仕組みがない。

## 対策

### 暫定対策（PR #931 で実施済み）

1. SSH keepalive 設定の追加（`ServerAliveInterval=30`, `ServerAliveCountMax=10`）
2. MinIO ヘルスチェック猶予の拡大（start_period: 30s, retries: 10, interval/timeout: 10s）

### 恒久対策（成果物要件）

品質チェックリストの「コード品質確認」に、インフラ構成変更時の観点を追加する:

- デプロイ構成（docker-compose、CI/CD）を変更した場合、対象環境のリソース特性（CPU、メモリ、ネットワーク帯域）がローカル環境と異なることを考慮したか

Issue #932

## 次のアクション

- [x] 暫定対策: SSH keepalive + MinIO ヘルスチェック拡大（PR #931）
- [ ] Issue #932: 品質チェックリストにインフラ構成変更時の環境差異確認観点を追加

## 分類

- カテゴリ: 視点不足
- 失敗タイプ: プロセスギャップ
- 問題の性質: プロセス的
