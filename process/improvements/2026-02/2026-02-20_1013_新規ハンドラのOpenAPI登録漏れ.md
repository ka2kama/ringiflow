# 新規ハンドラの OpenAPI 登録漏れ

## 事象

ワークフロー定義管理 API（6 エンドポイント）を実装した際、各ハンドラに `#[utoipa::path]` アノテーションを付与したが、`openapi.rs` の `ApiDoc` 構造体への登録と `just openapi-generate` の実行を漏らした。

`just check-all`（`openapi-check` を含む）は通過した。`openapi-check` は `openapi.yaml` と utoipa 生成出力の一致のみを検証するため、登録漏れ（= 両方に同じエンドポイントが欠落）は検出できない。

Claude Auto Review の Rules Check で指摘され、修正時にも `openapi.yaml` を手動編集しようとした。ユーザーの指摘により utoipa 自動生成の仕組みを正しく使用する方法に修正した。

## 原因分析

1. 新規ハンドラ追加時のワークフローに、OpenAPI 登録ステップが明示されていない。品質チェックリストの「仕様突合」は「OpenAPI 仕様と実装が一致している」とあるが、具体的な確認手順（openapi.rs への登録確認、`just openapi-generate` の実行）が記載されていない
2. `just openapi-check` は yaml とutoipa 生成結果の一致を検証するが、「実装済みハンドラが全て登録されているか」は検証できない。登録漏れがあっても yaml と生成結果が一致するため通過する（検出のギャップ）
3. 修正時に `openapi.yaml` の生成方法を調査せず、手動編集に着手した

## 対策

問題の性質: プロセス的（新規エンドポイント追加のフローに OpenAPI 登録手順が欠如）

### 暫定対策

品質チェックリストの「仕様突合」に具体的な確認手順を追加する:

- 新規ハンドラモジュール追加時: `openapi.rs` の `paths()` にハンドラ関数を登録
- 新規タグ追加時: `openapi.rs` の `tags()` にタグを登録
- `just openapi-generate` を実行して `openapi.yaml` を更新
- `git diff openapi/openapi.yaml` で新規エンドポイントが含まれていることを目視確認

対策形式の検討: 品質チェックリストへの具体手順追加は成果物要件として機能する（チェック結果が記載されていることが検証可能）。

### 恒久対策（任意）

utoipa アノテーション付きハンドラと `openapi.rs` の登録を自動照合する仕組みの導入。例: `#[utoipa::path]` を持つ関数名を Grep で抽出し、`openapi.rs` の `paths()` 内の関数名と突合するスクリプトを CI に組み込む。

## 次のアクション

- [ ] 品質チェックリストに OpenAPI 仕様突合の具体手順を追加する（Issue #731）

## 分類

- カテゴリ: 知識-実行乖離
- 失敗タイプ: プロセスギャップ
- 問題の性質: プロセス的
