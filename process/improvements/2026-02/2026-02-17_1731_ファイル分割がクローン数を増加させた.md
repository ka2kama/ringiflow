# ファイル分割がクローン数を増加させた

## 事象

Epic #467（`just check` / `check-all` の警告をゼロにする）の Story 2（#525）で、ユースケース層の大きなファイル（`decision.rs`: 1889行、`lifecycle.rs` 等）をファイルサイズ削減のために分割した。結果として、Rust jscpd クローン数が 179 → 218 に増加した（+39件）。

Stories 2〜8 で各レイヤーのクローン削減に取り組んだにもかかわらず、全体のクローン数は当初より増えている。

## 原因分析

### 直接原因

ファイル分割により、1ファイル内の重複パターン（approve/reject/request_changes 等の類似処理）がファイル間クローンに変換された。jscpd はファイル間クローンをより多く検出するため、分割後にクローン数が増加した。

### 根本原因

ファイルサイズ削減とクローン削減は相反する場合がある、というトレードオフが計画段階で十分に検討されなかった。

ファイル分割時に、分割対象のファイル内に存在する重複パターンを共通化してから（またはと同時に）分割すべきだった。分割を先に行い、共通化を後回しにしたことで、重複パターンが複数ファイルに分散し、共通化がより困難になった。

## 対策

### 問題の性質: 思考的

ファイル分割の副作用（クローン増加）を予測できなかった。

### 対策案

1. ファイル分割を計画する際、分割対象ファイル内の重複パターンを事前に洗い出す（成果物要件: 計画ファイルの確認事項に「分割対象ファイル内の重複パターン」をチェック項目として記載する）
2. 重複パターンがある場合は、共通化を先に（または同時に）実施してからファイル分割を行う
3. 現在増加しているクローン（decision/ 配下の approve/reject/request_changes 間、lifecycle/ 配下の submit/resubmit 間）の削減は、必要に応じて別 Issue で対応する（任意）

## 次のアクション

- Issue #620 で対応

## 分類

- カテゴリ: 視点不足
- 失敗タイプ: 知識ギャップ
- 問題の性質: 思考的
