# Auto Review の重大度判定基準の欠如

## 事象

PR #918（フォルダ管理 API 実装）の Auto Review で「フォルダ移動/名前変更のトランザクション不在」が Medium と評価された。この問題は、`update` と `update_subtree_paths` がトランザクションなしで別々に実行されており、`update` 成功後に `update_subtree_paths` が失敗するとデータ整合性が壊れる（親フォルダは移動済みだが子孫フォルダのパスは旧パスのまま）。

Medium = 「改善推奨だがマージ可能」（approve）であり、データ整合性が壊れうる問題の重大度としては過小評価。結果として、この問題は Issue #927 として延期され、後続 PR #952 で修正された。

## 原因分析

### 直接原因: レビュープロンプトに重大度判定基準がない

`claude-auto-review.yaml` のプロンプトには以下が定義されている:

- レビュー観点（何をチェックするか）: バグ・正確性、セキュリティ、パフォーマンス等の 6 カテゴリ
- 承認判断（重大度に応じたアクション）: Critical/High → request-changes、Medium/Low → approve

しかし、発見した問題を Critical/High/Medium/Low のどれに分類するかの**判定基準が定義されていない**。AI レビュアーは自身の判断で重大度を分類するため、判断が不安定になる。

### 根本原因: 影響度と発生確率の重み付けが未定義

重大度判定には 2 つの軸がある:
- 影響度（Impact）: 問題が発生した場合の深刻さ
- 発生確率（Probability）: 問題が発生する可能性

トランザクション不在の場合:
- 影響度: 高（サイレントなデータ破損、回復困難）
- 発生確率: 低（2 番目の操作が失敗する確率は低い）

AI レビュアーは発生確率を重視して Medium と判定した可能性がある。しかし、レビューの重大度は**影響度を優先**すべきである。低確率でもデータ破損やセキュリティ侵害は High/Critical であるべき。

### 同一レビュー内の矛盾

同じレビューで LIKE ワイルドカードエスケープ漏れも Medium と評価された。この問題は、特定のフォルダ名（`_` や `%` を含む）で無関係なフォルダのパスが不正に更新されるもの。こちらは即座に修正されたが、トランザクション不在は延期された。両者ともデータ整合性に影響する同カテゴリの問題だが、LIKE 問題は通常操作で発生しうる点でより深刻。いずれも High が妥当。

## 対策

### フロー組み込み: レビュープロンプトに重大度判定ガイドラインを追加

`claude-auto-review.yaml` のプロンプトに、Verification 指摘の重大度判定基準を追加する。

判定の原則: **影響度を優先**する。発生確率が低くても、影響度が高ければ重大度を上げる。

| 重大度 | 判定基準 | 例 |
|--------|---------|-----|
| Critical | セキュリティ境界の突破、認証/認可バイパス、機密データ漏洩 | SQL インジェクション、認証なしの API アクセス |
| High | データ破損・不整合、サイレントな正確性バグ、ACID 違反 | トランザクション不在、LIKE ワイルドカード未エスケープ |
| Medium | ユーザーに見えるバグ、エッジケースの非最適な挙動、設計上の問題 | エラーメッセージの不正確さ、N+1 クエリ |
| Low | コード品質・可読性の改善、軽微な設計改善 | 命名の改善、不要な中間変数 |

対策形式の検討:
- ❌ 行動規範: 「影響度を優先して重大度を判定すること」（AI の判断任せで不安定）
- ✅ フロー組み込み: レビュープロンプトに判定基準テーブルを追加（毎回参照される）

## 次のアクション

- [ ] レビュープロンプトに重大度判定ガイドラインを追加する（Issue #959）

## 分類

- カテゴリ: 視点不足
- 失敗タイプ: プロセスギャップ
- 問題の性質: プロセス的
