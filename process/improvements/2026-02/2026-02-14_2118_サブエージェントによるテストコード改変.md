# サブエージェントによるテストコード改変

## 事象

`command.rs` の 3 分割リファクタリングで、サブエージェント（Task ツール）にコード移動を委譲したところ、テストコードがオリジナルから乖離した。

具体的な改変:

| 改変内容 | 例 |
|---------|-----|
| アサーションスタイルの変更 | `assert_eq!(result, expected)` → 個別フィールド `assert_eq!(result.instance.status(), ...)` |
| テストデータの変更 | コメント文字列 `"承認しました"` → `"承認OK"`、`comment: None` → `Some(...)` |
| 不要なセットアップの追加 | オリジナルにない `definition` 変数の作成 |
| 変数名の変更 | `instance_at_step2` → `step2_instance` |
| バージョン値の誤り | `Version::initial()` → `Version::initial().next()`（テストの意図が変わる） |

テストは全てパスしていたため、コンパイル・テスト実行だけでは検出できなかった。ユーザーからテスト改変の有無を確認する問いかけにより発覚した。

## 原因分析

### 直接原因

サブエージェントがコードの「移動」ではなく「再生成」を行った。移動元のコードを正確にコピーせず、訓練データに基づいて「それらしい」テストコードを新たに生成した。

### 構造的原因

1. サブエージェントへの指示が「移動」であっても、LLM は文字列の正確なコピーを保証しない
2. テストがパスする限り、テストデータやアサーションスタイルの変更は検出されない（テストの意図は変わらなくても、オリジナルとの一貫性が失われる）
3. リファクタリング（振る舞い変更なし）の検証は「テストがパスすること」だけでは不十分で、「オリジナルと一致すること」の検証が必要

## 対策

### リファクタリング時のサブエージェント使用ガイドライン（成果物要件）

リファクタリングでサブエージェントにコード移動を委譲する場合、以下を成果物要件とする:

1. サブエージェントの出力をオリジナルと diff で突合すること
2. テストコードの diff が「import パスの変更」以外を含む場合、オリジナルに戻すこと
3. プロダクションコードの diff が「import パスの変更」以外を含む場合、オリジナルに戻すこと

### 代替アプローチの検討

サブエージェントに「再生成」させるよりも、以下のアプローチが安全:

- `git show` でオリジナルを抽出し、sed/awk で import パスのみ変更する
- メインエージェントが直接 Read → Edit で移動する（サブエージェントを使わない）

## 次のアクション

- 対策は行動規範に近いが、リファクタリングでのサブエージェント使用は頻度が低く、フロー組み込みの費用対効果が低い。成果物要件（diff 突合の実施）として記録に留める

## 分類

- カテゴリ: 単一パス検証（サブエージェントの出力を検証なしに受け入れた）
- 失敗タイプ: プロセスギャップ（サブエージェント出力の検証プロセスが未定義だった）
