# plan モード後のコンテキスト喪失による計画ファイルのコミット漏れ

## 事象

PR #582 作成時、plan mode で作成した計画ファイル `prompts/plans/replicated-whistling-sonnet.md` を「PR の対象外」と判断し、コミットしなかった。ユーザーの指摘で修正。

## 原因分析

### 直接原因

`git status` で untracked file として表示されていた計画ファイルを、作業と無関係なファイルと誤認した。

### 根本原因

plan mode → `ExitPlanMode` → コンテキスト圧縮/クリア → 実装開始、という流れで計画ファイルを作成した記憶が失われた。コンテキストクリア後に gitStatus の `??` を見て「セッション開始前から存在していたファイル」と誤認した。

構造的な問題: plan mode で作成されたファイルは、コンテキストクリア後に「自分が作ったもの」という情報が消える。PR 作成フローに「計画ファイルの確認」ステップがないため、毎回起こりうる。

## 対策

### 問題の性質: プロセス的

PR 作成フローに計画ファイルの確認が組み込まれていない。

### 対策案

PR 完了フローの「収束確認完了」と「Draft PR 作成」の間で、`prompts/plans/` に未コミットの計画ファイルがないか確認するステップを追加する。成果物要件として「`git status` の untracked files に `prompts/plans/` のファイルがあれば、現在の作業との関連を確認してコミットする」を PR 完了フローに組み込む。

対策の Issue: #583

## 検証

### 再発（2026-02-21）

PR #766（#765）で同じ事象が再発。PR #589 で CLAUDE.md に追加した対策ステップが、その後の CLAUDE.md リファクタリング（PR 完了フロー → Issue 駆動開発の品質ゲートフローへの統合）で消失していた。

再対策: Issue 駆動開発の品質ゲートフロー（6.4）に計画ファイル確認ステップを再追加（PR #766）。

教訓: 対策をルールファイルに組み込んだ後、そのファイルが再構成される際に対策が消えるリスクがある。ドキュメント再構成時は既存の改善対策が保持されていることを確認する必要がある。

## 分類

- カテゴリ: コンテキスト引きずり
- 失敗タイプ: プロセスギャップ
- 問題の性質: プロセス的
