# テストリストがユニットテスト層のみをカバー

## 事象

Phase 2-2 の実装で、Core Service `get_role` ハンドラにテナント分離ロジックが欠如していた。レビューで指摘された後もテストなしで修正をコミットし、ユーザーに指摘されてテストを追加した。

根本的には、最初の実装時に `get_role` ハンドラのテストが存在しなかったことが問題。ハンドラテスト、API テスト（Hurl）、E2E テストについてテストリストで計画されず、品質チェックリストでも検出されなかった。

## 原因分析

### 直接原因

`get_role` にテナント検証を追加する修正をコミットした際、対応するテストを書かなかった。

### 構造的原因

テストリストの作成ガイダンス（TDD 開発フロー L165-210）がユニットテスト層のみをカバーしている。テストリストの例は Repository, UseCase のテストのみで、Handler テスト、API テスト、E2E テストが含まれていない。

品質チェックリストのテスト項目もこの構造を反映している:

| テスト層 | テストリストでの扱い | 品質チェックリストでの扱い |
|---------|---------------------|------------------------|
| ユニットテスト | ガイドあり | 「テストリストの項目が全て実装されているか」 |
| ハンドラテスト | なし | なし |
| API テスト（Hurl） | なし | なし |
| E2E テスト | なし | 「E2E シナリオを確認済みか」（曖昧） |

テストリスト自体がユニットテストしか含まないため、「テストリストが全て実装されているか」のチェックではハンドラテストや API テストの漏れを検出できない。

`just check-all` は既存テストの実行であり、テストの存在を保証しない。新機能に対応するテストが未作成でも pass する。

### 悪化要因

レビュー指摘対応（review-and-merge の Step 4）にも「修正に対応するテストを追加する」ステップがない。通常の TDD フローではテストから書くが、レビュー指摘対応は TDD フローの外にあり、テスト追加が構造的に保証されていない。

## 対策

### 1. 計画ファイル作成時にテスト層を体系的に検討する（設計段階の成果物要件）

テスト層の検討はテストリスト作成時ではなく、計画ファイル作成時（設計段階）で行う。テスト層の選択は設計判断であり、実装フェーズに入ってからでは遅い。

計画ファイルの各 Phase のテストリストに、テストピラミッドの各層を明記する:

```markdown
### Phase N: コンポーネント名

#### テストリスト

ユニットテスト:
- [ ] ...

ハンドラテスト（該当する場合）:
- [ ] ...

API テスト（該当する場合）:
- [ ] ...

E2E テスト（該当する場合）:
- [ ] ...
```

「該当しない」場合は「該当なし」と明記し、暗黙の省略を防ぐ。

計画ファイルの必須要素（`zoom-rhythm.md`）にテスト層の明記を追加し、設計ブラッシュアップループでテスト層の漏れをギャップとして検出できるようにする。

### 2. review-and-merge の修正対応にテスト確認を追加（フロー組み込み）

review-and-merge スキルの Step 4 に、修正適用後のテスト確認ステップを追加する:

```
修正を適用した後:
1. この修正に対応するテストが存在するか確認
2. 存在しない場合はテストを追加
3. テスト通過を確認してからコミット
```

→ Issue #448

## 次のアクション

1. 計画ファイルの必須要素（`.claude/rules/zoom-rhythm.md`）にテスト層の明記を追加
2. TDD 開発フロー（`docs/04_手順書/04_開発フロー/02_TDD開発フロー.md`）のテストリスト作成ガイダンスにテスト層のフォーマットを追加
3. 品質チェックリスト（`docs/04_手順書/04_開発フロー/01_Issue駆動開発.md`）のテスト項目にテスト層の検討を追加
4. review-and-merge スキルの Step 4 にテスト確認ステップを追加

## 分類

- カテゴリ: 視点不足
- 失敗タイプ: プロセスギャップ
- 問題の性質: プロセス的
