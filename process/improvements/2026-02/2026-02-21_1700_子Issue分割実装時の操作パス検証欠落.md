# 子 Issue 分割実装時の操作パス検証欠落

## 事象

ワークフローデザイナー画面（#405 Phase 2-4）の「検証」ボタンと「公開」ボタンが動作しない（#761）。

- 検証: API リクエストボディに `definition` ラッパーが欠落し、デシリアライズエラー
- 公開: ダイアログ ID のハードコード（`"designer-publish-dialog"`）が `ConfirmDialog.dialogId`（`"confirm-dialog"`）と不一致で、確認ダイアログが表示されない

子 Issue #722-#726 は全てクローズ済みだが、統合した状態での動作確認が行われておらず、正常系すら通らない状態でリリースされていた。

### 事象の再評価

初回の改善記録（PR #762）では「2つのバグ」として扱ったが、本質は**操作パスの検証が構造的に欠落**していたこと。今回は正常系で顕在化したが、正常系で漏れるなら準正常系・異常系はなおさら漏れる。5つの防波堤がすべて突破された構造的欠陥。

## 原因分析

### 防波堤の突破連鎖

| # | 防波堤 | 期待される機能 | 実際 |
|---|--------|--------------|------|
| 1 | 型システム | `validateDefinition` が構造を強制する | `Encode.Value` が構造を強制せず、不正なリクエストがコンパイルを通過 |
| 2 | ユニットテスト | エンコード結果が正しいことを検証 | `validateDefinition` のエンコードテストなし |
| 3 | E2E テスト | ユーザー操作パス（検証→公開）が動作することを検証 | E2E テストなし。どの子 Issue の責任にも割り当てられていなかった |
| 4 | PR Test plan | 手動確認で動作を検証 | PR #740 の Test plan に「バリデーション結果が表示される」が `[ ]` のまま。未検証でマージ |
| 5 | 改善記録 | 再発防止の仕組みを構築 | 初回分析では「改善記録として残す」のみ。対策として不十分 |

### 直接原因

1. `validateDefinition` API 関数の `body : Encode.Value` 型が構造を強制しないため、呼び出し側が `definition` ラッパーなしで送信してもコンパイルが通った
2. `Ports.showModalDialog` に文字列リテラルをハードコードし、`ConfirmDialog.dialogId` 定数を使わなかった

### 根本原因: Epic → Story 分割時のテスト責任断絶

Epic #405 の完了基準:

- テナント管理者が GUI でワークフロー定義を作成できる
- フロー定義のバリデーションが機能する

子 Issue の完了基準:

| 子 Issue | スコープ | 完了基準のレベル |
|---------|---------|---------------|
| #725 キャンバス+ステップ配置 | UI 描画、ドラッグ&ドロップ | UI 描画レベル（配置、移動、削除できる） |
| #726 接続線・バリデーション | 接続線描画、バリデーション結果表示 | 機能レベル（接続、編集、表示できる） |

「検証ボタンを押して結果を確認する」「公開ボタンを押して確認ダイアログが出て公開される」というユーザー操作パスは、Epic の完了基準に暗黙的に含まれているが、どの子 Issue の明示的なテスト責任にもなっていなかった。正常系・準正常系（バリデーションエラー時の表示）・異常系（API エラー時のハンドリング）を問わず、Story の境界をまたぐ操作パスの検証責任が体系的に割り当てられていなかった。

### 構造的原因の分解

| レイヤー | 原因 | 性質 |
|---------|------|------|
| L1 | Epic → Story 分割時に、Epic の完了基準をテスト責任（全テスト層）として子 Issue に割り当てるプロセスがない | プロセス的 |
| L2 | 最後の子 Story 完了時に Epic の完了基準を統合検証するステップがない | プロセス的 |
| L3 | PR Test plan の手動確認項目が未検証のまま品質ゲートを通過している | プロセス的 |

## 対策

### 対策 A: Story 分解時のテスト責任マッピング（フロー組み込み）

配置先: `docs/04_手順書/04_開発フロー/01_Issue駆動開発.md` — Story 分解プロセス

Story 分解の品質基準に「テスト責任の網羅」を追加。Epic 本文にテスト責任マッピング表（テスト層 × 操作パス）を成果物要件として義務付ける。

### 対策 B: Epic 最終 Story の統合検証ゲート（フロー組み込み）

配置先: `docs/04_手順書/04_開発フロー/01_Issue駆動開発.md` — Epic クローズフロー

Epic の最終 Story の PR で、Epic の全完了基準をテスト責任マッピングに基づいて統合検証することをゲート化。

### 対策 C: 品質ゲートの Test plan 検証（成果物要件）

配置先: `docs/04_手順書/04_開発フロー/01_Issue駆動開発.md` — 品質チェックリスト

品質チェックリストのテストセクションに「PR Test plan の全項目がチェック済みであること」を明示的に追加。

### バグ修正（完了）

PR #762 で修正済み:

- `encodeValidationRequest` 関数の追加でリクエストボディを正しくラップ
- ダイアログ ID を `ConfirmDialog.dialogId` に統一
- E2E テストの追加で今後の回帰を防止

### 対策形式の検証

| 対策 | 形式 | 検証 |
|------|------|------|
| A: テスト責任マッピング | 成果物要件 | Epic 本文にテスト責任マッピング表が存在すること |
| B: 統合検証ゲート | フロー組み込み | 品質チェックリストの項目として検証 |
| C: Test plan 検証 | 成果物要件 | 品質チェックリストの項目として検証 |

## 次のアクション

- Issue #763 で手順書を改訂（対策 A, B, C の組み込み）

## 分類

- カテゴリ: 視点不足
- 失敗タイプ: プロセスギャップ
- 問題の性質: プロセス的
