# 運用改善記録

開発プロセスで発生した問題と対策を記録する。

## 目的

- 問題の原因分析と対策を記録し、再発を防止する
- CLAUDE.md や手順書の改善につなげる
- 同様の問題が発生した際の参照資料とする

## 作成トリガー

**具体的な問題事象を起点とする**改善は、改善記録を作成する:

- ユーザーの指摘が正当だった場合（AI が見落とした問題をユーザーが検出した）
- AI の出力に誤りや品質問題があった場合
- プロセスの不備により手戻りが発生した場合
- CI/CD やワークフローの問題を発見した場合

AI エージェント運用に限らず、開発プロセス全般の問題が対象。

### 判定基準: 改善記録が必要か？

| 起点 | 改善記録 | 理由 | 例 |
|------|---------|------|-----|
| 問題起点（具体的な問題事象がある） | 必要 → Issue 化 | 原因分析なしの対策は表層的になりやすい | CI 失敗、レビュー漏れ、手戻り、プロセスの欠陥発見 |
| idea 起点（問題事象なし、前向きな施策） | 不要 → 直接 Issue 化 | 分析すべき「問題」が存在しない | 新スキル追加、新ツール導入、既存機能の拡張 |

判定テスト: 「具体的に何が起きたか（事象）」を説明できるか？
- Yes → 問題起点。改善記録を作成する
- No → idea 起点。直接 Issue 化してよい

改善の経緯: [問題起点の Issue に改善記録が欠如](2026-02/2026-02-11_2104_問題起点のIssueに改善記録が欠如.md)

## ディレクトリ構造

月ごとのサブディレクトリに整理する。

```
process/improvements/
├── YYYY-MM/
│   ├── YYYY-MM-DD_HHMM_<トピック>.md
│   └── ...
└── README.md
```

例: `process/improvements/2026-01/2026-01-27_2303_Issue駆動開発フロー未遵守.md`

## ファイル命名規則

```
YYYY-MM-DD_HHMM_<トピック>.md
```

- `HHMM`: 最初のコミット時刻（24時間形式、例: `0930`, `1415`）
- `<トピック>`: 問題の概要（例: `Issue駆動開発フロー未遵守`）

時刻の取得方法:

```bash
git log --format="%ci" --reverse <branch> --not main | head -1
# 出力例: 2026-01-22 11:08:10 +0900 → HHMM = 1108
```

## 記載内容

1. 事象: 何が起きたか
2. 原因分析: なぜ起きたか
3. 対策: どう改善するか
4. 次のアクション: 具体的な作業項目
5. 分類（必須）: カテゴリ、失敗タイプ、問題の性質（後述）

## 対策セクションの性質

対策セクションは「そのとき考えた対策案」であり、確定した方針ではない。Issue と同様に、実行時には [問題解決フレームワーク](../../.claude/rules/problem-solving.md) で精査してから実装に入る。

改善記録を書く時点では原因分析に集中し、対策は「その時点での最善の仮説」として記録する。

## 対策形式の検証（必須）

対策を記載する際、対策形式を意識し、行動規範形式のままにしない。

| 対策形式 | 定義 | 有効性 | 例 |
|---------|------|--------|-----|
| 行動規範 | 「〜すること」「〜を確認する」 | 低（再発リスク高） | 「確認してからコミットする」 |
| 成果物要件 | 「〜が存在すること」「〜が記載されていること」 | 高 | 「チェックリストに項目が存在し、確認結果が記載されていること」 |
| フロー組み込み | hooks / CI / スキル内チェック | 最高 | lefthook で自動検証、CI で lint 実行 |

行動規範形式の対策を記載した場合、以下を検討する:

1. 成果物要件に転換できないか — 検証可能な成果物（チェックリスト項目、必須セクション、テンプレート）で代替
2. フロー組み込みに転換できないか — hooks、CI、スキルのステップに組み込んで自動化
3. いずれも困難な場合 — 転換困難な理由を対策セクションに明記する

**禁止:** 行動規範形式の対策を、転換の検討なしに記載すること

改善の経緯: [行動規範形式の改善対策を成果物要件・フロー組み込みに転換する](https://github.com/ka2kama/ringiflow/issues/392)

## 対策設計の前提: 問題の性質分類（必須）

対策を設計する前に、問題の性質を分類する。性質に応じて適切なアプローチと対策の配置先が異なる。

### 問題の性質と routing table

| 性質 | 定義 | 適切なアプローチ | 対策の配置先 |
|------|------|----------------|-------------|
| 技術的 | CI エラー、ビルドエラー、実行時エラー、ツール仕様 | 調査手順、確認手段の明確化 | `troubleshooting.md`、ナレッジベース |
| プロセス的 | 手順スキップ、品質ゲート漏れ、フロー不備 | フロー改善、チェックリスト、スキル修正 | 手順書、スキル定義、CLAUDE.md |
| 思考的 | 判断の誤り、分析不足、視点の欠如 | フレームワーク、原則、観点の追加 | `problem-solving.md`、設計原則 |

**禁止:** 問題の性質を分類せずに対策を記載すること

→ 問題解決フレームワーク: [problem-solving.md](../../.claude/rules/problem-solving.md)（プロセス的・思考的問題に適用）
→ 技術的問題の調査: [troubleshooting.md](../../.claude/rules/troubleshooting.md)（技術的問題に適用）

### 対策案の妥当性チェック

対策を記載する際、以下を確認する:

1. 問題の性質と対策の配置先が routing table と一致しているか
2. 既存ツール・フレームワークの適用範囲を確認したか（troubleshooting.md、problem-solving.md 等）
3. 対策が既存ツールのスコープを不適切に拡大していないか

改善の経緯: [問題の性質を分類せず的外れな対策を提案](2026-02/2026-02-15_1309_問題の性質を分類せず的外れな対策を提案.md)

## 恒久対策の Issue 化（必須）

改善記録に恒久対策（未実行の作業項目）を記載した場合、**必ず GitHub Issue を作成**し、改善記録に Issue 番号を記載する。

理由: 改善記録はナレッジベースであり、タスク追跡の仕組みではない。未実行の作業項目が改善記録の中に埋もれて忘れられるリスクがある。タスク追跡は GitHub Issues に一元化する。

手順:

1. 恒久対策を改善記録に記載
2. 対応する GitHub Issue を作成
3. 改善記録の対策セクションに `Issue #番号` を記載

例外: 「任意」「推奨」と明記されたアクション項目は Issue 作成を省略してよい。

## 対策配置時の逆方向リンク（必須）

改善対策をドキュメント（CLAUDE.md、手順書、ルールファイル等）に配置する際、配置箇所の近くに改善記録への逆方向リンクを HTML コメントとして追加する。

### 目的

ドキュメント再構成時に「この記述は改善対策として追加されたもの」と識別できるようにする。逆方向リンクがないと、通常の文章と区別できず、再構成時に消失するリスクがある。

### 書式

```markdown
<!-- 改善: process/improvements/YYYY-MM/ファイル名.md -->
対策として追加された記述
```

コメントは対策の記述の直前に配置する。対策が複数行にわたる場合は、対策ブロックの先頭に 1 つ配置すれば十分。

### 適用範囲

| 対象 | 適用 |
|------|------|
| 今後の新規対策配置 | 必須 |
| 既存の対策配置 | 任意（段階的に追加） |

### 配置例

```markdown
#### 6.4 計画ファイルの確認

<!-- 改善: process/improvements/2026-02/2026-02-16_2301_planモード後のコンテキスト喪失による計画ファイルのコミット漏れ.md -->
`prompts/plans/` に未コミットの計画ファイルがないか確認する。
```

改善の経緯: [ドキュメント再構成時の改善対策デグレ](2026-02/2026-02-21_2152_ドキュメント再構成時の改善対策デグレ.md)

## 分類

改善記録には以下の分類を**必ず**付与する。蓄積された記録のパターン分析・傾向把握に使用する。

**禁止:** カテゴリ、失敗タイプ、問題の性質が未付与の状態で改善記録をコミットすること

→ 分析の方法: [AI 思考特性の分析ガイド](../../docs/06_ナレッジベース/methodology/AI思考特性の分析ガイド.md)

### カテゴリ（AI 構造的特性）

改善記録33件の分析（#315）で特定した、AI エージェントの思考の構造的特性。

| カテゴリ | 説明 | 例 |
|---------|------|-----|
| 参照漏れ | ドキュメント/手順が存在するが参照されなかった | Issue駆動フロー未遵守 |
| 単一パス検証 | 1回の確認で完全と考え、複数ループを省略 | 計画段階での網羅性不足 |
| 即座の対策 | 深く考えずに対策を提示 | 目先の対策に飛びつく傾向 |
| 視点不足 | 複数視点の同時把握ができていない | E2E視点の完了基準欠如 |
| コンテキスト引きずり | 前の会話/作業の文脈を不適切に持ち越し | 会話コンテキストのドキュメント混入 |
| 知識-実行乖離 | 情報は存在するが使用フローに組み込まれていない | CI Action許可設定漏れ |

カテゴリは固定ではない。新しいパターンが発見された場合は追加する。

### 失敗タイプ

根本原因がどの層にあるかを分類する。

| タイプ | 説明 |
|-------|------|
| 知識ギャップ | 情報自体を知らなかった |
| 実行ギャップ | 知っていたが実行しなかった |
| プロセスギャップ | プロセス自体が不十分だった |

### 記載時の照合手順

分類を記載する際は、以下の手順で定義済み値と照合する。

1. カテゴリの値が以下の6種のいずれかであることを確認する:
   - 参照漏れ / 単一パス検証 / 即座の対策 / 視点不足 / コンテキスト引きずり / 知識-実行乖離
2. 失敗タイプの値が以下の3種のいずれかであることを確認する:
   - 知識ギャップ / 実行ギャップ / プロセスギャップ
3. 問題の性質の値が以下の3種のいずれかであることを確認する:
   - 技術的 / プロセス的 / 思考的
4. 該当する値がない場合は、新しいパターンとして追加を検討する（カテゴリのみ。失敗タイプと問題の性質は固定）

**禁止:** カテゴリと失敗タイプの値を混同すること（例: カテゴリに「プロセスギャップ」を使用）

改善の経緯: [改善記録のカテゴリと失敗タイプの混同](2026-02/2026-02-14_2137_改善記録のカテゴリと失敗タイプの混同.md)

### 記載例

```markdown
## 分類

- カテゴリ: 参照漏れ
- 失敗タイプ: 実行ギャップ
- 問題の性質: プロセス的
```

## 検証

対策を実行した後、効果を追記する。フィードバックループを閉じることで、対策の有効性を確認する。

検証セクションは改善記録作成時には記載しない。対策実行後に追記する。

### 追記タイミング

対応 Issue のクローズ時に、振り返りステップの一環として追記する。

→ 手順: [Issue 駆動開発 > 改善記録の検証](../../docs/04_手順書/04_開発フロー/01_Issue駆動開発.md#改善記録の検証)

### フォーマット

```markdown
## 検証（対策実行後に追記）

- 実施日: YYYY-MM-DD
- 対策の実行状況: [実行済み / 部分的 / 未実行]
- 効果: [同種の問題が再発していないか]
- 備考: [対策の調整が必要な場合]
```

「効果」は同種の問題の再発有無を記載するフィールドであり、対策の実施内容ではない。効果が未確認の場合は `未確認（次回以降の改善記録作成時に再発有無を確認）` と記載する。

改善の経緯: [検証セクションの効果を対策実施内容で記載](2026-02/2026-02-14_2127_検証セクションの効果を対策実施内容で記載.md)
