# Phase 5 実装時の OpenAPI 仕様突合漏れ

**発生日時**: 2026-01-29
**重大度**: 高

## 問題

ワークフロー詳細画面で承認ステップ一覧と承認/却下ボタンが表示されない。Phase 5（バックエンド API 実装）で OpenAPI 仕様に反した実装が行われた。

### 事象

1. `GET /api/v1/workflows/{id}` が `steps` と `version` フィールドを返していない
2. `POST .../approve` と `POST .../reject` が 204 No Content を返しているが、仕様では 200 OK + `WorkflowResponse` を返すべき
3. Phase 6（フロントエンド）は OpenAPI 仕様に従って実装済みだが、バックエンドの不一致により Silent Failure が発生

### 原因分析

1. OpenAPI 仕様書 (`openapi/openapi.yaml`) との突合を実施しなかった
   - `WorkflowInstance` スキーマには `steps`（WorkflowStep の配列）と `version` フィールドが定義済み
   - approve/reject のレスポンスは `WorkflowResponse`（200 OK）と明記
2. Phase 間の結合検証が行われなかった
   - Phase 5（API）と Phase 6（フロントエンド）の間でレスポンス形式が不一致
   - フロントエンドのデコーダーはステップ一覧を期待するが、バックエンドが空のレスポンスを返却
3. Silent Failure パターン
   - `steps` フィールドがない場合、Elm デコーダーの `#[serde(default)]` 相当（`optionalField` + `Decode.list`）で空リストにフォールバック
   - エラーにならずに「ステップなし」として表示されるため、問題の検知が遅延

### 根本原因

API 実装時の完了チェックリストに「OpenAPI 仕様書との突合」が含まれていなかった。

## 対策

### 即時対策（本修正）

バックエンド 4 レイヤーを修正:

1. Core Service ユースケース: `WorkflowWithSteps` 構造体を導入し、ステップも一緒に返却
2. Core Service ハンドラ: `WorkflowStepDto` を追加、approve/reject を 200 OK + レスポンスボディに変更
3. BFF クライアント: `WorkflowStepDto` を追加、approve/reject の戻り値を `WorkflowResponse` に変更
4. BFF ハンドラ: `WorkflowStepData` を追加、approve/reject を 200 OK に変更

### 恒久対策

Phase 完了基準に以下を追加（実施済み: コミット 9b658ef）:

- 変更した API エンドポイントが OpenAPI 仕様と一致するか確認
- レスポンスのフィールド、ステータスコード、型をすべて照合

## AI エージェントへの教訓

### Silent Failure パターンの危険性

フロントエンドがオプショナルフィールドやデフォルト値でフォールバックする場合、バックエンドの欠落フィールドがエラーにならない。これは「動作するが正しくない」という最も発見しにくいバグを生む。

対策:
- API 実装後は必ず `curl` でレスポンスの全フィールドを確認
- OpenAPI 仕様の `required` フィールドがすべて返却されているか照合
- フロントエンドとバックエンドの結合ポイントでは、仕様書を真実の源泉（Single Source of Truth）として扱う

### API 実装時の突合チェックリスト

1. OpenAPI 仕様を開き、対象エンドポイントのレスポンススキーマを確認
2. 全 `required` フィールドが DTO に含まれているか確認
3. ステータスコードが仕様と一致するか確認
4. `curl` で実際のレスポンスを検証

## 関連

- Issue: #36（ワークフロー承認フロー）
- OpenAPI 仕様: `openapi/openapi.yaml`（WorkflowInstance / WorkflowStep スキーマ）
- 類似事例: [API デコーダー整合性確認不足](2026-01-28_0100_APIデコーダー整合性確認不足.md)

## 分類

- カテゴリ: 単一パス検証
- 失敗タイプ: プロセスギャップ
- 問題の性質: プロセス的

## 検証（対策実行後に追記）

- 実施日: 2026-01-30
- 対策の実行状況: 実行済み
- 効果: 品質チェックリストに「OpenAPI 仕様との突合」を追加（`.claude/rules/zoom-rhythm.md` の実装フェーズチェックリスト項目4）。API 実装後に OpenAPI 仕様と実装が乖離した状態でコミットすることを防ぐ仕組みが確立された。実装とレスポンス形式の不一致による Silent Failure のパターンは再発していない。
- 備考: なし
