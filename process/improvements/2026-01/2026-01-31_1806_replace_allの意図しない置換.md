# replace_all による意図しない置換

## 事象

Issue #182 の Phase 2（Api.ErrorMessage 抽出）で、Edit ツールの `replace_all` オプションを使って `apiErrorToMessage error` を `ErrorMessage.toUserMessage { entityName = "ワークフロー" } error` に一括置換した際、以下の箇所が意図せず書き換わった:

1. 呼び出し箇所（意図通り）:
   ```elm
   , errorMessage = Just (ErrorMessage.toUserMessage { entityName = "ワークフロー" } error)
   ```

2. 関数定義の本体行（意図しない）:
   ```elm
   apiErrorToMessage : ApiError -> String
   ErrorMessage.toUserMessage { entityName = "ワークフロー" } error =
       case error of
   ```

関数定義行の `apiErrorToMessage error =` が `ErrorMessage.toUserMessage { entityName = "ワークフロー" } error =` に書き換わり、Elm のコンパイルが通らない不正なコードになった。

`Workflow/Detail.elm` と `Task/Detail.elm` の両方で同じ問題が発生した。

## 原因分析

`replace_all` は単純な文字列一致で全箇所を置換するため、「呼び出し箇所」と「定義箇所」を区別できない。

`apiErrorToMessage error` という文字列は:
- 呼び出し: `Just (apiErrorToMessage error)` の中に出現
- 定義: `apiErrorToMessage error =` の `=` の前に出現

両方とも同じ文字列パターンを含むため、`replace_all` が両方を置換した。

## 対策

### 即時対応（実施済み）

手動で不正な関数定義を確認し、関数定義ごと削除した（共通モジュールに移行したため不要）。

### 再発防止（任意）

`replace_all` を使う前に以下を確認する:

1. 置換対象文字列が関数の「呼び出し」と「定義」の両方に現れないか確認する
2. 関数定義も含む場合は `replace_all` を使わず、個別に置換する
3. `replace_all` 使用後は `git diff` またはファイル読み込みで置換結果を確認する

**経験則:** リファクタリングで関数名を変更する場合、`replace_all` は呼び出し箇所のみに限定し、関数定義の削除は別の Edit 操作で行う。

## 次のアクション

- なし（再発防止は AI エージェントの運用ナレッジとして記録のみ）

## 分類

- カテゴリ: 単一パス検証
- 失敗タイプ: 実行ギャップ

## 検証（対策実行後に追記）

- 実施日: 2026-02-11
- 対策の実行状況: 実行済み
- 効果: 運用ナレッジとして記録。`replace_all` 使用時に関数定義と呼び出しの区別を意識する知見が蓄積された。同種の置換ミスは再発していない
- 備考: 再発防止は「任意」としたため、仕組みとしての強制はなく運用に依存
