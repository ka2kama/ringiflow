# E2E 視点の完了基準欠如

**発生日時**: 2026-01-29
**重大度**: 中

## 問題

Issue #36（ワークフロー承認/却下機能）で全 6 Phase が完了したにもかかわらず、フロントエンドの承認/却下ボタンが表示されなかった。

### 直接原因

2つの接続ポイントが欠落していた:

1. GET `/workflows/{id}` のレスポンスに `steps` フィールドが含まれていない
   - Core Service の `WorkflowInstanceDto` と BFF の `WorkflowData` に `steps` 未定義
   - フロントエンドのデコーダーが `optional "steps" ... []` でデフォルト空配列
2. `Main.elm` でユーザー情報を Session に設定するフロー（`/auth/me` → `Session.withUser`）が未実装
   - `Session.getUserId` が常に `Nothing`

### 根本原因

**完了基準が「バックエンド API の動作」に限定されており、E2E 視点がなかった。**

Issue #36 の完了基準:

```markdown
- [x] POST /approve で承認できる
- [x] POST /reject で却下できる
- [x] 承認/却下後にステータスが更新される
- [x] 楽観的ロックが機能する（409 Conflict）
```

全て「新規 API エンドポイントの動作」であり、「UI から承認操作を完了できる」というエンドツーエンドの基準がない。Phase 6（フロントエンド）を含む Issue であるにもかかわらず、完了基準はバックエンド視点のみだった。

### 構造的な問題

Phase を **レイヤー（縦）** で分割したため、レイヤー間の **データフロー（横）** の検証が漏れた:

- Phase 5（API 層）: 新規 POST エンドポイントを追加 → 既存 GET のレスポンス拡張が漏れた
- Phase 6（フロントエンド）: UI コンポーネントを作成 → API から `steps` が来ないことを検知できなかった

各 Phase を個別に検証しても、Phase 間の接続は検証されない。

## 対策

### 手順書の改善

Issue 駆動開発手順書（`docs/04_手順書/04_開発フロー/01_Issue駆動開発.md`）に以下を追加する。

#### 1. 完了基準のガイドラインに E2E 視点を追加

「4.3 実装計画作成」セクションの前、または「Issue に含める」セクションを拡充:

```markdown
完了基準の書き方:

- 技術的基準: API のエンドポイントが動作する、データが保存される、等
- E2E 基準（フルスタック機能の場合は必須）: ユーザーが UI から操作を完了できる
```

具体例:

```markdown
## 完了基準

API 基準:
- [ ] POST /approve で承認できる
- [ ] POST /reject で却下できる

E2E 基準:
- [ ] 承認者が詳細画面から承認操作を完了できる
- [ ] 承認者が詳細画面から却下操作を完了できる
```

E2E 基準があれば、「ボタンが表示されない」=「完了基準が未達成」と判断でき、レスポンスの `steps` 欠落やセッションの問題を実装中に検出できたはず。

#### 2. Phase 間接続の確認を促す

Phase 分割基準に「レイヤー間のデータフロー確認」を追加:

```markdown
Phase 分割の基準:
- 依存順（下位レイヤーから上位レイヤーへ）
- フルスタック機能の場合、既存 API の拡張が必要な箇所を洗い出す
```

## AI エージェントへの教訓

フルスタック機能（バックエンド + フロントエンド）の実装計画を作成する際:

1. 完了基準に「ユーザーが UI から操作を完了できる」を含める
2. 新規エンドポイントだけでなく、既存エンドポイントの拡張が必要な箇所を確認する
3. Phase 設計時にデータフロー（どの API がどのデータを返す必要があるか）を明示する

## 次のアクション

- [x] Issue 駆動開発手順書（完了基準のガイドライン）を更新

## 関連

- Issue: #36 ワークフロー承認/却下機能
- 類似: [API デコーダー整合性確認不足](./2026-01-28_0100_APIデコーダー整合性確認不足.md) — レイヤー間の接続検証が共通課題

## 分類

- カテゴリ: 視点不足
- 失敗タイプ: プロセスギャップ
- 問題の性質: 思考的

## 検証（対策実行後に追記）

- 実施日: 2026-01-30
- 対策の実行状況: 実行済み
- 効果: Issue 駆動開発手順書に E2E 視点を追加（`docs/04_手順書/04_開発フロー/01_Issue駆動開発.md`）。品質チェックリストに Phase 間接続の確認項目を追加（`.claude/rules/zoom-rhythm.md`）。フルスタック機能の完了基準に「ユーザーが UI から操作を完了できる」という E2E 基準が含まれるようになり、レイヤー間の接続漏れを実装中に検出できるようになった。
- 備考: なし
