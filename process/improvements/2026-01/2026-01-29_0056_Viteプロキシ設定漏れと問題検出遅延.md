# Vite プロキシ設定漏れと問題検出の遅延

## 事象

新規申請フォームで「下書き保存」ボタンをクリックすると、403 エラーが発生した。

調査の結果、Vite のプロキシ設定に `/auth` パスが含まれておらず、`/auth/csrf` へのリクエストが BFF に到達していなかった。CSRF トークンが取得できないため、POST リクエストが拒否されていた。

## 原因分析

### 直接的原因

認証機能（#34）実装時に、BFF の `/auth/*` エンドポイントを追加したが、フロントエンドの `vite.config.js` のプロキシ設定を更新し忘れた。

```javascript
// vite.config.js
proxy: {
  "/api": { ... },  // ← /api のみ設定
  // /auth が漏れていた
},
```

### 発覚が遅れた要因

| 要因 | 詳細 |
|------|------|
| DevAuth の存在 | 開発用認証バイパスにより、実際の `/auth/login` を呼ばずに開発できた |
| エラーの握りつぶし | Main.elm で CSRF トークン取得エラーを無視する設計だった |
| GET は成功 | `/api/v1/*` の GET リクエストは動作していたため、POST で初めて問題が顕在化 |

特にエラーハンドリングが問題を隠蔽していた：

```elm
-- Main.elm
GotCsrfToken result ->
    case result of
        Ok token -> ...
        Err _ ->
            -- 未認証の場合は 401 が返されるが、無視する
            ( model, Cmd.none )
```

## 対策

### 暫定対策（実施済み）

Vite プロキシ設定に `/auth` を追加（PR #147）。

### 恒久対策

Issue #146 で API パスを `/api/v1/*` 配下に統一する。これにより、プロキシ設定は `/api` のみで済む。

### 一般的な教訓

1. **エラーを握りつぶす場合でも、開発時にはログ出力する**
   - 本番では無視しても良いが、`console.warn` や `Debug.log` で開発者に見えるようにする

2. **DevAuth は便利だが、実際のフローも定期的にテストする**
   - E2E テストで実際のログインフローを含める

3. **新しいパスプレフィックスを追加した際のチェックリスト**
   - フロントエンドのプロキシ設定
   - CORS 設定（本番環境）
   - API Gateway / Reverse Proxy 設定（本番環境）

## 次のアクション

1. [x] 暫定対策: Vite プロキシに `/auth` を追加（PR #147）
2. [x] Issue 作成: API パス統一（#146）
3. [x] 改善記録を作成（本ファイル）
4. [ ] Issue #146 を実装してパスを統一

## 分類

- カテゴリ: 視点不足
- 失敗タイプ: プロセスギャップ

## 検証（対策実行後に追記）

- 実施日: 2026-02-11
- 対策の実行状況: 実行済み
- 効果: 暫定対策（Vite プロキシに `/auth` 追加、PR #147）は完了。恒久対策の API パス統一（#146）も完了し、プロキシ設定は `/api` のみに簡素化された。同種のプロキシ設定漏れは再発していない
- 備考: なし
