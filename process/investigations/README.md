# 調査記録（Investigation Record）

トラブルシューティングの仮説/検証プロセスを証跡として記録する。

## 目的

1. 監査証跡（Audit trail）: 修正に至った根拠を後から追跡可能にする。散弾銃デバッグの防止ゲートとしても機能
2. 知識の再利用: 同種の問題が再発した場合の参照資料。診断パターンを蓄積する

## 作成トリガー

[troubleshooting.md](../../.claude/rules/troubleshooting.md) に従い仮説検証を 2 回以上実施した場合、解決後に調査記録を作成する。

| 条件 | 調査記録 |
|------|---------|
| 仮説検証 1 回で解決 | 不要（セッションログの判断ログで十分） |
| 仮説検証 2 回以上 | 作成する |

## ディレクトリ構造

月ごとのサブディレクトリに整理する。

```
process/investigations/
├── YYYY-MM/
│   ├── YYYY-MM-DD_HHMM_<トピック>.md
│   └── ...
└── README.md
```

## ファイル命名規則

```
YYYY-MM-DD_HHMM_<トピック>.md
```

- `HHMM`: 最初のコミット時刻（24時間形式、例: `0930`, `1415`）
- `<トピック>`: 問題の概要（例: `WorkflowDefinitionデコーダ失敗`）

時刻の取得方法:

```bash
git log --format="%ci" --reverse <branch> --not main | head -1
# 出力例: 2026-01-22 11:08:10 +0900 → HHMM = 1108
```

## テンプレート

```markdown
# <問題のタイトル>

関連: #<Issue/PR 番号>（該当する場合）

## 症状

<事実のみ記載。解釈を加えない>

- エラーメッセージ:
- 発生タイミング:
- 影響範囲:

## 環境

| 項目 | 値 |
|------|-----|
| ブランチ | |
| 実行環境 | ローカル / CI |
| 関連コミット | |

## 仮説と検証

| # | 仮説 | 予測（正しければ何が観察されるか） | 検証手段 | 結果 | 判定 |
|---|------|--------------------------------|---------|------|------|
| 1 | | | | | 支持/棄却 |

### 仮説 N: <仮説名>

予測: ...
検証手段: ...

検証データ:

<実際の出力 / ログ / スクリーンショットパス>

判定: 支持 / 棄却 / 不明確
理由: ...

## 切り分け（Isolate）

<問題の局在化の手順と結果。該当する場合のみ>

| 確認レイヤー | 確認手段 | 結果 |
|------------|---------|------|
| | | 正常 / 異常 |

## 根本原因

<特定された根本原因>

### 因果関係

<Mermaid flowchart: 原因から症状への因果連鎖。該当する場合のみ>

## 修正と検証

修正内容: ...
検証結果: ...

## 診断パターン（Knowledge）

<今後同種の問題が発生した場合の診断のヒント>

- 症状「...」が見られたら、まず ... を確認する
- ...

## 関連ドキュメント

- セッションログ: [...]
- 改善記録: [...]（プロセス改善に至った場合）
```

### 必須セクションと任意セクション

| セクション | 必須 | 備考 |
|-----------|------|------|
| 症状 | ○ | 事実の記録 |
| 環境 | ○ | 再現条件 |
| 仮説と検証 | ○ | 証跡の核心 |
| 切り分け（Isolate） | △ | レイヤー横断の調査がある場合のみ |
| 根本原因 | ○ | 結論 |
| 修正と検証 | ○ | 対応結果 |
| 診断パターン | ○ | 知識の再利用 |
| 関連ドキュメント | ○ | トレーサビリティ |

## 他文書との関係

| 文書 | 関係 |
|------|------|
| セッションログ | セッションログは「何をやったか」、調査記録は「どう調べたか」。セッションログから調査記録へリンクする |
| 改善記録 | 改善記録は「プロセスの問題と対策」、調査記録は「技術的な調査の証跡」。同一事象で両方作成する場合は相互リンク |
| ナレッジベース | 調査記録の「診断パターン」が汎用的な場合、ナレッジベースに抽出して相互リンク |
| troubleshooting.md | 調査記録は troubleshooting.md のフレームワークの実行記録。「よくあるパターンと確認手段」テーブルに昇格させるべきパターンが蓄積されたら troubleshooting.md を更新する |

### 改善記録との使い分け

同一の問題で調査記録と改善記録の両方が必要な場合がある:

| 文書 | 記録対象 | 例 |
|------|---------|-----|
| 調査記録 | 技術的な調査プロセスの証跡 | デコーダバグの仮説検証 3 回の記録 |
| 改善記録 | プロセスの問題と対策 | 散弾銃デバッグというプロセス的問題の分析と対策 |

例: 散弾銃デバッグ事象では、改善記録に「系統的アプローチの適用結果」として仮説追跡表を含めていた。新体系では、技術的な調査プロセスは調査記録に、プロセス改善は改善記録に分離し、相互リンクする。
