# cargo-deny 設定
# 依存関係の脆弱性・ライセンス・ソースをチェックする
#
# 実行: cargo deny check
# 参照: https://embarkstudios.github.io/cargo-deny/
# 選定理由: ADR-033

# =============================================================================
# advisories: RustSec Advisory DB に基づく脆弱性チェック
# =============================================================================
#
# v0.19.0 以降、vulnerability / unsound / notice は常にエラーとして扱われる。
# 設定可能なのは unmaintained と yanked のみ。
[advisories]
# メンテナンスされていないクレートのチェック対象スコープ
# "all" = 全依存、"workspace" = ワークスペースメンバーのみ、"none" = 無効
unmaintained = "workspace"
# yank されたクレートの扱い
yanked = "warn"

# =============================================================================
# licenses: ライセンスチェック
# =============================================================================
#
# v0.19.0 以降、allow リストに含まれないライセンスはデフォルトで拒否される。
[licenses]
# SPDX ライセンス推定の確信度しきい値
confidence-threshold = 0.8
# 許可するライセンス一覧（cargo deny list の結果に基づく）
allow = [
    "0BSD",
    "Apache-2.0",
    "Apache-2.0 WITH LLVM-exception",
    "BSD-2-Clause",
    "BSD-3-Clause",
    "BSL-1.0",
    "CDLA-Permissive-2.0",
    "ISC",
    "MIT",
    "Unicode-3.0",
    "Unlicense",
    "Zlib",
]

# r-efi は LGPL-2.1-or-later だが、EFI/UEFI 環境専用のライブラリであり
# 本プロジェクトでは直接使用しない（Windows ビルドの推移的依存）。
# allow リストに LGPL を入れると他の LGPL クレートも許可してしまうため、
# 個別の例外として扱う。
[[licenses.exceptions]]
allow = ["LGPL-2.1-or-later"]
name = "r-efi"

# =============================================================================
# bans: クレートの禁止・制限
# =============================================================================
[bans]
# 同じクレートの複数バージョンはエラー（#901 でラチェット化）
# 既知の duplicate は skip で明示許容。新規 duplicate は CI を失敗させる。
multiple-versions = "deny"
# ワイルドカード依存は許可（workspace 内では一般的）
wildcards = "allow"

# 既知の duplicate crate の旧バージョンを skip（上流の移行完了後に削除する）
#
# 主な原因:
# - AWS SDK がまだ hyper 1.x / rustls 0.23 に完全移行していない
# - sqlx / argon2 が旧 rand (0.8) / getrandom (0.2) エコシステムに依存
# - Windows プラットフォームクレートのバージョン断片化
skip = [
    # rand / getrandom エコシステム（sqlx, argon2 経由）
    { crate = "getrandom@0.2", reason = "sqlx / argon2 が旧 rand エコシステムに依存" },
    { crate = "rand@0.8", reason = "sqlx / argon2 が旧 rand に依存" },
    { crate = "rand_chacha@0.3", reason = "rand 0.8 の推移的依存" },
    { crate = "rand_core@0.6", reason = "rand 0.8 の推移的依存" },
    # hyper / HTTP エコシステム（AWS SDK 経由）
    { crate = "h2@0.3", reason = "AWS SDK が hyper 0.14 経由で依存" },
    { crate = "http@0.2", reason = "AWS SDK が hyper 0.14 経由で依存" },
    { crate = "http-body@0.4", reason = "AWS SDK が hyper 0.14 経由で依存" },
    { crate = "hyper@0.14", reason = "AWS SDK がまだ hyper 1.x に移行していない" },
    { crate = "hyper-rustls@0.24", reason = "AWS SDK が rustls 0.21 に依存" },
    # TLS エコシステム（AWS SDK 経由）
    { crate = "rustls@0.21", reason = "AWS SDK がまだ rustls 0.23 に移行していない" },
    { crate = "rustls-webpki@0.101", reason = "rustls 0.21 の推移的依存" },
    { crate = "tokio-rustls@0.24", reason = "rustls 0.21 の推移的依存" },
    # AWS SDK 内部の smithy バージョン断層（aws-sdk-s3 が旧 smithy に依存）
    { crate = "aws-smithy-http@0.62", reason = "aws-sdk-s3 が旧 smithy-http に依存" },
    { crate = "aws-smithy-json@0.61", reason = "aws-sdk-s3 が旧 smithy-json に依存" },
    # 暗号エコシステム（AWS SDK 経由）
    { crate = "crypto-bigint@0.4", reason = "AWS SDK (aws-sigv4 → p256 → elliptic-curve) が旧バージョンに依存" },
    # その他
    { crate = "hashbrown@0.14", reason = "lettre → chumsky が旧バージョンに依存" },
    { crate = "hashbrown@0.15", reason = "推移的依存のバージョン差異" },
    { crate = "socket2@0.5", reason = "推移的依存のバージョン差異" },
]

# Windows プラットフォームクレートの旧バージョンツリーを一括 skip
# windows-sys の旧バージョンを skip-tree すると、対応する windows-targets と
# windows_* アーキテクチャクレートも自動的に skip される
skip-tree = [
    { crate = "windows-sys@0.48", reason = "sqlx (etcetera) 経由の旧バージョン" },
    { crate = "windows-sys@0.52", reason = "ring 経由の旧バージョン" },
    { crate = "windows-sys@0.59", reason = "insta (console) 経由の旧バージョン" },
    { crate = "windows-sys@0.60", reason = "socket2 経由の旧バージョン" },
]

# =============================================================================
# sources: クレートソースの制限
# =============================================================================
[sources]
# 不明なレジストリからのクレートは警告
unknown-registry = "warn"
# Git 依存は警告
unknown-git = "warn"
# crates.io のみ許可
allow-registry = ["https://github.com/rust-lang/crates.io-index"]
allow-git = []
